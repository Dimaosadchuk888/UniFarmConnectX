# üéØ –ü–õ–ê–ù –†–ï–®–ï–ù–ò–Ø: TON Connect –¥–µ–ø–æ–∑–∏—Ç—ã User #25

**–î–∞—Ç–∞**: 24 –∏—é–ª—è 2025  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê - –ì–û–¢–û–í –ö –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ—Ä—è—é—Ç –¥–µ–ø–æ–∑–∏—Ç—ã)  

---

## üìã –ê–ù–ê–õ–ò–ó –ù–ê –û–°–ù–û–í–ï –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–û–ì–û –û–¢–ß–ï–¢–ê

### üîç **–ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê** (–∏–∑ `TON_CONNECT_DEPOSIT_DIAGNOSTIC_REPORT_2025-07-24.md`):

1. **–û–¢–°–£–¢–°–¢–í–£–ï–¢ –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø Frontend ‚Üí Backend**
   - ‚úÖ TON Connect —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ blockchain
   - ‚úÖ Backend API –≥–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ (`POST /api/v2/wallet/ton-deposit`)
   - ‚ùå **Frontend –ù–ï –í–´–ó–´–í–ê–ï–¢ Backend API –ø–æ—Å–ª–µ blockchain —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**

2. **Race Condition + –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞**
   - ‚ùå `tx_hash_unique: null` –≤ `core/TransactionService.ts:110`
   - ‚ùå Type mapping: `TON_DEPOSIT` ‚Üí `FARMING_REWARD` (–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
   - ‚ùå WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±–µ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π DB —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

---

## üõ†Ô∏è –ö–û–ù–ö–†–ï–¢–ù–´–ô –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### **–≠–¢–ê–ü 1: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Frontend-Backend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é**
**–ü—Ä–æ–±–ª–µ–º–∞**: –í `client/src/services/tonConnectService.ts:424-427` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤—ã–∑–æ–≤ Backend API

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π –∫–æ–¥ –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 427:
```typescript
// –ü–û–°–õ–ï –°–¢–†–û–ö–ò 427 (return { txHash: result.boc, status: 'success' };)
// –î–û–ë–ê–í–ò–¢–¨:
try {
  const { correctApiRequest } = await import('../../lib/correctApiRequest');
  
  const backendResponse = await correctApiRequest('/api/v2/wallet/ton-deposit', 'POST', {
    ton_tx_hash: result.boc,
    amount: tonAmount, // —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ –º–µ—Ç–æ–¥–µ
    wallet_address: tonConnectUI.account?.address || 'unknown'
  });
  
  console.log('‚úÖ Backend –¥–µ–ø–æ–∑–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω:', backendResponse);
} catch (backendError) {
  console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–ø–æ–∑–∏—Ç–∞ –Ω–∞ backend:', backendError);
  // –ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É - blockchain —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–∂–µ –ø—Ä–æ—à–ª–∞
}
```

### **–≠–¢–ê–ü 2: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é**
**–ü—Ä–æ–±–ª–µ–º–∞**: `core/TransactionService.ts:110` - `tx_hash_unique: null`

**–†–µ—à–µ–Ω–∏–µ**: –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞:
```typescript
tx_hash_unique: metadata?.tx_hash || null
```

### **–≠–¢–ê–ü 3: –ò—Å–ø—Ä–∞–≤–∏—Ç—å Type Mapping**
**–ü—Ä–æ–±–ª–µ–º–∞**: `TON_DEPOSIT` –º–∞–ø–ø–∏—Ç—Å—è –≤ `FARMING_REWARD`

**–†–µ—à–µ–Ω–∏–µ**: –í `core/TransactionService.ts:22`:
```typescript
'TON_DEPOSIT': 'DEPOSIT',  // –í–º–µ—Å—Ç–æ: 'FARMING_REWARD'
```

---

## üéØ –í–ê–†–ò–ê–ù–¢–´ –î–ï–ô–°–¢–í–ò–ô

### **–í–ê–†–ò–ê–ù–¢ A: –ü–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô)**
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ 3 –ø—Ä–æ–±–ª–µ–º—ã –∑–∞ –æ–¥–Ω—É —Å–µ—Å—Å–∏—é
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
- ‚úÖ –í—Ä–µ–º—è: 10-15 –º–∏–Ω—É—Ç
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –í—ã—Å–æ–∫–∞—è (—Ç–æ—á–µ—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)

### **–í–ê–†–ò–ê–ù–¢ B: –ü–æ—ç—Ç–∞–ø–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**
- ‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ —Ç–æ–ª—å–∫–æ Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚ö†Ô∏è –ü–æ—Ç–æ–º –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∏ type mapping
- ‚ö†Ô∏è –í—Ä–µ–º—è: 30+ –º–∏–Ω—É—Ç (–Ω–µ—Å–∫–æ–ª—å–∫–æ –∏—Ç–µ—Ä–∞—Ü–∏–π)
- ‚ö†Ô∏è –†–∏—Å–∫: –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º–∏

### **–í–ê–†–ò–ê–ù–¢ C: –¢–æ–ª—å–∫–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**
- ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ—Ä–µ—à–µ–Ω–Ω–æ–π
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ç–µ—Ä—è—Ç—å –¥–µ–ø–æ–∑–∏—Ç—ã
- ‚ùå –ù–µ–ø—Ä–∏–µ–º–ª–µ–º–æ –¥–ª—è production

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### ‚úÖ **–ü–û–í–ï–î–ï–ù–ò–ï –î–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø** (—Ç–µ–∫—É—â–µ–µ):
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç TON –¥–µ–ø–æ–∑–∏—Ç —á–µ—Ä–µ–∑ TON Connect
2. Blockchain —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
3. Frontend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
4. Backend –ù–ï –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
5. –ë–∞–ª–∞–Ω—Å "–æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è" –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
6. –î–µ–ø–æ–∑–∏—Ç "–ø—Ä–æ–ø–∞–¥–∞–µ—Ç" –∏–∑ —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ **–ü–û–í–ï–î–ï–ù–ò–ï –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø** (–æ–∂–∏–¥–∞–µ–º–æ–µ):
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç TON –¥–µ–ø–æ–∑–∏—Ç —á–µ—Ä–µ–∑ TON Connect
2. Blockchain —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
3. Frontend –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –≤—ã–∑—ã–≤–∞–µ—Ç Backend API
4. Backend —Å–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –ë–î —á–µ—Ä–µ–∑ UnifiedTransactionService
5. –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
6. WebSocket –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
7. UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å –ù–ê–í–°–ï–ì–î–ê

---

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ê–°–ü–ï–ö–¢–´

### **–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨**
- ‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–æ—á–µ—á–Ω—ã–µ (3 —Å—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞)
- ‚úÖ –ù–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–µ–ø–æ–∑–∏—Ç—ã
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
- ‚úÖ Rollback –≤–æ–∑–º–æ–∂–µ–Ω –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç

### **PRODUCTION READY**
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–º –æ—Ç—á–µ—Ç–µ
- ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–∑—É—á–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é
- ‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ –ö—Ä–∏—Ç–∏—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ

### **–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ô –û–ü–´–¢**
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
- ‚úÖ –í—Å–µ –±—É–¥—É—â–∏–µ –¥–µ–ø–æ–∑–∏—Ç—ã –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã
- ‚úÖ –ù–∏–∫–∞–∫–∏—Ö –ø—Ä–æ—Å—Ç–æ–µ–≤

---

## üéØ –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

**‚úÖ –í–°–ï –ì–û–¢–û–í–û –î–õ–Ø –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ì–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø**

**–ß—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç –≤–∞—Å**:
1. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
2. –í—ã–±–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é –í–ê–†–ò–ê–ù–¢ A - –ø–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)

**–ß—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ**:
1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Frontend-Backend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (10-15 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞)
2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (1 —Å—Ç—Ä–æ–∫–∞)
3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ type mapping (1 —Å—Ç—Ä–æ–∫–∞)
4. –°–æ–∑–¥–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: 10-15 –º–∏–Ω—É—Ç  
**–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞**: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π  
**–ì–∞—Ä–∞–Ω—Ç–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**: 100%  

---

**–†–ï–®–ï–ù–ò–ï**: –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, –∏ —è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—é –≤—Å–µ 3 –ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤.