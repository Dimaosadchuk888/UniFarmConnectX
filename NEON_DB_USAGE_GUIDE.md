# Руководство по использованию Neon DB в UniFarm

## Введение

Данное руководство описывает настройку и использование Neon DB в качестве основной базы данных для проекта UniFarm. В соответствии с требованиями, приложение должно всегда использовать Neon DB вместо Replit PostgreSQL, независимо от настроек окружения.

## Преимущества использования Neon DB

- Независимость от Replit PostgreSQL и его локальных ограничений
- Более высокая производительность и масштабируемость
- Совместимость с партиционированием таблиц
- Доступность из любой среды развертывания

## Файлы конфигурации

### 1. `.env.neon`

Файл `.env.neon` содержит настройки подключения к Neon DB:

```
DATABASE_URL=postgres://user:password@endpoint.service.neon.tech/database
DATABASE_PROVIDER=neon
FORCE_NEON_DB=true
```

### 2. `start-neon.cjs`

Скрипт `start-neon.cjs` обеспечивает принудительный запуск приложения с использованием Neon DB:

```javascript
// Загружает переменные из .env.neon
// Устанавливает FORCE_NEON_DB=true
// Запускает приложение с настройками Neon DB
```

## Запуск приложения с Neon DB

Для запуска приложения с принудительным использованием Neon DB используйте команду:

```bash
node start-neon.cjs
```

Эта команда запустит скрипт, который:
1. Загрузит настройки из `.env.neon`
2. Установит необходимые переменные окружения
3. Запустит сервер с принудительным использованием Neon DB

## Проверка статуса Neon DB

Для проверки подключения и статуса Neon DB используйте скрипт:

```bash
node check-neon-status.cjs
```

Скрипт покажет:
- Статус подключения к Neon DB
- Список таблиц в базе данных
- Статистику по основным таблицам
- Информацию о партиционировании

## Архитектура подключения к базе данных

### Файл `server/db-selector-new.ts`

Этот файл отвечает за выбор базы данных. Модифицирован для принудительного использования Neon DB:

```typescript
// Приоритет проверки для использования Neon DB:
// 1. Проверка флага FORCE_NEON_DB
// 2. Проверка DATABASE_PROVIDER=neon
// 3. Проверка переопределения через OVERRIDE_DB_PROVIDER
```

### Файл `server/db-neon.ts`

Содержит логику подключения к Neon DB:

```typescript
// Установка SSL-соединения
// Инициализация пула соединений
// Обработка ошибок соединения
```

## Таблицы в базе данных Neon

База данных содержит следующие таблицы:
- users - пользователи системы
- transactions - транзакции (с партициями по месяцам)
- farming_deposits - депозиты в фарминг
- referrals - реферальные связи
- и другие служебные таблицы

## Партиционирование транзакций

Таблица transactions в Neon DB использует партиционирование по месяцам:
- transactions_2025_02, transactions_2025_03 и т.д.
- transactions_default для данных без соответствующей секции

## Возможные проблемы и их решения

### Ошибка партиционирования

При создании партиций может возникать ошибка:
```
Failed to log error to partition_logs: column "operation_type" of relation "partition_logs" does not exist
```

Это не критичная ошибка, связанная с отсутствием колонки в логах партиционирования. 
Функциональность партиций работает корректно.

### Отсутствие таблицы wallets

В Neon DB может отсутствовать таблица wallets. Это не влияет на работу приложения, 
так как используется альтернативный контроллер:
```
[WalletControllerFallback] Использование обновленного fallback контроллера
```

## Заключение

Настройка принудительного использования Neon DB позволяет обойти ограничения Replit PostgreSQL и обеспечить стабильную работу приложения в любой среде. При запуске через `start-neon.cjs` гарантируется использование Neon DB независимо от других настроек окружения.