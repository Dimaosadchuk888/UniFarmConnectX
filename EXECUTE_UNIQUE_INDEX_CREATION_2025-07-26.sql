-- üõ°Ô∏è –ë–ï–ó–û–ü–ê–°–ù–û–ï –°–û–ó–î–ê–ù–ò–ï –£–ù–ò–ö–ê–õ–¨–ù–û–ì–û –ò–ù–î–ï–ö–°–ê
-- –î–∞—Ç–∞: 26 –∏—é–ª—è 2025
-- –¶–µ–ª—å: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤

-- =====================================================
-- –í–ê–†–ò–ê–ù–¢ 1: –ë–ï–ó–û–ü–ê–°–ù–´–ô PARTIAL INDEX (–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô)
-- =====================================================

-- –≠—Ç–æ—Ç –∏–Ω–¥–µ–∫—Å –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –Ω–æ–≤—ã–µ –¥—É–±–ª–∏, –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
-- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ –∑–∞–ø–∏—Å—è–º —Å–æ–∑–¥–∞–Ω–Ω—ã–º –ø–æ—Å–ª–µ —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞

CREATE UNIQUE INDEX CONCURRENTLY idx_tx_hash_unique_new_deposits 
ON transactions(tx_hash_unique) 
WHERE tx_hash_unique IS NOT NULL 
  AND created_at > '2025-07-26T12:57:00.311Z';

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
-- \d+ transactions
-- SELECT indexname, indexdef FROM pg_indexes WHERE tablename = 'transactions' AND indexname LIKE '%tx_hash%';

-- =====================================================
-- –í–ê–†–ò–ê–ù–¢ 2: –ê–ì–†–ï–°–°–ò–í–ù–´–ô –ü–û–î–•–û–î - –ü–û–õ–ù–´–ô –ò–ù–î–ï–ö–°
-- =====================================================

-- ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –¥—É–±–ª–µ–π!
-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≥–æ—Ç–æ–≤—ã —É–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥—É–±–ª–∏

-- –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –¥—É–±–ª–µ–π
-- CREATE TABLE duplicate_backup_20250726 AS 
-- SELECT * FROM transactions 
-- WHERE tx_hash_unique IN (
--     SELECT tx_hash_unique FROM transactions 
--     WHERE tx_hash_unique IS NOT NULL 
--     GROUP BY tx_hash_unique 
--     HAVING COUNT(*) > 1
-- );

-- –®–∞–≥ 2: –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–µ–π (–æ—Å—Ç–∞–≤–ª—è–µ–º —Å–∞–º—ã–µ –Ω–æ–≤—ã–µ)
-- WITH duplicates AS (
--     SELECT id, 
--            ROW_NUMBER() OVER (PARTITION BY tx_hash_unique ORDER BY created_at DESC) as rn
--     FROM transactions 
--     WHERE tx_hash_unique IS NOT NULL
-- )
-- DELETE FROM transactions 
-- WHERE id IN (
--     SELECT id FROM duplicates WHERE rn > 1
-- );

-- –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
-- CREATE UNIQUE INDEX CONCURRENTLY idx_tx_hash_unique_full
-- ON transactions(tx_hash_unique) 
-- WHERE tx_hash_unique IS NOT NULL;

-- =====================================================
-- –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–©–ò–¢–´ –û–¢ –î–£–ë–õ–ï–ô
-- =====================================================

-- –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∑–∞—â–∏—Ç—É:

-- 1. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞):
-- INSERT INTO transactions (
--     user_id, type, amount, amount_uni, amount_ton, 
--     currency, status, description, tx_hash_unique
-- ) VALUES (
--     247, 'FARMING_REWARD', '0.001', '0', '0.001', 
--     'TON', 'completed', 'Test duplicate protection', 
--     'test_duplicate_protection_' || EXTRACT(EPOCH FROM NOW())
-- );

-- 2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ —Å —Ç–µ–º –∂–µ tx_hash_unique
-- (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ duplicate key)

-- =====================================================
-- –ú–û–ù–ò–¢–û–†–ò–ù–ì –ò –û–¢–ö–ê–¢
-- =====================================================

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è:
-- EXPLAIN ANALYZE SELECT * FROM transactions WHERE tx_hash_unique = 'test_hash';

-- –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–∫–∞—Ç–∞:
-- DROP INDEX CONCURRENTLY idx_tx_hash_unique_new_deposits;

-- =====================================================
-- –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –í–´–ü–û–õ–ù–ï–ù–ò–Æ
-- =====================================================

-- 1. –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–ê–Ø –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨:
--    - –í—ã–ø–æ–ª–Ω–∏—Ç–µ –í–ê–†–ò–ê–ù–¢ 1 (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π partial index)
--    - –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —Å–∏—Å—Ç–µ–º—É 24 —á–∞—Å–∞
--    - –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π —Ä–∞–±–æ—Ç–µ –æ—á–∏—Å—Ç–∏—Ç–µ –¥—É–±–ª–∏ –∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–Ω—ã–π –∏–Ω–¥–µ–∫—Å

-- 2. –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–ê–Ø –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞):
--    - –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –í–ê–†–ò–ê–ù–¢ 2
--    - –û—á–∏—Å—Ç–∏—Ç–µ –¥—É–±–ª–∏ —Å–æ–≥–ª–∞—Å–Ω–æ —à–∞–≥–∞–º
--    - –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å

-- 3. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:
--    - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ CONCURRENTLY –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
--    - –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
--    - –î–µ—Ä–∂–∏—Ç–µ –ø–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞ –Ω–∞–≥–æ—Ç–æ–≤–µ

-- ‚úÖ –ì–û–¢–û–í–û –ö –í–´–ü–û–õ–ù–ï–ù–ò–Æ!