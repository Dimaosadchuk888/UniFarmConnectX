# üö® TOO MANY REQUESTS INVESTIGATION REPORT
**–î–∞—Ç–∞:** 8 –∏—é–ª—è 2025  
**–°—Ç–∞—Ç—É—Å:** üîç –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ù–ê–ô–î–ï–ù–ê  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

## üîç –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ü–†–û–í–ï–î–ï–ù–û

### üìä –ê–Ω–∞–ª–∏–∑ WebView Console –ª–æ–≥–æ–≤:
- ‚úÖ –°–æ–±—Ä–∞–Ω–æ 50+ –∑–∞–ø–∏—Å–µ–π –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—à–∏–±–æ–∫ 429
- ‚úÖ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –≤—ã–∑—ã–≤–∞—é—â–∏–µ –ø—Ä–æ–±–ª–µ–º—É
- ‚úÖ –ò–∑—É—á–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è rate limiting —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ç–æ—á–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –∑–∞—â–∏—Ç—ã

---

## üéØ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê

### üî• –ü–†–û–ë–õ–ï–ú–ê ‚Ññ1: SimpleMissionsList –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `client/src/components/missions/SimpleMissionsList.tsx`

**–ü—Ä–æ–±–ª–µ–º–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```typescript
const { data: missionsData, refetch: refetchMissions } = useQuery({
  queryKey: ['/api/v2/missions/list', validUserId],
  queryFn: () => correctApiRequest(`/api/v2/missions/list?user_id=${validUserId}`),
  refetchInterval: 10000, // ‚ùå –ö–ê–ñ–î–´–ï 10 –°–ï–ö–£–ù–î!
});

const { data: userMissionsData, refetch: refetchUserMissions } = useQuery({
  queryKey: ['/api/v2/missions/user', validUserId],
  queryFn: () => correctApiRequest(`/api/v2/missions/user/${validUserId}`),
  refetchInterval: 10000, // ‚ùå –ö–ê–ñ–î–´–ï 10 –°–ï–ö–£–ù–î!
});
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. üîÑ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–µ–ª–∞–µ—Ç 2 –∑–∞–ø—Ä–æ—Å–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
2. ‚ö†Ô∏è `validUserId = userId || '1'` - fallback –Ω–∞ user_id=1 –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
3. üö´ –ó–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –ë–ï–ó JWT —Ç–æ–∫–µ–Ω–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
4. üõ°Ô∏è Rate limiting —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç: 12 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É = –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ 10 req/min

---

## üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø RATE LIMITING

### –°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã (core/middleware/rateLimiting.ts):

**strictRateLimit (–¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö endpoints):**
- ‚è±Ô∏è –û–∫–Ω–æ: 1 –º–∏–Ω—É—Ç–∞  
- üö´ –õ–∏–º–∏—Ç: 10 –∑–∞–ø—Ä–æ—Å–æ–≤
- üìù –°–æ–æ–±—â–µ–Ω–∏–µ: "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π"

**massOperationsRateLimit (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö):**
- ‚è±Ô∏è –û–∫–Ω–æ: 1 –º–∏–Ω—É—Ç–∞
- ‚úÖ –õ–∏–º–∏—Ç: 10,000 –∑–∞–ø—Ä–æ—Å–æ–≤
- üîì **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–ø—É—Å–∫ –¥–ª—è Bearer —Ç–æ–∫–µ–Ω–æ–≤**

**–¢–µ–∫—É—â–µ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ missions/routes.ts:**
```typescript
router.get('/list', requireTelegramAuth, missionsController.getActiveMissions...); 
router.get('/user/:userId', requireTelegramAuth, validateParams(userIdParamSchema), ...);
```

**–ù–ï–¢ rate limiting –≤ missions!** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `requireTelegramAuth`

---

## üî• –ü–†–û–ë–õ–ï–ú–ê ‚Ññ2: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –õ–æ–≥–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:
```
[correctApiRequest] –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç: {"ok":false,"status":429,"statusText":"Too Many Requests"}
[correctApiRequest] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {"url":"/api/v2/missions/list?user_id=1","method":"GET","headers":{"Content-Type":"application/json","Accept":"application/json"}}
```

**–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Authorization header!** 
- ‚ùå –ù–µ—Ç `"Authorization": "Bearer <token>"`
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π
- ‚ùå Rate limiting –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤

---

## üîÑ CHAIN REACTION –ü–†–û–ë–õ–ï–ú–ê

### –ü–æ—á–µ–º—É –æ—à–∏–±–∫–∞ "–±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è":

1. **SimpleMissionsList** —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å `refetchInterval: 10000`
2. **–ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å** –±–µ–∑ JWT ‚Üí 429 error
3. **React Query** –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç retry –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
4. **Rate limiting** –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ 15 –º–∏–Ω—É—Ç
5. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫—Ä–∞—Å–Ω–æ–µ –æ–∫–Ω–æ** "Too many requests"
6. **–¶–∏–∫–ª –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è** –¥–∞–∂–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–æ–∫–æ—è

---

## üõ†Ô∏è –¢–û–ß–ù–´–ô –î–ò–ê–ì–ù–û–ó

### –ß—Ç–æ –ù–ï —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–±–ª–µ–º–æ–π:
- ‚úÖ Rate limiting –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç DDoS —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ  
- ‚úÖ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω—ã
- ‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ

### –ß—Ç–æ –Ø–í–õ–Ø–ï–¢–°–Ø –ø—Ä–æ–±–ª–µ–º–æ–π:
- ‚ùå SimpleMissionsList –¥–µ–ª–∞–µ—Ç aggressive polling (10 —Å–µ–∫)
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–∞–º–∏
- ‚ùå React Query –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ 429 –æ—à–∏–±–∫–∞—Ö
- ‚ùå Fallback userId='1' –æ–±—Ö–æ–¥–∏—Ç –ª–æ–≥–∏–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ

### üéØ –†–ï–®–ï–ù–ò–ï ‚Ññ1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ SimpleMissionsList
```typescript
// –î–û–ë–ê–í–ò–¢–¨ –ø—Ä–æ–≤–µ—Ä–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
enabled: !!userId && !!localStorage.getItem('unifarm_jwt_token'),

// –£–í–ï–õ–ò–ß–ò–¢–¨ –∏–Ω—Ç–µ—Ä–≤–∞–ª:
refetchInterval: 30000, // 30 —Å–µ–∫—É–Ω–¥ –≤–º–µ—Å—Ç–æ 10

// –£–ë–†–ê–¢–¨ fallback:
const validUserId = userId; // –ë–µ–∑ || '1'
```

### üéØ –†–ï–®–ï–ù–ò–ï ‚Ññ2: –î–æ–±–∞–≤–∏—Ç—å massOperationsRateLimit –≤ missions
```typescript
// –í modules/missions/routes.ts:
import { massOperationsRateLimit } from '../../core/middleware/rateLimiting';

router.get('/list', requireTelegramAuth, massOperationsRateLimit, ...);
router.get('/user/:userId', requireTelegramAuth, massOperationsRateLimit, ...);
```

### üéØ –†–ï–®–ï–ù–ò–ï ‚Ññ3: –£–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ React Query
```typescript
retry: (failureCount, error) => {
  // –ù–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –ø—Ä–∏ 429 –æ—à–∏–±–∫–∞—Ö
  if (error?.status === 429) return false;
  return failureCount < 3;
}
```

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û–°–¢–¨ –ü–†–û–ë–õ–ï–ú–´

**–£—Ä–æ–≤–µ–Ω—å:** üî• **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô**
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –°–æ–∑–¥–∞–µ—Ç –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π UX —Å –∫—Ä–∞—Å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏ –æ—à–∏–±–æ–∫
- –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–∞–∂–µ –±–µ–∑ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í–ª–∏—è–µ—Ç –Ω–∞ production –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–¥ production deployment

---

## üìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å SimpleMissionsList –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é  
2. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –î–æ–±–∞–≤–∏—Ç—å rate limiting –≤ missions routes
3. **–£–ª—É—á—à–µ–Ω–∏–µ:** –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å React Query retry –ª–æ–≥–∏–∫—É
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ 429 –æ—à–∏–±–æ–∫ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---
*–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: 8 –∏—é–ª—è 2025, 13:04 UTC*  
*–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å: Agent System Diagnostics*