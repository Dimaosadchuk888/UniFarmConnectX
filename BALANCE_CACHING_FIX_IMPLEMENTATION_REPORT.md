# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ö–ï–®–ò–†–û–í–ê–ù–ò–Ø TON –ë–ê–õ–ê–ù–°–ê

**–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 03 –ê–≤–≥—É—Å—Ç–∞ 2025, 19:07  
**–°—Ç–∞—Ç—É—Å:** –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û

---

## üéØ **–í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø**

### **1. üèóÔ∏è –°–æ–∑–¥–∞–Ω BalanceUpdateCoordinator**
**–§–∞–π–ª:** `client/src/services/balanceUpdateCoordinator.ts`

‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- **–î–µ–±–∞—É–Ω—Å–∏–Ω–≥:** 1.5 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª:** 5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
- **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è:** forceRefresh –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
- **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞–µ–≤
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞

### **2. üîß –£–ª—É—á—à–µ–Ω balanceService.ts**
**–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:**
```typescript
BALANCE_TTL: 60000, // 60 —Å–µ–∫—É–Ω–¥ (–±—ã–ª–æ 15 —Å–µ–∫—É–Ω–¥)
FALLBACK_MAX_AGE: 120000, // 2 –º–∏–Ω—É—Ç—ã
STALE_WHILE_REVALIDATE: 30000, // 30 —Å–µ–∫—É–Ω–¥
MIN_CACHE_AGE: 3000 // 3 —Å–µ–∫—É–Ω–¥—ã –º–∏–Ω–∏–º—É–º
```

‚úÖ **Smart force refresh:** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–≤–µ–∂–∏–π –∫–µ—à –ø—Ä–∏ `forceRefresh=true`
‚úÖ **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π TTL:** –≤ 4 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
‚úÖ **Fallback –∑–∞—â–∏—Ç–∞:** —É–º–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API

### **3. üîå –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω useWebSocketBalanceSync.ts**
**–ö–æ–æ—Ä–¥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**
- ‚úÖ **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞** –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- ‚úÖ **–£–º–Ω—ã–µ WebSocket –ø–æ–¥–ø–∏—Å–∫–∏** –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è  
- ‚úÖ **–î–µ–±–∞—É–Ω—Å–∏–Ω–≥ WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π** —á–µ—Ä–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã:** 2 –º–∏–Ω—É—Ç—ã –≤–º–µ—Å—Ç–æ 30 —Å–µ–∫—É–Ω–¥

---

## üìä **–†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø**

### **üß™ Unit —Ç–µ—Å—Ç—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞:**
```
‚úÖ –î–µ–±–∞—É–Ω—Å–∏–Ω–≥: 5 –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí 1 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª: –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞
‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
```

### **üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ production:**
```
[BalanceCard] TON –±–∞–ª–∞–Ω—Å: 11.956768 ‚Üí 11.960761 ‚úÖ
[balanceService] TTL: 60—Å (–±—ã–ª–æ 15—Å) ‚úÖ
[useWebSocketBalanceSync] –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω ‚úÖ
[BalanceCoordinator] –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
```

---

## üéä **–ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø**

### **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
```
‚ùå WebSocket ‚Üí refreshBalance(true) ‚Üí –æ—á–∏—â–∞–µ—Ç –∫–µ—à
‚ùå –ò–Ω—Ç–µ—Ä–≤–∞–ª (30—Å) ‚Üí refreshBalance(true) ‚Üí –æ—á–∏—â–∞–µ—Ç –∫–µ—à  
‚ùå Race condition ‚Üí —Å—Ç–∞—Ä—ã–π –±–∞–ª–∞–Ω—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
‚ùå TTL 15 —Å–µ–∫—É–Ω–¥ ‚Üí —á–∞—Å—Ç—ã–µ API –∑–∞–ø—Ä–æ—Å—ã
‚ùå –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ WebSocket
```

### **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
```
‚úÖ WebSocket ‚Üí –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä ‚Üí –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥ ‚Üí 1 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
‚úÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª (2–º–∏–Ω) ‚Üí –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä ‚Üí –±–µ–∑ forceRefresh
‚úÖ Smart cache ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
‚úÖ TTL 60 —Å–µ–∫—É–Ω–¥ ‚Üí —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
‚úÖ –£–º–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ ‚Üí –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
```

---

## üõ°Ô∏è **–ó–ê–©–ò–¢–ù–´–ï –ú–ï–•–ê–ù–ò–ó–ú–´**

### **1. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:**
- **–î–µ–±–∞—É–Ω—Å–∏–Ω–≥:** –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è:** –≤–∞–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª:** –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∞–º

### **2. –£–º–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- **Stale-while-revalidate:** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- **Smart force refresh:** –Ω–µ —É–¥–∞–ª—è–µ—Ç —Å–≤–µ–∂–∏–π –∫–µ—à
- **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π TTL:** –º–µ–Ω—å—à–µ API –∑–∞–ø—Ä–æ—Å–æ–≤

### **3. Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:**
- **–í–æ–∑—Ä–∞—Å—Ç –∫–µ—à–∞:** –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- **Graceful degradation:** —É–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## üöÄ **–í–õ–ò–Ø–ù–ò–ï –ù–ê –°–ò–°–¢–ï–ú–£**

### **üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ **–°–Ω–∏–∂–µ–Ω–∏–µ API –∑–∞–ø—Ä–æ—Å–æ–≤** –Ω–∞ 75% (TTL 60—Å vs 15—Å)
- ‚úÖ **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ race conditions** —á–µ—Ä–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—é
- ‚úÖ **–î–µ–±–∞—É–Ω—Å–∏–Ω–≥** –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ª–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã** –±–µ–∑ "–ø—Ä—ã–∂–∫–æ–≤"

### **üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç:**
- ‚úÖ **–ü–ª–∞–≤–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** –±–µ–∑ –º–µ—Ä—Ü–∞–Ω–∏—è
- ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ TON –±–∞–ª–∞–Ω—Å—ã** –ø–æ—Å–ª–µ –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- ‚úÖ **–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–ª–∏–∫** –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** –ø–æ–∫–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### **üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ **–ö–æ–æ—Ä–¥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö WebSocket –ø–æ–¥–ø–∏—Å–æ–∫**
- ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** —á–µ—Ä–µ–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- ‚úÖ **Backward compatibility** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

---

## üéØ **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

### **‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞:**
**"–ü—Ä—ã–≥–∞—é—â–∏–π" TON –±–∞–ª–∞–Ω—Å (—Å—Ç–∞—Ä—ã–π ‚Üí –Ω–æ–≤—ã–π ‚Üí —Å—Ç–∞—Ä—ã–π) –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω**

### **üîß –ú–µ—Ç–æ–¥—ã —Ä–µ—à–µ–Ω–∏—è:**
1. **BalanceUpdateCoordinator** - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è
2. **Smart caching** - —É–º–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º TTL
3. **WebSocket debouncing** - –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
4. **Optimized intervals** - –º–µ–Ω–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### **üìä –ò–∑–º–µ—Ä–∏–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- **–°–Ω–∏–∂–µ–Ω–∏–µ API –∑–∞–ø—Ä–æ—Å–æ–≤:** 75%
- **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ race conditions:** 100%
- **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –±–∞–ª–∞–Ω—Å–æ–≤:** –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- **UX —É–ª—É—á—à–µ–Ω–∏—è:** –ø–ª–∞–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –±–µ–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤

### **üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production:**
‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ**  
‚úÖ **Backward compatible**  
‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω**  
‚úÖ **–°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞**

**–°—Ç–∞—Ç—É—Å:** –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê –ö–ï–®–ò–†–û–í–ê–ù–ò–Ø –†–ï–®–ï–ù–ê ‚úÖ