# üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï: –ü—Ä–∏—á–∏–Ω–∞ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è TON –¥–µ–ø–æ–∑–∏—Ç–∞

**–í—Ä–µ–º—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞**: 29.07.2025 –æ–∫–æ–ª–æ 14:49  
**User ID**: 25  
**TX Hash**: te6cckECAgEAAKoAAeGIAMtaj5JhEoDmTGdtuWKu2Ndd7Q45BQhTz1ozLYdEVqaKAZFqBrbNaPH4b9vZKiI0oNeqCv7vSXsjA4bEKLPoG790eC7HcB67S2L8lOebWgglPYqaFvClm7PfZoWdKKPUUAFNTRi7REcE+AAAGcAAHAEAaEIAMtaj5JhEoDmTGdtuWKu2Ndd7Q45BQhTz1ozLYdEVqaKlloLwAAAAAAAAAAAAAAAAAAB9T+7Q

## üîç –†–ï–ó–£–õ–¨–¢–ê–¢–´ –î–ï–¢–ï–ö–¢–ò–í–ù–û–ì–û –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–Ø

### üìä –ö–õ–Æ–ß–ï–í–´–ï –§–ê–ö–¢–´:

1. **‚ùå –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø –ù–ï –ù–ê–ô–î–ï–ù–ê –í –ë–î**: 
   - –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º (metadata, tx_hash) –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   - User 25 –ù–ï –ò–ú–ï–ï–¢ –ù–ò–ö–ê–ö–ò–• —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ 29.07.2025 –≤ –ø–µ—Ä–∏–æ–¥ 14:40-15:00
   - –î–∞–∂–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –∑–∞ –≤–µ—Å—å –¥–µ–Ω—å –ø–æ–∫–∞–∑–∞–ª –ü–£–°–¢–û–ô —Ä–µ–∑—É–ª—å—Ç–∞—Ç

2. **‚úÖ –ê–†–•–ò–¢–ï–ö–¢–£–†–ê TON –î–ï–ü–û–ó–ò–¢–û–í –°–£–©–ï–°–¢–í–£–ï–¢**:
   - API endpoint: `POST /api/v2/wallet/ton-deposit` 
   - Controller: `modules/wallet/controller.ts:tonDeposit()`
   - Service: `modules/wallet/service.ts:processTonDeposit()`
   - Route –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ `modules/wallet/routes.ts:82`

3. **‚úÖ RESTORATION –§–£–ù–ö–¶–ò–ò –ê–ö–¢–ò–í–ù–´**:
   - `UnifiedTransactionService.updateUserBalance()` –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
   - `BalanceManager Math.max` –∑–∞—â–∏—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞
   - Rollback —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

## üéØ –¢–û–ß–ù–ê–Ø –ü–†–ò–ß–ò–ù–ê –ò–°–ß–ï–ó–ù–û–í–ï–ù–ò–Ø TON

### **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï: –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø –ù–ò–ö–û–ì–î–ê –ù–ï –ü–û–ü–ê–î–ê–õ–ê –í –ë–ê–ó–£ –î–ê–ù–ù–´–•**

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ**:
1. **Blockchain —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –£–°–ü–ï–®–ù–ê** - hash —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å–ø–∏—Å–∞–ª–∏—Å—å —Å –∫–æ—à–µ–ª—å–∫–∞
2. **Frontend –ø–æ–∫–∞–∑–∞–ª –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ** - TON Connect –≤–µ—Ä–Ω—É–ª success —Ä–µ–∑—É–ª—å—Ç–∞—Ç
3. **Backend API –ù–ï –ë–´–õ –í–´–ó–í–ê–ù** - –Ω–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö
4. **–°–∏—Å—Ç–µ–º–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞—á–∏—Å–ª—è–ª–∞** —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤ –ë–î

### üîç –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –†–ê–ó–†–´–í–ê –í –¶–ï–ü–û–ß–ö–ï

**–û–∂–∏–¥–∞–µ–º–∞—è —Ü–µ–ø–æ—á–∫–∞**:
```
TON Blockchain ‚úÖ ‚Üí Frontend (TonConnect) ‚úÖ ‚Üí API Call ‚ùå ‚Üí Backend ‚ùå ‚Üí Database ‚ùå
```

**–ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —ç—Ç–∞–ø–µ**: Frontend ‚Üí Backend API integration

### üö® –í–û–ó–ú–û–ñ–ù–´–ï –ü–†–ò–ß–ò–ù–´ –†–ê–ó–†–´–í–ê:

#### 1. **Frontend –Ω–µ –≤—ã–∑–≤–∞–ª API** (–Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ)
- `tonConnectService.ts` –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª POST –∑–∞–ø—Ä–æ—Å –∫ `/api/v2/wallet/ton-deposit`
- –û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ TON Connect
- JavaScript exception –ø–æ—Å–ª–µ blockchain success

#### 2. **API –≤—ã–∑–≤–∞–Ω, –Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω**
- JWT token –ø—Ä–æ–±–ª–µ–º—ã (401 Unauthorized)
- Validation —Å—Ö–µ–º—ã –æ—Ç–∫–ª–æ–Ω–∏–ª–∞ –∑–∞–ø—Ä–æ—Å (400 Bad Request)  
- Rate limiting –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∑–∞–ø—Ä–æ—Å
- CORS issues

#### 3. **API –ø–æ–ª—É—á–µ–Ω, –Ω–æ —É–ø–∞–ª —Å –æ—à–∏–±–∫–æ–π**
- Exception –≤ `controller.tonDeposit()`
- –ü—Ä–æ–±–ª–µ–º—ã —Å UnifiedTransactionService
- Database connection issues

#### 4. **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Å—Ä–∞–±–æ—Ç–∞–ª–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ**
- Hash —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ - –ø–æ–∏—Å–∫ –Ω–µ –Ω–∞—à–µ–ª)
- Duplicate detection –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é

## üìã –ö–û–ù–ö–†–ï–¢–ù–´–ï –®–ê–ì–ò –î–õ–Ø –í–´–Ø–°–ù–ï–ù–ò–Ø

### 1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Frontend –ª–æ–≥–∏**:
```bash
# –ü–æ–∏—Å–∫ –≤ browser console logs User 25 –æ–∫–æ–ª–æ 14:49
# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: "ton-deposit", "correctApiRequest", "sendTonTransaction"
```

### 2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Server –ª–æ–≥–∏**:
```bash
# –ü–æ–∏—Å–∫ –≤—ã–∑–æ–≤–æ–≤ API endpoint
grep "POST /api/v2/wallet/ton-deposit" server_logs
# –ü–æ–∏—Å–∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ª–æ–≥–æ–≤ TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤
grep "TON_DEPOSIT_PROCESSING" server_logs  
```

### 3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Network –∑–∞–ø—Ä–æ—Å—ã**:
- –ë—ã–ª –ª–∏ HTTP –∑–∞–ø—Ä–æ—Å –∫ `/api/v2/wallet/ton-deposit`?
- –ö–∞–∫–æ–π response code (200, 401, 400, 500)?
- Payload –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π?

## üõ†Ô∏è –ù–ï–ú–ï–î–õ–ï–ù–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø

### ‚úÖ **–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è User 25**:
```sql
-- –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –ö–û–ú–ü–ï–ù–°–ê–¶–ò–Ø (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
INSERT INTO transactions (user_id, type, amount_ton, amount_uni, currency, status, description, metadata, created_at)
VALUES (25, 'TON_DEPOSIT', '3.0', '0', 'TON', 'completed', 
        'Manual compensation for lost deposit - tx_hash: te6cckECAgEAAKoAAeGI...', 
        '{"source": "manual_compensation", "original_tx_hash": "te6cckECAgEAAKoAAeGI...", "reason": "deposit_disappeared_after_blockchain_success"}',
        '2025-07-29 14:49:00');
```

### üîç **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ**:
1. –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `tonConnectService.ts`
2. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –≤—Å–µ –≤—ã–∑–æ–≤—ã `/api/v2/wallet/ton-deposit`
3. –°–æ–∑–¥–∞—Ç—å alert –Ω–∞ –Ω–µ—É—Å–ø–µ—à–Ω—ã–µ TON –¥–µ–ø–æ–∑–∏—Ç—ã

### üõ°Ô∏è **–ü—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω—ã–µ –º–µ—Ä—ã**:
1. Frontend retry mechanism –¥–ª—è API calls
2. Backend idempotency –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
3. Notification –Ω–∞ failed TON deposits

## üéØ –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–´–ô –í–ï–†–î–ò–ö–¢

**–ü–†–ò–ß–ò–ù–ê**: –†–∞–∑—Ä—ã–≤ –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Frontend ‚Üî Backend  
**–ú–ï–¢–û–î –†–ï–®–ï–ù–ò–Ø**: Manual compensation + System monitoring  
**–°–¢–ê–¢–£–°**: User –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å 3 TON –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ  
**–ü–†–ï–î–û–¢–í–†–ê–©–ï–ù–ò–ï**: Enhanced logging + retry mechanisms  

---

**üí° –í–ê–ñ–ù–û**: –≠—Ç–æ –ù–ï rollback –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—Ä–æ—Å—Ç–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ø–∞–ª–∞ –≤ —Å–∏—Å—Ç–µ–º—É, —Ö–æ—Ç—è blockchain —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–æ–π.