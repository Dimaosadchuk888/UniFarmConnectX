# Роль: Senior TypeScript Engineer + Backend Debug Specialist (Telegram | SQL | Async Tasks)

Твоя задача — аккуратно усунути перелік технічних помилок нижче без порушення існуючого production-коду.

## ВАЖЛИВО:
- Нічого не видаляй, що не заважає роботі
- Ніде не використовуй @ts-ignore
- Не змінюй структуру файлів і не прибирай вже налаштовану бізнес-логіку
- Дай чіткий звіт по кожному з пунктів: що саме було виправлено, у якому файлі і яка причина помилки

## СПИСОК ПРОБЛЕМ:

1. ❗ [Telegram ERROR] Помилка налаштування webhook: 429  
   Too Many Requests: retry after 1  
   Ймовірна причина: Повторне встановлення webhook без перевірки існуючого.  
   Що зробити: перед викликом setWebhook() перевір, чи він вже існує (через `getWebhookInfo()`).

2. ❗ [ReferralBonusProcessor] Error recovering failed processing  
   TypeError: db.select is not a function  
   Ймовірна причина: Неправильна інстанція db (можливо db = undefined або об'єкт без методу select).  
   Що зробити: перевір, який саме об’єкт підставляється в db і чи імпортується коректна версія.

3. ❗ [OptimizedReferralTreeService] Ошибка при создании индексов  
   TypeError: this.db.execute is not a function  
   Ймовірна причина: Використовується об'єкт без методу execute або this не той контекст.  
   Що зробити: Перевір ініціалізацію this.db та чи правильно переданий контекст класу.

4. ❗ [Server] Ошибка при миграции реферальных кодов  
   TypeError: db.select is not a function  
   Ймовірна причина: Як і вище — db або неправильно створений, або втрачено тип.  
   Що зробити: Пройтись по логіці імпорту db та впевнитися, що це один валідний об'єкт.

5. ❗ [Background Tasks] Error initializing referral processor  
   TypeError: this.db.execute is not a function  
   Ймовірна причина: Повтор цієї ж помилки — або не той db, або метод відсутній у класі.  
   Що зробити: Внести типізацію для this.db, перевірити інжекцію залежності.

---

## ДОДАТКОВІ ВИМОГИ:
- Якщо db — це модуль типу pg, переконайся, що методи select, execute або інші дійсно реалізовані. Якщо це abstraction layer — перевір, що вона підключена.
- Якщо помилки через dist/index.js, то бажано відтворити вихідний `.ts`-файл і внести зміни там, а не в збілдженому коді.
- Зроби все максимально чисто: з коментарями і окремими комітами.

## ПО ЗАВЕРШЕННЮ:
Виведи повний технічний звіт по кожному з 5 пунктів:
- Причина помилки
- У якому файлі знайдено
- Яке саме рішення реалізовано
- Чи потребує воно подальшого супроводу