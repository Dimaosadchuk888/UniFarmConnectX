Задача: Аудит и корректировка инициализации Telegram WebApp API

Цель: устранить предупреждение Приложение не открыто из Telegram и обеспечить корректную загрузку window.Telegram.WebApp

⸻

1. Внести правки в index.html

Что сделать:
 • Переместить <meta name="telegram-web-app-ready" content="true" /> сразу после <meta charset="UTF-8" />
 • Добавить скрипт перед загрузкой React, который:
 • устраняет слэш в URL
 • сохраняет initData из window.Telegram.WebApp в sessionStorage

Фрагмент кода: <script>
// Удаление слеша
if (window.location.pathname.endsWith('/') && window.location.pathname !== '/') {
  window.history.replaceState({}, document.title,
    window.location.pathname.slice(0, -1) + window.location.search + window.location.hash
  );
}

// Проверка Telegram API
window.addEventListener('DOMContentLoaded', function () {
  const isTelegramAvailable = typeof window.Telegram !== 'undefined';
  const isWebAppAvailable = isTelegramAvailable && typeof window.Telegram.WebApp !== 'undefined';

  if (isWebAppAvailable && window.Telegram.WebApp.initData) {
    try {
      sessionStorage.setItem('telegramInitData', window.Telegram.WebApp.initData);
    } catch (e) {
      console.error('[Telegram WebApp] Save error:', e);
    }
  }
});
</script> 



⸻

2. Добавить отладочную проверку в client/src/main.tsx

Перед запуском React-приложения: console.log('[TG INIT] Telegram object state:', {
  telegramDefined: typeof window.Telegram !== 'undefined',
  webAppDefined: typeof window.Telegram?.WebApp !== 'undefined',
  initDataLength: window.Telegram?.WebApp?.initData?.length || 0,
  savedInitData: sessionStorage.getItem('telegramInitData')?.length || 0
}); 



⸻

3. Обновить компонент TelegramInitDataWarning

Учитывать состояние Telegram API и sessionStorage: const checkTelegramWebAppState = () => {
  const hasTelegramObj = typeof window !== 'undefined' && !!window.Telegram;
  const hasWebAppObj = hasTelegramObj && !!window.Telegram?.WebApp;

  let initData = hasWebAppObj ? window.Telegram.WebApp.initData : '';

  if ((!initData || initData.trim() === '') && typeof window !== 'undefined') {
    try {
      const saved = sessionStorage.getItem('telegramInitData');
      if (saved && saved.trim() !== '') {
        initData = saved;
      }
    } catch (e) {
      console.error('[TelegramInitDataWarning] Session read error:', e);
    }
  }

  return !!initData && initData.length > 0;
};



⸻

Требование:

Не переписывать существующую логику. Только расширить текущие проверки и инициализацию.