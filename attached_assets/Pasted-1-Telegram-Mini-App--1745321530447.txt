1. Цель

Провести полный аудит причины, по которой в Telegram Mini App не отображается реферальная ссылка, и подготовить рекомендации/патч без нарушения работающей функциональности.

2. Задачи
 1. Диагностика
 • Проанализировать цепочку получения ref_code от сервера до рендер‑компонента.
 • Проверить, приходит ли ref_code в ответе /api/me, правильно ли он кладётся в стейт/контекст, и где «теряется» при отображении.
 • Проследить, какие проверки (isTelegramWebApp, initData, userId и т.д.) могут блокировать вывод ссылки в Mini App.
 • Составить список файлов/функций, которые задействованы в этой цепочке (пример: UserController.ts, TelegramService.ts, ReferralLinkCard.tsx, …).
 2. Локальный аудит кода
 • Отметить все места, где возможны:
• Неверные условия (if (isTelegramAvailable)),
• Обработки ошибок, выводящие «Не удалось получить ссылку»,
• Ранние return’ы или неоптимальные таймауты/ретраи.
 • Зафиксировать это в отчёте (файл audit-ref-link.md или ответ‑комментарий).
 3. Минимальная правка (опционально)
 • Если выяснится одна очевидная причина (например, пропущенный await, опечатка в key), внести точечное прав­к‑фикс; иначе подготовить пул/патч‑реквест в отдельной ветке без мержа.

3. Ограничения и правила работы : №
Ограничение
Пояснение
1
Не изменять бизнес‑логику маркетинга, начислений, расчётов, сохранённых процентов и уровней.

2
Не трогать файлы, не относящиеся к задаче (фарминг, кошелёк, TON‑connect и т.п.) без явного запроса‑обоснования.

3
Запрещено удалять/переименовывать существующие модели, миграции, env‑ключи.

4
Каждое потенциально рискованное изменение описывать в чате и ждать подтверждения прежде чем коммитить.

5
После правок запускать npm run dev + локальный тест Mini App в dev‑окне Replit и прикладывать скрин/лог.

4. Что делать, если нужен доступ к «чужому» файлу?
 1. В чате указать полный путь к файлу/директории.
 2. Коротко описать, зачем он нужен для решения задачи.
 3. Ждать одобрения.

5. Ожидаемые результаты
 • Отчёт с найденными проблемами и их приоритетами.
 • (Опционально) Pull‑/merge‑request или коммит fix/ref-link-display с точечным исправлением.
 • Инструкция, как перепроверить в Telegram Mini App (в т. ч. список тест‑кейсов).

⸻

Формат ответов:
 • Для отчёта — маркдаун‑список.
 • Для кода — дифф или ссылка на ветку.
 • Для всех вопросов к нам — начинайте строку с ❓.