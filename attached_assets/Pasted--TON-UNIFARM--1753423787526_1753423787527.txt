üìã –ê–ù–ê–õ–ò–ó –û–ë–†–ê–ë–û–¢–ö–ò TON –î–ï–ü–û–ó–ò–¢–û–í –í UNIFARM
–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –≤–∞—à–µ–≥–æ –∫–æ–¥–∞, –≤–æ—Ç –∫–∞–∫ —É –≤–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–ø–æ–∑–∏—Ç–æ–≤ TON:

1. –§–∞–π–ª—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–ø–æ–∑–∏—Ç–æ–≤
core/TransactionService.ts: –º–µ—Ç–æ–¥ createTransaction()
–°—Ç—Ä–æ–∫–∏ 102-120: –°–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –ë–î
–°—Ç—Ä–æ–∫–∞ 114: tx_hash_unique: metadata?.tx_hash || null - –ó–ê–©–ò–¢–ê –û–¢ –î–£–ë–õ–ò–ö–ê–¢–û–í —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
TRANSACTION_TYPE_MAPPING —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ: 'TON_DEPOSIT': 'FARMING_REWARD' (—Å—Ç—Ä–æ–∫–∞ 21)
modules/wallet/service.ts: –ª–æ–≥–∏–∫–∞ –Ω–∞ —Å—Ç—Ä–æ–∫–∞—Ö 380-395
// UnifiedTransactionService –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
// - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã —á–µ—Ä–µ–∑ metadata.tx_hash
// - –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ BalanceManager üìã –ê–ù–ê–õ–ò–ó –û–ë–†–ê–ë–û–¢–ö–ò TON –î–ï–ü–û–ó–ò–¢–û–í –í UNIFARM
–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –≤–∞—à–µ–≥–æ –∫–æ–¥–∞, –≤–æ—Ç –∫–∞–∫ —É –≤–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–ø–æ–∑–∏—Ç–æ–≤ TON:
## 1. **–§–∞–π–ª—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–ø–æ–∑–∏—Ç–æ–≤**
### **core/TransactionService.ts: –º–µ—Ç–æ–¥ `createTransaction()`**
- **–°—Ç—Ä–æ–∫–∏ 102-120**: –°–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –ë–î
- **–°—Ç—Ä–æ–∫–∞ 114**: `tx_hash_unique: metadata?.tx_hash || null` - **–ó–ê–©–ò–¢–ê –û–¢ –î–£–ë–õ–ò–ö–ê–¢–û–í —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞**
- **TRANSACTION_TYPE_MAPPING** —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ: `'TON_DEPOSIT': 'FARMING_REWARD'` (—Å—Ç—Ä–æ–∫–∞ 21)
### **modules/wallet/service.ts: –ª–æ–≥–∏–∫–∞ –Ω–∞ —Å—Ç—Ä–æ–∫–∞—Ö 380-395**
```typescript
// UnifiedTransactionService –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
// - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã —á–µ—Ä–µ–∑ metadata.tx_hash
// - –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ BalanceManager  
// - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
// - –ü—Ä–∞–≤–∏–ª—å–Ω–æ –º–∞–ø–∏—Ç TON_DEPOSIT -> FARMING_REWARD
modules/wallet/controller.ts: –º–µ—Ç–æ–¥ tonDeposit
Wallet-Based Deposit Resolution –Ω–∞ —Å—Ç—Ä–æ–∫–∞—Ö 440-470
3 —É—Ä–æ–≤–Ω—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: JWT ‚Üí –∫–æ—à–µ–ª–µ–∫ ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
–í—ã–∑—ã–≤–∞–µ—Ç walletService.processTonDeposit() –Ω–∞ —Å—Ç—Ä–æ–∫–µ 466
client/src/services/tonConnectService.ts: –º–µ—Ç–æ–¥ sendTonTransaction()
–°–æ–∑–¥–∞–µ—Ç BOC-payload —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º "UniFarm"
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —á–µ—Ä–µ–∑ TON Connect
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {txHash, status} –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
2. –õ–æ–≥–∏–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ TransactionService: tx_hash_unique: metadata?.tx_hash || null
‚úÖ metadata.tx_hash –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏–∑ WalletService (—Å—Ç—Ä–æ–∫–∞ 393)
–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ tx_hash_unique:
‚úÖ –î–∞, –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ TransactionService
–ò—Å—Ç–æ—á–Ω–∏–∫: metadata.tx_hash –∏–∑ ton_tx_hash –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
TRANSACTION_TYPE_MAPPING:
const TRANSACTION_TYPE_MAPPING = {
  'TON_DEPOSIT': 'FARMING_REWARD',        // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –º–∞–ø–∏—Ç—Å—è
  'UNI_DEPOSIT': 'FARMING_REWARD',        
  'BOOST_PURCHASE': 'FARMING_REWARD',     
  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–∞–ø–ø–∏–Ω–≥–∏
}
3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
client/src/contexts/webSocketContext.tsx:
–ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–æ–∫–µ 145: setTimeout(() => connect(), 100)
Heartbeat ping –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (—Å—Ç—Ä–æ–∫–∞ 62)
–ê–≤—Ç–æ–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –æ–±—Ä—ã–≤–µ (—Å—Ç—Ä–æ–∫–∞ 113)
–û–±—Ä–∞–±–æ—Ç–∫–∞ balance_update –Ω–∞ —Å—Ç—Ä–æ–∫–µ 81
core/BalanceManager.ts:
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ updateUserBalance()
WebSocket callback: onBalanceUpdate?: (changeData) => Promise<void>
–ó–∞—â–∏—Ç–∞ –æ—Ç Race Condition —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ user_id –∏ —Å—É–º–º
modules/transactions/service.ts:
–ü–æ–ª–Ω–∞—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ UnifiedTransactionService (—Å—Ç—Ä–æ–∫–∞ 31)
–í—Å–µ –º–µ—Ç–æ–¥—ã –¥–µ–ª–µ–≥–∏—Ä—É—é—Ç—Å—è –Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å
4. –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
–ü–æ–ª—è –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:
‚úÖ tx_hash_unique - –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ metadata.tx_hash
‚úÖ is_duplicate - boolean —Ñ–ª–∞–≥ –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
‚úÖ duplicate_of_id - —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
‚úÖ metadata - JSON –ø–æ–ª–µ —Å tx_hash
–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å:
–¢–†–ï–ë–£–ï–¢–°–Ø –°–û–ó–î–ê–¢–¨: CREATE UNIQUE INDEX idx_tx_hash_unique ON transactions((metadata->>'tx_hash'))
5. Frontend –ª–æ–≥–∏–∫–∞
–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã API:
–ù–ï–¢ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
–ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö txHash –Ω–∞ frontend
–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: sendTonTransaction() ‚Üí /api/v2/wallet/ton-deposit
–ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è:
–û–¢–°–£–¢–°–¢–í–£–ï–¢ –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–¥–µ
–ö–Ω–æ–ø–∫–∞ disabled —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è isProcessing
TonDepositCard.tsx –ª–æ–≥–∏–∫–∞:
// –°—Ç—Ä–æ–∫–∏ 121-133: –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ API –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è txHash
// –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
üö® –ù–ê–ô–î–ï–ù–ù–´–ï –£–Ø–ó–í–ò–ú–û–°–¢–ò:
–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤ –ë–î –Ω–∞ tx_hash_unique
Frontend –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
–í–æ–∑–º–æ–∂–µ–Ω Race Condition –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –Ω–∞–∂–∞—Ç–∏–∏
WebSocket –º–æ–∂–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –±–∞–ª–∞–Ω—Å–∞
‚úÖ –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢ –ü–†–ê–í–ò–õ–¨–ù–û:
TransactionService –∑–∞–ø–æ–ª–Ω—è–µ—Ç tx_hash_unique
TRANSACTION_TYPE_MAPPING –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
Wallet-Based Deposit Resolution —Ä–∞–±–æ—Ç–∞–µ—Ç
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —á–µ—Ä–µ–∑ UnifiedTransactionService
BalanceManager –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
