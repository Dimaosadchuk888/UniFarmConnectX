# AGENT PROMPT ‚Äî –ê—É–¥–∏—Ç –ø–µ—Ä–µ–¥–∞—á–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ `initData JWT` –≤ Mini-App UniFarm

## üéØ  –¶–µ–ª—å
–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, —á—Ç–æData JWT` –≤ –∏–∑ Telegram Mini-App:
1. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ.
2. –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è –Ω–∞ backend –±–µ–∑ –ø–æ—Ç–µ—Ä—å –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
3. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏ (HMAC-SHA256 —Å Bot Token).
4. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ (`start_param`) –∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏.

---

## üîç  –®–∞–≥–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏

### 1. –§—Ä–æ–Ω—Ç–µ–Ω–¥  
1. –ù–∞–π—Ç–∏, –≥–¥–µ —á–∏—Ç–∞–µ—Ç—Å—è—Ä–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ (`start_param`) –∏ —Å–æ 
   ```bash
   rg -n "initData" client/ --type ts,tsx,js

 2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ initData –±–µ–∑ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ API:
 ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª—ã —Å fetch('/api/auth/verify' –∏–ª–∏ –ø–æ—Ö–æ–∂–∏–º.
 ‚Ä¢ –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π —Ç–æ—á–Ω–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ (initData –¥–æ–ª–∂–µ–Ω –∏–¥—Ç–∏ –≤ raw –≤–∏–¥–µ –∏–ª–∏ JSON).

2. Network-Layer
 1. –õ–æ–∫–∞–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å Mini-App, –æ—Ç–∫—Ä—ã—Ç—å DevTools ‚Üí Network.
 2. –ù–∞–π—Ç–∏ –∑–∞–ø—Ä–æ—Å, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π initData.
 3. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ payload –∏ –ø—Ä–∏–ª–æ–∂–∏—Ç—å –≤ –æ—Ç—á—ë—Ç.

3. Backend (routes / controllers)
 1. –ù–∞–π—Ç–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏:

rg -n "verifyInitData" modules/ | head

–∏–ª–∏ "/auth/verify"

 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ –Ω—ë–º:
 ‚Ä¢ –î–æ—Å—Ç–∞—ë—Ç—Å—è initData –∏–∑ body –∏–ª–∏ header.
 ‚Ä¢ –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è checkTelegramInitData(initData, BOT_TOKEN).
 3. –ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é checkTelegramInitData:
 ‚Ä¢ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ö—ç—à —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É Telegram:
hex(HMAC_SHA256(botToken, sorted_query_string)) === hash
 ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ
 ‚Ä¢ –æ—Ç—Å–µ–∫–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—à–µ 24 —á (–ø–æ auth_date),
 ‚Ä¢ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ / 401 –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º —Ö—ç—à–µ.

4. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
 1. –í –º–µ—Å—Ç–µ, –≥–¥–µ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞, –Ω–∞–π—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ start_param.
 2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ
 ‚Ä¢ –µ—Å–ª–∏ start_param = ref_code, —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å—Ç—Ä–æ–∫–∞ –≤ referrals,
 ‚Ä¢ –¥—É–±–ª–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è (ON CONFLICT DO NOTHING).

5. –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç

–≠—Ç–∞–ø OK? –§–∞–π–ª / –°—Ç—Ä–æ–∫–∞ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
initData —á–∏—Ç–∞–µ—Ç—Å—è ‚úÖ/‚ùå client/App.tsx:42 ‚Ä¶
initData –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚úÖ/‚ùå network capture ‚Ä¶
–ü–æ–¥–ø–∏—Å—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è ‚úÖ/‚ùå modules/auth/verify.ts:30 ‚Ä¶
start_param –∑–∞–ø–∏—Å–∞–Ω ‚úÖ/‚ùå modules/referral/service.ts:77 ‚Ä¶


‚∏ª

‚õî  –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
 ‚Ä¢ –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ: –Ω–µ –∏–∑–º–µ–Ω—è—Ç—å –∫–æ–¥ –∏ –ë–î.
 ‚Ä¢ –ù–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ Bot Token –∏–ª–∏ initData –≤ –æ—Ç—á—ë—Ç–µ ‚Äî –º–∞—Å–∫–∏—Ä—É–π –∏—Ö.

üìé  –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–¥–∞—á–∏

–§–∞–π–ª initdata_audit.md, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π:
 1. –¢–∞–±–ª–∏—Ü—É –≤—ã—à–µ (—Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞).
 2. –°—ã—Ä–æ–π –ø—Ä–∏–º–µ—Ä initData (hash —Å–∫—Ä—ã—Ç).
 3. –í—ã–≤–æ–¥: ¬´–ø–µ—Ä–µ–¥–∞—á–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã / –µ—Å—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (–ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç—å)¬ª.

–û—Ç–¥–∞–π –∞–≥–µ–Ω—Ç—É —ç—Ç–æ—Ç —á–µ–∫-–ª–∏—Å—Ç ‚Äî –ø–æ–ª—É—á–∏—à—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –æ —Ç–æ–º, –∫–∞–∫ initData JWT –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —Ç–≤–æ—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.