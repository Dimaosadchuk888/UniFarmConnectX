Техническое задание №2: Реферальные начисления от дохода с фарминга (доход от дохода)

Цель:
Реализовать систему реферальных начислений, в которой бонусы начисляются пользователям только от дохода их рефералов, полученного через фарминг. Продажи бустов и любые одноразовые действия не участвуют в начислениях.

1. Структура уровней и процентов:

| Уровень | Процент от дохода реферала |
|--------:|-----------------------------|
| 1       | 100%                        |
| 2       | 2%                          |
| 3       | 3%                          |
| 4       | 4%                          |
| 5       | 5%                          |
| 6       | 6%                          |
| 7       | 7%                          |
| 8       | 8%                          |
| 9       | 9%                          |
| 10      | 10%                         |
| 11      | 11%                         |
| 12      | 12%                         |
| 13      | 13%                         |
| 14      | 14%                         |
| 15      | 15%                         |
| 16      | 16%                         |
| 17      | 17%                         |
| 18      | 18%                         |
| 19      | 19%                         |
| 20      | 20%                         |

2. Источник начислений:
- Начисления происходят только от доходов рефералов, полученных через фарминг.
- Доход считается как проценты по UNI фармингу и TON фармингу (ежесекундные начисления).
- Система берёт начисление за текущую секунду (или минуту) и распределяет по уровням согласно % выше.

3. Начисление и хранение:
- Хранение:
  - Таблица transactions: каждая выплата фиксируется с типом referral_reward.
  - Таблица users: поле referral_earnings суммирует все полученные доходы от партнёров.
  - Таблица referrals: хранит связи пригласивший → приглашённый.
- Формат транзакции:
  - type: referral_reward
  - description: Referral reward from level [номер уровня]
  - source_user_id: ID реферала, чьи доходы стали источником

4. Техническая реализация:
- FarmingService / BalanceUpdater:
  - при каждом начислении дохода пользователю (от фарминга), вызывается ReferralService.processFarmingReferralReward(userId, earnedAmount)
- ReferralService:
  - Рекурсивно проходит по иерархии до 20 уровней вверх
  - Для каждого уровня берёт соответствующий процент из массива LEVEL_PERCENTS
  - Начисляет бонус в UNI или TON на баланс пригласителя
  - Создаёт запись в transactions

5. Ограничения и контроль:
- Фиксация уровней: структура и проценты не должны изменяться без утверждения.
- Отображение в интерфейсе:
  - В “Партнёрке” показывать: доход от фарминга (не от покупок)
  - В “Истории транзакций”: отмечать такие бонусы как referral_reward
- Временные задержки: начисления должны происходить в реальном времени или с минимальной буферизацией (до 10 секунд).

6. Что нельзя делать (ограничения):
- НЕ использовать покупки бустов как источник реферальных начислений
- НЕ начислять бонусы от первоначального депозита или регистрации
- НЕ использовать фиксированные суммы — только % от фармингового дохода
- НЕ отображать доход от покупок в “доходе от партнёров”