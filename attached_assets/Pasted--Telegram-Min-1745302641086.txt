⸻

Техническое задание: Аудит и устранение проблемы с отображением реферальной ссылки в Telegram Mini App UniFarm

Цель задачи

Полностью устранить проблему, при которой реферальная ссылка не отображается в Mini App, несмотря на корректную генерацию ref_code в базе данных для пользователя.

⸻

1. Проверка генерации и передачи ref_code

Проблема:
 • ref_code создается только для тестового пользователя с id=1
 • У новых пользователей ref_code не создаётся из-за некорректной инициализации Telegram ID

Решение:
 • Проверить и доработать логику генерации ref_code в UserController.ts, особенно в блоке первого входа.
 • Обеспечить проверку ref_code при каждом запросе к /api/me, и при его отсутствии — создать новый.
 • Добавить в логах явную фиксацию, когда ref_code создан, пропущен или не сгенерирован.

⸻

2. Устранение ошибок Telegram WebApp

Проблема:
 • В devtools Mini App Telegram объект не инициализируется (Telegram object not available)
 • Это блокирует получение telegram_id, без которого не создаётся пользователь

Решение:
 • Улучшить telegramService.ts: добавить поддержку всех форматов получения telegram_id (query params, headers, initData)
 • Добавить логи ошибок и fallback для window.Telegram.WebApp.initDataUnsafe

⸻

3. Компонент ReferralLinkCard.tsx

Проблема:
 • Отображает ошибку через 3 секунды, если не получен ref_code, даже если он появляется позже

Решение:
 • Добавить повторный запрос ref_code через 2–3 секунды, если он не был получен
 • Добавить кнопку Обновить ссылку, если ref_code не пришёл
 • Всегда отображать loader “Получение ссылки…” в момент загрузки

⸻

4. Улучшение API и диагностики

Добавить:
 • Эндпоинт /api/telegram-debug, возвращающий текущее состояние initData, telegram_id, ref_code, username — только для админов
 • Расширенное логирование при каждом входе пользователя: source (telegram или web), данные, результат и ошибки

⸻

5. Проверка базы данных

SQL-запрос для Replit: SELECT id, telegram_id, username, ref_code FROM users ORDER BY id ASC; 

Цель:
 • Проверить, создаются ли пользователи вообще
 • Убедиться, что ref_code не дублируется, создаётся для всех

⸻

6. Проверка Mini App внутри Telegram

Проверить в боевом режиме:
 • Telegram WebApp инициализируется
 • ref_code отображается
 • Ссылка формируется в формате:
https://t.me/UniFarmingBot/app?startapp=ref_КОД
 • Ошибки Telegram object not found — не возникают

⸻

Результат считается выполненным, если:
 • Реферальная ссылка отображается у всех новых пользователей
 • Нет ошибок Telegram WebApp в консоли
 • В БД создаются новые пользователи с корректными telegram_id и ref_code
 • Ошибки ref_code not received исчезли
 • Все действия логируются и отслеживаются