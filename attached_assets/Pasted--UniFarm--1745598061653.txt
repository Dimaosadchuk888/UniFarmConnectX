Техническое задание: Пошаговая реализация новой реферальной системы UniFarm

Цель:

Постепенно перейти на внутреннюю систему генерации и управления ref_code, без использования данных Telegram. Важно сохранить стабильную работу всех текущих функций: фарминг, партнёрка, реферальная глубина, начисления, кошелёк.

⸻

Порядок этапов (ТЗ):

⸻

Этап 1 — Подготовка (никаких изменений в логике)

Что делаем:
 • Отключаем использование всех Telegram-полей (username, id, userAgent и т.д.) из регистрации и партнёрки
 • Проверяем, что Telegram теперь используется только как точка запуска Mini App

Подтверждение:
Пользователь может запускать Mini App только через Telegram, но логика больше не зависит от Telegram API

⸻

Этап 2 — Внедрение guest_id

Что делаем:
 • При первом визите Mini App система генерирует и сохраняет guest_id (если он ещё не создан)
 • guest_id используется как ключ для создания/определения пользователя

Важно:
Пока продолжается работа старой системы — новый ID не заменяет существующий, а просто добавляется

⸻

Этап 3 — Автоматическая генерация ref_code

Что делаем:
 • Если ref_code ещё не был сгенерирован → генерируем автоматически при первом визите
 • Код сохраняется в БД навсегда и не перезаписывается

Важно:
Существующие ref_code не трогаем. Генерация включается только для новых пользователей

⸻

Этап 4 — Привязка inviter_id

Что делаем:
 • Если пользователь зашёл с параметром ?start=Z81KX2, сохраняем inviter_id только при первой регистрации
 • Если inviter_id уже есть — не перезаписываем

Важно:
Убедиться, что старая логика ref_path, referrals не поломана — а просто читается по-новому

⸻

Этап 5 — Безопасное восстановление пользователя

Что делаем:
 • При повторном заходе по guest_id или сохранённой сессии — возвращаем старый кабинет
 • Только удаление Telegram-бота даёт право создать новый аккаунт

Важно:
Никакие старые пользователи не теряют свои кабинеты и не получают новых по ошибке

⸻

Этап 6 — Поддержка AirDrop-режима

Что делаем:
 • Регистрируем и сохраняем пользователей даже если Telegram недоступен
 • ref_code, ref_path, inviter_id — всё формируется как обычно через guest_id

Важно:
AirDrop работает независимо от Telegram — вся партнёрка, фарминг и бусты активны

⸻

Этап 7 — Блокировка запуска вне Telegram

Что делаем:
 • Mini App должен запускаться только из Telegram
 • Если зашли по ссылке с браузера — показываем баннер “Открой через Telegram”

Важно:
Это финальный якорь безопасности: без Telegram невозможна регистрация

⸻

Этап 8 — Проверка всех сценариев

Что проверяем:
 • Заход по ссылке — ref_code создаётся
 • Повторный заход — ref_code не меняется
 • Заход с другого устройства без бота — кабинет не создаётся
 • После удаления бота — можно создать новый кабинет

⸻

Как отмечать прогресс:
 • После каждого этапа Replit предоставляет:
 • Скрин или лог реализации
 • Проверку на сохранение всех работающих функций
 • Подтверждение, что ничего не поломано

⸻