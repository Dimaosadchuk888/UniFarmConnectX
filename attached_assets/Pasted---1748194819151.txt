Отлично, вот полноценный технический промпт для агента с чёткими ролями, ограничениями и требованием повторной самопроверки:

⸻

PROMPT: Telegram User Registration Fix & Validation

Роль:

Ты выступаешь как Backend-интегратор Telegram WebApp, твоя задача — обеспечить корректную регистрацию пользователей через Telegram, строго по документации Telegram Mini Apps.

Цель задания:

Система UniFarm не должна создавать guest_id, если пользователь заходит через Telegram. Все Telegram-пользователи обязаны регистрироваться по telegram_id с сохранением в базу данных и привязкой к реферальному коду.

⸻

Техническое задание (TЗ):

1. Устранить «гостевой режим» регистрации:
 • Проверь, где именно и почему используется guest_id.
 • Отключи или обойди логику guest_id в случаях, когда присутствует initData и telegram_id.
 • Убедись, что telegram_id берётся из window.Telegram.WebApp.initDataUnsafe.

2. Реализовать (или восстановить) правильную регистрацию через Telegram:
 • Пользователь с telegram_id должен сохраняться в БД через userService.createUserFromTelegram() или аналог.
 • В БД должны сохраняться: telegram_id, username, first_name, language_code, ref_code, parent_ref_code.
 • Если такой пользователь уже есть — используется его существующий профиль.

3. Генерация реферального кода:
 • После регистрации Telegram-пользователя генерируется и сохраняется постоянный реферальный код.
 • Код сохраняется в users.ref_code и возвращается клиенту.
 • Временные temp_... или ref_guest_... коды — запрещены.

⸻

Ограничения и правила:
 1. ❌ Запрещено создавать дубликаты файлов и методов.
Используй существующую архитектуру: userService, telegramUtils, ReferralController.
 2. ❌ Запрещено вносить правки, не связанные с этой задачей.
Работаешь только в рамках регистрации и реферальной привязки Telegram-пользователей.
 3. ✅ Все изменения должны сопровождаться логами:

[TG REGISTERED] Пользователь создан: telegram_id=...
[REF CODE CREATED] Привязка к коду: ref_...


 4. ✅ После завершения работы ты ОБЯЗАН выполнить повторную проверку:
 • Зарегистрировать тестового Telegram-пользователя.
 • Убедиться, что он сохраняется в БД.
 • Проверить, что реферальный код выдаётся один и тот же при повторных входах.
 • Убедиться, что нигде не используется guest_id.

⸻

Цель проверки:

Пользователь, заходящий через Telegram Mini App, должен:
 • [✓] Создаваться в БД по telegram_id
 • [✓] Получать постоянный ref_code
 • [✓] Не иметь guest_id
 • [✓] Получать один и тот же код при повторном входе
 • [✓] Не порождать временные или fallback коды

⸻