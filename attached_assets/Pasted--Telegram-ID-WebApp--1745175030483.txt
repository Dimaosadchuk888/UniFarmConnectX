Техническое задание: Аудит и устранение проблемы отсутствия Telegram ID в WebApp

Задача:
Провести детальный аудит и устранить причину, по которой Telegram Mini App не получает initData и Telegram ID, из-за чего не работает генерация реферальной ссылки.

⸻

Контекст:
 • На экране партнёрской программы отображается ошибка:
“Не удалось подтвердить ваш аккаунт Telegram”
 • Отладочная информация показывает: 

ID пользователя: 1  
Telegram ID: не получен  
Кэш ID: не получен  
hasRealUserId: false  
hasRealUserIdState: false  


 • Это значит, что WebApp не получает данные initDataUnsafe.user.id из window.Telegram.WebApp

⸻

Что проверить и подтвердить:

1. Telegram WebApp API
 • Проверить, инициализируется ли window.Telegram.WebApp
 • Проверить, передаётся ли initDataUnsafe и содержит ли user.id
 • Добавить логирование initDataUnsafe и window.Telegram в консоль, если его ещё нет

2. Домен и manifest.json
 • Убедиться, что в [@BotFather] в поле WebApp URL указан ТЕКУЩИЙ домен (например, https://unifarming.ton/)
 • Проверить, что файл tonconnect-manifest.json доступен по ссылке и содержит актуальные:
 • url
 • name
 • iconUrl

3. Активация бота
 • Убедиться, что бот UniFarmingBot запускается с командой /start при первом заходе
 • Проверить, передаёт ли Telegram корректный initData после запуска через кнопку Open UniFarm в Telegram

4. Проверка WebApp-фрейма
 • Открывается ли приложение внутри Telegram, а не в браузере (где window.Telegram = undefined)
 • При необходимости — реализовать fallback-проверку контекста (isTelegramWebApp)

⸻

Требования:
 • Не переписывать текущую структуру получения userId
 • Не менять уже реализованные механизмы реферальной ссылки
 • Все действия только в рамках устранения причины неполучения Telegram initData

⸻

Ожидаемый результат:
 • После запуска через Telegram Mini App должна корректно отображаться реферальная ссылка вида:
https://t.me/UniFarmingBot?start=user{id}
 • Отладочная информация должна показывать реальный Telegram ID, не fallback userId = 1
 • Ошибка “Не удалось подтвердить ваш аккаунт Telegram” больше не должна появляться