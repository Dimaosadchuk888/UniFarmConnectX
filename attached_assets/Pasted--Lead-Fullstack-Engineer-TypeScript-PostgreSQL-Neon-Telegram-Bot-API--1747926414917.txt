Роль: Lead Fullstack Engineer з експертизою в TypeScript, PostgreSQL (Neon), Telegram Bot API та продакшн-деплоях на Replit.

Ціль: Внести комплексні покращення в кодову базу UniFarm без порушення існуючої логіки. Основний акцент — виправлення типів TypeScript, покращення обробки помилок БД та Telegram інтеграції, без створення дублікатів, тимчасових рішень чи нових маршрутів.

Технічне завдання:

1. Виправлення помилок TypeScript
- Проаналізуй файли:
  • server/routes-new.ts
  • server/telegram/setup-hook.ts
  • server/telegram/bot.ts
  • server/check-webhook.ts
  • server/api/admin/index.ts
- Виправи помилки типів, особливо:
  • Уточни типи middleware Express (наприклад, RequestHandler, Request, `Response`)
  • Убери as unknown, any, @ts-ignore
  • Заміни тип unknown на визначені інтерфейси або guard-функції
  • Додай types/global.d.ts або аналогічні для глобальних об’єктів, якщо треба

2. Покращення обробки підключень до БД (Neon / Replit / In-memory)
- Додай детальне логування, коли система переключається між джерелами
- Введи пінг або heartbeat до Neon DB з періодичною перевіркою на відновлення
- Додай retry logic на критичні запити
- Виводь помилки з чіткими деталями (host, код, тип, останній статус)

3. Telegram інтеграція:
- Приведи всі виклики Telegram API до єдиного типізованого класу або сервісу
- Покрий всі команди типами і реєструй їх автоматично
- Введи обробку помилок Telegram API з логуванням і відправкою в окремий logger
- Удоскональ webhook-обробник:
  • Валідуй initData
  • Розділи message, callback_query, web_app_data
- Перевір setMenuButton — додай fallback, якщо не підтримується

4. Обмеження
- Не створюй нові файли типу *-copy.ts, *-new.ts, *-temp.ts
- Не дублюй логіку маршрутизації чи підключення до БД
- Не міняй структуру відповіді API
- Не змінюй імена існуючих змінних .env без моєї вказівки

5. Очікуваний результат
- Повністю чиста TypeScript база без LSP-помилок
- Telegram бот працює стабільно: відповідає, відкриває Mini App, логування в порядку
- БД підключення стабільні, fallback працює, логування чітке
- Кнопка Run стабільно запускає сервер і не виключає його через 2 секунди
- Preview відкривається в браузері і Telegram Mini App без білого екрану

Проект вийшов на стадію продакшн, тому код має бути чистим, стабільним і підтримуваним. Працюй уважно, не допускай хаотичних змін.