PROMPT ДЛЯ АГЕНТА (ENGINEER MODE)

Роль: Production Stabilization Engineer
Ціль: Усунути всі залишкові критичні помилки, які блокують відображення Telegram Mini App UniFarm та стабільну роботу сервера.
Вимоги:
 • НЕ змінювати робочі механіки без пояснень
 • НЕ видаляти функціональний код
 • Робити checkpoint після кожного мікрошагу
 • Прокоментувати у чаті: дію + причину

⸻

1. КРОК: Усунути проблему __dirname is not defined (500 GET ‘/’)
 • Впровадити фікс для Node ESM:

import { fileURLToPath } from 'url';
import { dirname } from 'path';
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

 • Замінити всі виклики __dirname в server/index.ts або productionStatic.ts на цей підхід.

⸻

2. КРОК: Повністю прибрати “UniFarm API Server: Online” з frontend
 • Перевірити root route '/' в server/index.ts. Там має бути:

// Перенаправлення на index.html
app.get('*', serveFrontendStatic); 

 • Заборонено повертати res.send("UniFarm API Server: Online") — видалити або обгорнути if (healthCheck).

⸻

3. КРОК: Усунути Telegram Webhook 429 Error
 • Webhook конфліктує з частими redeploy:
 • Встановити перевірку перед setWebhook:

const currentWebhook = await getWebhookInfo();
if (currentWebhook.url !== targetUrl) {
  await bot.setWebhook(targetUrl);
}

 • АБО використовувати Telegram polling в development

⸻

4. КРОК: Усунути помилки db.select is not a function
 • Це значить, що db обʼєкт не має методу .select()
 • У ReferralBonusProcessor, OptimizedReferralTreeService, migrateRefCodes:
 • Перевірити, чи використовується правильний драйвер (pg або kysely)
 • Забезпечити, що db = getDatabaseClient() повертає клієнт з select, execute

⸻

5. КРОК: Забезпечити правильний fallback на frontend
 • У server/index.ts та server/productionStatic.ts:
 • Усі запити, що не починаються з /api, мають повертати index.html:

app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'dist', 'index.html'));
});

 • Не має бути res.send('Service Unavailable') на fallback’ах

⸻

6. КРОК: Повна перевірка системи після виправлень

Після кожного кроку:
 • Повідомити в чат: який саме файл був змінений, яка строка
 • Зробити деплой та протестувати Telegram Mini App
 • Підтвердити, що:
 • Відображається frontend
 • Немає 429 або 500
 • В логах немає TypeError: db.select is not a function

⸻

Контрольний список помилок — НЕ ЧІПАТИ, лише відмічати:

[Telegram ERROR] Помилка налаштування webhook: 429
[ReferralBonusProcessor] Error recovering failed processing: TypeError: db.select is not a function
[OptimizedReferralTreeService] TypeError: this.db.execute is not a function
[Server] Ошибка при миграции реферальных кодов: TypeError: db.select is not a function
[Background Tasks] TypeError: this.db.execute is not a function
[ErrorHandler] error: __dirname is not defined


⸻

Завдання:
Пройти всі 6 етапів, надавати звіт у чат після кожного з них. Усі виправлення мають бути несучасними для вже працюючої частини коду.
Після завершення — зробити production deploy та надати підсумковий звіт із підтвердженням, що Mini App відкривається без помилок.