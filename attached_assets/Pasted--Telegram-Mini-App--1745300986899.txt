Техническое задание: Аудит отображения реферальной ссылки в Telegram Mini App

Цель:
Устранить проблему, при которой в Telegram Mini App не отображается реферальная ссылка, несмотря на корректную генерацию ref_code на backend.

⸻

1. Провести аудит backend-части:
 • Убедиться, что при первом входе ref_code создаётся корректно и сохраняется в базе.
 • Проверить UserController и API /api/me, чтобы:
 • Объект ref_code всегда возвращался для авторизованного пользователя.
 • Не возникало ошибок, если telegram_id отсутствует или недоступен.
 • Убедиться, что ref_code корректно сериализуется и передаётся на frontend.

⸻

2. Провести аудит frontend-части:
 • Проверить компонент ReferralLinkCard:
 • Инициализация Telegram.WebApp происходит корректно в Telegram Mini App.
 • Подключение Telegram WebApp не блокирует получение ref_code.
 • Отображение реферальной ссылки не зависит от window.Telegram при наличии уже полученного кода.
 • Проверить условие отображения оранжевого блока “Не удалось получить ссылку”:
 • Он не должен отображаться, если ref_code существует.
 • Должен отображаться только в случае явной ошибки запроса.
 • Убедиться, что ссылка отображается в виде:
https://t.me/UniFarmingBot/app?startapp=ref_КОД

⸻

3. Проверить возможные причины ошибки в Telegram Mini App:
 • Возможно, Telegram WebApp не инициализируется корректно:
 • Проверить объект window.Telegram.WebApp внутри TelegramService.
 • Добавить fallback-логику на случай, если Telegram WebApp не загружен (использовать локальное состояние telegram_id, если есть).
 • Убедиться, что при открытии через Telegram telegram_id доступен в initDataUnsafe или initData.

⸻

4. Проверить и протестировать:
 • Отображение реферальной ссылки в Telegram Mini App (в боевом режиме).
 • Отображение в дев-режиме и через прямую ссылку.
 • Проверить отображение для нового пользователя и уже зарегистрированного.

⸻

Дополнительно:
 • Убедиться, что баг не связан с connect wallet — отображение ссылки должно происходить до подключения кошелька.
 • Проверить, не мешает ли WebApp Preview в Replit передаче Telegram-данных (использовать реальные тесты в Telegram).

⸻

После аудита:
 • Предоставить отчёт, где была ошибка.
 • Устранить её.
 • Подтвердить отображение ссылки на скриншоте, сделанном в Telegram Mini App.