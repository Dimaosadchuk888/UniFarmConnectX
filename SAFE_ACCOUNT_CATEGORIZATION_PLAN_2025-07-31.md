# üéØ –ß–ï–¢–ö–ò–ô –ü–õ–ê–ù: –ö–ê–¢–ï–ì–û–†–ò–ó–ê–¶–ò–Ø –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ê–ö–ö–ê–£–ù–¢–û–í

**–î–∞—Ç–∞**: 31.07.2025  
**–°—Ç–∞—Ç—É—Å**: –ë–ï–ó–û–ü–ê–°–ù–´–ô –ü–õ–ê–ù –ë–ï–ó –†–ò–°–ö–ê –î–õ–Ø –†–ï–§–ï–†–ê–õ–¨–ù–û–ô –°–ò–°–¢–ï–ú–´

## üìä –ü–û–ù–ò–ú–ê–ù–ò–ï –°–¢–†–£–ö–¢–£–†–´ –ê–ö–ö–ê–£–ù–¢–û–í

### –ï—Å—Ç—å –î–í–ê —Ç–∏–ø–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤:

1. **üîó –†–ï–§–ï–†–ê–õ–¨–ù–´–ï –ê–ö–ö–ê–£–ù–¢–´** (–ù–ï –¢–†–û–ì–ê–ï–ú!)
   - –ò–º–µ—é—Ç ref_code
   - –£—á–∞—Å—Ç–≤—É—é—Ç –≤ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ  
   - –°–≤—è–∑–∞–Ω—ã —á–µ—Ä–µ–∑ parent_ref_code
   - **–†–ê–ë–û–¢–ê–Æ–¢ –ò–î–ï–ê–õ–¨–ù–û - –ù–ï –¢–†–û–ì–ê–¢–¨!**

2. **üß™ –¢–ï–°–¢–û–í–´–ï –ê–ö–ö–ê–£–ù–¢–´** (–ù–£–ñ–ù–û –ò–°–ü–†–ê–í–ò–¢–¨)
   - –ë–µ–∑ ref_code (—Å–æ–∑–¥–∞–Ω—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤)
   - –ù–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
   - –ò–º–µ—é—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å WebSocket/API/Balance Manager
   - **–ú–û–ñ–ù–û –ë–ï–ó–û–ü–ê–°–ù–û –ò–°–ü–†–ê–í–õ–Ø–¢–¨**

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê

### ‚ùå –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û:
- –¢—Ä–æ–≥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã —Å ref_code
- –ò–∑–º–µ–Ω—è—Ç—å parent_ref_code —Å–≤—è–∑–∏  
- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã
- –ó–∞—Ç—Ä–∞–≥–∏–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã referral_*
- –í–ª–∏—è—Ç—å –Ω–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É

### ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û –ú–û–ñ–ù–û:
- –ò—Å–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –±–µ–∑ ref_code
- –°–æ–∑–¥–∞–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–ø–∏—Å–∏ (sessions, transactions)
- –ò—Å–ø—Ä–∞–≤–ª—è—Ç—å TON Boost –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
- –£–ª—É—á—à–∞—Ç—å —Å–∏—Å—Ç–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤

## üéØ –ß–ï–¢–ö–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –≠–¢–ê–ü 1: –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê
```sql
-- –ù–∞–π—Ç–∏ –¢–û–õ–¨–ö–û —Ç–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã (–±–µ–∑ ref_code)
SELECT id, username, first_name, created_at,
       'TEST_ACCOUNT_NEEDS_REPAIR' as category
FROM users 
WHERE ref_code IS NULL OR ref_code = '';

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –≤ –ø–æ—Ä—è–¥–∫–µ
SELECT COUNT(*) as referral_accounts_count,
       COUNT(CASE WHEN parent_ref_code IS NOT NULL THEN 1 END) as with_parent_refs
FROM users 
WHERE ref_code IS NOT NULL AND ref_code != '';
```

### –≠–¢–ê–ü 2: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –¢–û–õ–¨–ö–û –¢–ï–°–¢–û–í–´–• –ê–ö–ö–ê–£–ù–¢–û–í
```sql
-- BACKUP —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
CREATE TABLE test_users_backup AS 
SELECT * FROM users WHERE ref_code IS NULL OR ref_code = '';

-- –ò—Å–ø—Ä–∞–≤–∏—Ç—å –¢–û–õ–¨–ö–û —Ç–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã (–±–µ–∑ ref_code)
-- –ù–ï –î–ê–ï–ú –∏–º ref_code - –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–º–∏!

-- 1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
INSERT INTO user_sessions (user_id, session_token, expires_at, created_at)
SELECT 
    u.id,
    'test_session_' || u.id || '_' || EXTRACT(EPOCH FROM NOW())::bigint,
    NOW() + INTERVAL '30 days',
    NOW()
FROM users u
LEFT JOIN user_sessions us ON u.id = us.user_id
WHERE (u.ref_code IS NULL OR u.ref_code = '') -- –¢–û–õ–¨–ö–û —Ç–µ—Å—Ç–æ–≤—ã–µ
    AND u.telegram_id IS NOT NULL 
    AND us.user_id IS NULL;

-- 2. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è Balance Manager
INSERT INTO transactions (user_id, type, currency, amount, status, description)
SELECT 
    u.id,
    'TEST_ACCOUNT_INIT',
    'UNI',
    0.001, -- –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ü–µ–ª–µ–π
    'completed',
    '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞'
FROM users u
LEFT JOIN transactions t ON u.id = t.user_id
WHERE (u.ref_code IS NULL OR u.ref_code = '') -- –¢–û–õ–¨–ö–û —Ç–µ—Å—Ç–æ–≤—ã–µ
    AND t.user_id IS NULL;

-- 3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å TON Boost –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
INSERT INTO ton_farming_data (user_id, farming_balance, farming_rate, boost_active, last_update)
SELECT 
    u.id,
    0,
    0.000000231,
    u.ton_boost_active,
    NOW()
FROM users u
LEFT JOIN ton_farming_data tfd ON u.id = tfd.user_id
WHERE (u.ref_code IS NULL OR u.ref_code = '') -- –¢–û–õ–¨–ö–û —Ç–µ—Å—Ç–æ–≤—ã–µ
    AND u.ton_boost_active = true 
    AND tfd.user_id IS NULL;
```

### –≠–¢–ê–ü 3: –ú–û–ù–ò–¢–û–†–ò–ù–ì –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–æ—Å—Ç—Ä–∞–¥–∞–ª–∞
SELECT 'REFERRAL_SYSTEM_CHECK' as check_type,
       COUNT(*) as total_referral_users,
       COUNT(DISTINCT parent_ref_code) as unique_parent_refs,
       COUNT(CASE WHEN parent_ref_code IS NOT NULL THEN 1 END) as users_with_parents
FROM users 
WHERE ref_code IS NOT NULL AND ref_code != '';

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã  
SELECT 'TEST_ACCOUNTS_FIXED' as check_type,
       COUNT(*) as test_accounts,
       COUNT(CASE WHEN EXISTS(SELECT 1 FROM transactions t WHERE t.user_id = u.id) THEN 1 END) as with_transactions,
       COUNT(CASE WHEN EXISTS(SELECT 1 FROM user_sessions s WHERE s.user_id = u.id) THEN 1 END) as with_sessions
FROM users u
WHERE ref_code IS NULL OR ref_code = '';
```

## üîÑ –£–õ–£–ß–®–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´ –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò

### –î–ª—è –±—É–¥—É—â–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ - –¥–≤–∞ –ø—É—Ç–∏:

**–†–ï–§–ï–†–ê–õ–¨–ù–´–ï –ê–ö–ö–ê–£–ù–¢–´** (—á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É):
```typescript
// modules/auth/service.ts - –ø–æ–ª–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å ref_code
if (startParam) { // –ø—Ä–∏—à–µ–ª –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ
  userData.ref_code = generateRefCode();
  userData.parent_ref_code = startParam;
  // + –ø–æ–ª–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
}
```

**–¢–ï–°–¢–û–í–´–ï –ê–ö–ö–ê–£–ù–¢–´** (–ø—Ä—è–º–æ–π –≤—Ö–æ–¥):
```typescript
// modules/auth/service.ts - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑ ref_code
if (!startParam) { // –ø—Ä—è–º–æ–π –≤—Ö–æ–¥ = —Ç–µ—Å—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç
  userData.ref_code = null; // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–º
  // + –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
}
```

## ‚úÖ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞:

**–†–ï–§–ï–†–ê–õ–¨–ù–´–ï –ê–ö–ö–ê–£–ù–¢–´**:
- –û—Å—Ç–∞—é—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º–∏ ‚úÖ
- –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ ‚úÖ
- –í—Å–µ —Å–≤—è–∑–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã ‚úÖ

**–¢–ï–°–¢–û–í–´–ï –ê–ö–ö–ê–£–ù–¢–´**:
- –ü–æ–ª—É—á–∞—é—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ ‚úÖ
- –ü–æ–ª—É—á–∞—é—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è Balance Manager ‚úÖ
- –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è TON Boost –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å ‚úÖ
- –ù–ï –ø–æ–ª—É—á–∞—é—Ç ref_code (–æ—Å—Ç–∞—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–º–∏) ‚úÖ

**–ù–û–í–´–ï –ê–ö–ö–ê–£–ù–¢–´**:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –∫–∞–∫ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ/—Ç–µ—Å—Ç–æ–≤—ã–µ ‚úÖ
- –ü–æ–ª—É—á–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ —Ç–∏–ø—É ‚úÖ

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–°–Ω–∞—á–∞–ª–∞**: –í—ã–ø–æ–ª–Ω–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
2. **–ü–æ—Ç–æ–º**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã  
3. **–í –∫–æ–Ω—Ü–µ**: –£–ª—É—á—à–∏—Ç—å —Å–∏—Å—Ç–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–ì–õ–ê–í–ù–û–ï**: –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç–æ–π –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ!