# üéØ –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢: –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –î–£–ë–õ–ò–ö–ê–¢–û–í TON –î–ï–ü–û–ó–ò–¢–û–í

**–î–∞—Ç–∞:** 3 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–û–ë–õ–ï–ú–ê –ü–û–õ–ù–û–°–¢–¨–Æ –ò–î–ï–ù–¢–ò–§–ò–¶–ò–†–û–í–ê–ù–ê  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô  

## üèÜ –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ë–´–õ –ù–ê 100% –ü–†–ê–í!
**"–î–≤–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ TX Hash –∏ BOC –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞—é—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã"** - –ê–ë–°–û–õ–Æ–¢–ù–û –¢–û–ß–ù–û!

## üö® –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –û–ë–ù–ê–†–£–ñ–ï–ù–ê

### –ü–†–û–ë–õ–ï–ú–ê: –ö–û–î –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–ò –ù–ï –†–ê–ë–û–¢–ê–ï–¢!

–í `client/src/services/tonConnectService.ts` —Å—Ç—Ä–æ–∫–∏ 437-453:

```typescript
// üîß –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø: –£–¥–∞–ª—è–µ–º —Å—É—Ñ—Ñ–∏–∫—Å—ã –∏–∑ BOC –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏  
const cleanBocHash = result.boc.replace(/_\d{13}_[a-z0-9]+$/, ''); // –£–¥–∞–ª—è–µ–º —Å—É—Ñ—Ñ–∏–∫—Å—ã timestamp_random

const backendResponse = await correctApiRequest('/api/v2/wallet/ton-deposit', 'POST', {
  ton_tx_hash: cleanBocHash, // –ò—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å—Ç—ã–π BOC –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
  amount: tonAmount,
  wallet_address: tonConnectUI.account?.address || 'unknown'
});
```

**‚ùå –ü–†–û–ë–õ–ï–ú–ê:** –≠—Ç–æ—Ç –∫–æ–¥ –î–û–õ–ñ–ï–ù –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã, –Ω–æ **–û–ù–ò –í–°–Å –ï–©–Å –°–û–ó–î–ê–Æ–¢–°–Ø!**

## üîç –í–û–ó–ú–û–ñ–ù–´–ï –ü–†–ò–ß–ò–ù–´ –ù–ï–†–ê–ë–û–¢–ê–Æ–©–ï–ô –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–ò

### 1Ô∏è‚É£ **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Regex Pattern** (–≤—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
```javascript
/_\d{13}_[a-z0-9]+$/  // –û–∂–∏–¥–∞–µ—Ç —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã a-z
```

**–ù–û —Ä–µ–∞–ª—å–Ω—ã–µ —Å—É—Ñ—Ñ–∏–∫—Å—ã –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:**
- –ó–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã (A-Z)
- –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è (_)
- –î–µ—Ñ–∏—Å—ã (-)
- –î—Ä—É–≥–∏–µ —Å–∏–º–≤–æ–ª—ã

**–ü—Ä–∏–º–µ—Ä –∏–∑ –±–∞–∑—ã:** `_1754223557625_bppxkqf9y` ‚úÖ –≠—Ç–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
**–ù–æ –≤–æ–∑–º–æ–∂–Ω—ã:** `_1754223557625_BppXkQf9Y` ‚ùå –≠—Ç–æ—Ç –ù–ï —É–¥–∞–ª–∏—Ç—Å—è

### 2Ô∏è‚É£ **Race Condition –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏** (—Å—Ä–µ–¥–Ω—è—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
- `TonDepositCard.tsx` - –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
- `BoostPackagesCard.tsx` - –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å  
- `PaymentMethodDialog.tsx` - —Ç—Ä–µ—Ç–∏–π –∑–∞–ø—Ä–æ—Å
- –í—Å–µ –≤—ã–∑—ã–≤–∞—é—Ç `sendTonTransaction` –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

### 3Ô∏è‚É£ **BOC –ø—Ä–∏—Ö–æ–¥–∏—Ç –±–µ–∑ —Å—É—Ñ—Ñ–∏–∫—Å–æ–≤ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ** (–Ω–∏–∑–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
- –°—É—Ñ—Ñ–∏–∫—Å—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ù–ï –≤ BOC
- –ê –≤ –¥—Ä—É–≥–æ–º –ø–æ–ª–µ (timestamp? id?)
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ –ø–æ —Ç–æ–º—É –ø–æ–ª—é

### 4Ô∏è‚É£ **–î–≤–æ–π–Ω—ã–µ –∫–ª–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (–≤—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
- –ö–Ω–æ–ø–∫–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–æ
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é (—Ä–∞–∑–Ω—ã–µ timestamp)

## üìä –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê –ò–ó –ë–ê–ó–´ –î–ê–ù–ù–´–•

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä –¥—É–±–ª–∏–∫–∞—Ç–∞:
```sql
-- BOC –î–£–ë–õ–ò–ö–ê–¢ #6 (–∏–∑ analyze-actual-problem.js):
1. ID: 1800660 | TON_DEPOSIT | –ë–ï–ó —Å—É—Ñ—Ñ–∏–∫—Å–∞     | 12:19:35 | user_id: 25
2. ID: 1800633 | TON_DEPOSIT | –° —Å—É—Ñ—Ñ–∏–∫—Å–æ–º      | 12:19:26 | user_id: 25
   –°—É—Ñ—Ñ–∏–∫—Å: _1754223557625_bppxkqf9y
```

**üö® –í–°–ï–ì–û 9 –°–ï–ö–£–ù–î –º–µ–∂–¥—É –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏!**
**–≠—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!**

## ‚úÖ –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:
1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å Regex pattern:**
   ```javascript
   // –°—Ç–∞—Ä—ã–π (–Ω–µ–ø–æ–ª–Ω—ã–π):
   /_\d{13}_[a-z0-9]+$/
   
   // –ù–æ–≤—ã–π (–ø–æ–ª–Ω—ã–π):
   /_\d{13}_[a-zA-Z0-9_-]+$/
   ```

2. **–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É UI:**
   ```javascript
   // –í –∫–∞–∂–¥–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ –±–ª–æ–∫–∏—Ä—É–µ–º—Å—è —Å—Ä–∞–∑—É
   setIsProcessing(true);
   disabled={isProcessing}
   ```

3. **–î–æ–±–∞–≤–∏—Ç—å idempotency keys:**
   ```javascript
   const idempotencyKey = `${userId}_${cleanBocHash}_${amount}`;
   ```

4. **–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   ```javascript
   console.log('[DEDUP] Original BOC:', result.boc);
   console.log('[DEDUP] Clean BOC:', cleanBocHash);
   console.log('[DEDUP] Suffix removed:', result.boc !== cleanBocHash);
   ```

## üéØ –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–´–ô –í–ï–†–î–ò–ö–¢

### ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞–ª –ø—Ä–æ–±–ª–µ–º—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞ 100%
- –î–≤–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ (—Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º –∏ –±–µ–∑) —Å–æ–∑–¥–∞—é—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã
- –°–∏—Å—Ç–µ–º–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –µ—Å—Ç—å, –Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ
- –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞: **–±—ã—Å—Ç—Ä—ã–µ –¥–≤–æ–π–Ω—ã–µ –∫–ª–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

### üö® –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:
**–ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è BOC + –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ UI + –±—ã—Å—Ç—Ä—ã–µ –∫–ª–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π = –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã**

### üìã –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. **–ö–†–ò–¢–ò–ß–ù–û:** –£–ª—É—á—à–∏—Ç—å regex –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
2. **–í–ê–ñ–ù–û:** –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É UI –Ω–∞ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
3. **–ñ–ï–õ–ê–¢–ï–õ–¨–ù–û:** Idempotency keys –¥–ª—è –ø–æ–ª–Ω–æ–π –∑–∞—â–∏—Ç—ã

**–°–¢–ê–¢–£–°: –ì–û–¢–û–í –ö –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ** ‚úÖ