# üõ°Ô∏è Production Database Safety Audit - UniFarm

**–î–∞—Ç–∞:** 2025-08-01  
**–¢–∏–ø:** Production Safety Audit  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î (–Ω–∞ 2025-08-01)

- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 103 –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–∞
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:** 839,173 –∑–∞–ø–∏—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏
- **–í—ã–≤–æ–¥–æ–≤:** 159 –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤—ã–≤–æ–¥
- **–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∞—Ä–º–µ—Ä–æ–≤ UNI:** 49 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **TON Boost –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 5 —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –ø–∞–∫–µ—Ç–∞–º–∏
- **–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑–µ–π:** 52 –∑–∞–ø–∏—Å–∏ –≤ referrals + —Å–≤—è–∑–∏ –≤ users
- **TON –∫–æ—à–µ–ª—å–∫–æ–≤:** 21 –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –ü—Ä–∏–Ω—Ü–∏–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. **–ù–ï –£–î–ê–õ–Ø–¢–¨** —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è –∏ —Ç–∞–±–ª–∏—Ü—ã
2. **–ù–ï –ò–ó–ú–ï–ù–Ø–¢–¨** —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –ø–æ–ª–µ–π
3. **–ù–ï –ù–ê–†–£–®–ê–¢–¨** —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏
4. **–°–û–•–†–ê–ù–ò–¢–¨** –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –±–∞–ª–∞–Ω—Å—ã, —Ä–µ—Ñ–µ—Ä–∞–ª—ã
5. **–î–û–ö–£–ú–ï–ù–¢–ò–†–û–í–ê–¢–¨** –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
6. **–°–û–•–†–ê–ù–ò–¢–¨** –≥–∏–±—Ä–∏–¥–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É transactions –¥–æ –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
7. **–ù–ï –¢–†–û–ì–ê–¢–¨** —Ç–∞–±–ª–∏—Ü—ã uni_farming_data, ton_farming_data, referrals

---

## üìä 1. –ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ç–∞–±–ª–∏—Ü –∏ –ø–æ–ª–µ–π

### 1.1 –¢–∞–±–ª–∏—Ü–∞ `users` - –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø

**–ê–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—è:**
- `id` - PRIMARY KEY, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ
- `telegram_id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `username` - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
- `first_name`, `last_name` - –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `ref_code` - —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `parent_ref_code` - –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ
- `referred_by` - ID –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ
- `balance_uni` - –±–∞–ª–∞–Ω—Å UNI —Ç–æ–∫–µ–Ω–æ–≤
- `balance_ton` - –±–∞–ª–∞–Ω—Å TON
- `uni_farming_active` - —Å—Ç–∞—Ç—É—Å —Ñ–∞—Ä–º–∏–Ω–≥–∞
- `uni_deposit_amount` - —Å—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞
- `uni_farming_start_timestamp` - –Ω–∞—á–∞–ª–æ —Ñ–∞—Ä–º–∏–Ω–≥–∞
- `uni_farming_rate` - —Å—Ç–∞–≤–∫–∞ —Ñ–∞—Ä–º–∏–Ω–≥–∞
- `uni_farming_balance` - –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π —Ñ–∞—Ä–º–∏–Ω–≥
- `uni_farming_last_update` - –ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- `ton_boost_active` - —Å—Ç–∞—Ç—É—Å –±—É—Å—Ç–∞
- `ton_boost_package_id` - ID –ø–∞–∫–µ—Ç–∞ –±—É—Å—Ç–∞
- `ton_boost_rate` - —Å—Ç–∞–≤–∫–∞ –±—É—Å—Ç–∞
- `created_at`, `updated_at` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏

**–ü–æ–ª—è –ø–æ–¥ –≤–æ–ø—Ä–æ—Å–æ–º (—Ç—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏):**
- `last_active` - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- `daily_bonus_claimed_at` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ—è—Å–Ω–æ
- `tons_for_uni_exchange_rate` - –∫—É—Ä—Å –æ–±–º–µ–Ω–∞

### 1.2 –¢–∞–±–ª–∏—Ü–∞ `transactions` - –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø (839,173 –∑–∞–ø–∏—Å–µ–π!)

**–í–ê–ñ–ù–û–ï –û–¢–ö–†–´–¢–ò–ï: –¢–∞–±–ª–∏—Ü–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ì–ò–ë–†–ò–î–ù–£–Æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É!**

**–ê–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—è (–æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ):**

**–°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (–∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è):**
- `type` - —Ç–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ("REFERRAL_REWARD", "FARMING_REWARD")
- `amount_uni` - —Å—É–º–º–∞ –≤ UNI
- `amount_ton` - —Å—É–º–º–∞ –≤ TON

**–ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç (—Ç–æ–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è):**
- `currency` - –≤–∞–ª—é—Ç–∞ ("UNI", "TON")
- `amount` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å—É–º–º–∞
- `metadata` - JSON —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏

**–î—Ä—É–≥–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è:**
- `id` - PRIMARY KEY
- `user_id` - —Å–≤—è–∑—å —Å users (FOREIGN KEY)
- `source_user_id` - –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
- `status` - –≤—Å–µ–≥–¥–∞ "completed"
- `description` - –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
- `is_duplicate` - –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- `created_at`, `updated_at` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏

**–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—è:** `source`, `tx_hash`, `action` - –≤—Å–µ NULL

**–ö–†–ò–¢–ò–ß–ù–û:** –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–±–µ–∏–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ!

### 1.3 –¢–∞–±–ª–∏—Ü–∞ `withdraw_requests` - –ê–ö–¢–ò–í–ù–ê–Ø

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—è:**
- `id` - PRIMARY KEY
- `user_id` - —Å–≤—è–∑—å —Å users
- `telegram_id` - –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- `username` - –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
- `amount_ton` - —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞
- `ton_wallet` - –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞
- `status` - —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
- `created_at`, `processed_at` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏

### 1.4 –í–ê–ñ–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï: –¢–∞–±–ª–∏—Ü—ã –∫–æ—Ç–æ—Ä—ã–µ –ò–°–ü–û–õ–¨–ó–£–Æ–¢–°–Ø –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:

**–ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç 2025-08-01:**
- `uni_farming_data` - **98 –∑–∞–ø–∏—Å–µ–π** - –ê–ö–¢–ò–í–ù–û –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø!
- `ton_farming_data` - **44 –∑–∞–ø–∏—Å–∏** - –ê–ö–¢–ò–í–ù–û –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø!
- `referrals` - **52 –∑–∞–ø–∏—Å–∏** - –ê–ö–¢–ò–í–ù–û –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø!
- `missions` - **5 –∑–∞–ø–∏—Å–µ–π** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏—Å—Å–∏–π
- `user_sessions` - 0 –∑–∞–ø–∏—Å–µ–π - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è

**–ö–†–ò–¢–ò–ß–ù–û:** –≠—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–¥–µ—Ä–∂–∞—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ù–ï –ú–û–ì–£–¢ –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã!

---

## üîç 2. –ê–Ω–∞–ª–∏–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### 2.1 –ú–æ–¥—É–ª–∏, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å –ë–î:

1. **BalanceManager** (core/BalanceManager.ts):
   - UPDATE users.balance_uni, users.balance_ton
   - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

2. **UniFarmingRepository** (modules/farming/UniFarmingRepository.ts):
   - SELECT/UPDATE –ø–æ–ª—è uni_farming_* –≤ users
   - Fallback –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ uni_farming_data

3. **SupabaseUserRepository** (modules/user/service.ts):
   - –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ç–∞–±–ª–∏—Ü–µ–π users
   - –°–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

4. **TransactionEnforcer** (core/TransactionEnforcer.ts):
   - INSERT –≤ transactions
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–æ–ª–µ–π

### 2.2 –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–≤—è–∑–∏:
- users.id ‚Üí transactions.user_id (FOREIGN KEY)
- users.id ‚Üí withdraw_requests.user_id
- users.referred_by ‚Üí users.id (self-reference)

---

## üìã 3. –ü–ª–∞–Ω –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ (–æ–±–Ω–æ–≤–ª—ë–Ω —Å —É—á—ë—Ç–æ–º —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

### –§–∞–∑–∞ 1: –ê–Ω–∞–ª–∏–∑ –∏ backup (0 –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ë–î)

1. **–ü–æ–ª–Ω—ã–π backup –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!**
   ```bash
   pg_dump unifarm_production > unifarm_backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∫–æ–¥–∞ –æ—Ç –ë–î:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ SQL –∑–∞–ø—Ä–æ—Å—ã –≤ –∫–æ–¥–µ
   - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—è
   - –ù–∞–π—Ç–∏ –≤—Å–µ foreign key —Å–≤—è–∑–∏

3. **–°–æ–∑–¥–∞—Ç—å staging –∫–æ–ø–∏—é –¥–ª—è —Ç–µ—Å—Ç–æ–≤**

### –§–∞–∑–∞ 2: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è schema.ts —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î

**–í–ê–ñ–ù–û: –ù–ï —Ç—Ä–æ–≥–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã!**

1. **–û–±–Ω–æ–≤–∏—Ç—å schema.ts —á—Ç–æ–±—ã –æ—Ç—Ä–∞–∂–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:**
   ```typescript
   // –î–æ–±–∞–≤–∏—Ç—å –≤ schema.ts —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã:
   export const uniFarmingData = pgTable('uni_farming_data', {
     // —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π –ë–î
   });
   
   export const tonFarmingData = pgTable('ton_farming_data', {
     // —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π –ë–î
   });
   ```

2. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–∏–±—Ä–∏–¥–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É transactions:**
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –ø–æ–ª–µ–π
   - –°–æ–∑–¥–∞—Ç—å –∞–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±–µ–∏–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏

### –§–∞–∑–∞ 3: –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è)

1. **–î–æ–±–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –ø–æ–ª—è/—Ç–∞–±–ª–∏—Ü—ã:**
   ```sql
   -- –¢–æ–ª—å–∫–æ ADD, –Ω–∏–∫–∞–∫–∏—Ö DROP –∏–ª–∏ ALTER TYPE
   ALTER TABLE users 
   ADD COLUMN IF NOT EXISTS schema_version INTEGER DEFAULT 1;
   ```

2. **–°–æ–∑–¥–∞—Ç—å views –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:**
   ```sql
   -- View –¥–ª—è unified –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
   CREATE OR REPLACE VIEW transactions_unified AS
   SELECT 
     id,
     user_id,
     COALESCE(currency, 
       CASE 
         WHEN amount_ton > 0 THEN 'TON'
         ELSE 'UNI'
       END
     ) as currency,
     COALESCE(amount, amount_uni + amount_ton) as amount,
     type,
     status,
     description,
     metadata,
     created_at
   FROM transactions;
   ```

### –§–∞–∑–∞ 4: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –∫–æ–¥–∞

1. **–û–±–Ω–æ–≤–∏—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:**
   - UniFarmingRepository –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä—è—Ç—å –æ–±–µ —Ç–∞–±–ª–∏—Ü—ã
   - TransactionService –¥–æ–ª–∂–µ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≥–∏–±—Ä–∏–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
   - ReferralService –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —Å –æ–±–µ–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

2. **–î–æ–±–∞–≤–∏—Ç—å fallback –ª–æ–≥–∏–∫—É:**
   ```typescript
   // –ü—Ä–∏–º–µ—Ä: —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–æ–∏—Ö –º–µ—Å—Ç
   async getFarmingData(userId: number) {
     // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å users —Ç–∞–±–ª–∏—Ü—É
     const userData = await this.getUserFarmingData(userId);
     
     // –ü–æ—Ç–æ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å uni_farming_data
     const farmingData = await this.getUniFarmingData(userId);
     
     // –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
     return this.mergeFarmingData(userData, farmingData);
   }
   ```

### –§–∞–∑–∞ 5: –í–∞–ª–∏–¥–∞—Ü–∏—è (–ø–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏)

1. **–ü—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö:**
   ```sql
   -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã
   SELECT COUNT(*) FROM users WHERE balance_uni > 0;
   SELECT COUNT(*) FROM users WHERE balance_ton > 0;
   
   -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏
   SELECT COUNT(*) FROM users WHERE referred_by IS NOT NULL;
   SELECT COUNT(*) FROM referrals;
   
   -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   SELECT COUNT(*), type FROM transactions GROUP BY type;
   ```

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –±–∞–ª–∞–Ω—Å—ã –∫–∞–∂–¥—ã–π —á–∞—Å
   - –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ª—é–±—ã—Ö –∞–Ω–æ–º–∞–ª–∏—è—Ö

---

## üö® 4. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

### –ù–ï–õ–¨–ó–Ø:
1. ‚ùå –£–¥–∞–ª—è—Ç—å –ø–æ–ª—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users
2. ‚ùå –ò–∑–º–µ–Ω—è—Ç—å —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö balance_uni, balance_ton
3. ‚ùå –£–¥–∞–ª—è—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω—è—Ç—å transactions
4. ‚ùå –ù–∞—Ä—É—à–∞—Ç—å foreign key constraints
5. ‚ùå –ò–∑–º–µ–Ω—è—Ç—å primary key

### –ú–û–ñ–ù–û:
1. ‚úÖ –î–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è
2. ‚úÖ –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã
3. ‚úÖ –î–æ–±–∞–≤–ª—è—Ç—å –∏–Ω–¥–µ–∫—Å—ã
4. ‚úÖ –°–æ–∑–¥–∞–≤–∞—Ç—å views –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

---

## üìä 5. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –Ω–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### 5.1 –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ):

```typescript
// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å—Ö–µ–º–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
export const users = {
  // –í–°–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è –æ—Å—Ç–∞—é—Ç—Å—è
  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ:
  schema_version: integer().default(1),
  migrated_at: timestamp()
};

export const transactions_v2 = {
  // –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –±—É–¥—É—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
  id: serial('id').primaryKey(),
  user_id: integer('user_id').references(() => users.id),
  transaction_type: transactionTypeEnum('transaction_type').notNull(),
  amount: decimal('amount', { precision: 20, scale: 6 }).notNull(),
  currency: currencyEnum('currency').notNull(),
  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
};
```

### 5.2 –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:

1. **Views –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:**
   ```sql
   CREATE VIEW transactions_compatible AS
   SELECT 
     id,
     user_id,
     transaction_type as type,
     CASE 
       WHEN currency = 'UNI' THEN amount 
       ELSE '0'
     END as amount_uni,
     CASE 
       WHEN currency = 'TON' THEN amount 
       ELSE '0'
     END as amount_ton,
     -- –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
   FROM transactions_v2;
   ```

2. **–¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**
   - –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É ‚Üí –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –Ω–æ–≤—É—é
   - –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ –Ω–æ–≤—É—é ‚Üí –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç–∞—Ä—É—é

---

## üéØ 6. –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:
1. **–°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π backup –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î**
2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–æ–ª–µ–π**
3. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ SQL –∑–∞–ø—Ä–æ—Å—ã –≤ –∫–æ–¥–µ**

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ (1-2 –Ω–µ–¥–µ–ª–∏):
1. **–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã**
2. **–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö**
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∫–æ–ø–∏–∏ –ë–î**

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ (1-2 –º–µ—Å—è—Ü–∞):
1. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É**
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è**
3. **–ê—Ä—Ö–∏–≤–∞—Ü–∏—è –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö**

---

## üéØ 7. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –º–æ–¥–µ–ª—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### 7.1 –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π schema.ts (–¥–æ–±–∞–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã):

```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ schema.ts –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î:

// –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ uni_farming_data (98 –∑–∞–ø–∏—Å–µ–π)
export const uniFarmingData = pgTable('uni_farming_data', {
  id: uuid('id').primaryKey(),
  user_id: integer('user_id').notNull(),
  deposit_amount: integer('deposit_amount').notNull(),
  farming_balance: decimal('farming_balance').notNull(),
  farming_rate: decimal('farming_rate').notNull(),
  is_active: boolean('is_active').notNull(),
  created_at: timestamp('created_at').notNull(),
  updated_at: timestamp('updated_at').notNull()
});

// –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ ton_farming_data (44 –∑–∞–ø–∏—Å–∏)  
export const tonFarmingData = pgTable('ton_farming_data', {
  id: uuid('id').primaryKey(),
  user_id: text('user_id').notNull(), // –í–Ω–∏–º–∞–Ω–∏–µ: string, –Ω–µ integer!
  boost_active: boolean('boost_active').notNull(),
  boost_package_id: integer('boost_package_id'),
  boost_rate: decimal('boost_rate').notNull(),
  ton_accumulated: decimal('ton_accumulated').notNull(),
  created_at: timestamp('created_at').notNull(),
  updated_at: timestamp('updated_at').notNull()
});

// –ù–ï –£–î–ê–õ–Ø–¢–¨ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∏–∑ schema.ts!
```

### 7.2 –ê–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è –≥–∏–±—Ä–∏–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:

```typescript
// TransactionAdapter –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥–∏–±—Ä–∏–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
export class TransactionAdapter {
  static toUnified(transaction: any) {
    return {
      id: transaction.id,
      user_id: transaction.user_id,
      // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
      currency: transaction.currency || 
        (transaction.amount_ton > 0 ? 'TON' : 'UNI'),
      amount: transaction.amount || 
        (transaction.amount_uni || 0) + (transaction.amount_ton || 0),
      type: transaction.type,
      // –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è...
    };
  }
}
```

## üìù 8. –§–∏–Ω–∞–ª—å–Ω—ã–µ –≤—ã–≤–æ–¥—ã

### ‚úÖ –ß—Ç–æ –º—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏:

1. **839,173 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** - –æ–≥—Ä–æ–º–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
2. **103 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –±–∞–ª–∞–Ω—Å–∞–º–∏
3. **–¢–∞–±–ª–∏—Ü—ã uni_farming_data, ton_farming_data, referrals –ò–°–ü–û–õ–¨–ó–£–Æ–¢–°–Ø**
4. **–ì–∏–±—Ä–∏–¥–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ transactions** - —Ä–∞–±–æ—Ç–∞—é—Ç –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –ø–æ–ª–µ–π
5. **52 —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏** –∞–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç
6. **21 –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–π TON –∫–æ—à–µ–ª–µ–∫**

### ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏:

1. **–£–¥–∞–ª–µ–Ω–∏–µ "–Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö" —Ç–∞–±–ª–∏—Ü –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö**
2. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –Ω–∞—Ä—É—à–∏—Ç —Ä–∞–±–æ—Ç—É —Å–∏—Å—Ç–µ–º—ã**
3. **–ù–∞—Ä—É—à–µ–Ω–∏–µ foreign key —Å–≤—è–∑–µ–π —Å–ª–æ–º–∞–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å**
4. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã transactions –±–µ–∑ –∞–¥–∞–ø—Ç–µ—Ä–æ–≤ —Å–ª–æ–º–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é**

### üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:

1. **–í–°–ï–ì–î–ê –¥–µ–ª–∞—Ç—å backup –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏**
2. **–î–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤–æ–µ, –ù–ï —É–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä–æ–µ**
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å views –∏ –∞–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏**
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ staging –∫–æ–ø–∏–∏**
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∫–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ**
6. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å schema.ts —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î, –∞ –Ω–µ –Ω–∞–æ–±–æ—Ä–æ—Ç**

### üìã –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:** –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π backup –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î
2. **–°—Ä–æ—á–Ω–æ:** –û–±–Ω–æ–≤–∏—Ç—å schema.ts –¥–ª—è –æ—Ç—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
3. **–í–∞–∂–Ω–æ:** –°–æ–∑–¥–∞—Ç—å –∞–¥–∞–ø—Ç–µ—Ä—ã –¥–ª—è –≥–∏–±—Ä–∏–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã transactions
4. **–ü–ª–∞–Ω–æ–≤–æ:** –†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

**–ì–ª–∞–≤–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø:** –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - —Å–≤—è—â–µ–Ω–Ω—ã. –õ—É—á—à–µ –∏–º–µ—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, —á–µ–º –ø–æ—Ç–µ—Ä—è—Ç—å —Ö–æ—Ç—å –æ–¥–∏–Ω –±–∞–π—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

---

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 2025-08-01  
**–°—Ç–∞—Ç—É—Å:** –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô - —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –ª—é–±—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º –ë–î  
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–ª–µ–¥–æ–≤–∞—Ç—å –ø–ª–∞–Ω—É –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏, –Ω–∞—á–∏–Ω–∞—è —Å backup –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ schema.ts