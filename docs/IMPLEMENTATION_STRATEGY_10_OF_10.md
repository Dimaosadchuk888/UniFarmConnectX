# üéØ –°–¢–†–ê–¢–ï–ì–ò–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–ò 10 –∏–∑ 10

## üìã –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–£–î–ò–¢–ê

### ‚úÖ UNI Farming
- **–°—Ç–∞—Ç—É—Å**: –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω
- **–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π**: 0
- **–î–µ–π—Å—Ç–≤–∏—è**: –ù–µ —Ç—Ä–µ–±—É—é—Ç—Å—è

### ‚ö†Ô∏è TON Farming  
- **–°—Ç–∞—Ç—É—Å**: –¢—Ä–µ–±—É–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- **–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π**: 16 –∑–∞–ø–∏—Å–µ–π
- **–û–±—â–∞—è —Ä–∞–∑–Ω–∏—Ü–∞**: 161.04
- **–î–µ–π—Å—Ç–≤–∏–µ**: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ UPDATE

### üöÄ –ò–Ω–¥–µ–∫—Å—ã
- **–í—Å–µ–≥–æ**: 8 –∏–Ω–¥–µ–∫—Å–æ–≤
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö**: 2 (telegram_id, transactions)
- **–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: 4
- **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: 2

---

## üìù –ü–û–®–ê–ì–û–í–´–ô –ü–õ–ê–ù –í–´–ü–û–õ–ù–ï–ù–ò–Ø

### –®–ê–ì 1: –°–æ–∑–¥–∞–Ω–∏–µ Backup (5 –º–∏–Ω—É—Ç)
```bash
# –°–æ–∑–¥–∞—ë–º –ø–æ–ª–Ω—ã–π backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
pg_dump $DATABASE_URL > backup_before_optimization_$(date +%Y%m%d_%H%M%S).sql

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä backup
ls -lh backup_*.sql
```

### –®–ê–ì 2: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è TON Farming (10 –º–∏–Ω—É—Ç)

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç `scripts/generated_sync_script.sql`:

```sql
-- –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
-- 1. –°–æ–∑–¥–∞—ë—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Å—É–º–º—É –î–û –∏–∑–º–µ–Ω–µ–Ω–∏–π
-- 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç 16 –∑–∞–ø–∏—Å–µ–π ton_farming_balance
-- 3. –°–æ–∑–¥–∞—ë—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Å—É–º–º—É –ü–û–°–õ–ï
-- 4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–Ω–∏—Ü—É

-- –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–µ–¥ COMMIT!
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ —É–≤–µ–ª–∏—á–∏—Ç—Å—è –Ω–∞ 161.04
- 16 –∑–∞–ø–∏—Å–µ–π –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã

### –®–ê–ì 3: –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ (20 –º–∏–Ω—É—Ç)

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç `scripts/generated_index_script.sql`:

```sql
-- –°–æ–∑–¥–∞—ë—Ç 8 –∏–Ω–¥–µ–∫—Å–æ–≤ —Å CONCURRENTLY (–±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü)
-- –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–∞–±–ª–∏—Ü
```

**–ü–æ—Ä—è–¥–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è:**
1. ‚ùó `idx_users_telegram_id` - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
2. ‚ùó `idx_transactions_user_id__created_at_desc` - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π  
3. `idx_users_balance_uni__balance_ton` - –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
4. `idx_users_uni_farming_active` - –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
5. `idx_users_referred_by` - —Å—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
6. `idx_transactions_type` - —Å—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
7. `idx_withdraw_requests_status` - –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
8. `idx_withdraw_requests_user_id` - –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

### –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (5 –º–∏–Ω—É—Ç)

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
SELECT COUNT(*) as synced_records
FROM users u
JOIN ton_farming_data tfd ON u.id = CAST(tfd.user_id AS INTEGER)
WHERE u.ton_farming_balance = tfd.farming_balance;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤
SELECT 
  tablename,
  indexname,
  pg_size_pretty(pg_relation_size(indexname::regclass)) as size
FROM pg_indexes
WHERE schemaname = 'public'
  AND indexname LIKE 'idx_%'
ORDER BY tablename, indexname;
```

---

## ‚úÖ –ö–û–ù–¢–†–û–õ–¨–ù–´–ô –ß–ï–ö–õ–ò–°–¢

- [ ] Backup —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω
- [ ] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (16 –∑–∞–ø–∏—Å–µ–π)
- [ ] –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ —É–≤–µ–ª–∏—á–∏–ª–∞—Å—å –Ω–∞ 161.04
- [ ] –í—Å–µ 8 –∏–Ω–¥–µ–∫—Å–æ–≤ —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞–±–ª–∏—Ü –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–ª—É—á—à–∏–ª–∞—Å—å

---

## üéâ –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –ü–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
- ‚úÖ 100% –¥–∞–Ω–Ω—ã—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ –ù–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏
- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞

### –ü–æ—Å–ª–µ –∏–Ω–¥–µ–∫—Å–æ–≤:
- ‚ö° –ü–æ–∏—Å–∫ –ø–æ telegram_id: **–≤ 10 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ**
- ‚ö° –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: **–≤ 5-10 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ**
- ‚ö° –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–æ–≤: **–≤ 5 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ**
- ‚ö° –û–±—â–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: **—É–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 300-500%**

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ CONCURRENTLY** –¥–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤ - —ç—Ç–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—ã
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã** –ø–µ—Ä–µ–¥ COMMIT
3. **–ù–µ —É–¥–∞–ª—è–π—Ç–µ —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã** - —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
4. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫—É** –≤–æ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤

---

## üö® –û–¢–ö–ê–¢ (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ backup
psql $DATABASE_URL < backup_before_optimization_YYYYMMDD_HHMMSS.sql
```

---

## üìû –ü–û–î–î–ï–†–ñ–ö–ê

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `SELECT * FROM pg_stat_activity;`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: `SELECT * FROM pg_locks;`
3. –°–≤—è–∂–∏—Ç–µ—Å—å —Å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ~40 –º–∏–Ω—É—Ç**
**–†–∏—Å–∫: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π**
**–†–µ–∑—É–ª—å—Ç–∞—Ç: 10 –∏–∑ 10** üéØ