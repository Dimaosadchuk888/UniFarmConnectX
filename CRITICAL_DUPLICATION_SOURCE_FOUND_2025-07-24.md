# üö® –ò–°–¢–û–ß–ù–ò–ö –î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø –ù–ê–ô–î–ï–ù! –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê

**–î–∞—Ç–∞:** 24 –∏—é–ª—è 2025 18:15 MSK  
**–°—Ç–∞—Ç—É—Å:** üîç –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –û–ë–ù–ê–†–£–ñ–ï–ù–ê  
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç –¥–≤–µ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏  

---

## üìã –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –û–ë–ù–ê–†–£–ñ–ï–ù–ò–ï

### **–ù–ê–ô–î–ï–ù–ê –û–®–ò–ë–ö–ê –í –î–í–£–• –ú–ï–°–¢–ê–• –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û!**

#### **–ú–ï–°–¢–û 1: modules/wallet/service.ts (—Å—Ç—Ä–æ–∫–∏ 400-406)**
```typescript
metadata: {
  source: 'ton_deposit',
  original_type: 'TON_DEPOSIT',
  wallet_address,
  tx_hash: ton_tx_hash  // ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ï –ü–û–õ–ï!
}
```

#### **–ú–ï–°–¢–û 2: core/TransactionService.ts (—Å—Ç—Ä–æ–∫–∞ 118)**
```typescript
tx_hash_unique: metadata?.ton_tx_hash || null, // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û –ù–ê ton_tx_hash
```

---

## üéØ **–ü–†–û–ë–õ–ï–ú–ê –í –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ò –ü–û–õ–ï–ô**

### **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. **WalletService –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç**: `metadata.tx_hash = "te6cckECBAEAAL0..."`
2. **TransactionService –∏—â–µ—Ç**: `metadata.ton_tx_hash` 
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç**: `tx_hash_unique = null` (–ø–æ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!)
4. **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ù–ï –†–ê–ë–û–¢–ê–ï–¢** = —Å–æ–∑–¥–∞—é—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç—ã

### **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ü–µ–ø–æ—á–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**:
```
Frontend –≤—ã–∑—ã–≤–∞–µ—Ç API ‚Üí
metadata = { tx_hash: "hash123" } ‚Üí
TransactionService –∏—â–µ—Ç metadata.ton_tx_hash ‚Üí
–ù–ï –ù–ê–•–û–î–ò–¢! ‚Üí
tx_hash_unique = null ‚Üí
Unique constraint –ù–ï –°–†–ê–ë–ê–¢–´–í–ê–ï–¢ ‚Üí
–°–æ–∑–¥–∞–µ—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Üí
+2 TON –≤–º–µ—Å—Ç–æ +1 TON
```

---

## üîç **–î–í–û–ô–ù–ê–Ø –û–®–ò–ë–ö–ê –û–ë–ù–ê–†–£–ñ–ï–ù–ê**

### **–û—à–∏–±–∫–∞ #1: –í WalletService (modules/wallet/service.ts:404)**
```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
tx_hash: ton_tx_hash

// ‚úÖ –î–û–õ–ñ–ù–û –ë–´–¢–¨:
ton_tx_hash: ton_tx_hash
```

### **–û—à–∏–±–∫–∞ #2: –Ø –∏—Å–ø—Ä–∞–≤–∏–ª —Ç–æ–ª—å–∫–æ TransactionService**
- –ò—Å–ø—Ä–∞–≤–∏–ª `metadata?.tx_hash` ‚Üí `metadata?.ton_tx_hash` 
- –ù–û –ù–ï –ò–°–ü–†–ê–í–ò–õ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–æ–±–ª–µ–º—ã –≤ WalletService!
- –ü–æ—ç—Ç–æ–º—É –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!

---

## üìä **–ü–û–õ–ù–ê–Ø –°–•–ï–ú–ê –ü–†–û–ë–õ–ï–ú–´**

### **Frontend (tonConnectService.ts)**:
```typescript
await correctApiRequest('/api/v2/wallet/ton-deposit', 'POST', {
  ton_tx_hash: result.boc,  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
  amount: tonAmount,
  wallet_address: address
});
```

### **Backend –ø–æ–ª—É—á–∞–µ—Ç –∏ –ü–ï–†–ï–ú–ê–¢–´–í–ê–ï–¢ –≤ WalletService**:
```typescript
// WalletService —Å–æ–∑–¥–∞–µ—Ç metadata —Å –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ú –ø–æ–ª–µ–º:
metadata: {
  tx_hash: ton_tx_hash  // ‚ùå –î–æ–ª–∂–Ω–æ –±—ã—Ç—å ton_tx_hash!
}
```

### **TransactionService –ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏**:
```typescript
tx_hash_unique: metadata?.ton_tx_hash || null  // –ù–ï –ù–ê–•–û–î–ò–¢!
```

---

## ‚ö° **–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –¢–†–ï–ë–£–ï–¢–°–Ø**

### **–ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ modules/wallet/service.ts —Å—Ç—Ä–æ–∫–∞ 404**:
```typescript
// –ë–´–õ–û:
tx_hash: ton_tx_hash

// –ò–°–ü–†–ê–í–ò–¢–¨ –ù–ê:
ton_tx_hash: ton_tx_hash
```

---

## üéØ **–°–¢–ê–¢–£–°**

**‚úÖ –ü–†–û–ë–õ–ï–ú–ê –î–ò–ê–ì–ù–û–°–¢–ò–†–û–í–ê–ù–ê**: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–µ–π metadata  
**‚è≥ –¢–†–ï–ë–£–ï–¢ –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ì–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø**: –û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –∫–æ–¥–∞  
**üö® –ö–†–ò–¢–ò–ß–ù–û**: –ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –¥–µ–ø–æ–∑–∏—Ç —Å–æ–∑–¥–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç  

---

**–í–´–í–û–î: Redeploy –Ω–µ –ø–æ–º–æ–≥, –ø–æ—Ç–æ–º—É —á—Ç–æ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–æ–±–ª–µ–º—ã –Ω–µ –±—ã–ª –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –≤ WalletService!**