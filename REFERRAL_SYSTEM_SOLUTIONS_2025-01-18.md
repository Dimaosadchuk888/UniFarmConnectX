# –ö–û–ù–ö–†–ï–¢–ù–´–ï –†–ï–®–ï–ù–ò–Ø –î–õ–Ø –†–ï–§–ï–†–ê–õ–¨–ù–û–ô –°–ò–°–¢–ï–ú–´ UNIFARM
**–î–∞—Ç–∞:** 18 —è–Ω–≤–∞—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –±–µ–∑ –≤—Ä–µ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é

## üìã –û–ë–ù–ê–†–£–ñ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. ‚ùå processReferral() –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –í `auth/service.ts` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ–ª–µ `referred_by`, –Ω–æ –º–µ—Ç–æ–¥ `processReferral()` –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è.

### 2. ‚ùå –¢–∞–±–ª–∏—Ü–∞ `referrals` –ø—É—Å—Ç–∞—è 
**–°–ª–µ–¥—Å—Ç–≤–∏–µ:** –ë–µ–∑ –∑–∞–ø–∏—Å–µ–π –≤ `referrals` –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞—á–∏—Å–ª—è—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã.

### 3. ‚ö†Ô∏è –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å –Ω–µ—É—Å—Ç–æ–π—á–∏–≤–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** 310% –æ–±—â–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (—É—Ä–æ–≤–µ–Ω—å 1 = 100%, —É—Ä–æ–≤–Ω–∏ 2-20 = 210%).

### 4. ‚ùå Orphaned –∑–∞–ø–∏—Å–∏ –≤ –ë–î
**–ü—Ä–æ–±–ª–µ–º–∞:** 6 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤.

## üîß –ö–û–ù–ö–†–ï–¢–ù–´–ï –†–ï–®–ï–ù–ò–Ø

### –†–ï–®–ï–ù–ò–ï 1: –î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ processReferral –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `modules/auth/service.ts`  
**–ú–µ—Å—Ç–æ:** –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 164 (–≥–¥–µ `isNewUser = true`)  
**–î–æ–±–∞–≤–∏—Ç—å –∫–æ–¥:**

```typescript
// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–≤—è–∑–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if (isNewUser && options.ref_by && userInfo) {
  const ReferralService = require('../referral/service').ReferralService;
  const referralService = new ReferralService();
  
  // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–º—É –∫–æ–¥—É
  const { data: referrer } = await supabase
    .from('users')
    .select('id')
    .eq('ref_code', options.ref_by)
    .single();
  
  if (referrer) {
    await referralService.processReferral(options.ref_by, userInfo.id.toString());
    logger.info('[AuthService] –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞', { 
      newUserId: userInfo.id, 
      refCode: options.ref_by 
    });
  }
}
```

### –†–ï–®–ï–ù–ò–ï 2: –û—á–∏—Å—Ç–∏—Ç—å orphaned –∑–∞–ø–∏—Å–∏

**SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è Supabase:**
```sql
UPDATE users 
SET referred_by = NULL 
WHERE referred_by IS NOT NULL 
  AND referred_by NOT IN (SELECT id FROM users);
```

### –†–ï–®–ï–ù–ò–ï 3: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ distributeReferralRewards

**–§–∞–π–ª:** `modules/referral/service.ts`  
**–ú–µ—Ç–æ–¥:** `distributeReferralRewards`  
**–ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 215 –¥–æ–±–∞–≤–∏—Ç—å:**

```typescript
logger.info('[ReferralService] –ù–∞—á–∞–ª–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥', {
  userId,
  farmingRewardAmount: amount,
  currency
});
```

**–ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 225 –¥–æ–±–∞–≤–∏—Ç—å:**
```typescript
logger.info('[ReferralService] –ü–æ—Å—Ç—Ä–æ–µ–Ω–∞ —Ü–µ–ø–æ—á–∫–∞ —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤', {
  userId,
  chainLength: referrerChain.length,
  chain: referrerChain
});

if (referrerChain.length === 0) {
  logger.warn('[ReferralService] –¶–µ–ø–æ—á–∫–∞ —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–≤ –ø—É—Å—Ç–∞—è - –Ω–∞–≥—Ä–∞–¥—ã –Ω–µ –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã');
}
```

### –†–ï–®–ï–ù–ò–ï 4: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫—É—é –º–æ–¥–µ–ª—å

**–§–∞–π–ª:** `modules/referral/service.ts`  
**–°—Ç—Ä–æ–∫–∏ 38-58 –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞:**

```typescript
// –ù–æ–≤—ã–µ —É—Å—Ç–æ–π—á–∏–≤—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
const REFERRAL_LEVELS = {
  1: 0.05,   // 5% –≤–º–µ—Å—Ç–æ 100%
  2: 0.03,   // 3% –≤–º–µ—Å—Ç–æ 2%
  3: 0.02,   // 2% –≤–º–µ—Å—Ç–æ 3%
  4: 0.015,  // 1.5% –≤–º–µ—Å—Ç–æ 4%
  5: 0.01,   // 1% –≤–º–µ—Å—Ç–æ 5%
  6: 0.008,  // 0.8%
  7: 0.006,  // 0.6%
  8: 0.005,  // 0.5%
  9: 0.004,  // 0.4%
  10: 0.003, // 0.3%
  11: 0.0025,
  12: 0.002,
  13: 0.0018,
  14: 0.0015,
  15: 0.0012,
  16: 0.001,
  17: 0.0008,
  18: 0.0006,
  19: 0.0004,
  20: 0.0002  // 0.02%
};
// –ò—Ç–æ–≥–æ: ~19.5% –≤–º–µ—Å—Ç–æ 310%
```

### –†–ï–®–ï–ù–ò–ï 5: –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–≤—è–∑–µ–π

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `scripts/migrate-existing-referrals.ts`

```typescript
import { supabase } from '../core/supabase';
import { ReferralService } from '../modules/referral/service';

async function migrateExistingReferrals() {
  console.log('–ù–∞—á–∞–ª–æ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑–µ–π...');
  
  const referralService = new ReferralService();
  
  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏
  const { data: usersWithRefs } = await supabase
    .from('users')
    .select('id, ref_code, referred_by')
    .not('referred_by', 'is', null);
  
  if (!usersWithRefs) return;
  
  for (const user of usersWithRefs) {
    // –ù–∞—Ö–æ–¥–∏–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
    const { data: referrer } = await supabase
      .from('users')
      .select('ref_code')
      .eq('id', user.referred_by)
      .single();
    
    if (referrer && referrer.ref_code) {
      console.log(`–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º User ${user.id} -> Referrer ${user.referred_by}`);
      await referralService.processReferral(referrer.ref_code, user.id.toString());
    }
  }
  
  console.log('–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
}

migrateExistingReferrals();
```

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ä–µ—à–µ–Ω–∏–π:
1. ‚úÖ –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `referrals`
2. ‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –Ω–∞—á–Ω—É—Ç –Ω–∞—á–∏—Å–ª—è—Ç—å—Å—è –ø—Ä–∏ —Ñ–∞—Ä–º–∏–Ω–≥-–¥–æ—Ö–æ–¥–∞—Ö
3. ‚úÖ –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å —Å—Ç–∞–Ω–µ—Ç —É—Å—Ç–æ–π—á–∏–≤–æ–π (19.5% –≤–º–µ—Å—Ç–æ 310%)
4. ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω–∞ –æ—Ç –±–∏—Ç—ã—Ö —Å–≤—è–∑–µ–π
5. ‚úÖ –ü–æ—è–≤–∏—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## ‚ö° –ü–û–†–Ø–î–û–ö –í–ù–ï–î–†–ï–ù–ò–Ø

1. **–°–Ω–∞—á–∞–ª–∞** - –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–†–µ—à–µ–Ω–∏–µ 3)
2. **–ó–∞—Ç–µ–º** - –æ—á–∏—Å—Ç–∏—Ç—å orphaned –∑–∞–ø–∏—Å–∏ (–†–µ—à–µ–Ω–∏–µ 2)
3. **–ü–æ—Å–ª–µ** - –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ processReferral (–†–µ—à–µ–Ω–∏–µ 1)
4. **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ** - –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–≤—è–∑–µ–π
5. **–í –∫–æ–Ω—Ü–µ** - –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç—ã (–†–µ—à–µ–Ω–∏–µ 4)

## ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

–í—Å–µ —Ä–µ—à–µ–Ω–∏—è:
- –ù–µ –ª–æ–º–∞—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- –û–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
- –ú–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç–º–µ–Ω–µ–Ω—ã
- –ù–µ —Ç—Ä–µ–±—É—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –ë–î
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ (10-20 —Å—Ç—Ä–æ–∫)