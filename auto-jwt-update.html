<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniFarm - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #0f0f0f;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        h1 {
            color: #8b5cf6;
            margin-bottom: 30px;
            text-align: center;
        }
        .step {
            background: #252525;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .step h2 {
            color: #10b981;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .step p {
            margin: 5px 0;
            line-height: 1.6;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.success {
            background: #065f46;
            color: #10b981;
        }
        .status.error {
            background: #7f1d1d;
            color: #ef4444;
        }
        .status.warning {
            background: #78350f;
            color: #f59e0b;
        }
        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            width: 100%;
        }
        button:hover {
            background: #7c3aed;
        }
        .code {
            background: #0f0f0f;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            margin-top: 10px;
        }
        .jwt-info {
            background: #1f2937;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }
        .jwt-info h3 {
            color: #60a5fa;
            margin-bottom: 10px;
        }
        .jwt-info p {
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê UniFarm JWT Update Tool</h1>
        
        <div class="step">
            <h2>–®–∞–≥ 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</h2>
            <p>–≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:</p>
            <ul>
                <li>–£–¥–∞–ª–∏—Ç –≤—Å–µ —Å—Ç–∞—Ä—ã–µ JWT —Ç–æ–∫–µ–Ω—ã</li>
                <li>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç –Ω–æ–≤—ã–π JWT —Ç–æ–∫–µ–Ω –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</li>
                <li>–û–±–Ω–æ–≤–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</li>
            </ul>
            
            <div id="currentStatus" class="status warning">
                –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...
            </div>
        </div>

        <div class="step">
            <h2>–®–∞–≥ 2: –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <select id="userSelect" style="width: 100%; padding: 10px; background: #0f0f0f; color: #e0e0e0; border: 1px solid #4b5563; border-radius: 6px; margin-bottom: 10px;">
                <option value="61">User ID 61 (telegram_id: 987654321)</option>
                <option value="62">User ID 62 (telegram_id: 987654322)</option>
                <option value="63">User ID 63 (telegram_id: 987654323)</option>
                <option value="custom">–î—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å...</option>
            </select>
            
            <div id="customUserInput" style="display: none;">
                <input type="number" id="customUserId" placeholder="User ID" style="width: 100%; padding: 10px; background: #0f0f0f; color: #e0e0e0; border: 1px solid #4b5563; border-radius: 6px; margin-bottom: 10px;">
                <input type="number" id="customTelegramId" placeholder="Telegram ID" style="width: 100%; padding: 10px; background: #0f0f0f; color: #e0e0e0; border: 1px solid #4b5563; border-radius: 6px; margin-bottom: 10px;">
            </div>
            
            <button onclick="updateJWT()">üöÄ –û–±–Ω–æ–≤–∏—Ç—å JWT —Ç–æ–∫–µ–Ω</button>
        </div>

        <div class="step" id="resultStep" style="display: none;">
            <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
            <div id="resultStatus" class="status"></div>
            <div id="jwtInfo" class="jwt-info" style="display: none;">
                <h3>–ù–æ–≤—ã–π JWT —Ç–æ–∫–µ–Ω:</h3>
                <p id="newToken"></p>
            </div>
        </div>
    </div>

    <script>
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            checkCurrentStatus();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è select
            document.getElementById('userSelect').addEventListener('change', function(e) {
                document.getElementById('customUserInput').style.display = 
                    e.target.value === 'custom' ? 'block' : 'none';
            });
        };

        function checkCurrentStatus() {
            const statusDiv = document.getElementById('currentStatus');
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–ª—é—á–∏ JWT
            const jwtKeys = [
                'unifarm_jwt_token',
                'telegramJWT',
                'authToken',
                'jwt_token',
                'telegram_jwt'
            ];
            
            const foundTokens = [];
            jwtKeys.forEach(key => {
                const token = localStorage.getItem(key);
                if (token) {
                    foundTokens.push(key);
                }
            });
            
            if (foundTokens.length > 0) {
                statusDiv.className = 'status warning';
                statusDiv.innerHTML = `‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã JWT —Ç–æ–∫–µ–Ω—ã –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –∫–ª—é—á–∞—Ö: ${foundTokens.join(', ')}`;
                
                // –ü—ã—Ç–∞–µ–º—Å—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω
                const currentToken = localStorage.getItem('unifarm_jwt_token') || localStorage.getItem('telegramJWT');
                if (currentToken) {
                    try {
                        const payload = JSON.parse(atob(currentToken.split('.')[1]));
                        statusDiv.innerHTML += `<br>–¢–µ–∫—É—â–∏–π user_id: ${payload.userId || payload.user_id || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}`;
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', e);
                    }
                }
            } else {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = '‚ùå JWT —Ç–æ–∫–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage';
            }
        }

        async function updateJWT() {
            const resultStep = document.getElementById('resultStep');
            const resultStatus = document.getElementById('resultStatus');
            const jwtInfoDiv = document.getElementById('jwtInfo');
            const newTokenDiv = document.getElementById('newToken');
            
            resultStep.style.display = 'block';
            resultStatus.className = 'status warning';
            resultStatus.innerHTML = 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞...';
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userSelect = document.getElementById('userSelect');
            let userId, telegramId;
            
            if (userSelect.value === 'custom') {
                userId = document.getElementById('customUserId').value;
                telegramId = document.getElementById('customTelegramId').value;
                
                if (!userId || !telegramId) {
                    resultStatus.className = 'status error';
                    resultStatus.innerHTML = '‚ùå –í–≤–µ–¥–∏—Ç–µ User ID –∏ Telegram ID';
                    return;
                }
            } else {
                userId = userSelect.value;
                // –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ telegram_id –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const telegramIds = {
                    '61': 987654321,
                    '62': 987654322,
                    '63': 987654323
                };
                telegramId = telegramIds[userId];
            }
            
            try {
                // –®–∞–≥ 1: –û—á–∏—â–∞–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã
                const keysToRemove = [
                    'unifarm_jwt_token',
                    'telegramJWT',
                    'authToken',
                    'jwt_token',
                    'telegram_jwt',
                    'unifarm_last_session',
                    'unifarm_guest_id'
                ];
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                resultStatus.innerHTML = '‚úÖ –°—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã —É–¥–∞–ª–µ–Ω—ã<br>üîÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞...';
                
                // –®–∞–≥ 2: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π JWT —Ç–æ–∫–µ–Ω (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
                const header = btoa(JSON.stringify({
                    alg: 'HS256',
                    typ: 'JWT'
                }));
                
                const payload = btoa(JSON.stringify({
                    userId: parseInt(userId),
                    user_id: parseInt(userId), // –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                    telegram_id: parseInt(telegramId),
                    username: `test_user_${userId}`,
                    ref_code: `REF_TEST_${userId}`,
                    iat: Math.floor(Date.now() / 1000),
                    exp: Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60) // 7 –¥–Ω–µ–π
                }));
                
                // –ü—Ä–æ—Å—Ç–∞—è –ø–æ–¥–ø–∏—Å—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const signature = btoa(`test_signature_${userId}_${Date.now()}`);
                
                const newToken = `${header}.${payload}.${signature}`;
                
                // –®–∞–≥ 3: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
                localStorage.setItem('unifarm_jwt_token', newToken);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                resultStatus.className = 'status success';
                resultStatus.innerHTML = `‚úÖ JWT —Ç–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è user_id: ${userId}`;
                
                jwtInfoDiv.style.display = 'block';
                newTokenDiv.textContent = newToken;
                
                // –®–∞–≥ 4: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    resultStatus.innerHTML += '<br>üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...';
                    window.location.href = '/';
                }, 3000);
                
            } catch (error) {
                resultStatus.className = 'status error';
                resultStatus.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            }
        }
    </script>
</body>
</html>