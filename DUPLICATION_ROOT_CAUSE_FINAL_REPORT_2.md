# üîç –î–£–ë–õ–ò–ö–ê–¢–´ –¢–†–ê–ù–ó–ê–ö–¶–ò–ô - –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ù–ê–ô–î–ï–ù–ê (–§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç #2)

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 3 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞:** 13:30 UTC  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –í–´–°–û–ö–ê–Ø  

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –û–¢–ö–†–´–¢–ò–ï

### –†–µ–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ù–ï —Å–≤—è–∑–∞–Ω —Å TON –¥–µ–ø–æ–∑–∏—Ç–∞–º–∏
**–î–£–ë–õ–ò–ö–ê–¢–´ —Å–æ–∑–¥–∞—é—Ç—Å—è –°–ò–°–¢–ï–ú–û–ô –†–ï–§–ï–†–ê–õ–¨–ù–´–• –ù–ê–ì–†–ê–î!**

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã:
1. **14 –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∑–∞ 2 —á–∞—Å–∞** - –í–°–ï —Ç–∏–ø–∞ `REFERRAL_REWARD`
2. **–í–°–ï –¥—É–±–ª–∏–∫–∞—Ç—ã** –∏–º–µ—é—Ç `tx_hash = NULL` –∏ `boc = NULL` 
3. **–ò—Å—Ç–æ—á–Ω–∏–∫:** `core/scheduler/farmingScheduler.ts`, —Å—Ç—Ä–æ–∫–∏ 321-337
4. **–ü—Ä–æ–±–ª–µ–º–∞:** Race conditions –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ UNI —Ñ–∞—Ä–º–∏–Ω–≥–∞

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –î–£–ë–õ–ò–ö–ê–¢–û–í

**–ü—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 25: 2 √ó 0.00002257 TON (—Ä–∞–∑–Ω–∏—Ü–∞ 32 —Å–µ–∫)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 233: 2 √ó 0.0000191 TON (—Ä–∞–∑–Ω–∏—Ü–∞ 23 —Å–µ–∫)  
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 305: 2 √ó 0.000173611 TON (—Ä–∞–∑–Ω–∏—Ü–∞ 44 —Å–µ–∫)

**–û–±—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω:**
- –í—Å–µ –¥—É–±–ª–∏–∫–∞—Ç—ã: `REFERRAL_REWARD` + `source: unknown`
- –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞: 10-50 —Å–µ–∫—É–Ω–¥
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ (level, percentage, source_user_id)

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:
```typescript
// core/scheduler/farmingScheduler.ts:321-337
const referralResult = await referralService.distributeReferralRewards(
  farmer.user_id.toString(),
  income,
  'UNI',
  'farming'
);
```

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ç–æ—á–∫–∏:
1. **–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç**
2. **–ù–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è REFERRAL_REWARD**
3. **Race conditions –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—É—Å–∫–∞—Ö**
4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã**

## üìà –í–õ–ò–Ø–ù–ò–ï –ù–ê –°–ò–°–¢–ï–ú–£

### –§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –¥–≤–æ–π–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã
- –ù–∞—Ä—É—à–∞–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–±—ã—Ç–∫–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:
- –ó–∞—Å–æ—Ä–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏
- –ò—Å–∫–∞–∂–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏
- –ü—Ä–æ–±–ª–µ–º—ã —Å –∞—É–¥–∏—Ç–æ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

## üéØ –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:
1. **–ê–Ω–∞–ª–∏–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞** (`modules/referral/service.ts`)
2. **–ü–æ–∏—Å–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–π –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –≤ REFERRAL_REWARD**
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ race conditions –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ**
4. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–µ–π**

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1. ‚úÖ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å `modules/referral/service.ts`  
2. ‚ùå –ù–∞–π—Ç–∏ –º–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è REFERRAL_REWARD —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
3. ‚ùå –î–æ–±–∞–≤–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –º–µ—Ç–∫–∞–º
4. ‚ùå –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## üîç –°–¢–ê–¢–£–° –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø

**–ü—Ä–æ–≥—Ä–µ—Å—Å:** 75% –∑–∞–≤–µ—Ä—à–µ–Ω–æ  
**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** –ê–Ω–∞–ª–∏–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞  
**–û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è —Ä–µ—à–µ–Ω–∏—è:** 30-60 –º–∏–Ω—É—Ç  

**–í–∞–∂–Ω–æ:** –ö–æ–¥ –ù–ï –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –¥–æ –ø–æ–ª–Ω–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã.