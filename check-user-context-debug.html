<!DOCTYPE html>
<html>
<head>
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ UserContext –∏ JWT</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        .section {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .error { color: #f33; }
        .warning { color: #fa0; }
        .success { color: #0f0; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üîç –û—Ç–ª–∞–¥–∫–∞ UserContext –∏ JWT –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞ 74</h1>
    
    <div id="results"></div>

    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            results.appendChild(div);
        }
        
        function section(title) {
            const div = document.createElement('div');
            div.className = 'section';
            div.innerHTML = `<h2>${title}</h2>`;
            results.appendChild(div);
            return div;
        }
        
        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞
        const jwtSection = section('1. JWT –¢–æ–∫–µ–Ω');
        const token = localStorage.getItem('unifarm_jwt_token');
        
        if (token) {
            jwtSection.innerHTML += `<div class="success">‚úì JWT —Ç–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω</div>`;
            jwtSection.innerHTML += `<div>–î–ª–∏–Ω–∞ —Ç–æ–∫–µ–Ω–∞: ${token.length}</div>`;
            
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                jwtSection.innerHTML += `<pre class="success">Payload:
${JSON.stringify(payload, null, 2)}</pre>`;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º userId –≤ payload
                const userId = payload.userId || payload.user_id;
                if (userId) {
                    jwtSection.innerHTML += `<div class="success">‚úì userId –≤ —Ç–æ–∫–µ–Ω–µ: ${userId}</div>`;
                } else {
                    jwtSection.innerHTML += `<div class="error">‚úó userId –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–æ–∫–µ–Ω–µ!</div>`;
                }
            } catch (e) {
                jwtSection.innerHTML += `<div class="error">‚úó –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JWT: ${e.message}</div>`;
            }
        } else {
            jwtSection.innerHTML += `<div class="error">‚úó JWT —Ç–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!</div>`;
        }
        
        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage
        const storageSection = section('2. LocalStorage');
        const lastSession = localStorage.getItem('unifarm_last_session');
        
        if (lastSession) {
            try {
                const session = JSON.parse(lastSession);
                storageSection.innerHTML += `<pre class="success">Last Session:
${JSON.stringify(session, null, 2)}</pre>`;
            } catch (e) {
                storageSection.innerHTML += `<div class="error">‚úó –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ last_session</div>`;
            }
        } else {
            storageSection.innerHTML += `<div class="warning">‚ö† unifarm_last_session –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>`;
        }
        
        // 3. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        const debugSection = section('3. –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞');
        debugSection.innerHTML += `<pre>// –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

// 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
const userContext = window.__REACT_DEVTOOLS_GLOBAL_HOOK__?.renderers?.get(1)?.getCurrentFiber()?.memoizedProps?.value;
console.log('UserContext:', userContext);

// 2. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å:
window.dispatchEvent(new CustomEvent('force-refresh-balance'));

// 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –∑–∞–ø—Ä–æ—Å –±–∞–ª–∞–Ω—Å–∞ –Ω–∞–ø—Ä—è–º—É—é:
fetch('/api/v2/wallet/balance?user_id=74', {
    headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('unifarm_jwt_token')
    }
}).then(r => r.json()).then(console.log);

// 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
fetch('/api/v2/users/profile', {
    headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('unifarm_jwt_token')
    }
}).then(r => r.json()).then(console.log);
</pre>`;
        
        // 4. –¢–µ—Å—Ç–æ–≤—ã–π API –∑–∞–ø—Ä–æ—Å
        const apiSection = section('4. –¢–µ—Å—Ç–æ–≤—ã–π API –∑–∞–ø—Ä–æ—Å');
        
        fetch('/api/v2/wallet/balance?user_id=74', {
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
        .then(r => r.json())
        .then(data => {
            apiSection.innerHTML += `<pre class="success">API –æ—Ç–≤–µ—Ç:
${JSON.stringify(data, null, 2)}</pre>`;
        })
        .catch(err => {
            apiSection.innerHTML += `<div class="error">‚úó –û—à–∏–±–∫–∞ API: ${err.message}</div>`;
        });
    </script>
</body>
</html>