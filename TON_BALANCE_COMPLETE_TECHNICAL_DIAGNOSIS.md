# üîç –ü–û–õ–ù–ê–Ø –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: TON DEPOSITS & BALANCE DISPLAY

## üìã –ó–ê–î–ê–ß–ê
–î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—á–µ–º—É TON –¥–µ–ø–æ–∑–∏—Ç—ã —á–µ—Ä–µ–∑ Connect Wallet (Tonkeeper) –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ production –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –¥–ª—è Users 25 –∏ 227, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —É—Å–ø–µ—à–Ω—ã–µ blockchain —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

## üéØ –í–´–í–û–î–´ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò

### ‚úÖ –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û

1. **–°–µ—Ä–≤–µ—Ä –∏ API –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ**
   - –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç—É 3000
   - Health endpoint –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å "ok"
   - WebSocket endpoint –¥–æ—Å—Ç—É–ø–µ–Ω
   - API endpoints –æ—Ç–≤–µ—á–∞—é—Ç (—Ç—Ä–µ–±—É—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é)

2. **TON –¥–µ–ø–æ–∑–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞**
   - WalletService.processTonDeposit() —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   - –°–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
   - –û–±–Ω–æ–≤–ª—è–µ—Ç balance_ton –≤ users —Ç–∞–±–ª–∏—Ü–µ
   - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è type='DEPOSIT', currency='TON', status='completed'

3. **Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞ –º–µ—Å—Ç–µ**
   - BalanceCard.tsx –∏–º–µ–µ—Ç –ª–æ–≥–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (refreshBalance)
   - TonDepositCard.tsx –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å API
   - WebSocket –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞
   - Auto-refresh –±–∞–ª–∞–Ω—Å–∞ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥

## ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ù–ê–ô–î–ï–ù–´

### 1. **USERNAME COLLISION - –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ User 25 (telegram_id: 425855744) –∏ User 227 (telegram_id: 25) –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π username: "DimaOsadchuk"

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –≤–ª–∏—è–Ω–∏–µ:**
- JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å telegram_id
- –ù–æ —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å username –¥–ª—è –ø–æ–∏—Å–∫–∞
- –î–µ–ø–æ–∑–∏—Ç—ã User 25 –ø–æ–ø–∞–¥–∞—é—Ç –Ω–∞ —Å—á–µ—Ç User 227

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞:**
```
User 25 (intended recipient): 0.11 TON (2 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
User 227 (collision victim): 2.11 TON (17 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
TON transactions comparison:
- User 25: 0 TON transactions
- User 227: 17 TON transactions
```

### 2. **–ë–ê–õ–ê–ù–° MISMATCH**

**–ù–∞–π–¥–µ–Ω–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ:**
- User 25: –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å ‚â† Database –±–∞–ª–∞–Ω—Å
- User 227: –ü–æ–ª—É—á–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ User 25

### 3. **API ROUTES CONFIGURATION**

**–ü—Ä–æ–±–ª–µ–º–∞:** User profile endpoint –Ω–µ –Ω–∞–π–¥–µ–Ω
- `/api/v2/user/profile` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 404
- –≠—Ç–æ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Ä–æ—É—Ç–∏–Ω–≥–∞

## üìä –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –¶–ï–ü–û–ß–ö–ò –û–ë–†–ê–ë–û–¢–ö–ò

### STEP 1: ‚úÖ Blockchain Transaction
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã –≤ –±–ª–æ–∫—á–µ–π–Ω–µ TON
- Tonkeeper –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–µ –¥–µ–ø–æ–∑–∏—Ç—ã
- Hash —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ

### STEP 2: ‚ö†Ô∏è Connect Wallet API Processing
- POST `/api/v2/wallet/ton-deposit` endpoint —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- WalletService.processTonDeposit() —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- **–ù–û**: –í–æ–∑–º–æ–∂–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å user identification

### STEP 3: ‚ùå Database Transaction Recording
- **–ö–†–ò–¢–ò–ß–ù–û**: TON —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –Ω–µ —Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- User 25: 0 TON transactions –≤ –±–∞–∑–µ
- User 227: 17 TON transactions (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É User 25)

### STEP 4: ‚ùå Balance Manager Updates
- BalanceManager.addBalance() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
- **–ù–û**: –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- User 25: 0.11 TON (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å)
- User 227: 2.11 TON (–ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –¥–µ–ø–æ–∑–∏—Ç—ã User 25)

### STEP 5: ‚úÖ Database balance_ton Updates
- –ü–æ–ª–µ balance_ton –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–ù–û**: –≤ –∑–∞–ø–∏—Å–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### STEP 6: ‚ùå API Response Mismatch
- API getWalletBalance –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **–ù–û**: –¥–ª—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- User 25 –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–π –º–∞–ª—ã–π –±–∞–ª–∞–Ω—Å (0.11 TON)
- User 227 –ø–æ–ª—É—á–∞–µ—Ç –±–æ–ª—å—à–æ–π –±–∞–ª–∞–Ω—Å (2.11 TON), –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É User 25

### STEP 7: ‚úÖ Frontend Hooks Working
- useUserBalance hook —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API
- **–ù–û**: –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### STEP 8: ‚ùå Production vs Dev Differences
- –í DEV: –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞–º–∏
- –í PROD: —Ç–æ –∂–µ —Å–∞–º–æ–µ
- **–†–∞–∑–Ω–∏—Ü–∞ –Ω–µ –≤ —á–∞—Å—Ç–æ—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –∞ –≤ user identification**

### STEP 9: ‚úÖ Caching Working Correctly
- Frontend cache –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
- WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç
- **–ù–û**: –∫—ç—à —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–†–û–ë–õ–ï–ú–´

### Authentication Flow Analysis
```typescript
// CORRECT: JWT —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
payload: {
  userId: 25,                    // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π DB ID
  telegram_id: 425855744,        // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π Telegram ID  
  username: 'DimaOsadchuk',      // ‚ö†Ô∏è –ö–æ–ª–ª–∏–∑–∏—è —Å User 227
  ref_code: 'UNI25'
}
```

### Potential Issue in TON Deposit Processing
```typescript
// –ü–û–î–û–ó–†–ï–ù–ò–ï: –ì–¥–µ-—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è username –≤–º–µ—Å—Ç–æ userId/telegram_id
// processTonDeposit(params) –º–æ–∂–µ—Ç –∏—Å–∫–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ username
// –≠—Ç–æ –≤—ã–∑–æ–≤–µ—Ç collision –º–µ–∂–¥—É Users 25 –∏ 227
```

### Database State Evidence
```sql
-- User 25: Intended recipient
SELECT id, telegram_id, username, balance_ton FROM users WHERE id = 25;
-- Result: id=25, telegram_id=425855744, username='DimaOsadchuk', balance_ton=0.11

-- User 227: Collision victim  
SELECT id, telegram_id, username, balance_ton FROM users WHERE id = 227;
-- Result: id=227, telegram_id=25, username='DimaOsadchuk', balance_ton=2.11

-- Transaction distribution
SELECT user_id, COUNT(*), currency FROM transactions 
WHERE currency = 'TON' AND user_id IN (25, 227) 
GROUP BY user_id, currency;
-- Result: User 25: 0 TON transactions, User 227: 17 TON transactions
```

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ

### –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å User Identification
1. **–ù–∞–π—Ç–∏ –≤ WalletService.processTonDeposit() –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è username**
2. **–ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ userId –∏–ª–∏ telegram_id**
3. **–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ JWT payload.userId –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ**

### –ü–†–ò–û–†–ò–¢–ï–¢ 2: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö  
1. **–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤—Å–µ TON —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å User 227 –Ω–∞ User 25**
2. **–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å—ã –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏**
3. **–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π**

### –ü–†–ò–û–†–ò–¢–ï–¢ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. **–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ —Å User 25**
2. **–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é**
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –≤ real-time**

## üéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** Username collision –º–µ–∂–¥—É Users 25 –∏ 227 –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ç–æ–º—É, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ü–µ–ø–æ—á–∫–∞ —Ä–∞–∑—Ä—ã–≤–∞:**
Connect Wallet ‚Üí JWT (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π) ‚Üí TON Deposit Processing (–∏—â–µ—Ç –ø–æ username) ‚Üí **COLLISION** ‚Üí Wrong User Transaction ‚Üí Wrong Balance Update ‚Üí Frontend Shows Wrong Balance

**–≠—Ñ—Ñ–µ–∫—Ç:** User 25 –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ 0.11 TON –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω—ã—Ö ~2+ TON, –∫–æ—Ç–æ—Ä—ã–µ –æ—à–∏–±–æ—á–Ω–æ –∑–∞—á–∏—Å–ª–µ–Ω—ã User 227.

**–†–µ—à–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ user identification –≤ TON deposit processing –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ (userId/telegram_id) –≤–º–µ—Å—Ç–æ username.

---
**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞:** 21 –∏—é–ª—è 2025, 15:14 UTC
**–°—Ç–∞—Ç—É—Å:** –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞, –≥–æ—Ç–æ–≤—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é