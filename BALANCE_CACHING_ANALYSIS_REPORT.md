# üîç –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´ –ö–ï–®–ò–†–û–í–ê–ù–ò–Ø TON –ë–ê–õ–ê–ù–°–ê

**–î–∞—Ç–∞:** 03 –ê–≤–≥—É—Å—Ç–∞ 2025, 19:00  
**–ü—Ä–æ–±–ª–µ–º–∞:** TON –±–∞–ª–∞–Ω—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Üí –Ω–æ–≤–æ–µ ‚Üí —Å—Ç–∞—Ä–æ–µ –ø–æ—Å–ª–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è

---

## üö® **–ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ü–†–û–ë–õ–ï–ú–´**

### **üîÑ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:**

1. **UserContext.refreshBalance()** - –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±–Ω–æ–≤–ª—è—Ç–æ—Ä
2. **useWebSocketBalanceSync hook** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket
3. **–ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
4. **–†—É—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** - —á–µ—Ä–µ–∑ UI –¥–µ–π—Å—Ç–≤–∏—è

### **‚ö° Race Condition:**

```
–ü–æ—Å–ª–µ TON –¥–µ–ø–æ–∑–∏—Ç–∞:
1. WebSocket –ø–æ–ª—É—á–∞–µ—Ç balance_update —Å–æ–æ–±—â–µ–Ω–∏–µ
2. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è refreshBalance(true) - –æ—á–∏—â–∞–µ—Ç –∫–µ—à –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç API
3. –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∞–≤—Ç–æ–∏–Ω—Ç–µ—Ä–≤–∞–ª (30 —Å–µ–∫) —Ç–æ–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç refreshBalance(true)
4. –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –°–¢–ê–†–´–ï –¥–∞–Ω–Ω—ã–µ –∏–∑-–∑–∞ race condition –≤ API
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç: —Å—Ç–∞—Ä—ã–π ‚Üí –Ω–æ–≤—ã–π ‚Üí —Å—Ç–∞—Ä—ã–π –±–∞–ª–∞–Ω—Å
```

---

## üìã **–î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ê–†–•–ò–¢–ï–ö–¢–£–†–´**

### **1. üèóÔ∏è balanceService.ts - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**

```typescript
// –ü–†–û–ë–õ–ï–ú–ê: TTL –∫–µ—à–∞ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π
BALANCE_TTL: 15000, // 15 —Å–µ–∫—É–Ω–¥

// –ü–†–û–ë–õ–ï–ú–ê: forceRefresh=true –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ—Ç –∫–µ—à
if (forceRefresh) {
  cacheService.invalidate(cacheKey); // ‚Üê –£–¥–∞–ª—è–µ—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ
}
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚úó –ö–µ—à –∂–∏–≤–µ—Ç –≤—Å–µ–≥–æ 15 —Å–µ–∫—É–Ω–¥
- ‚úó forceRefresh —É–¥–∞–ª—è–µ—Ç –∫–µ—à –ø–æ–ª–Ω–æ—Å—Ç—å—é
- ‚úó –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API

### **2. üîå useWebSocketBalanceSync.ts - WebSocket —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**

```typescript
// –ü–†–û–ë–õ–ï–ú–ê: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
useEffect(() => {
  subscribeToUserUpdates(userId); // ‚Üê –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–∞—Å—Ç–æ
}, [userId, connectionStatus, subscribeToUserUpdates]);

// –ü–†–û–ë–õ–ï–ú–ê: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
useEffect(() => {
  const interval = setInterval(() => {
    refreshBalance(true); // ‚Üê –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ forceRefresh
  }, 30000);
}, [userId, refreshBalance]);
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚úó WebSocket –ø–æ–¥–ø–∏—Å–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
- ‚úó –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ—Ç –∫–µ—à –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
- ‚úó –ù–µ—Ç –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–∞ multiple balance_update —Å–æ–æ–±—â–µ–Ω–∏–π

### **3. üèõÔ∏è UserContext.tsx - –°–æ—Å—Ç–æ—è–Ω–∏–µ**

```typescript
// –ó–ê–©–ò–¢–ê: –ï—Å—Ç—å –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
if (refreshInProgressRef.current) {
  return; // ‚Üê –•–æ—Ä–æ—à–æ!
}

// –ü–†–û–ë–õ–ï–ú–ê: –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ª–∏—à–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
}, [state.userId, refreshBalance]); // ‚Üê refreshBalance –º–µ–Ω—è–µ—Ç—Å—è —á–∞—Å—Ç–æ
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚úó refreshBalance –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç—Å—è —á–∞—Å—Ç–æ –∏–∑-–∑–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- ‚úó –ù–µ—Ç –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–∞ –ø—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –≤—ã–∑–æ–≤–∞—Ö

---

## üéØ **–°–¶–ï–ù–ê–†–ò–ô –ü–†–û–ë–õ–ï–ú–´ "–ü–†–´–ì–ê–Æ–©–ò–ô –ë–ê–õ–ê–ù–°"**

### **Timeline –ø—Ä–∏ TON –¥–µ–ø–æ–∑–∏—Ç–µ:**

```
00:00 - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç TON –¥–µ–ø–æ–∑–∏—Ç
00:01 - Blockchain –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
00:02 - –°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –¥–µ–ø–æ–∑–∏—Ç, –æ–±–Ω–æ–≤–ª—è–µ—Ç –ë–î
00:03 - WebSocket –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç balance_update
00:04 - Frontend –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
00:05 - refreshBalance(true) –æ—á–∏—â–∞–µ—Ç –∫–µ—à #1
00:06 - API –∑–∞–ø—Ä–æ—Å #1 ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ù–û–í–´–ô –±–∞–ª–∞–Ω—Å ‚úÖ
00:07 - UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ù–û–í–´–ô –±–∞–ª–∞–Ω—Å
00:08 - –ò–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
00:09 - refreshBalance(true) –æ—á–∏—â–∞–µ—Ç –∫–µ—à #2
00:10 - API –∑–∞–ø—Ä–æ—Å #2 ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –°–¢–ê–†–´–ô –±–∞–ª–∞–Ω—Å ‚ùå (race condition –≤ –ë–î)
00:11 - UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –°–¢–ê–†–´–ô –±–∞–ª–∞–Ω—Å üö®
```

---

## üîç **–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó –ò–ó –õ–û–ì–û–í**

### **–ß—Ç–æ –≤–∏–¥–Ω–æ –≤ –∫–æ–Ω—Å–æ–ª–∏:**

```javascript
// –•–æ—Ä–æ—à–æ: –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—É—á–µ–Ω
[balanceService] –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –±–∞–ª–∞–Ω—Å–∞: {tonBalance: 11.952775}

// –ü—Ä–æ–±–ª–µ–º–∞: –°–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ WebSocket
[useWebSocketBalanceSync] –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: 184
[WebSocket] –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: 184

// –ü—Ä–æ–±–ª–µ–º–∞: –ö–µ—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
[CacheService] –ö–µ—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω: balance:184
```

---

## üéä **–î–ò–ê–ì–ù–û–ó**

### **üî¥ –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
**–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –º–µ–∂–¥—É –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞**

### **üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ–±–ª–µ–º—ã:**

1. **WebSocket Race Condition:**
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ balance_update —Å–æ–æ–±—â–µ–Ω–∏—è
   - –ù–µ—Ç –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–∞ WebSocket —Å–æ–±—ã—Ç–∏–π

2. **–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫–µ—à-–∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - forceRefresh=true —É–¥–∞–ª—è–µ—Ç –≤–µ—Å—å –∫–µ—à
   - –ö–æ—Ä–æ—Ç–∫–∏–π TTL (15 —Å–µ–∫)
   - –ù–µ—Ç —É–º–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

3. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ API –∑–∞–ø—Ä–æ—Å—ã:**
   - WebSocket –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ + –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
   - API –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

4. **–ù–µ—Ç state management –¥–ª—è pending –∑–∞–ø—Ä–æ—Å–æ–≤:**
   - refreshInProgressRef –∑–∞—â–∏—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É —Ñ—É–Ω–∫—Ü–∏—é
   - –ù–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

---

## üí° **–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –†–ï–®–ï–ù–ò–Ø**

### **1. –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π:**
```typescript
// –î–æ–±–∞–≤–∏—Ç—å debounce –¥–ª—è balance_update —Å–æ–æ–±—â–µ–Ω–∏–π
const debouncedRefresh = debounce(() => refreshBalance(true), 1000);
```

### **2. –£–º–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```typescript
// –£–≤–µ–ª–∏—á–∏—Ç—å TTL –∏ –¥–æ–±–∞–≤–∏—Ç—å stale-while-revalidate
BALANCE_TTL: 60000, // 60 —Å–µ–∫—É–Ω–¥ –≤–º–µ—Å—Ç–æ 15
```

### **3. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:**
```typescript
// –ï–¥–∏–Ω—ã–π BalanceManager —Å –æ—á–µ—Ä–µ–¥—å—é –∑–∞–ø—Ä–æ—Å–æ–≤
class BalanceUpdateCoordinator {
  private pendingRequests = new Set();
  private lastUpdateTime = 0;
}
```

### **4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤:**
```typescript
// –ú–µ–Ω–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
setInterval(() => refreshBalance(false), 60000); // 60 —Å–µ–∫, –±–µ–∑ forceRefresh
```

---

## ‚úÖ **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

–ü—Ä–æ–±–ª–µ–º–∞ "–ø—Ä—ã–≥–∞—é—â–µ–≥–æ" TON –±–∞–ª–∞–Ω—Å–∞ –≤—ã–∑–≤–∞–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–º –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–º - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –º–µ–∂–¥—É –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞. WebSocket –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ —Ä—É—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—Ç –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ race conditions –∏ –ø–æ–∫–∞–∑—É —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö.

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –í–´–°–û–ö–ê–Ø - –≤–ª–∏—è–µ—Ç –Ω–∞ UX –∏ –¥–æ–≤–µ—Ä–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** –°–†–ï–î–ù–Ø–Ø - —Ç—Ä–µ–±—É–µ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π  
**–í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–∏—Å—Ç–µ–º—É:** –¢–æ–ª—å–∫–æ frontend, backend —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ