# –ü–æ–ª–Ω–æ–µ –†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –ó–∞–ø–∏—Å–∏ –≤ –ë–∞–∑—É –î–∞–Ω–Ω—ã—Ö
**–î–∞—Ç–∞:** 14 –∏—é–Ω—è 2025  
**–°—Ç–∞—Ç—É—Å:** –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

## –†–ï–ó–£–õ–¨–¢–ê–¢–´ –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–Ø

### 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–∞–∑–µ –î–∞–Ω–Ω—ã—Ö
```sql
SELECT current_database(), current_schema(), current_user, inet_server_addr();
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** `neondb`
- **–°—Ö–µ–º–∞:** `public` 
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** `neondb_owner`
- **–°–µ—Ä–≤–µ—Ä:** `169.254.254.254`

### 2. –ê–Ω–∞–ª–∏–∑ –°—Ö–µ–º –≤ –ë–∞–∑–µ –î–∞–Ω–Ω—ã—Ö
```sql
SELECT schema_name FROM information_schema.schemata ORDER BY schema_name;
```
**–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å—Ö–µ–º—ã:**
- `information_schema` (—Å–∏—Å—Ç–µ–º–Ω–∞—è)
- `pg_catalog` (—Å–∏—Å—Ç–µ–º–Ω–∞—è)
- `pg_toast` (—Å–∏—Å—Ç–µ–º–Ω–∞—è)
- `public` (–æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ö–µ–º–∞ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö)

**–í–´–í–û–î:** –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö —Å—Ö–µ–º (`auth`, `testing`, `staging`, `default`) –ù–ï–¢.

### 3. –ü–æ–∏—Å–∫ –¢–∞–±–ª–∏—Ü Users
```sql
SELECT table_name, table_schema FROM information_schema.tables WHERE table_type = 'BASE TABLE' AND table_name LIKE '%user%';
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `users` –≤ —Å—Ö–µ–º–µ `public`
- `pg_user_mapping` –≤ —Å—Ö–µ–º–µ `pg_catalog` (—Å–∏—Å—Ç–µ–º–Ω–∞—è)

**–í–´–í–û–î:** –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ users –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ö–µ–º–µ `public`.

### 4. –ü–æ–ª–Ω—ã–π –ê–Ω–∞–ª–∏–∑ –¢–∞–±–ª–∏—Ü –≤ –°—Ö–µ–º–µ Public
```sql
SELECT table_name, table_schema FROM information_schema.tables WHERE table_type = 'BASE TABLE' AND table_schema = 'public';
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü–∞ `users` –≤ —Å—Ö–µ–º–µ `public`

### 5. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¢–∞–±–ª–∏—Ü—ã public.users
**–í–ª–∞–¥–µ–ª–µ—Ü —Ç–∞–±–ª–∏—Ü—ã:** `neondb_owner`  
**–°—Ö–µ–º–∞:** `public`  
**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–µ–π:** 57 –ø–æ–ª–µ–π

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**
- `id` (integer, PRIMARY KEY, auto-increment)
- `telegram_id` (bigint, NOT NULL, UNIQUE)
- `username` (varchar, nullable)
- `first_name` (varchar, nullable)
- `ref_code` (varchar, NOT NULL, UNIQUE)
- `parent_ref_code` (varchar, nullable)
- `created_at` (timestamp, default: CURRENT_TIMESTAMP)
- `updated_at` (timestamp, default: CURRENT_TIMESTAMP)

## –ê–ù–ê–õ–ò–ó –ö–û–î–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò

### –ü—É—Ç—å –ó–∞–ø–∏—Å–∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
1. **–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞:** `/api/v2/register/telegram`
2. **–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä:** `modules/auth/controller.ts` ‚Üí `AuthController.registerTelegram()`
3. **–°–µ—Ä–≤–∏—Å:** `modules/auth/service.ts` ‚Üí `AuthService.registerDirectFromTelegramUser()`
4. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å:** `modules/users/service.ts` ‚Üí `UserService.findOrCreateFromTelegram()`
5. **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** `modules/users/repository.ts` ‚Üí `UserRepository.createUserFromTelegram()`
6. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** `core/db.ts` ‚Üí Drizzle ORM ‚Üí PostgreSQL

### SQL –ó–∞–ø—Ä–æ—Å –°–æ–∑–¥–∞–Ω–∏—è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```typescript
const [newUser] = await db.insert(users)
  .values(userData)
  .returning();
```

**–ì–¥–µ `users` –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∏–∑ `shared/schema.ts`:**
```typescript
export const users = pgTable("users", { ... });
```

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–∞–∑–µ –î–∞–Ω–Ω—ã—Ö
**–§–∞–π–ª:** `core/db.ts`
```typescript
const PRODUCTION_DATABASE_URL = 'postgresql://neondb_owner:npg_SpgdNBV70WKl@ep-lucky-boat-a463bggt-pooler.us-east-1.aws.neon.tech/neondb?sslmode=require';
export const pool = new Pool({ connectionString: PRODUCTION_DATABASE_URL });
export const db = drizzle({ client: pool, schema });
```

## –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ó–ê–ü–ò–°–ò

### –¢–µ—Å—Ç–æ–≤–∞—è –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
```sql
INSERT INTO public.users (telegram_id, username, first_name, ref_code, created_at, updated_at) 
VALUES (888888888, 'investigation_user', 'Investigation', 'INVEST01', NOW(), NOW())
RETURNING id, telegram_id, username, ref_code, created_at;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- **ID:** 8
- **Telegram ID:** 888888888
- **Username:** investigation_user
- **Ref Code:** INVEST01
- **–°–æ–∑–¥–∞–Ω:** 2025-06-14 11:05:29.862717

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ó–∞–ø–∏—Å–∏
```sql
SELECT COUNT(*) FROM public.users WHERE telegram_id = 888888888;
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 1 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω

## –í–´–í–û–î–´ –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–Ø

### ‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û
1. **–°—Ö–µ–º–∞ –∑–∞–ø–∏—Å–∏:** –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `public.users`
2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** `ep-lucky-boat-a463bggt` (–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–¥–∞–∫—à–Ω –±–∞–∑–∞)
3. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:** –ß–µ—Ä–µ–∑ `core/db.ts` —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
4. **ORM:** Drizzle ORM —Å —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
5. **–ü—É—Ç—å –∑–∞–ø–∏—Å–∏:** –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ—Ç API –¥–æ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### ‚ùå –ù–ï –ù–ê–ô–î–ï–ù–û
1. **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ö–µ–º—ã:** –ù–µ—Ç —Å—Ö–µ–º `auth`, `testing`, `staging`, `default`
2. **–î—É–±–ª–∏—Ä—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã:** –ù–µ—Ç –¥—Ä—É–≥–∏—Ö —Ç–∞–±–ª–∏—Ü —Å –∏–º–µ–Ω–µ–º `users`
3. **–ü—Ä–µ—Ñ–∏–∫—Å—ã —Å—Ö–µ–º:** –ö–æ–¥ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —è–≤–Ω—ã–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã —Å—Ö–µ–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `public`)

### üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ö–û–î–ê
**UserRepository.createUserFromTelegram()** —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ INSERT
- –ü–æ–¥—Å—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–æ –∏ –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–∞

## –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –û–°–û–ë–ï–ù–ù–û–°–¢–ò

### –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –¢–æ—á–∫–∞ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è
```typescript
// core/db.ts - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
export const db = drizzle({ client: pool, schema });
```

### –ò–º–ø–æ—Ä—Ç –°—Ö–µ–º—ã
```typescript
// shared/schema.ts - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã users
export const users = pgTable("users", { ... });
```

### –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ó–∞–ø–∏—Å—å
```typescript
// modules/users/repository.ts - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
await db.insert(users).values(userData).returning();
```

## –ò–¢–û–ì–û–í–´–ô –°–¢–ê–¢–£–°

**‚úÖ –°–ò–°–¢–ï–ú–ê –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û**
- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `public.users`
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö `ep-lucky-boat-a463bggt` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ù–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö —Å—Ö–µ–º –∏–ª–∏ —Ç–∞–±–ª–∏—Ü
- –ü—É—Ç—å –∑–∞–ø–∏—Å–∏ –æ—Ç API –¥–æ –ë–î –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Å–ª–µ–∂–µ–Ω
- –¢–µ—Å—Ç–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞

**üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê**
- **–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 8
- **–ü–æ—Å–ª–µ–¥–Ω–∏–π ID:** 8
- **–¢–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 8 (–≤–∫–ª—é—á–∞—è investigation_user)
- **–ü—Ä–æ–¥–∞–∫—à–Ω –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:** 100%

---
**–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:** –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –í—Å–µ –∑–∞–ø–∏—Å–∏ –∏–¥—É—Ç —Å—Ç—Ä–æ–≥–æ –≤ `public.users` –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö `ep-lucky-boat-a463bggt`. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö —Å—Ö–µ–º –∏–ª–∏ —Ç–∞–±–ª–∏—Ü –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –ö–æ–¥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π —Ç–æ—á–∫–æ–π –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ `core/db.ts`.