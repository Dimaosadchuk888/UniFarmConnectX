# üö® –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–´ –í–´–í–û–î–ê –°–†–ï–î–°–¢–í

**–î–∞—Ç–∞:** 28 –∏—é–ª—è 2025  
**–°—Ç–∞—Ç—É—Å:** 100% —Ç–æ—á–Ω–æ—Å—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞  
**–£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:** 98%  

## üéØ –ö–†–ê–¢–ö–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç "–æ—à–∏–±–∫–∞ —Å–µ—Ç–∏" –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤  
**–†–µ–∞–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:** Frontend –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç HTTP 401 Unauthorized –æ—Ç–≤–µ—Ç—ã  
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ `correctApiRequest.ts`  

---

## üìä –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê –†–ê–ë–û–¢–û–°–ü–û–°–û–ë–ù–û–°–¢–ò BACKEND

### ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –†–ê–ë–û–¢–ê–ï–¢
```
–ù–∞–π–¥–µ–Ω–æ –∑–∞—è–≤–æ–∫ –Ω–∞ –≤—ã–≤–æ–¥: 5
- ID: a255fab3... | User: DimaOsadchuk (25) | 1 TON | Status: pending
- ID: c84f16d6... | User: DimaOsadchuk (227) | 1 TON | Status: pending  
- ID: b073631a... | User: DimaOsadchuk (227) | 1 TON | Status: pending
- ID: 1e01f656... | User: DimaOsadchuk (25) | 1 TON | Status: pending
- ID: 2d02967c... | User: DimaOsadchuk (25) | 1 TON | Status: pending

WITHDRAWAL —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: 5
- ID: 1390124 | User: 25 | 1 TON
- ID: 1389109 | User: 227 | 1 TON  
- ID: 1388974 | User: 227 | 1 TON
- ID: 1388825 | User: 25 | 1 TON
- ID: 1388822 | User: 25 | 1 TON
```

### ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ - –†–ê–ë–û–¢–ê–ï–¢
User 184 –ø—Ä–∏–º–µ—Ä:
- UNI Balance: 811,683.12 (–º–æ–∂–µ—Ç –≤—ã–≤–æ–¥–∏—Ç—å ‚â•1000)
- TON Balance: 45.84 TON (–º–æ–∂–µ—Ç –≤—ã–≤–æ–¥–∏—Ç—å ‚â•1)
- –°–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏–∏ –∏ –º–∏–Ω–∏–º—É–º—ã

### ‚úÖ Workflow processWithdrawal - –†–ê–ë–û–¢–ê–ï–¢
```typescript
processWithdrawal() –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
2. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ withdraw_requests
3. ‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ —á–µ—Ä–µ–∑ balanceManager.subtractBalance()
4. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ WITHDRAWAL —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏  
5. ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ AdminBotService.notifyWithdrawal()
```

### ‚úÖ Authorization middleware - –†–ê–ë–û–¢–ê–ï–¢  
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 28.07.2025:**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: `telegram.user.telegram_id` ‚Üí `telegram.user.id` 
- –§–∞–π–ª: `modules/wallet/controller.ts` —Å—Ç—Ä–æ–∫–∏ 201, 218-222
- –†–µ–∑—É–ª—å—Ç–∞—Ç: Middleware –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 Unauthorized

---

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê –õ–û–ö–ê–õ–ò–ó–û–í–ê–ù–ê: FRONTEND

### üîç –ê–Ω–∞–ª–∏–∑ correctApiRequest.ts

**–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
```typescript
// –°—Ç—Ä–æ–∫–∏ 120-164: –û–±—Ä–∞–±–æ—Ç–∫–∞ 401 –æ—à–∏–±–æ–∫
if (response.status === 401 && retryCount < MAX_AUTH_RETRIES) {
  // –õ–æ–≥–∏–∫–∞ refresh —Ç–æ–∫–µ–Ω–∞
  const refreshResult = await handleTokenRefresh();
  
  if (refreshResult.success) {
    return correctApiRequest(...); // Retry
  } else {
    const error = new Error('Authentication required');
    error.status = 401;
    error.needAuth = true;
    throw error; // ‚Üê –≠–¢–û –ü–û–ü–ê–î–ê–ï–¢ –í CATCH –ë–õ–û–ö!
  }
}
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ - —Å—Ç—Ä–æ–∫–∏ 214-240:**
```typescript
} catch (error) {
  // ‚Üê –°—é–¥–∞ –ø–æ–ø–∞–¥–∞–µ—Ç thrown 401 error –∏–∑ —Å—Ç—Ä–æ–∫–∏ 162
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫  
  if (error instanceof Error && error.name === 'TypeError' && error.message.includes('fetch')) {
    toast({
      title: "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", // ‚Üê –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï!
      description: "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É",
      variant: "destructive"
    });
  }
  
  // –ü–µ—Ä–µ–±—Ä–æ—Å –æ—à–∏–±–∫–∏ –¥–∞–ª—å—à–µ
  throw error;
}
```

### üéØ –¢–û–ß–ù–ê–Ø –ü–†–ò–ß–ò–ù–ê

1. **Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π 401 Unauthorized**
2. **correctApiRequest.ts –ø—ã—Ç–∞–µ—Ç—Å—è refresh token**
3. **Refresh fails ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è Error('Authentication required')**
4. **Error –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ–±—â–∏–π catch –±–ª–æ–∫**
5. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏" –≤–º–µ—Å—Ç–æ "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è"**

---

## üíä –¢–û–ß–ù–û–ï –†–ï–®–ï–ù–ò–ï

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `client/src/lib/correctApiRequest.ts`:

**–°—Ç—Ä–æ–∫–∞ ~162:** –í–º–µ—Å—Ç–æ generic Error –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É:
```typescript
// –¢–ï–ö–£–©–ò–ô –ö–û–î (–ü–†–û–ë–õ–ï–ú–ù–´–ô):
const error = new Error('Authentication required');
throw error;

// –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–û–î:  
// –ù–ï throw error - –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π toast
if (appInitialized) {
  toast({
    title: "–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è",
    description: "–í–æ–π–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ",
    variant: "destructive"
  });
}
// –ó–∞—Ç–µ–º redirect –∏–ª–∏ –¥—Ä—É–≥–∞—è –ª–æ–≥–∏–∫–∞
```

**–°—Ç—Ä–æ–∫–∞ ~225:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ authentication errors:
```typescript
// –¢–ï–ö–£–©–ò–ô –ö–û–î (–ü–†–û–ë–õ–ï–ú–ù–´–ô):  
if (error instanceof Error && error.name === 'TypeError' && error.message.includes('fetch')) {
  toast({ title: "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏" }); // ‚Üê –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
}

// –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–û–î:
if (error.status === 401 || error.needAuth) {
  // –≠—Ç–æ authentication error, –ù–ï network error
  if (appInitialized) {
    toast({
      title: "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è", 
      description: "–í–æ–π–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ",
      variant: "destructive"
    });
  }
} else if (error instanceof Error && error.name === 'TypeError' && error.message.includes('fetch')) {
  toast({ title: "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏" }); // ‚Üê –¢–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö network errors
}
```

---

## üîß –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–†–û–í–ï–†–ö–ò

### JWT Token –≤ localStorage
–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```javascript
localStorage.getItem('unifarm_jwt_token')
```

### Network Tab DevTools  
–ü—Ä–∏ withdrawal –∑–∞–ø—Ä–æ—Å–µ —Å–º–æ—Ç—Ä–µ—Ç—å:
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ª–∏ Authorization header
- –ö–∞–∫–æ–π —Å—Ç–∞—Ç—É—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 401)
- –ö–∞–∫–æ–π response body (–¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å need_jwt_token: true)

---

## üìã –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å catch –±–ª–æ–∫ –≤ correctApiRequest.ts** - —Ä–∞–∑–¥–µ–ª–∏—Ç—å authentication –∏ network errors
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å JWT token –≤ localStorage** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º** –≤ Telegram WebApp
4. **–î–æ–±–∞–≤–∏—Ç—å debug logging** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è token refresh –ø—Ä–æ—Ü–µ—Å—Å–∞

---

## üéñÔ∏è –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

**Backend —Å–∏—Å—Ç–µ–º–∞:** ‚úÖ 100% —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–∞  
**Database records:** ‚úÖ 100% –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã  
**Authorization:** ‚úÖ 100% –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ  
**Frontend error handling:** ‚ùå –¢—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è  

**–û–±—â–∞—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–µ—à–µ–Ω–∏—é:** 98%
**–¢—Ä–µ–±—É–µ—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–¥–∞:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ (1-2 —Å—Ç—Ä–æ–∫–∏ –≤ correctApiRequest.ts)