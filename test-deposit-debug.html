<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ - –û—Ç–ª–∞–¥–∫–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        .button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        pre {
            background: #2d3748;
            color: white;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .balance-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .balance-item {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .balance-value {
            font-size: 20px;
            font-weight: bold;
            color: #007bff;
        }
        .balance-label {
            font-size: 12px;
            color: #666;
        }
        .test-section {
            border: 2px dashed #007bff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –¢–µ—Å—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ - –û—Ç–ª–∞–¥–∫–∞</h1>
        
        <div class="balance-info">
            <div class="balance-item">
                <div class="balance-value" id="currentBalance">-</div>
                <div class="balance-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å UNI</div>
            </div>
            <div class="balance-item">
                <div class="balance-value" id="currentDeposit">-</div>
                <div class="balance-label">–î–µ–ø–æ–∑–∏—Ç –≤ —Ñ–∞—Ä–º–∏–Ω–≥–µ</div>
            </div>
        </div>

        <div class="test-section">
            <h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ API</h3>
            <button class="button" onclick="testFarmingAPI()">üìä –§–∞—Ä–º–∏–Ω–≥ API</button>
            <button class="button" onclick="testWalletAPI()">üí∞ Wallet API</button>
            <button class="button" onclick="testDepositAPI()">üîß –î–µ–ø–æ–∑–∏—Ç API</button>
        </div>

        <div class="test-section">
            <h3>–¢–µ—Å—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ 1 UNI</h3>
            <button class="button" onclick="performDeposit(1)">üí∏ –î–µ–ø–æ–∑–∏—Ç 1 UNI</button>
            <button class="button" onclick="performDeposit(2)">üí∏ –î–µ–ø–æ–∑–∏—Ç 2 UNI</button>
            <button class="button" onclick="performDeposit(5)">üí∏ –î–µ–ø–æ–∑–∏—Ç 5 UNI</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'https://uni-farm-connect-x-ab245275.replit.app';
        const JWT_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjYyLCJ0ZWxlZ3JhbV9pZCI6ODg4ODg4NDgsInVzZXJuYW1lIjoicHJldmlld190ZXN0IiwiZmlyc3RfbmFtZSI6IlByZXZpZXciLCJyZWZfY29kZSI6IlJFRl8xNzUxNzgwNTIxOTE4X2UxdjYyZCIsImlhdCI6MTc1MTg3MTA2MywiZXhwIjoxNzUyNDc1ODYzfQ.NKbyJiXtLnGzyr0w-C1oR658X5TzDO6EkKU8Ie5zgE0';

        function addResult(title, content, type = 'result') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `
                <h4>${title}</h4>
                <div>${content}</div>
                <small>–í—Ä–µ–º—è: ${new Date().toLocaleTimeString()}</small>
            `;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function updateBalance(farmingData) {
            if (farmingData && farmingData.data) {
                document.getElementById('currentBalance').textContent = farmingData.data.balance_uni.toFixed(3);
                document.getElementById('currentDeposit').textContent = farmingData.data.uni_deposit_amount.toFixed(0);
            }
        }

        async function testFarmingAPI() {
            try {
                const response = await fetch(`${API_BASE}/api/v2/uni-farming/status?user_id=62`, {
                    headers: {
                        'Authorization': `Bearer ${JWT_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    updateBalance(data);
                    addResult('‚úÖ –§–∞—Ä–º–∏–Ω–≥ API —Ä–∞–±–æ—Ç–∞–µ—Ç', `
                        <div>–°—Ç–∞—Ç—É—Å: ${response.status}</div>
                        <div>–ë–∞–ª–∞–Ω—Å UNI: ${data.data.balance_uni}</div>
                        <div>–î–µ–ø–æ–∑–∏—Ç: ${data.data.uni_deposit_amount}</div>
                        <div>–ê–∫—Ç–∏–≤–µ–Ω: ${data.data.uni_farming_active ? '–î–∞' : '–ù–µ—Ç'}</div>
                    `, 'success');
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –§–∞—Ä–º–∏–Ω–≥ API', `
                        <div>–°—Ç–∞—Ç—É—Å: ${response.status}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `, 'error');
                }
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', error.message, 'error');
            }
        }

        async function testWalletAPI() {
            try {
                const response = await fetch(`${API_BASE}/api/v2/wallet/balance?user_id=62`, {
                    headers: {
                        'Authorization': `Bearer ${JWT_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const text = await response.text();
                
                try {
                    const data = JSON.parse(text);
                    addResult('‚úÖ Wallet API —Ä–∞–±–æ—Ç–∞–µ—Ç', `
                        <div>–°—Ç–∞—Ç—É—Å: ${response.status}</div>
                        <div>UNI –±–∞–ª–∞–Ω—Å: ${data.data.uniBalance}</div>
                        <div>TON –±–∞–ª–∞–Ω—Å: ${data.data.tonBalance}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `, 'success');
                } catch (parseError) {
                    addResult('‚ùå Wallet API - –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON', `
                        <div>–°—Ç–∞—Ç—É—Å: ${response.status}</div>
                        <div>Raw response: ${text}</div>
                        <div>JSON Error: ${parseError.message}</div>
                    `, 'error');
                }
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ Wallet API', error.message, 'error');
            }
        }

        async function testDepositAPI() {
            try {
                const response = await fetch(`${API_BASE}/api/v2/uni-farming/deposit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${JWT_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: '0.001',
                        user_id: 62
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    addResult('‚úÖ –î–µ–ø–æ–∑–∏—Ç API —Ä–∞–±–æ—Ç–∞–µ—Ç', `
                        <div>–°—Ç–∞—Ç—É—Å: ${response.status}</div>
                        <div>–û—Ç–≤–µ—Ç: ${data.message}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `, 'success');
                } else {
                    addResult('‚ùå –û—à–∏–±–∫–∞ –î–µ–ø–æ–∑–∏—Ç API', `
                        <div>–°—Ç–∞—Ç—É—Å: ${response.status}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `, 'error');
                }
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', error.message, 'error');
            }
        }

        async function performDeposit(amount) {
            // –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –î–û –¥–µ–ø–æ–∑–∏—Ç–∞
            const balanceBefore = await getFarmingData();
            
            addResult(`üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–æ–∑–∏—Ç ${amount} UNI`, `
                <div>–ë–∞–ª–∞–Ω—Å –î–û: ${balanceBefore?.balance_uni || 'N/A'} UNI</div>
                <div>–î–µ–ø–æ–∑–∏—Ç –î–û: ${balanceBefore?.uni_deposit_amount || 'N/A'} UNI</div>
            `, 'result');

            try {
                const response = await fetch(`${API_BASE}/api/v2/uni-farming/deposit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${JWT_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: amount.toString(),
                        user_id: 62
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    addResult(`‚úÖ –î–µ–ø–æ–∑–∏—Ç ${amount} UNI –≤—ã–ø–æ–ª–Ω–µ–Ω`, `
                        <div>–°—Ç–∞—Ç—É—Å: ${response.status}</div>
                        <div>–û—Ç–≤–µ—Ç: ${data.message}</div>
                    `, 'success');
                    
                    // –ñ–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    setTimeout(async () => {
                        const balanceAfter = await getFarmingData();
                        
                        if (balanceBefore && balanceAfter) {
                            const balanceChange = balanceAfter.balance_uni - balanceBefore.balance_uni;
                            const depositChange = balanceAfter.uni_deposit_amount - balanceBefore.uni_deposit_amount;
                            
                            addResult(`üìä –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ –¥–µ–ø–æ–∑–∏—Ç–∞ ${amount} UNI`, `
                                <div>–ë–∞–ª–∞–Ω—Å –ü–û–°–õ–ï: ${balanceAfter.balance_uni} UNI</div>
                                <div>–î–µ–ø–æ–∑–∏—Ç –ü–û–°–õ–ï: ${balanceAfter.uni_deposit_amount} UNI</div>
                                <div>–ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞: ${balanceChange.toFixed(6)} UNI</div>
                                <div>–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞: ${depositChange.toFixed(6)} UNI</div>
                                <div><strong>–°–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong> ${Math.abs(balanceChange + amount) < 0.001 ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢'}</div>
                            `, balanceChange < 0 ? 'success' : 'error');
                        }
                    }, 2000);
                } else {
                    addResult(`‚ùå –û—à–∏–±–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–∞ ${amount} UNI`, `
                        <div>–°—Ç–∞—Ç—É—Å: ${response.status}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `, 'error');
                }
            } catch (error) {
                addResult('‚ùå –û—à–∏–±–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–∞', error.message, 'error');
            }
        }

        async function getFarmingData() {
            try {
                const response = await fetch(`${API_BASE}/api/v2/uni-farming/status?user_id=62`, {
                    headers: {
                        'Authorization': `Bearer ${JWT_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                return data.success ? data.data : null;
            } catch (error) {
                return null;
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            testFarmingAPI();
        };
    </script>
</body>
</html>