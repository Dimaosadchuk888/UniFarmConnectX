/**
 * üõ°Ô∏èüîß UNIFARM E2E COMPREHENSIVE TEST SCRIPT
 * 
 * ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ UniFarm
 * ‚ö†Ô∏è –°–¢–†–û–ì–û –¢–û–õ–¨–ö–û –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –í REPLIT PREVIEW
 * 
 * –ó–∞–¥–∞—á–∏:
 * 1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (user_id: 9999, telegram_id: 999999999)
 * 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
 * 3. –¢–µ—Å—Ç –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã
 * 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ UI —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
 * 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
 * 
 * ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
 * - –ù–ï –ò–ó–ú–ï–ù–Ø–ï–¢ –ø—Ä–æ–¥–∞–∫—à–Ω –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
 * - –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
 * - –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è —Å—Ä–µ–¥–∞
 */

const fs = require('fs');
const path = require('path');

let fetch;

async function initFetch() {
  if (!fetch) {
    const fetchModule = await import('node-fetch');
    fetch = fetchModule.default;
  }
  return fetch;
}

// üîí –¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const TEST_CONFIG = {
  BASE_URL: 'http://localhost:3000',
  TEST_USER: {
    id: 9999,
    telegram_id: 999999999,
    username: 'test_e2e_user',
    first_name: 'TestE2E',
    last_name: 'User',
    ref_code: 'TEST_E2E_REF_999'
  },
  TEST_REFERRAL: {
    id: 9998,
    telegram_id: 999999998,
    username: 'test_e2e_referral',
    first_name: 'TestE2E',
    last_name: 'Referral',
    ref_code: 'TEST_E2E_REF_998'
  },
  INITIAL_BALANCE: {
    UNI: 1000,
    TON: 1000
  },
  FARMING_AMOUNT: 100,
  BOOST_PACKAGE: 'Starter', // 1% TON Boost
  BOOST_AMOUNT: 10
};

// üéØ –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
let testResults = {
  passed: 0,
  failed: 0,
  tests: []
};

let testUserToken = null;
let referralUserToken = null;

// üîß –£—Ç–∏–ª–∏—Ç—ã
class TestLogger {
  static log(message, type = 'INFO') {
    const timestamp = new Date().toISOString();
    const logMessage = `[${timestamp}] [${type}] ${message}`;
    console.log(logMessage);
  }

  static success(message) {
    this.log(`‚úÖ ${message}`, 'SUCCESS');
  }

  static error(message) {
    this.log(`‚ùå ${message}`, 'ERROR');
  }

  static warn(message) {
    this.log(`‚ö†Ô∏è ${message}`, 'WARNING');
  }

  static info(message) {
    this.log(`‚ÑπÔ∏è ${message}`, 'INFO');
  }
}

// üß™ –¢–µ—Å—Ç-—Ñ—É–Ω–∫—Ü–∏–∏
async function makeRequest(endpoint, options = {}) {
  await initFetch();
  
  const url = `${TEST_CONFIG.BASE_URL}${endpoint}`;
  const defaultOptions = {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
      ...options.headers
    }
  };

  const finalOptions = { ...defaultOptions, ...options };
  
  try {
    const response = await fetch(url, finalOptions);
    const data = await response.json();
    
    TestLogger.info(`${finalOptions.method} ${endpoint} - Status: ${response.status}`);
    
    return {
      success: response.ok,
      status: response.status,
      data: data
    };
  } catch (error) {
    TestLogger.error(`Request failed: ${endpoint} - ${error.message}`);
    return {
      success: false,
      status: 0,
      data: null,
      error: error.message
    };
  }
}

async function test(name, testFunction) {
  TestLogger.info(`üß™ Starting test: ${name}`);
  
  try {
    const result = await testFunction();
    
    if (result.success) {
      TestLogger.success(`Test passed: ${name}`);
      testResults.passed++;
      testResults.tests.push({
        name,
        status: 'PASSED',
        details: result.details || 'Test completed successfully'
      });
    } else {
      TestLogger.error(`Test failed: ${name} - ${result.error}`);
      testResults.failed++;
      testResults.tests.push({
        name,
        status: 'FAILED',
        error: result.error,
        details: result.details
      });
    }
  } catch (error) {
    TestLogger.error(`Test error: ${name} - ${error.message}`);
    testResults.failed++;
    testResults.tests.push({
      name,
      status: 'ERROR',
      error: error.message
    });
  }
}

// üîê –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function createTestUser(userConfig) {
  const response = await makeRequest('/api/v2/auth/register/telegram', {
    method: 'POST',
    body: JSON.stringify({
      telegram_id: userConfig.telegram_id,
      username: userConfig.username,
      first_name: userConfig.first_name,
      last_name: userConfig.last_name,
      direct_registration: true
    })
  });

  if (!response.success) {
    // –ü—Ä–æ–±—É–µ–º –ø—Ä—è–º—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    const directResponse = await makeRequest('/api/v2/auth/telegram', {
      method: 'POST',
      body: JSON.stringify({
        telegram_id: userConfig.telegram_id,
        username: userConfig.username,
        first_name: userConfig.first_name,
        last_name: userConfig.last_name,
        direct_registration: true
      })
    });
    
    if (directResponse.success && directResponse.data.token) {
      return directResponse.data.token;
    }
  }

  if (response.success && response.data.token) {
    return response.data.token;
  }

  throw new Error(`Failed to create test user: ${response.data?.error || 'Unknown error'}`);
}

// üéØ –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å–∏—Å—Ç–µ–º—ã

// 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function testUserCreation() {
  try {
    testUserToken = await createTestUser(TEST_CONFIG.TEST_USER);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const profileResponse = await makeRequest('/api/v2/user/profile', {
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      }
    });

    if (!profileResponse.success) {
      return {
        success: false,
        error: 'Failed to get user profile',
        details: profileResponse.data
      };
    }

    const user = profileResponse.data.user;
    
    return {
      success: true,
      details: {
        user_id: user.id,
        telegram_id: user.telegram_id,
        username: user.username,
        ref_code: user.ref_code,
        balance_uni: user.balance_uni,
        balance_ton: user.balance_ton
      }
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

// 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
async function testBalanceDeposit() {
  try {
    // –ü–æ–ø–æ–ª–Ω—è–µ–º UNI –±–∞–ª–∞–Ω—Å
    const uniDepositResponse = await makeRequest('/api/v2/wallet/deposit', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      },
      body: JSON.stringify({
        amount: TEST_CONFIG.INITIAL_BALANCE.UNI,
        currency: 'UNI'
      })
    });

    if (!uniDepositResponse.success) {
      return {
        success: false,
        error: 'Failed to deposit UNI',
        details: uniDepositResponse.data
      };
    }

    // –ü–æ–ø–æ–ª–Ω—è–µ–º TON –±–∞–ª–∞–Ω—Å
    const tonDepositResponse = await makeRequest('/api/v2/wallet/deposit', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      },
      body: JSON.stringify({
        amount: TEST_CONFIG.INITIAL_BALANCE.TON,
        currency: 'TON'
      })
    });

    if (!tonDepositResponse.success) {
      return {
        success: false,
        error: 'Failed to deposit TON',
        details: tonDepositResponse.data
      };
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
    const balanceResponse = await makeRequest('/api/v2/wallet/balance', {
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      }
    });

    if (!balanceResponse.success) {
      return {
        success: false,
        error: 'Failed to get balance',
        details: balanceResponse.data
      };
    }

    const balance = balanceResponse.data;
    
    return {
      success: true,
      details: {
        uni_balance: balance.uni,
        ton_balance: balance.ton,
        uni_deposited: TEST_CONFIG.INITIAL_BALANCE.UNI,
        ton_deposited: TEST_CONFIG.INITIAL_BALANCE.TON
      }
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

// 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ UNI Farming
async function testUniFarming() {
  try {
    // –ù–∞—á–∏–Ω–∞–µ–º UNI —Ñ–∞—Ä–º–∏–Ω–≥
    const startFarmingResponse = await makeRequest('/api/v2/farming/start', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      },
      body: JSON.stringify({
        amount: TEST_CONFIG.FARMING_AMOUNT
      })
    });

    if (!startFarmingResponse.success) {
      return {
        success: false,
        error: 'Failed to start UNI farming',
        details: startFarmingResponse.data
      };
    }

    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å —Ñ–∞—Ä–º–∏–Ω–≥–∞
    const farmingStatusResponse = await makeRequest('/api/v2/farming/status', {
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      }
    });

    if (!farmingStatusResponse.success) {
      return {
        success: false,
        error: 'Failed to get farming status',
        details: farmingStatusResponse.data
      };
    }

    const farmingStatus = farmingStatusResponse.data;
    
    return {
      success: true,
      details: {
        farming_amount: TEST_CONFIG.FARMING_AMOUNT,
        farming_rate: farmingStatus.farming_rate,
        farming_started: farmingStatus.farming_started,
        expected_daily_income: farmingStatus.expected_daily_income
      }
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

// 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ TON Boost
async function testTonBoost() {
  try {
    // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
    const packagesResponse = await makeRequest('/api/v2/boost/packages', {
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      }
    });

    if (!packagesResponse.success) {
      return {
        success: false,
        error: 'Failed to get boost packages',
        details: packagesResponse.data
      };
    }

    const packages = packagesResponse.data.packages;
    const starterPackage = packages.find(p => p.name === TEST_CONFIG.BOOST_PACKAGE);
    
    if (!starterPackage) {
      return {
        success: false,
        error: 'Starter package not found',
        details: { available_packages: packages.map(p => p.name) }
      };
    }

    // –ü–æ–∫—É–ø–∞–µ–º Boost –ø–∞–∫–µ—Ç
    const purchaseResponse = await makeRequest('/api/v2/boost/purchase', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      },
      body: JSON.stringify({
        package_name: TEST_CONFIG.BOOST_PACKAGE,
        amount: TEST_CONFIG.BOOST_AMOUNT
      })
    });

    if (!purchaseResponse.success) {
      return {
        success: false,
        error: 'Failed to purchase boost package',
        details: purchaseResponse.data
      };
    }

    // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –±—É—Å—Ç-–ø–∞–∫–µ—Ç—ã
    const activeBoostsResponse = await makeRequest('/api/v2/boost/active', {
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      }
    });

    if (!activeBoostsResponse.success) {
      return {
        success: false,
        error: 'Failed to get active boosts',
        details: activeBoostsResponse.data
      };
    }

    const activeBoosts = activeBoostsResponse.data;
    
    return {
      success: true,
      details: {
        package_purchased: TEST_CONFIG.BOOST_PACKAGE,
        amount_invested: TEST_CONFIG.BOOST_AMOUNT,
        active_boosts: activeBoosts.active_boosts,
        boost_rate: starterPackage.rate
      }
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

// 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã
async function testReferralSystem() {
  try {
    // –°–æ–∑–¥–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    referralUserToken = await createTestUser(TEST_CONFIG.TEST_REFERRAL);
    
    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const referralCodeResponse = await makeRequest('/api/v2/referral/code', {
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      }
    });

    if (!referralCodeResponse.success) {
      return {
        success: false,
        error: 'Failed to get referral code',
        details: referralCodeResponse.data
      };
    }

    const referralCode = referralCodeResponse.data.ref_code;

    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–æ–¥–æ–º
    const referralRegistrationResponse = await makeRequest('/api/v2/referral/register', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${referralUserToken}`
      },
      body: JSON.stringify({
        ref_code: referralCode
      })
    });

    if (!referralRegistrationResponse.success) {
      return {
        success: false,
        error: 'Failed to register referral',
        details: referralRegistrationResponse.data
      };
    }

    // –î–µ–ª–∞–µ–º –¥–µ–ø–æ–∑–∏—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–∏—Å—Å–∏–∏
    const referralDepositResponse = await makeRequest('/api/v2/wallet/deposit', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${referralUserToken}`
      },
      body: JSON.stringify({
        amount: 100,
        currency: 'UNI'
      })
    });

    if (!referralDepositResponse.success) {
      return {
        success: false,
        error: 'Failed referral deposit',
        details: referralDepositResponse.data
      };
    }

    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
    const referralStatsResponse = await makeRequest('/api/v2/referral/stats', {
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      }
    });

    if (!referralStatsResponse.success) {
      return {
        success: false,
        error: 'Failed to get referral stats',
        details: referralStatsResponse.data
      };
    }

    const referralStats = referralStatsResponse.data;
    
    return {
      success: true,
      details: {
        referral_code: referralCode,
        referral_registered: true,
        referral_stats: referralStats,
        referral_deposit: 100
      }
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

// 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ Daily Bonus
async function testDailyBonus() {
  try {
    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å daily bonus
    const bonusStatusResponse = await makeRequest('/api/v2/daily-bonus/status', {
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      }
    });

    if (!bonusStatusResponse.success) {
      return {
        success: false,
        error: 'Failed to get daily bonus status',
        details: bonusStatusResponse.data
      };
    }

    const bonusStatus = bonusStatusResponse.data;

    // –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∑–∞–±–∏—Ä–∞–µ–º daily bonus
    if (bonusStatus.available) {
      const claimBonusResponse = await makeRequest('/api/v2/daily-bonus/claim', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${testUserToken}`
        }
      });

      if (!claimBonusResponse.success) {
        return {
          success: false,
          error: 'Failed to claim daily bonus',
          details: claimBonusResponse.data
        };
      }

      const claimResult = claimBonusResponse.data;
      
      return {
        success: true,
        details: {
          bonus_available: true,
          bonus_claimed: true,
          bonus_amount: claimResult.bonus_amount,
          streak: claimResult.streak
        }
      };
    } else {
      return {
        success: true,
        details: {
          bonus_available: false,
          next_bonus_in: bonusStatus.next_bonus_in,
          current_streak: bonusStatus.streak
        }
      };
    }
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

// 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ Missions
async function testMissions() {
  try {
    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–∏—Å—Å–∏–π
    const missionsResponse = await makeRequest('/api/v2/missions/list', {
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      }
    });

    if (!missionsResponse.success) {
      return {
        success: false,
        error: 'Failed to get missions list',
        details: missionsResponse.data
      };
    }

    const missions = missionsResponse.data.missions;
    
    if (missions.length === 0) {
      return {
        success: true,
        details: {
          missions_available: false,
          message: 'No missions available'
        }
      };
    }

    // –ü—Ä–æ–±—É–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–≤—É—é –º–∏—Å—Å–∏—é
    const firstMission = missions[0];
    const completeMissionResponse = await makeRequest(`/api/v2/missions/complete/${firstMission.id}`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      }
    });

    if (!completeMissionResponse.success) {
      return {
        success: false,
        error: 'Failed to complete mission',
        details: completeMissionResponse.data
      };
    }

    const completionResult = completeMissionResponse.data;
    
    return {
      success: true,
      details: {
        missions_available: true,
        total_missions: missions.length,
        mission_completed: firstMission.title,
        reward: completionResult.reward
      }
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

// 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
async function testTransactions() {
  try {
    // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    const transactionsResponse = await makeRequest('/api/v2/transactions', {
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      }
    });

    if (!transactionsResponse.success) {
      return {
        success: false,
        error: 'Failed to get transactions',
        details: transactionsResponse.data
      };
    }

    const transactions = transactionsResponse.data.transactions;
    
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    const transactionTypes = {};
    transactions.forEach(tx => {
      transactionTypes[tx.type] = (transactionTypes[tx.type] || 0) + 1;
    });

    return {
      success: true,
      details: {
        total_transactions: transactions.length,
        transaction_types: transactionTypes,
        latest_transactions: transactions.slice(0, 5).map(tx => ({
          type: tx.type,
          amount_uni: tx.amount_uni,
          amount_ton: tx.amount_ton,
          created_at: tx.created_at
        }))
      }
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

// 9. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞
async function testFinalBalance() {
  try {
    // –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
    const finalBalanceResponse = await makeRequest('/api/v2/wallet/balance', {
      headers: {
        'Authorization': `Bearer ${testUserToken}`
      }
    });

    if (!finalBalanceResponse.success) {
      return {
        success: false,
        error: 'Failed to get final balance',
        details: finalBalanceResponse.data
      };
    }

    const finalBalance = finalBalanceResponse.data;
    
    return {
      success: true,
      details: {
        final_uni_balance: finalBalance.uni,
        final_ton_balance: finalBalance.ton,
        balance_changes: {
          uni: finalBalance.uni - TEST_CONFIG.INITIAL_BALANCE.UNI,
          ton: finalBalance.ton - TEST_CONFIG.INITIAL_BALANCE.TON
        }
      }
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

// üßπ –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
async function cleanupTestData() {
  TestLogger.warn('Starting test data cleanup...');
  
  try {
    // –ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–µ—Å–ª–∏ API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)
    if (testUserToken) {
      await makeRequest('/api/v2/user/delete', {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${testUserToken}`
        }
      });
    }

    if (referralUserToken) {
      await makeRequest('/api/v2/user/delete', {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${referralUserToken}`
        }
      });
    }

    TestLogger.success('Test data cleanup completed');
  } catch (error) {
    TestLogger.warn(`Cleanup warning: ${error.message}`);
  }
}

// üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
function generateReport() {
  const reportData = {
    timestamp: new Date().toISOString(),
    environment: 'Replit Preview',
    test_summary: {
      total_tests: testResults.passed + testResults.failed,
      passed: testResults.passed,
      failed: testResults.failed,
      success_rate: Math.round((testResults.passed / (testResults.passed + testResults.failed)) * 100)
    },
    test_details: testResults.tests,
    configuration: TEST_CONFIG
  };

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç –≤ —Ñ–∞–π–ª
  const reportPath = path.join(__dirname, 'e2e_test_report.json');
  fs.writeFileSync(reportPath, JSON.stringify(reportData, null, 2));

  // –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
  console.log('\n' + '='.repeat(60));
  console.log('üéØ UNIFARM E2E TEST REPORT');
  console.log('='.repeat(60));
  console.log(`üìÖ Timestamp: ${reportData.timestamp}`);
  console.log(`üåç Environment: ${reportData.environment}`);
  console.log(`üìä Success Rate: ${reportData.test_summary.success_rate}%`);
  console.log(`‚úÖ Passed: ${reportData.test_summary.passed}`);
  console.log(`‚ùå Failed: ${reportData.test_summary.failed}`);
  console.log(`üìã Total Tests: ${reportData.test_summary.total_tests}`);
  console.log('\nüìù Test Details:');
  
  testResults.tests.forEach(test => {
    const status = test.status === 'PASSED' ? '‚úÖ' : '‚ùå';
    console.log(`${status} ${test.name}`);
    if (test.details) {
      console.log(`   ${JSON.stringify(test.details, null, 2)}`);
    }
    if (test.error) {
      console.log(`   Error: ${test.error}`);
    }
  });

  console.log('\nüìÑ Full report saved to:', reportPath);
  console.log('='.repeat(60));
}

// üöÄ –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
async function runE2ETests() {
  TestLogger.info('üéØ Starting UniFarm E2E Comprehensive Test Suite');
  TestLogger.info('‚ö†Ô∏è Running in SAFE TEST MODE - No production data affected');
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
  try {
    const healthResponse = await makeRequest('/health');
    if (!healthResponse.success) {
      TestLogger.error('Server is not accessible. Please ensure the server is running.');
      return;
    }
    TestLogger.success('Server is accessible and ready for testing');
  } catch (error) {
    TestLogger.error(`Server health check failed: ${error.message}`);
    return;
  }

  // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
  await test('1. User Creation and Authentication', testUserCreation);
  await test('2. Balance Deposit (UNI + TON)', testBalanceDeposit);
  await test('3. UNI Farming Operations', testUniFarming);
  await test('4. TON Boost System', testTonBoost);
  await test('5. Referral System', testReferralSystem);
  await test('6. Daily Bonus System', testDailyBonus);
  await test('7. Missions System', testMissions);
  await test('8. Transaction History', testTransactions);
  await test('9. Final Balance Verification', testFinalBalance);

  // –û—á–∏—Å—Ç–∫–∞ –∏ –æ—Ç—á–µ—Ç
  await cleanupTestData();
  generateReport();
  
  TestLogger.info('üéâ E2E Test Suite completed successfully!');
}

// üé¨ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
if (require.main === module) {
  runE2ETests().catch(error => {
    TestLogger.error(`Critical error: ${error.message}`);
    process.exit(1);
  });
}

module.exports = {
  runE2ETests,
  TEST_CONFIG,
  TestLogger
};