# JWT Token Page Refresh - –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç –∏ –ø–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
## 28 –∏—é–ª—è 2025

## üö® –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ Telegram WebApp –∏–ª–∏ Replit Preview –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞:
```json
{"success":false,"error":"Authentication required","need_jwt_token":true}
```

## ‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ - ROOT CAUSE –Ω–∞–π–¥–µ–Ω

### Backend —Å–∏—Å—Ç–µ–º–∞ JWT - –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û ‚úÖ
- **Endpoint `/api/v2/auth/refresh`** - –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω 
- **AuthController.refreshToken()** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- **AuthService.refreshToken()** - –∏–º–µ–µ—Ç –¥–≤–æ–π–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é
- **Middleware telegramAuth** - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT —Ç–æ–∫–µ–Ω—ã

### üéØ –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: Frontend timing –∏ state management

#### –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê #1: Race condition –≤ UserContext
**–§–∞–π–ª**: `client/src/contexts/userContext.tsx` —Å—Ç—Ä–æ–∫–∏ 258-289
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ page refresh userContext –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∏ —Å—Ä–∞–∑—É –ø—ã—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram initData, –ù–ï –ø—Ä–æ–≤–µ—Ä–∏–≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≤–∞–ª–∏–¥–Ω—ã–π JWT —Ç–æ–∫–µ–Ω –≤ localStorage.

#### –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê #2: correctApiRequest –º–æ–∂–µ—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–∫–µ–Ω
**–§–∞–π–ª**: `client/src/lib/correctApiRequest.ts` —Å—Ç—Ä–æ–∫–∏ 42-60  
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö API –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±–µ–∑ Authorization header.

#### –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê #3: –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
**–§–∞–π–ª**: `client/src/contexts/userContext.tsx` —Å—Ç—Ä–æ–∫–∏ 261-289
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ page refresh —Å–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ –≤–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ JWT —Ç–æ–∫–µ–Ω–∞.

## üîß –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #1: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–æ–∫–µ–Ω–∞
```typescript
// –í userContext.tsx - –≤ –Ω–∞—á–∞–ª–µ refreshUserData()
const existingToken = localStorage.getItem('unifarm_jwt_token');
if (existingToken) {
  console.log('[UserContext] –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–∫–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º...');
  try {
    const response = await correctApiRequest('/api/v2/users/profile');
    if (response.success) {
      console.log('[UserContext] –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é');
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      dispatch({ type: 'SET_USER_DATA', payload: response.data });
      return;
    }
  } catch (error) {
    console.log('[UserContext] –¢–æ–∫–µ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω—É–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
  }
}
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #2: –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–∫–µ–Ω–∞
```typescript  
// –í correctApiRequest.ts - —É—Å–∏–ª–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
let token = localStorage.getItem('unifarm_jwt_token');
if (!token && url.includes('/api/v2/') && !url.includes('/auth/')) {
  console.error('[correctApiRequest] API –∑–∞–ø—Ä–æ—Å –±–µ–∑ —Ç–æ–∫–µ–Ω–∞:', url);
  throw new Error('JWT —Ç–æ–∫–µ–Ω —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö API –∑–∞–ø—Ä–æ—Å–æ–≤');
}
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #3: –ò–∑–±–µ–≥–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
```typescript
// –í userContext.tsx - —É–ª—É—á—à–∏—Ç—å —É—Å–ª–æ–≤–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
if (initData && !existingToken && !authorizationAttemptedRef.current) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å–µ—Å—Å–∏–∏
  const lastSession = localStorage.getItem('unifarm_last_session');
  if (lastSession) {
    console.log('[UserContext] –ù–∞–π–¥–µ–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Å–µ—Å—Å–∏—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
    return;
  }
  // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  authorizationAttemptedRef.current = true;
  // ... –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
}
```

## üìã –ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å
- ‚ùå Backend auth endpoints - —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚ùå JWT —Å–∏—Å—Ç–µ–º–∞ - –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞  
- ‚ùå Middleware –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚ùå tokenRefreshHandler - –ª–æ–≥–∏–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
1. **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #1 - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
2. **–í–´–°–û–ö–ò–ô**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #2 - –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–∫–µ–Ω–∞ –≤ API
3. **–°–†–ï–î–ù–ò–ô**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #3 - –∏–∑–±–µ–≥–∞–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- ‚úÖ Page refresh —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ "Authentication required" 
- ‚úÖ JWT —Ç–æ–∫–µ–Ω—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤–æ –≤—Å–µ API –∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –≤ Telegram WebApp –∏ Replit Preview

## üß™ –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
1. –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
2. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±—Ä–∞—É–∑–µ—Ä–∞  
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
4. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è  
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É Authorization header –≤ DevTools

---
**–°—Ç–∞—Ç—É—Å**: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Ç–æ—á–Ω—ã–µ –º–µ—Å—Ç–∞ –∏ –º–µ—Ç–æ–¥—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –ö–æ–¥ –Ω–µ –∏–∑–º–µ–Ω—è–ª—Å—è —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.