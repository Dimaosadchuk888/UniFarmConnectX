# üîç –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´ CONNECTWALLET
**–î–∞—Ç–∞:** 6 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–¢–∏–ø:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞—É–¥–∏—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞  
**–°—Ç–∞—Ç—É—Å:** –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

## ‚úÖ 1. –ö–ê–ö –°–ï–ô–ß–ê–° –†–ê–ë–û–¢–ê–ï–¢ –§–ò–ö–°–ò–†–û–í–ê–ù–ò–ï –•–≠–®–ê

### –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ —Ç–æ–ª—å–∫–æ @ton/core –±–µ–∑ fallback –Ω–∞ SHA256?

**–ù–ï–¢, SHA256 fallback –û–°–¢–ê–ï–¢–°–Ø –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤:**
- **–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥:** @ton/core Cell.hash() - —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ 100% —Å–ª—É—á–∞–µ–≤
- **Fallback –∞–∫—Ç–∏–≤–µ–Ω:** –î–ê, –Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º —Å–±–æ–µ @ton/core
- **–†–∏—Å–∫:** –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ñ–µ–π–∫–æ–≤—ã–π —Ö—ç—à –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º —Å–±–æ–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

```typescript
// core/tonApiClient.ts —Å—Ç—Ä–æ–∫–∏ 272-280
catch (error) {
  // Fallback to SHA256 —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ @ton/core –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
  logger.warn('[TonAPI] Attempting SHA256 fallback for hash extraction');
  const fallbackHash = crypto.createHash('sha256').update(bocData).digest('hex');
  logger.warn('[TonAPI] Using SHA256 fallback hash (not blockchain hash!)');
  return fallbackHash;
}
```

### –ì–¥–µ —Ö—ç—à –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –±–∞–∑–µ?

**–¢–∞–±–ª–∏—Ü–∞:** `transactions`  
**–ü–æ–ª–µ:** `tx_hash_unique` (VARCHAR —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–Ω–¥–µ–∫—Å–æ–º)  
**–ö–æ–Ω—Ç—Ä–æ–ª—å —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏:**
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –≤ UnifiedTransactionService
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–æ–≤ –≤ —Ç–µ—á–µ–Ω–∏–µ 10 –º–∏–Ω—É—Ç

### –ú–æ–∂–µ—Ç –ª–∏ —Ö—ç—à –Ω–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è?

**–ù–ï–¢, —Å–∏—Å—Ç–µ–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è:**
- –ï—Å–ª–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ö—ç—à–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–æ—Å—å ‚Üí –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ ‚Üí —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è
- –ï—Å–ª–∏ —Ö—ç—à –∏–∑–≤–ª–µ—á–µ–Ω ‚Üí –∑–∞–ø–∏—Å—å –≤ –ë–î –∞—Ç–æ–º–∞—Ä–Ω–∞—è ‚Üí –ª–∏–±–æ –≤—Å—ë –∑–∞–ø–∏—Å–∞–Ω–æ, –ª–∏–±–æ –Ω–∏—á–µ–≥–æ

---

## ‚úÖ 2. –ö–ê–ö –°–ò–°–¢–ï–ú–ê –†–ï–ê–ì–ò–†–£–ï–¢ –ù–ê –£–°–ü–ï–®–ù–´–ô –î–ï–ü–û–ó–ò–¢

### –ö–∞–∫–æ–π —Å–µ—Ä–≤–∏—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞ –±–∞–ª–∞–Ω—Å?

**BalanceManager** —á–µ—Ä–µ–∑ —Ü–µ–ø–æ—á–∫—É:
1. UnifiedTransactionService —Å–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
2. –í—ã–∑—ã–≤–∞–µ—Ç BalanceManager.addBalance()
3. BalanceManager –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—è balance_uni/balance_ton –≤ —Ç–∞–±–ª–∏—Ü–µ users

### –ì–¥–µ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è —Å–≤—è–∑–∫–∞ "hash ‚Üí –±–∞–ª–∞–Ω—Å ‚Üí —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è"?

**–í –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î:**
```
1. INSERT –≤ transactions (—Å tx_hash_unique)
2. UPDATE users SET balance_ton = balance_ton + amount
3. WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

### –ï—Å—Ç—å –ª–∏ —Å–ª—É—á–∞–∏ –≥–¥–µ —Ö—ç—à –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω, –Ω–æ –±–∞–ª–∞–Ω—Å –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω?

**–¢–ï–û–†–ï–¢–ò–ß–ï–°–ö–ò –î–ê, –Ω–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ CRITICAL:**
- UnifiedTransactionService –ù–ï –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø—Ä–∏ —Å–±–æ–µ –±–∞–ª–∞–Ω—Å–∞
- –ù–æ —Å–æ–∑–¥–∞–µ—Ç –ª–æ–≥ `[CRITICAL] [BALANCE_UPDATE_FAILED]`
- –ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ: 0 —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞–µ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞

---

## ‚úÖ 3. –ö–û–ù–§–õ–ò–ö–¢–´ –ò –°–¢–ê–†–´–ô –ö–û–î

### –û—Å—Ç–∞—Ç–æ—á–Ω—ã–µ –±–ª–æ–∫–∏ –∫–æ–¥–∞ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏

**–ù–ê–ô–î–ï–ù–´ 2 –º–µ—Å—Ç–∞ —Å SHA256:**

1. **core/tonApiClient.ts** - SHA256 –∫–∞–∫ fallback (—Å—Ç—Ä–æ–∫–∏ 272-280)
2. **utils/tonDepositFallback.ts** - SHA256 –∫–∞–∫ –≤—Ç–æ—Ä–æ–π fallback (—Å—Ç—Ä–æ–∫–∏ 83-89)

### –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ SHA256 fallback?

**–î–ê, –∞–∫—Ç–∏–≤–µ–Ω –≤ –æ–±–æ–∏—Ö –º–µ—Å—Ç–∞—Ö:**
- –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º —Å–±–æ–µ @ton/core
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å WARNING: "Using SHA256 fallback (not blockchain hash!)"

### –ú–æ–∂–µ—Ç –ª–∏ –≤–º–µ—à–∞—Ç—å—Å—è –∏ —Å–æ–∑–¥–∞—Ç—å —Ñ–µ–π–∫–æ–≤—ã–π —Ö—ç—à?

**–î–ê, –º–æ–∂–µ—Ç –ø—Ä–∏ —É—Å–ª–æ–≤–∏—è—Ö:**
1. @ton/core –≤—ã–±—Ä–æ—Å–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (—Å–±–æ–π –ø–∞—Ä—Å–∏–Ω–≥–∞ BOC)
2. SHA256 —Å–æ–∑–¥–∞—Å—Ç —Ñ–µ–π–∫–æ–≤—ã–π —Ö—ç—à
3. –≠—Ç–æ—Ç —Ö—ç—à –ø–æ–ø–∞–¥–µ—Ç –≤ –ë–î
4. –î–µ–ø–æ–∑–∏—Ç –ù–ï –±—É–¥–µ—Ç –Ω–∞–π–¥–µ–Ω –≤ –±–ª–æ–∫—á–µ–π–Ω–µ

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è, –Ω–æ –Ω–µ –Ω—É–ª–µ–≤–∞—è

---

## ‚úÖ 4. –ü–û–õ–ù–û–¶–ï–ù–ù–û–°–¢–¨ –¶–ï–ü–û–ß–ö–ò

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å —Ü–µ–ø–æ—á–∫–∏ TON ‚Üí BOC ‚Üí Hash ‚Üí DB ‚Üí –ë–∞–ª–∞–Ω—Å ‚Üí UI

**–û—Ü–µ–Ω–∫–∞: 95% –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏**

‚úÖ **–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ:**
- BOC ‚Üí Hash (—á–µ—Ä–µ–∑ @ton/core) - 100% –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ö—ç—à–µ–π
- Hash ‚Üí DB - –∞—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å —Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π
- DB ‚Üí –ë–∞–ª–∞–Ω—Å - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- –ë–∞–ª–∞–Ω—Å ‚Üí UI - WebSocket + React Query –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

‚ö†Ô∏è **–¢–æ—á–∫–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–±–æ—è:**
1. SHA256 fallback –ø—Ä–∏ —Å–±–æ–µ @ton/core
2. –°–±–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞, –±–∞–ª–∞–Ω—Å –Ω–µ—Ç)
3. –ù–µ—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –±–ª–æ–∫—á–µ–π–Ω–µ

### –¢–µ—Ä—è—é—Ç—Å—è –ª–∏ –¥–µ–ø–æ–∑–∏—Ç—ã?

**–ù–ï–¢, –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞:**
1. LocalStorage backup (pending_ton_deposit, failed_ton_deposit)
2. DepositRecoveryService - –ø–æ–≤—Ç–æ—Ä –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
3. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
4. –†—É—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ª–æ–≥–∏

**–ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏ –∑–∞—â–∏—â–µ–Ω—ã:**
- –ú–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ - retry –º–µ—Ö–∞–Ω–∏–∑–º
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∫–ª–∏–∫–∏ - processedTxHashes Set + –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
- –°–±–æ–π —Å–µ—Ç–∏ - LocalStorage + –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

---

## ‚úÖ 5. –§–ò–ù–ê–õ–¨–ù–´–ô –í–ï–†–î–ò–ö–¢

### –í—Å—ë –ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —É—Å—Ç–æ–π—á–∏–≤–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ?

**–î–ê, —Å –æ–≥–æ–≤–æ—Ä–∫–∞–º–∏:**
- ‚úÖ 100% —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ (66 –¥–µ–ø–æ–∑–∏—Ç–æ–≤)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ blockchain —Ö—ç—à–µ–π
- ‚úÖ –ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- ‚ö†Ô∏è SHA256 fallback –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º
- ‚ö†Ô∏è –ù–µ—Ç blockchain –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –ß—Ç–æ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ?

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ SHA256 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
   - Grep –ª–æ–≥–æ–≤ –Ω–∞ "SHA256 fallback"
   - Alert –ø—Ä–∏ –ª—é–±–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ fallback

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –±–∞–ª–∞–Ω—Å–æ–≤:**
   ```sql
   SELECT user_id, 
          SUM(amount_ton) as sum_deposits,
          MAX(u.balance_ton) as current_balance
   FROM transactions t
   JOIN users u ON u.id = t.user_id
   WHERE t.type = 'TON_DEPOSIT'
   GROUP BY user_id
   HAVING SUM(amount_ton) != MAX(u.balance_ton)
   ```

3. **–ê—É–¥–∏—Ç —Å—Ç–∞—Ä—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å SHA256:**
   - –ù–∞–π—Ç–∏ –≤—Å–µ tx_hash_unique –¥–ª–∏–Ω–æ–π 64 —Å–∏–º–≤–æ–ª–∞
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Ö —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤ –±–ª–æ–∫—á–µ–π–Ω–µ

---

## üìä –ò–¢–û–ì–û–í–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –°–∏—Å—Ç–µ–º–∞ –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û —Å —É—Ä–æ–≤–Ω–µ–º –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ 95%

**–ß—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ:**
- ‚úÖ –ù–æ–≤—ã–µ –¥–µ–ø–æ–∑–∏—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ blockchain —Ö—ç—à–∏
- ‚úÖ –ù–∏ –æ–¥–∏–Ω –¥–µ–ø–æ–∑–∏—Ç –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è
- ‚úÖ –ë–∞–ª–∞–Ω—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ –≤—Å—Ç—Ä–æ–µ–Ω—ã

**–û—Å—Ç–∞—Ç–æ—á–Ω—ã–µ —Ä–∏—Å–∫–∏ (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ):**
- ‚ö†Ô∏è SHA256 fallback –º–æ–∂–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ —Å–±–æ–µ
- ‚ö†Ô∏è –°—Ç–∞—Ä—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–æ–≥—É—Ç –∏–º–µ—Ç—å —Ñ–µ–π–∫–æ–≤—ã–µ —Ö—ç—à–∏
- ‚ö†Ô∏è –ù–µ—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –±–ª–æ–∫—á–µ–π–Ω–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º SHA256 fallback –∞–∫—Ç–∏–≤–∞—Ü–∏–π.