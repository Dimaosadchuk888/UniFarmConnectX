# Аудит Telegram бота UniFarm

## Общая информация

**Имя бота:** UniFarm
**Username:** @UniFarming_Bot
**Дата аудита:** 27 апреля 2025 года
**Версия API Telegram:** 6.0

## Функциональные возможности

- [x] Регистрация пользователей через Telegram Mini App
- [x] Поддержка идентификации по guest_id
- [x] Поддержка идентификации без Telegram API (режим AirDrop)
- [x] Многоуровневая реферальная система (до 20 уровней)
- [x] Интеграция с TON Keeper
- [x] Валидация Telegram Web App initData

## Безопасность

### Проверка подписи initData

Telegram отправляет данные с безопасной подписью HMAC-SHA-256. Эта подпись проверяется в каждом запросе через:

```javascript
const isValid = validateTelegramInitData(initDataString, botToken, options);
```

### Приоритеты идентификации пользователя

Согласно техническому заданию, в приложении используется следующий порядок приоритета идентификации:

1. Сессия
2. guest_id (уникальный идентификатор, хранящийся в localStorage)
3. telegram_id (используется только при наличии валидной подписи initData)

### Отказоустойчивость

Система спроектирована для работы даже при недоступности Telegram API:
- Валидный guest_id позволяет восстановить сессию
- Создание новых пользователей возможно без Telegram данных
- Реферальные коды работают и без Telegram авторизации

## Аудит маршрутов API

| Маршрут | Метод | Описание | Безопасность |
|---------|-------|----------|-------------|
| `/api/auth/telegram` | POST | Аутентификация через Telegram | Проверка initData |
| `/api/session/restore` | POST | Восстановление сессии по guest_id | Валидация guest_id |
| `/api/airdrop/register` | POST | Регистрация пользователя без Telegram | Генерация уникального ref_code |
| `/api/log-launch` | POST | Логирование запусков Mini App | Базовая фильтрация ботов |
| `/api/telegram-debug` | GET | Диагностический эндпоинт | Только информация без персональных данных |

## Проблемы и их решения

### Проблема черного экрана в Telegram

**Причина:** Несовпадение режимов работы (production/development)

**Решение:**
- Настройка корректного определения среды (`NODE_ENV=production`)
- Улучшение отображения ошибок в компоненте `TelegramWebAppCheck`
- Добавление подробного логирования состояния инициализации Telegram WebApp

### Неработающий Webhook

**Причина:** Неправильные URL или отсутствие SSL

**Решение:**
- Создан скрипт для настройки webhook (`setup-telegram-webhook.js`)
- Добавлена проверка валидности URL
- Обеспечено автоматическое использование HTTPS через Replit

## Рекомендации по развертыванию

1. Используйте скрипт `deploy-production.sh` для полной подготовки и деплоя
2. Запускайте приложение всегда в режиме production (`start-production.sh`)
3. Убедитесь, что токен бота (`TELEGRAM_BOT_TOKEN`) доступен как переменная окружения
4. При разработке используйте маршрут `/api/telegram-debug` для диагностики

## Заключение

Бот @UniFarming_Bot и связанное с ним приложение UniFarm соответствуют требованиям безопасности и функциональности Telegram. Рекомендуется регулярная проверка логов и мониторинг использования для обеспечения постоянной стабильности работы.