# üîç –ü–û–õ–ù–û–ï –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –û–ü–ò–°–ê–ù–ò–ï –¶–ï–ü–û–ß–ö–ò –ü–†–ò–Å–ú–ê TON –í UNIFARM

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 21 —è–Ω–≤–∞—Ä—è 2025  
**–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã:** 2.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞

---

## üìä –û–ë–ó–û–† –ê–†–•–ò–¢–ï–ö–¢–£–†–´

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ
‚îÇ   Frontend      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  TON Connect    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ    Backend      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ    Database     ‚îÇ
‚îÇ (TonDepositCard)‚îÇ     ‚îÇ  (Blockchain)   ‚îÇ     ‚îÇ   (API/Service) ‚îÇ     ‚îÇ   (Supabase)    ‚îÇ
‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ     ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üß© 1. FRONTEND - –ò–ù–ò–¶–ò–ê–¶–ò–Ø –î–ï–ü–û–ó–ò–¢–ê

### 1.1 –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `client/src/components/wallet/TonDepositCard.tsx`  
**–≠–∫—Ä–∞–Ω:** –†–∞–∑–¥–µ–ª "–ö–æ—à–µ–ª–µ–∫" ‚Üí –ö–∞—Ä—Ç–æ—á–∫–∞ "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ TON Wallet"

### 1.2 –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞

```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
useEffect(() => {
  if (tonConnectUI) {
    const connected = isTonWalletConnected(tonConnectUI);
    setIsConnected(connected);
    
    if (connected && tonConnectUI.account?.address) {
      const getUserFriendlyAddress = async () => {
        const userFriendlyAddress = await getTonWalletAddress(tonConnectUI);
        if (userFriendlyAddress) {
          setWalletAddress(userFriendlyAddress);
          await saveTonWalletAddress(userFriendlyAddress); // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
        }
      };
      getUserFriendlyAddress();
    }
  }
}, [tonConnectUI]);
```

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ö—É–∫–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `useTonConnectUI()` - React hook –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ TonConnect UI
- `isTonWalletConnected()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- `getTonWalletAddress()` - –ø–æ–ª—É—á–µ–Ω–∏–µ user-friendly –∞–¥—Ä–µ—Å–∞
- `saveTonWalletAddress()` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –≤ –ë–î —á–µ—Ä–µ–∑ API

### 1.3 –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ–ø–æ–∑–∏—Ç–∞ (—Å—Ç—Ä–æ–∫–∏ 95-156):**

```typescript
const handleDeposit = async () => {
  const depositAmount = parseFloat(amount);
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  if (!depositAmount || depositAmount <= 0) {
    showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
    return;
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ TON Connect
  const result = await sendTonTransaction(
    tonConnectUI,
    depositAmount.toString(),
    'UniFarm Deposit'
  );

  if (result && result.status === 'success' && result.txHash) {
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ backend –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    const response = await fetch('/api/v2/wallet/ton-deposit', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('unifarm_jwt_token')}`
      },
      body: JSON.stringify({
        user_id: userId,
        ton_tx_hash: result.txHash,
        amount: depositAmount,
        wallet_address: walletAddress
      })
    });
  }
};
```

### 1.4 –ü–∞—Ä–∞–º–µ—Ç—Ä—ã, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ |
|----------|-----|----------|----------|
| `user_id` | number | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ | –ò–∑ UserContext |
| `ton_tx_hash` | string | –•–µ—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –±–ª–æ–∫—á–µ–π–Ω–µ | result.boc –∏–∑ TonConnect |
| `amount` | number | –°—É–º–º–∞ –≤ TON | –í–≤–µ–¥–µ–Ω–Ω–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º |
| `wallet_address` | string | –ê–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è | –ò–∑ TonConnect UI |

---

## üîó 2. TON CONNECT - –ë–õ–û–ö–ß–ï–ô–ù –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø

### 2.1 –°–µ—Ä–≤–∏—Å TON Connect
**–§–∞–π–ª:** `client/src/services/tonConnectService.ts`

### 2.2 –ü—Ä–æ—Ü–µ—Å—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

```typescript
export async function sendTonTransaction(
  tonConnectUI: TonConnectUI,
  tonAmount: string,
  comment: string = ''
): Promise<{ txHash: string; status: string } | null> {
  // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –Ω–∞–Ω–æTON
  const nanoTonAmount = parseFloat(tonAmount) * 1000000000;
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏–∑ ENV
  const receiverAddress = import.meta.env.VITE_TON_BOOST_RECEIVER_ADDRESS || 
    'UQBlrUfJMIlAcyYzttyxV2xrrvaHHIKEKeetGZbDoitTRWT8';
  
  // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ payload —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º
  const payload = createTONPayload(comment);
  
  // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  const transaction = {
    validUntil: Math.floor(Date.now() / 1000) + 600, // 10 –º–∏–Ω—É—Ç
    messages: [{
      address: receiverAddress,
      amount: nanoTonAmount.toString(),
      payload: payload,
      bounce: false
    }]
  };
  
  // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ TonConnect UI
  const result = await tonConnectUI.sendTransaction(transaction);
  
  return {
    txHash: result.boc,
    status: 'success'
  };
}
```

### 2.3 –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∫–æ—à–µ–ª—å–∫–∏
- Tonkeeper
- OpenMask
- TonHub
- –ò –¥—Ä—É–≥–∏–µ –∫–æ—à–µ–ª—å–∫–∏, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª TON Connect

---

## üñ•Ô∏è 3. BACKEND - –û–ë–†–ê–ë–û–¢–ö–ê –î–ï–ü–û–ó–ò–¢–ê

### 3.1 –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
**–§–∞–π–ª:** `modules/wallet/routes.ts`

```typescript
// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ (—Å—Ç—Ä–æ–∫–∞ 82)
router.post('/ton-deposit', 
  requireTelegramAuth,    // –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞
  liberalRateLimit,       // Rate limiting
  validateBody(tonDepositSchema), // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
  walletController.tonDeposit.bind(walletController)
);

// –°—Ö–µ–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
const tonDepositSchema = z.object({
  ton_tx_hash: z.string().min(1, 'Transaction hash is required'),
  amount: z.number().positive('Amount must be positive'),  
  wallet_address: z.string().min(1, 'Wallet address is required')
});
```

### 3.2 –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
**–§–∞–π–ª:** `modules/wallet/controller.ts` (–º–µ—Ç–æ–¥ `tonDeposit`)

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: Wallet-Based Deposit Resolution

```typescript
async tonDeposit(req: Request, res: Response, next: NextFunction) {
  const telegram = this.validateTelegramAuth(req, res);
  const { ton_tx_hash, amount, wallet_address } = req.body;

  // 1. –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ JWT (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π flow)
  let user = await userRepository.getUserByTelegramId(telegram.user.id);
  
  // 2. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω - –ø–æ–∏—Å–∫ –ø–æ –∫–æ—à–µ–ª—å–∫—É
  if (!user) {
    const { data: existingUser } = await supabase
      .from('users')
      .select('*')
      .eq('ton_wallet_address', wallet_address)
      .single();
    
    if (existingUser) {
      user = existingUser;
    }
  }
  
  // 3. –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if (!user) {
    user = await userRepository.getOrCreateUserFromTelegram({
      telegram_id: telegram.user.id,
      username: telegram.user.username,
      first_name: telegram.user.first_name
    });
    
    // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–∞
    await supabase
      .from('users')
      .update({
        ton_wallet_address: wallet_address,
        ton_wallet_verified: true,
        ton_wallet_linked_at: new Date().toISOString()
      })
      .eq('id', user.id);
  }
  
  // –í—ã–∑–æ–≤ —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
  const result = await walletService.processTonDeposit({
    user_id: user.id,
    ton_tx_hash,
    amount,
    wallet_address
  });
}
```

### 3.3 –°–µ—Ä–≤–∏—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏
**–§–∞–π–ª:** `modules/wallet/service.ts` (–º–µ—Ç–æ–¥ `processTonDeposit`)

```typescript
async processTonDeposit(params: {
  user_id: number;
  ton_tx_hash: string;
  amount: number;
  wallet_address: string;
}): Promise<{ success: boolean; transaction_id?: string; error?: string }> {
  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
  const existingTransaction = await supabase
    .from('transactions')
    .select('*')
    .eq('metadata->tx_hash', ton_tx_hash)
    .eq('type', 'DEPOSIT')
    .single();

  if (existingTransaction.data) {
    return {
      success: false,
      error: '–≠—Ç–æ—Ç –¥–µ–ø–æ–∑–∏—Ç —É–∂–µ –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω'
    };
  }

  // 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
  const { data: user } = await supabase
    .from('users')
    .select('balance_ton')
    .eq('id', user_id)
    .single();

  // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
  const newBalance = parseFloat(user.balance_ton || '0') + amount;
  
  await supabase
    .from('users')
    .update({ balance_ton: newBalance })
    .eq('id', user_id);

  // 4. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  const { data: transaction } = await supabase
    .from('transactions')
    .insert({
      user_id,
      amount_ton: amount,
      amount_uni: 0,
      type: 'DEPOSIT',
      currency: 'TON',
      status: 'completed',
      description: `TON deposit from blockchain: ${ton_tx_hash}`,
      metadata: {
        source: 'ton_deposit',
        original_type: 'TON_DEPOSIT',
        wallet_address,
        tx_hash: ton_tx_hash
      }
    })
    .select()
    .single();

  return {
    success: true,
    transaction_id: transaction?.id?.toString()
  };
}
```

---

## üíæ 4. DATABASE - –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–•

### 4.1 –¢–∞–±–ª–∏—Ü–∞ `users`

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | serial | Primary key |
| `telegram_id` | bigint | Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `balance_ton` | numeric(18,6) | –ë–∞–ª–∞–Ω—Å –≤ TON |
| `ton_wallet_address` | text | –ê–¥—Ä–µ—Å TON –∫–æ—à–µ–ª—å–∫–∞ |
| `ton_wallet_verified` | boolean | –§–ª–∞–≥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–æ—à–µ–ª—å–∫–∞ |
| `ton_wallet_linked_at` | timestamp | –í—Ä–µ–º—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫–æ—à–µ–ª—å–∫–∞ |

### 4.2 –¢–∞–±–ª–∏—Ü–∞ `transactions` (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç)

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | serial | Primary key |
| `user_id` | integer | FK to users |
| `amount_ton` | numeric(18,6) | –°—É–º–º–∞ –≤ TON |
| `amount_uni` | numeric(18,6) | –°—É–º–º–∞ –≤ UNI |
| `type` | text | –¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ('DEPOSIT') |
| `currency` | text | –í–∞–ª—é—Ç–∞ ('TON') |
| `status` | text | –°—Ç–∞—Ç—É—Å ('completed') |
| `description` | text | –û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ |
| `metadata` | jsonb | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |
| `created_at` | timestamp | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è |

### 4.3 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ metadata –¥–ª—è TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤

```json
{
  "source": "ton_deposit",
  "original_type": "TON_DEPOSIT",
  "wallet_address": "UQxx...xxx",
  "tx_hash": "hash_from_blockchain"
}
```

---

## üîç 5. –ú–ï–•–ê–ù–ò–ó–ú–´ –ó–ê–©–ò–¢–´ –ò –í–ê–õ–ò–î–ê–¶–ò–ò

### 5.1 –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ö–µ—à—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ metadata
SELECT * FROM transactions 
WHERE metadata->>'tx_hash' = 'incoming_hash' 
AND type = 'DEPOSIT'
```

### 5.2 –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

1. **JWT —Ç–æ–∫–µ–Ω** ‚Üí telegram_id ‚Üí –ø–æ–∏—Å–∫ –≤ –ë–î
2. **–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞** ‚Üí ton_wallet_address ‚Üí –ø–æ–∏—Å–∫ –≤ –ë–î  
3. **–ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ** ‚Üí –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å + –ø—Ä–∏–≤—è–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–∞

### 5.3 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞

- **–ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ** - —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è callback –æ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
- **–ê—Ç–æ–º–∞—Ä–Ω–æ–µ** - –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î
- **–° –æ—Ç–∫–∞—Ç–æ–º** - –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

---

## üìà 6. FLOW DIAGRAM

```mermaid
sequenceDiagram
    participant U as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant F as Frontend
    participant TC as TON Connect
    participant B as Backend API
    participant DB as Database

    U->>F: –ù–∞–∂–∏–º–∞–µ—Ç "–ü–æ–ø–æ–ª–Ω–∏—Ç—å"
    F->>F: –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã
    F->>TC: sendTransaction()
    TC->>U: –û—Ç–∫—Ä—ã–≤–∞–µ—Ç Tonkeeper
    U->>TC: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    TC-->>F: result.boc (tx hash)
    F->>B: POST /api/v2/wallet/ton-deposit
    B->>B: –í–∞–ª–∏–¥–∞—Ü–∏—è JWT
    B->>DB: –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    B->>DB: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞
    B->>DB: UPDATE balance_ton
    B->>DB: INSERT transaction
    B-->>F: {success: true}
    F->>U: "–î–µ–ø–æ–∑–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω"
    F->>F: refreshBalance()
```

---

## ‚ö° 7. –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨ –ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø

### 7.1 –ò–Ω–¥–µ–∫—Å—ã –≤ –ë–î

```sql
-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX idx_users_ton_wallet_address ON users(ton_wallet_address);
CREATE INDEX idx_transactions_metadata_tx_hash ON transactions((metadata->>'tx_hash'));
CREATE INDEX idx_transactions_user_id ON transactions(user_id);
```

### 7.2 Rate Limiting

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `liberalRateLimit` –¥–ª—è endpoint'–∞
- –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

### 7.3 –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ

- –ë–∞–ª–∞–Ω—Å –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `refreshBalance(true)`

---

## üö® 8. –í–û–ó–ú–û–ñ–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–®–ï–ù–ò–Ø

### 8.1 –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—Ä–æ—à–ª–∞, –Ω–æ –±–∞–ª–∞–Ω—Å –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è

**–ü—Ä–∏—á–∏–Ω—ã:**
1. JWT —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ telegram_id
3. –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –º–µ–∂–¥—É frontend –∏ backend

**–†–µ—à–µ–Ω–∏–µ:** –°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç wallet-based resolution - –Ω–∞–π–¥–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∞–¥—Ä–µ—Å—É –∫–æ—à–µ–ª—å–∫–∞

### 8.2 –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–æ–≤

**–ó–∞—â–∏—Ç–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ `metadata->>'tx_hash'`

### 8.3 –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ userId

**–†–µ—à–µ–Ω–∏–µ:** –¢—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## ‚úÖ 9. –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´

–ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç 21 —è–Ω–≤–∞—Ä—è 2025:

- ‚úÖ **Frontend** - –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å backend
- ‚úÖ **Backend** - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–µ–ø–æ–∑–∏—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ **Database** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å metadata
- ‚úÖ **–ó–∞—â–∏—Ç–∞** - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ **–ë–∞–ª–∞–Ω—Å** - –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ

---

## üìù 10. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ

1. **–î–æ–±–∞–≤–∏—Ç—å webhook –æ—Ç –±–ª–æ–∫—á–µ–π–Ω–∞** - –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º** - –ø—Ä–∏ —Å–±–æ—è—Ö —Å–µ—Ç–∏
3. **–î–æ–±–∞–≤–∏—Ç—å –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** - push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞—á–∏—Å–ª–µ–Ω–∏–∏
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–∞
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –¥–µ–ø–æ–∑–∏—Ç–æ–≤

---

**–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:** 21 —è–Ω–≤–∞—Ä—è 2025  
**–ê–≤—Ç–æ—Ä:** UniFarm Development Team