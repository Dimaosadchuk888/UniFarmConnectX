<!DOCTYPE html>
<html>
<head>
    <title>Final JWT Test - UniFarm Token Backup System</title>
    <style>
        body { font-family: monospace; max-width: 800px; margin: 20px auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 10px 0; }
        button:hover { background: #0056b3; }
        .success { color: green; background: #f0f8f0; padding: 10px; border-radius: 4px; }
        .error { color: red; background: #fdf2f2; padding: 10px; border-radius: 4px; }
        .info { color: blue; background: #f0f4ff; padding: 10px; border-radius: 4px; }
        textarea { width: 100%; height: 100px; font-family: monospace; }
        .log { background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px; margin: 10px 0; max-height: 200px; overflow-y: auto; }
        .step { margin: 15px 0; padding: 15px; border: 2px solid #ddd; border-radius: 8px; }
        .step-title { font-weight: bold; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Final JWT Test - Token Backup System</h1>
        <p><strong>–¶–µ–ª—å:</strong> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å–∏—Å—Ç–µ–º—ã backup/restore JWT —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</p>

        <div class="step">
            <div class="step-title">Step 1: Set Test JWT Token</div>
            <textarea id="tokenInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ JWT —Ç–æ–∫–µ–Ω...">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjE4NCwidGVsZWdyYW1faWQiOjk5OTQ4OSwidXNlcm5hbWUiOiJ0ZXN0X3VzZXJfMTc1MjEyOTg0MDkwNSIsInJlZl9jb2RlIjoiUkVGXzE3NTI3NTU4MzUzNThfeWpydXN2IiwiaWF0IjoxNzUzMTgzNjMwLCJleHAiOjE3NTM3ODg0MzB9.BXd9tYdUTb8sO5bxsb372iamJRomJBBfNSm_-dgKngc</textarea>
            <button onclick="setToken()">Set Token in LocalStorage</button>
            <div id="tokenStatus"></div>
        </div>

        <div class="step">
            <div class="step-title">Step 2: Simulate ForceRefresh Button (with VITE_JWT_BACKUP_ENABLED=true)</div>
            <button onclick="simulateForceRefresh()">Simulate Force Refresh with Backup</button>
            <div id="backupStatus"></div>
        </div>

        <div class="step">
            <div class="step-title">Step 3: Test JWT Restore on Page Load</div>
            <button onclick="testJWTRestore()">Test JWT Restore from SessionStorage</button>
            <div id="restoreStatus"></div>
        </div>

        <div class="step">
            <div class="step-title">Step 4: Test JWT Refresh Endpoint</div>
            <button onclick="testJWTRefresh()">Test JWT Refresh API</button>
            <div id="refreshStatus"></div>
        </div>

        <div class="log">
            <strong>üìã Test Log:</strong>
            <div id="testLog"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        }

        function setToken() {
            const token = document.getElementById('tokenInput').value.trim();
            if (!token) {
                document.getElementById('tokenStatus').innerHTML = '<div class="error">–¢–æ–∫–µ–Ω –Ω–µ –≤–≤–µ–¥–µ–Ω</div>';
                return;
            }
            
            localStorage.setItem('userToken', token);
            document.getElementById('tokenStatus').innerHTML = '<div class="success">‚úÖ –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage</div>';
            log('JWT —Ç–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ localStorage', 'success');
        }

        function simulateForceRefresh() {
            const token = localStorage.getItem('userToken');
            if (!token) {
                document.getElementById('backupStatus').innerHTML = '<div class="error">–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage</div>';
                return;
            }

            // –°–∏–º—É–ª—è—Ü–∏—è VITE_JWT_BACKUP_ENABLED=true logic
            log('–°–∏–º—É–ª—è—Ü–∏—è: VITE_JWT_BACKUP_ENABLED=true', 'info');
            log('ForceRefreshButton: –°–æ–∑–¥–∞–Ω–∏–µ backup —Ç–æ–∫–µ–Ω–∞ –≤ sessionStorage', 'info');
            
            sessionStorage.setItem('jwt_backup_token', token);
            sessionStorage.setItem('jwt_backup_timestamp', Date.now().toString());
            
            // –°–∏–º—É–ª—è—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ localStorage (–∫–∞–∫ –¥–µ–ª–∞–µ—Ç ForceRefresh)
            localStorage.removeItem('userToken');
            
            document.getElementById('backupStatus').innerHTML = '<div class="success">‚úÖ JWT backup —Å–æ–∑–¥–∞–Ω, localStorage –æ—á–∏—â–µ–Ω</div>';
            log('JWT backup —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ sessionStorage, localStorage –æ—á–∏—â–µ–Ω', 'success');
        }

        function testJWTRestore() {
            const backupToken = sessionStorage.getItem('jwt_backup_token');
            const backupTimestamp = sessionStorage.getItem('jwt_backup_timestamp');
            
            if (!backupToken) {
                document.getElementById('restoreStatus').innerHTML = '<div class="error">Backup —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                log('JWT restore: backup —Ç–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', 'error');
                return;
            }

            // –°–∏–º—É–ª—è—Ü–∏—è restore logic –∏–∑ UserContext
            log('UserContext: –û–±–Ω–∞—Ä—É–∂–µ–Ω JWT backup –≤ sessionStorage', 'info');
            log(`Backup timestamp: ${new Date(parseInt(backupTimestamp)).toLocaleString()}`, 'info');
            
            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ localStorage
            localStorage.setItem('userToken', backupToken);
            
            // –û—á–∏—Å—Ç–∫–∞ backup
            sessionStorage.removeItem('jwt_backup_token');
            sessionStorage.removeItem('jwt_backup_timestamp');
            
            document.getElementById('restoreStatus').innerHTML = '<div class="success">‚úÖ JWT —Ç–æ–∫–µ–Ω –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ backup</div>';
            log('JWT —Ç–æ–∫–µ–Ω –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ localStorage –∏–∑ backup', 'success');
        }

        async function testJWTRefresh() {
            const token = localStorage.getItem('userToken');
            if (!token) {
                document.getElementById('refreshStatus').innerHTML = '<div class="error">–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è refresh</div>';
                return;
            }

            log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ JWT refresh endpoint...', 'info');
            
            try {
                const response = await fetch('/api/v2/auth/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ token })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    localStorage.setItem('userToken', result.data.token);
                    document.getElementById('refreshStatus').innerHTML = '<div class="success">‚úÖ JWT refresh —É—Å–ø–µ—à–µ–Ω, –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω</div>';
                    log(`JWT refresh —É—Å–ø–µ—à–µ–Ω. User: ${result.data.user.username} (${result.data.user.telegram_id})`, 'success');
                } else {
                    document.getElementById('refreshStatus').innerHTML = `<div class="error">‚ùå JWT refresh failed: ${result.error || 'Unknown error'}</div>`;
                    log(`JWT refresh failed: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                document.getElementById('refreshStatus').innerHTML = `<div class="error">‚ùå Network error: ${error.message}</div>`;
                log(`Network error: ${error.message}`, 'error');
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            log('üß™ Final JWT Test - –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é', 'info');
            log('Feature Flag: VITE_JWT_BACKUP_ENABLED –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ true', 'info');
            log('Backend: JWT refresh endpoint —Å fallback validation –∞–∫—Ç–∏–≤–µ–Ω', 'info');
        }
    </script>
</body>
</html>
