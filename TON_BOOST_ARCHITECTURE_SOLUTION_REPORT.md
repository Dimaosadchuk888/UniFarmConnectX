# TON BOOST ARCHITECTURE SOLUTION - –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –û–¢–ß–ï–¢

**–î–∞—Ç–∞:** 13 —è–Ω–≤–∞—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–®–ï–ù–ò–ï –ù–ê–ô–î–ï–ù–û - –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ö–û–î–ê

## üìã 1. –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –†–ï–®–ï–ù–ò–Ø –ü–†–û–ë–õ–ï–ú–´ TON BOOST

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:
–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ `tonBoostIncomeScheduler.ts` –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–µ `user.balance_ton` –∏–∑ –æ–±—ä–µ–∫—Ç–æ–≤ `TonFarmingData`, –Ω–æ —ç—Ç–æ –ø–æ–ª–µ —Ç–∞–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.

### –ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:

**–í–∞—Ä–∏–∞–Ω—Ç 1 (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ - 5 —Å—Ç—Ä–æ–∫):**
```typescript
// –í tonBoostIncomeScheduler.ts –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 59
const activeBoostUsers = await tonFarmingRepo.getActiveBoostUsers();

// –î–û–ë–ê–í–ò–¢–¨: –ø–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const userIds = activeBoostUsers.map(u => u.user_id);
const { data: userBalances } = await supabase
  .from('users')
  .select('id, balance_ton, balance_uni')
  .in('id', userIds);

// –°–æ–∑–¥–∞—Ç—å –º–∞–ø—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
const balanceMap = new Map(userBalances?.map(u => [u.id, u]) || []);
```

**–í–∞—Ä–∏–∞–Ω—Ç 2 (–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ):**
- –ò–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `TonFarmingData` –¥–æ–±–∞–≤–∏–≤ –ø–æ–ª—è `balance_ton` –∏ `balance_uni`
- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥ `getActiveBoostUsers()` –¥–ª—è JOIN —Å —Ç–∞–±–ª–∏—Ü–µ–π users

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤:
- **–¢–µ–∫—É—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:** `farming_balance`, `farming_rate`, `boost_package_id`
- **–û–∂–∏–¥–∞–µ–º—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º:** `balance_ton`, `balance_uni`, `ton_boost_package`
- **–†–µ—à–µ–Ω–∏–µ:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –¥–≤—É—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏–ª–∏ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

## üìä 2. –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–û–ï –°–†–ê–í–ù–ï–ù–ò–ï UniFarming vs TON Boost

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç             | UniFarming                              | TON Boost                          |
| --------------------- | --------------------------------------- | ---------------------------------- |
| **–ò—Å—Ç–æ—á–Ω–∏–∫ –±–∞–ª–∞–Ω—Å–∞**  | `balance_uni` –∏–∑ `users`                | `balance_ton` –∏–∑ `users` (–ù–ï –î–û–°–¢–£–ü–ï–ù) |
| **–ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ** | `uni_farming_data` + `users`          | `ton_farming_data` + `users`       |
| **–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫**       | `farmingScheduler.ts`                   | `tonBoostIncomeScheduler.ts`       |
| **–ö—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å** | `BatchBalanceProcessor`              | `BalanceManager.addBalance()` ‚úÖ    |
| **–ú–µ—Ö–∞–Ω–∏–∑–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è** | `processFarmingIncome()` ‚Üí batch      | –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚úÖ       |
| **WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** | ‚úÖ –ß–µ—Ä–µ–∑ BatchBalanceProcessor      | ‚úÖ –ß–µ—Ä–µ–∑ BalanceManager callback   |
| **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**        | ‚úÖ `FARMING_REWARD` —Å–æ–∑–¥–∞—é—Ç—Å—è           | ‚ùå `TON_BOOST_INCOME` –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è |
| **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î**     | ‚úÖ Batch SQL update                     | ‚ùå –ù–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (userDeposit=0) |
| **–†–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–∞**     | ‚úÖ uni_deposit_amount √ó rate            | ‚ùå undefined √ó rate = 0            |

### –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è:

**UniFarming (—Ä–∞–±–æ—Ç–∞–µ—Ç):**
1. `farmingScheduler` –ø–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∞—Ä–º–µ—Ä–æ–≤
2. –†–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–∞: `uni_deposit_amount √ó uni_farming_rate`
3. –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –¥–æ—Ö–æ–¥—ã –≤ –º–∞—Å—Å–∏–≤ `farmerIncomes`
4. `BatchBalanceProcessor.processFarmingIncome()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
5. BatchBalanceProcessor –Ω–∞–ø—Ä—è–º—É—é –æ–±–Ω–æ–≤–ª—è–µ—Ç `users` —Ç–∞–±–ª–∏—Ü—É
6. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WebSocket —á–µ—Ä–µ–∑ `BalanceNotificationService`
7. –°–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ `FARMING_REWARD`

**TON Boost (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç):**
1. `tonBoostIncomeScheduler` –ø–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚úÖ
2. –ü—ã—Ç–∞–µ—Ç—Å—è —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å: `parseFloat(user.balance_ton || '0')` ‚ùå
3. `user.balance_ton = undefined`, —Ä–µ–∑—É–ª—å—Ç–∞—Ç = 0
4. `userDeposit = 0`, –¥–æ—Ö–æ–¥ = 0
5. –£—Å–ª–æ–≤–∏–µ `if (fiveMinuteIncome <= 0.0001)` –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
6. –ù–∏–∫–∞–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

## üîç 3. –¢–û–ß–ù–ê–Ø –ü–†–ò–ß–ò–ù–ê –û–¢–°–£–¢–°–¢–í–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø balance_ton

### –¶–µ–ø–æ—á–∫–∞ –æ–±—Ä—ã–≤–∞:

1. **TonFarmingRepository.getActiveBoostUsers()** ‚úÖ
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ `ton_farming_data`
   - –ù–ï –≤–∫–ª—é—á–∞–µ—Ç `balance_ton` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `users`

2. **tonBoostIncomeScheduler.processTonBoostIncome()** ‚ùå
   - –°—Ç—Ä–æ–∫–∞ 77: `parseFloat(user.balance_ton || '0')`
   - `user.balance_ton` = undefined
   - `userDeposit` = 0

3. **–†–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–∞** ‚ùå
   - `dailyIncome = 0 √ó 0.01 = 0`
   - `fiveMinuteIncome = 0`

4. **–ü—Ä–æ–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏** ‚ùå
   - –°—Ç—Ä–æ–∫–∞ 102: `if (fiveMinuteIncome <= 0.0001) continue;`
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è

5. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚ùå `BalanceManager.addBalance()` –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
   - ‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ù–ï —Å–æ–∑–¥–∞—é—Ç—Å—è
   - ‚ùå WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
   - ‚ùå UI –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –ú–æ–¥—É–ª–∏ –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç:
- ‚ùå **BalanceManager** - –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ —É—Å–ª–æ–≤–∏—è –ø—Ä–æ–ø—É—Å–∫–∞
- ‚ùå **UnifiedTransactionService** - –Ω–µ —Å–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚ùå **BalanceNotificationService** - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WebSocket

### –ü–æ—á–µ–º—É BalanceManager –æ–±—Ö–æ–¥–∏—Ç—Å—è —Å—Ç–æ—Ä–æ–Ω–æ–π:
- –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `BalanceManager.addBalance()` (—Å—Ç—Ä–æ–∫–∞ 111)
- –ù–û –∫–æ–¥ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –∏–∑-–∑–∞ `userDeposit = 0`

## üéØ –ò–¢–û–ì–û–í–û–ï –†–ï–®–ï–ù–ò–ï

### –î–ª—è –∑–∞–ø—É—Å–∫–∞ TON Boost –Ω—É–∂–Ω–æ:
1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `users` –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
2. –°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ `ton_farming_data` —Å –±–∞–ª–∞–Ω—Å–∞–º–∏ –∏–∑ `users`
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–µ–ø–æ–∑–∏—Ç–∞

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:
–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ö–æ–¥ –∫–∞–∫ –≤ UniFarming - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–∫–ª—é—á–∞—è –±–∞–ª–∞–Ω—Å—ã.

---

**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 5-10 –º–∏–Ω—É—Ç  
**–†–∏—Å–∫–∏:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ