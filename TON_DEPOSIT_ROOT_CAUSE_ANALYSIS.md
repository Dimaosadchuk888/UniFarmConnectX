# üî¥ –ê–ù–ê–õ–ò–ó –ö–û–†–ù–ï–í–û–ô –ü–†–ò–ß–ò–ù–´ –ü–†–û–ë–õ–ï–ú –° TON –î–ï–ü–û–ó–ò–¢–ê–ú–ò
## –î–∞—Ç–∞: 06.08.2025

## üéØ –ì–õ–ê–í–ù–ê–Ø –ù–ê–•–û–î–ö–ê

**–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –†–ê–°–•–û–ñ–î–ï–ù–ò–ï –í –ê–†–•–ò–¢–ï–ö–¢–£–†–ï:**
- –¢–ó —Ç—Ä–µ–±—É–µ—Ç: –î–µ–ø–æ–∑–∏—Ç—ã –¥–æ–ª–∂–Ω—ã –ø–æ–ø–∞–¥–∞—Ç—å –≤ `balance_ton`
- –†–µ–∞–ª—å–Ω–æ—Å—Ç—å: `balance_ton` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏–º–µ–µ—Ç —Ç–∏–ø `number`
- –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ –≤—Å–µ –¥–µ–ø–æ–∑–∏—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç `balance_ton`

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î - –ö–û–†–†–ï–ö–¢–ù–ê–Ø ‚úÖ
```
users.balance_ton: number (–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∏–ø)
users.balance_uni: number (–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∏–ø)
```

### 2. –î–µ–ø–æ–∑–∏—Ç—ã –°–û–ó–î–ê–Æ–¢–°–Ø ‚úÖ
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ç–∏–ø–∞ `TON_DEPOSIT` —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `transactions`
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –°—Ç–∞—Ç—É—Å = `completed`

### 3. –ë–∞–ª–∞–Ω—Å—ã –ù–ï –í–°–ï–ì–î–ê –û–ë–ù–û–í–õ–Ø–Æ–¢–°–Ø ‚ùå
–ü—Ä–∏–º–µ—Ä—ã –∏–∑ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:
- User 328: –î–µ–ø–æ–∑–∏—Ç 15 TON ‚Üí balance_ton = 15 ‚úÖ
- User 317: –î–µ–ø–æ–∑–∏—Ç 25 TON ‚Üí balance_ton = 30.3 ‚úÖ (—Å —É—á–µ—Ç–æ–º –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö)
- User 25: –î–≤–∞ –¥–µ–ø–æ–∑–∏—Ç–∞ –ø–æ 50 TON ‚Üí balance_ton = 487.45 ‚úÖ

**–ù–û:** –ï—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –¥–µ–ø–æ–∑–∏—Ç—ã –Ω–µ –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –≤ –±–∞–ª–∞–Ω—Å–µ!

## üîç –ê–ù–ê–õ–ò–ó –ö–û–î–ê

### –¶–µ–ø–æ—á–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–ø–æ–∑–∏—Ç–∞:

1. **Frontend** (`TonDepositCard.tsx`)
   ‚Üí –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç BOC –Ω–∞ backend

2. **Backend** (`modules/wallet/controller.ts::tonDeposit`)
   ‚Üí –ü–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
   ‚Üí –í—ã–∑—ã–≤–∞–µ—Ç `walletService.processTonDeposit()`

3. **WalletService** (`modules/wallet/service.ts::processTonDeposit`)
   ‚Üí –°–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —á–µ—Ä–µ–∑ `UnifiedTransactionService`
   
4. **UnifiedTransactionService** (`core/TransactionService.ts`)
   ‚Üí –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ `transactions`
   ‚Üí **–î–û–õ–ñ–ï–ù** –≤—ã–∑–≤–∞—Ç—å `BalanceManager.addBalance()`

5. **BalanceManager** (`core/BalanceManager.ts`)
   ‚Üí **–î–û–õ–ñ–ï–ù** –æ–±–Ω–æ–≤–∏—Ç—å `balance_ton` –≤ —Ç–∞–±–ª–∏—Ü–µ `users`

## ‚ö†Ô∏è –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### –ü–†–û–ë–õ–ï–ú–ê 1: –ù–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π –≤—ã–∑–æ–≤ BalanceManager
–í `TransactionService.ts` (—Å—Ç—Ä–æ–∫–∏ 475-485):
```typescript
if (amount_uni > 0) {
  await balanceManager.addBalance(user_id, amount_uni, 0);
}

if (amount_ton > 0) {
  await balanceManager.addBalance(user_id, 0, amount_ton);
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–æ–ª—è `amount_uni` –∏ `amount_ton`, –Ω–æ –¥–ª—è `TON_DEPOSIT` –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–æ–ª–µ `amount`!

### –ü–†–û–ë–õ–ï–ú–ê 2: –ü–æ–ª–µ amount vs amount_ton
–í `processTonDeposit` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è:
```typescript
amount_ton: amount,  // –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ amount_ton
amount_uni: 0,
```

–ù–æ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–æ—Å—Ç–æ `amount` –±–µ–∑ —Å—É—Ñ—Ñ–∏–∫—Å–∞!

### –ü–†–û–ë–õ–ï–ú–ê 3: Silent failures
–ï—Å–ª–∏ `BalanceManager.addBalance()` –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤—Å–µ —Ä–∞–≤–Ω–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è:
```typescript
// –ù–ï –±–ª–æ–∫–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ –±–∞–ª–∞–Ω—Å–∞
```

### –ü–†–û–ë–õ–ï–ú–ê 4: –†–∞–∑–Ω—ã–µ –ø—É—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è –¥–µ–ø–æ–∑–∏—Ç–æ–≤
–ï—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—É—Ç–µ–π —Å–æ–∑–¥–∞–Ω–∏—è TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤:
1. –ß–µ—Ä–µ–∑ `tonDeposit` controller
2. –ß–µ—Ä–µ–∑ –ø—Ä—è–º—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã (–∞–¥–º–∏–Ω–∫–∞?)
3. –ß–µ—Ä–µ–∑ schedulers/–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é

–ù–µ –≤—Å–µ –ø—É—Ç–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è—é—Ç –±–∞–ª–∞–Ω—Å!

## üîß –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –®–ê–ì 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å TransactionService
–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–ª—è `TON_DEPOSIT` –≤—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ–ª–µ–º.

### –®–ê–ì 2: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ processTonDeposit
–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ –±–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω.

### –®–ê–ì 3: –î–æ–±–∞–≤–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤
–°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

### –®–ê–ì 4: –£—Å–∏–ª–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–î–æ–±–∞–≤–∏—Ç—å CRITICAL –ª–æ–≥–∏ –ø—Ä–∏ –ª—é–±–æ–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–∏ –º–µ–∂–¥—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π –∏ –±–∞–ª–∞–Ω—Å–æ–º.

## üìù –í–´–í–û–î–´

1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤ —Ü–µ–ª–æ–º –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è** - –ø–æ–ª–µ `balance_ton` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
2. **–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏** - –Ω–µ –≤—Å–µ –ø—É—Ç–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç –±–∞–ª–∞–Ω—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. **Silent failures** - –æ—à–∏–±–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
4. **–ù—É–∂–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å—ã –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üö® –ö–†–ò–¢–ò–ß–ù–û–°–¢–¨: –í–´–°–û–ö–ê–Ø

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ—Ä—è—é—Ç –¥–µ–Ω—å–≥–∏! –î–µ–ø–æ–∑–∏—Ç—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å –∫–æ—à–µ–ª—å–∫–æ–≤, –Ω–æ –Ω–µ –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –≤ –±–∞–ª–∞–Ω—Å–∞—Ö.

## üéØ –ù–ï–ú–ï–î–õ–ï–ù–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø

1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤ TransactionService
2. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
4. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π