# –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢: –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –û–ë–†–´–í–ê –†–ï–§–ï–†–ê–õ–¨–ù–û–ô –¶–ï–ü–û–ß–ö–ò

## üéØ –†–ï–ó–Æ–ú–ï –ü–†–û–ë–õ–ï–ú–´
–ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `users`, –Ω–æ **–ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–≤—è–∑—å** –≤ —Ç–∞–±–ª–∏—Ü–µ `referrals`. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø–æ–ª–æ–≤–∏–Ω—É - –Ω–∞—á–∏—Å–ª—è–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã –æ—Ç —Ñ–∞–Ω—Ç–æ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

## üîç –î–ï–¢–ê–õ–¨–ù–ê–Ø –¶–ï–ü–û–ß–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò

### 1. FRONTEND - –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –†–ï–§–ï–†–ê–õ–¨–ù–û–ì–û –ö–û–î–ê
**–§–∞–π–ª**: `client/src/lib/utils.ts` ‚Üí `getReferrerIdFromURL()`
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã**:
- URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: `?ref_code=XXX`, `?start=userXXX`, `?startapp=XXX`  
- Telegram WebApp: `startParam`, `initData` —Å `start=XXX`
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: start ‚Üí ref_code ‚Üí startapp ‚Üí Telegram startParam ‚Üí initData

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

### 2. FRONTEND - –ü–ï–†–ï–î–ê–ß–ê –ù–ê BACKEND
**–§–∞–π–ª**: `client/src/App.tsx` ‚Üí `authenticateUser()`
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û

```javascript
const refCode = getReferrerIdFromURL();
if (refCode) {
  sessionStorage.setItem('referrer_code', refCode);
}

const response = await fetch('/api/v2/auth/telegram', {
  body: JSON.stringify({
    initData: window.Telegram.WebApp.initData,
    ref_by: refCode || undefined  // ‚Üê –ö–û–†–†–ï–ö–¢–ù–ê–Ø –ü–ï–†–ï–î–ê–ß–ê
  })
});
```

### 3. BACKEND - –¢–û–ß–ö–ê –í–•–û–î–ê
**–§–∞–π–ª**: `modules/auth/controller.ts` ‚Üí `authenticateTelegram()`
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û

```typescript
const { initData: initDataFromBody, refBy, ref_by } = req.body;
const referralCode = refBy || ref_by; // ‚Üê –ö–û–†–†–ï–ö–¢–ù–û–ï –ò–ó–í–õ–ï–ß–ï–ù–ò–ï

if (direct_registration && telegram_id) {
  const result = await this.authService.registerDirectFromTelegramUser({
    telegram_id: parseInt(telegram_id.toString()),
    ref_by: referralCode  // ‚Üê –ö–û–†–†–ï–ö–¢–ù–ê–Ø –ü–ï–†–ï–î–ê–ß–ê
  });
}
```

### 4. AUTH SERVICE - –û–ë–†–ê–ë–û–¢–ö–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò
**–§–∞–π–ª**: `modules/auth/service.ts`
**–°—Ç–∞—Ç—É—Å**: ‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–û –†–ê–ë–û–¢–ê–ï–¢

#### 4.1 `registerDirectFromTelegramUser()` (—Å—Ç—Ä–æ–∫–∏ 326-391)
‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç `findOrCreateFromTelegram()`

#### 4.2 `findOrCreateFromTelegram()` (—Å—Ç—Ä–æ–∫–∏ 181-230)
‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç `processReferralInline()`
‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

#### 4.3 `createUser()` (—Å—Ç—Ä–æ–∫–∏ 147-176)
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å `referred_by: null`

#### 4.4 `processReferralInline()` (—Å—Ç—Ä–æ–∫–∏ 50-119) - **–ü–†–û–ë–õ–ï–ú–ù–ê–Ø –ó–û–ù–ê**

**–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –í –°–¢–†–£–ö–¢–£–†–ï –î–ê–ù–ù–´–•**:
```typescript
// –°–¢–†–û–ö–ê 84 - –î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï!
const { error: referralError } = await supabase
  .from('referrals')
  .insert({
    user_id: newUserId,          // ‚Üê ID –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
    referred_user_id: newUserId, // ‚Üê –î–£–ë–õ–ò–†–£–ï–¢ user_id! –û–®–ò–ë–ö–ê!
    inviter_id: referrer.id,     // ‚Üê ID –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ
    // ...–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
  });
```

**–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –î–û–õ–ñ–ù–ê –ë–´–¢–¨**:
```typescript
{
  user_id: newUserId,          // ID –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ
  referred_user_id: newUserId, // –¢–æ—Ç –∂–µ ID –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  inviter_id: referrer.id,     // ID –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ - –ö–õ–Æ–ß–ï–í–û–ï –ü–û–õ–ï!
}
```

### 5. REFERRAL SERVICE - –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø
**–§–∞–π–ª**: `modules/referral/service.ts` ‚Üí `processReferral()`
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û (–ù–û –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø)

**–û—Ç–ª–∏—á–∏—è –æ—Ç processReferralInline()**:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `REFERRAL_TABLES.REFERRALS` –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∏ 'referrals'
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: `referred_user_id: parseInt(newUserId)`
- –õ—É—á—à–µ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

## üö® –ö–û–†–ù–ï–í–´–ï –ü–†–ò–ß–ò–ù–´ –ü–†–û–ë–õ–ï–ú

### 1. –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–û–ï –î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï
- **–î–≤–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –º–µ—Ç–æ–¥–∞**: `processReferral()` –∏ `processReferralInline()`
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π**: `processReferralInline()` —Å –æ—à–∏–±–∫–∞–º–∏
- **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**: `processReferral()` –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

### 2. –û–®–ò–ë–ö–ê –í –°–¢–†–£–ö–¢–£–†–ï –î–ê–ù–ù–´–•
- **processReferralInline() —Å—Ç—Ä–æ–∫–∞ 84**: `referred_user_id: newUserId` - –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–î–æ–ª–∂–Ω–æ –±—ã—Ç—å**: `inviter_id: referrer.id` - –∫–ª—é—á–µ–≤–æ–µ –ø–æ–ª–µ —Å–≤—è–∑–∏

### 3. –ü–†–û–ë–õ–ï–ú–´ –° SUPABASE –û–ü–ï–†–ê–¶–ò–Ø–ú–ò
**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã —Å–±–æ—è**:
- **RLS (Row Level Security)**: –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ `referrals`
- **–¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö**: –ö–æ–Ω—Ñ–ª–∏–∫—Ç `INTEGER` vs `STRING` –¥–ª—è `user_id`
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å**: –û–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω—ã

### 4. –§–ê–ù–¢–û–ú–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò 186-190
**–ü–∞—Ä–∞–¥–æ–∫—Å**:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ **–ù–ï –°–£–©–ï–°–¢–í–£–Æ–¢** –≤ —Ç–∞–±–ª–∏—Ü–µ `users`
- **–ù–û –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç** —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è User 184
- **–ò—Å—Ç–æ—á–Ω–∏–∫**: –ó–∞–ø–∏—Å–∏ –≤ `ton_farming_data` –±–µ–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üîÑ –¶–ï–ü–û–ß–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –ù–ê–ì–†–ê–î

### buildReferrerChain() –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û
```typescript
// modules/referral/service.ts —Å—Ç—Ä–æ–∫–∏ 166-205
while (level < maxLevels) {
  const { data: user } = await supabase
    .from(REFERRAL_TABLES.USERS)
    .select('id, referred_by')
    .eq('id', currentUserId)
    .single();
    
  if (!user.referred_by) break; // ‚Üê –ó–î–ï–°–¨ –ü–†–û–ë–õ–ï–ú–ê –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  
  referrerChain.push(user.referred_by.toString());
}
```

### distributeReferralRewards() –†–ê–ë–û–¢–ê–ï–¢
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ `farmingScheduler` –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—á–∏—Å–ª—è–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã –î–õ–Ø –°–£–©–ï–°–¢–í–£–Æ–©–ò–• —Å–≤—è–∑–µ–π
- –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—É –Ω–∏—Ö `referred_by = null`)

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú

### –£—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (‚úÖ):
1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –∏–∑ URL/Telegram
2. –ü–µ—Ä–µ–¥–∞—á–∞ ref_code –Ω–∞ backend  
3. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ `users`
4. –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Å–≤—è–∑—è–º
5. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ü–µ–ø–æ—á–µ–∫ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö `referred_by`

### –ù–µ—É—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (‚ùå):
1. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `referred_by`** - –æ—Å—Ç–∞–µ—Ç—Å—è `null`
2. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –≤ `referrals`** - —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞
3. **–ù–æ–≤—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏** - –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è
4. **API –¥–æ—Å—Ç—É–ø –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º** - –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç "–ù–ï –ù–ê–ô–î–ï–ù"

## üéØ –§–ò–ù–ê–õ–¨–ù–´–ï –í–´–í–û–î–´

### –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê
–°–∏—Å—Ç–µ–º–∞ –∏–º–µ–µ—Ç **–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—É—é –æ—à–∏–±–∫—É –≤ processReferralInline()** - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è INSERT –æ–ø–µ—Ä–∞—Ü–∏–∏, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Å–±–æ—é Supabase –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—é —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑–µ–π.

### –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ü–†–û–ë–õ–ï–ú–´  
1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏** - –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö –º–µ—Ç–æ–¥–∞ –¥–ª—è –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏
2. **–§–∞–Ω—Ç–æ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - –Ω–∞–≥—Ä–∞–¥—ã –æ—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. **API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å** - –ø—Ä–æ–±–ª–µ–º—ã —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –∏–ª–∏ —Ç–æ–∫–µ–Ω–∞–º–∏

### –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø
1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –≤ processReferralInline()** (—Å—Ç—Ä–æ–∫–∞ 84)
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ Supabase RLS** –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `referrals` 
3. **–î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** Supabase –æ—à–∏–±–æ–∫
4. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –æ–¥–∏–Ω –º–µ—Ç–æ–¥** - `processReferral()` –∏–∑ ReferralService
5. **–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∞–Ω—Ç–æ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** –≤ `ton_farming_data`

---

**–°–¢–ê–¢–£–°**: –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞ - –æ—à–∏–±–∫–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –¥–∞–Ω–Ω—ã—Ö INSERT –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ processReferralInline()
**–†–ò–°–ö**: –í–´–°–û–ö–ò–ô - –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ—Ä—è—é—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏  
**–ü–†–ò–û–†–ò–¢–ï–¢**: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô - —Ç—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è