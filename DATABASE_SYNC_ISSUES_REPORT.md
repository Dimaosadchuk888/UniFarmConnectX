# Отчет о проблемах синхронизации базы данных UniFarm
**Дата:** 11 июля 2025
**Статус:** Критические проблемы обнаружены

## Резюме
Обнаружены серьезные проблемы с синхронизацией данных между таблицами, которые могут привести к финансовым несоответствиям и потере доверия пользователей.

## 1. UNI Farming - Критическое расхождение депозитов

### Проблема:
- **Сумма всех транзакций FARMING_DEPOSIT:** 1,360 UNI
- **Текущий депозит в uni_farming_data:** 407,589 UNI
- **Необъяснимая разница:** 406,229 UNI (99.7% депозита!)

### Анализ:
Огромная разница указывает на то, что:
1. Депозиты обновлялись напрямую через SQL без создания транзакций
2. Возможно, была миграция данных из старой версии системы
3. Проценты от фарминга добавлялись напрямую к депозиту вместо отдельного поля

### Риски:
- ❌ Невозможно провести аудит движения средств
- ❌ Пользователи не видят историю своих операций
- ❌ Нарушена финансовая прозрачность системы

## 2. TON Boost - Полная дисфункция системы

### Проблемы:
1. **Таблица ton_farming_data не существует**
   - Система использует fallback на таблицу users
   - Но необходимые поля отсутствуют

2. **Отсутствующие поля в таблице users:**
   - ton_farming_deposit
   - ton_farming_balance
   - ton_farming_rate
   - ton_farming_start_timestamp
   - ton_farming_last_update
   - ton_boost_active (поле ton_boost_package существует!)

### Последствия:
- ❌ TON Boost покупки не работают корректно
- ❌ Невозможно отслеживать доходы от TON farming
- ❌ Пользователь 74 имеет ton_boost_package: 2, но система не может это обработать

## 3. Referral система - Отсутствие данных

### Проблемы:
- Таблица referrals пуста для пользователя 74
- В таблице users отсутствуют поля для referral статистики
- Невозможно отследить партнерские выплаты

## Рекомендации по исправлению

### Немедленные действия:

1. **Добавить недостающие TON поля в таблицу users:**
```sql
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS ton_boost_active BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS ton_farming_deposit NUMERIC(20,9) DEFAULT 0,
ADD COLUMN IF NOT EXISTS ton_farming_balance NUMERIC(20,9) DEFAULT 0,
ADD COLUMN IF NOT EXISTS ton_farming_rate NUMERIC(10,6) DEFAULT 0.01,
ADD COLUMN IF NOT EXISTS ton_farming_start_timestamp TIMESTAMP DEFAULT NULL,
ADD COLUMN IF NOT EXISTS ton_farming_last_update TIMESTAMP DEFAULT NULL;
```

2. **Создать миграционную транзакцию для объяснения разницы:**
```sql
INSERT INTO transactions (user_id, type, amount_uni, description, created_at)
VALUES (74, 'FARMING_DEPOSIT', 406229.001, 'Миграция исторических депозитов', NOW());
```

3. **Реализовать строгую политику:**
   - ВСЕ изменения депозитов должны создавать транзакции
   - Прямые SQL обновления deposit_amount запрещены
   - Каждая операция должна быть прослеживаемой

### Долгосрочные решения:

1. **Создать таблицу ton_farming_data** для правильной архитектуры
2. **Реализовать двустороннюю синхронизацию** между таблицами
3. **Добавить триггеры БД** для автоматического создания транзакций
4. **Провести полный аудит** всех пользователей на предмет расхождений

## Заключение

Система имеет серьезные проблемы с целостностью данных. Хотя функциональность работает (депозиты создаются, проценты начисляются), отсутствие транзакционной истории и синхронизации между таблицами создает риски для финансовой отчетности и доверия пользователей.

**Приоритет:** КРИТИЧЕСКИЙ
**Время на исправление:** 2-4 часа
**Влияние на пользователей:** Высокое