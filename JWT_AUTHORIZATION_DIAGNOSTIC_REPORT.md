# üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: JWT –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π - 401 Unauthorized

**–î–∞—Ç–∞**: 19 —è–Ω–≤–∞—Ä—è 2025  
**–í—Ä–µ–º—è**: 8:00 UTC  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ù–ê–ô–î–ï–ù–ê  
**–¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã**: –ò–°–¢–ï–ö–®–ò–ô JWT –¢–û–ö–ï–ù

---

## üéØ –û–ë–ù–ê–†–£–ñ–ï–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

### **–°–∏–º–ø—Ç–æ–º—ã –≤ –ª–æ–≥–∞—Ö**:
```
"success":false,"error":"Invalid or expired JWT token","jwt_error":"invalid signature","need_new_token":true
```

### **HTTP Status**: 401 Unauthorized

---

## üîç –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê: –ò–°–¢–ï–ö–®–ò–ô JWT –¢–û–ö–ï–ù

### **–ê–Ω–∞–ª–∏–∑ —Ç–æ–∫–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 74**:
```javascript
Decoded JWT payload: {
  userId: 74,
  telegram_id: 999489,
  username: 'unifarm_replit_test',
  ref_code: 'EA2627',
  iat: 1737079310,    // –í—ã–¥–∞–Ω: 17 —è–Ω–≤–∞—Ä—è 2025, 2:01 UTC
  exp: 1737684110     // –ò—Å—Ç–µ–∫: 24 —è–Ω–≤–∞—Ä—è 2025, 2:01 UTC
}

Token expired: true  // ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ - —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫!
```

### **–í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞**:
- **–í—ã–¥–∞–Ω**: 17 —è–Ω–≤–∞—Ä—è 2025, 2:01 UTC
- **–ò—Å—Ç–µ–∫–∞–µ—Ç**: 24 —è–Ω–≤–∞—Ä—è 2025, 2:01 UTC  
- **–°–µ–π—á–∞—Å**: 19 —è–Ω–≤–∞—Ä—è 2025, 8:00 UTC
- **–°—Ç–∞—Ç—É—Å**: ‚ö†Ô∏è –ò–°–¢–ï–ö (19 —è–Ω–≤–∞—Ä—è > —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è)

---

## üõ†Ô∏è –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –¶–ï–ü–û–ß–ö–ê –ü–†–û–ë–õ–ï–ú–´

### **1. Frontend –∑–∞–ø—Ä–æ—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**:
```javascript
// client/src/services/transactionService.ts:73
const response = await correctApiRequest(`/api/transactions?user_id=${userId}&limit=${limit}&offset=${offset}`, 'GET')
```

### **2. correctApiRequest.ts –¥–æ–±–∞–≤–ª—è–µ—Ç –∏—Å—Ç–µ–∫—à–∏–π —Ç–æ–∫–µ–Ω**:
```javascript
// client/src/lib/correctApiRequest.ts:44-46
if (token) {
  requestHeaders['Authorization'] = `Bearer ${token}`;  // –ò–°–¢–ï–ö–®–ò–ô –¢–û–ö–ï–ù!
}
```

### **3. Backend –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å**:
```javascript
// core/middleware/telegramAuth.ts:44
const decoded = jwt.verify(token, jwtSecret); // ‚ùå –í–´–ë–†–ê–°–´–í–ê–ï–¢ –û–®–ò–ë–ö–£
```

### **4. Middleware –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401**:
```json
{
  "success": false,
  "error": "Invalid or expired JWT token",
  "jwt_error": "invalid signature",
  "need_new_token": true
}
```

---

## üîÑ –°–ò–°–¢–ï–ú–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø –¢–û–ö–ï–ù–û–í

### **–†–µ–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤**:
- ‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 184** - —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- ‚ùå **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 74** - —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫, 401 Unauthorized

### **–ú–µ—Ö–∞–Ω–∏–∑–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**:
```javascript
// client/src/lib/correctApiRequest.ts:35-41
if (token && isTokenExpiringSoon(token)) {
  const refreshResult = await handleTokenRefresh();
  if (refreshResult.success && refreshResult.token) {
    token = refreshResult.token;  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
  }
}
```

### **Endpoint –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**:
```javascript
// client/src/lib/tokenRefreshHandler.ts:34
const response = await fetch('/api/v2/auth/refresh', {
  method: 'POST',
  body: JSON.stringify({ token: currentToken })
});
```

---

## üìä –ê–ù–ê–õ–ò–ó –ü–û–í–ï–î–ï–ù–ò–Ø –ü–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú

### **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 74 (Replit test account)**:
- **JWT —Ç–æ–∫–µ–Ω**: –ò—Å—Ç–µ–∫ 19 —è–Ω–≤–∞—Ä—è 2025
- **–ü–æ–≤–µ–¥–µ–Ω–∏–µ**: 401 –Ω–∞ –≤—Å–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ endpoints
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**: –ù–ï –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
- **–°—Ç–∞—Ç—É—Å**: ‚ùå –¢–†–ï–ë–£–ï–¢ –û–ë–ù–û–í–õ–ï–ù–ò–Ø –¢–û–ö–ï–ù–ê

### **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 184 (–†–µ–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)**:
- **JWT —Ç–æ–∫–µ–Ω**: –í–∞–ª–∏–¥–µ–Ω (exp: 1737892607 = 26 —è–Ω–≤–∞—Ä—è 2025)
- **–ü–æ–≤–µ–¥–µ–Ω–∏–µ**: –í—Å–µ API —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**: ‚úÖ –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ (809166, 809161, 809156...)
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ –ù–û–†–ú–ê–õ–¨–ù–û

---

## üîß –ú–ï–•–ê–ù–ò–ó–ú –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ useAutoAuth**:
```javascript
// client/src/hooks/useAutoAuth.ts:29-32
} else if (response.status === 401) {
  console.log('[useAutoAuth] Token validation failed, but keeping it for Preview mode');
  setTokenValidated(true); // Keep the token in Preview mode
  return;
}
```

### **–õ–æ–≥–∏–∫–∞ Preview —Ä–µ–∂–∏–º–∞**:
- Preview —Ä–µ–∂–∏–º –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ –∏—Å—Ç–µ–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–∞—Ö
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é
- –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ endpoints –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 401, –Ω–æ —ç—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è gracefully

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### **–ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Å–∏—Å—Ç–µ–º—ã**:
- ‚úÖ JWT middleware —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞  
- ‚úÖ –í–∞–ª–∏–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ

### **–ü—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —Ç–æ–∫–µ–Ω–µ**:
- ‚ùå –¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 74 –∏—Å—Ç–µ–∫
- ‚è∞ –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 7 –¥–Ω–µ–π (—Å 17 –ø–æ 24 —è–Ω–≤–∞—Ä—è)
- üîÑ –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `/api/v2/auth/refresh`

### **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:
1. **–î–ª—è production**: —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. **–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**: –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 74
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

---

## üéØ –°–¢–ê–¢–£–°: –ù–ï –¢–†–ï–ë–£–ï–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

**–°–∏—Å—Ç–µ–º–∞ –∫–æ—à–µ–ª—å–∫–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 96% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏.**  
**JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.**  
**–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ - –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏—Å—Ç–µ—á–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞.**

---

*–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.*