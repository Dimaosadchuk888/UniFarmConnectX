# üìã –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ API –¢–†–ê–ù–ó–ê–ö–¶–ò–ô

## üîç –ê–ù–ê–õ–ò–ó –¶–ï–ü–û–ß–ö–ò –ó–ê–ü–†–û–°–ê GET /api/v2/transactions

### 1. Frontend ‚Üí Backend –∑–∞–ø—Ä–æ—Å
```
Frontend (TransactionHistory.tsx)
‚Üì 
correctApiRequest('/api/v2/transactions?page=1&limit=20')
‚Üì
JWT Header: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 2. Backend –æ–±—Ä–∞–±–æ—Ç–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞

üìÅ **core/middleware/telegramAuth.ts**  
üî¢ **–°—Ç—Ä–æ–∫–∏ 44-81**
```javascript
// –°—Ç—Ä–æ–∫–∞ 44: –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç—Å—è JWT
const decoded = jwt.verify(token, jwtSecret) as any;
// decoded —Å–æ–¥–µ—Ä–∂–∏—Ç: { userId: 74, telegram_id: 999489, ... }

// –°—Ç—Ä–æ–∫–∞ 48-49: –ò–∑–≤–ª–µ–∫–∞—é—Ç—Å—è ID
const userId = decoded.userId || decoded.user_id;      // = 74
const telegramId = decoded.telegram_id || decoded.telegramId; // = 999489

// –°—Ç—Ä–æ–∫–∞ 59: –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ –ë–î
const fullUser = await userRepository.getUserById(userId);

// –°—Ç—Ä–æ–∫–∞ 69-81: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê - —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
const user = {
  id: fullUser.id,              // = 74 (database ID)
  telegram_id: fullUser.telegram_id, // = 999489 (Telegram ID)
  // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
};

// ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –≤ –æ–±—ä–µ–∫—Ç–µ telegram –ø–æ–ª–µ user.id —Å–æ–¥–µ—Ä–∂–∏—Ç database ID, –∞ –Ω–µ telegram_id
(req as any).telegram = { user, validated: true };
```

### 3. –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

üìÅ **modules/transactions/controller.ts**  
üî¢ **–°—Ç—Ä–æ–∫–∏ 15-22**
```javascript
// –°—Ç—Ä–æ–∫–∞ 15: –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
const telegram = this.validateTelegramAuth(req, res);
// telegram.user.id = 74 (—ç—Ç–æ database ID, –ù–ï telegram_id!)

// –°—Ç—Ä–æ–∫–∞ 22: –û–®–ò–ë–ö–ê - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
const user = await userRepository.getUserByTelegramId(telegram.user.id);
// –ò—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å telegram_id = 74
// –ù–∞—Ö–æ–¥–∏—Ç User 77 (—É –∫–æ—Ç–æ—Ä–æ–≥–æ telegram_id = 74)
```

### 4. –†–µ–∑—É–ª—å—Ç–∞—Ç
- –í–º–µ—Å—Ç–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π User 74 –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ User 77
- Frontend –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —á—É–∂–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ

### –í–ê–†–ò–ê–ù–¢ 1: –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

üìÅ **modules/transactions/controller.ts**  
üî¢ **–°—Ç—Ä–æ–∫–∞ 22**  
üí° **–ò–∑–º–µ–Ω–∏—Ç—å:**
```javascript
// –ë–´–õ–û:
const user = await userRepository.getUserByTelegramId(telegram.user.id);

// –°–¢–ê–õ–û:
const user = await userRepository.getUserById(telegram.user.id);
```

üîê **–ß—Ç–æ –±—É–¥–µ—Ç –∑–∞—â–∏—â–µ–Ω–æ:**
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —á—É–∂–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

‚úÖ **–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
1. –û—á–∏—Å—Ç–∏—Ç—å localStorage –∏ –∑–∞–Ω–æ–≤–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è
2. –û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É Wallet ‚Üí History
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ DAILY_BONUS –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 74

### –í–ê–†–ò–ê–ù–¢ 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

üìÅ **core/middleware/telegramAuth.ts**  
üî¢ **–°—Ç—Ä–æ–∫–∞ 81**  
üí° **–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ–±—ä–µ–∫—Ç–∞ telegram:**
```javascript
// –ë–´–õ–û:
(req as any).telegram = { user, validated: true };

// –°–¢–ê–õ–û:
(req as any).telegram = { 
  user: {
    ...user,
    id: user.telegram_id,  // –ò—Å–ø–æ–ª—å–∑—É–µ–º telegram_id –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
    database_id: user.id   // –°–æ—Ö—Ä–∞–Ω—è–µ–º database ID –æ—Ç–¥–µ–ª—å–Ω–æ
  }, 
  validated: true 
};
```

‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –≠—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –í–°–ï–• –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤

## üîç –î–†–£–ì–ò–ï –ú–ï–°–¢–ê –° –¢–ê–ö–û–ô –ñ–ï –ü–†–û–ë–õ–ï–ú–û–ô

### 1. modules/wallet/controller.ts

üìÅ **modules/wallet/controller.ts**  
üî¢ **–°—Ç—Ä–æ–∫–∏ 124, 242**
```javascript
// –°—Ç—Ä–æ–∫–∞ 124 (–º–µ—Ç–æ–¥ withdraw):
const user = await userRepository.getUserByTelegramId(telegram.user.id);

// –°—Ç—Ä–æ–∫–∞ 242 (–º–µ—Ç–æ–¥ createDeposit):
const user = await userRepository.getOrCreateUserFromTelegram({
  telegram_id: telegram.user.id,  // ‚ùå –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è database ID –≤–º–µ—Å—Ç–æ telegram_id
  // ...
});
```

üí° **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ:**
- –ó–∞–º–µ–Ω–∏—Ç—å getUserByTelegramId –Ω–∞ getUserById
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å telegram.user.telegram_id –≤–º–µ—Å—Ç–æ telegram.user.id

### 2. –î—Ä—É–≥–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
- `telegram.user.id` 
- `getUserByTelegramId(telegram.user.id)`

## üìä –í–õ–ò–Ø–ù–ò–ï –ù–ê –°–í–Ø–ó–ê–ù–ù–´–ï –ú–û–î–£–õ–ò

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –í–ê–†–ò–ê–ù–¢ 1:
‚úÖ **–ù–µ –ø–æ—Å—Ç—Ä–∞–¥–∞—é—Ç:**
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (JWT –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å)
- –ú–∏—Å—Å–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É)
- Daily Bonus (—É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
- Farming (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç userId –∏–∑ req.body)

‚ö†Ô∏è **–¢—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:**
- Wallet withdraw (—Ç–∞ –∂–µ –ø—Ä–æ–±–ª–µ–º–∞)
- Wallet deposits (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç getOrCreateUserFromTelegram)
- Boost –ø–æ–∫—É–ø–∫–∏ (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É)

### –¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞–Ω:
1. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:** GET /api/v2/transactions –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 271 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é User 74
2. **–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤:** POST /api/v2/wallet/withdraw –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞—è–≤–∫—É –¥–ª—è User 74
3. **–î–µ–ø–æ–∑–∏—Ç—ã:** POST /api/v2/wallet/deposit –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏—Å–ª—è—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ User 74
4. **–ë–∞–ª–∞–Ω—Å:** GET /api/v2/wallet/balance —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç getUserById)

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
- `id` –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ Telegram –¥–æ–ª–∂–µ–Ω –≤—Å–µ–≥–¥–∞ –æ–∑–Ω–∞—á–∞—Ç—å telegram_id
- `userId` –∏–ª–∏ `database_id` –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ ID –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### 2. –¢–∏–ø–∏–∑–∞—Ü–∏—è
–°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã:
```typescript
interface TelegramAuthUser {
  telegram_id: number;  // ID –∏–∑ Telegram
  database_id: number;  // ID –∏–∑ –Ω–∞—à–µ–π –ë–î
  username?: string;
  // ...
}
```

### 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ BaseController
–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–º –¥–∞–Ω–Ω—ã–º:
```typescript
protected validateUserAccess(requestUserId: number, authUser: any): boolean {
  return requestUserId === authUser.id;
}
```

## ‚úÖ –ò–¢–û–ì–û–í–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

1. **–°—Ä–æ—á–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:** modules/transactions/controller.ts (—Å—Ç—Ä–æ–∫–∞ 22)
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:** modules/wallet/controller.ts (—Å—Ç—Ä–æ–∫–∏ 124, 242)
3. **–ü—Ä–æ–≤–µ—Å—Ç–∏ –∞—É–¥–∏—Ç:** –í—Å–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è telegram.user.id
4. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ:** –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ–±—ä–µ–∫—Ç–∞ telegram –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
5. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã:** E2E —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô üî¥
–ü—Ä–æ–±–ª–µ–º–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.