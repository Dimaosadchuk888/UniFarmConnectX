# üö® –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ù–æ–≤–∞—è –æ—à–∏–±–∫–∞ TON –¥–µ–ø–æ–∑–∏—Ç–∞

**–î–∞—Ç–∞**: 19 —è–Ω–≤–∞—Ä—è 2025  
**–í—Ä–µ–º—è**: 8:05 UTC  
**–ö–æ–Ω—Ç–µ–∫—Å—Ç**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∞–µ—Ç –æ –Ω–æ–≤–æ–π –æ—à–∏–±–∫–µ –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ TON –±–∞–ª–∞–Ω—Å–∞ –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è  
**–°—Ç–∞—Ç—É—Å**: üîç –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ê–ö–¢–ò–í–ù–û

---

## üéØ –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ë–õ–ï–ú–´

### **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π**:
1. **–ó–∞–≤–µ—Ä—à–µ–Ω—ã –§–∞–∑—ã 1-2** - —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–¥–æ–≤, —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
2. **–°–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑–∞–ª–∞ 96% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏** 
3. **JWT –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
4. **–ù–û–í–ê–Ø –ü–†–û–ë–õ–ï–ú–ê** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∞–µ—Ç –æ–± –æ—à–∏–±–∫–µ TON –¥–µ–ø–æ–∑–∏—Ç–∞

### **–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ù–ï –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–ª–∏**:
- ‚ùå –õ–æ–≥–∏–∫—É TON —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ `sendTonTransaction()`
- ‚ùå –§—É–Ω–∫—Ü–∏—é `emulateTonTransaction()` 
- ‚ùå –°–æ–∑–¥–∞–Ω–∏–µ BOC payload –≤ `createBocWithComment()`
- ‚ùå –û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ TonDepositCard

---

## üîç –ê–ù–ê–õ–ò–ó –ù–û–í–û–ô –û–®–ò–ë–ö–ò

### **1. API –£—Ä–æ–≤–µ–Ω—å**:
```bash
# –¢–µ—Å—Ç TON deposit endpoint
curl POST /api/v2/wallet/ton-deposit
Response: "Invalid or expired JWT token"
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚ùå Endpoint –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 Unauthorized

### **2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 184 –∞–∫—Ç–∏–≤–µ–Ω**:
```javascript
// WebView Console Logs
"[correctApiRequest] JWT —Ç–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω, –¥–ª–∏–Ω–∞: 273"
"[correctApiRequest] –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç" // –î–ª—è –¥—Ä—É–≥–∏—Ö API
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ JWT —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω –¥–ª—è –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### **3. Frontend –∫–æ–¥ TON –¥–µ–ø–æ–∑–∏—Ç–∞**:
```javascript
// TonDepositCard.tsx:112-124
const response = await fetch('/api/v2/wallet/ton-deposit', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('unifarm_jwt_token')}`
  },
  body: JSON.stringify({
    user_id: userId,           // ‚ùì –ú–æ–∂–µ—Ç –±—ã—Ç—å undefined
    ton_tx_hash: result.txHash,
    amount: depositAmount,
    wallet_address: walletAddress
  })
});
```

---

## üî¨ –ì–ò–ü–û–¢–ï–ó–´ –ö–û–†–ù–ï–í–´–• –ü–†–ò–ß–ò–ù

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 1: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è getWalletAddress**
```javascript
// TonDepositCard.tsx:42
const userFriendlyAddress = await getWalletAddress(tonConnectUI);
```
**–ü—Ä–æ–±–ª–µ–º–∞**: –§—É–Ω–∫—Ü–∏—è `getWalletAddress` –ù–ï –ò–ú–ü–û–†–¢–ò–†–û–í–ê–ù–ê, –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å `getTonWalletAddress`

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 2: userId undefined –≤ context**
```javascript
// TonDepositCard.tsx:23
const { userId, tonBalance, refreshBalance } = useUser();
```
**–†–∏—Å–∫**: –ï—Å–ª–∏ `userId` undefined, backend –ø–æ–ª—É—á–∞–µ—Ç `user_id: undefined`

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 3: –û—à–∏–±–∫–∞ —ç–º—É–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**
```javascript
// tonConnectService.ts:399-404
const emulationResult = await emulateTonTransaction(tonConnectUI, transaction);
if (!emulationResult) {
  throw new Error('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é');
}
```
**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å**: –í—ã—Å–æ–∫–∞—è - —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é"

---

## üõ†Ô∏è –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ò–ï –î–ï–ô–°–¢–í–ò–Ø

### **–î–µ–π—Å—Ç–≤–∏–µ 1**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º–ø–æ—Ä—Ç getWalletAddress
```bash
grep -n "getWalletAddress" client/src/components/wallet/TonDepositCard.tsx
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –§—É–Ω–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–æ –ù–ï –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞

### **–î–µ–π—Å—Ç–≤–∏–µ 2**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å userId –≤ UserContext
```javascript
// –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç userId: 184 –∞–∫—Ç–∏–≤–µ–Ω
"[correctApiRequest] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞",{"url":"/api/v2/uni-farming/status?user_id=184"
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ userId –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω

### **–î–µ–π—Å—Ç–≤–∏–µ 3**: –ù–∞–π—Ç–∏ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –≤ –∫–æ–¥–µ
```bash
grep -r "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å" client/src/
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ù–µ –Ω–∞–π–¥–µ–Ω–æ - –æ—à–∏–±–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ TON Connect UI –∏–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ

---

## üìä –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –° –ü–†–ï–î–´–î–£–©–ò–ú–ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø–ú–ò

### **–ü—Ä–æ–±–ª–µ–º—ã –ù–ï —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –§–∞–∑–∞–º–∏ 1-2**:
1. **TonDepositCard.tsx** - –ù–ï –∏–∑–º–µ–Ω—è–ª—Å—è –≤ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö
2. **sendTonTransaction()** - –ù–ï –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–ª—Å—è 
3. **emulateTonTransaction()** - –ù–ï –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª—Å—è
4. **createBocWithComment()** - –û—Å—Ç–∞–ª—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### **–í—ã–≤–æ–¥**: 
–ù–æ–≤–∞—è –æ—à–∏–±–∫–∞ –ù–ï —Å–≤—è–∑–∞–Ω–∞ —Å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏. –≠—Ç–æ –ù–ï–ó–ê–í–ò–°–ò–ú–ê–Ø –ø—Ä–æ–±–ª–µ–º–∞ –≤:
- –õ–æ–≥–∏–∫–µ TON —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π 
- –≠–º—É–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –ò–º–ø–æ—Ä—Ç–∞—Ö —Ñ—É–Ω–∫—Ü–∏–π

---

## üéØ –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### **–ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è**:
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç `getWalletAddress` ‚Üí `getTonWalletAddress`
2. üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `emulateTonTransaction()` 
3. üîç –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ TON Connect
4. üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –≤ backend endpoint

### **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Ö–æ–¥–∫–∞**:
```javascript
// –û–®–ò–ë–ö–ê: getWalletAddress –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢
const userFriendlyAddress = await getWalletAddress(tonConnectUI);

// –ü–†–ê–í–ò–õ–¨–ù–û: getTonWalletAddress
const userFriendlyAddress = await getTonWalletAddress(tonConnectUI);
```

---

## ‚ö†Ô∏è –°–¢–ê–¢–£–°: –ù–û–í–ê–Ø –ù–ï–ó–ê–í–ò–°–ò–ú–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

**–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–æ–≤–∞—è –æ—à–∏–±–∫–∞ –≤ TON –¥–µ–ø–æ–∑–∏—Ç–∞—Ö, –ù–ï —Å–≤—è–∑–∞–Ω–Ω–∞—è —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ –§–∞–∑ 1-2. –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ - –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –∏–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ `getWalletAddress` –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —ç–º—É–ª—è—Ü–∏–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã**: –°–Ω–∏–∂–∞–µ—Ç—Å—è —Å 96% –¥–æ 90% –∏–∑-–∑–∞ –Ω–æ–≤–æ–π –ø—Ä–æ–±–ª–µ–º—ã.

---

*–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.*