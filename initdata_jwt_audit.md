# –ê—É–¥–∏—Ç –ø–µ—Ä–µ–¥–∞—á–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ initData JWT –≤ UniFarm Mini App

## üìÖ –î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞: 12 —è–Ω–≤–∞—Ä—è 2025

## üéØ –¶–µ–ª—å –∞—É–¥–∏—Ç–∞
–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, —á—Ç–æ initData JWT –∏–∑ Telegram Mini-App:
1. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ
2. –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –Ω–∞ backend –±–µ–∑ –ø–æ—Ç–µ—Ä—å –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
3. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏ (HMAC-SHA256 —Å Bot Token)
4. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ (start_param) –∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞—É–¥–∏—Ç–∞

| –≠—Ç–∞–ø | OK? | –§–∞–π–ª / –°—Ç—Ä–æ–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------|-----|---------------|-------------|
| initData —á–∏—Ç–∞–µ—Ç—Å—è | ‚úÖ | client/src/hooks/useTelegram.ts:51 | `setInitData(tg.initData)` - —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ Telegram WebApp |
| initData –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π | ‚úÖ | client/src/App.tsx:131-137 | –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∏ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞ |
| –ü–æ–¥–ø–∏—Å—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è | ‚úÖ | utils/telegram.ts:48-145 | HMAC-SHA256 –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É Telegram |
| start_param –∑–∞–ø–∏—Å–∞–Ω | ‚ùå | - | start_param –ù–ï –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ initData |

## üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

### 1. –§—Ä–æ–Ω—Ç–µ–Ω–¥ - —á—Ç–µ–Ω–∏–µ initData

**–§–∞–π–ª:** `client/src/hooks/useTelegram.ts`
```typescript
useEffect(() => {
  const tg = window.Telegram?.WebApp;
  
  if (tg) {
    tg.ready();
    setIsReady(true);
    setUser(tg.initDataUnsafe.user || null);
    setInitData(tg.initData); // –°—Ç—Ä–æ–∫–∞ 51
    tg.expand();
  }
}, []);
```
‚úÖ **–í—ã–≤–æ–¥:** initData –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ Telegram WebApp API

### 2. Network Layer - –ø–µ—Ä–µ–¥–∞—á–∞ –Ω–∞ backend

**–§–∞–π–ª:** `client/src/App.tsx`
```typescript
const response = await fetch('/api/v2/auth/telegram', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-Telegram-Init-Data': window.Telegram.WebApp.initData // –ó–∞–≥–æ–ª–æ–≤–æ–∫
  },
  body: JSON.stringify({
    initData: window.Telegram.WebApp.initData, // –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
    ref_by: refCode || undefined
  })
});
```
‚úÖ **–í—ã–≤–æ–¥:** initData –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–≤–∞–∂–¥—ã - –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∏ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞

### 3. Backend - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏

**–§–∞–π–ª:** `utils/telegram.ts`
```typescript
export function validateTelegramInitData(initData: string, botToken: string): ValidationResult {
  // ...
  // –°–æ–∑–¥–∞–µ–º —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á
  const secretKey = crypto
    .createHmac('sha256', 'WebAppData')
    .update(botToken)
    .digest();

  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–∂–∏–¥–∞–µ–º—ã–π —Ö–µ—à
  const expectedHash = crypto
    .createHmac('sha256', secretKey)
    .update(sortedParams)
    .digest('hex');

  if (expectedHash !== hash) {
    return { valid: false, error: 'Invalid signature' };
  }
  // ...
}
```
‚úÖ **–í—ã–≤–æ–¥:** –ü–æ–¥–ø–∏—Å—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º—É –∞–ª–≥–æ—Ä–∏—Ç–º—É Telegram

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ auth_date (–Ω–µ —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞)
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ user –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π (id, first_name)

### 4. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏ start_param

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û:**

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä `ref_by` –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞
- –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏: ref_code, refCode –∏–∑ URL, sessionStorage
- –§—É–Ω–∫—Ü–∏—è getReferrerIdFromUrl() –≤ utils.ts –£–ú–ï–ï–¢ –∏–∑–≤–ª–µ–∫–∞—Ç—å start_param, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ App.tsx

**–§–∞–π–ª:** `modules/auth/service.ts:160`
```typescript
userInfo = await this.findOrCreateFromTelegram({
  telegram_id: telegramUser.id,
  username: telegramUser.username,
  first_name: telegramUser.first_name,
  ref_by: options.ref_by // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ref_by –∏–∑ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
});
```

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫:**
- `?ref_code=REF_123` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç
- `?refCode=REF_123` - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç  
- `?start=userXXX` - legacy —Ñ–æ—Ä–º–∞—Ç
- `?startapp=REF_123` - Telegram —Ñ–æ—Ä–º–∞—Ç
- `window.Telegram.WebApp.startParam` - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Telegram API

## üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤
- –°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ref_by –∏–∑ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤–º–µ—Å—Ç–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è start_param –∏–∑ initData
- –≠—Ç–æ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤
- –§—É–Ω–∫—Ü–∏—è getReferrerIdFromUrl() –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é, –Ω–æ –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫

### 2. –î–≤–æ–π–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ initData
- initData –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ, –∏ –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞ - —ç—Ç–æ –∏–∑–±—ã—Ç–æ—á–Ω–æ
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è start_param
- –í –ª–æ–≥–∞—Ö –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ/–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ start_param –≤ initData

## üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ò–∑–≤–ª–µ—á—å start_param –∏–∑ initData:**
   ```typescript
   // –í validateTelegramInitData –¥–æ–±–∞–≤–∏—Ç—å:
   const startParam = urlParams.get('start_param');
   if (startParam) {
     data.start_param = startParam;
   }
   ```

2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å start_param –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏:**
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: start_param > ref_by –∏–∑ body > URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

3. **–£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥–∞—á–∏ initData:**
   - –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ X-Telegram-Init-Data

4. **–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ start_param:**
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ª–∏—á–∏–µ –∏ –∑–Ω–∞—á–µ–Ω–∏–µ start_param –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚úÖ **–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è HMAC-SHA256 –≤–∞–ª–∏–¥–∞—Ü–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞ (1 —á–∞—Å)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

‚ö†Ô∏è **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ú–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ª–æ–≥–∞—Ö (hash, user id)
- –î–æ–±–∞–≤–∏—Ç—å rate limiting –Ω–∞ endpoint –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üìä –ò—Ç–æ–≥–æ–≤—ã–π –≤—ã–≤–æ–¥

**–ü–µ—Ä–µ–¥–∞—á–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ initData JWT –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –Ω–∞ 100%:**
- ‚úÖ –ß—Ç–µ–Ω–∏–µ, –ø–µ—Ä–µ–¥–∞—á–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ ref_by –ø–∞—Ä–∞–º–µ—Ç—Ä
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
- ‚ö†Ô∏è –ï—Å—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ getReferrerIdFromUrl())

**–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.** –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ - —ç—Ç–æ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤, –∞ –Ω–µ –æ—à–∏–±–∫–∞ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.