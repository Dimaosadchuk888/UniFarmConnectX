# Инструкция по интеграции исправлений в UniFarm

## Обзор проблем и решений

В результате проведенного аудита выявлены следующие критические проблемы:

1. **Проблемы подключения к базе данных**:
   - Нестабильное подключение к Neon DB
   - Попытки подключения через Unix socket
   - Отсутствие механизма принудительного выбора Neon DB

2. **Проблемы с CORS**:
   - Использование `Access-Control-Allow-Origin: *` несовместимо с credentials
   - Отсутствует `Access-Control-Allow-Credentials: true`, необходимый для cookies
   - Некорректная обработка Telegram-специфичных заголовков

3. **Проблемы с сессиями**:
   - Отсутствие таблицы sessions для хранения сессий
   - Некорректная настройка cookies (sameSite, secure)
   - Отсутствие механизма авторизации через Telegram

## Подготовленные модули исправлений

1. **db-selector-fix.js** - Исправление подключения к базе данных
2. **integration.js** - Интеграционный модуль, объединяющий все исправления

## Шаги по интеграции

### Шаг 1: Добавление фикса для базы данных

В самом начале `server/index.ts` перед всеми другими импортами добавить:

```typescript
// Первым делом применяем фикс для базы данных
import '../db-selector-fix';
```

### Шаг 2: Интеграция исправлений в маршруты

В файле `server/routes.ts` перед вызовом функции `registerRoutes` добавить:

```typescript
// Применяем улучшения для CORS, сессий и аутентификации Telegram
import { applyAllImprovements } from '../integration';
app = applyAllImprovements(app);
```

### Шаг 3: Проверка работоспособности

После внесения изменений необходимо выполнить следующие проверки:

1. **Проверка подключения к БД**:
   - Откройте URL `/api/diag/db`
   - Должен вернуться JSON с информацией о подключении

2. **Проверка CORS**:
   - Откройте URL `/api/diag/cors`
   - Проверьте заголовки в ответе

3. **Проверка сессий**:
   - Откройте URL `/api/diag/session`
   - При повторных обращениях счетчик views должен увеличиваться

4. **Проверка авторизации Telegram**:
   - Откройте приложение внутри Telegram Mini App
   - Убедитесь, что авторизация работает корректно

## Рекомендации по поддержке

1. **Мониторинг логов**:
   - Следите за сообщениями "[Integration]" в логах
   - Ошибки подключения к БД будут отмечены "[Database Fix]"

2. **Обновление исправлений**:
   - При необходимости обновить только фикс для БД, достаточно обновить файл db-selector-fix.js
   - Для обновления всех исправлений обновите integration.js

3. **Долгосрочное решение**:
   - Рекомендуется впоследствии создать миграцию для добавления недостающих таблиц
   - Для повышения безопасности рекомендуется изменить SESSION_SECRET на уникальное значение

## Возможные проблемы и их решения

1. **Проблема**: Ошибка при подключении к БД после интеграции
   **Решение**: Проверьте, что файл db-selector-fix.js импортируется в самом начале server/index.ts

2. **Проблема**: CORS по-прежнему блокирует запросы с credentials
   **Решение**: Проверьте, что applyAllImprovements вызывается до регистрации маршрутов

3. **Проблема**: Не создается таблица sessions
   **Решение**: Создайте таблицу вручную с помощью SQL-запроса из скрипта integration.js

4. **Проблема**: Авторизация Telegram не работает
   **Решение**: Проверьте наличие переменной окружения TELEGRAM_BOT_TOKEN