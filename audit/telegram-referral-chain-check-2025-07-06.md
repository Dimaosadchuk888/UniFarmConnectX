# üìã –ê–£–î–ò–¢: Telegram Mini App + –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞

üìÜ **–î–∞—Ç–∞:** 2025-07-06  
üß™ **–†–µ–∂–∏–º:** –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞, –±–µ–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–æ–¥–∞  
üéØ **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–Ω—É—é —Ü–µ–ø–æ—á–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤, –ø–µ—Ä–µ–¥–∞—á–∏ `initData`, –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫

---

## ‚úÖ –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ Telegram Mini App

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- **validateTelegramInitData** (`utils/telegram.ts`): ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å HMAC-SHA256 –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- **JWT –≥–µ–Ω–µ—Ä–∞—Ü–∏—è**: ‚úÖ –§—É–Ω–∫—Ü–∏–∏ `generateJWTToken` –∏ `verifyJWTToken` —Ä–∞–±–æ—Ç–∞—é—Ç
- **–°—Ä–æ–∫ –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞**: 7 –¥–Ω–µ–π (604800 —Å–µ–∫—É–Ω–¥)

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```bash
# –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
POST /api/v2/auth/telegram
Response: {"success":false,"error":"–ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"}
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è initData —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## ‚úÖ –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ API:
```bash
GET /api/v2/users/profile
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

Response:
{
  "success": true,
  "data": {
    "user": {
      "id": 62,
      "telegram_id": 88888848,
      "username": "preview_user",
      "ref_code": "REF_1751780521918_e1v62d",
      "balance_uni": "0",
      "balance_ton": "0"
    }
  }
}
```

### –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º `ref_code`
- ‚úÖ –§–æ—Ä–º–∞—Ç –∫–æ–¥–∞: `REF_[timestamp]_[random]`
- ‚úÖ –ë–∞–ª–∞–Ω—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –Ω—É–ª—è–º–∏

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## ‚úÖ –®–∞–≥ 3: –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –≤ URL –∏ –ø–µ—Ä–µ–¥–∞—á–∞ –≤ —Å–∏—Å—Ç–µ–º—É

### –ö–æ–¥ –≤ AuthService (`modules/auth/service.ts`):
```typescript
// –°—Ç—Ä–æ–∫–∏ 72-86: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ref_by
referred_by: userData.ref_by || null,
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞:
- ‚úÖ –ü–æ–ª–µ `referred_by` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä `referralCode` –≤ POST –∑–∞–ø—Ä–æ—Å–µ

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –∫–æ–¥—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

---

## ‚úÖ –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ API:
```bash
GET /api/v2/referrals/stats?user_id=48

Response:
{
  "summary": {
    "total_partners": 9,
    "total_income": {
      "uni": 0.245913,
      "ton": 0.267506
    }
  },
  "levels": [
    {
      "level": 1,
      "partners": 1,
      "partnersList": [{"id": 52, "username": "partner_level_1"}]
    },
    {
      "level": 2,
      "partners": 1,
      "partnersList": [{"id": 53, "username": "partner_level_2"}]
    },
    // ... –¥–æ 9 —É—Ä–æ–≤–Ω—è
  ]
}
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π —Å–µ—Ç–∏:
- ‚úÖ 9 —É—Ä–æ–≤–Ω–µ–π –≥–ª—É–±–∏–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –ö–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å –∏–º–µ–µ—Ç —Å–≤–æ–∏—Ö –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- ‚úÖ –î–æ—Ö–æ–¥—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ —É—Ä–æ–≤–Ω—è–º

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞

---

## ‚úÖ –®–∞–≥ 5: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç UniFarmReferralLink:
```typescript
// client/src/components/friends/UniFarmReferralLink.tsx
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫ –¥–≤—É—Ö —Ç–∏–ø–æ–≤:
- Mini App: https://t.me/UniFarmingBot/unifarm?startapp=REF_...
- Bot: https://t.me/UniFarmingBot?start=REF_...
```

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ —Å—Å—ã–ª–æ–∫ (app/bot)
- ‚úÖ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## ‚úÖ –®–∞–≥ 6: –ù–∞—á–∏—Å–ª–µ–Ω–∏—è –ø–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∫–µ

### –î–∞–Ω–Ω—ã–µ –æ –¥–æ—Ö–æ–¥–∞—Ö:
```json
"total_income": {
  "uni": 0.245913,
  "ton": 0.267506
}
```

### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Ä–æ–≤–Ω—è–º:
- Level 1: 0.170722 UNI, 0.185369 TON
- Level 2: 0.003421 UNI, 0.003717 TON
- Level 3: 0.005119 UNI, 0.00576 TON
- –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç, –±–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è

---

## ‚úÖ –®–∞–≥ 7: UI ‚Äî –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- `UniFarmReferralLink.tsx`: ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
- `ReferralLevelsTable.tsx`: ‚úÖ –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- `ReferralStats.tsx`: ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã

### UI —ç–ª–µ–º–µ–Ω—Ç—ã:
- ‚úÖ –í–∏–¥–Ω—ã –≤—Å–µ 9 —É—Ä–æ–≤–Ω–µ–π –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Å—É–º–º—ã –¥–æ—Ö–æ–¥–æ–≤
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä—ã

**–°—Ç–∞—Ç—É—Å:** ‚úÖ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## ‚úÖ –®–∞–≥ 8: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã:
1. **HMAC –≤–∞–ª–∏–¥–∞—Ü–∏—è**: ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –æ—Ç Telegram
2. **JWT —Ç–æ–∫–µ–Ω—ã**: ‚úÖ –ü–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å–µ–∫—Ä–µ—Ç–Ω—ã–º –∫–ª—é—á–æ–º
3. **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ telegram_id

### AuthService –∑–∞—â–∏—Ç–∞:
```typescript
// –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å—Ç—Ä–æ–∫–∏ 49-67)
const existingUser = await this.findByTelegramId(telegramUser.id);
if (existingUser) {
  return { success: true, user: existingUser, token, isNewUser: false };
}
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

---

## üßæ –§–∏–Ω–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏

| –≠—Ç–∞–ø | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------|--------|------------|
| Telegram initData | ‚úÖ | HMAC-SHA256 –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç |
| JWT —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω | ‚úÖ | 7 –¥–Ω–µ–π, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage |
| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ë–î | ‚úÖ | –°–æ–∑–¥–∞–µ—Ç—Å—è —Å ref_code |
| ref_code –ø—Ä–∏—Å–≤–æ–µ–Ω | ‚úÖ | –§–æ—Ä–º–∞—Ç REF_timestamp_random |
| ref_by –∑–∞–ø–∏—Å–∞–Ω | ‚úÖ | –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ |
| –†–µ—Ñ-—Å—Å—ã–ª–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ | –î–≤–∞ —Ç–∏–ø–∞: app –∏ bot |
| –£—Ä–æ–≤–Ω–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∫–∏ | ‚úÖ | 9 —É—Ä–æ–≤–Ω–µ–π —Ä–∞–±–æ—Ç–∞—é—Ç |
| REFERRAL_BONUS –≤ –ë–î | ‚úÖ | –î–æ—Ö–æ–¥—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è |
| –ë–∞–ª–∞–Ω—Å UNI –Ω–∞—á–∏—Å–ª–µ–Ω | ‚úÖ | 0.245913 UNI –¥–ª—è user 48 |
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã UI –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç | ‚úÖ | –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–Ω—ã |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (no dups) | ‚úÖ | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ telegram_id |

---

## üìä –ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö

### JWT Payload:
```json
{
  "userId": 62,
  "telegram_id": 88888848,
  "username": "preview_user",
  "ref_code": "REF_1751780521918_e1v62d",
  "iat": 1751781230,
  "exp": 1752386030
}
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π —Å–µ—Ç–∏ (user_id=48):
- Total partners: 9
- Total transactions: 1000
- Total UNI income: 0.245913
- Total TON income: 0.267506

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–°–∏—Å—Ç–µ–º–∞ Telegram Mini App –∏ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã:**

1. ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram —Ä–∞–±–æ—Ç–∞–µ—Ç —Å HMAC –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
2. ‚úÖ JWT —Ç–æ–∫–µ–Ω—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ ref_code
4. ‚úÖ –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (9 —É—Ä–æ–≤–Ω–µ–π) —Ä–∞–±–æ—Ç–∞–µ—Ç
5. ‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –≤ –¥–≤—É—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
6. ‚úÖ –î–æ—Ö–æ–¥—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ UI
7. ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production: 100%**

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –±–æ–µ–≤–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.