# –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –†–ï–§–ï–†–ê–õ–¨–ù–û–ô –°–ò–°–¢–ï–ú–´

## üéØ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –í PROCESSREFERRALINLINE() –ò–°–ü–†–ê–í–õ–ï–ù–ê
**–ú–æ–¥—É–ª—å**: `modules/auth/service.ts`

**–ü—Ä–æ–±–ª–µ–º—ã –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã**:
1. **–¢–∏–ø–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**:
   - `user_id: newUserId` ‚Üí `user_id: parseInt(newUserId)`
   - `reward_uni: 0` ‚Üí `reward_uni: '0'` (—Å—Ç—Ä–æ–∫–æ–≤—ã–π —Ç–∏–ø –¥–ª—è Supabase)
   - `reward_ton: 0` ‚Üí `reward_ton: '0'`

2. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫**:
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ –ø–æ–ª—è Supabase error (code, details, hint)
   - –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è INSERT –æ–ø–µ—Ä–∞—Ü–∏–π
   - –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏

3. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**:
   - –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ç–∏–ø –ø—Ä–æ—Ü–µ—Å—Å–∞ (`processMethod: 'processReferralInline'`)
   - –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å–ø–µ—Ö–µ –æ–ø–µ—Ä–∞—Ü–∏–π
   - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –æ—à–∏–±–æ–∫

### ‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ò–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –°–û–ó–î–ê–ù–´

1. **`test_referral_system_fix.js`**
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º–∏ –∫–æ–¥–∞–º–∏
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è `referred_by` –ø–æ–ª—è
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ `referrals`

2. **`check_supabase_rls_permissions.js`**
   - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Row Level Security –ø—Ä–∞–≤
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–æ–≤ –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
   - SQL –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è RLS policies

3. **`comprehensive_referral_diagnosis.cjs`**
   - –ê–Ω–∞–ª–∏–∑ —Ñ–∞–Ω—Ç–æ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π 186-190
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
   - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ü–µ–ø–æ—á–∫–∏ `buildReferrerChain()`

4. **`verify_referral_fix.cjs`**
   - –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–±–ª–µ–º –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
   - –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

## üîç –ö–û–†–ù–ï–í–´–ï –ü–†–ò–ß–ò–ù–´ –ü–†–û–ë–õ–ï–ú

### 1. SUPABASE –¢–ò–ü–ò–ó–ê–¶–ò–Ø ‚ùå‚Üí‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö —Å—Ö–µ–º–µ –ë–î
- PostgreSQL –æ–∂–∏–¥–∞–µ—Ç INTEGER –¥–ª—è `user_id`
- VARCHAR –¥–ª—è `reward_uni/ton` –ø–æ–ª–µ–π
- –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –≤ Supabase API

**–†–µ—à–µ–Ω–∏–µ**: –Ø–≤–Ω–æ–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –≤–æ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

### 2. –ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ‚ùå‚Üí‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞**: –û—à–∏–±–∫–∏ Supabase –Ω–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å
**–†–µ—à–µ–Ω–∏–µ**: –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª–µ–π error –æ–±—ä–µ–∫—Ç–∞

### 3. RLS –ü–†–ê–í–ê (–ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê) ‚ö†Ô∏è
**–í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞**: Row Level Security –±–ª–æ–∫–∏—Ä—É–µ—Ç INSERT
**–†–µ—à–µ–Ω–∏–µ**: SQL –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö policies

## üß™ –ü–õ–ê–ù –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### –≠—Ç–∞–ø 1: –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
```bash
node start-unifarm.cjs
```

### –≠—Ç–∞–ø 2: –ë—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –û—Ç–∫—Ä—ã—Ç—å DevTools Console
2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å `test_referral_system_fix.js`
3. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞

### –≠—Ç–∞–ø 3: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ RLS (–ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
1. –í—ã–ø–æ–ª–Ω–∏—Ç—å `check_supabase_rls_permissions.js`
2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –∫–æ–º–∞–Ω–¥—ã –¥–ª—è RLS policies
3. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –≠—Ç–∞–ø 4: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `referred_by` –≤ —Ç–∞–±–ª–∏—Ü–µ users (–Ω–µ null)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ referrals (–Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏)
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å `buildReferrerChain()` —Å –Ω–æ–≤—ã–º–∏ —Å–≤—è–∑—è–º–∏

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚ùå `referred_by = null` –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚ùå –ü—É—Å—Ç–∞—è —Ç–∞–±–ª–∏—Ü–∞ `referrals`
- ‚ùå `buildReferrerChain()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç—ã–µ —Ü–µ–ø–æ—á–∫–∏
- ‚ùå –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–º —Å–≤—è–∑—è–º

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ `referred_by = referrer_id` –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ó–∞–ø–∏—Å–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `referrals`
- ‚úÖ `buildReferrerChain()` –Ω–∞—Ö–æ–¥–∏—Ç —Ü–µ–ø–æ—á–∫–∏
- ‚úÖ `distributeReferralRewards()` –Ω–∞—á–∏—Å–ª—è–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã
- ‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 95-100%

## üöÄ –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã:
1. –¢–∏–ø–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Supabase
2. –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
3. –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å–∫—Ä–∏–ø—Ç—ã —Å–æ–∑–¥–∞–Ω—ã
4. SQL –∫–æ–º–∞–Ω–¥—ã –¥–ª—è RLS –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã

### ‚è≥ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
3. –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –ª–æ–≥–æ–≤
4. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

---

**–°–¢–ê–¢–£–°**: ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ó–ê–í–ï–†–®–ï–ù–´ - –ì–û–¢–û–í –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ
**–ü–†–ò–û–†–ò–¢–ï–¢**: –í–´–°–û–ö–ò–ô - –¢—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
**–û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢**: –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞—á–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ 95-100%