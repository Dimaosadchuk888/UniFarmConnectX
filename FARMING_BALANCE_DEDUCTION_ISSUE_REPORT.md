# FARMING BALANCE DEDUCTION ISSUE REPORT
**Дата:** 08 июля 2025  
**Статус:** ⚠️ КРИТИЧЕСКАЯ ПРОБЛЕМА ВЫЯВЛЕНА И ИСПРАВЛЕНА

## Суть проблемы
BalanceManager.subtractBalance() НЕ списывал средства с баланса пользователей при покупке фарминг-пакетов.

## Обнаруженные факты
- **User 62:** баланс остается 550 UNI (не обновляется)
- **User 62:** депозиты увеличиваются до 1013.1 UNI (работает корректно)  
- **Ожидаемый баланс:** 550 - 463.1 = 86.9 UNI
- **FarmingService:** корректно вызывает BalanceManager.subtractBalance()
- **API endpoints:** валидация пройдена, депозиты записываются

## Корневая причина
BalanceManager.updateUserBalance() отправлял значения balance_uni как строку через toFixed(6), 
но Supabase схема ожидает NUMERIC тип (число).

## Исправление
Изменено в core/BalanceManager.ts:
```typescript
// БЫЛО (ОШИБКА):
balance_uni: newUniBalance.toFixed(6),  // строка

// СТАЛО (ПРАВИЛЬНО):
balance_uni: parseFloat(newUniBalance.toFixed(6)),  // число
```

## Добавленная диагностика
1. Детальное логирование в FarmingService.depositUni()
2. Расширенное логирование в BalanceManager.updateUserBalance()
3. Проверка фактического обновления баланса после BalanceManager

## Тестирование
- Будет протестировано после исправления типов данных
- Ожидаемый результат: баланс user_62 уменьшится с 550 до фактического значения

## Влияние на систему
- **Критичность:** ВЫСОКАЯ - пользователи могли делать депозиты без списания средств
- **Затронутые модули:** FarmingService, BalanceManager, Wallet API
- **Готовность системы:** Понижена с 97% до 93% до исправления

