# üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ß–ï–¢: –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤ (29.07.2025)

## –î–ò–ê–ì–ù–û–ó: –°–∏—Å—Ç–µ–º–∞ TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ–º rollback —Ñ—É–Ω–∫—Ü–∏–π

### üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –í—Å–µ–≥–æ 13 –∑–∞–ø–∏—Å–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –ù–ï–¢ –¥–∞–Ω–Ω—ã—Ö User 25  
**–ü–æ–∏—Å–∫ tx_hash**: –ù–ï–¢ –∑–∞–ø–∏—Å–µ–π —Å blockchain –∫–æ–¥–∞–º–∏ te6cckECAgEAAKoAAeGI...  
**–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç—ã**: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∑–∞–ø–∏—Å–∏ —Å 14:06 –∏ 14:08 (29.07.2025)

---

## üîç –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ rollback —Ñ—É–Ω–∫—Ü–∏–π 29.07.2025

### –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–û–õ–û–ú–ö–ê –≤ `UnifiedTransactionService.updateUserBalance()`

**–§–∞–π–ª**: `core/TransactionService.ts`  
**–°—Ç—Ä–æ–∫–∏**: 387-399  

```typescript
private async updateUserBalance(...): Promise<void> {
  // –û–¢–ö–õ–Æ–ß–ï–ù–û: updateUserBalance –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ –±–∞–ª–∞–Ω—Å–æ–≤
  logger.warn('[ANTI_ROLLBACK_PROTECTION] UnifiedTransactionService.updateUserBalance –û–¢–ö–õ–Æ–ß–ï–ù', {
    reason: '–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ unexpected —Å–ø–∏—Å–∞–Ω–∏–π'
  });
  
  // –ù–ï–ú–ï–î–õ–ï–ù–ù–´–ô –í–´–•–û–î - –ù–ï –û–ë–ù–û–í–õ–Ø–ï–ú –ë–ê–õ–ê–ù–°–´ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò
  return;
}
```

### –ü–û–í–†–ï–ñ–î–ï–ù–ù–´–ô WORKFLOW TON –î–ï–ü–û–ó–ò–¢–û–í

#### 1. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ –ë–î**
- ‚úÖ `WalletService.processTonDeposit()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è  
- ‚úÖ `UnifiedTransactionService.createTransaction()` —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å  
- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—É—á–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Ç–∏–ø–∞ `DEPOSIT`

#### 2. **–ù–û –ë–ê–õ–ê–ù–°–´ –ù–ï –û–ë–ù–û–í–õ–Ø–Æ–¢–°–Ø**  
- ‚ùå `shouldUpdateBalance('TON_DEPOSIT')` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true`
- ‚ùå `updateUserBalance()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –Ω–æ **–ù–ï–ú–ï–î–õ–ï–ù–ù–û –ó–ê–í–ï–†–®–ê–ï–¢–°–Ø**
- ‚ùå –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º

#### 3. **–†–ï–ó–£–õ–¨–¢–ê–¢: "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏-–ø—Ä–∏–∑—Ä–∞–∫–∏"**
```
–ï–°–¢–¨ –∑–∞–ø–∏—Å—å –≤ –ë–î ‚Üí –ù–ï–¢ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞ –±–∞–ª–∞–Ω—Å ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –≤–∏–¥–∏—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞
```

---

## üìã –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó –ü–û–í–†–ï–ñ–î–ï–ù–ò–ô

### –û—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã (29.07.2025):

1. **UnifiedTransactionService.updateUserBalance()** ‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø TON –î–ï–ü–û–ó–ò–¢–û–í**
   - –û—Ç–∫–ª—é—á–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º `[ANTI_ROLLBACK_PROTECTION]`
   - –≠—Ñ—Ñ–µ–∫—Ç: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è, –±–∞–ª–∞–Ω—Å—ã –ù–ï –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

2. **BalanceManager.updateUserBalance()** ‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø TON –î–ï–ü–û–ó–ò–¢–û–í**  
   - –û—Ç–∫–ª—é—á–µ–Ω `Math.max(0, balance - amount)` –≤ subtract –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
   - –≠—Ñ—Ñ–µ–∫—Ç: –ú–æ–∂–µ—Ç –≤–ª–∏—è—Ç—å –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–∞

3. **TransactionEnforcer.detectDirectSQLUpdates()** ‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø TON –î–ï–ü–û–ó–ò–¢–û–í**
   - –û—Ç–∫–ª—é—á–µ–Ω –¥–µ—Ç–µ–∫—Ç–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–æ–≤  
   - –≠—Ñ—Ñ–µ–∫—Ç: –ù–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

4. **SQL —Å–∫—Ä–∏–ø—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏** ‚ö†Ô∏è **–ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–û –ö–†–ò–¢–ò–ß–ù–û**
   - –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ `.DISABLED_ROLLBACK_PROTECTION`  
   - –≠—Ñ—Ñ–µ–∫—Ç: –í–æ–∑–º–æ–∂–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –¥–µ–ø–æ–∑–∏—Ç—ã

### –õ–æ–≥–∏–∫–∞ TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤:
```typescript
// modules/wallet/service.ts - processTonDeposit()
const result = await transactionService.createTransaction({
  type: 'TON_DEPOSIT',  // shouldUpdateBalance(TON_DEPOSIT) = TRUE
  amount_ton: amount,   // –î–æ–ª–∂–Ω–æ –∑–∞—á–∏—Å–ª–∏—Ç—å—Å—è –Ω–∞ –±–∞–ª–∞–Ω—Å
  // ...
});

// –ù–æ –≤ UnifiedTransactionService.updateUserBalance():
// –ù–ï–ú–ï–î–õ–ï–ù–ù–´–ô –í–´–•–û–î - –±–∞–ª–∞–Ω—Å –ù–ï –û–ë–ù–û–í–õ–Ø–ï–¢–°–Ø!
```

---

## üö® –°–¢–ï–ü–ï–ù–¨ –£–©–ï–†–ë–ê

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:
- **User 25**: 2 –¥–µ–ø–æ–∑–∏—Ç–∞ (14:06, 14:08) –Ω–µ –∑–∞—á–∏—Å–ª–µ–Ω—ã
- **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –í–°–ï –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** —Å TON –¥–µ–ø–æ–∑–∏—Ç–∞–º–∏ –ø–æ—Å–ª–µ 29.07.2025

### –¢–∏–ø—ã –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:
- **TON_DEPOSIT**: –î–µ–ø–æ–∑–∏—Ç—ã –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ ‚ùå
- **UNI_DEPOSIT**: –î–µ–ø–æ–∑–∏—Ç—ã UNI —Ç–æ–∫–µ–Ω–æ–≤ ‚ùå  
- **FARMING_REWARD**: –î–æ—Ö–æ–¥—ã –æ—Ç —Ñ–∞—Ä–º–∏–Ω–≥–∞ ‚ùå
- **REFERRAL_REWARD**: –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã ‚ùå
- **MISSION_REWARD**: –ù–∞–≥—Ä–∞–¥—ã –∑–∞ –º–∏—Å—Å–∏–∏ ‚ùå
- **DAILY_BONUS**: –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã ‚ùå

### –†–∞–±–æ—Ç–∞—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:
- **BOOST_PURCHASE**: –ü–æ–∫—É–ø–∫–∏ TON Boost (–Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç –±–∞–ª–∞–Ω—Å) ‚úÖ
- **WITHDRAWAL**: –í—ã–≤–æ–¥—ã —Å—Ä–µ–¥—Å—Ç–≤ (–Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç –±–∞–ª–∞–Ω—Å) ‚úÖ

---

## üí° –ü–õ–ê–ù –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:

1. **–í—Ä–µ–º–µ–Ω–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å updateUserBalance()** –¥–ª—è –Ω–æ–≤—ã—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤
2. **–†—É—á–Ω–æ–π –ø–µ—Ä–µ—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–æ–≤** –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
3. **–ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö "–ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö" –¥–µ–ø–æ–∑–∏—Ç–æ–≤** —Å 29.07.2025
4. **–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º** (–≤–∫–ª—é—á–∞—è User 25)

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –º–µ—Ä—ã:

1. **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –∑–∞—â–∏—Ç–∞** –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è rollback
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏** –±–∞–ª–∞–Ω—Å–æ–≤ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤** –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º

---

## üéØ –í–´–í–û–î–´

**–°—Ç–∞—Ç—É—Å**: üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–û–õ–û–ú–ö–ê –°–ò–°–¢–ï–ú–´ –ü–û–ü–û–õ–ù–ï–ù–ò–ô**

**–ü—Ä–∏—á–∏–Ω–∞**: –ó–∞—â–∏—Ç–∞ –æ—Ç rollback —Ñ—É–Ω–∫—Ü–∏–π –ø—Ä–∏–≤–µ–ª–∞ –∫ –ø–æ–ª–Ω–æ–º—É –æ—Ç–∫–ª—é—á–µ–Ω–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤

**–≠—Ñ—Ñ–µ–∫—Ç**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ—Ä—è—é—Ç –≤—Å–µ –¥–µ–ø–æ–∑–∏—Ç—ã, –ø–æ—Å—Ç—É–ø–∞—é—â–∏–µ –ø–æ—Å–ª–µ 29.07.2025 14:00

**–†–µ—à–µ–Ω–∏–µ**: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `UnifiedTransactionService.updateUserBalance()` —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π –∑–∞—â–∏—Ç–æ–π

**–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è**: User 25 –∏ –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç—Ä–µ–±—É—é—Ç —Ä—É—á–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤