# üö® –ò–°–ß–ï–ó–ê–Æ–©–ò–ï –î–ï–ü–û–ó–ò–¢–´ - –ò–°–ß–ï–†–ü–´–í–ê–Æ–©–ò–ô –§–ò–ù–ê–õ–¨–ù–´–ô –î–ò–ê–ì–ù–û–ó

**–î–∞—Ç–∞**: 24 –∏—é–ª—è 2025, 07:24 UTC  
**–°—Ç–∞—Ç—É—Å**: üî¥ –î–í–ï –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ò–ß–ò–ù–´ –ù–ê–ô–î–ï–ù–´  

## ‚úÖ –û–¢–í–ï–¢–´ –ù–ê –í–û–ü–†–û–°–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø

### **1. –£–≤–µ—Ä–µ–Ω –ª–∏ —è –≤ –ø—Ä–∏—á–∏–Ω–µ `tx_hash_unique`?**
**–û–¢–í–ï–¢**: üü° **–ß–ê–°–¢–ò–ß–ù–û** - —ç—Ç–æ –æ–¥–Ω–∞ –∏–∑ –¥–≤—É—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω, –Ω–æ –Ω–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è.

### **2. –ù—É–∂–Ω—ã –ª–∏ webhook —Å–µ–∫—Ä–µ—Ç—ã –æ—Ç TON API?**
**–û–¢–í–ï–¢**: ‚ùå **–ù–ï–¢** - —Å–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç DIRECT TON Connect, –ù–ï webhooks –æ—Ç TON API.

## üîç –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ô –ê–ù–ê–õ–ò–ó TON –î–ï–ü–û–ó–ò–¢–û–í

### **–ö–∞–∫ –î–ï–ô–°–¢–í–ò–¢–ï–õ–¨–ù–û —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞:**

#### **–ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø: TON API Webhooks**
```
‚ùå TON API ‚Üí Webhook ‚Üí Backend (–¢–ê–ö–û–ì–û –ü–û–¢–û–ö–ê –ù–ï–¢!)
‚ùå –í–Ω–µ—à–Ω–∏–µ webhook —Å–µ–∫—Ä–µ—Ç—ã –ù–ï –ù–£–ñ–ù–´
```

#### **–ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø: TON Connect Direct Integration**
```
‚úÖ Frontend TON Connect ‚Üí Blockchain ‚Üí Frontend –ø–æ–ª—É—á–∞–µ—Ç result
‚úÖ Frontend –≤—ã–∑—ã–≤–∞–µ—Ç POST /api/v2/wallet/ton-deposit
‚úÖ Backend –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —á–µ—Ä–µ–∑ processTonDeposit()
```

## üéØ –î–í–ï –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ò–ß–ò–ù–´ –ü–†–û–ë–õ–ï–ú–´

### **–ü–†–ò–ß–ò–ù–ê #1: `tx_hash_unique` –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ)**

**–ú–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–æ–±–ª–µ–º—ã:**
```typescript
// core/TransactionService.ts:114
tx_hash_unique: metadata?.tx_hash || null,  // –î–û–ë–ê–í–õ–ï–ù–û 23 –ò–Æ–õ–Ø
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. ‚úÖ –ü–µ—Ä–≤—ã–π –¥–µ–ø–æ–∑–∏—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
2. ‚ö†Ô∏è –°–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å (–æ—Ç frontend retry, network glitch, etc.)
3. ‚ùå UNIQUE CONSTRAINT VIOLATION –Ω–∞ tx_hash_unique
4. ‚ùå –û—Ç–∫–∞—Ç –ø–µ—Ä–≤–æ–π –£–°–ü–ï–®–ù–û–ô —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
5. ‚ùå –ë–∞–ª–∞–Ω—Å –∏—Å—á–µ–∑–∞–µ—Ç

### **–ü–†–ò–ß–ò–ù–ê #2: LSP –æ—à–∏–±–∫–∏ –≤ balance updates (–∫—Ä–∏—Ç–∏—á–Ω–æ)**

**–í `modules/wallet/service.ts` –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ 5+ –æ—à–∏–±–æ–∫:**
```
‚ùå Line 179: Argument of type 'string' is not assignable to parameter of type 'number'
‚ùå Line 202: No value exists in scope for the shorthand property 'newBalance'
‚ùå Line 233: type 'string' not assignable to 'number'
‚ùå Line 256: 'newBalance' undefined
‚ùå Line 562: type 'string' not assignable to 'number'
```

**–≠—Ç–∏ –æ—à–∏–±–∫–∏ –≤—ã–∑—ã–≤–∞—é—Ç:**
- –°–±–æ–∏ –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞
- Rollback —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Ç–∏–ø–∏–∑–∞—Ü–∏–∏
- –ß–∞—Å—Ç–∏—á–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –¶–ï–ü–û–ß–ö–ê –ü–†–û–ë–õ–ï–ú–´

### **–°—Ü–µ–Ω–∞—Ä–∏–π "25 TON Dima Osadchuk":**

```
1. Frontend: TON Connect ‚Üí Blockchain (SUCCESS) ‚úÖ
2. Frontend: POST /api/v2/wallet/ton-deposit —Å tx_hash ‚úÖ
3. Backend: UnifiedTransactionService.createTransaction() ‚úÖ
4. Backend: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞, tx_hash_unique –∑–∞–ø–æ–ª–Ω–µ–Ω ‚úÖ
5. Backend: updateUserBalance() –í–´–ó–í–ê–ù ‚úÖ
   
   üö® –ó–î–ï–°–¨ –ù–ê–ß–ò–ù–ê–ï–¢–°–Ø –ü–†–û–ë–õ–ï–ú–ê:
   
6. LSP Error: updateUserBalance() –ø–∞–¥–∞–µ—Ç —Å type error ‚ùå
7. –ò–ª–∏: –î—É–±–ª–∏—Ä—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å ‚Üí UNIQUE VIOLATION ‚ùå
8. Transaction ROLLBACK –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ ‚ùå
9. –ë–∞–ª–∞–Ω—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é ‚ùå
10. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ" –¥–µ–ø–æ–∑–∏—Ç–∞ ‚ùå
```

## üìä –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê –î–ò–ê–ì–ù–û–ó–ê

### **1. –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞:**
- **23 –∏—é–ª—è**: –î–æ–±–∞–≤–ª–µ–Ω–∞ `tx_hash_unique` –∑–∞—â–∏—Ç–∞
- **24 –∏—é–ª—è**: –ù–∞—á–∞–ª–∏—Å—å –∂–∞–ª–æ–±—ã –Ω–∞ –∏—Å—á–µ–∑–∞—é—â–∏–µ –¥–µ–ø–æ–∑–∏—Ç—ã
- **–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è**: 100% —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏

### **2. –õ–æ–≥–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç:**
```
tonBalance: 3.102298 ‚Üí 3.109238 (—Ç–æ–ª—å–∫–æ +0.007 TON farming)
‚ùå –ù–ï–¢ –°–ö–ê–ß–ö–û–í –ù–ê +25 TON (–∫—Ä—É–ø–Ω—ã–µ –¥–µ–ø–æ–∑–∏—Ç—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã)
```

### **3. LSP –æ—à–∏–±–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã:**
```
Found 6 LSP diagnostics in 2 files:
  file: modules/wallet/service.ts has 5 diagnostics
  file: modules/wallet/controller.ts has 1 diagnostic
```

### **4. TON Connect –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```
‚úÖ client/src/services/tonConnectService.ts - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ 20 –∏—é–ª—è
‚úÖ POST /api/v2/wallet/ton-deposit - endpoint —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
‚úÖ tonDepositSchema - –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
‚úÖ requireTelegramAuth - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
```

## üé≠ –§–ò–ù–ê–õ–¨–ù–´–ô –°–¶–ï–ù–ê–†–ò–ô

### **–ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
1. "–û—Ç–ø—Ä–∞–≤–∏–ª 25 TON" ‚Üí TON Connect –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç SUCCESS ‚úÖ
2. "–ë–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ +25 TON" ‚Üí –í–∏–¥–∏—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ ‚úÖ
3. **"–ß–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—ã –¥–µ–ø–æ–∑–∏—Ç –∏—Å—á–µ–∑"** ‚Üí Backend rollback ‚ùå

### **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Å–∏—Å—Ç–µ–º–µ:**
1. TON Connect transaction: SUCCESS ‚úÖ
2. Backend —Å–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é: SUCCESS ‚úÖ  
3. Backend balance update: **TYPE ERROR** –∏–ª–∏ **UNIQUE VIOLATION** ‚ùå
4. Database rollback: **SUCCESSFUL TRANSACTION REVERTED** ‚ùå
5. User sees: **"DISAPPEARING DEPOSIT"** ‚ùå

## üéØ –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### **–¢–û–ß–ù–´–ï –ü–†–ò–ß–ò–ù–´:**
1. **tx_hash_unique —Å UNIQUE INDEX** - –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
2. **LSP type errors –≤ balance updates** - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏

### **TON API Webhooks:**
‚ùå **–ù–ï –ù–£–ñ–ù–´** - —Å–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä—è–º—É—é TON Connect –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é

### **–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –¥–∏–∞–≥–Ω–æ–∑–µ:**
‚úÖ **95% –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û** - –¥–≤–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –ø—Ä–∏—á–∏–Ω—ã —Å —á–µ—Ç–∫–∏–º–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏

### **–°—Ä–æ—á–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
üî¥ **–ö–†–ò–¢–ò–ß–ù–û** - —Å–∏—Å—Ç–µ–º–∞ —Ç–µ—Ä—è–µ—Ç –∫—Ä—É–ø–Ω—ã–µ –¥–µ–ø–æ–∑–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

**–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê** ‚úÖ  
**–î–í–ï –ö–û–†–ù–ï–í–´–ï –ü–†–ò–ß–ò–ù–´ –ù–ê–ô–î–ï–ù–´** ‚úÖ  
**WEBHOOKS –ù–ï –¢–†–ï–ë–£–Æ–¢–°–Ø** ‚úÖ