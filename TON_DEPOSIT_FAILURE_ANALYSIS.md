# üö® **–ê–ù–ê–õ–ò–ó –ü–û–¢–ï–†–ò –ü–õ–ê–¢–ï–ñ–ï–ô TON –î–ï–ü–û–ó–ò–¢–û–í**

**–î–∞—Ç–∞:** 4 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:** –ü–æ—á–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ—Ä—è—é—Ç –¥–µ–ø–æ–∑–∏—Ç—ã —á–µ—Ä–µ–∑ ConnectWallet

---

## üí∏ **–û–°–ù–û–í–ù–´–ï –ü–†–ò–ß–ò–ù–´ –ü–û–¢–ï–†–ò –ü–õ–ê–¢–ï–ñ–ï–ô**

### **1. üîê JWT Token Timeout (–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫)**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–ª–∞—Ç–µ–∂ —É—Ö–æ–¥–∏—Ç –∏–∑ –∫–æ—à–µ–ª—å–∫–∞, –Ω–æ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞ –¥–ª—è –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏
**–§–∞–π–ª:** `client/src/services/tonConnectService.ts` —Å—Ç—Ä–æ–∫–∏ 317-476

```typescript
// üõ°Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê: –ó–∞—â–∏—â–∞–µ–º TON –¥–µ–ø–æ–∑–∏—Ç—ã –æ—Ç JWT token timeout
return await criticalOperationGuard.guardTonDeposit(async () => {
  console.log('[TON_DEPOSIT_PROTECTION] üîí –î–µ–ø–æ–∑–∏—Ç –∑–∞—â–∏—â–µ–Ω —Å–∏—Å—Ç–µ–º–æ–π JWT –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞');
```

**–°—Ü–µ–Ω–∞—Ä–∏–π –ø–æ—Ç–µ—Ä–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, JWT –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
2. –ó–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É –¥–µ–ø–æ–∑–∏—Ç–∞ (2-3 –º–∏–Ω—É—Ç—ã)
3. JWT –∏—Å—Ç–µ–∫–∞–µ—Ç –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é - –¥–µ–Ω—å–≥–∏ —É—Ö–æ–¥—è—Ç —Å –∫–æ—à–µ–ª—å–∫–∞
5. API –≤—ã–∑–æ–≤ `/api/v2/wallet/ton-deposit` –ø–æ–ª—É—á–∞–µ—Ç 401 Unauthorized
6. **–†–ï–ó–£–õ–¨–¢–ê–¢: –î–µ–Ω—å–≥–∏ —É—à–ª–∏, –¥–µ–ø–æ–∑–∏—Ç –Ω–µ –∑–∞—Å—á–∏—Ç–∞–Ω**

### **2. üì± –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫)**

**–§–∞–π–ª:** `client/src/services/tonConnectService.ts` —Å—Ç—Ä–æ–∫–∏ 448-461

```typescript
if (error instanceof UserRejectsError) {
  debugLog('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –∫–æ—à–µ–ª—å–∫–µ');
  return {
    txHash: '',
    status: 'error'
  };
}
```

**–°—Ü–µ–Ω–∞—Ä–∏–π –ø–æ—Ç–µ—Ä–∏:**
1. –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ Tonkeeper
3. –û—Ç–∫–ª–æ–Ω—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
4. **–ù–û:** –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ—à–µ–ª—å–∫–∏ –º–æ–≥—É—Ç –ø–æ–∫–∞–∑–∞—Ç—å "–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ" –¥–∞–∂–µ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ
5. **–†–ï–ó–£–õ–¨–¢–ê–¢: –î–µ–Ω—å–≥–∏ —É—à–ª–∏, –Ω–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Å—á–∏—Ç–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é –Ω–µ—É—Å–ø–µ—à–Ω–æ–π**

### **3. üåê –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ –≤–æ –≤—Ä–µ–º—è API –≤—ã–∑–æ–≤–∞ (–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫)**

**–§–∞–π–ª:** `client/src/components/wallet/TonDepositCard.tsx` —Å—Ç—Ä–æ–∫–∏ 136-148

```typescript
const response = await fetch('/api/v2/wallet/ton-deposit', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${localStorage.getItem('unifarm_jwt_token')}`
  },
  body: JSON.stringify({
    user_id: userId,
    ton_tx_hash: result.txHash,  // ‚Üê –ö–†–ò–¢–ò–ß–ù–û: —Ö—ç—à —É–∂–µ –ø–æ–ª—É—á–µ–Ω
    amount: depositAmount,
    wallet_address: walletAddress
  })
});
```

**–°—Ü–µ–Ω–∞—Ä–∏–π –ø–æ—Ç–µ—Ä–∏:**
1. `sendTonTransaction()` —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω
2. –ü–æ–ª—É—á–µ–Ω `result.txHash` - –¥–µ–Ω—å–≥–∏ —É—à–ª–∏ —Å –∫–æ—à–µ–ª—å–∫–∞  
3. –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ API (—Ç–∞–π–º–∞—É—Ç, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)
4. `fetch()` –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π
5. **–†–ï–ó–£–õ–¨–¢–ê–¢: –î–µ–Ω—å–≥–∏ —É—à–ª–∏, –Ω–æ –±—ç–∫–µ–Ω–¥ –Ω–µ –∑–Ω–∞–µ—Ç –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**

### **4. üîÑ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—â–∏—Ç—ã –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç (–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫)**

**–§–∞–π–ª:** `core/TransactionService.ts` —Å—Ç—Ä–æ–∫–∏ 114-148

```typescript
// –¢–û–ß–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è - —Ç–æ–ª—å–∫–æ –¥–ª—è –¢–û–ß–ù–û —Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
const { data: existingTransactions, error: checkError } = await supabase
  .from('transactions')
  .select('id, created_at, user_id, amount_ton, type, description, tx_hash_unique')
  .eq('tx_hash_unique', txHashToCheck)  
  .eq('user_id', user_id)
  .order('created_at', { ascending: false });

if (shouldBlock) {
  // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ù–´–• –î–ï–ü–û–ó–ò–¢–û–í
  logger.error('[CRITICAL] [DEPOSIT_BLOCKED_BY_DEDUPLICATION]', {
    blocked_reason: 'PREVENTED_DUPLICATE'
  });
  return { success: false, error: '–î—É–±–ª–∏—Ä—É—é—â–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è' };
}
```

**–°—Ü–µ–Ω–∞—Ä–∏–π –ø–æ—Ç–µ—Ä–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–µ–ø–æ–∑–∏—Ç, –ø–æ–ª—É—á–∞–µ—Ç —Å–µ—Ç–µ–≤—É—é –æ—à–∏–±–∫—É
2. –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –¥–µ–ø–æ–∑–∏—Ç —Å —Ç–æ–π –∂–µ —Å—É–º–º–æ–π —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç
3. –°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–∏—Ç "–ø–æ—Ö–æ–∂—É—é" —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–∞–∫ –¥—É–±–ª–∏–∫–∞—Ç
4. **–†–ï–ó–£–õ–¨–¢–ê–¢: –í—Ç–æ—Ä–æ–π –ø–ª–∞—Ç–µ–∂ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –¥–µ–Ω—å–≥–∏ –≤–∏—Å—è—Ç**

### **5. üèóÔ∏è –û—à–∏–±–∫–∏ –≤ UnifiedTransactionService (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫)**

**–§–∞–π–ª:** `modules/wallet/service.ts` —Å—Ç—Ä–æ–∫–∏ 411-431

```typescript
if (!result.success) {
  logger.error('[WalletService] UnifiedTransactionService –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É', {
    userId: user_id,
    txHash: ton_tx_hash,
    error: result.error
  });

  return {
    success: false,
    error: result.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏'
  };
}
```

**–°—Ü–µ–Ω–∞—Ä–∏–π –ø–æ—Ç–µ—Ä–∏:**
1. API –ø–æ–ª—É—á–∏–ª —Ö—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
2. `UnifiedTransactionService.createTransaction()` –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π
3. –ë–∞–ª–∞–Ω—Å –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
4. **–†–ï–ó–£–õ–¨–¢–ê–¢: –•—ç—à –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –≤ –ª–æ–≥–∞—Ö, –Ω–æ –¥–µ–ø–æ–∑–∏—Ç –ø–æ—Ç–µ—Ä—è–Ω**

### **6. üíæ –û—à–∏–±–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫)**

**–§–∞–π–ª:** `core/BalanceManager.ts` —Å—Ç—Ä–æ–∫–∏ 139-162

```typescript
const { data: updatedUser, error: updateError } = await supabase
  .from('users')
  .update({
    balance_uni: parseFloat(newUniBalance.toFixed(6)),
    balance_ton: parseFloat(newTonBalance.toFixed(6))
  })
  .eq('id', user_id)
  .select('id, balance_uni, balance_ton')
  .single();

if (updateError) {
  logger.error('[BalanceManager] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤ –ë–î:', {
    user_id,
    error: updateError.message
  });
  return { success: false, error: `–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞: ${updateError.message}` };
}
```

**–°—Ü–µ–Ω–∞—Ä–∏–π –ø–æ—Ç–µ—Ä–∏:**
1. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–∞–¥–∞–µ—Ç —Å DB –æ—à–∏–±–∫–æ–π
3. **–†–ï–ó–£–õ–¨–¢–ê–¢: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞–ø–∏—Å–∞–Ω–∞, –Ω–æ –±–∞–ª–∞–Ω—Å –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω**

---

## üîç **–û–¢ –ß–ï–ì–û –ó–ê–í–ò–°–ò–¢ –ö–û–†–†–ï–ö–¢–ù–û–ï –ó–ê–ß–ò–°–õ–ï–ù–ò–ï**

### **–¶–µ–ø–æ—á–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞:**

1. **‚úÖ TON Connect UI —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**
   - –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
   - `sendTransaction()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π BOC

2. **‚úÖ JWT Token –∞–∫—Ç—É–∞–ª–µ–Ω**
   - –¢–æ–∫–µ–Ω –Ω–µ –∏—Å—Ç–µ–∫ –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
   - –°–∏—Å—Ç–µ–º–∞ `criticalOperationGuard` —É—Å–ø–µ—à–Ω–æ –∑–∞—â–∏—â–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é

3. **‚úÖ –°–µ—Ç–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ**
   - API –≤—ã–∑–æ–≤ `/api/v2/wallet/ton-deposit` –¥–æ—Ö–æ–¥–∏—Ç –¥–æ —Å–µ—Ä–≤–µ—Ä–∞
   - –ù–µ—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏–ª–∏ —Ä–∞–∑—Ä—ã–≤–æ–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

4. **‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —Å–æ–∑–¥–∞–Ω**
   - `getUserByTelegramId()` —Ä–∞–±–æ—Ç–∞–µ—Ç
   - –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ `getOrCreateUserFromTelegram()` —Å–æ–∑–¥–∞–µ—Ç –∞–∫–∫–∞—É–Ω—Ç

5. **‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç**
   - –•—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —É–Ω–∏–∫–∞–ª–µ–Ω –∏–ª–∏ –ø—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏
   - `checkRecentTransaction()` –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

6. **‚úÖ UnifiedTransactionService —Å–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é**
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ –∏ —Å—É–º–º—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
   - –ó–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É `transactions` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

7. **‚úÖ BalanceManager –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å**
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `users` –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
   - –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

8. **‚úÖ WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è**
   - –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç —Å–∏–≥–Ω–∞–ª –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞
   - `refreshBalance()` —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ

---

## üéØ **–û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –í UX: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏**

### **1. üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (–°–õ–ê–ë–û–ï –ú–ï–°–¢–û)**

**–§–∞–π–ª:** `client/src/components/wallet/TonDepositCard.tsx` —Å—Ç—Ä–æ–∫–∏ 156-158

```typescript
// –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
setTimeout(() => {
  refreshBalance(true);
}, 1000);
```

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π
- –ï—Å–ª–∏ `refreshBalance()` –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–≤–∏–¥–∏—Ç –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
- –ù–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### **2. üì° WebSocket –º–æ–∂–µ—Ç –Ω–µ –¥–æ—Å—Ç–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ**

**–§–∞–π–ª:** `client/src/hooks/useWebSocketBalanceSync.ts` —Å—Ç—Ä–æ–∫–∏ 55-64

```typescript
if (lastMessage && lastMessage.type === 'balance_update') {
  if (lastMessage.userId === userId && userId) {
    balanceCoordinator.requestUpdate(userId, 'websocket-update', true);
  }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º
- –°–æ–æ–±—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### **3. üé® UX –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å–ø–µ—Ö –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è**

**–§–∞–π–ª:** `client/src/components/wallet/TonDepositCard.tsx` —Å—Ç—Ä–æ–∫–∏ 152-153

```typescript
if (data.success) {
  success(`–î–µ–ø–æ–∑–∏—Ç ${depositAmount} TON —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω`);
  setAmount('');
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
- –ù–æ –±–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
- –°–æ–∑–¥–∞–µ—Ç—Å—è –ª–æ–∂–Ω–æ–µ –æ—â—É—â–µ–Ω–∏–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è

---

## üõ†Ô∏è **–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–°–¢–†–ê–ù–ï–ù–ò–Æ –†–ò–°–ö–û–í**

### **1. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ JWT timeout**
```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
const isTokenValid = await validateJWTToken();
if (!isTokenValid) {
  await refreshToken();
}
```

### **2. Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è API –≤—ã–∑–æ–≤–æ–≤**
```typescript
const retryDeposit = async (retries = 3) => {
  for (let i = 0; i < retries; i++) {
    try {
      const response = await fetch('/api/v2/wallet/ton-deposit', {});
      if (response.ok) return response;
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
};
```

### **3. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞**
```typescript
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–û–±—Ä–∞–±–æ—Ç–∫–∞..." –≤–º–µ—Å—Ç–æ "–£—Å–ø–µ—à–Ω–æ"
setDepositStatus('processing');
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
const checkBalance = setInterval(() => {
  refreshBalance(true);
}, 2000);
```

### **4. Fallback –¥–ª—è WebSocket**
```typescript
// –ï—Å–ª–∏ WebSocket –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º polling
useEffect(() => {
  if (!isWebSocketConnected) {
    const interval = setInterval(() => {
      refreshBalance(true);
    }, 10000);
    return () => clearInterval(interval);
  }
}, [isWebSocketConnected]);
```

---

## üìä **–í–´–í–û–î–´**

### **–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –¥–µ–ø–æ–∑–∏—Ç–∞:**
1. **JWT Token timeout** - –¥–µ–Ω—å–≥–∏ —É—à–ª–∏, –Ω–æ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
2. **–°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏** - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –Ω–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
3. **DB –æ—à–∏–±–∫–∏** - –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã, –Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã

### **–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫:**
1. **–õ–æ–∂–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ –∫–æ—à–µ–ª—å–∫–µ
2. **–ò–∑–ª–∏—à–Ω—è—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è** –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–µ –¥–µ–ø–æ–∑–∏—Ç—ã

### **UX –ø—Ä–æ–±–ª–µ–º—ã:**
1. **–û–±–º–∞–Ω—á–∏–≤—ã–π —É—Å–ø–µ—Ö** - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–≥–æ—Ç–æ–≤–æ" –¥–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ retry** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ
3. **–°–ª–∞–±–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å** - –Ω–µ—Ç –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–°–∏—Å—Ç–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –∏ —É–ª—É—á—à–µ–Ω–∏—è UX –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞.**