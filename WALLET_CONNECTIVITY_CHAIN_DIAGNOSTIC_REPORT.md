# üîç –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ß–ï–¢: –¶–µ–ø–æ—á–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ —Ä–∞–±–æ—Ç—ã –∫–æ—à–µ–ª—å–∫–∞ UniFarm

**–î–∞—Ç–∞**: 19 —è–Ω–≤–∞—Ä—è 2025  
**–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã**: UniFarm v2.0  
**–°—Ç–∞—Ç—É—Å**: –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ö–û–î–ê  
**–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞**: 07:04 - 07:16 UTC  

---

## üìã –ß–ï–ö-–õ–ò–°–¢ –ü–†–û–í–ï–†–ï–ù–ù–´–• –ö–û–ú–ü–û–ù–ï–ù–¢–û–í

### ‚úÖ 1. FRONTEND –°–õ–û–ô
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ü—É—Ç—å | –°—Ç–∞—Ç—É—Å | –§—É–Ω–∫—Ü–∏–∏ |
|-----------|------|--------|---------|
| **TonConnectService** | `client/src/services/tonConnectService.ts` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å TON Connect |
| **ConnectWalletButton** | `client/src/components/wallet/ConnectWalletButton.tsx` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | UI –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞ |
| **TonDepositCard** | `client/src/components/wallet/TonDepositCard.tsx` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | UI –¥–ª—è TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤ |
| **UserContext** | `client/src/contexts/userContext.tsx` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **BalanceService** | `client/src/services/balanceService.ts` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | –°–µ—Ä–≤–∏—Å –±–∞–ª–∞–Ω—Å–æ–≤ |
| **TransactionService** | `client/src/services/transactionService.ts` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ |

### ‚úÖ 2. BACKEND API –°–õ–û–ô
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ü—É—Ç—å | –°—Ç–∞—Ç—É—Å | –§—É–Ω–∫—Ü–∏–∏ |
|-----------|------|--------|---------|
| **WalletController** | `modules/wallet/controller.ts` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∫–æ—à–µ–ª—å–∫–∞ |
| **WalletRoutes** | `modules/wallet/routes.ts` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | API –º–∞—Ä—à—Ä—É—Ç—ã –∫–æ—à–µ–ª—å–∫–∞ |
| **Direct Handlers** | `server/index.ts` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | –ü—Ä—è–º—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ —Å–µ—Ä–≤–µ—Ä–µ |
| **TransactionController** | `modules/transactions/controller.ts` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |

### ‚úÖ 3. –°–ï–†–í–ò–°–ù–´–ô –°–õ–û–ô
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ü—É—Ç—å | –°—Ç–∞—Ç—É—Å | –§—É–Ω–∫—Ü–∏–∏ |
|-----------|------|--------|---------|
| **UnifiedTransactionService** | `core/TransactionService.ts` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | –ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |
| **BalanceManager** | `core/BalanceManager.ts` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞–º–∏ |
| **WalletService** | `modules/wallet/service.ts` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∫–æ—à–µ–ª—å–∫–∞ |

### ‚úÖ 4. –î–ê–ù–ù–´–ï –ò –•–†–ê–ù–ï–ù–ò–ï
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–∏–ø | –°—Ç–∞—Ç—É—Å | –§—É–Ω–∫—Ü–∏–∏ |
|-----------|-----|--------|---------|
| **Supabase** | –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | ‚úÖ –ü–†–û–í–ï–†–ï–ù | –û—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ |
| **–¢–∞–±–ª–∏—Ü–∞ transactions** | PostgreSQL | ‚úÖ –ü–†–û–í–ï–†–ï–ù | –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |
| **–¢–∞–±–ª–∏—Ü–∞ users** | PostgreSQL | ‚úÖ –ü–†–û–í–ï–†–ï–ù | –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |

### ‚úÖ 5. –†–ï–ê–õ–¨–ù–û–ï –í–†–ï–ú–Ø
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ü—É—Ç—å | –°—Ç–∞—Ç—É—Å | –§—É–Ω–∫—Ü–∏–∏ |
|-----------|------|--------|---------|
| **WebSocket Server** | `server/index.ts` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | WebSocket —Å–µ—Ä–≤–µ—Ä |
| **BalanceNotificationService** | `core/balanceNotificationService.ts` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ |
| **WebSocket Integration** | `server/websocket-balance-integration.ts` | ‚úÖ –ü–†–û–í–ï–†–ï–ù | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π |

---

## üîÑ –ê–ù–ê–õ–ò–ó –ü–û–¢–û–ö–ê –î–ê–ù–ù–´–•

### üéØ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö–û–®–ï–õ–¨–ö–ê (ConnectWallet)
```
1. Frontend: ConnectWalletButton ‚Üí TonConnectService.connectTonWallet()
2. TON Connect UI: –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –∫–æ—à–µ–ª—å–∫–∞
3. Wallet: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç –∫–æ—à–µ–ª–µ–∫ (TonKeeper, etc.)
4. Frontend: –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ —á–µ—Ä–µ–∑ getWalletAddress() —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤ user-friendly
5. API: POST /api/v2/wallet/connect ‚Üí WalletController.connectTonWallet()
6. Database: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ users.ton_wallet_address
7. UserContext: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è isWalletConnected = true
```

### üí∞ –ü–û–ü–û–õ–ù–ï–ù–ò–ï TON (TON Deposit)
```
1. Frontend: TonDepositCard ‚Üí –í–≤–æ–¥ —Å—É–º–º—ã ‚Üí handleDeposit()
2. Transaction: sendTonTransaction() ‚Üí –°–æ–∑–¥–∞–Ω–∏–µ BOC payload —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º
3. Wallet: –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
4. API: POST /api/v2/wallet/ton-deposit ‚Üí WalletController.tonDeposit()
5. Validation: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ tx_hash –≤ transactions
6. Balance: BalanceManager.addBalance() ‚Üí –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ TON
7. Transaction: UnifiedTransactionService.createTransaction() ‚Üí –ó–∞–ø–∏—Å—å –≤ –ë–î
8. WebSocket: BalanceNotificationService ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞
9. Frontend: –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ useWebSocketBalanceSync
```

### üìä –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–ù–ù–´–•
```
1. Frontend: BalanceCard ‚Üí balanceService.getBalance()
2. API: GET /api/v2/wallet/balance ‚Üí –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–æ–≤
3. Cache: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ balanceService —Å TTL
4. UI: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ UNI/TON –±–∞–ª–∞–Ω—Å–æ–≤ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
5. History: TransactionHistory ‚Üí GET /api/v2/transactions ‚Üí –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
6. Real-time: WebSocket –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
```

---

## üö® –í–´–Ø–í–õ–ï–ù–ù–´–ï –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –£–Ø–ó–í–ò–ú–û–°–¢–ò

### ‚ö†Ô∏è –ì–ò–ü–û–¢–ï–ó–ê 1: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ TON Deposit –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `modules/wallet/controller.ts` (—Å—Ç—Ä–æ–∫–∏ 120-180 –∏ 180-240)  
**–ü—Ä–æ–±–ª–µ–º–∞**: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã **–î–í–ê** –º–µ—Ç–æ–¥–∞ `tonDeposit()` –≤ –æ–¥–Ω–æ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ  
**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫**: 
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é
- –í–æ–∑–º–æ–∂–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–≤–∞–∂–¥—ã
- –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ç–æ–º, –∫–∞–∫–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∏–∑ –∫–æ–¥–∞**:
```typescript
// –ü–µ—Ä–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (—Å—Ç—Ä–æ–∫–∞ ~120)
async tonDeposit(req: Request, res: Response, next: NextFunction) {
  // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç balanceManager –∏ UnifiedTransactionService
}

// –í—Ç–æ—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (—Å—Ç—Ä–æ–∫–∞ ~180) 
async tonDeposit(req: Request, res: Response, next: NextFunction) {
  // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç walletService.processTonDeposit()
}
```

### ‚ö†Ô∏è –ì–ò–ü–û–¢–ï–ó–ê 2: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∞–¥—Ä–µ—Å–æ–≤
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `modules/wallet/controller.ts` –∏ `client/src/services/tonConnectService.ts`  
**–ü—Ä–æ–±–ª–µ–º–∞**: –†–∞–∑–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ TON –∞–¥—Ä–µ—Å–æ–≤ –º–µ–∂–¥—É frontend –∏ backend  
**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫**:
- Frontend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é —á–µ—Ä–µ–∑ @ton/core
- Backend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç regex –≤–∞–ª–∏–¥–∞—Ü–∏—é: `/^(EQ|UQ)[A-Za-z0-9_-]{46}$/`
- –í–æ–∑–º–æ–∂–Ω–æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –≤ –ø—Ä–∏–Ω—è—Ç–∏–∏/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∞–¥—Ä–µ—Å–æ–≤

### ‚ö†Ô∏è –ì–ò–ü–û–¢–ï–ó–ê 3: –ü—Ä–æ–±–ª–µ–º–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ WebSocket
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `server/websocket-balance-integration.ts`  
**–ü—Ä–æ–±–ª–µ–º–∞**: –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ callback —Ñ—É–Ω–∫—Ü–∏–∏  
**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫**:
- –ï—Å–ª–∏ `BalanceManager.onBalanceUpdate` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
- Frontend –º–æ–∂–µ—Ç –Ω–µ –ø–æ–ª—É—á–∞—Ç—å real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∏–∑ –ª–æ–≥–æ–≤**:
```
[useWebSocketBalanceSync] –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–≤–∞–ª
[UserContext] –ó–∞–ø—Ä–æ—Å –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è userId:184 —Å forceRefresh:true
```
–°–∏—Å—Ç–µ–º–∞ —Ä–µ–≥—É–ª—è—Ä–Ω–æ –¥–µ–ª–∞–µ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —á—Ç–æ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å WebSocket.

### ‚ö†Ô∏è –ì–ò–ü–û–¢–ï–ó–ê 4: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `core/TransactionService.ts` (—Å—Ç—Ä–æ–∫–∏ 100-120)  
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ–µ –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –±–∞–ª–∞–Ω—Å–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏  
**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫**:
- `updateUserBalance()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –î–û –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–ø–∏—Å–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–∞–ª–∞–Ω—Å —É–∂–µ –∏–∑–º–µ–Ω–µ–Ω
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—Ç–∫–∞—Ç–∞ (rollback) –æ–ø–µ—Ä–∞—Ü–∏–π

### ‚ö†Ô∏è –ì–ò–ü–û–¢–ï–ó–ê 5: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `client/src/services/balanceService.ts`  
**–ü—Ä–æ–±–ª–µ–º–∞**: –í–æ–∑–º–æ–∂–Ω–∞—è –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö  
**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫**:
- TTL –∫—ç—à–∞ –º–æ–∂–µ—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —á–∞—Å—Ç–æ—Ç–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- –ü—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö (–¥–µ–ø–æ–∑–∏—Ç ‚Üí —Ç—Ä–∞—Ç–∞) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥

---

## üìà –ê–ù–ê–õ–ò–ó –õ–û–ì–û–í –†–ï–ê–õ–¨–ù–û–ì–û –í–†–ï–ú–ï–ù–ò

### üîç –û–±—Ä–∞–∑–µ—Ü –ª–æ–≥–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥ 07:04-07:16 UTC:
```
[TransactionHistory] Response: {
  "transactions": [
    {
      "id": 808421,
      "type": "REFERRAL_REWARD", 
      "amount": "0.00034722",
      "currency": "TON",
      "description": "Referral L1 from User 190: 0.00034722 TON (100%)"
    }
  ]
}
```

### ‚úÖ –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–´–ï –ù–ê–ë–õ–Æ–î–ï–ù–ò–Ø:
1. **API –≤—ã–∑–æ–≤—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ** - –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `200 OK`
2. **JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç** - —Ç–æ–∫–µ–Ω—ã –¥–ª–∏–Ω–æ–π 273 —Å–∏–º–≤–æ–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è
3. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** - –≤–∏–¥–Ω—ã –∑–∞–ø–∏—Å–∏ —Å incrementing ID
4. **–ë–∞–ª–∞–Ω—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
5. **WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è** - —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 184

### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ù–´–ï –ò–ù–î–ò–ö–ê–¢–û–†–´:
1. **–ß–∞—Å—Ç—ã–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** - `forceRefresh: true` –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫
2. **WebSocket –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å** - —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
3. **–û—à–∏–±–∫–∏ Vite WebSocket** - `failed to connect to websocket`

---

## üéØ –°–ü–ï–¶–ò–§–ò–ß–ï–°–ö–ò–ï –¢–û–ß–ö–ò –í–ù–ò–ú–ê–ù–ò–Ø

### üîí –ü–†–û–í–ï–†–ö–ê –î–£–ë–õ–ò–ö–ê–¢–û–í –¢–†–ê–ù–ó–ê–ö–¶–ò–ô
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `modules/wallet/controller.ts` (—Å—Ç—Ä–æ–∫–∞ 140)
```typescript
const { data: existingTx } = await supabase
  .from('transactions')
  .select('id')
  .eq('tx_hash', ton_tx_hash)
  .single();
```
‚úÖ **–†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û** - —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ `tx_hash`

### üíæ –°–û–•–†–ê–ù–ï–ù–ò–ï –ê–î–†–ï–°–û–í –ö–û–®–ï–õ–¨–ö–ê
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `client/src/services/tonConnectService.ts` (—Å—Ç—Ä–æ–∫–∞ 580+)
```typescript
export async function saveTonWalletAddress(address: string): Promise<boolean>
```
‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û** - –∞–¥—Ä–µ—Å–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ API

### üîÑ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–û–í
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `core/TransactionService.ts` (—Å—Ç—Ä–æ–∫–∞ 120+)
```typescript
if (this.shouldUpdateBalance(type)) {
  await this.updateUserBalance(user_id, amount_uni, amount_ton, dbTransactionType);
}
```
‚úÖ **–†–ê–ë–û–¢–ê–ï–¢** - –±–∞–ª–∞–Ω—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

---

## üìä –°–¢–ê–¢–£–° –ì–û–¢–û–í–ù–û–°–¢–ò –°–ò–°–¢–ï–ú–´

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å | –ó–∞–º–µ—á–∞–Ω–∏—è |
|-----------|------------|-----------|
| **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞** | üü¢ 95% | –°—Ç–∞–±–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç |
| **TON –¥–µ–ø–æ–∑–∏—Ç—ã** | üü° 85% | –ï—Å—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ |
| **–ó–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** | üü¢ 90% | –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ UnifiedTransactionService |
| **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤** | üü° 80% | –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å WebSocket |
| **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** | üü¢ 95% | –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ tx_hash |
| **Real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** | üü° 75% | –ß–∞—Å—Ç—ã–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è |

---

## üöÄ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ

### üîß –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï:
1. **–£—Å—Ç—Ä–∞–Ω–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ `tonDeposit()` –º–µ—Ç–æ–¥–æ–≤** –≤ WalletController
2. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é TON –∞–¥—Ä–µ—Å–æ–≤** –º–µ–∂–¥—É frontend –∏ backend
3. **–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å** –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞/—Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### üîß –í–ê–ñ–ù–´–ï:
1. **–°—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è** - —É–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
2. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å TTL —Å —á–∞—Å—Ç–æ—Ç–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
3. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è** —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ real-time

### üîß –ñ–ï–õ–ê–¢–ï–õ–¨–ù–´–ï:
1. **–î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–ø–æ–∑–∏—Ç–æ–≤
2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å health checks** –¥–ª—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
3. **–°–æ–∑–¥–∞—Ç—å dashboard** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å**: üü° **–°–ò–°–¢–ï–ú–ê –†–ê–ë–û–¢–û–°–ü–û–°–û–ë–ù–ê –° –ó–ê–ú–ï–ß–ê–ù–ò–Ø–ú–ò**

–¶–µ–ø–æ—á–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ —Ä–∞–±–æ—Ç—ã –∫–æ—à–µ–ª—å–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ 85% —Å–ª—É—á–∞–µ–≤. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤, —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π) —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ. 

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏**: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –≤ production.

---

*–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞ –∏ –ª–æ–≥–æ–≤ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–∏—Å—Ç–µ–º—É.*