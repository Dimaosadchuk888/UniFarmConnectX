# ๐ ะะะฌะขะะะะะขะะะะซะ ะะะะฅะะ ะ ะะะะะซะ ะะะฅะะขะะะขะฃะะะซะ ะะะะะะ

**ะะฐัะฐ:** 21 ัะฝะฒะฐัั 2025  
**ะฆะตะปั:** ะะฝะฐะปะธะท ะฐะปััะตัะฝะฐัะธะฒ ะธ ะดะตัะฐะปะธะทะฐัะธั ะฐััะธัะตะบัััั TON ะดะตะฟะพะทะธัะพะฒ

---

## 1๏ธโฃ ะะะฌะขะะะะะขะะะะซะ (ะะะะะ ะะะะกะขะะ) ะะะะฅะะ

### ๐ฏ ะะธะฝะธะผะฐะปัะฝะพะต ัะตัะตะฝะธะต - ะธัะฟัะฐะฒะธัั ัะพะปัะบะพ ะพะดะฝั ัััะพะบั

ะะพัะปะต ะฐะฝะฐะปะธะทะฐ ะฒัะตะน ะฐััะธัะตะบัััั, ัะฐะผะพะต ะฟัะพััะพะต ัะตัะตะฝะธะต - ััะพ ะธัะฟัะฐะฒะธัั ะตะดะธะฝััะฒะตะฝะฝัั ัััะพะบั ะบะพะดะฐ:

**ะคะฐะนะป:** `modules/wallet/controller.ts`  
**ะกััะพะบะฐ:** ~450

```typescript
// ะะซะะ (ะฝะตะฟัะฐะฒะธะปัะฝะพ):
let user = await userRepository.getUserByTelegramId(telegram.user.id);

// ะกะขะะะ (ะฟัะฐะฒะธะปัะฝะพ):
let user = await userRepository.getUserByTelegramId(telegram.user.telegram_id);
```

### ะะพัะตะผั ััะพ ัะฐะฑะพัะฐะตั?

1. **JWT ัะถะต ัะพะดะตัะถะธั ะฟัะฐะฒะธะปัะฝัะน telegram_id** ะฒ ะฟะพะปะต `telegram.user.telegram_id`
2. **Fallback ะฟะพ wallet ัะถะต ัะตะฐะปะธะทะพะฒะฐะฝ** ะฒ ะบะพะดะต ะฝะธะถะต
3. **Auto-creation ัะถะต ัะฐะฑะพัะฐะตั** ะตัะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะต ะฝะฐะนะดะตะฝ

### ะญัะพะณะพ ะดะพััะฐัะพัะฝะพ?

**ะะ**, ะตัะปะธ:
- ะ ะฑะฐะทะต ะดะฐะฝะฝัั ะฒัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ะธะผะตัั ะบะพััะตะบัะฝัะน telegram_id
- ะะตั ะบะพะฝัะปะธะบัะพะฒ ั ะดัะฑะปะธััััะธะผะธัั telegram_id
- Wallet ะฟัะธะฒัะทัะฒะฐะตััั ัะพะปัะบะพ ะบ ะพะดะฝะพะผั ะฟะพะปัะทะพะฒะฐัะตะปั

**ะะะข**, ะตัะปะธ:
- ะััั ะฟะพะปัะทะพะฒะฐัะตะปะธ ะฑะตะท telegram_id ะธะปะธ ั ะฝะตะฒะตัะฝัะผ telegram_id
- ะะดะธะฝ wallet ะธัะฟะพะปัะทัะตััั ะฝะตัะบะพะปัะบะธะผะธ ะฟะพะปัะทะพะฒะฐัะตะปัะผะธ
- ะัะถะฝะฐ ะดะพะฟะพะปะฝะธัะตะปัะฝะฐั ะทะฐัะธัะฐ ะพั ะผะพัะตะฝะฝะธัะตััะฒะฐ

---

## 2๏ธโฃ ะะะะะซะ ะะะฅะะขะะะขะฃะะะซะ ะะะะะะ ะขะะะฃะฉะะะ ะะะจะะะะฏ

### ๐บ๏ธ ะะพะปะฝะฐั ัะตะฟะพัะบะฐ ะพะฑัะฐะฑะพัะบะธ TON ะดะตะฟะพะทะธัะฐ

```
โโโโโโโโโโโโโโโโโโโ
โ  TonDepositCard โ (Frontend)
โโโโโโโโโโฌโโโโโโโโโ
         โ 1. ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั "ะะพะฟะพะปะฝะธัั"
         โ 2. TON Connect ะพัะบััะฒะฐะตั ะบะพัะตะปะตะบ
         โ 3. ะะพะดัะฒะตัะถะดะฐะตั ััะฐะฝะทะฐะบัะธั
         โผ
โโโโโโโโโโโโโโโโโโโ
โ tonConnectSvc   โ (Frontend Service)
โโโโโโโโโโฌโโโโโโโโโ
         โ 4. ะะพะปััะฐะตั ัะตะทัะปััะฐั ััะฐะฝะทะฐะบัะธะธ
         โ 5. ะะทะฒะปะตะบะฐะตั txHash ะธะท result.boc
         โ 6. POST /api/v2/wallet/ton-deposit
         โผ
โโโโโโโโโโโโโโโโโโโ
โ Express Router  โ (Backend)
โโโโโโโโโโฌโโโโโโโโโ
         โ 7. ะะฐัััััะธะทะฐัะธั ะฝะฐ WalletController
         โผ
โโโโโโโโโโโโโโโโโโโ
โ telegramAuth    โ (Middleware)
โโโโโโโโโโฌโโโโโโโโโ
         โ 8. ะัะพะฒะตััะตั JWT ัะพะบะตะฝ
         โ 9. ะะตะบะพะดะธััะตั: {userId: 74, telegram_id: 999489}
         โ 10. ะกะพะทะดะฐะตั req.telegram ะพะฑัะตะบั
         โผ
โโโโโโโโโโโโโโโโโโโ
โ WalletControllerโ
โ   .tonDeposit   โ
โโโโโโโโโโฌโโโโโโโโโ
         โ 11. ะะฐะปะธะดะธััะตั ะฒัะพะดะฝัะต ะดะฐะฝะฝัะต
         โ 12. ะัะตั ะฟะพะปัะทะพะฒะฐัะตะปั (ะะะะะะะะ ะะะะกะฌ!)
         โ 13. Fallback ะฟะพ wallet_address
         โ 14. Auto-creation ะตัะปะธ ะฝะต ะฝะฐะนะดะตะฝ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ WalletService   โ
โ.processTonDep   โ
โโโโโโโโโโฌโโโโโโโโโ
         โ 15. ะัะพะฒะตััะตั ะดัะฑะปะธะบะฐัั ะฟะพ tx_hash
         โ 16. ะกะพะทะดะฐะตั ััะฐะฝะทะฐะบัะธั ะฒ ะะ
         โ 17. ะะฑะฝะพะฒะปัะตั ะฑะฐะปะฐะฝั ัะตัะตะท BalanceManager
         โผ
โโโโโโโโโโโโโโโโโโโ
โ   Supabase DB   โ
โโโโโโโโโโฌโโโโโโโโโ
         โ 18. INSERT ะฒ transactions
         โ 19. UPDATE users.balance_ton
         โผ
โโโโโโโโโโโโโโโโโโโ
โBalanceNotifSvc โ
โโโโโโโโโโฌโโโโโโโโโ
         โ 20. WebSocket ัะฒะตะดะพะผะปะตะฝะธะต
         โผ
โโโโโโโโโโโโโโโโโโโ
โ    Frontend     โ
โโโโโโโโโโโโโโโโโโโ
         21. ะะฑะฝะพะฒะปะตะฝะธะต ะฑะฐะปะฐะฝัะฐ ะฒ UI
```

### ๐ ะฃัะฐััะฒัััะธะต ะผะพะดัะปะธ ะธ ัะฐะนะปั

#### Frontend:
1. **client/src/components/wallet/TonDepositCard.tsx**
   - ะะฝะธัะธะธััะตั ะดะตะฟะพะทะธั
   - ะะฑัะฐะฑะฐััะฒะฐะตั ัะตะทัะปััะฐั ััะฐะฝะทะฐะบัะธะธ
   
2. **client/src/services/tonConnectService.ts**
   - ะฃะฟัะฐะฒะปัะตั TON Connect UI
   - ะัะฟัะฐะฒะปัะตั ััะฐะฝะทะฐะบัะธั ะฒ ะฑะปะพะบัะตะนะฝ
   - ะัะทัะฒะฐะตั backend API

3. **client/src/contexts/UserContext.tsx**
   - ะฅัะฐะฝะธั ัะตะบััะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั
   - ะะฑะฝะพะฒะปัะตั ะฑะฐะปะฐะฝั ะฟะพัะปะต ะดะตะฟะพะทะธัะฐ

#### Backend:
1. **modules/wallet/routes.ts**
   ```typescript
   router.post('/ton-deposit', requireTelegramAuth, controller.tonDeposit.bind(controller));
   ```

2. **core/middleware/telegramAuth.ts**
   - ะะตะบะพะดะธััะตั JWT: `{userId: 74, telegram_id: 999489}`
   - ะกะพะทะดะฐะตั `req.telegram.user` ะพะฑัะตะบั

3. **modules/wallet/controller.ts**
   - ะะตัะพะด `tonDeposit` - ะพัะฝะพะฒะฝะฐั ะปะพะณะธะบะฐ
   - **ะะะะกะฌ ะะะะะะะะ**: ะธัะฟะพะปัะทัะตั `telegram.user.id` ะฒะผะตััะพ `telegram.user.telegram_id`

4. **modules/wallet/service.ts**
   - `processTonDeposit` - ะพะฑัะฐะฑะพัะบะฐ ะดะตะฟะพะทะธัะฐ
   - ะัะพะฒะตัะบะฐ ะดัะฑะปะธะบะฐัะพะฒ
   - ะกะพะทะดะฐะฝะธะต ััะฐะฝะทะฐะบัะธะธ

5. **core/BalanceManager.ts**
   - `addBalance` - ะพะฑะฝะพะฒะปะตะฝะธะต ะฑะฐะปะฐะฝัะฐ ะฟะพะปัะทะพะฒะฐัะตะปั
   - ะัะพะผะฐัะฝะฐั ะพะฟะตัะฐัะธั ัะตัะตะท Supabase

#### ะะฐะทะฐ ะดะฐะฝะฝัั:
1. **ะขะฐะฑะปะธัะฐ users**
   ```sql
   id: 74
   telegram_id: 999489
   ton_wallet_address: "UQxx...123"
   balance_ton: "100.5"
   ```

2. **ะขะฐะฑะปะธัะฐ transactions**
   ```sql
   user_id: 74
   type: "TON_DEPOSIT"
   amount: "1.0"
   currency: "TON"
   metadata: {
     tx_hash: "abc123...",
     wallet_address: "UQxx...123"
   }
   ```

### ๐ ะะฝะฐะปะธะท ะฟะพัะตะฝัะธะฐะปัะฝัั ะฟัะพะฑะปะตะผ

#### ะะพะฝัะปะธะบั ะธะดะตะฝัะธัะธะบะฐัะพัะพะฒ:
```typescript
// ะ JWT:
telegram.user = {
  id: 74,              // database ID
  telegram_id: 999489  // ัะตะฐะปัะฝัะน telegram ID
}

// ะัะพะฑะปะตะผะฐ ะฒ controller:
getUserByTelegramId(telegram.user.id)  // ะะตัะตะดะฐะตั 74 ะฒะผะตััะพ 999489!
```

#### ะะธัะบ ะดัะฑะปะธะบะฐัะพะฒ:
1. **ะัะปะธ ะพะดะธะฝ wallet ะฝะฐ ะฝะตัะบะพะปัะบะพ ะฟะพะปัะทะพะฒะฐัะตะปะตะน:**
   - User A: telegram_id=111, wallet="UQxx...123"
   - User B: telegram_id=222, wallet="UQxx...123"
   - ะะตะฟะพะทะธั ะผะพะถะตั ะทะฐัะธัะปะธัััั ะฝะต ัะพะผั

2. **ะัะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะฑะตะท telegram_id:**
   - Fallback ะฟะพ wallet ะผะพะถะตั ะฝะต ััะฐะฑะพัะฐัั
   - ะกะพะทะดะฐัััั ะฝะพะฒัะน ะฟะพะปัะทะพะฒะฐัะตะปั-ะดัะฑะปะธะบะฐั

#### ะะพะฝะบะธ ะดะฐะฝะฝัั:
- ะะฐัะฐะปะปะตะปัะฝัะต ะดะตะฟะพะทะธัั ะผะพะณัั ัะพะทะดะฐัั race condition
- ะะพ Supabase RLS ะธ ััะฐะฝะทะฐะบัะธะธ ััะพ ะฟัะตะดะพัะฒัะฐัะฐัั

---

## 3๏ธโฃ ะะะขะะะฌะะซะ ะะะะ ะะะะะะะะะฏ

### ะะฐัะธะฐะฝั A: ะะธะฝะธะผะฐะปัะฝะพะต ะธัะฟัะฐะฒะปะตะฝะธะต (1 ัััะพะบะฐ)

**ะะทะผะตะฝะตะฝะธั:**
1. **modules/wallet/controller.ts** ัััะพะบะฐ ~450:
   ```typescript
   // ะะฐะผะตะฝะธัั:
   let user = await userRepository.getUserByTelegramId(telegram.user.id);
   // ะะฐ:
   let user = await userRepository.getUserByTelegramId(telegram.user.telegram_id);
   ```

**ะขะตััะธัะพะฒะฐะฝะธะต:**
1. ะกะพะทะดะฐัั ัะตััะพะฒะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั
2. ะะพะดะบะปััะธัั TON ะบะพัะตะปะตะบ
3. ะกะดะตะปะฐัั ะดะตะฟะพะทะธั
4. ะัะพะฒะตัะธัั ะทะฐัะธัะปะตะฝะธะต ะฝะฐ ะฟัะฐะฒะธะปัะฝัะน ะฐะบะบะฐัะฝั

**ะัะบะฐั:**
- Git revert ะพะดะฝะพะณะพ ะบะพะผะผะธัะฐ
- ะะธะบะฐะบะธั ะธะทะผะตะฝะตะฝะธะน ะฒ ะะ ะฝะต ััะตะฑัะตััั

### ะะฐัะธะฐะฝั B: ะะพะปะฝะพะต ัะตัะตะฝะธะต ั ะทะฐัะธัะพะน

**ะะทะผะตะฝะตะฝะธั:**

1. **modules/user/repository.ts** - ะดะพะฑะฐะฒะธัั ะผะตัะพะด:
   ```typescript
   async findUserByJWTContext(jwtUser: any): Promise<User | null> {
     // ะะฝะพะณะพััะพะฒะฝะตะฒัะน ะฟะพะธัะบ ะฟะพะปัะทะพะฒะฐัะตะปั
     // 1. ะะพ telegram_id
     // 2. ะะพ database ID  
     // 3. ะะพ username ั ะฟัะพะฒะตัะบะพะน
   }
   ```

2. **modules/wallet/controller.ts** - ะพะฑะฝะพะฒะธัั tonDeposit:
   ```typescript
   // ะัะฟะพะปัะทะพะฒะฐัั ะฝะพะฒัะน ะผะตัะพะด
   let user = await userRepository.findUserByJWTContext(telegram.user);
   
   // ะะพะฑะฐะฒะธัั ะฟัะพะฒะตัะบั ะฒะปะฐะดะตะปััะฐ ะบะพัะตะปัะบะฐ
   if (walletOwner && !isOwner) {
     return this.sendError(res, 'ะะพัะตะปะตะบ ะฟัะธะฝะฐะดะปะตะถะธั ะดััะณะพะผั ะฟะพะปัะทะพะฒะฐัะตะปั', 403);
   }
   ```

3. **ะะฐะทะฐ ะดะฐะฝะฝัั** - ะดะพะฑะฐะฒะธัั ะธะฝะดะตะบัั:
   ```sql
   CREATE INDEX idx_users_ton_wallet ON users(ton_wallet_address);
   CREATE INDEX idx_users_telegram_id ON users(telegram_id);
   ```

**ะขะตััะธัะพะฒะฐะฝะธะต:**
1. ะขะตัั ั ะฟัะฐะฒะธะปัะฝัะผ JWT
2. ะขะตัั ั ะฝะตะฒะตัะฝัะผ telegram_id
3. ะขะตัั ั ััะถะธะผ ะบะพัะตะปัะบะพะผ
4. ะขะตัั ัะพะทะดะฐะฝะธั ะฝะพะฒะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั
5. ะะฐะณััะทะพัะฝัะน ัะตัั

**ะะพะฝะธัะพัะธะฝะณ:**
```typescript
// ะะพะฑะฐะฒะธัั ะฒ tonDeposit:
logger.info('[TON Deposit] Resolution', {
  method: resolutionMethod,
  jwt_telegram_id: telegram.user.telegram_id,
  jwt_database_id: telegram.user.id,
  found_user_id: user?.id,
  wallet: wallet_address
});
```

**ะขะพัะบะธ ะพัะบะฐัะฐ:**
1. Feature flag: `ENABLE_JWT_CONTEXT_SEARCH=false`
2. ะัะบะฐั ะบะพะดะฐ ัะตัะตะท git
3. ะะฝะดะตะบัั ะผะพะถะฝะพ ะพััะฐะฒะธัั - ะพะฝะธ ะฝะต ะฒะปะธััั ะฝะฐ ะปะพะณะธะบั

---

## โ ะะะะะะะะะะฆะะฏ

### ะะปั ะฑััััะพะณะพ ัะตัะตะฝะธั ะฟัะพะฑะปะตะผั:
**ะัะฟะพะปัะทัะนัะต ะะฐัะธะฐะฝั A** - ะธัะฟัะฐะฒะปะตะฝะธะต ะพะดะฝะพะน ัััะพะบะธ. ะญัะพ ัะตัะธั 95% ะฟัะพะฑะปะตะผ ั ะผะธะฝะธะผะฐะปัะฝัะผ ัะธัะบะพะผ.

### ะะปั ะดะพะปะณะพััะพัะฝะพะน ะฝะฐะดะตะถะฝะพััะธ:
**ะะฝะตะดัะธัะต ะะฐัะธะฐะฝั B** ะฟะพัะปะต ัะตััะธัะพะฒะฐะฝะธั ะะฐัะธะฐะฝัะฐ A. ะญัะพ ะพะฑะตัะฟะตัะธั:
- ะะฐัะธัั ะพั edge cases
- ะััััั ะดะธะฐะณะฝะพััะธะบั
- ะะพัะพะฒะฝะพััั ะบ ะฑัะดััะธะผ ะธะทะผะตะฝะตะฝะธัะผ

### ะะฐัะฐะฝัะธะธ:
- โ TON ะดะตะฟะพะทะธัั ะฑัะดัั ะทะฐัะธัะปััััั ะผะณะฝะพะฒะตะฝะฝะพ
- โ ะะต ััะตะฑัะตััั ะผะธะณัะฐัะธั ะฝะฐ telegram_id
- โ ะััะณะธะต ะผะฐัััััั ะฝะต ะทะฐััะฐะณะธะฒะฐัััั
- โ ะะธัะบ ะฟะพัะตัะธ ะดะฐะฝะฝัั ะผะธะฝะธะผะฐะปะตะฝ

---

**ะะพะบัะผะตะฝั ะฟะพะดะณะพัะพะฒะปะตะฝ:** 21 ัะฝะฒะฐัั 2025  
**ะกัะฐััั:** ะะพัะพะฒ ะบ ะพะฑััะถะดะตะฝะธั ะฒัะฑะพัะฐ ะฒะฐัะธะฐะฝัะฐ