# üîß –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –î–£–ë–õ–ò–ö–ê–¢–û–í - –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–´–ô

**–î–∞—Ç–∞:** 3 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** –í–´–°–û–ö–ê–Ø  
**–°—Ç–∞—Ç—É—Å:** –ì–û–¢–û–í –ö –†–ï–ê–õ–ò–ó–ê–¶–ò–ò  

## üéØ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ù–ê–ô–î–ï–ù–ê

**–ò—Å—Ç–æ—á–Ω–∏–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:** `modules/referral/service.ts`, —Å—Ç—Ä–æ–∫–∏ 331-345  
**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è REFERRAL_REWARD —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π  
**–¢—Ä–∏–≥–≥–µ—Ä:** Race conditions –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ —Ñ–∞—Ä–º–∏–Ω–≥–∞ (`core/scheduler/farmingScheduler.ts`)  

### –ú–µ—Ö–∞–Ω–∏–∑–º —Å–æ–∑–¥–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:
1. –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ñ–∞—Ä–º–∏–Ω–≥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç UNI —Ñ–∞—Ä–º–∏–Ω–≥ –¥–æ—Ö–æ–¥—ã
3. –í—ã–∑—ã–≤–∞–µ—Ç `referralService.distributeReferralRewards()`
4. –°–æ–∑–¥–∞–µ—Ç REFERRAL_REWARD —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–ï–ó –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
5. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—É—Å–∫–µ - —Å–æ–∑–¥–∞—é—Ç—Å—è –¥—É–±–ª–∏

## üîç –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏ –∫–æ–¥–∞:

**1. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å (modules/referral/service.ts:331-345):**
```typescript
await transactionService.createTransaction({
  user_id: parseInt(commission.userId),
  type: 'REFERRAL_REWARD',
  amount_uni: currency === 'UNI' ? parseFloat(commission.amount) : 0,
  amount_ton: currency === 'TON' ? parseFloat(commission.amount) : 0,
  // ‚ùå –ù–ï–¢ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
});
```

**2. –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ñ–∞—Ä–º–∏–Ω–≥–∞ (core/scheduler/farmingScheduler.ts:321-337):**
```typescript
// –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –æ—Ç UNI —Ñ–∞—Ä–º–∏–Ω–≥–∞
const referralResult = await referralService.distributeReferralRewards(
  farmer.user_id.toString(),
  income,
  'UNI',
  'farming'
);
// ‚ùå –ù–ï–¢ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
```

## üõ†Ô∏è –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –í–∞—Ä–∏–∞–Ω—Ç 1: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–µ (–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô)
```typescript
// –î–æ–±–∞–≤–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ metadata
const uniqueKey = `${sourceUserId}_${commission.userId}_${commission.level}_${Math.floor(Date.now() / 60000)}`; // –º–∏–Ω—É—Ç–∞

await transactionService.createTransaction({
  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
  metadata: {
    source_user_id: parseInt(sourceUserId),
    level: commission.level,
    percentage: commission.percentage,
    source_type: sourceType,
    dedup_key: uniqueKey // ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á
  }
});
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
–ü–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º REFERRAL_REWARD –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∏–Ω—É—Ç.

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞  
–î–æ–±–∞–≤–∏—Ç—å distributed lock –≤ `farmingScheduler.ts` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π.

## üìã –®–ê–ì–ò –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –≠—Ç–∞–ø 1: –ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `core/TransactionService.ts` –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
- ‚ùå –ù–∞–π—Ç–∏ –ø–æ—á–µ–º—É REFERRAL_REWARD –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è
- ‚ùå –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –≠—Ç–∞–ø 2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚ùå –î–æ–±–∞–≤–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –¥–ª—è REFERRAL_REWARD
- ‚ùå –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚ùå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–æ–≤—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

### –≠—Ç–∞–ø 3: –í–∞–ª–∏–¥–∞—Ü–∏—è
- ‚ùå –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
- ‚ùå –£–±–µ–¥–∏—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- ‚ùå –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–Ω

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø

1. **–ù–ï –ò–ó–ú–ï–ù–Ø–¢–¨ –ö–û–î** –¥–æ –ø–æ–ª–Ω–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –≤ `TransactionService`
2. **–°–û–•–†–ê–ù–ò–¢–¨** –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
3. **–î–û–ë–ê–í–ò–¢–¨** —Ç–æ–ª—å–∫–æ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é, –Ω–µ –Ω–∞—Ä—É—à–∞—è –ª–æ–≥–∏–∫—É
4. **–ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–¢–¨** –Ω–∞ –Ω–µ–±–æ–ª—å—à–æ–π –≤—ã–±–æ—Ä–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

- ‚úÖ –ü–æ–ª–Ω–æ–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ REFERRAL_REWARD
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è

**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 30-60 –º–∏–Ω—É—Ç  
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** 15-30 –º–∏–Ω—É—Ç  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–Ω:** 1-2 —á–∞—Å–∞