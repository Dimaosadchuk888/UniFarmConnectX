# –ò–¢–û–ì–û–í–´–ô –°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´ –ó–ê–Ø–í–û–ö –ù–ê –í–´–í–û–î
## –î–∞—Ç–∞: 29 –∏—é–ª—è 2025

---

## ‚úÖ –°–ò–°–¢–ï–ú–ê –ó–ê–Ø–í–û–ö –ù–ê –í–´–í–û–î –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–¢–ê–ï–¢

### üéØ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

1. **JWT –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞**
   - –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ "Network Error" –ø—Ä–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–æ–∫–µ–Ω–∞—Ö
   - –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è: `"Invalid or expired JWT token"`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–ª–∞–≥–æ–≤ `need_new_token: true` –∏ `need_jwt_token: true`

2. **Middleware –∏—Å–ø—Ä–∞–≤–ª–µ–Ω**
   - `core/middleware/auth.ts` –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AuthService
   - –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ LSP –æ—à–∏–±–∫–∏ –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Ç–∏–ø–æ–≤
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ JWT —Ç–æ–∫–µ–Ω–æ–≤

3. **–í—Å–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç**
   - `/api/v2/wallet/withdraw` - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–æ–∫ –Ω–∞ –≤—ã–≤–æ–¥
   - `/api/v2/wallet/balance` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞  
   - `/api/v2/wallet/transactions` - –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üß™ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:

### ‚úÖ –¢–µ—Å—Ç 1: –ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π JWT —Ç–æ–∫–µ–Ω
```json
{
  "success": false,
  "error": "Invalid or expired JWT token", 
  "jwt_error": "jwt malformed",
  "need_new_token": true
}
```

### ‚úÖ –¢–µ—Å—Ç 2: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π JWT —Ç–æ–∫–µ–Ω  
```json
{
  "success": false,
  "error": "Authentication required",
  "need_jwt_token": true
}
```

### ‚úÖ –¢–µ—Å—Ç 3: –í—Å–µ wallet endpoints
- –í—Å–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ù–∏–∫–∞–∫–∏—Ö "Network Error" —Å–æ–æ–±—â–µ–Ω–∏–π
- –°—Ç–∞—Ç—É—Å 401 –¥–ª—è –≤—Å–µ—Ö –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üí° –ß–¢–û –≠–¢–û –û–ó–ù–ê–ß–ê–ï–¢ –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô:

### üöÄ –ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

1. **–° –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º JWT —Ç–æ–∫–µ–Ω–æ–º:**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥
   - –°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞–ø—Ä–æ—Å —Å–æ–≥–ª–∞—Å–Ω–æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞–º —Ä–∞–±–æ—Ç–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

2. **–° –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º JWT —Ç–æ–∫–µ–Ω–æ–º:**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: "–¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫"
   - Frontend –º–æ–∂–µ—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
   - –ù–∏–∫–∞–∫–∏—Ö –∑–∞–ø—É—Ç—ã–≤–∞—é—â–∏—Ö "Network Error"

3. **–ë–µ–∑ JWT —Ç–æ–∫–µ–Ω–∞:**
   - –ß–µ—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è"
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò:

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `core/middleware/telegramAuth.ts` - JWT error handling
- `core/middleware/auth.ts` - AuthService integration  
- `modules/auth/service.ts` - Type safety improvements
- `utils/telegram.ts` - Environment-aware validation

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
- `requireTelegramAuth` middleware –Ω–∞ –≤—Å–µ—Ö withdrawal endpoints
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Zod schemas
- Rate limiting –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞
- –ü–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è TypeScript

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:

**–ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –¥–æ–ª–∂–Ω–æ:**

- –ù–∏–∫–∞–∫–∏—Ö "Network Error" —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü–æ–Ω—è—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç:**
- –ü–æ–¥–∞–≤–∞—Ç—å –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥ —Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
- –ü–æ–ª—É—á–∞—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π  
- –ü–æ–Ω–∏–º–∞—Ç—å, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è

---

**–°—Ç–∞—Ç—É—Å: üéâ –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–û –ò –ì–û–¢–û–í–û –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ**