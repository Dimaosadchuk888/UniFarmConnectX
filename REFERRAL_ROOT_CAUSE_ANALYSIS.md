# –ê–ù–ê–õ–ò–ó –ö–û–†–ù–ï–í–û–ô –ü–†–ò–ß–ò–ù–´ –ü–†–û–ë–õ–ï–ú–´ –†–ï–§–ï–†–ê–õ–¨–ù–û–ô –°–ò–°–¢–ï–ú–´

## üîç –†–ï–ó–£–õ–¨–¢–ê–¢–´ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò

### –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:

1. **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê #1**: Auth Routes –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `ref_by`
   - ‚úÖ Auth Controller –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `ref_by` 
   - ‚ùå Auth Routes –ù–ï –∏–∑–≤–ª–µ–∫–∞–µ—Ç `ref_by` –∏–∑ initData
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç**: —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä —Ç–µ—Ä—è–µ—Ç—Å—è –¥–æ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä

2. **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê #2**: Telegram Middleware –ù–ï –∏–∑–≤–ª–µ–∫–∞–µ—Ç `ref_by`
   - ‚úÖ InitData –∏ HMAC –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞—é—Ç
   - ‚ùå `ref_by` –ù–ï –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ Telegram initData
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç**: —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã

3. **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê #3**: Supabase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ–ø–æ–ª–Ω–∞—è
   - ‚úÖ createClient –Ω–∞—Å—Ç—Ä–æ–µ–Ω
   - ‚ùå Auth setup –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
   - ‚ùå RLS references –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –∑–∞–ø–∏—Å–µ–π

## üéØ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê

**–û–°–ù–û–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê**: `ref_by` –ø–∞—Ä–∞–º–µ—Ç—Ä **–ù–ï –ò–ó–í–õ–ï–ö–ê–ï–¢–°–Ø** –∏–∑ Telegram `initData`

### –¶–µ–ø–æ—á–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫—É —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º: `t.me/bot?start=REF123`
2. Telegram –ø–µ—Ä–µ–¥–∞–µ—Ç `start_param=REF123` –≤ `initData` 
3. ‚ùå Middleware `utils/telegram.ts` –ù–ï –∏–∑–≤–ª–µ–∫–∞–µ—Ç `start_param`/`ref_by`
4. ‚ùå Routes –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
5. Controller –ø–æ–ª—É—á–∞–µ—Ç `ref_by = undefined`
6. AuthService **–ù–ï –í–´–ó–´–í–ê–ï–¢** `processReferralInline()` —Ç.–∫. –Ω–µ—Ç `ref_by`
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å `referred_by = null`

## üîß –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –≠—Ç–∞–ø 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ ref_by –∏–∑ initData
```typescript
// –í utils/telegram.ts –¥–æ–±–∞–≤–∏—Ç—å:
const extractStartParam = (initData: string) => {
  const params = new URLSearchParams(initData);
  const startParam = params.get('start_param');
  return startParam; // –≠—Ç–æ –∏ –µ—Å—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥
}
```

### –≠—Ç–∞–ø 2: –ü–µ—Ä–µ–¥–∞—Ç—å ref_by –≤ middleware
- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `telegramAuth` middleware –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è start_param
- –î–æ–±–∞–≤–∏—Ç—å `req.telegramData.ref_by = startParam`

### –≠—Ç–∞–ø 3: –û–±–Ω–æ–≤–∏—Ç—å routes –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ ref_by
- –í Auth Routes –¥–æ–±–∞–≤–∏—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ `ref_by` –∏–∑ `req.telegramData`
- –ü–µ—Ä–µ–¥–∞—Ç—å –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä

### –≠—Ç–∞–ø 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Supabase RLS policies
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ `referrals` –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ policies
- –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞—Ç—å policy –¥–ª—è INSERT

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ù–ê–•–û–î–ö–ò

1. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏**:
   - `findOrCreateFromTelegram` (–æ—Å–Ω–æ–≤–Ω–æ–π)
   - `registerDirectFromTelegramUser` (–¥–ª—è –ø—Ä—è–º–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
   - `createUser` (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π)

2. **processReferral –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è 3 —Ä–∞–∑–∞** –Ω–æ –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:
   - –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ—Ç `ref_by` –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –Ω–∞ –≤—Ö–æ–¥–µ

3. **Controller –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ref_by**:
   - –ú–∞–ø–ø–∏–Ω–≥ `refBy ‚Üí ref_by` —Ä–∞–±–æ—Ç–∞–µ—Ç
   - –ü—Ä—è–º–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –∫–æ–¥—ã
   - **–ù–û** –¥–∞–Ω–Ω—ã–µ –Ω–µ –¥–æ—Ö–æ–¥—è—Ç –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º –Ω–∞ —É—Ä–æ–≤–Ω–µ middleware/routes

## üìä –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ò–ô –ß–ï–ö–õ–ò–°–¢

### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
- AuthService.processReferralInline() –ª–æ–≥–∏–∫–∞
- AuthController –æ–±—Ä–∞–±–æ—Ç–∫–∞ ref_by
- Supabase createClient –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- –°—Ö–µ–º–∞ –ë–î (–≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏ –ø–æ–ª—è –µ—Å—Ç—å)
- ReferralService –º–µ—Ç–æ–¥—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç

### ‚ùå –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ start_param –∏–∑ Telegram initData
- –ü–µ—Ä–µ–¥–∞—á–∞ ref_by —á–µ—Ä–µ–∑ middleware chain
- Auth Routes –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- Supabase Auth/RLS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤–æ–∑–º–æ–∂–Ω–æ)

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ù–∞–π—Ç–∏ –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å** `utils/telegram.ts` - –∫–∞–∫ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è initData
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å middleware chain** - –≥–¥–µ —Ç–µ—Ä—è–µ—Ç—Å—è ref_by
3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ start_param –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ Telegram initData
4. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å** —Ü–µ–ø–æ—á–∫—É –ø–µ—Ä–µ–¥–∞—á–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
5. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å** Supabase RLS policies –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã referrals

---

**–í–´–í–û–î**: –ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ processReferralInline(), –∞ –≤ —Ç–æ–º, —á—Ç–æ **—Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–æ–æ–±—â–µ –Ω–µ –¥–æ—Ö–æ–¥—è—Ç –¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏** –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º –≤ middleware/routes —Ü–µ–ø–æ—á–∫–µ.