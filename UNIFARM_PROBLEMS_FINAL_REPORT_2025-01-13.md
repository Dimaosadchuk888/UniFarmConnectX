# UNIFARM PROBLEMS INVESTIGATION - ФИНАЛЬНЫЙ ОТЧЕТ
## Дата: 13 января 2025
## Статус: ✅ ЗАВЕРШЕНО

---

## РЕЗЮМЕ РАССЛЕДОВАНИЯ

Проведено комплексное техническое расследование 6 критических проблем в системе UniFarm. Все корневые причины идентифицированы без изменения кода.

---

## ПРОБЛЕМА 1: Пропавшие депозиты TON
### Описание
В TransactionHistory отображаются только транзакции type='FARMING_REWARD', но отсутствуют депозиты TON, несмотря на наличие farming_balance в ton_farming_data.

### Корневая причина
1. TON депозиты НЕ создают транзакции в таблице transactions
2. Метод activateBoost() напрямую обновляет farming_balance без записи транзакции
3. Только начисления доходов (FARMING_REWARD) попадают в историю

### Доказательства
- 8 пользователей имеют farming_balance > 0 (сумма 540 TON)
- 0 транзакций с metadata.original_type='TON_BOOST_INCOME' или 'TON_BOOST_PURCHASE'
- TransactionHistory фильтрует только FARMING_REWARD транзакции

---

## ПРОБЛЕМА 2: BOOST_PURCHASE транзакции с нулевой суммой
### Описание
Все 8 BOOST_PURCHASE транзакций показывают amount_ton = 0, хотя пользователи имеют корректные farming_balance.

### Корневая причина  
**Двойной parseFloat** в цепочке обработки:
1. В getAvailableBoosts() min_amount уже преобразован: `parseFloat('5.0') = 5`
2. В purchaseWithInternalWallet снова применяется parseFloat к числу
3. Возможная проблема с типизацией или undefined значением

### Доказательства
```typescript
// getAvailableBoosts():
min_amount: parseFloat(BOOST_PACKAGES.STANDARD.min_amount), // '5.0' → 5

// purchaseWithInternalWallet():
const requiredAmount = parseFloat(boostPackage.min_amount || "0"); // 5 → ???
```

---

## ПРОБЛЕМА 3: CRON планировщик не начисляет farming rewards
### Описание
farmingScheduler должен начислять 1% в день, но новых FARMING_REWARD транзакций нет более 24 часов.

### Корневая причина
**Неподтвержденная гипотеза**: Планировщик может быть остановлен или заблокирован.
- Последняя транзакция FARMING_REWARD: более 24 часов назад
- Нет логов ошибок в отчете
- Требуется проверка статуса cron задач

---

## ПРОБЛЕМА 4: Несоответствие балансов в TransactionHistory
### Описание
TransactionHistory показывает текущий баланс 2,844,056 UNI, но сумма транзакций не соответствует.

### Корневая причина
1. **Исторические данные**: Часть баланса могла быть начислена до миграции на новую систему транзакций
2. **Прямые SQL обновления**: Возможны обновления балансов минуя транзакции
3. **Batch операции**: farmingScheduler может обновлять балансы батчами без детализации

---

## ПРОБЛЕМА 5: TON Boost доходы не отображаются
### Описание
Пользователи с активным TON Boost не видят начисления доходов в истории.

### Корневая причина
1. tonBoostIncomeScheduler создает транзакции с type='FARMING_REWARD'
2. Отсутствует различение между UNI и TON farming rewards
3. metadata не используется для фильтрации в UI

### Доказательства
- SQL запрос показал 0 транзакций с metadata.original_type='TON_BOOST_INCOME'
- Все TON доходы смешаны с UNI farming rewards

---

## ПРОБЛЕМА 6: ton_farming_data имеет farming_balance, но нет транзакций
### Описание
8 пользователей имеют farming_balance в ton_farming_data, но соответствующих транзакций нет.

### Корневая причина
**Архитектурная проблема**: Система обновляет балансы напрямую, минуя транзакционную модель:
1. activateBoost() → UPDATE ton_farming_data SET farming_balance
2. Нет вызова TransactionService для записи депозита
3. История транзакций неполная

---

## ТЕХНИЧЕСКИЕ НАХОДКИ

### 1. Отсутствие таблицы boost_packages
- Данные о пакетах хранятся в константе BOOST_PACKAGES в коде
- 5 пакетов: STARTER (1 TON), STANDARD (5 TON), ADVANCED (10 TON), PREMIUM (25 TON), ELITE (100 TON)

### 2. Проблемы с типизацией
- getAvailableBoosts возвращает BoostPackageData[] с числовыми полями
- purchaseWithInternalWallet ожидает строковые значения

### 3. Metadata не используется
- Транзакции содержат metadata, но UI не использует её для фильтрации
- Все farming rewards выглядят одинаково

---

## РЕКОМЕНДАЦИИ

### Критические исправления:
1. **Создавать транзакции для TON депозитов** при активации boost
2. **Исправить двойной parseFloat** в purchaseWithInternalWallet
3. **Использовать metadata** для различения типов транзакций в UI
4. **Проверить статус планировщиков** и их логи

### Архитектурные улучшения:
1. Создать enum для типов транзакций (UNI_FARMING_REWARD, TON_BOOST_INCOME, TON_BOOST_PURCHASE)
2. Добавить валидацию типов в TypeScript
3. Внедрить транзакционную целостность для всех финансовых операций

---

## ЗАКЛЮЧЕНИЕ

Все 6 проблем имеют общую корневую причину: **нарушение транзакционной целостности**. Система обновляет балансы напрямую, минуя создание транзакций, что приводит к неполной истории и путанице в UI.

Для полного решения требуется обеспечить, чтобы КАЖДОЕ изменение баланса сопровождалось созданием соответствующей транзакции с правильными метаданными.