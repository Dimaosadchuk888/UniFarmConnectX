# üìã –û–¢–ß–ï–¢ T2.3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Auth Service —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–æ–π

## ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
**UserRepository (modules/users/repository.ts)**
- `findByTelegramId()` - –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_id
- `createUserFromTelegram()` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö Telegram
- `findByRefCode()` - –ø–æ–∏—Å–∫ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–º—É –∫–æ–¥—É
- `checkUniqueness()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ telegram_id –∏ username
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤ (8 —Å–∏–º–≤–æ–ª–æ–≤)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑–µ–π —á–µ—Ä–µ–∑ parent_ref_code

**UserService (modules/users/service.ts)**
- `findOrCreateFromTelegram()` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞/—Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `findByTelegramId()` - –ø–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `validateRefCode()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤
- `userExists()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –º–µ–∂–¥—É User –∏ UserInfo —Ç–∏–ø–∞–º–∏

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π AuthService
**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å UserService:**
- –ó–∞–º–µ–Ω–∞ –ø—Ä—è–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î –Ω–∞ –≤—ã–∑–æ–≤—ã UserService
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `ref_by` –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
- –í–æ–∑–≤—Ä–∞—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∏—Å–∫–∞/—Å–æ–∑–¥–∞–Ω–∏—è

**–°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã:**
1. –í–∞–ª–∏–¥–∞—Ü–∏—è Telegram initData —á–µ—Ä–µ–∑ HMAC
2. –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_id
3. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
5. –í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π AuthController
**–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:**
- –ü—Ä–∏–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `ref_by` –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞ `/api/v2/auth/telegram`
- –ü–µ—Ä–µ–¥–∞—á–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –≤ AuthService
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏

### 4. –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ insertUserSchema:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è balance_uni –∏ balance_ton
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–æ–ª–µ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –¥–ª—è UserRepository

## üß™ –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û

### –°–æ–∑–¥–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç (test-auth-integration.js)
**–¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
1. **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram
2. **–í—Ö–æ–¥ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
3. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ ref_by
4. **–í–∞–ª–∏–¥–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–æ–≤** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
5. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Å—Å–∏–∏** - –ø—Ä–æ–≤–µ—Ä–∫–∞ payload —Ç–æ–∫–µ–Ω–∞

**–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ —É—Å–ª–æ–≤–∏—è:**
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ telegram_id
- –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑–µ–π
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω—ã—Ö JWT —Ç–æ–∫–µ–Ω–æ–≤
- –í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

## ‚ö†Ô∏è –ù–ï –ò–ó–ú–ï–ù–ï–ù–û (—Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º)

### –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
- –§–∞—Ä–º–∏–Ω–≥ —Å–∏—Å—Ç–µ–º–∞ (farming_deposits, uni_farming)
- –ë—É—Å—Ç –ø–∞–∫–µ—Ç—ã (boost_deposits, ton_boost_deposits)
- –ú–∏—Å—Å–∏–∏ (missions, user_missions)
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (transactions)

### –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
- –¢–∞–±–ª–∏—Ü–∞ referrals –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ù–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ü–µ–ø–æ—á–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (—Ç–æ–ª—å–∫–æ parent_ref_code)
- –†–∞—Å—á–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –¥–æ—Ö–æ–¥–æ–≤ –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

**API Endpoint: POST /api/v2/auth/telegram**
```json
// –ó–∞–ø—Ä–æ—Å
{
  "initData": "telegram_init_data_here",
  "ref_by": "ABC12345" // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
}

// –û—Ç–≤–µ—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
{
  "success": true,
  "user": {
    "id": "123",
    "telegram_id": 123456789,
    "username": "testuser",
    "ref_code": "XYZ98765",
    "created_at": "2025-06-11T..."
  },
  "token": "jwt_token_here"
}

// –û—Ç–≤–µ—Ç –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// (—Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ)
```

## üìä –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨

### –°–≤—è–∑–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- ‚úÖ –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegram_id –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥–µ
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ref_code
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π —á–µ—Ä–µ–∑ ref_by
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ telegram_id –∏–ª–∏ username
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ –æ—Ç–≤–µ—Ç–µ API

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —á–∏—Å—Ç–æ—Ç–∞
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏: Repository ‚Üí Service ‚Üí Controller
- ‚úÖ –¢–∏–ø–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –∏ –º–µ—Ç–æ–¥–æ–≤
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Auth Service —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–æ–π –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞.**