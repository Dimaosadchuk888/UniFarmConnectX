# Миграция с Neon DB на PostgreSQL Replit

Этот документ описывает процесс перехода с Neon DB на встроенную PostgreSQL базу данных Replit для проекта UniFarm Remix. Миграция необходима для использования встроенной базы данных Replit вместо внешней Neon DB.

## 1. Цель миграции

Цель миграции - полностью отключить Neon DB и использовать только внутреннюю базу данных PostgreSQL на Replit. Это позволит:

- Работать без внешних зависимостей
- Ускорить работу приложения за счет локального размещения БД
- Упростить настройку и обслуживание

## 2. Настройка базы данных

### 2.1. Создание базы данных PostgreSQL

Для создания базы данных PostgreSQL на Replit необходимо:

1. Открыть вкладку `Tools` (Инструменты) в боковой панели Replit
2. Выбрать `Secrets` (Секреты)
3. Нажать на кнопку `+ Add a Secret` (Добавить секрет)
4. Создать секрет с ключом "database-postgresql" и значением "true"
5. После этого Replit автоматически создаст базу данных и добавит необходимые переменные окружения

### 2.2. Проверка переменных окружения

После создания базы данных будут автоматически добавлены следующие переменные окружения:

- `PGHOST` - хост базы данных
- `PGPORT` - порт базы данных (обычно 5432)
- `PGUSER` - имя пользователя
- `PGPASSWORD` - пароль пользователя
- `PGDATABASE` - имя базы данных
- `DATABASE_URL` - полный URL для подключения к базе данных

## 3. Миграция схемы данных

### 3.1. Запуск миграции

Для миграции схемы базы данных необходимо выполнить команду:

```bash
node migrate-replit-db.js
```

Этот скрипт выполнит миграцию схемы базы данных с помощью Drizzle ORM.

### 3.2. Проверка успешности миграции

После выполнения миграции можно проверить состояние базы данных с помощью команды:

```bash
node drizzle-kit introspect
```

## 4. Запуск приложения с Replit PostgreSQL

### 4.1. Запуск приложения

Для запуска приложения с Replit PostgreSQL используйте команду:

```bash
node start-with-replit-db.js
```

### 4.2. Подтверждение использования Replit PostgreSQL

Для проверки, что приложение использует Replit PostgreSQL, а не Neon DB, можно выполнить SQL-запрос:

```sql
SELECT current_database(), current_user, inet_server_addr(), inet_server_port();
```

## 5. Устранение неполадок

### 5.1. Проблемы с миграцией

Если возникают проблемы с миграцией, попробуйте выполнить следующие шаги:

1. Проверьте, что все переменные окружения доступны
2. Попробуйте выполнить команду `drizzle-kit push:pg` вручную
3. Проверьте логи ошибок в консоли

### 5.2. Проблемы с подключением

Если возникают проблемы с подключением к базе данных:

1. Убедитесь, что база данных запущена и доступна
2. Проверьте, что переменные окружения имеют правильные значения
3. Подтвердите, что приложение использует правильные настройки подключения

## 6. Дополнительные ресурсы

- [Документация Replit по PostgreSQL](https://docs.replit.com/hosting/databases/postgresql-database)
- [Документация Drizzle ORM](https://orm.drizzle.team/docs/overview)
- [Справочник по командам PostgreSQL](https://www.postgresql.org/docs/current/sql-commands.html)