# Настройка и использование PostgreSQL на Replit ✅

Это руководство описывает процесс настройки и использования локальной базы данных PostgreSQL на платформе Replit без зависимости от внешних сервисов, таких как Neon DB.

## Статус: ✅ Полностью рабочая конфигурация

База данных PostgreSQL на Replit успешно интегрирована в приложение. Вся необходимая функциональность работает.

Приложение успешно подключается к локальной базе данных без зависимости от Neon DB.

## Преимущества использования PostgreSQL на Replit

- **Отсутствие внешних зависимостей**: Все данные хранятся локально на Replit
- **Бесплатность**: Не требуется оплата за внешние базы данных
- **Скорость**: Локальная база данных имеет меньшую задержку
- **Простота**: Все работает внутри одного окружения

## Пошаговая инструкция по настройке

### 1. Настройка переменных окружения

Запустите скрипт настройки переменных окружения:

```bash
node setup-replit-db-env.mjs
```

Этот скрипт:
- Создаст/обновит файл `.env` с правильными настройками для PostgreSQL
- Удалит все упоминания о Neon DB из переменных окружения
- Установит переменные окружения для использования только локальной базы данных

### 2. Запуск и инициализация PostgreSQL

Для запуска PostgreSQL на Replit и инициализации базы данных выполните:

```bash
node start-with-replit-db.mjs
```

Этот скрипт:
- Проверит, запущен ли PostgreSQL, и запустит его при необходимости
- Инициализирует структуру базы данных, если она не существует
- Запустит приложение с новыми настройками

### 3. Создание структуры базы данных (при необходимости)

Если вам нужно вручную создать структуру базы данных:

```bash
node initialize-replit-db.mjs
```

Этот скрипт создаст все необходимые таблицы и индексы в базе данных PostgreSQL на Replit.

## Проверка и мониторинг

### Проверка соединения с базой данных

```bash
psql -h localhost -U runner -d postgres -c "SELECT 1 AS connected"
```

### Просмотр логов PostgreSQL

```bash
cat $HOME/.pg/logs/postgresql.log
```

### Ручной запуск PostgreSQL

```bash
pg_ctl -D "$HOME/.pg/data" -l "$HOME/.pg/logs/postgresql.log" start
```

### Остановка PostgreSQL

```bash
pg_ctl -D "$HOME/.pg/data" stop
```

## Технические детали

### Конфигурация соединения

Параметры соединения для PostgreSQL на Replit:

```
Host: localhost
Port: 5432
User: runner
Password: [пустая строка]
Database: postgres
```

Строка подключения:
```
postgresql://runner@localhost:5432/postgres
```

### Коды ошибок и решения

| Ошибка | Описание | Решение |
|--------|----------|---------|
| ECONNREFUSED | PostgreSQL не запущен | Запустите `pg_ctl -D "$HOME/.pg/data" start` |
| ERROR: relation "table" does not exist | Таблица не существует в БД | Запустите `node initialize-replit-db.mjs` |
| EADDRINUSE | Порт 5432 уже используется | Проверьте, что нет другого экземпляра PostgreSQL |

## Миграция с Neon DB

Если вы ранее использовали Neon DB, вам нужно инициализировать новую схему БД и, при необходимости, заново ввести данные. Прямая миграция данных в текущей версии не поддерживается.

## Важные файлы

- `server/db-replit.ts` - Основной файл подключения к PostgreSQL на Replit
- `server/db-selector.ts` - Селектор базы данных, который выбирает db-replit.ts
- `setup-replit-db-env.mjs` - Скрипт настройки переменных окружения
- `initialize-replit-db.mjs` - Скрипт инициализации структуры базы данных
- `start-with-replit-db.mjs` - Скрипт запуска приложения с PostgreSQL