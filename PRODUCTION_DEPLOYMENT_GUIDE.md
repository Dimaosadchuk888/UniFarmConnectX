# Руководство по деплою UniFarm в продакшн

Этот документ описывает процесс деплоя приложения UniFarm в продакшн-окружение с использованием Neon DB.

## Требования для деплоя

1. Рабочее подключение к Neon DB (переменная окружения `DATABASE_URL`)
2. Настроенный Telegram бот (переменная окружения `TELEGRAM_BOT_TOKEN`)
3. Доступ к Replit Deploy

## Шаги по деплою

### 1. Подготовка к деплою

1. Убедитесь, что все ваши изменения сохранены и закоммичены.
2. Проверьте работоспособность приложения в локальном окружении.
3. Проверьте подключение к Neon DB с помощью скрипта:
   ```
   node check-neon-db-connection.js
   ```

### 2. Деплой приложения

#### Автоматический деплой (рекомендуется)

Для деплоя с принудительным использованием Neon DB:

```
node deploy-with-neon.js
```

Этот скрипт:
- Сохранит резервную копию `.replit`
- Заменит его на версию с настройками Neon DB
- Выполнит деплой
- Восстановит оригинальный `.replit` после завершения

#### Ручной деплой

1. Замените `.replit` файл на `.replit.neon`:
   ```
   cp .replit.neon .replit
   ```

2. Запустите деплой:
   ```
   replit deploy
   ```

3. После завершения деплоя восстановите оригинальную конфигурацию:
   ```
   cp .replit.backup .replit
   ```

### 3. Проверка после деплоя

После успешного деплоя выполните следующие проверки:

1. Откройте приложение по URL деплоя.
2. Проверьте, что все основные функции работают корректно:
   - Аутентификация пользователей
   - Фарминг UNI и TON
   - Реферальная система
   - Партиционирование транзакций

3. Проверьте логи на наличие ошибок.

### 4. Настройка Telegram бота

После деплоя необходимо обновить webhook Telegram бота на новый URL:

```
node setup-telegram-bot.js
```

## Устранение неполадок

### Проблемы с базой данных

Если возникают проблемы с подключением к базе данных:

1. Проверьте переменные окружения:
   ```
   node check-neon-db-connection.js
   ```

2. При необходимости, запустите процесс партиционирования транзакций заново:
   ```
   node server/scripts/create-partitions.js
   ```

### Проблемы с ES модулями

При ошибках типа "require is not defined in ES module scope":

1. Убедитесь, что используете `start-deployment.js` вместо `start-unified.js`
2. Проверьте, что все `.js` файлы используют ES модули правильно
   
## Дополнительная информация

- База данных разделена на партиции по дате для таблицы transactions
- Приложение настроено на использование Neon DB в продакшне
- При деплое через `.replit.neon` будут проигнорированы любые настройки DATABASE_PROVIDER=replit