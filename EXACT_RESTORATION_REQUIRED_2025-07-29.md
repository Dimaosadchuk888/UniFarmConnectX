# üéØ –¢–û–ß–ù–´–ô –°–ü–ò–°–û–ö –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø - –ë–ï–ó –ù–û–í–´–• –§–£–ù–ö–¶–ò–ô

## –ß–¢–û –ù–£–ñ–ù–û –í–û–°–°–¢–ê–ù–û–í–ò–¢–¨ (–±—ã–ª–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ 29.07.2025)

### 1. UnifiedTransactionService.updateUserBalance() - –ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø TON –î–ï–ü–û–ó–ò–¢–û–í

**–§–∞–π–ª**: `core/TransactionService.ts`  
**–°—Ç—Ä–æ–∫–∏**: 387-399

**–°–ï–ô–ß–ê–° (—Å–ª–æ–º–∞–Ω–æ)**:
```typescript
private async updateUserBalance(...): Promise<void> {
  // –û–¢–ö–õ–Æ–ß–ï–ù–û: updateUserBalance –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫ –±–∞–ª–∞–Ω—Å–æ–≤
  logger.warn('[ANTI_ROLLBACK_PROTECTION] UnifiedTransactionService.updateUserBalance –û–¢–ö–õ–Æ–ß–ï–ù');
  // –ù–ï–ú–ï–î–õ–ï–ù–ù–´–ô –í–´–•–û–î - –ù–ï –û–ë–ù–û–í–õ–Ø–ï–ú –ë–ê–õ–ê–ù–°–´ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò
  return;
}
```

**–ù–£–ñ–ù–û –í–û–°–°–¢–ê–ù–û–í–ò–¢–¨ (–∫–∞–∫ –±—ã–ª–æ –¥–æ 29.07.2025)**:
```typescript
private async updateUserBalance(
  user_id: number, 
  amount_uni: number, 
  amount_ton: number, 
  type: TransactionsTransactionType
): Promise<void> {
  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º BalanceManager –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
    const balanceManager = BalanceManager.getInstance();
    
    if (amount_uni > 0) {
      await balanceManager.addBalance(user_id, amount_uni, 0);
    }
    
    if (amount_ton > 0) {
      await balanceManager.addBalance(user_id, 0, amount_ton);
    }

    logger.info('[UnifiedTransactionService] –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω', {
      user_id, amount_uni, amount_ton
    });

  } catch (error) {
    logger.error('[UnifiedTransactionService] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞', {
      user_id, error
    });
  }
}
```

---

### 2. BalanceManager.updateUserBalance() - –ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø –ö–û–†–†–ï–ö–¢–ù–û–°–¢–ò –û–ü–ï–†–ê–¶–ò–ô

**–§–∞–π–ª**: `core/BalanceManager.ts`  
**–°—Ç—Ä–æ–∫–∏**: 103-106

**–°–ï–ô–ß–ê–° (—Å–ª–æ–º–∞–Ω–æ)**:
```typescript
case 'subtract':
  // Math.max(0, balance - amount) –û–¢–ö–õ–Æ–ß–ï–ù - —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã
  newUniBalance = current.balance_uni - amount_uni;
  newTonBalance = current.balance_ton - amount_ton;
  // + –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–æ–≤
  break;
```

**–ù–£–ñ–ù–û –í–û–°–°–¢–ê–ù–û–í–ò–¢–¨ (–∫–∞–∫ –±—ã–ª–æ –¥–æ 29.07.2025)**:
```typescript
case 'subtract':
  newUniBalance = Math.max(0, current.balance_uni - amount_uni);
  newTonBalance = Math.max(0, current.balance_ton - amount_ton);
  break;
```

---

### 3. TransactionEnforcer.enforcePolicy() - –ú–ï–ù–ï–ï –ö–†–ò–¢–ò–ß–ù–û

**–§–∞–π–ª**: `core/TransactionEnforcer.ts`  
**–°—Ç—Ä–æ–∫–∏**: 89-108

**–°–ï–ô–ß–ê–° (—Å–ª–æ–º–∞–Ω–æ)**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã

**–ù–£–ñ–ù–û –í–û–°–°–¢–ê–ù–û–í–ò–¢–¨**: –õ–æ–≥–∏–∫—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–∫–∞–∫ –±—ã–ª–æ –¥–æ 29.07.2025)

---

## –ß–¢–û –ù–ï –ù–£–ñ–ù–û –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–¢–¨

### 1. BatchBalanceProcessor.invalidateBatch() - –ù–ï –ö–†–ò–¢–ò–ß–ù–û
- –ú–∞—Å—Å–æ–≤–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞ –±–∞–ª–∞–Ω—Å–æ–≤
- –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ TON –¥–µ–ø–æ–∑–∏—Ç—ã
- **–û–°–¢–ê–í–ò–¢–¨ –û–¢–ö–õ–Æ–ß–ï–ù–ù–´–ú**

### 2. TransactionsService.recalculateUserBalance() - –ù–ï –ö–†–ò–¢–ò–ß–ù–û  
- –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–ª–∞ –Ω—É–ª–µ–≤—ã–µ –±–∞–ª–∞–Ω—Å—ã (0, 0)
- –ë–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –∏–∑-–∑–∞ –±–∞–≥–æ–≤
- **–û–°–¢–ê–í–ò–¢–¨ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ù–´–ú**

### 3. TransactionEnforcer.detectDirectSQLUpdates() - –ù–ï –ö–†–ò–¢–ò–ß–ù–û
- –î–µ—Ç–µ–∫—Ç–æ—Ä "–ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö" –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–æ–≤
- –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- **–ú–û–ñ–ù–û –û–°–¢–ê–í–ò–¢–¨ –û–¢–ö–õ–Æ–ß–ï–ù–ù–´–ú**

### 4. SQL —Å–∫—Ä–∏–ø—Ç —É–¥–∞–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ - –ù–ï –ö–†–ò–¢–ò–ß–ù–û
- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ `.DISABLED_ROLLBACK_PROTECTION`
- –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ç–µ–∫—É—â—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- **–û–°–¢–ê–í–ò–¢–¨ –û–¢–ö–õ–Æ–ß–ï–ù–ù–´–ú**

---

## –ü–†–ò–û–†–ò–¢–ï–¢–´ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø

### –ü–†–ò–û–†–ò–¢–ï–¢ 1 (–ö–†–ò–¢–ò–ß–ù–û - –ë–ï–ó –≠–¢–û–ì–û TON –î–ï–ü–û–ó–ò–¢–´ –ù–ï –†–ê–ë–û–¢–ê–Æ–¢):
1. **UnifiedTransactionService.updateUserBalance()** - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
2. **BalanceManager subtract –æ–ø–µ—Ä–∞—Ü–∏—è** - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Math.max(0, balance - amount)

### –ü–†–ò–û–†–ò–¢–ï–¢ 2 (–ñ–ï–õ–ê–¢–ï–õ–¨–ù–û):
3. **TransactionEnforcer.enforcePolicy()** - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ù–ï –¢–†–û–ì–ê–¢–¨ (–ü–†–ê–í–ò–õ–¨–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–´):
- BatchBalanceProcessor.invalidateBatch()
- TransactionsService.recalculateUserBalance()  
- TransactionEnforcer.detectDirectSQLUpdates()
- SQL —Å–∫—Ä–∏–ø—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏

---

## –ü–õ–ê–ù –ú–ò–ù–ò–ú–ê–õ–¨–ù–û–ì–û –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø

### –®–∞–≥ 1: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å updateUserBalance –≤ TransactionService
- –£–±—Ä–∞—Ç—å `return;` 
- –í–µ—Ä–Ω—É—Ç—å –ª–æ–≥–∏–∫—É –≤—ã–∑–æ–≤–∞ BalanceManager

### –®–∞–≥ 2: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Math.max –≤ BalanceManager
- –í–µ—Ä–Ω—É—Ç—å `Math.max(0, balance - amount)` –≤ subtract –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

### –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ TON –¥–µ–ø–æ–∑–∏—Ç—ã –∑–∞—á–∏—Å–ª—è—é—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –±–∞–ª–∞–Ω—Å—ã –Ω–µ —É—Ö–æ–¥—è—Ç –≤ –º–∏–Ω—É—Å

**–†–ï–ó–£–õ–¨–¢–ê–¢**: TON –¥–µ–ø–æ–∑–∏—Ç—ã —Å–Ω–æ–≤–∞ –±—É–¥—É—Ç –∑–∞—á–∏—Å–ª—è—Ç—å—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, —Å–∏—Å—Ç–µ–º–∞ –≤–µ—Ä–Ω–µ—Ç—Å—è –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –¥–æ 29.07.2025