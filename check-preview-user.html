<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniFarm - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #0f0f0f;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h1 { color: #8b5cf6; }
        h2 { color: #10b981; }
        .data-block {
            background: #252525;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        .status-ok { color: #10b981; }
        .status-warn { color: #f59e0b; }
        .status-error { color: #ef4444; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        td, th {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #374151;
        }
        th { color: #60a5fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç UniFarm Preview User Check</h1>
        
        <div class="section">
            <h2>1. JWT Token Analysis</h2>
            <div id="jwtAnalysis" class="data-block">–ê–Ω–∞–ª–∏–∑...</div>
        </div>
        
        <div class="section">
            <h2>2. API Profile Response</h2>
            <div id="apiProfile" class="data-block">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        
        <div class="section">
            <h2>3. UserContext State</h2>
            <div id="contextState" class="data-block">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
        </div>
        
        <div class="section">
            <h2>4. Wallet Data Check</h2>
            <div id="walletData" class="data-block">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
        </div>
        
        <div class="section">
            <h2>üìä Summary</h2>
            <table id="summaryTable">
                <tr>
                    <th>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç</th>
                    <th>–§–∞–∫—Ç</th>
                    <th>–ü–æ–¥–∫–ª—é—á–µ–Ω</th>
                    <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                </tr>
            </table>
        </div>
    </div>

    <script>
        async function checkPreviewUser() {
            const results = {};
            
            // 1. JWT Token Analysis
            const jwtDiv = document.getElementById('jwtAnalysis');
            const jwtToken = localStorage.getItem('unifarm_jwt_token') || localStorage.getItem('telegramJWT');
            
            if (jwtToken) {
                try {
                    const payload = JSON.parse(atob(jwtToken.split('.')[1]));
                    jwtDiv.innerHTML = `<span class="status-ok">‚úÖ JWT –Ω–∞–π–¥–µ–Ω</span><br>
                        user_id: ${payload.userId || payload.user_id}<br>
                        telegram_id: ${payload.telegram_id}<br>
                        username: ${payload.username}<br>
                        ref_code: ${payload.ref_code}<br>
                        exp: ${new Date(payload.exp * 1000).toLocaleString()}`;
                    
                    results.jwt = {
                        status: '‚úÖ',
                        userId: payload.userId || payload.user_id,
                        comment: `user_id = ${payload.userId || payload.user_id}`
                    };
                } catch (e) {
                    jwtDiv.innerHTML = `<span class="status-error">‚ùå –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JWT</span><br>${e.message}`;
                    results.jwt = { status: '‚ùå', comment: '–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è' };
                }
            } else {
                jwtDiv.innerHTML = '<span class="status-warn">‚ö†Ô∏è JWT —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage</span>';
                results.jwt = { status: '‚ùå', comment: '–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω' };
            }
            
            // 2. API Profile Request
            const profileDiv = document.getElementById('apiProfile');
            try {
                const response = await fetch('/api/v2/users/profile?user_id=48', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': jwtToken ? `Bearer ${jwtToken}` : ''
                    }
                });
                const data = await response.json();
                
                if (data.success && data.data) {
                    const user = data.data.user;
                    profileDiv.innerHTML = `<span class="status-ok">‚úÖ API —É—Å–ø–µ—à–Ω–æ</span><br>
                        user_id: ${user.id}<br>
                        telegram_id: ${user.telegram_id}<br>
                        username: ${user.username}<br>
                        balance_uni: ${user.balance_uni}<br>
                        balance_ton: ${user.balance_ton}`;
                    
                    results.api = {
                        status: '‚úÖ',
                        userId: user.id,
                        comment: `user_id = ${user.id}`,
                        balances: { uni: user.balance_uni, ton: user.balance_ton }
                    };
                } else {
                    profileDiv.innerHTML = `<span class="status-error">‚ùå API –æ—à–∏–±–∫–∞</span><br>${JSON.stringify(data)}`;
                    results.api = { status: '‚ùå', comment: '–û—à–∏–±–∫–∞ API' };
                }
            } catch (e) {
                profileDiv.innerHTML = `<span class="status-error">‚ùå –ó–∞–ø—Ä–æ—Å –Ω–µ —É–¥–∞–ª—Å—è</span><br>${e.message}`;
                results.api = { status: '‚ùå', comment: e.message };
            }
            
            // 3. Check UserContext (—á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å)
            const contextDiv = document.getElementById('contextState');
            contextDiv.innerHTML = `<span class="status-warn">‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞</span><br>
                –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏:<br>
                <code>console.log('UserContext userId:', window.__unifarm_user_id);</code>`;
            
            // 4. Wallet Data
            const walletDiv = document.getElementById('walletData');
            try {
                const walletResponse = await fetch('/api/v2/wallet/balance?user_id=48', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': jwtToken ? `Bearer ${jwtToken}` : ''
                    }
                });
                const walletData = await walletResponse.json();
                
                if (walletData.success) {
                    walletDiv.innerHTML = `<span class="status-ok">‚úÖ Wallet API —Ä–∞–±–æ—Ç–∞–µ—Ç</span><br>
                        ${JSON.stringify(walletData.data, null, 2)}`;
                    results.wallet = { status: '‚úÖ', comment: 'API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ' };
                } else {
                    walletDiv.innerHTML = `<span class="status-warn">‚ö†Ô∏è Wallet API –≤–µ—Ä–Ω—É–ª:</span><br>${JSON.stringify(walletData)}`;
                    results.wallet = { status: '‚ö†Ô∏è', comment: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–≤–µ—Ç' };
                }
            } catch (e) {
                walletDiv.innerHTML = `<span class="status-error">‚ùå Wallet –∑–∞–ø—Ä–æ—Å –Ω–µ —É–¥–∞–ª—Å—è</span><br>${e.message}`;
                results.wallet = { status: '‚ùå', comment: e.message };
            }
            
            // Update summary table
            const summaryTable = document.getElementById('summaryTable');
            const rows = [
                ['JWT —Ç–æ–∫–µ–Ω', `payload —Å user_id = ${results.jwt?.userId || '?'}`, results.jwt?.status || '?', results.jwt?.comment || ''],
                ['/profile', `–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç user_id=${results.api?.userId || '?'}`, results.api?.status || '?', results.api?.comment || ''],
                ['Wallet API', '–±–∞–ª–∞–Ω—Å –ø—Ä–∏—Ö–æ–¥–∏—Ç?', results.wallet?.status || '?', results.wallet?.comment || ''],
                ['UI Wallet', '–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –±–∞–ª–∞–Ω—Å?', 'üîç', '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /wallet'],
                ['–û—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏', '–µ—Å—Ç—å?', 'üîç', '–û—Ç–∫—Ä–æ–π—Ç–µ DevTools'],
                ['–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å –ë–î', '—Å–æ–≤–ø–∞–¥–∞—é—Ç –ª–∏ —Ü–∏—Ñ—Ä—ã?', 'üîç', `UNI: ${results.api?.balances?.uni || '?'}, TON: ${results.api?.balances?.ton || '?'}`]
            ];
            
            rows.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.innerHTML = cell;
                    tr.appendChild(td);
                });
                summaryTable.appendChild(tr);
            });
        }
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = checkPreviewUser;
    </script>
</body>
</html>