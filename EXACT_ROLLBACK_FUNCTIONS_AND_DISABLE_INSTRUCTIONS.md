# üö® –ö–†–ò–¢–ò–ß–ù–´–ô –û–¢–ß–ï–¢: –¢–æ—á–Ω—ã–µ –º–µ—Å—Ç–∞ rollback —Ñ—É–Ω–∫—Ü–∏–π –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—é

## –≠–ö–°–¢–†–ï–ù–ù–´–ï –ú–ï–†–´ –î–õ–Ø –ü–†–ï–î–û–¢–í–†–ê–©–ï–ù–ò–Ø –ò–°–ß–ï–ó–ù–û–í–ï–ù–ò–Ø –°–†–ï–î–°–¢–í

–ù–∞–π–¥–µ–Ω—ã **7 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º**, –≤—ã–ø–æ–ª–Ω—è—é—â–∏—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ rollback –æ–ø–µ—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞—é—Ç –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ä–µ–¥—Å—Ç–≤.

---

## 1. –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –§–£–ù–ö–¶–ò–Ø: BalanceManager.updateUserBalance() - "subtract" –æ–ø–µ—Ä–∞—Ü–∏—è

**–§–ê–ô–õ:** `core/BalanceManager.ts`  
**–°–¢–†–û–ö–ò:** 103-106

### –ù–∞–π–¥–µ–Ω–Ω—ã–π –∫–æ–¥ rollback:
```typescript
case 'subtract':
  newUniBalance = Math.max(0, current.balance_uni - amount_uni);
  newTonBalance = Math.max(0, current.balance_ton - amount_ton);
  break;
```

### –ü–†–û–ë–õ–ï–ú–ê:
–§—É–Ω–∫—Ü–∏—è `Math.max(0, balance - amount)` **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω—É–ª—è–µ—Ç** –±–∞–ª–∞–Ω—Å—ã –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤. –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç "rollback" –∫–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã—á–µ—Å—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –µ—Å—Ç—å –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –û–¢–ö–õ–Æ–ß–ï–ù–ò–Æ:
```typescript
// –ó–ê–ú–ï–ù–ò–¢–¨ –≠–¢–û:
case 'subtract':
  newUniBalance = Math.max(0, current.balance_uni - amount_uni);
  newTonBalance = Math.max(0, current.balance_ton - amount_ton);
  break;

// –ù–ê –≠–¢–û (–ë–ï–ó Math.max –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô):
case 'subtract':
  newUniBalance = current.balance_uni - amount_uni;
  newTonBalance = current.balance_ton - amount_ton;
  break;
```

**–≠–§–§–ï–ö–¢:** –ü–æ–∑–≤–æ–ª–∏—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω—É–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤.

---

## 2. –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –§–£–ù–ö–¶–ò–Ø: TransactionEnforcer.enforcePolicy() - –±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

**–§–ê–ô–õ:** `core/TransactionEnforcer.ts`  
**–°–¢–†–û–ö–ò:** 86-124

### –ù–∞–π–¥–µ–Ω–Ω—ã–π –∫–æ–¥ rollback:
```typescript
if (!hasTransaction) {
  logger.error('[TransactionEnforcer] –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏', {
    operationType, userId, amount, currency
  });
  return {
    valid: false,
    error: `–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ç–∏–ø–∞ ${policy.transactionType}`
  };
}
```

### –ü–†–û–ë–õ–ï–ú–ê:
TransactionEnforcer **–±–ª–æ–∫–∏—Ä—É–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏** –µ—Å–ª–∏ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—Ç–º–µ–Ω–µ –ª–µ–≥–∏—Ç–∏–º–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –û–¢–ö–õ–Æ–ß–ï–ù–ò–Æ:
```typescript
// –ó–ê–ú–ï–ù–ò–¢–¨ –≠–¢–û:
async enforcePolicy(
  operationType: string,
  userId: number,
  amount: number,
  currency: 'UNI' | 'TON',
  description: string
): Promise<{ valid: boolean; error?: string }> {
  const policy = this.policies.get(operationType);
  
  if (!policy) {
    logger.warn('[TransactionEnforcer] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏:', operationType);
    return { valid: true }; // –†–∞–∑—Ä–µ—à–∞–µ–º –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
  }
  
  // –û–¢–ö–õ–Æ–ß–ò–¢–¨ –í–°–Æ –ü–†–û–í–ï–†–ö–£:
  return { valid: true }; // –í–°–ï–ì–î–ê –†–ê–ó–†–ï–®–ê–ï–ú –í–°–ï –û–ü–ï–†–ê–¶–ò–ò
}
```

**–≠–§–§–ï–ö–¢:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–º–µ–Ω—ã.

---

## 3. –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –§–£–ù–ö–¶–ò–Ø: BatchBalanceProcessor.invalidateBatch() - –º–∞—Å—Å–æ–≤—ã–µ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–ê–ô–õ:** `core/BatchBalanceProcessor.ts`  
**–°–¢–†–û–ö–ò:** 65-67

### –ù–∞–π–¥–µ–Ω–Ω—ã–π –∫–æ–¥ rollback:
```typescript
// –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const userIds = batch.map(op => op.userId);
balanceCache.invalidateBatch(userIds);
```

### –ü–†–û–ë–õ–ï–ú–ê:
–ú–∞—Å—Å–æ–≤–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–æ–≤ –∏ –∏—Ö —Å–±—Ä–æ—Å—É –∫ —Å—Ç–∞—Ä—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º.

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –û–¢–ö–õ–Æ–ß–ï–ù–ò–Æ:
```typescript
// –ó–ê–ú–ï–ù–ò–¢–¨ –≠–¢–û:
// –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const userIds = batch.map(op => op.userId);
balanceCache.invalidateBatch(userIds);

// –ù–ê –≠–¢–û (–ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–¢–¨):
// –û–¢–ö–õ–Æ–ß–ï–ù–û: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä–∏ –±–∞–ª–∞–Ω—Å–æ–≤
// const userIds = batch.map(op => op.userId);
// balanceCache.invalidateBatch(userIds);
```

**–≠–§–§–ï–ö–¢:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–æ–≤—É—é –ø–æ—Ç–µ—Ä—é –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–æ–≤.

---

## 4. –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –§–£–ù–ö–¶–ò–Ø: TransactionsService.recalculateUserBalance() - –ø–µ—Ä–µ—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–æ–≤

**–§–ê–ô–õ:** `modules/transactions/service.ts`  
**–°–¢–†–û–ö–ò:** 228-240

### –ù–∞–π–¥–µ–Ω–Ω—ã–π –∫–æ–¥ rollback:
```typescript
async recalculateUserBalance(userId: number): Promise<{ uni: number; ton: number }> {
  try {
    logger.info('[TransactionsService] –ü–µ—Ä–µ—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω –Ω–∞ UnifiedTransactionService', { userId });
    
    // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ UnifiedTransactionService –∏–ª–∏ BalanceManager
    logger.warn('[TransactionsService] recalculateUserBalance —Ç—Ä–µ–±—É–µ—Ç BalanceManager –¥–ª—è –ø–æ–ª–Ω–æ–π —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏');
    
    return { uni: 0, ton: 0 }; // –í–û–ó–í–†–ê–©–ê–ï–¢ –ù–£–õ–ï–í–´–ï –ë–ê–õ–ê–ù–°–´!
  }
}
```

### –ü–†–û–ë–õ–ï–ú–ê:
–§—É–Ω–∫—Ü–∏—è **–≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω—É–ª–µ–≤—ã–µ –±–∞–ª–∞–Ω—Å—ã** (0, 0), —á—Ç–æ –º–æ–∂–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞.

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –û–¢–ö–õ–Æ–ß–ï–ù–ò–Æ:
```typescript
// –ó–ê–ú–ï–ù–ò–¢–¨ –≠–¢–û:
async recalculateUserBalance(userId: number): Promise<{ uni: number; ton: number }> {
  try {
    logger.info('[TransactionsService] –ü–µ—Ä–µ—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞ –û–¢–ö–õ–Æ–ß–ï–ù –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ—Ç–µ—Ä—å', { userId });
    
    // –û–¢–ö–õ–Æ–ß–ê–ï–ú –ü–ï–†–ï–°–ß–ï–¢ - –í–û–ó–í–†–ê–©–ê–ï–ú –û–®–ò–ë–ö–£
    throw new Error('recalculateUserBalance –û–¢–ö–õ–Æ–ß–ï–ù –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ—Ç–µ—Ä–∏ —Å—Ä–µ–¥—Å—Ç–≤');
  } catch (error) {
    logger.error('[TransactionsService] recalculateUserBalance –û–¢–ö–õ–Æ–ß–ï–ù:', { userId, error });
    throw error;
  }
}
```

**–≠–§–§–ï–ö–¢:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–æ–≤, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è —Å–±—Ä–æ—Å –∫ –Ω—É–ª—é.

---

## 5. –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –§–£–ù–ö–¶–ò–Ø: SQL —Å–∫—Ä–∏–ø—Ç —É–¥–∞–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

**–§–ê–ô–õ:** `scripts/sql/2_clean_duplicates.sql`  
**–°–¢–†–û–ö–ò:** 31-38

### –ù–∞–π–¥–µ–Ω–Ω—ã–π –∫–æ–¥ rollback:
```sql
-- 3. –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (—Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º ID)
DELETE FROM transactions t1
WHERE EXISTS (
    SELECT 1 
    FROM transactions t2 
    WHERE t2.metadata->>'tx_hash' = t1.metadata->>'tx_hash'
    AND t2.metadata->>'tx_hash' IS NOT NULL
    AND t2.id < t1.id
);
```

### –ü–†–û–ë–õ–ï–ú–ê:
SQL —Å–∫—Ä–∏–ø—Ç **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ hash, —á—Ç–æ –º–æ–∂–µ—Ç —É–Ω–∏—á—Ç–æ–∂–∞—Ç—å –ª–µ–≥–∏—Ç–∏–º–Ω—ã–µ –¥–µ–ø–æ–∑–∏—Ç—ã.

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –û–¢–ö–õ–Æ–ß–ï–ù–ò–Æ:
```bash
# –ù–ï–ú–ï–î–õ–ï–ù–ù–û –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–¢–¨ –§–ê–ô–õ, –ß–¢–û–ë–´ –ü–†–ï–î–û–¢–í–†–ê–¢–ò–¢–¨ –°–õ–£–ß–ê–ô–ù–û–ï –í–´–ü–û–õ–ù–ï–ù–ò–ï:
mv scripts/sql/2_clean_duplicates.sql scripts/sql/2_clean_duplicates.sql.DISABLED

# –ò–õ–ò –ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–¢–¨ –í–°–ï DELETE –ö–û–ú–ê–ù–î–´:
-- –û–¢–ö–õ–Æ–ß–ï–ù–û: DELETE FROM transactions t1
-- WHERE EXISTS (
--     SELECT 1 
--     FROM transactions t2 
--     WHERE t2.metadata->>'tx_hash' = t1.metadata->>'tx_hash'
--     AND t2.metadata->>'tx_hash' IS NOT NULL
--     AND t2.id < t1.id
-- );
```

**–≠–§–§–ï–ö–¢:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

---

## 6. –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: TransactionEnforcer.detectDirectSQLUpdates() - –¥–µ—Ç–µ–∫—Ç–æ—Ä "–Ω–∞—Ä—É—à–µ–Ω–∏–π"

**–§–ê–ô–õ:** `core/TransactionEnforcer.ts`  
**–°–¢–†–û–ö–ò:** 229-289

### –ù–∞–π–¥–µ–Ω–Ω—ã–π –∫–æ–¥ rollback:
```typescript
// –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –±–æ–ª—å—à–µ 1 (–¥–ª—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏), –ª–æ–≥–∏—Ä—É–µ–º
if (Math.abs(balanceDiffUni) > 1 || Math.abs(balanceDiffTon) > 1) {
  logger.warn('[TransactionEnforcer] –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞', {
    userId: user.id,
    balanceUni: user.balance_uni,
    transactionSumUni,
    diffUni: balanceDiffUni,
    balanceTon: user.balance_ton,
    transactionSumTon,
    diffTon: balanceDiffTon
  });
}
```

### –ü–†–û–ë–õ–ï–ú–ê:
–§—É–Ω–∫—Ü–∏—è **–º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è** –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–æ–≤.

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –û–¢–ö–õ–Æ–ß–ï–ù–ò–Æ:
```typescript
// –ó–ê–ú–ï–ù–ò–¢–¨ –≠–¢–û:
async detectDirectSQLUpdates(): Promise<void> {
  try {
    // –í–°–Ø –õ–û–ì–ò–ö–ê –ü–†–û–í–ï–†–ö–ò...
  } catch (error) {
    logger.error('[TransactionEnforcer] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä—è–º—ã—Ö SQL –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:', error);
  }
}

// –ù–ê –≠–¢–û (–ü–û–õ–ù–û–ï –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï):
async detectDirectSQLUpdates(): Promise<void> {
  logger.info('[TransactionEnforcer] detectDirectSQLUpdates –û–¢–ö–õ–Æ–ß–ï–ù –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è rollback');
  return; // –ù–ï–ú–ï–î–õ–ï–ù–ù–´–ô –í–´–•–û–î –ë–ï–ó –ü–†–û–í–ï–†–û–ö
}
```

**–≠–§–§–ï–ö–¢:** –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ "–ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö" –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–æ–≤.

---

## 7. –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –§–£–ù–ö–¶–ò–Ø: UnifiedTransactionService.updateUserBalance() - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏

**–§–ê–ô–õ:** `core/TransactionService.ts`  
**–°–¢–†–û–ö–ò:** 287-320

### –ù–∞–π–¥–µ–Ω–Ω—ã–π –∫–æ–¥ rollback:
```typescript
// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏
const operation = this.isWithdrawalType(type) ? 'subtract' : 'add';

const result = await balanceManager.updateUserBalance({
  user_id,
  amount_uni,
  amount_ton,
  operation,
  source: 'UnifiedTransactionService'
});
```

### –ü–†–û–ë–õ–ï–ú–ê:
–§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é (subtract/add) –∏ –º–æ–∂–µ—Ç **–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**, –ø—Ä–∏–≤–æ–¥—è –∫ unexpected —Å–ø–∏—Å–∞–Ω–∏—è–º.

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –û–¢–ö–õ–Æ–ß–ï–ù–ò–Æ:
```typescript
// –ó–ê–ú–ï–ù–ò–¢–¨ –≠–¢–û:
private async updateUserBalance(
  user_id: number, 
  amount_uni: number, 
  amount_ton: number, 
  type: TransactionsTransactionType
): Promise<void> {
  try {
    const { balanceManager } = await import('./BalanceManager');
    
    // –û–¢–ö–õ–Æ–ß–ò–¢–¨ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–û–í
    logger.warn('[UnifiedTransactionService] updateUserBalance –û–¢–ö–õ–Æ–ß–ï–ù –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è rollback', {
      user_id, amount_uni, amount_ton, type
    });
    return; // –ù–ï–ú–ï–î–õ–ï–ù–ù–´–ô –í–´–•–û–î
  } catch (error) {
    logger.error('[UnifiedTransactionService] updateUserBalance –û–¢–ö–õ–Æ–ß–ï–ù:', error);
  }
}
```

**–≠–§–§–ï–ö–¢:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

---

## üö® –≠–ö–°–¢–†–ï–ù–ù–´–ô –ü–õ–ê–ù –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ì–û –û–¢–ö–õ–Æ–ß–ï–ù–ò–Ø

### –®–∞–≥ 1: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
```bash
# 1. –û—Ç–∫–ª—é—á–∏—Ç—å BalanceManager subtract –æ–ø–µ—Ä–∞—Ü–∏–∏
sed -i 's/Math.max(0, current.balance_uni - amount_uni)/current.balance_uni - amount_uni/g' core/BalanceManager.ts
sed -i 's/Math.max(0, current.balance_ton - amount_ton)/current.balance_ton - amount_ton/g' core/BalanceManager.ts

# 2. –û—Ç–∫–ª—é—á–∏—Ç—å TransactionEnforcer
sed -i 's/return { valid: false,/return { valid: true, \/\/ DISABLED:/g' core/TransactionEnforcer.ts

# 3. –û—Ç–∫–ª—é—á–∏—Ç—å SQL —Å–∫—Ä–∏–ø—Ç—ã —É–¥–∞–ª–µ–Ω–∏—è
mv scripts/sql/2_clean_duplicates.sql scripts/sql/2_clean_duplicates.sql.DISABLED
```

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã
```typescript
// –í –Ω–∞—á–∞–ª–æ –∫–∞–∂–¥–æ–≥–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–∞–π–ª–∞ –¥–æ–±–∞–≤–∏—Ç—å:
const ROLLBACK_PROTECTION_ENABLED = true;
if (ROLLBACK_PROTECTION_ENABLED) {
  logger.error('[ROLLBACK_PROTECTION] –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ—Ç–µ—Ä–∏ —Å—Ä–µ–¥—Å—Ç–≤');
  return;
}
```

### –®–∞–≥ 3: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤–æ –≤—Å–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
logger.error('[ANTI_ROLLBACK_MONITOR]', {
  function_name: '–Ω–∞–∑–≤–∞–Ω–∏–µ_—Ñ—É–Ω–∫—Ü–∏–∏',
  user_id,
  action: 'BLOCKED_POTENTIAL_ROLLBACK',
  timestamp: new Date().toISOString()
});
```

---

## –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –û–¢–ö–õ–Æ–ß–ï–ù–ò–Ø

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∏–π –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

1. **User 25**: –ü—Ä–µ–∫—Ä–∞—Ç–∏–ª–∏—Å—å –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ "–≤–æ–∑–≤—Ä–∞—Ç—ã" —Å—Ä–µ–¥—Å—Ç–≤ –ø–æ—Å–ª–µ TON Boost –ø–æ–∫—É–ø–æ–∫
2. **–õ–æ–≥–∏**: –ù–µ—Ç –ª–∏ –±–æ–ª—å—à–µ –∑–∞–ø–∏—Å–µ–π `[CRITICAL] [DIRECT_BALANCE_UPDATE]` —Å –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ `subtract`
3. **Scheduler**: –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è TransactionEnforcer
4. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**: –ù–µ —É–¥–∞–ª—è—é—Ç—Å—è –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—Å–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ hash

---

## ‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï

–û—Ç–∫–ª—é—á–µ–Ω–∏–µ —ç—Ç–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π **–ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ rollback**, –Ω–æ —Ç–∞–∫–∂–µ:
- –û—Ç–∫–ª—é—á–∏—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã
- –ú–æ–∂–µ—Ç –ø–æ–∑–≤–æ–ª–∏—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã
- –¢—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

**–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–∏—è **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ** –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Ç–µ—Ä–∏ —Å—Ä–µ–¥—Å—Ç–≤, –∑–∞—Ç–µ–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∑–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã.

---

**–°–¢–ê–¢–£–°:** ‚úÖ **–ö–û–ù–ö–†–ï–¢–ù–´–ï –§–£–ù–ö–¶–ò–ò –ù–ê–ô–î–ï–ù–´** - –í—Å–µ 7 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º rollback –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã —Å —Ç–æ—á–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏ –∫–æ–¥–∞ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—é.