# üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó: –ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ TON –±–∞–ª–∞–Ω—Å–æ–≤

**–î–∞—Ç–∞:** 27 –∏—é–ª—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –û–ë–ù–ê–†–£–ñ–ï–ù–´  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò

### üîç **–û–ë–ù–ê–†–£–ñ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´**

#### 1. **–ü–∞—Ç—Ç–µ—Ä–Ω—ã –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**
- **17 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** —Å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏ 16-199 —Å–µ–∫—É–Ω–¥
- –°—É–º–º—ã –±–ª–∏–∑–∫–∏ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é, —á—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ (User 238):**
```
–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 1: 0.000005 TON (12:31:05)
–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 2: 0.000006 TON (12:32:58) - –ò–Ω—Ç–µ—Ä–≤–∞–ª: 113 —Å–µ–∫—É–Ω–¥
–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 3: 0.000008 TON (12:33:14) - –ò–Ω—Ç–µ—Ä–≤–∞–ª: 16 —Å–µ–∫—É–Ω–¥
```

#### 2. **–†–∞–±–æ—Ç–∞—é—â–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è TX —Ö–µ—à–µ–π**
‚úÖ **–ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–´–ô –ú–û–ú–ï–ù–¢**: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö TX —Ö–µ—à–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
- –°–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ blockchain —Ö–µ—à–∞–º
- –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ blockchain —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

---

## üéØ **–£–ó–ö–ò–ï –ú–ï–°–¢–ê –°–ò–°–¢–ï–ú–´**

### **1. TransactionService.shouldUpdateBalance()**
**–§–∞–π–ª:** `core/TransactionService.ts` —Å—Ç—Ä–æ–∫–∏ 347-361

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ—Ç–æ–¥ `shouldUpdateBalance()` –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è –º–Ω–æ–≥–æ —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
```typescript
const incomeTypes: ExtendedTransactionType[] = [
  'FARMING_REWARD',      // TON Boost –¥–æ—Ö–æ–¥—ã
  'TON_DEPOSIT',         // –ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞  
  'BOOST_PURCHASE',      // ‚Üê –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê
  'DEPOSIT'              // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–µ–ø–æ–∑–∏—Ç—ã
];
```

**–†–∏—Å–∫:** `BOOST_PURCHASE` —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞—é—Ç `updateUserBalance()`, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º –±–∞–ª–∞–Ω—Å–∞.

### **2. BalanceManager –æ–ø–µ—Ä–∞—Ü–∏–∏**
**–§–∞–π–ª:** `core/BalanceManager.ts` —Å—Ç—Ä–æ–∫–∏ 64-75

**–ú–µ—Ö–∞–Ω–∏–∑–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:**
```typescript
async updateUserBalance(data: BalanceUpdateData): Promise<{
  user_id: number,
  amount_uni = 0, 
  amount_ton = 0, 
  operation, // 'add' | 'subtract' | 'set'
  source = 'BalanceManager'
})
```

**–†–∏—Å–∫:** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å race conditions.

### **3. TON Boost –∞–∫—Ç–∏–≤–∞—Ü–∏—è**
**–§–∞–π–ª:** `modules/boost/service.ts` 

**–î–≤–æ–π–Ω–æ–π –ø—É—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:**
1. **–°–ø–∏—Å–∞–Ω–∏–µ —á–µ—Ä–µ–∑ WalletService.processWithdrawal()** (–ø–æ–∫—É–ø–∫–∞ –ø–∞–∫–µ—Ç–∞)
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ TonFarmingRepository.activateBoost()** (—Å–æ–∑–¥–∞–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞)

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–ø–æ—á–∫–∞:**
```
TON Boost –ø–æ–∫—É–ø–∫–∞ ‚Üí –°–ø–∏—Å–∞–Ω–∏–µ 1 TON ‚Üí 
–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–∞–∫–µ—Ç–∞ ‚Üí –°–æ–∑–¥–∞–Ω–∏–µ BOOST_PURCHASE —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Üí 
shouldUpdateBalance() = true ‚Üí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç 1 TON
```

### **4. Wallet Service TON –¥–µ–ø–æ–∑–∏—Ç—ã**
**–§–∞–π–ª:** `modules/wallet/service.ts` —Å—Ç—Ä–æ–∫–∏ 391-407

**–î–≤–æ–π–Ω–æ–π API –≤—ã–∑–æ–≤ —Ä–∏—Å–∫:** 
- Frontend –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å API –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
- –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é TX hash, –≤–æ–∑–º–æ–∂–Ω—ã race conditions –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º

---

## üî¨ **–î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ö–û–†–ù–ï–í–´–• –ü–†–ò–ß–ò–ù**

### **–ü—Ä–æ–±–ª–µ–º–∞ ‚Ññ1: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –ø—É—Ç–∞–Ω–∏—Ü–∞ —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**

**BOOST_PURCHASE vs TON_BOOST_DEPOSIT:**
- `BOOST_PURCHASE` = –ø–æ–∫—É–ø–∫–∞ –ø–∞–∫–µ—Ç–∞ (–¥–æ–ª–∂–Ω–æ —Å–ø–∏—Å—ã–≤–∞—Ç—å TON)
- `TON_BOOST_DEPOSIT` = –¥–µ–ø–æ–∑–∏—Ç –¥–ª—è —Ñ–∞—Ä–º–∏–Ω–≥–∞ (–¥–æ–ª–∂–Ω–æ –∑–∞—á–∏—Å–ª—è—Ç—å TON)

**–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** `BOOST_PURCHASE` –º–∞–ø–∏—Ç—Å—è –≤ `FARMING_REWARD` –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ **–ó–ê–ß–ò–°–õ–Ø–ï–¢** TON –≤–º–µ—Å—Ç–æ —Å–ø–∏—Å–∞–Ω–∏—è.

### **–ü—Ä–æ–±–ª–µ–º–∞ ‚Ññ2: Race Conditions –≤ BalanceManager**

**–°—Ü–µ–Ω–∞—Ä–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç TON Boost –ø–æ–∫—É–ø–∫—É
2. `WalletService.processWithdrawal()` —Å–ø–∏—Å—ã–≤–∞–µ—Ç 1 TON
3. `TonFarmingRepository.activateBoost()` —Å–æ–∑–¥–∞–µ—Ç BOOST_PURCHASE —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é  
4. `TransactionService.shouldUpdateBalance()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç true
5. `BalanceManager.updateUserBalance()` –∑–∞—á–∏—Å–ª—è–µ—Ç 1 TON –æ–±—Ä–∞—Ç–Ω–æ
6. **–†–ï–ó–£–õ–¨–¢–ê–¢:** –î–µ–Ω—å–≥–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å –Ω–∞ –±–∞–ª–∞–Ω—Å

### **–ü—Ä–æ–±–ª–µ–º–∞ ‚Ññ3: –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏**

**–ü–∞—Ç—Ç–µ—Ä–Ω 113-115 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏** —É –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞:
- –†–∞–±–æ—Ç—É –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
- Batch –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –í–æ–∑–º–æ–∂–Ω—ã–µ timeout –∏ retry –º–µ—Ö–∞–Ω–∏–∑–º—ã

---

## ‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò**

### **–ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:**

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å mapping BOOST_PURCHASE —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**
   - `BOOST_PURCHASE` –ù–ï –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å—Å—è –≤ `shouldUpdateBalance()`
   - –ü–æ–∫—É–ø–∫–∏ –ø–∞–∫–µ—Ç–æ–≤ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –¥–æ—Ö–æ–¥–∞–º–∏

2. **–ê—É–¥–∏—Ç BalanceManager race conditions**
   - –î–æ–±–∞–≤–∏—Ç—å mutex/lock –º–µ—Ö–∞–Ω–∏–∑–º—ã –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–ª–∞–Ω—Å–æ–º
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ —Å timestamps

3. **–†–∞–∑–¥–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Boost –ø–æ–∫—É–ø–æ–∫ –∏ –¥–µ–ø–æ–∑–∏—Ç–æ–≤**
   - –ü–æ–∫—É–ø–∫–∞ –ø–∞–∫–µ—Ç–∞ = —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–∞–Ω–∏–µ
   - –°–æ–∑–¥–∞–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞ = –æ—Ç–¥–µ–ª—å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –±–∞–ª–∞–Ω—Å –ø–æ–∫—É–ø–∫–∏

### **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

1. **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**
   - –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ debit/credit –æ–ø–µ—Ä–∞—Ü–∏–π
   - –£–¥–∞–ª–µ–Ω–∏–µ –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω—ã—Ö mappings

2. **–£–ª—É—á—à–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**
   - Real-time –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ balance changes
   - Alert system –¥–ª—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ edge cases**
   - Concurrent purchases
   - Network timeout scenarios
   - Database constraint violations

---

## üìà **–ú–ï–¢–†–ò–ö–ò –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê**

- **–ü—Ä–æ–±–ª–µ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 17 –∏–∑ 23 –∞–∫—Ç–∏–≤–Ω—ã—Ö (74%)
- **–ß–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ–±–ª–µ–º:** –ö–∞–∂–¥—ã–µ 1-2 –º–∏–Ω—É—Ç—ã
- **–¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:** –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ TON Boost –¥–æ—Ö–æ–¥—ã –º–∞–ª—ã—Ö —Å—É–º–º
- **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è:** –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (0 –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö TX —Ö–µ—à–µ–π)

---

## üéØ **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

–°–∏—Å—Ç–µ–º–∞ —Å—Ç—Ä–∞–¥–∞–µ—Ç –æ—Ç **–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π** –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ TON Boost —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:

1. **BOOST_PURCHASE** –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–∞–ø–∏—Ç—Å—è –∫–∞–∫ –¥–æ—Ö–æ–¥ (`FARMING_REWARD`)
2. **shouldUpdateBalance()** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—á–∏—Å–ª—è–µ—Ç –¥–µ–Ω—å–≥–∏ –∑–∞ –ø–æ–∫—É–ø–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
3. **Race conditions** –º–µ–∂–¥—É —Å–ø–∏—Å–∞–Ω–∏–µ–º –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ–º

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ - –¥–µ–Ω—å–≥–∏ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∏ –º–æ–≥—É—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç timing –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏.

**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ TON Boost –ø–æ–∫—É–ø–æ–∫.