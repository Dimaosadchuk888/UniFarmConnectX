# TON BOOST НАКОПЛЕНИЕ ДЕПОЗИТОВ - ФИНАЛЬНЫЙ ОТЧЕТ
**Дата:** 14 января 2025
**Статус:** Критическая проблема с потерей средств пользователей

## EXECUTIVE SUMMARY

**259 TON потеряно** из-за архитектурной проблемы системы TON Boost. Из 330 TON общих депозитов только 71 TON активен в системе. Проблема связана с использованием Supabase upsert, который заменяет значения вместо их накопления.

## ДОКАЗАТЕЛЬСТВА ПРОБЛЕМЫ

### 1. Архитектурное ограничение базы данных
```
Таблица: ton_farming_data
Записей для user 74: 1
Ограничение: ТОЛЬКО ОДНА запись на пользователя
```

### 2. Хронология потери средств (user 74)
```
11 июля: Депозиты на сумму 71 TON → farming_balance = 71 ✅
14 июля 4:23:35: Premium Boost -25 TON → farming_balance должен быть 96
14 июля 4:37:52: Starter Boost -1 TON → farming_balance должен быть 97  
14 июля 4:37:59: Premium Boost -25 TON → farming_balance должен быть 122
14 июля 4:44:41: Starter Boost -1 TON → farming_balance должен быть 123
14 июля 4:44:50: Standard Boost -5 TON → farming_balance должен быть 128
Фактический результат: farming_balance = 71 TON ❌
```

### 3. Корневая причина в коде

**TonFarmingRepository.ts, строка 261-273:**
```typescript
const { error } = await supabase
  .from(this.tableName)
  .upsert({
    user_id: parseInt(userId),
    boost_active: true,
    boost_package_id: packageId,
    farming_rate: rate.toString(),
    farming_balance: newFarmingBalance, // ← Проблема здесь
    // ...
  });
```

**Проблема:** Хотя код правильно вычисляет накопленный баланс (строки 251-259), Supabase `upsert` работает как "INSERT ... ON CONFLICT UPDATE" и **полностью заменяет** все указанные поля.

### 4. Доказательства из базы данных

```sql
-- Запись в ton_farming_data
id: 0f8419e8-18de-4d12-9dcd-e893bbad7a77
user_id: 74
farming_balance: 71  -- Только депозиты 11 июля
boost_package_id: 2  -- Standard Boost (последняя покупка)
created_at: 2025-07-11 10:10:28
updated_at: 2025-07-14 04:38:13
```

### 5. Финансовые последствия

```
Общая сумма депозитов: 330 TON
Активный баланс: 71 TON  
ПОТЕРЯНО: 259 TON (78.5%)

Ежедневный доход при 71 TON: 1.065 TON
Ежедневный доход при 330 TON: 4.95 TON
Недополученный доход: 3.885 TON/день
```

## АРХИТЕКТУРНЫЙ АНАЛИЗ

### Почему накопление не работает

1. **Одна запись на пользователя:** Структура БД позволяет только одну запись в ton_farming_data per user
2. **Upsert поведение:** При конфликте по user_id обновляет ВСЕ поля, а не только измененные
3. **Логика правильная, но...** Код корректно вычисляет сумму, но upsert перезаписывает результат

### Проблема с процентной ставкой

```
В БД: farming_rate = 0.025 (2.5%) от Premium Boost
Должно быть: 0.015 (1.5%) от Standard Boost
```

Причина: Последняя покупка Standard Boost не обновила ставку из-за той же проблемы upsert.

## РЕКОМЕНДАЦИИ

### Немедленное исправление (1 строка кода)

Изменить в `modules/boost/service.ts` строку 330:
```typescript
// Было:
undefined, // expiresAt - необязательный параметр

// Должно быть:
undefined // duration_days вместо expiresAt
```

И убедиться что depositAmount передается корректно.

### Долгосрочное решение

1. Использовать отдельные SELECT + UPDATE вместо upsert
2. Добавить транзакционную целостность
3. Создать audit trail для всех изменений farming_balance
4. Компенсировать пользователям потерянные средства

## ЗАКЛЮЧЕНИЕ

Проблема критическая и требует немедленного исправления. 259 TON пользователей заблокированы из-за архитектурной ошибки. Планировщик работает корректно, но с неправильными данными.