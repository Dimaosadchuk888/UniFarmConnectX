#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Neon DB
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ .env.neon

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
RESET='\033[0m'

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ü–≤–µ—Ç–æ–º
log() {
  local color=$1
  local message=$2
  echo -e "${color}${message}${RESET}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ .env.neon
load_env() {
  log $BLUE "üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ .env.neon..."
  
  if [ ! -f .env.neon ]; then
    log $RED "‚ùå –§–∞–π–ª .env.neon –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    return 1
  fi
  
  # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env.neon
  export $(grep -v '^#' .env.neon | xargs)
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
  if [ -z "$DATABASE_URL" ]; then
    log $RED "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç DATABASE_URL –≤ .env.neon!"
    return 1
  fi
  
  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Neon DB
  export DATABASE_PROVIDER=neon
  export USE_LOCAL_DB_ONLY=false
  export FORCE_NEON_DB=true
  export DISABLE_REPLIT_DB=true
  export OVERRIDE_DB_PROVIDER=neon
  
  # –í—ã–≤–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å –º–∞—Å–∫–∏—Ä–æ–≤–∫–æ–π DATABASE_URL
  log $GREEN "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:"
  log $RESET "  DATABASE_PROVIDER=$DATABASE_PROVIDER"
  log $RESET "  USE_LOCAL_DB_ONLY=$USE_LOCAL_DB_ONLY"
  log $RESET "  FORCE_NEON_DB=$FORCE_NEON_DB"
  log $RESET "  DATABASE_URL=$(echo $DATABASE_URL | sed 's/:[^:]*@/:\*\*\*@/')"
  
  return 0
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Neon DB
check_neon_connection() {
  log $BLUE "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Neon DB..."
  
  # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  node check-neon-db.js
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞
  if [ $? -ne 0 ]; then
    log $RED "‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Neon DB –Ω–µ —É–¥–∞–ª–∞—Å—å!"
    return 1
  fi
  
  return 0
}

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
start_app() {
  log $MAGENTA "\nüöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å Neon DB..."
  
  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞
  export NODE_ENV=production
  export PORT=${PORT:-3000}
  
  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  node dist/index.js
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞
main() {
  log $CYAN "=== UniFarm —Å Neon DB ==="
  
  # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
  if ! load_env; then
    log $RED "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ .env.neon"
    exit 1
  fi
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Neon DB
  if ! check_neon_connection; then
    log $YELLOW "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ Neon DB!"
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–ø—É—Å–∫? (y/n): " continue_launch
    
    if [ "$continue_launch" != "y" ]; then
      log $YELLOW "–ó–∞–ø—É—Å–∫ –æ—Ç–º–µ–Ω–µ–Ω."
      exit 1
    fi
  fi
  
  # –°—Ç–∞—Ä—Ç—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  start_app
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
trap 'log $YELLOW "\n‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."; exit 0' SIGINT SIGTERM

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
main