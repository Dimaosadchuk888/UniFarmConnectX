<!DOCTYPE html>
<html>
<head>
    <title>JWT Recovery Test</title>
</head>
<body>
    <h1>JWT Token Recovery Test</h1>
    <div id="results"></div>
    
    <button onclick="runTests()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
    <button onclick="clearToken()">–û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω (—Å–∏–º—É–ª—è—Ü–∏—è –ø–æ—Ç–µ—Ä–∏)</button>
    <button onclick="showCurrentToken()">–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω</button>
    
    <script>
        const resultsDiv = document.getElementById('results');
        
        function log(message) {
            console.log(message);
            resultsDiv.innerHTML += '<div>' + message + '</div>';
        }
        
        function showCurrentToken() {
            const token = localStorage.getItem('unifarm_jwt_token');
            log('[JWT Test] –¢–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω: ' + (token ? '–ï–°–¢–¨ (–¥–ª–∏–Ω–∞: ' + token.length + ')' : '–û–¢–°–£–¢–°–¢–í–£–ï–¢'));
        }
        
        function clearToken() {
            localStorage.removeItem('unifarm_jwt_token');
            log('[JWT Test] ‚ùå –¢–æ–∫–µ–Ω —É–¥–∞–ª–µ–Ω –∏–∑ localStorage');
        }
        
        async function testRefreshEndpoint() {
            const currentToken = localStorage.getItem('unifarm_jwt_token');
            if (!currentToken) {
                log('[JWT Test] ‚ö†Ô∏è –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–ª—è refresh —Ç–µ—Å—Ç–∞');
                return false;
            }
            
            try {
                log('[JWT Test] üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º /api/auth/refresh...');
                const response = await fetch('/api/auth/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + currentToken
                    },
                    body: JSON.stringify({ token: currentToken })
                });
                
                log('[JWT Test] Refresh status: ' + response.status);
                const data = await response.json();
                log('[JWT Test] Refresh response: ' + JSON.stringify(data, null, 2));
                
                if (response.ok && data.success && data.data?.token) {
                    localStorage.setItem('unifarm_jwt_token', data.data.token);
                    log('[JWT Test] ‚úÖ Refresh —É—Å–ø–µ—à–µ–Ω, —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω');
                    return true;
                } else {
                    log('[JWT Test] ‚ùå Refresh –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è');
                    return false;
                }
            } catch (error) {
                log('[JWT Test] ‚ùå Refresh error: ' + error.message);
                return false;
            }
        }
        
        async function testTelegramAuth() {
            if (!window.Telegram?.WebApp?.initData) {
                log('[JWT Test] ‚ö†Ô∏è Telegram initData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ –≤ Telegram WebApp)');
                return false;
            }
            
            try {
                log('[JWT Test] üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º /api/auth/telegram...');
                const response = await fetch('/api/auth/telegram', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        initData: window.Telegram.WebApp.initData
                    })
                });
                
                log('[JWT Test] Telegram auth status: ' + response.status);
                const data = await response.json();
                log('[JWT Test] Telegram auth response: ' + JSON.stringify(data, null, 2));
                
                if (response.ok && data.success && data.data?.token) {
                    localStorage.setItem('unifarm_jwt_token', data.data.token);
                    log('[JWT Test] ‚úÖ Telegram auth —É—Å–ø–µ—à–µ–Ω, —Ç–æ–∫–µ–Ω —Å–æ–∑–¥–∞–Ω');
                    return true;
                } else {
                    log('[JWT Test] ‚ùå Telegram auth –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è');
                    return false;
                }
            } catch (error) {
                log('[JWT Test] ‚ùå Telegram auth error: ' + error.message);
                return false;
            }
        }
        
        async function testTokenRecoveryService() {
            // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º tokenRecoveryService –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            if (typeof tokenRecoveryService !== 'undefined') {
                log('[JWT Test] üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º tokenRecoveryService.recoverJwtToken()...');
                try {
                    const result = await tokenRecoveryService.recoverJwtToken();
                    log('[JWT Test] TokenRecoveryService result: ' + result);
                    return result;
                } catch (error) {
                    log('[JWT Test] ‚ùå TokenRecoveryService error: ' + error.message);
                    return false;
                }
            } else {
                log('[JWT Test] ‚ö†Ô∏è TokenRecoveryService –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω)');
                return false;
            }
        }
        
        async function runTests() {
            resultsDiv.innerHTML = '';
            log('[JWT Test] === –ù–ê–ß–ò–ù–ê–ï–ú –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï JWT RECOVERY ===');
            
            showCurrentToken();
            
            log('[JWT Test] === –¢–ï–°–¢ 1: REFRESH ENDPOINT ===');
            await testRefreshEndpoint();
            
            log('[JWT Test] === –¢–ï–°–¢ 2: TELEGRAM AUTH ===');
            await testTelegramAuth();
            
            log('[JWT Test] === –¢–ï–°–¢ 3: TOKEN RECOVERY SERVICE ===');
            await testTokenRecoveryService();
            
            log('[JWT Test] === –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û ===');
            showCurrentToken();
        }
    </script>
</body>
</html>