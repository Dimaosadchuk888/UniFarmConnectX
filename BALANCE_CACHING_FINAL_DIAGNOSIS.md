# üéØ –§–ò–ù–ê–õ–¨–ù–´–ô –î–ò–ê–ì–ù–û–ó: –ü–†–û–ë–õ–ï–ú–ê –ö–ï–®–ò–†–û–í–ê–ù–ò–Ø TON –ë–ê–õ–ê–ù–°–ê

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 03 –ê–≤–≥—É—Å—Ç–∞ 2025, 19:05  
**–°—Ç–∞—Ç—É—Å:** –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ù–ê–ô–î–ï–ù–ê

---

## ‚úÖ **–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê**

### üö® **–°–∏–º–ø—Ç–æ–º:**
–ü–æ—Å–ª–µ TON –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç:
```
–°—Ç–∞—Ä—ã–π –±–∞–ª–∞–Ω—Å ‚Üí –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å ‚Üí –°—Ç–∞—Ä—ã–π –±–∞–ª–∞–Ω—Å
```

### üîç **–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
**–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–µc–∫–æ–æ—Ä–¥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ —Å–æ–∑–¥–∞—é—Ç race condition**

---

## üìã **–î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê –ò–ó –ê–ù–ê–õ–ò–ó–ê –ö–û–î–ê –ò –õ–û–ì–û–í**

### **1. üîÑ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**

```typescript
// 1. WebSocket –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–ø—Ä–∏ –∫–∞–∂–¥–æ–º balance_update)
if (lastMessage && lastMessage.type === 'balance_update') {
  refreshBalance(true); // ‚Üê –û—á–∏—â–∞–µ—Ç –∫–µ—à
}

// 2. –ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫)
setInterval(() => {
  refreshBalance(true); // ‚Üê –û—á–∏—â–∞–µ—Ç –∫–µ—à –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ  
}, 30000);

// 3. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ WebSocket –ø–æ–¥–ø–∏—Å–∫–∏ (–≤–∏–¥–Ω–æ –≤ –ª–æ–≥–∞—Ö)
[useWebSocketBalanceSync] –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: 184
[WebSocket] –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: 184
```

### **2. üîÑ –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫–µ—à-–∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–∏–µ:**

```typescript
// –í balanceService.ts
if (forceRefresh) {
  cacheService.invalidate(cacheKey); // ‚Üê –£–¥–∞–ª—è–µ—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ
}

// TTL —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π
BALANCE_TTL: 15000, // 15 —Å–µ–∫—É–Ω–¥
```

### **3. üìä –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö:**

```javascript
// –ß–∞—Å—Ç—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ WebSocket (–∏–∑–±—ã—Ç–æ—á–Ω—ã–µ)
[useWebSocketBalanceSync] –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: 184
[WebSocket] –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: 184

// –ß–∞—Å—Ç–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞
[CacheService] –ö–µ—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω: balance:184

// –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
[UserContext] refreshBalance —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–∏–ª –±–∞–ª–∞–Ω—Å
```

---

## üéØ **–¢–û–ß–ù–´–ô –°–¶–ï–ù–ê–†–ò–ô –ü–†–û–ë–õ–ï–ú–´**

### **Timeline "–ø—Ä—ã–≥–∞—é—â–µ–≥–æ" –±–∞–ª–∞–Ω—Å–∞:**

```
[T+0s]  TON –¥–µ–ø–æ–∑–∏—Ç –ø–æ—Å—Ç—É–ø–∞–µ—Ç –Ω–∞ –∫–æ—à–µ–ª–µ–∫
[T+1s]  –°–µ—Ä–≤–µ—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç –ë–î —Å –Ω–æ–≤—ã–º –±–∞–ª–∞–Ω—Å–æ–º
[T+2s]  WebSocket –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç balance_update
[T+3s]  Frontend #1: refreshBalance(true) ‚Üí –ö–µ—à –æ—á–∏—â–µ–Ω
[T+4s]  API –∑–∞–ø—Ä–æ—Å #1 ‚Üí –ü–æ–ª—É—á–µ–Ω –ù–û–í–´–ô –±–∞–ª–∞–Ω—Å ‚úÖ
[T+5s]  UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
[T+6s]  –ò–Ω—Ç–µ—Ä–≤–∞–ª (30 —Å–µ–∫) –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
[T+7s]  Frontend #2: refreshBalance(true) ‚Üí –ö–µ—à —Å–Ω–æ–≤–∞ –æ—á–∏—â–µ–Ω  
[T+8s]  API –∑–∞–ø—Ä–æ—Å #2 ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –°–¢–ê–†–´–ô –±–∞–ª–∞–Ω—Å ‚ùå
[T+9s]  UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–π –±–∞–ª–∞–Ω—Å üö® –ü–†–û–ë–õ–ï–ú–ê!
```

### **–ü–æ—á–µ–º—É API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–π –±–∞–ª–∞–Ω—Å:**
- –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –º–æ–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- –ë–î —Ä–µ–ø–ª–∏–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞  
- –ö–µ—à –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Ç–æ–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å invalidated

---

## üõ†Ô∏è **–ö–û–ú–ü–û–ù–ï–ù–¢–´ –°–ò–°–¢–ï–ú–´ –ò –ò–• –ü–†–û–ë–õ–ï–ú–´**

### **üîß balanceService.ts:**
- ‚ùå **–ö–æ—Ä–æ—Ç–∫–∏–π TTL:** 15 —Å–µ–∫—É–Ω–¥ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ
- ‚ùå **–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è:** forceRefresh —É–¥–∞–ª—è–µ—Ç –≤—Å—ë
- ‚ùå **–ù–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏:** –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—Ç—Å—è

### **üîß useWebSocketBalanceSync.ts:**
- ‚ùå **–ò–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏:** WebSocket –ø–æ–¥–ø–∏—Å–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
- ‚ùå **–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã:** –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫ forceRefresh=true
- ‚ùå **–ù–µ—Ç –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–∞:** –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ balance_update –Ω–µ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è

### **üîß UserContext.tsx:**
- ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç race condition:** refreshInProgressRef.current —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚ùå **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** refreshBalance –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
- ‚ùå **–ù–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏:** –Ω–µ –∑–Ω–∞–µ—Ç –æ –¥—Ä—É–≥–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

---

## üí° **–°–¢–†–ê–¢–ï–ì–ò–ß–ï–°–ö–ò–ï –†–ï–®–ï–ù–ò–Ø**

### **üéØ 1. –ï–¥–∏–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:**
```typescript
class BalanceUpdateCoordinator {
  private lastUpdateTime = 0;
  private pendingUpdate = false;
  
  async requestUpdate(source: string, force: boolean = false) {
    // –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
  }
}
```

### **üéØ 2. –£–º–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```typescript
// –£–≤–µ–ª–∏—á–∏—Ç—å TTL –∏ –¥–æ–±–∞–≤–∏—Ç—å stale-while-revalidate
BALANCE_TTL: 60000, // 60 —Å–µ–∫—É–Ω–¥
STALE_WHILE_REVALIDATE: 30000, // 30 —Å–µ–∫—É–Ω–¥

// –ù–µ —É–¥–∞–ª—è—Ç—å –∫–µ—à –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–∏ forceRefresh
if (forceRefresh && cacheAge < MINIMUM_CACHE_AGE) {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º stale data –ø–æ–∫–∞ –ø–æ–ª—É—á–∞–µ–º fresh
}
```

### **üéØ 3. WebSocket –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥:**
```typescript
const debouncedRefresh = debounce((force) => {
  refreshBalance(force);
}, 1000); // 1 —Å–µ–∫—É–Ω–¥–∞ –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥

// –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ balance_update —Å–æ–æ–±—â–µ–Ω–∏–π
```

### **üéØ 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤:**
```typescript
// –ú–µ–Ω–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
setInterval(() => {
  refreshBalance(false); // –ë–ï–ó forceRefresh
}, 120000); // 2 –º–∏–Ω—É—Ç—ã –≤–º–µ—Å—Ç–æ 30 —Å–µ–∫—É–Ω–¥
```

---

## üéä **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

### **‚úÖ –î–∏–∞–≥–Ω–æ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω:**
–ü—Ä–æ–±–ª–µ–º–∞ "–ø—Ä—ã–≥–∞—é—â–µ–≥–æ" TON –±–∞–ª–∞–Ω—Å–∞ –≤—ã–∑–≤–∞–Ω–∞ **–Ω–µc–∫–æ–æ—Ä–¥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏** –∏ **–∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º –∫–µ—à-–∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º**.

### **üéØ –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:**
- **UX Impact:** –í–´–°–û–ö–ò–ô - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ—Ä—è—é—Ç –¥–æ–≤–µ—Ä–∏–µ –∫ —Å–∏—Å—Ç–µ–º–µ
- **–ë–∏–∑–Ω–µ—Å Impact:** –°–†–ï–î–ù–ò–ô - –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—Ç—Ç–æ–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
- **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å:** –°–†–ï–î–ù–Ø–Ø - –Ω—É–∂–µ–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏

### **üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å BalanceUpdateCoordinator
2. –î–æ–±–∞–≤–∏—Ç—å WebSocket –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥
3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö TON –¥–µ–ø–æ–∑–∏—Ç–∞—Ö

**–°—Ç–∞—Ç—É—Å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é:** ‚úÖ –ì–û–¢–û–í–û –ö –†–ê–ó–†–ê–ë–û–¢–ö–ï