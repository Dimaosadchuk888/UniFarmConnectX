# –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

## üìä –ö–†–ê–¢–ö–ò–ï –í–´–í–û–î–´

‚úÖ **–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ò–°–ü–†–ê–í–õ–ï–ù–ê –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**  
‚ùå **–ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ –∫–æ–¥–µ, –∞ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ API**  
üîç **–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint**  

---

## üîç –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó

### 1. –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–¥–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω**
```typescript
// modules/auth/service.ts:6
import { ReferralService } from '../referral/service';
```

**‚úÖ –õ–æ–≥–∏–∫–∞ processReferral –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç**
```typescript
// modules/auth/service.ts:168-190
if (options.ref_by && userInfo) {
  const referralService = new ReferralService();
  const referralResult = await referralService.processReferral(options.ref_by, userInfo.id.toString());
}
```

**‚úÖ –ú–µ—Ç–æ–¥ processReferral —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**
- –û–±–Ω–æ–≤–ª—è–µ—Ç referred_by –≤ —Ç–∞–±–ª–∏—Ü–µ users
- –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ referrals
- –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞

### 2. –°–æ—Å—Ç–æ—è–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞**
```sql
referrals: 6 –∑–∞–ø–∏—Å–µ–π (–≤—Å–µ –≤–∞–ª–∏–¥–Ω—ã–µ)
users: 6 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å referred_by = 184
```

**‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—ã —Ä–∞–±–æ—Ç–∞—é—Ç**
- Users 185-190 –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–≤—è–∑–∞–Ω—ã —Å User 184
- –í—Å–µ –∑–∞–ø–∏—Å–∏ –≤ referrals –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä—É—á–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é (16.5 —á–∞—Å–æ–≤ —Ä–∞–∑–Ω–∏—Ü–∞)

### 3. –ü—Ä–æ–±–ª–µ–º–∞ —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

**‚ùå 7 –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (191-197) –∏–º–µ—é—Ç referred_by: null**
- –í—Å–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –ø–æ—Å–ª–µ 18 –∏—é–ª—è 06:00
- –†–µ–∞–ª—å–Ω—ã–µ telegram_id –∏ usernames
- –ù–ï –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### 4. –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

**üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint**

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint**: `/api/v2/auth/telegram`  
**–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint**: `/api/v2/auth/login` (404 Not Found)

```javascript
// –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
const response = await fetch('/api/v2/auth/telegram', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    initData: telegramInitData,
    refBy: refCode  // –í–Ω–∏–º–∞–Ω–∏–µ: refBy, –Ω–µ ref_by!
  })
});
```

### 5. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞

**‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–æ–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**

–í –∫–æ–¥–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è:
- `options.ref_by` (auth/service.ts:168)

–í —Å—Ö–µ–º–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:
- `refBy` (auth/routes.ts:13)

---

## üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ

### 1. –û–±–Ω–æ–≤–∏—Ç—å frontend (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
```javascript
// –ò—Å–ø—Ä–∞–≤–∏—Ç—å endpoint
const response = await fetch('/api/v2/auth/telegram', {
  method: 'POST',
  body: JSON.stringify({
    initData: telegramData,
    refBy: referralCode  // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å refBy
  })
});
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
```typescript
// –í auth/controller.ts –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
const refBy = req.body.refBy;
const result = await this.authService.authenticateFromTelegram(
  initData, 
  { ref_by: refBy }  // –ú–∞–ø–ø–∏–Ω–≥ refBy -> ref_by
);
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º endpoint
node test_referral_flow.cjs
```

---

## üìà –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è endpoint:
1. **–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** –±—É–¥—É—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ AuthService
2. **–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞** –Ω–∞—á–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è –Ω–æ–≤—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π
3. **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å** –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è —Å 0% –¥–æ 95-100%

---

## üéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é.**

–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –ù–ï –≤ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–º –∏–º–ø–æ—Ä—Ç–µ (—Ö–æ—Ç—è –µ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ã–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º), –∞ –≤ —Ç–æ–º, —á—Ç–æ –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–∑–æ–≤–∞ API —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º endpoint –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.