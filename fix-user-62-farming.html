<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ uni_farming_rate –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 62</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .status {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .button:hover {
            background: #45a049;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        .error {
            color: #f44336;
            font-weight: bold;
        }
        .warning {
            color: #ff9800;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UNI —Ñ–∞—Ä–º–∏–Ω–≥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 62</h1>
        
        <div class="status">
            <h3>–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:</h3>
            <p>–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 62 –µ—Å—Ç—å –¥–µ–ø–æ–∑–∏—Ç 100 UNI, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ <code>uni_farming_rate</code>, 
            –∏–∑-–∑–∞ —á–µ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã.</p>
        </div>

        <button id="fixButton" class="button" onclick="fixFarmingRate()">
            –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å uni_farming_rate = 0.01
        </button>

        <div id="log" class="log" style="display: none;"></div>
    </div>

    <script>
        const API_URL = '/api/v2';
        const USER_ID = 62;
        const FARMING_RATE = '0.01';
        
        function log(message, type = '') {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const className = type ? ` class="${type}"` : '';
            logDiv.innerHTML += `[${timestamp}]${className ? `<span${className}>` : ''} ${message}${className ? '</span>' : ''}\n`;
        }
        
        async function fixFarmingRate() {
            const button = document.getElementById('fixButton');
            button.disabled = true;
            
            log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è...', 'warning');
            
            // –ü–æ–ª—É—á–∞–µ–º JWT —Ç–æ–∫–µ–Ω –∏–∑ localStorage
            const jwtToken = localStorage.getItem('unifarm_jwt_token');
            if (!jwtToken) {
                log('‚ùå JWT —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage!', 'error');
                log('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.', 'error');
                button.disabled = false;
                return;
            }
            
            log('‚úÖ JWT —Ç–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω, –¥–ª–∏–Ω–∞: ' + jwtToken.length);
            
            try {
                // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
                log('\nüìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞...');
                const statusResponse = await fetch(`${API_URL}/farming/status?user_id=${USER_ID}`, {
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`
                    }
                });
                
                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    const data = statusData.data || {};
                    log(`–§–∞—Ä–º–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω: ${data.uni_farming_active || false}`);
                    log(`–î–µ–ø–æ–∑–∏—Ç: ${data.uni_deposit_amount || 0} UNI`);
                    log(`–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞: ${data.uni_farming_rate || '–ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–ê'}`);
                }
                
                // 2. –û–±–Ω–æ–≤–ª—è–µ–º uni_farming_rate
                log('\nüîß –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ uni_farming_rate...');
                const updateResponse = await fetch(`${API_URL}/users/${USER_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uni_farming_rate: FARMING_RATE
                    })
                });
                
                if (!updateResponse.ok) {
                    const errorText = await updateResponse.text();
                    throw new Error(`HTTP ${updateResponse.status}: ${errorText}`);
                }
                
                const result = await updateResponse.json();
                log('‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                
                // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                log('\nüìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞...');
                const newStatusResponse = await fetch(`${API_URL}/farming/status?user_id=${USER_ID}`, {
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`
                    }
                });
                
                if (newStatusResponse.ok) {
                    const newStatusData = await newStatusResponse.json();
                    const newData = newStatusData.data || {};
                    log(`–§–∞—Ä–º–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω: ${newData.uni_farming_active || false}`, 
                        newData.uni_farming_active ? 'success' : 'warning');
                    log(`–î–µ–ø–æ–∑–∏—Ç: ${newData.uni_deposit_amount || 0} UNI`);
                    log(`–ù–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞: ${newData.uni_farming_rate || '–ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–ê'}`, 
                        newData.uni_farming_rate === FARMING_RATE ? 'success' : 'error');
                    
                    if (newData.uni_farming_rate === FARMING_RATE) {
                        log('\nüéâ –°—Ç–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!', 'success');
                        log('–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞—á–Ω–µ—Ç –Ω–∞—á–∏—Å–ª—è—Ç—å –Ω–∞–≥—Ä–∞–¥—ã –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ü–∏–∫–ª–µ (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç).', 'success');
                        log('–ë–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è —Å —Ç–µ–∫—É—â–∏—Ö 448.22702 UNI.', 'success');
                    }
                }
                
            } catch (error) {
                log(`\n‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                log('–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:', 'warning');
                log('1. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É');
                log('2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                log('3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (scripts/fix-farming-rate.sql)');
            } finally {
                button.disabled = false;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ JWT —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            const hasToken = !!localStorage.getItem('unifarm_jwt_token');
            if (!hasToken) {
                log('‚ö†Ô∏è JWT —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.', 'warning');
            } else {
                log('‚úÖ JWT —Ç–æ–∫–µ–Ω –æ–±–Ω–∞—Ä—É–∂–µ–Ω. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.', 'success');
            }
        };
    </script>
</body>
</html>