# Детальный анализ проблемы синхронизации баланса UniFarming

## Краткая сводка проблемы
Баланс пользователя не обновляется автоматически в браузере после начисления наград от фарминга. Пользователь вынужден обновлять страницу вручную, чтобы увидеть новый баланс.

## Корневая причина: Конфликт двух версий BalanceNotificationService

### 1. Обнаружены два файла с разными именами:
- `core/balanceNotificationService.ts` (строчная буква) - создан 4 июля 2025
- `core/BalanceNotificationService.ts` (заглавная буква) - создан 11 июля 2025

### 2. Каждый файл имеет разную сигнатуру методов:

**Версия 1 (строчная буква):**
```typescript
// Ожидает объект с данными
public notifyBalanceUpdate(updateData: BalanceUpdateData): void

// Методы для WebSocket
public registerConnection(userId: number, ws: WebSocket): void
public removeConnection(userId: number, ws: WebSocket): void
```

**Версия 2 (заглавная буква):**
```typescript
// Ожидает только userId
async notifyBalanceUpdate(userId: number): Promise<void>

// Методы для WebSocket (другие названия!)
addConnection(userId: number, socket: WebSocket): void
removeConnection(userId: number, socket: WebSocket): void
```

### 3. Использование в разных частях системы:

| Файл | Импортирует версию | Использует методы |
|------|-------------------|-------------------|
| server/index.ts | balanceNotificationService (строчная) | registerConnection, removeConnection |
| core/BatchBalanceProcessor.ts | BalanceNotificationService (заглавная) | notifyBalanceUpdate |
| server/websocket-balance-integration.ts | BalanceNotificationService (заглавная) | notifyBalanceUpdate |

## Как это ломает систему:

### Шаг 1: WebSocket подключение
- Браузер подключается по WebSocket
- `server/index.ts` регистрирует соединение через `registerConnection` в **версии 1**
- Соединение сохраняется в `Map<number, WebSocket[]>` в файле с маленькой буквы

### Шаг 2: Начисление награды от фарминга
- Каждые 5 минут запускается `farmingScheduler`
- Он вызывает `BatchBalanceProcessor.processFarmingIncome()`
- BatchBalanceProcessor обновляет баланс в базе данных

### Шаг 3: Попытка отправить уведомление (ГДЕ ЛОМАЕТСЯ)
- BatchBalanceProcessor импортирует **версию 2** (заглавная буква)
- Вызывает `notifyBalanceUpdate` с объектом:
```typescript
notificationService.notifyBalanceUpdate({
  userId: op.userId,
  changeAmount: 228.447367,
  currency: 'UNI',
  source: 'batch_update',
  timestamp: '2025-07-13T05:22:02.671Z'
});
```
- НО! Версия 2 ожидает только `userId`, а не объект
- Более того, WebSocket соединения хранятся в ДРУГОМ файле (версия 1)
- Версия 2 не видит зарегистрированные соединения
- Уведомление не отправляется

### Шаг 4: Результат
- Баланс обновлен в базе данных ✅
- Транзакция создана ✅
- WebSocket уведомление НЕ отправлено ❌
- UI не обновляется автоматически ❌

## Доказательства из логов:

### 1. WebSocket подключен и работает:
```
[WebSocket] Подписка на обновления пользователя: 74
[useWebSocketBalanceSync] Подписка на обновления баланса для пользователя: 74
```

### 2. Фарминг работает (новые транзакции):
```
FARMING_REWARD: 228.447367 UNI (05:22:02)
FARMING_REWARD: 209.569163 UNI (05:16:59)
```

### 3. НО нет сообщений типа `balance_update` в логах браузера

## Текущее состояние системы:
- ✅ Фарминг расчеты: работают правильно
- ✅ База данных: обновляется корректно
- ✅ Транзакции: создаются правильно
- ✅ WebSocket: подключение активно
- ❌ Уведомления: не отправляются из-за конфликта версий

## Влияние на пользователей:
1. Баланс не обновляется в реальном времени
2. Нужно обновлять страницу F5 чтобы увидеть новый баланс
3. Создается впечатление, что фарминг не работает (хотя он работает)
4. Пользователь видит старый баланс: 1,377,201.45 UNI вместо актуального

## Временное решение для пользователей:
**Обновляйте страницу (F5) чтобы увидеть актуальный баланс**

## Техническое решение:
1. Удалить один из конфликтующих файлов
2. Стандартизировать все импорты на одну версию
3. Убедиться что все методы используют правильную сигнатуру
4. Протестировать сквозную доставку WebSocket сообщений

## Вывод:
Система фарминга работает идеально. Проблема только в системе уведомлений, которая не может отправить обновление в браузер из-за существования двух несовместимых версий одного и того же сервиса. Как только конфликт будет устранен, балансы начнут обновляться в реальном времени без необходимости перезагрузки страницы.