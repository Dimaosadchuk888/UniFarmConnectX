<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test UNI Farming Deposit - User 74</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #333;
            border-radius: 5px;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .error {
            color: #ff6b6b;
            background: #3a0000;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #51cf66;
            background: #003a00;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        #logs {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px;
        }
        .amount-button {
            background: #6366f1;
            margin: 5px;
        }
        .amount-button:hover {
            background: #4f46e5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test UNI Farming Deposit - User 74</h1>
        
        <div class="section">
            <h2>User Info</h2>
            <div id="userInfo">Loading...</div>
        </div>

        <div class="section">
            <h2>Current Balance</h2>
            <div id="balance">Loading...</div>
        </div>

        <div class="section">
            <h2>Farming Status</h2>
            <div id="farmingStatus">Loading...</div>
        </div>

        <div class="section">
            <h2>Test Deposit</h2>
            <div>
                <input type="number" id="depositAmount" placeholder="Enter amount" value="5" step="0.1">
                <button onclick="testDeposit()">Test Deposit</button>
            </div>
            <div>
                <button class="amount-button" onclick="setAmount(5)">5 UNI</button>
                <button class="amount-button" onclick="setAmount(10)">10 UNI</button>
                <button class="amount-button" onclick="setAmount(25)">25 UNI</button>
                <button class="amount-button" onclick="setAmount(50)">50 UNI</button>
            </div>
        </div>

        <div class="section">
            <h2>Response</h2>
            <div id="response"></div>
        </div>

        <div class="section">
            <h2>Debug Logs</h2>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        const JWT_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjc0LCJ0ZWxlZ3JhbV9pZCI6OTk5NDg5LCJ1c2VybmFtZSI6InRlc3RfdXNlcl8xNzUyMTI5ODQwOTA1IiwicmVmX2NvZGUiOiJSRUZfMTc1MjEyOTg0MDkwNl9hNGRha3ciLCJpYXQiOjE3NTIxMjk4NDIsImV4cCI6MTc1MjczNDY0Mn0.wbXSPiEkUrXgvGJqFcJEaGeFMD3zM0sQzl_-tYg_lro';
        const API_BASE = '/api/v2';

        function log(message, data = null) {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toISOString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `[${timestamp}] ${message}`;
            if (data) {
                logEntry.textContent += ` - ${JSON.stringify(data, null, 2)}`;
            }
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message, data);
        }

        function setAmount(amount) {
            document.getElementById('depositAmount').value = amount;
            log(`Amount set to ${amount} UNI`);
        }

        async function makeRequest(url, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${JWT_TOKEN}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }

            log(`Making ${method} request to ${url}`, body);

            try {
                const response = await fetch(url, options);
                const data = await response.json();
                log(`Response from ${url}:`, data);
                return data;
            } catch (error) {
                log(`Error in request to ${url}:`, error.message);
                throw error;
            }
        }

        async function loadUserInfo() {
            try {
                const data = await makeRequest(`${API_BASE}/users/profile?user_id=74`);
                document.getElementById('userInfo').innerHTML = `
                    <div>ID: ${data.data?.id || 'N/A'}</div>
                    <div>Username: ${data.data?.username || 'N/A'}</div>
                    <div>Telegram ID: ${data.data?.telegram_id || 'N/A'}</div>
                `;
            } catch (error) {
                document.getElementById('userInfo').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function loadBalance() {
            try {
                const data = await makeRequest(`${API_BASE}/wallet/balance?user_id=74`);
                document.getElementById('balance').innerHTML = `
                    <div>UNI Balance: ${data.data?.balance_uni || 'N/A'}</div>
                    <div>TON Balance: ${data.data?.balance_ton || 'N/A'}</div>
                `;
            } catch (error) {
                document.getElementById('balance').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function loadFarmingStatus() {
            try {
                const data = await makeRequest(`${API_BASE}/uni-farming/status?user_id=74`);
                const status = data.data;
                document.getElementById('farmingStatus').innerHTML = `
                    <div>Active: ${status?.uni_farming_active ? 'Yes' : 'No'}</div>
                    <div>Deposit Amount: ${status?.uni_deposit_amount || 0} UNI</div>
                    <div>Farming Balance: ${status?.uni_farming_balance || 0} UNI</div>
                    <div>Rate: ${status?.uni_farming_rate || 0}%</div>
                `;
            } catch (error) {
                document.getElementById('farmingStatus').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function testDeposit() {
            const amount = document.getElementById('depositAmount').value;
            const responseDiv = document.getElementById('response');
            
            if (!amount || parseFloat(amount) <= 0) {
                responseDiv.innerHTML = '<div class="error">Please enter a valid amount</div>';
                return;
            }

            responseDiv.innerHTML = '<div>Processing deposit...</div>';

            try {
                // Step 1: Check current balance
                log('Step 1: Checking current balance');
                const balanceBefore = await makeRequest(`${API_BASE}/wallet/balance?user_id=74`);
                log('Balance before deposit:', balanceBefore.data);

                // Step 2: Make deposit
                log('Step 2: Making deposit');
                const depositData = {
                    amount: amount,
                    user_id: 74
                };
                
                const depositResponse = await makeRequest(
                    `${API_BASE}/uni-farming/deposit`,
                    'POST',
                    depositData
                );
                
                log('Deposit response:', depositResponse);

                // Step 3: Check balance after
                log('Step 3: Checking balance after deposit');
                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second
                const balanceAfter = await makeRequest(`${API_BASE}/wallet/balance?user_id=74`);
                log('Balance after deposit:', balanceAfter.data);

                // Step 4: Check farming status
                log('Step 4: Checking farming status');
                const farmingStatus = await makeRequest(`${API_BASE}/uni-farming/status?user_id=74`);
                log('Farming status after deposit:', farmingStatus.data);

                // Display results
                if (depositResponse.success) {
                    responseDiv.innerHTML = `
                        <div class="success">Deposit successful!</div>
                        <div>Message: ${depositResponse.message || 'Deposit completed'}</div>
                        <div>Balance before: ${balanceBefore.data?.balance_uni || 'N/A'} UNI</div>
                        <div>Balance after: ${balanceAfter.data?.balance_uni || 'N/A'} UNI</div>
                        <div>Amount deducted: ${parseFloat(balanceBefore.data?.balance_uni || 0) - parseFloat(balanceAfter.data?.balance_uni || 0)} UNI</div>
                    `;
                } else {
                    responseDiv.innerHTML = `
                        <div class="error">Deposit failed!</div>
                        <div>Message: ${depositResponse.message || 'Unknown error'}</div>
                    `;
                }

                // Reload all data
                await loadBalance();
                await loadFarmingStatus();

            } catch (error) {
                log('Error during deposit test:', error);
                responseDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Load initial data
        window.onload = async () => {
            log('Page loaded, initializing...');
            await loadUserInfo();
            await loadBalance();
            await loadFarmingStatus();
        };
    </script>
</body>
</html>