# üîç –†–ï–¢–†–û–°–ü–ï–ö–¢–ò–í–ù–´–ô –ê–£–î–ò–¢: –†–µ–≥—Ä–µ—Å—Å WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ UNI

**–î–∞—Ç–∞:** 10 —è–Ω–≤–∞—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ü–†–ò–ß–ò–ù–ê –†–ï–ì–†–ï–°–°–ê –£–°–¢–ê–ù–û–í–õ–ï–ù–ê

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

### 1. –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º

#### ‚úÖ 4 –∏—é–ª—è 2025 - –í–Ω–µ–¥—Ä–µ–Ω–∏–µ BalanceNotificationService
- –°–æ–∑–¥–∞–Ω `core/balanceNotificationService.ts` 
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏:
  - `core/scheduler/farmingScheduler.ts` - –¥–ª—è UNI farming –¥–æ—Ö–æ–¥–æ–≤
  - `modules/scheduler/tonBoostIncomeScheduler.ts` - –¥–ª—è TON boost –¥–æ—Ö–æ–¥–æ–≤
- WebSocket —Ö—ç–Ω–¥–ª–µ—Ä –≤ `server/index.ts` —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

#### ‚úÖ 6 –∏—é–ª—è 2025 - –°–æ–∑–¥–∞–Ω–∏–µ BalanceManager
- –ö–æ–º–º–∏—Ç: `4fe0ae404` - "Unify balance and transaction handling"
- –°–æ–∑–¥–∞–Ω `core/BalanceManager.ts` –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–ª–∞–Ω—Å–∞–º–∏
- –ó–∞–º–µ–Ω–∏–ª 4 –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞

### 2. –ì–¥–µ –ø—Ä–æ–∏–∑–æ—à–µ–ª —Ä–∞–∑—Ä—ã–≤

#### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ç–æ—á–∫–∞ —Ä–µ–≥—Ä–µ—Å—Å–∞:
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ BalanceManager **–ù–ï –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** —Å BalanceNotificationService!

**–ü–æ—á–µ–º—É —Ä–∞–±–æ—Ç–∞–ª–æ —Ä–∞–Ω—å—à–µ:**
- –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏ —Ñ–∞—Ä–º–∏–Ω–≥–∞ –Ω–∞–ø—Ä—è–º—É—é –æ–±–Ω–æ–≤–ª—è–ª–∏ –±–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ SQL
- –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–∑—ã–≤–∞–ª–∏ `BalanceNotificationService.notifyBalanceUpdate()`
- WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–ª—è–ª–∏—Å—å –Ω–∞ frontend

**–ü–æ—á–µ–º—É –ø–µ—Ä–µ—Å—Ç–∞–ª–æ —Ä–∞–±–æ—Ç–∞—Ç—å:**
- BalanceManager —Å—Ç–∞–ª –µ–¥–∏–Ω–æ–π —Ç–æ—á–∫–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤
- –í—Å–µ –º–æ–¥—É–ª–∏ (–≤–∫–ª—é—á–∞—è FarmingService) —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç `BalanceManager.subtractBalance()`
- –ù–û BalanceManager **–Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç** BalanceNotificationService –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!

### 3. –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞

#### –í –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ (—Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ):
```typescript
// core/scheduler/farmingScheduler.ts —Å—Ç—Ä–æ–∫–∏ 120-130
// –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ SQL:
const balanceService = BalanceNotificationService.getInstance();
balanceService.notifyBalanceUpdate({
  userId: farmer.id,
  balanceUni: parseFloat(farmer.balance_uni || '0') + parseFloat(income),
  balanceTon: parseFloat(farmer.balance_ton || '0'),
  changeAmount: parseFloat(income),
  currency: 'UNI',
  source: 'farming',
  timestamp: new Date().toISOString()
});
```

#### –í BalanceManager (–ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç ‚ùå):
```typescript
// core/BalanceManager.ts —Å—Ç—Ä–æ–∫–∏ 130-160
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
logger.info('[BalanceManager] –ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', {...});
return { success: true, newBalance };
// –ù–ï–¢ –≤—ã–∑–æ–≤–∞ BalanceNotificationService!
```

### 4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã

#### WebSocket –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- ‚úÖ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ (–≤–∏–¥–Ω–æ –≤ –ª–æ–≥–∞—Ö: "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: 74")
- ‚úÖ BalanceNotificationService —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- ‚úÖ Frontend —Å–ª—É—à–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è `balance_update`

#### –ù–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–æ–∑–∏—Ç–µ:
- ‚ùå FarmingService ‚Üí BalanceManager ‚Üí Supabase ‚úÖ ‚Üí –ö–û–ù–ï–¶ (–Ω–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
- ‚úÖ FarmingScheduler ‚Üí Supabase ‚úÖ ‚Üí BalanceNotificationService ‚úÖ ‚Üí WebSocket ‚úÖ

## üéØ –í—ã–≤–æ–¥—ã

### –¢–æ—á–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ —Ä–µ–≥—Ä–µ—Å—Å–∞:
**–ü—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ 6 –∏—é–ª—è 2025** –∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ BalanceManager –±—ã–ª–∞ —É–ø—É—â–µ–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å BalanceNotificationService, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–±–æ—Ç–∞–ª–∞ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞—Ö —Å 4 –∏—é–ª—è.

### –ü–æ—á–µ–º—É —ç—Ç–æ –Ω–µ –±—ã–ª–æ –∑–∞–º–µ—á–µ–Ω–æ —Å—Ä–∞–∑—É:
1. –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–æ–Ω–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç BalanceManager)
2. –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–ª—Å—è –≤ –ë–î –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ
4. –ü—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ—è–≤–ª—è–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –¥–µ–ø–æ–∑–∏—Ç–∞—Ö

### –ß—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å:
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ farming –ø–∞–∫–µ—Ç–æ–≤
- –†–µ–∞–ª-—Ç–∞–π–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∞–Ω–∏–π UNI
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏

### –ì–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:
- ‚úÖ –í –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞—Ö (farmingScheduler, tonBoostIncomeScheduler)
- ‚ùå –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ BalanceManager

### –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é:
–î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ BalanceNotificationService –≤ –º–µ—Ç–æ–¥ `updateUserBalance` –∫–ª–∞—Å—Å–∞ BalanceManager –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤ –ë–î (—Å—Ç—Ä–æ–∫–∞ ~160).