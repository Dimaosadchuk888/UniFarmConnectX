# 🎯 ACTION PLAN: Исправление архитектурных проблем UniFarming

**Дата:** 14 января 2025  
**Приоритет:** КРИТИЧЕСКИЙ  
**Тип:** Архитектурный рефакторинг

## 📋 КРАТКОЕ ОПИСАНИЕ ПРОБЛЕМЫ

Система UniFarming имеет **множественные пути расчета дохода**, работающие параллельно и непоследовательно:
- Основной код корректен (использует `deposit_amount`)
- Существует fallback логика (использует `balance_uni`)
- Возможны дублированные процессы или накопленные периоды

**Бизнес-риск:** Пользователи получают неправильные начисления, что подрывает доверие к системе.

## 🔧 ПЛАН ДЕЙСТВИЙ

### ФАЗА 1: ДИАГНОСТИКА (1-2 дня)
**Цель:** Найти все источники начисления farming income

#### 1.1 Аудит планировщиков
- [x] Найти ВСЕ файлы с текстом `FARMING_REWARD` или `farming income`
  - ✅ Найдено 8 файлов: farmingScheduler.ts, fix-farming-scheduler.ts, test-farming-*.ts
  - ✅ Основной планировщик: core/scheduler/farmingScheduler.ts
  - ✅ Есть альтернативные скрипты исправления (fix-farming-scheduler.ts)
- [x] Проверить crontab/systemd на предмет дублированных задач
  - ✅ Планировщик запускается через node-cron в процессе Node.js
  - ✅ Использует `*/5 * * * *` (каждые 5 минут) 
  - ✅ Нет внешних cron/systemd задач
- [x] Проверить логи за последние 7 дней на аномальные паттерны
  - ✅ Обнаружен BatchBalanceProcessor timeout (30 секунд)
  - ✅ Временно отключен batch update (строка 117 farmingScheduler.ts)
  - ✅ Накопление периодов связано с пропущенными запусками

#### 1.2 Трассировка транзакций
- [x] Взять 5 аномальных транзакций User 74 (>2000 UNI)
  - ✅ ID 665177: 4876.22 UNI (22 периода = 110 минут накопления)
  - ✅ ID 664978: 4652.77 UNI (21 период = 105 минут)
  - ✅ ID 664779: 4428.81 UNI (20 периодов = 100 минут)
  - ✅ ID 664580: 4205.12 UNI (19 периодов = 95 минут)
  - ✅ ID 664381: 3981.35 UNI (18 периодов = 90 минут)
- [x] Найти точное место создания через поиск по logs
  - ✅ Все транзакции создаются в farmingScheduler.ts
  - ✅ Накопление происходит из-за пропуска запусков планировщика
- [x] Определить call stack для каждой
  - ✅ server/index.ts → farmingScheduler.start()
  - ✅ cron каждые 5 минут → processUniFarmingIncome()
  - ✅ calculateUniFarmingIncome() накапливает периоды с последнего обновления

#### 1.3 Анализ данных
- [x] SQL запрос: все пользователи с `uni_deposit_amount IS NULL`
  - ✅ Найдено 0 пользователей с NULL депозитом
  - ✅ ВСЕ пользователи имеют корректный uni_deposit_amount
- [x] Проверить даты их регистрации и источник
  - ✅ Не применимо - нет пользователей с NULL
- [x] Найти корреляцию с проблемными начислениями
  - ✅ Проблема не в fallback логике, а в накоплении периодов
  - ✅ Основная причина: пропуски запусков планировщика

### ФАЗА 2: ИЗОЛЯЦИЯ (2-3 дня)
**Цель:** Отключить все альтернативные механизмы

#### 2.1 Создать единую точку входа
- [x] Создан UnifiedFarmingCalculator.ts
  - ✅ Единственная точка расчета farming income
  - ✅ Логирование всех вызовов с call stack
  - ✅ Валидация deposit_amount !== null
  - ✅ Защита от накопления: максимум 288 периодов (24 часа)
  - ✅ Лимит транзакции: максимум 10k UNI
  - ✅ Метод validateCalculation для дополнительной проверки
- [x] Интегрирован в farmingScheduler.ts
  - ✅ Заменен старый calculateUniFarmingIncome
  - ✅ Добавлена валидация перед добавлением в farmerIncomes

#### 2.2 Временные меры
- [x] Добавить в `farmingScheduler.ts`:
  ```typescript
  if (!farmer.deposit_amount || farmer.deposit_amount === '0') {
    logger.warn(`SKIP: User ${farmer.user_id} has no deposit`);
    continue;
  }
  ```
  - ✅ Добавлена проверка в строки 101-105
- [x] Мониторинг: алерт при создании транзакций >1000 UNI
  - ✅ Добавлен алерт в строки 111-118
  - ✅ Логирование userId, amount, depositAmount, lastUpdate

#### 2.3 Отключение дубликатов
- [x] Найти альтернативные cron/schedulers:
  - ✅ fix-farming-scheduler.ts - прямое начисление минуя планировщик (строки 38-75)
  - ✅ test-farming-scheduler-once.ts - тестовый запуск планировщика
  - ✅ Прямые SQL обновления балансов в fix-farming-scheduler.ts (строки 59-66)
- [x] Закомментировать/удалить альтернативные скрипты
  - ✅ fix-farming-scheduler.ts → fix-farming-scheduler.ts.disabled
  - ✅ test-farming-scheduler-once.ts → test-farming-scheduler-once.ts.disabled
- [x] Добавить distributed lock для предотвращения параллельных запусков
  - ✅ Добавлен флаг isProcessing в FarmingScheduler
  - ✅ Проверка минимального интервала 4.5 минуты между запусками
  - ✅ Логирование всех пропусков с причинами
  - ✅ Finally блок для гарантированного снятия lock

### ФАЗА 3: ИСПРАВЛЕНИЕ ДАННЫХ (3-4 дня)
**Цель:** Привести данные в консистентное состояние

#### 3.1 Миграция пользователей
- [x] Для всех с `uni_deposit_amount = NULL`:
  - Если есть транзакции `FARMING_DEPOSIT` → восстановить сумму
  - Если нет → установить `uni_deposit_amount = 0`
  - ✅ Создан и запущен phase3-migrate-null-deposits.ts
  - ✅ Результат: 0 пользователей с NULL депозитами найдено
  
#### 3.2 Перерасчет балансов
- [x] Создать скрипт `scripts/recalculate-farming-balances.ts`
- [x] Для каждого пользователя:
  1. Суммировать все `FARMING_DEPOSIT` транзакции
  2. Суммировать все `FARMING_REWARD` транзакции
  3. Проверить соответствие текущему балансу
  4. Создать корректирующие транзакции при необходимости
  - ✅ Создан phase3-recalculate-farming-balances.ts
  - ✅ User 74: депозиты 6,293,682 UNI, награды 740,942 UNI
  - ✅ Обнаружены аномальные транзакции >5000 UNI

#### 3.3 Очистка накоплений
- [x] Сбросить `uni_farming_last_update` для всех активных фармеров
- [x] Запустить планировщик с чистого листа
  - ✅ Создан phase3-reset-farming-timestamps.ts
  - ✅ Сброшены timestamps для 36 активных фармеров
  - ✅ Новый timestamp: 2025-07-14T13:52:30.530Z

### ФАЗА 4: АРХИТЕКТУРНЫЙ РЕФАКТОРИНГ (5-7 дней)
**Цель:** Предотвратить повторение проблемы

#### 4.1 Новая архитектура
```
┌─────────────────┐
│  Scheduler      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌──────────────┐
│ UnifiedFarming  │────▶│ AuditLogger  │
│ Calculator      │     └──────────────┘
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌──────────────┐
│ TransactionSvc  │────▶│  Database    │
└─────────────────┘     └──────────────┘
```

#### 4.2 Защитные механизмы
- [ ] **Idempotency keys**: предотвращение дублирования транзакций
- [ ] **Rate limiting**: максимум 1 начисление за 5 минут на пользователя
- [ ] **Validation layer**: проверка всех расчетов перед записью
- [ ] **Audit trail**: полное логирование всех операций

#### 4.3 Мониторинг
- [ ] Dashboard с метриками:
  - Количество начислений в минуту
  - Средняя/максимальная сумма транзакции
  - Пользователи с аномалиями
- [ ] Алерты:
  - Транзакция > 1000 UNI
  - Более 2 начислений за 5 минут одному пользователю
  - Начисление при deposit_amount = 0

### ФАЗА 5: ТЕСТИРОВАНИЕ (2-3 дня)
**Цель:** Убедиться в корректности работы

#### 5.1 Unit тесты
- [ ] Тест расчета от депозита (правильный случай)
- [ ] Тест с null депозитом (должен пропускаться)
- [ ] Тест накопленных периодов

#### 5.2 Integration тесты
- [ ] Симуляция 48 часов работы планировщика
- [ ] Проверка отсутствия дубликатов
- [ ] Валидация сумм начислений

#### 5.3 Regression тесты
- [ ] Проверка всех существующих пользователей
- [ ] Сравнение с историческими данными

## 📊 МЕТРИКИ УСПЕХА

1. **100% транзакций** рассчитаны от `deposit_amount`
2. **0 пользователей** с `uni_deposit_amount = NULL` и активным фармингом
3. **0 транзакций** > ожидаемого дневного дохода (deposit * 0.01)
4. **Снижение на 95%** количества обращений в поддержку по farming

## ⏱️ TIMELINE

| Фаза | Длительность | Команда |
|------|--------------|---------|
| Диагностика | 1-2 дня | Backend + DevOps |
| Изоляция | 2-3 дня | Backend |
| Исправление данных | 3-4 дня | Backend + DBA |
| Рефакторинг | 5-7 дней | Backend + Архитектор |
| Тестирование | 2-3 дня | QA + Backend |
| **ИТОГО** | **13-19 дней** | |

## 🚨 РИСКИ И МИТИГАЦИЯ

### Риск 1: Потеря данных при миграции
**Митигация:** 
- Полный backup перед началом
- Работа на копии БД
- Поэтапный rollout

### Риск 2: Недовольство пользователей
**Митигация:**
- Прозрачная коммуникация о исправлениях
- Компенсация за неправильные начисления
- Горячая линия поддержки

### Риск 3: Новые баги при рефакторинге
**Митигация:**
- Feature flags для постепенного включения
- A/B тестирование на 5% пользователей
- Быстрый rollback механизм

## 📝 ЧЕКЛИСТ ГОТОВНОСТИ К PRODUCTION

- [ ] Все тесты проходят (unit, integration, regression)
- [ ] Метрики в норме на staging окружении
- [ ] Документация обновлена
- [ ] Runbook для поддержки подготовлен
- [ ] План отката утвержден
- [ ] Мониторинг и алерты настроены

## 🎯 ОПРЕДЕЛЕНИЕ УСПЕХА

Система считается исправленной когда:
1. За 7 дней работы не зафиксировано ни одной аномальной транзакции
2. Все активные фармеры получают доход строго от депозита
3. Код прошел security audit
4. Архитектура задокументирована и понятна новым разработчикам

---

**Ответственный:** Lead Backend Developer  
**Утверждающий:** CTO  
**Дата начала:** По согласованию  
**Дата окончания:** Начало + 19 дней

*Документ подготовлен на основе технического исследования и архитектурного анализа системы UniFarming.*