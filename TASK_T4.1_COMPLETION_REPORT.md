# –ó–ê–î–ê–ß–ê T4.1 –í–´–ü–û–õ–ù–ï–ù–ê: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è

## ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û: –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è 20-—É—Ä–æ–≤–Ω–µ–≤–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

### üìå –§–∞–π–ª —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: `modules/referral/logic/rewardDistribution.ts`

#### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–µ—Ç–æ–¥–µ `distributeFarmingRewards()`:

1. **–û–±–µ—Ä—Ç–∫–∞ db.transaction()**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ 20 —É—Ä–æ–≤–Ω—è–º –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
2. **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å**: –õ–∏–±–æ –≤—Å–µ —É—Ä–æ–≤–Ω–∏ –ø–æ–ª—É—á–∞—é—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è, –ª–∏–±–æ –Ω–∏ –æ–¥–∏–Ω
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç**: –ü—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ –≤—Å—è –æ–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è
4. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `transactional: true` –≤–æ –≤—Å–µ –ª–æ–≥–∏

### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:

```typescript
// ‚≠ê –¢–†–ê–ù–ó–ê–ö–¶–ò–û–ù–ù–û–ï –ù–ê–ß–ò–°–õ–ï–ù–ò–ï –í–°–ï–• –†–ï–§–ï–†–ê–õ–¨–ù–´–• –í–û–ó–ù–ê–ì–†–ê–ñ–î–ï–ù–ò–ô
const success = await db.transaction(async (tx) => {
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–º–∏—Å—Å–∏–∏ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  for (const commission of commissions) {
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –≤ —Ä–∞–º–∫–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    const [referrer] = await tx.select()...
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –≤ —Ä–∞–º–∫–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    await tx.update(users)...
    
    // –ó–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ —Ä–∞–º–∫–∞—Ö –æ–±—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    await tx.insert(transactions)...
  }
  
  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ commit
  return true;
});
```

### üìä –ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã:

#### –î–û (–±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π):
- –ö–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
- –†–∏—Å–∫ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –í–æ–∑–º–æ–∂–Ω–∞—è –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

#### –ü–û–°–õ–ï (—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏):
- –í—Å–µ 20 —É—Ä–æ–≤–Ω–µ–π –≤ –æ–¥–Ω–æ–π –∞—Ç–æ–º–∞—Ä–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ü–æ–ª–Ω—ã–π –æ—Ç–∫–∞—Ç –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

### üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:

**–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç**: `test-transactional-referrals.js`
- –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –≤—Å–µ—Ö 20 —É—Ä–æ–≤–Ω–µ–π
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:

–í—Å–µ –ª–æ–≥–∏ —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∞—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:
```json
{
  "transactional": true,
  "totalCommissions": 15,
  "totalLevels": 20,
  "timestamp": "2025-06-11T..."
}
```

### üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç:

**–í–°–ï —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø–æ 20 —É—Ä–æ–≤–Ω—è–º —Ç–µ–ø–µ—Ä—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã**:
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö  
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π

### üí° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

1. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ù–µ–≤–æ–∑–º–æ–∂–Ω—ã —á–∞—Å—Ç–∏—á–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
2. **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –î–∞–Ω–Ω—ã–µ –≤—Å–µ–≥–¥–∞ –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
3. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º–æ—Å—Ç—å**: –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –û–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–º–µ—Å—Ç–æ 20+ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### ‚ö†Ô∏è –ß—Ç–æ –ù–ï –∏–∑–º–µ–Ω–µ–Ω–æ (–∫–∞–∫ —Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å):

- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –æ—Å—Ç–∞–ª–∞—Å—å –ø—Ä–µ–∂–Ω–µ–π
- –ú–∏—Å—Å–∏–∏, –±—É—Å—Ç—ã, farming –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π API –æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

## üöÄ –°–¢–ê–¢–£–°: –ì–û–¢–û–í–û –ö –ü–†–û–ò–ó–í–û–î–°–¢–í–£

–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –¥–ª—è production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å—é –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –≤—Å–µ–º 20 —É—Ä–æ–≤–Ω—è–º.