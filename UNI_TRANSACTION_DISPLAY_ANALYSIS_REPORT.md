# üìä –û–¢–ß–ï–¢: –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´ –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø UNI –¢–†–ê–ù–ó–ê–ö–¶–ò–ô

## –î–∞—Ç–∞: 06.08.2025
## –°—Ç–∞—Ç—É—Å: –ü–†–û–ë–õ–ï–ú–ê –ò–î–ï–ù–¢–ò–§–ò–¶–ò–†–û–í–ê–ù–ê

---

## üîç **–ö–†–ê–¢–ö–û–ï –†–ï–ó–Æ–ú–ï**

### **–ü—Ä–æ–±–ª–µ–º–∞:**
–í —Ä–∞–∑–¥–µ–ª–µ "–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π" –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∏–ª—å—Ç—Ä–∞ **"UNI"** –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ "–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π", —Ö–æ—Ç—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

### **–ü—Ä–∏—á–∏–Ω–∞:**
‚ùå **–ü–†–û–ë–õ–ï–ú–ê –ù–ê FRONTEND** - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Å backend, –Ω–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ UI.

---

## ‚úÖ **–ß–¢–û –†–ê–ë–û–¢–ê–ï–¢ –ü–†–ê–í–ò–õ–¨–ù–û**

### **1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** ‚úÖ
- **16,851 UNI —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 184
- –í—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
  - `currency = 'UNI'`
  - `amount_uni` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  - `amount` = `amount_uni` (–±–µ–∑ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π)

### **2. Backend —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è** ‚úÖ
- –§–∏–ª—å—Ç—Ä `currency.eq.UNI,amount_uni.gt.0` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç **16,851 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é** (100% —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–∞–π–¥–µ–Ω—ã)
- API endpoint `/api/v2/transactions` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

### **3. Backend —Å–µ—Ä–≤–∏—Å—ã** ‚úÖ
- `TransactionsController` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
- `TransactionsService` –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –Ω–∞ `UnifiedTransactionService`
- `UnifiedTransactionService.getUserTransactions()` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ

---

## ‚ùå **–ì–î–ï –ü–†–û–ë–õ–ï–ú–ê**

### **Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `TransactionHistory.tsx`**

#### **–°–∏–º–ø—Ç–æ–º—ã:**
1. –ü—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–µ "UNI" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"
2. –ü—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–µ "TON" —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
3. –ü—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–µ "–í—Å–µ" —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–∏–¥–Ω—ã

#### **–¢–æ—á–∫–∞ —Å–±–æ—è:**
```typescript
// client/src/components/wallet/TransactionHistory.tsx
console.log('[TransactionHistory] –ü–æ–ª—É—á–µ–Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:', result.transactions.length);
// –ó–¥–µ—Å—å result.transactions.length = 0 –¥–ª—è UNI, —Ö–æ—Ç—è backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
```

#### **–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. **–ü—Ä–æ–±–ª–µ–º–∞ —Å JWT —Ç–æ–∫–µ–Ω–æ–º –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ UNI —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**
   - –ò–∑ –ª–æ–≥–æ–≤ –≤–∏–¥–Ω–æ: `[correctApiRequest] ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: API –∑–∞–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç JWT —Ç–æ–∫–µ–Ω`
   - –ó–∞–ø—Ä–æ—Å –Ω–∞ `/api/v2/transactions?currency=UNI` –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞

2. **Race condition –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ**
   - –¢–æ–∫–µ–Ω –º–æ–∂–µ—Ç —Ç–µ—Ä—è—Ç—å—Å—è –º–µ–∂–¥—É —Ä–µ–Ω–¥–µ—Ä–∞–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
   - –ü—Ä–∏ —Å–º–µ–Ω–µ —Ñ–∏–ª—å—Ç—Ä–∞ —Ç–æ–∫–µ–Ω –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è

3. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º**
   - `CacheService` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è UNI
   - –ö–µ—à –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ

---

## üìà **–î–ï–¢–ê–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê**

### **–î–∞–Ω–Ω—ã–µ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ –ë–î:**

```
–í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –ë–î: 1,084,220
‚îú‚îÄ‚îÄ –° –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º currency: 1,084,194 (99.9%)
‚îú‚îÄ‚îÄ –° amount_uni > 0: 768,149
‚îú‚îÄ‚îÄ –° amount_ton > 0: 315,984
‚îî‚îÄ‚îÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 184:
    ‚îú‚îÄ‚îÄ –í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: 36,786
    ‚îú‚îÄ‚îÄ UNI —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: 16,851
    ‚îî‚îÄ‚îÄ TON —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: 19,935
```

### **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:**

| –§–∏–ª—å—Ç—Ä | –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ë–î | –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ UI |
|--------|----------------|-------------------|
| `currency='UNI'` | 16,851 | 0 ‚ùå |
| `currency='TON'` | 19,935 | 19,935 ‚úÖ |
| `currency.eq.UNI,amount_uni.gt.0` | 16,851 | 0 ‚ùå |

### **–ü—Ä–∏–º–µ—Ä—ã UNI —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –ë–î:**
```
ID: 1970220, amount: 0.121528, amount_uni: 0.121528, type: REFERRAL_REWARD
ID: 1969851, amount: 9.899306, amount_uni: 9.899306, type: FARMING_REWARD
ID: 1969821, amount: 0.069444, amount_uni: 0.069444, type: REFERRAL_REWARD
```

---

## üîß **–ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê**

### **JWT Token Loss –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ UNI —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**

–ò–∑ –ª–æ–≥–æ–≤ –±—Ä–∞—É–∑–µ—Ä–∞ –≤–∏–¥–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
```
1. [TransactionHistory] –ó–∞–ø—Ä–æ—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —á–µ—Ä–µ–∑ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å
2. [CacheService] –ü—Ä–æ–º–∞—Ö –∫–µ—à–∞: transactions-v2:184:1:20:UNI
3. [correctApiRequest] ‚ùå JWT —Ç–æ–∫–µ–Ω —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö API –∑–∞–ø—Ä–æ—Å–æ–≤
4. [TransactionHistory] –ü–æ–ª—É—á–µ–Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: 0
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ —Ñ–∏–ª—å—Ç—Ä "UNI" –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
2. –ö–µ—à –ø—É—Å—Ç–æ–π, –Ω—É–∂–µ–Ω –∑–∞–ø—Ä–æ—Å –∫ API
3. JWT —Ç–æ–∫–µ–Ω –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π
4. API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 –æ—à–∏–±–∫—É
5. Frontend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"

**–ü–æ—á–µ–º—É —Ç–æ–ª—å–∫–æ UNI:**
- –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è "–í—Å–µ" —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—Ä–∞–±–æ—Ç–∞–µ—Ç)
- –ó–∞—Ç–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ "TON" (—Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–∞–∫ –∫–∞–∫ —Ç–æ–∫–µ–Ω —É–∂–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
- –ù–æ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ "UNI" —Ç–æ–∫–µ–Ω –º–æ–∂–µ—Ç —Å–Ω–æ–≤–∞ –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è –∏–∑-–∑–∞ race condition

---

## üìù **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

### **–ò—Ç–æ–≥–æ–≤—ã–π –¥–∏–∞–≥–Ω–æ–∑:**
1. ‚úÖ **Backend —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è
2. ‚úÖ **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–æ—Ä—è–¥–∫–µ** - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –º–µ—Å—Ç–µ
3. ‚ùå **Frontend —Ç–µ—Ä—è–µ—Ç JWT —Ç–æ–∫–µ–Ω** –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ UNI —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
4. ‚ùå **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É** - –≤–º–µ—Å—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"

### **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞–ª–∏—á–∏—è JWT —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
2. –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É 401 –æ—à–∏–±–æ–∫ –≤ `fetchTransactionsV2`
3. –î–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞
4. –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤–º–µ—Å—Ç–æ "–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"

---

**–ê–≤—Ç–æ—Ä:** Replit Agent  
**–î–∞—Ç–∞:** 06.08.2025  
**–°—Ç–∞—Ç—É—Å:** –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω, –ø—Ä–æ–±–ª–µ–º–∞ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ frontend