# üîç –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π —É–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞—É–¥–∏—Ç —Ü–µ–ø–æ—á–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ UNI

**–î–∞—Ç–∞:** 10 —è–Ω–≤–∞—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ò–ß–ò–ù–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∞—É–¥–∏—Ç–∞

### 1. ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏—á–∏–Ω—ã

**–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –≤ BalanceManager –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏—Å–∫–ª—é—á–∏–ª–∞ –≤—ã–∑–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**

#### –í BalanceManager (—Å—Ç—Ä–æ–∫–∏ 150-160):
```typescript
logger.info('[BalanceManager] –ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω:', {...});
return { success: true, newBalance };
// ‚ùå –ù–ï–¢ –≤—ã–∑–æ–≤–∞ BalanceNotificationService.notifyBalanceUpdate()
```

#### –í –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ —Ñ–∞—Ä–º–∏–Ω–≥–∞ (—Å—Ç—Ä–æ–∫–∏ 120-130):
```typescript
// ‚úÖ –ï–°–¢–¨ –≤—ã–∑–æ–≤ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:
const balanceService = BalanceNotificationService.getInstance();
balanceService.notifyBalanceUpdate({
  userId: farmer.id,
  balanceUni: parseFloat(farmer.balance_uni || '0') + parseFloat(income),
  // ...
});
```

### 2. üîé –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–ú–æ–¥—É–ª–∏, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ BalanceManager:**

| –ú–æ–¥—É–ª—å | –ú–µ—Ç–æ–¥ | –§–∞–π–ª | –û–∂–∏–¥–∞–µ—Ç WebSocket? |
|--------|-------|------|-------------------|
| **FarmingService** | `subtractBalance()` | `modules/farming/service.ts:230` | ‚úÖ –î–∞ |
| **TransactionService** | `updateUserBalance()` | `core/TransactionService.ts` | ‚úÖ –î–∞ |

**–ú–æ–¥—É–ª–∏, –ù–ï –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ BalanceManager (—Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞–ø—Ä—è–º—É—é):**
- ‚úÖ `core/scheduler/farmingScheduler.ts` - –æ–±–Ω–æ–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ SQL + –≤—ã–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ `modules/scheduler/tonBoostIncomeScheduler.ts` - –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ

### 3. üîå –ü–æ–¥–ø–∏—Å–∫–∞ –∏ —Å–ª—É—à–∞—Ç–µ–ª–∏ WebSocket

**Frontend –ø–æ–¥–ø–∏—Å–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:**

#### –í BalanceCard.tsx (—Å—Ç—Ä–æ–∫–∏ 78-81):
```typescript
useEffect(() => {
  if (connectionStatus === 'connected' && userId) {
    subscribeToUserUpdates(userId);
  }
}, [connectionStatus, userId]);
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π (—Å—Ç—Ä–æ–∫–∏ 84-110):
```typescript
useEffect(() => {
  if (lastMessage && lastMessage.type === 'balance_update') {
    // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç UI –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è
    refreshBalance();
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—é
  }
}, [lastMessage, userId]);
```

**WebSocket –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ server/index.ts:**
- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ BalanceNotificationService
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ü–µ—Ä–µ–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Å–µ—Ä–≤–∏—Å–∞ –∫ –∫–ª–∏–µ–Ω—Ç–∞–º

### 4. üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç-–¥–µ–π—Å—Ç–≤–∏–π

**–ü—Ä–∏ –¥–µ–ø–æ–∑–∏—Ç–µ UNI farming (—á–µ—Ä–µ–∑ BalanceManager):**
- ‚úÖ –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –ë–î Supabase
- ‚ùå WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
- ‚ùå UI –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏

**–ü—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –¥–æ—Ö–æ–¥–∞ (—á–µ—Ä–µ–∑ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫):**
- ‚úÖ –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –ë–î
- ‚úÖ WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
- ‚úÖ UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## üéØ –§–∏–Ω–∞–ª—å–Ω—ã–µ –≤—ã–≤–æ–¥—ã

### 1. ‚úÖ –ü—Ä–∏—á–∏–Ω–∞ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞:
**BalanceManager –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç BalanceNotificationService** –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞.

### 2. üîÅ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ —Ä–∏—Å–∫–∞:

| –û–ø–µ—Ä–∞—Ü–∏—è | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç BalanceManager? | –†–∏—Å–∫ —Ä–µ–≥—Ä–µ—Å—Å–∞ |
|----------|---------------------------|---------------|
| UNI farming –¥–µ–ø–æ–∑–∏—Ç | ‚úÖ –î–∞ | ‚ùå –£–∂–µ —Å–ª–æ–º–∞–Ω–æ |
| TON boost –ø–æ–∫—É–ø–∫–∞ | ‚ùì –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ | ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–æ |
| –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ | ‚ùì –ß–µ—Ä–µ–∑ TransactionService | ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–æ |
| –ú–∏—Å—Å–∏–∏ –Ω–∞–≥—Ä–∞–¥—ã | ‚ùì –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ | ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–æ |
| Daily bonus | ‚ùì –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ | ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–æ |

### 3. üìÅ –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ —Ü–µ–ø–æ—á–∫–µ:

**Backend:**
- `core/BalanceManager.ts` - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞–º–∏ (‚ùå –Ω–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
- `core/balanceNotificationService.ts` - —Å–µ—Ä–≤–∏—Å WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `modules/farming/service.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç BalanceManager –¥–ª—è –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- `core/scheduler/farmingScheduler.ts` - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç BalanceManager (‚úÖ —Ä–∞–±–æ—Ç–∞–µ—Ç)
- `server/index.ts` - WebSocket —Å–µ—Ä–≤–µ—Ä –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

**Frontend:**
- `client/src/components/wallet/BalanceCard.tsx` - —Å–ª—É—à–∞–µ—Ç WebSocket —Å–æ–±—ã—Ç–∏—è
- `client/src/contexts/userContext.tsx` - —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –±–∞–ª–∞–Ω—Å–∞
- `client/src/contexts/webSocketContext.tsx` - WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

### 4. ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é:

#### –í–∞—Ä–∏–∞–Ω—Ç 1 (–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ):
–î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ BalanceNotificationService –≤ –º–µ—Ç–æ–¥ `updateUserBalance` –∫–ª–∞—Å—Å–∞ BalanceManager –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 160:

```typescript
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:
if (result.success) {
  const balanceService = BalanceNotificationService.getInstance();
  balanceService.notifyBalanceUpdate({
    userId: user_id,
    balanceUni: newBalance.balance_uni,
    balanceTon: newBalance.balance_ton,
    changeAmount: operation === 'add' ? amount_uni : -amount_uni,
    currency: amount_uni > 0 ? 'UNI' : 'TON',
    source: source || 'manual',
    timestamp: new Date().toISOString()
  });
}
```

#### –í–∞—Ä–∏–∞–Ω—Ç 2 (–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ):
–í–Ω–µ–¥—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É —Å–æ–±—ã—Ç–∏–π (Event Emitter) –≤ BalanceManager –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –±–∞–ª–∞–Ω—Å–∞.

## üìã –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã:** 85%  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:** –í—ã—Å–æ–∫–∞—è  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** –ù–∏–∑–∫–∞—è  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** 15-30 –º–∏–Ω—É—Ç  
**–†–∏—Å–∫ –Ω–æ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π

–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–∞, —Ä–µ—à–µ–Ω–∏–µ –æ—á–µ–≤–∏–¥–Ω–æ, —Ä–∏—Å–∫–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã.