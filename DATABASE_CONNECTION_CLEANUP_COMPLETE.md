# –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–ï: –ú–∞—Ä—à—Ä—É—Ç –ó–∞–ø–∏—Å–∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
**–î–∞—Ç–∞:** 14 –∏—é–Ω—è 2025  
**–°—Ç–∞—Ç—É—Å:** –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û - –°–ò–°–¢–ï–ú–ê –†–ê–ë–û–¢–ê–ï–¢ –ü–†–ê–í–ò–õ–¨–ù–û ‚úÖ

## –†–ï–ó–£–õ–¨–¢–ê–¢–´ –†–ê–°–°–õ–ï–î–û–í–ê–ù–ò–Ø

### 1. –ê–Ω–∞–ª–∏–∑ –°—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö
```sql
SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';
```
**–†–ï–ó–£–õ–¨–¢–ê–¢:** –°—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–∞–±–ª–∏—Ü–∞ `users` (–ù–ï `user`)

### 2. –ü–æ–∏—Å–∫ –í—Å–µ—Ö –¢–∞–±–ª–∏—Ü —Å "user"
```sql
SELECT table_name, table_schema FROM information_schema.tables WHERE table_name ILIKE '%user%';
```
**–ù–ê–ô–î–ï–ù–û –í –°–•–ï–ú–ï PUBLIC:**
- `users` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–°–ò–°–¢–ï–ú–ù–´–ï –¢–ê–ë–õ–ò–¶–´ (PostgreSQL):**
- `pg_user`, `pg_user_mapping` –∏ –¥—Ä. –≤ —Å—Ö–µ–º–µ `pg_catalog`

### 3. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è ORM-—Å—Ö–µ–º—ã
**–§–∞–π–ª:** `shared/schema.ts`
```typescript
export const users = pgTable("users", {
  id: serial("id").primaryKey(),
  telegram_id: bigint("telegram_id", { mode: "number" }).unique(),
  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
});
```

**–í–´–í–û–î:** ORM –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ —Ç–∞–±–ª–∏—Ü—É `"users"`

### 4. –ò–º–ø–æ—Ä—Ç—ã –≤ UserRepository
**–§–∞–π–ª:** `modules/users/repository.ts`
```typescript
import { users, type InsertUser, type User } from '../../shared/schema';
```
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
await db.insert(users).values(userData).returning();
```

**–í–´–í–û–î:** –ò–º–ø–æ—Ä—Ç –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

## –ü–û–õ–ù–´–ô –ü–£–¢–¨ –ó–ê–ü–ò–°–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô

### –ú–∞—Ä—à—Ä—É—Ç –î–∞–Ω–Ω—ã—Ö
1. **API Endpoint:** `/api/v2/register/telegram`
2. **Controller:** `AuthController.registerTelegram()`
3. **Service:** `AuthService.registerDirectFromTelegramUser()`
4. **User Service:** `UserService.findOrCreateFromTelegram()`
5. **Repository:** `UserRepository.createUserFromTelegram()`
6. **ORM Query:** `db.insert(users).values(userData).returning()`
7. **SQL:** `INSERT INTO users (...) VALUES (...)`
8. **Database:** PostgreSQL —Ç–∞–±–ª–∏—Ü–∞ `public.users`

### SQL-–∑–∞–ø—Ä–æ—Å CREATE TABLE (—Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ 63 –ø–æ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ `users`:

```sql
CREATE TABLE public.users (
  id integer NOT NULL DEFAULT nextval('users_id_seq'::regclass),
  telegram_id bigint NOT NULL UNIQUE,
  username character varying(255),
  first_name character varying(255),
  ref_code character varying(12) NOT NULL UNIQUE,
  parent_ref_code character varying(12),
  balance_uni numeric DEFAULT 0,
  balance_ton numeric DEFAULT 0,
  created_at timestamp DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp DEFAULT CURRENT_TIMESTAMP,
  -- ... –∏ –µ—â–µ 53 –ø–æ–ª—è
  PRIMARY KEY (id)
);
```

## –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–ü–ò–°–ò

### –¢–µ—Å—Ç 1: SQL –ü—Ä—è–º–∞—è –ó–∞–ø–∏—Å—å
```sql
INSERT INTO users (telegram_id, username, first_name, ref_code, created_at, updated_at) 
VALUES (777777777, 'orm_verification_user', 'ORM Test', 'ORMTEST1', NOW(), NOW());
```
**–†–ï–ó–£–õ–¨–¢–ê–¢:** ‚úÖ –£—Å–ø–µ—à–Ω–æ - ID: 9, –∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞

### –¢–µ—Å—Ç 2: –ü–æ–¥—Å—á–µ—Ç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```sql
SELECT COUNT(*) FROM users;
```
**–†–ï–ó–£–õ–¨–¢–ê–¢:** 9 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤–∫–ª—é—á–∞—è —Ç–µ—Å—Ç–æ–≤—ã—Ö)

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ORM –≤ UserRepository
–ö–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É:
```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ INSERT
const countBefore = await db.execute(sql`SELECT COUNT(*) FROM users`);

// –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ INSERT
const [newUser] = await db.insert(users).values(userData).returning();

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ INSERT
const countAfter = await db.execute(sql`SELECT COUNT(*) FROM users`);

// –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const verification = await db.execute(sql`SELECT id, telegram_id, ref_code FROM users WHERE id = ${newUser.id}`);
```

## –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó

### ‚ùå –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –ù–ï –ù–ê–ô–î–ï–ù–û
–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ "–≤ –±–∞–∑–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü–∞ public.user" - **–ù–ï–í–ï–†–ù–û**

**–§–ê–ö–¢–´:**
1. ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–∞–±–ª–∏—Ü–∞ `public.users` (–ù–ï `public.user`)
2. ‚úÖ ORM —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É `"users"`
3. ‚úÖ –ò–º–ø–æ—Ä—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã: `import { users } from '../../shared/schema'`
4. ‚úÖ SQL-–∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
5. ‚úÖ –ó–∞–ø–∏—Å–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –≤–∏–¥–Ω—ã –≤ –±–∞–∑–µ

### ‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û –ö–û–†–†–ï–ö–¢–ù–û–ô –†–ê–ë–û–¢–û–ô
1. **–¢–∞–±–ª–∏—Ü–∞:** `public.users` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
2. **ORM-–º–∞–ø–ø–∏–Ω–≥:** Drizzle –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–≤—è–∑–∞–Ω —Å —Ç–∞–±–ª–∏—Ü–µ–π
3. **–ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
4. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** 63 –ø–æ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å—Ö–µ–º–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò

### –†–µ–∞–ª—å–Ω–∞—è –ü—Ä–æ–±–ª–µ–º–∞
–û—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:
```
[QueryClient] –û—à–∏–±–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å: HTTP 401: Unauthorized
[QueryClient] –û—à–∏–±–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å: HTTP 404: Not Found
```

**–≠–¢–û –ù–ï –ü–†–û–ë–õ–ï–ú–ê –ó–ê–ü–ò–°–ò –í –ë–î**, –∞ –ø—Ä–æ–±–ª–µ–º–∞:
1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏—è –≤–∞–ª–∏–¥–Ω–æ–≥–æ JWT —Ç–æ–∫–µ–Ω–∞ –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö
2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Telegram Mini App
3. –ü—Ä–æ–±–ª–µ–º —Å initData –æ—Ç Telegram

### –î–∞–Ω–Ω—ã–µ –≤ –ë–∞–∑–µ
```sql
SELECT id, telegram_id, username, ref_code FROM users ORDER BY id DESC LIMIT 5;
```
**–†–ï–ó–£–õ–¨–¢–ê–¢:**
```
ID | Telegram ID | Username              | Ref Code
---|-------------|----------------------|----------
9  | 777777777   | orm_verification_user | ORMTEST1
8  | 888888888   | investigation_user    | INVEST01
7  | 999999999   | final_test_user       | FINTEST1
6  | 999000003   | manual_test_3         | MNLTEST3
5  | 999000002   | manual_test_2         | MNLTEST2
```

## –ò–¢–û–ì–û–í–´–ï –í–´–í–û–î–´

### ‚úÖ –ë–ê–ó–ê –î–ê–ù–ù–´–• –†–ê–ë–û–¢–ê–ï–¢ –ü–†–ê–í–ò–õ–¨–ù–û
- –¢–∞–±–ª–∏—Ü–∞ `public.users` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
- ORM –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–≤—è–∑–∞–Ω —Å —Ç–∞–±–ª–∏—Ü–µ–π
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- –í—Å–µ 9 —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–∏–¥–Ω—ã –≤ –±–∞–∑–µ

### ‚ùå –û–®–ò–ë–û–ß–ù–û–ï –ü–†–ï–î–ü–û–õ–û–ñ–ï–ù–ò–ï
–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ `public.users` –Ω–µ–≤–µ—Ä–Ω–æ. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –∑–∞–¥—É–º–∞–Ω–æ.

### üîç –†–ï–ê–õ–¨–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê
–ü—Ä–æ–±–ª–µ–º–∞ –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (401/404 –æ—à–∏–±–∫–∏), –∞ –Ω–µ –≤ –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

---
**–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:** –ú–∞—Ä—à—Ä—É—Ç –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –¢–∞–±–ª–∏—Ü–∞ `public.users` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, ORM –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è. –ü—Ä–æ–±–ª–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ Telegram Mini App –∏ JWT —Ç–æ–∫–µ–Ω–æ–≤.