<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON Connect - –î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        button {
            background: #0088cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0066aa; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        pre {
            background: #1a1a1a;
            padding: 10px;
            overflow-x: auto;
            border-radius: 5px;
        }
        #logs {
            background: #0a0a0a;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîç TON Connect - –î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞</h1>
    
    <div class="section">
        <h2>1. –ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞</h2>
        <button onclick="testManifest()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∞–Ω–∏—Ñ–µ—Å—Ç</button>
        <div id="manifestResult"></div>
    </div>
    
    <div class="section">
        <h2>2. –¢–µ—Å—Ç React –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</h2>
        <button onclick="testReactConfig()">–¢–µ—Å—Ç —Å window.location.origin</button>
        <button onclick="testAbsoluteUrl()">–¢–µ—Å—Ç —Å –ø–æ–ª–Ω—ã–º URL</button>
        <button onclick="testRelativeUrl()">–¢–µ—Å—Ç —Å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º URL</button>
    </div>
    
    <div class="section">
        <h2>3. –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç SDK</h2>
        <button onclick="testDirectSDK()">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å SDK –Ω–∞–ø—Ä—è–º—É—é</button>
        <button onclick="testOpenModal()">–û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ</button>
    </div>
    
    <div class="section">
        <h2>4. –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage</h2>
        <button onclick="checkLocalStorage()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage</button>
        <button onclick="clearTonConnectData()">–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ TON Connect</button>
    </div>
    
    <div class="section">
        <h2>üìú –õ–æ–≥–∏</h2>
        <div id="logs"></div>
    </div>

    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script>
        let tonConnectUI = null;
        const logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().substring(11, 19);
            const logEntry = { timestamp, message, type };
            logs.push(logEntry);
            updateLogs();
            console.log(`[TON Debug] ${message}`);
        }
        
        function updateLogs() {
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML = logs.map(l => 
                `<div class="${l.type}">[${l.timestamp}] ${l.message}</div>`
            ).join('');
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        async function testManifest() {
            log('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç...', 'info');
            const manifestUrl = window.location.origin + '/tonconnect-manifest.json';
            
            try {
                log(`–ó–∞–≥—Ä—É–∂–∞–µ–º: ${manifestUrl}`, 'info');
                const response = await fetch(manifestUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log('‚úÖ –ú–∞–Ω–∏—Ñ–µ—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                log(`–°–æ–¥–µ—Ä–∂–∏–º–æ–µ: ${JSON.stringify(data, null, 2)}`, 'info');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—è
                if (data.url !== window.location.origin) {
                    log(`‚ö†Ô∏è URL –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ (${data.url}) –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º (${window.location.origin})`, 'warning');
                }
                
                document.getElementById('manifestResult').innerHTML = `
                    <pre class="success">${JSON.stringify(data, null, 2)}</pre>
                `;
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞: ${error.message}`, 'error');
                document.getElementById('manifestResult').innerHTML = `
                    <pre class="error">–û—à–∏–±–∫–∞: ${error.message}</pre>
                `;
            }
        }
        
        async function testReactConfig() {
            log('üß™ –¢–µ—Å—Ç —Å window.location.origin...', 'info');
            const manifestUrl = `${window.location.origin}/tonconnect-manifest.json`;
            await initTonConnect(manifestUrl);
        }
        
        async function testAbsoluteUrl() {
            log('üß™ –¢–µ—Å—Ç —Å –ø–æ–ª–Ω—ã–º URL...', 'info');
            const manifestUrl = 'https://uni-farm-connect-x-ab245275.replit.app/tonconnect-manifest.json';
            await initTonConnect(manifestUrl);
        }
        
        async function testRelativeUrl() {
            log('üß™ –¢–µ—Å—Ç —Å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º URL...', 'info');
            const manifestUrl = '/tonconnect-manifest.json';
            await initTonConnect(manifestUrl);
        }
        
        async function initTonConnect(manifestUrl) {
            try {
                log(`–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º TON Connect —Å manifestUrl: ${manifestUrl}`, 'info');
                
                // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä
                if (tonConnectUI) {
                    log('–£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä...', 'info');
                    tonConnectUI = null;
                }
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
                tonConnectUI = new window.TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: manifestUrl,
                    buttonRootId: null
                });
                
                log('‚úÖ TON Connect UI –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                tonConnectUI.onStatusChange((wallet) => {
                    if (wallet) {
                        log(`‚úÖ –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω: ${wallet.account.address}`, 'success');
                    } else {
                        log('‚ö†Ô∏è –ö–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω', 'warning');
                    }
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
                const isConnected = await tonConnectUI.connectionRestored;
                log(`–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${isConnected ? '–ø–æ–¥–∫–ª—é—á–µ–Ω' : '–Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω'}`, 'info');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        async function testDirectSDK() {
            log('üß™ –¢–µ—Å—Ç –ø—Ä—è–º–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ SDK...', 'info');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å SDK
                if (!window.TON_CONNECT_UI) {
                    throw new Error('SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                }
                
                log('SDK –¥–æ—Å—Ç—É–ø–µ–Ω, –≤–µ—Ä—Å–∏—è: ' + (window.TON_CONNECT_UI.version || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'), 'info');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å —Ç–µ–∫—É—â–∏–º origin
                const manifestUrl = window.location.origin + '/tonconnect-manifest.json';
                await initTonConnect(manifestUrl);
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        async function testOpenModal() {
            if (!tonConnectUI) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ SDK', 'error');
                return;
            }
            
            try {
                log('–û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ...', 'info');
                const result = await tonConnectUI.openModal();
                log('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ', 'info');
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        function checkLocalStorage() {
            log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage...', 'info');
            
            const tonKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('ton') || key.includes('TON'))) {
                    tonKeys.push(key);
                    const value = localStorage.getItem(key);
                    log(`${key}: ${value?.substring(0, 50)}...`, 'info');
                }
            }
            
            if (tonKeys.length === 0) {
                log('TON Connect –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ localStorage', 'warning');
            } else {
                log(`–ù–∞–π–¥–µ–Ω–æ ${tonKeys.length} –∫–ª—é—á–µ–π`, 'success');
            }
        }
        
        function clearTonConnectData() {
            log('üßπ –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ TON Connect...', 'info');
            
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('ton') || key.includes('TON'))) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                log(`–£–¥–∞–ª–µ–Ω: ${key}`, 'info');
            });
            
            log(`‚úÖ –û—á–∏—â–µ–Ω–æ ${keysToRemove.length} –∫–ª—é—á–µ–π`, 'success');
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'info');
            log(`–¢–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω: ${window.location.origin}`, 'info');
            testManifest();
        };
    </script>
</body>
</html>