<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON Connect - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</title>
    <style>
        body {
            font-family: monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .test-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #333;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        button {
            background: #4ade80;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #22c55e; }
        pre {
            background: #0a0a0a;
            padding: 10px;
            overflow-x: auto;
            border-radius: 5px;
        }
        #logs {
            height: 300px;
            overflow-y: auto;
            background: #0a0a0a;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>üîç TON Connect - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h1>
    
    <div class="section">
        <h2>üìç –¢–µ–∫—É—â–µ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ</h2>
        <div id="environment"></div>
    </div>
    
    <div class="section">
        <h2>üß™ –¢–µ—Å—Ç—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏</h2>
        <div id="tests"></div>
    </div>
    
    <div class="section">
        <h2>üîß –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
        <button onclick="testDirectConnect()">–¢–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
        <button onclick="testWithCustomManifest()">–¢–µ—Å—Ç —Å custom manifest URL</button>
        <button onclick="clearCache()">–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à TON Connect</button>
    </div>
    
    <div class="section">
        <h2>üìú –õ–æ–≥–∏</h2>
        <div id="logs"></div>
    </div>

    <script>
        const currentDomain = window.location.origin;
        const logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ message: logEntry, type });
            console.log(`[TON Connect Diagnostics] ${message}`);
            updateLogs();
        }
        
        function updateLogs() {
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML = logs.map(l => 
                `<div class="${l.type}">${l.message}</div>`
            ).join('');
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        async function runAllTests() {
            log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É...', 'info');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
            document.getElementById('environment').innerHTML = `
                <div class="test-row">
                    <span>–¢–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω:</span>
                    <span class="info">${currentDomain}</span>
                </div>
                <div class="test-row">
                    <span>User-Agent:</span>
                    <span class="info">${navigator.userAgent}</span>
                </div>
                <div class="test-row">
                    <span>Telegram WebApp:</span>
                    <span class="${window.Telegram?.WebApp ? 'success' : 'warning'}">${window.Telegram?.WebApp ? '–î–∞' : '–ù–µ—Ç'}</span>
                </div>
            `;
            
            const tests = [
                {
                    name: '–ú–∞–Ω–∏—Ñ–µ—Å—Ç (–æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å)',
                    url: '/tonconnect-manifest.json',
                    check: 'json'
                },
                {
                    name: '–ú–∞–Ω–∏—Ñ–µ—Å—Ç (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π)',
                    url: '/.well-known/tonconnect-manifest.json',
                    check: 'json'
                },
                {
                    name: '–ò–∫–æ–Ω–∫–∞ UniFarm',
                    url: '/assets/unifarm-icon.svg',
                    check: 'status'
                },
                {
                    name: 'CORS –ø–æ–ª–∏—Ç–∏–∫–∞',
                    url: '/tonconnect-manifest.json',
                    check: 'cors'
                },
                {
                    name: '–í–Ω–µ—à–Ω—è—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å',
                    url: `${currentDomain}/tonconnect-manifest.json`,
                    check: 'external'
                }
            ];
            
            const results = [];
            
            for (const test of tests) {
                log(`–¢–µ—Å—Ç–∏—Ä—É–µ–º: ${test.name}...`);
                try {
                    const response = await fetch(test.url, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    
                    let status = 'error';
                    let details = '';
                    
                    if (response.ok) {
                        if (test.check === 'json') {
                            const data = await response.json();
                            if (data.url && data.name) {
                                status = 'success';
                                details = `URL: ${data.url}`;
                                
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–æ–º–µ–Ω–∞
                                if (data.url !== currentDomain) {
                                    status = 'warning';
                                    details += ` (–Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º –¥–æ–º–µ–Ω–æ–º!)`;
                                    log(`‚ö†Ô∏è –í–ê–ñ–ù–û: –î–æ–º–µ–Ω –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ (${data.url}) –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º (${currentDomain})`, 'warning');
                                }
                            }
                        } else if (test.check === 'cors') {
                            const corsHeader = response.headers.get('Access-Control-Allow-Origin');
                            if (corsHeader) {
                                status = 'success';
                                details = `CORS: ${corsHeader}`;
                            } else {
                                status = 'warning';
                                details = 'CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç';
                            }
                        } else {
                            status = 'success';
                            details = `HTTP ${response.status}`;
                        }
                    } else {
                        details = `HTTP ${response.status}`;
                    }
                    
                    results.push({
                        name: test.name,
                        status,
                        details
                    });
                    
                    log(`${test.name}: ${status} - ${details}`, status);
                    
                } catch (error) {
                    results.push({
                        name: test.name,
                        status: 'error',
                        details: error.message
                    });
                    log(`${test.name}: –û–®–ò–ë–ö–ê - ${error.message}`, 'error');
                }
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            document.getElementById('tests').innerHTML = results.map(r => `
                <div class="test-row">
                    <span>${r.name}</span>
                    <span class="${r.status}">${r.details}</span>
                </div>
            `).join('');
            
            log('‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
        }
        
        async function testDirectConnect() {
            log('üîå –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ TON Connect...', 'info');
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º SDK –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                if (!window.TON_CONNECT_UI) {
                    log('–ó–∞–≥—Ä—É–∂–∞–µ–º TON Connect SDK...', 'info');
                    const script = document.createElement('script');
                    script.src = 'https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js';
                    document.head.appendChild(script);
                    
                    await new Promise((resolve) => {
                        script.onload = resolve;
                    });
                }
                
                log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º TON Connect UI...', 'info');
                
                const manifestUrl = `${currentDomain}/tonconnect-manifest.json`;
                log(`–ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç: ${manifestUrl}`, 'info');
                
                const tonConnectUI = new window.TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: manifestUrl,
                    buttonRootId: null
                });
                
                log('TON Connect UI –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                tonConnectUI.onStatusChange((walletInfo) => {
                    if (walletInfo) {
                        log(`‚úÖ –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω: ${JSON.stringify(walletInfo, null, 2)}`, 'success');
                    } else {
                        log('–ö–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω', 'warning');
                    }
                });
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                log('–û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...', 'info');
                const result = await tonConnectUI.openModal();
                log(`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${JSON.stringify(result)}`, 'info');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }
        
        async function testWithCustomManifest() {
            const customUrl = prompt('–í–≤–µ–¥–∏—Ç–µ custom URL –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞:', 'https://raw.githubusercontent.com/ton-connect/demo-dapp-backend/master/tonconnect-manifest.json');
            if (!customUrl) return;
            
            log(`üîß –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å custom –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–º: ${customUrl}`, 'info');
            
            try {
                const tonConnectUI = new window.TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: customUrl,
                    buttonRootId: null
                });
                
                log('Custom –º–∞–Ω–∏—Ñ–µ—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                await tonConnectUI.openModal();
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å custom –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–º: ${error.message}`, 'error');
            }
        }
        
        function clearCache() {
            log('üßπ –û—á–∏—â–∞–µ–º –∫—ç—à TON Connect...', 'info');
            
            // –û—á–∏—â–∞–µ–º localStorage
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('ton') || key.includes('TON'))) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                log(`–£–¥–∞–ª–µ–Ω –∫–ª—é—á: ${key}`, 'info');
            });
            
            log(`‚úÖ –û—á–∏—â–µ–Ω–æ ${keysToRemove.length} –∫–ª—é—á–µ–π –∏–∑ localStorage`, 'success');
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = () => {
            runAllTests();
        };
    </script>
</body>
</html>