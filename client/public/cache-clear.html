<!DOCTYPE html>
<html>
<head>
    <title>UniFarm Cache Clear Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            margin: 0;
            background: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { 
            font-size: 24px; 
            margin: 0 0 20px 0; 
            color: #333; 
            text-align: center;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background: #1976d2; }
        button.danger { background: #f44336; }
        button.danger:hover { background: #d32f2f; }
        button.success { background: #4caf50; }
        button.success:hover { background: #388e3c; }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        .status.info { background: #e3f2fd; color: #1976d2; }
        .status.success { background: #e8f5e9; color: #2e7d32; }
        .status.error { background: #ffebee; color: #c62828; }
        .log {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .divider {
            height: 1px;
            background: #e0e0e0;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ UniFarm Cache Clear Tool</h1>
        
        <div class="section">
            <h3>–ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º?</h3>
            <p>–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –æ—á–∏—Å—Ç–∏—Ç–µ –≤—Å–µ –∫–µ—à–∏:</p>
        </div>

        <button onclick="clearAllCaches()" class="danger">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –í–°–ï –∫–µ—à–∏
        </button>

        <div class="divider"></div>

        <button onclick="clearLocalStorage()">
            üì¶ –û—á–∏—Å—Ç–∏—Ç—å LocalStorage
        </button>

        <button onclick="clearSessionStorage()">
            üîí –û—á–∏—Å—Ç–∏—Ç—å SessionStorage
        </button>

        <button onclick="clearServiceWorker()">
            ‚öôÔ∏è –£–¥–∞–ª–∏—Ç—å Service Workers
        </button>

        <button onclick="hardReload()">
            üîÑ –ñ–µ—Å—Ç–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
        </button>

        <div class="divider"></div>

        <button onclick="checkCurrentData()" class="success">
            üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        </button>

        <div id="status"></div>
        <div id="log" class="log" style="display:none;"></div>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const statusDiv = document.getElementById('status');
            const logDiv = document.getElementById('log');
            
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.innerHTML = message;
            statusDiv.appendChild(status);
            
            logDiv.style.display = 'block';
            logDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}<br>`;
        };

        const clearLocalStorage = () => {
            try {
                const keys = Object.keys(localStorage);
                log(`–ù–∞–π–¥–µ–Ω–æ ${keys.length} –∫–ª—é—á–µ–π –≤ LocalStorage`, 'info');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const jwtToken = localStorage.getItem('unifarm_jwt_token');
                
                localStorage.clear();
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º JWT –µ—Å–ª–∏ –±—ã–ª
                if (jwtToken) {
                    localStorage.setItem('unifarm_jwt_token', jwtToken);
                    log('JWT —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'info');
                }
                
                log('‚úÖ LocalStorage –æ—á–∏—â–µ–Ω', 'success');
            } catch (e) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ LocalStorage: ${e.message}`, 'error');
            }
        };

        const clearSessionStorage = () => {
            try {
                const keys = Object.keys(sessionStorage);
                log(`–ù–∞–π–¥–µ–Ω–æ ${keys.length} –∫–ª—é—á–µ–π –≤ SessionStorage`, 'info');
                sessionStorage.clear();
                log('‚úÖ SessionStorage –æ—á–∏—â–µ–Ω', 'success');
            } catch (e) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ SessionStorage: ${e.message}`, 'error');
            }
        };

        const clearServiceWorker = async () => {
            try {
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    log(`–ù–∞–π–¥–µ–Ω–æ ${registrations.length} Service Workers`, 'info');
                    
                    for (let registration of registrations) {
                        await registration.unregister();
                        log(`–£–¥–∞–ª–µ–Ω SW: ${registration.scope}`, 'info');
                    }
                    
                    log('‚úÖ –í—Å–µ Service Workers —É–¥–∞–ª–µ–Ω—ã', 'success');
                } else {
                    log('Service Workers –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è', 'info');
                }
            } catch (e) {
                log(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è Service Workers: ${e.message}`, 'error');
            }
        };

        const clearBrowserCache = async () => {
            try {
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    log(`–ù–∞–π–¥–µ–Ω–æ ${cacheNames.length} –∫–µ—à–µ–π –±—Ä–∞—É–∑–µ—Ä–∞`, 'info');
                    
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        log(`–£–¥–∞–ª–µ–Ω –∫–µ—à: ${cacheName}`, 'info');
                    }
                    
                    log('‚úÖ –ö–µ—à –±—Ä–∞—É–∑–µ—Ä–∞ –æ—á–∏—â–µ–Ω', 'success');
                } else {
                    log('Cache API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'info');
                }
            } catch (e) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–µ—à–∞ –±—Ä–∞—É–∑–µ—Ä–∞: ${e.message}`, 'error');
            }
        };

        const clearAllCaches = async () => {
            document.getElementById('status').innerHTML = '';
            log('üßπ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É...', 'info');
            
            await clearBrowserCache();
            clearLocalStorage();
            clearSessionStorage();
            await clearServiceWorker();
            
            log('‚úÖ –í—Å–µ –∫–µ—à–∏ –æ—á–∏—â–µ–Ω—ã!', 'success');
            log('–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π', 'info');
        };

        const hardReload = () => {
            log('üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º –∂–µ—Å—Ç–∫—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É...', 'info');
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫–µ—à–∞
            const timestamp = Date.now();
            const currentUrl = window.location.href.split('?')[0];
            const newUrl = `${currentUrl}?nocache=${timestamp}`;
            
            setTimeout(() => {
                window.location.href = newUrl;
                window.location.reload(true);
            }, 1000);
        };

        const checkCurrentData = async () => {
            document.getElementById('status').innerHTML = '';
            log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö...', 'info');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ LocalStorage
            const jwtToken = localStorage.getItem('unifarm_jwt_token');
            if (jwtToken) {
                try {
                    const payload = JSON.parse(atob(jwtToken.split('.')[1]));
                    log(`JWT —Ç–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω: User ID ${payload.userId}`, 'success');
                    log(`Telegram ID: ${payload.telegram_id}`, 'info');
                    log(`–ò—Å—Ç–µ–∫–∞–µ—Ç: ${new Date(payload.exp * 1000).toLocaleString()}`, 'info');
                } catch (e) {
                    log('JWT —Ç–æ–∫–µ–Ω –ø–æ–≤—Ä–µ–∂–¥–µ–Ω', 'error');
                }
            } else {
                log('JWT —Ç–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', 'error');
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π
            log(`–¢–µ–∫—É—â–∏–π URL: ${window.location.hostname}`, 'info');
            log(`–ü—Ä–æ—Ç–æ–∫–æ–ª: ${window.location.protocol}`, 'info');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram
            if (window.Telegram?.WebApp) {
                log('Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
                log(`–í–µ—Ä—Å–∏—è: ${window.Telegram.WebApp.version}`, 'info');
                log(`InitData: ${window.Telegram.WebApp.initData ? '–ï—Å—Ç—å' : '–ù–µ—Ç'}`, 'info');
            } else {
                log('Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ API
            try {
                const response = await fetch('/api/v2/auth/telegram', { method: 'GET' });
                log(`API —Å—Ç–∞—Ç—É—Å: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
            } catch (e) {
                log(`API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${e.message}`, 'error');
            }
        };
    </script>
</body>
</html>