<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ UniFarm</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        .status.warning {
            background: #fff3e0;
            color: #f57c00;
            border: 1px solid #ffcc02;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        .btn-danger:hover {
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
        }
        .progress {
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        .details {
            text-align: left;
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
        }
        .back-link {
            display: inline-block;
            margin-top: 30px;
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ UniFarm</h1>
        
        <div id="status" class="status info">
            –ì–æ—Ç–æ–≤ –∫ –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–∞ –∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        </div>

        <div class="progress" id="progress" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
        </div>

        <div id="details" class="details" style="display: none;"></div>

        <button class="btn btn-danger" onclick="clearAllCache()" id="clearBtn">
            –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫—ç—à
        </button>
        
        <button class="btn" onclick="clearTonConnectOnly()" id="tonBtn">
            –¢–æ–ª—å–∫–æ TON Connect
        </button>

        <button class="btn" onclick="clearUserData()" id="userBtn">
            –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        </button>

        <a href="/" class="back-link" id="backLink" style="display: none;">
            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        </a>
    </div>

    <script>
        let logDetails = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDetails.push(`${timestamp}: ${message}`);
            updateDetails();
            console.log(`[Cache Clear] ${message}`);
        }

        function updateDetails() {
            const detailsEl = document.getElementById('details');
            detailsEl.style.display = 'block';
            detailsEl.innerHTML = logDetails.join('<br>');
            detailsEl.scrollTop = detailsEl.scrollHeight;
        }

        function updateProgress(percent, text) {
            const progressEl = document.getElementById('progress');
            const fillEl = document.getElementById('progressFill');
            const textEl = document.getElementById('progressText');
            
            progressEl.style.display = 'block';
            fillEl.style.width = `${percent}%`;
            textEl.textContent = text;
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.textContent = message;
        }

        function disableButtons() {
            document.getElementById('clearBtn').disabled = true;
            document.getElementById('tonBtn').disabled = true;
            document.getElementById('userBtn').disabled = true;
        }

        function enableButtons() {
            document.getElementById('clearBtn').disabled = false;
            document.getElementById('tonBtn').disabled = false;
            document.getElementById('userBtn').disabled = false;
        }

        function showBackLink() {
            document.getElementById('backLink').style.display = 'inline-block';
        }

        async function clearAllCache() {
            disableButtons();
            logDetails = [];
            updateStatus('–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞...', 'info');
            
            try {
                log('–ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É –∫—ç—à–∞');
                updateProgress(10, '–û—á–∏—â–∞–µ–º localStorage...');

                // 1. –û—á–∏—Å—Ç–∫–∞ localStorage
                const lsKeys = Object.keys(localStorage);
                log(`–ù–∞–π–¥–µ–Ω–æ ${lsKeys.length} –∫–ª—é—á–µ–π –≤ localStorage`);
                lsKeys.forEach(key => {
                    localStorage.removeItem(key);
                    log(`–£–¥–∞–ª–µ–Ω –∫–ª—é—á: ${key}`);
                });
                updateProgress(25, 'localStorage –æ—á–∏—â–µ–Ω');

                // 2. –û—á–∏—Å—Ç–∫–∞ sessionStorage
                updateProgress(35, '–û—á–∏—â–∞–µ–º sessionStorage...');
                const ssKeys = Object.keys(sessionStorage);
                log(`–ù–∞–π–¥–µ–Ω–æ ${ssKeys.length} –∫–ª—é—á–µ–π –≤ sessionStorage`);
                ssKeys.forEach(key => {
                    sessionStorage.removeItem(key);
                    log(`–£–¥–∞–ª–µ–Ω –∫–ª—é—á: ${key}`);
                });
                updateProgress(45, 'sessionStorage –æ—á–∏—â–µ–Ω');

                // 3. –û—á–∏—Å—Ç–∫–∞ IndexedDB
                updateProgress(55, '–û—á–∏—â–∞–µ–º IndexedDB...');
                try {
                    const databases = await indexedDB.databases();
                    for (const db of databases) {
                        if (db.name) {
                            indexedDB.deleteDatabase(db.name);
                            log(`–£–¥–∞–ª–µ–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö IndexedDB: ${db.name}`);
                        }
                    }
                } catch (e) {
                    log(`–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ IndexedDB: ${e.message}`);
                }
                updateProgress(70, 'IndexedDB –æ—á–∏—â–µ–Ω');

                // 4. –û—á–∏—Å—Ç–∫–∞ –∫—É–∫–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–æ–º–µ–Ω–∞
                updateProgress(80, '–û—á–∏—â–∞–µ–º –∫—É–∫–∏...');
                const cookies = document.cookie.split(";");
                cookies.forEach(cookie => {
                    const eqPos = cookie.indexOf("=");
                    const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
                    if (name) {
                        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
                        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=${window.location.hostname}`;
                        log(`–£–¥–∞–ª–µ–Ω cookie: ${name}`);
                    }
                });
                updateProgress(90, '–ö—É–∫–∏ –æ—á–∏—â–µ–Ω—ã');

                // 5. –ü–æ–ø—ã—Ç–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ —á–µ—Ä–µ–∑ Service Worker
                updateProgress(95, '–û—á–∏—â–∞–µ–º Service Worker –∫—ç—à...');
                if ('serviceWorker' in navigator) {
                    try {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (const registration of registrations) {
                            await registration.unregister();
                            log('Service Worker –æ—Ç–∫–ª—é—á–µ–Ω');
                        }
                    } catch (e) {
                        log(`Service Worker: ${e.message}`);
                    }
                }

                if ('caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        for (const cacheName of cacheNames) {
                            await caches.delete(cacheName);
                            log(`–£–¥–∞–ª–µ–Ω –∫—ç—à: ${cacheName}`);
                        }
                    } catch (e) {
                        log(`–ö—ç—à API: ${e.message}`);
                    }
                }

                updateProgress(100, '–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
                updateStatus('‚úÖ –í–µ—Å—å –∫—ç—à —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω!', 'success');
                log('–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                
                showBackLink();
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ: ${error.message}`);
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–∞', 'warning');
            } finally {
                enableButtons();
            }
        }

        async function clearTonConnectOnly() {
            disableButtons();
            logDetails = [];
            updateStatus('–û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ TON Connect...', 'info');
            
            try {
                log('–ù–∞—á–∏–Ω–∞–µ–º –æ—á–∏—Å—Ç–∫—É TON Connect –¥–∞–Ω–Ω—ã—Ö');
                updateProgress(20, '–ü–æ–∏—Å–∫ TON Connect –¥–∞–Ω–Ω—ã—Ö...');

                // –û—á–∏—Å—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–ª—è TON Connect –∫–ª—é—á–µ–π
                const tonKeys = [
                    'ton-connect-ui_wallet-info',
                    'ton-connect-ui_preferred-wallet',
                    'ton-connect-ui_theme',
                    'tonconnect-storage_bridge',
                    'tonconnect-storage_http-bridge',
                    'tonconnect-storage_injected-wallet',
                    'tonconnect-storage_ton-connect',
                ];

                let keysFound = 0;
                Object.keys(localStorage).forEach(key => {
                    if (key.includes('ton-connect') || key.includes('tonconnect') || 
                        key.includes('ton_wallet') || key.includes('wallet')) {
                        localStorage.removeItem(key);
                        log(`–£–¥–∞–ª–µ–Ω –∫–ª—é—á: ${key}`);
                        keysFound++;
                    }
                });

                tonKeys.forEach(key => {
                    if (localStorage.getItem(key)) {
                        localStorage.removeItem(key);
                        log(`–£–¥–∞–ª–µ–Ω TON –∫–ª—é—á: ${key}`);
                        keysFound++;
                    }
                });

                updateProgress(60, '–û—á–∏—â–∞–µ–º sessionStorage...');
                Object.keys(sessionStorage).forEach(key => {
                    if (key.includes('ton-connect') || key.includes('tonconnect') || 
                        key.includes('ton_wallet') || key.includes('wallet')) {
                        sessionStorage.removeItem(key);
                        log(`–£–¥–∞–ª–µ–Ω session –∫–ª—é—á: ${key}`);
                        keysFound++;
                    }
                });

                updateProgress(100, 'TON Connect –æ—á–∏—â–µ–Ω!');
                updateStatus(`‚úÖ TON Connect –æ—á–∏—â–µ–Ω! –£–¥–∞–ª–µ–Ω–æ ${keysFound} –∫–ª—é—á–µ–π`, 'success');
                log(`–û—á–∏—Å—Ç–∫–∞ TON Connect –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –£–¥–∞–ª–µ–Ω–æ ${keysFound} –∫–ª—é—á–µ–π`);
                
                showBackLink();
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ TON Connect: ${error.message}`);
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ TON Connect', 'warning');
            } finally {
                enableButtons();
            }
        }

        async function clearUserData() {
            disableButtons();
            logDetails = [];
            updateStatus('–û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...', 'info');
            
            try {
                log('–ù–∞—á–∏–Ω–∞–µ–º –æ—á–∏—Å—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                updateProgress(25, '–û—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω—ã...');

                const userKeys = [
                    'unifarm_jwt_token',
                    'unifarm_last_session', 
                    'unifarm_guest_id',
                    'unifarm_user_data',
                    'user_balance',
                    'wallet_address'
                ];

                let keysFound = 0;
                userKeys.forEach(key => {
                    if (localStorage.getItem(key)) {
                        localStorage.removeItem(key);
                        log(`–£–¥–∞–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–ª—é—á: ${key}`);
                        keysFound++;
                    }
                });

                updateProgress(70, '–û—á–∏—â–∞–µ–º session –¥–∞–Ω–Ω—ã–µ...');
                Object.keys(sessionStorage).forEach(key => {
                    if (key.includes('unifarm') || key.includes('user') || key.includes('balance')) {
                        sessionStorage.removeItem(key);
                        log(`–£–¥–∞–ª–µ–Ω session –∫–ª—é—á: ${key}`);
                        keysFound++;
                    }
                });

                updateProgress(100, '–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—á–∏—â–µ–Ω—ã!');
                updateStatus(`‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—á–∏—â–µ–Ω—ã! –£–¥–∞–ª–µ–Ω–æ ${keysFound} –∫–ª—é—á–µ–π`, 'success');
                log(`–û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –£–¥–∞–ª–µ–Ω–æ ${keysFound} –∫–ª—é—á–µ–π`);
                
                showBackLink();
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${error.message}`);
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'warning');
            } finally {
                enableButtons();
            }
        }

        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º –∫—ç—à–µ
        window.addEventListener('load', () => {
            const lsCount = Object.keys(localStorage).length;
            const ssCount = Object.keys(sessionStorage).length;
            log(`–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∫–ª—é—á–µ–π - localStorage: ${lsCount}, sessionStorage: ${ssCount}`);
        });
    </script>
</body>
</html>