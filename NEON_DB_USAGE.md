# Руководство по использованию Neon DB в UniFarm

## Обзор

Этот документ описывает процесс подключения и использования Neon DB как альтернативного провайдера базы данных для UniFarm. Neon DB - это облачный PostgreSQL сервис, который предлагает:

- Автоматическое масштабирование (serverless)
- Встроенные пулы соединений
- Высокую отказоустойчивость
- Оптимизацию для высоконагруженных систем

## Настройка окружения

### 1. Конфигурация .env.neon

Для работы с Neon DB необходимо создать файл `.env.neon` в корне проекта со следующими настройками:

```env
# Настройки принудительного использования Neon DB
DATABASE_PROVIDER=neon
USE_LOCAL_DB_ONLY=false
FORCE_NEON_DB=true
DISABLE_REPLIT_DB=true
OVERRIDE_DB_PROVIDER=neon

# URL подключения к Neon DB
DATABASE_URL=postgresql://your_username:your_password@your-neon-endpoint.neon.tech/your_database?sslmode=require
```

Важное замечание:
- Всегда используйте параметр `?sslmode=require` в URL подключения
- Для оптимальной производительности рекомендуется использовать endpoints с постфиксом `-pooler`

### 2. Проверка подключения

Для проверки подключения к Neon DB используйте скрипт:

```bash
node check-neon-db.js
```

Скрипт проверит:
- Соединение с Neon DB
- Размер базы данных
- Список таблиц и количество записей
- Статус партиционирования таблицы transactions

## Запуск приложения с Neon DB

Для запуска приложения с использованием Neon DB предусмотрено два скрипта:

### Вариант 1: Bash скрипт (рекомендуется)

```bash
chmod +x start-with-neon.sh
./start-with-neon.sh
```

### Вариант 2: Node.js скрипт

```bash
node neon-start.js
```

Оба скрипта автоматически:
1. Загружают настройки из `.env.neon`
2. Проверяют подключение к Neon DB
3. Запускают приложение с правильными переменными окружения

## Инициализация и миграция базы данных

### Инициализация базовых таблиц

Для инициализации базы данных в Neon DB необходимо создать базовую структуру:

```bash
node init-neon-db.js
```

Этот скрипт создаст все необходимые таблицы в Neon DB на основе структуры, описанной в `shared/schema.ts`.

### Миграция схемы базы данных

Если структура таблиц уже существует, для обновления схемы используйте:

```bash
node migrate-neon-db.js
```

Этот скрипт запустит `drizzle-kit push` с настройками Neon DB.

## Партиционирование таблицы transactions

В Neon DB необходимо отдельно настроить партиционирование для таблицы transactions:

```bash
node create-neon-partitions.js
```

⚠️ **ВНИМАНИЕ**: Этот скрипт пересоздаст таблицу transactions. Перед запуском убедитесь, что у вас есть резервная копия данных.

Скрипт автоматически:
1. Создаст резервную копию существующих данных
2. Пересоздаст таблицу transactions с партиционированием по RANGE(created_at)
3. Создаст партиции для последних 3 месяцев и следующих 3 месяцев
4. Восстановит данные из резервной копии
5. Создаст функции для автоматического управления партициями

## Особенности работы с Neon DB

### Оптимизация запросов

- Используйте индексы для ускорения запросов по часто используемым полям
- Для больших таблиц применяйте партиционирование
- Ограничивайте выборки с помощью LIMIT и OFFSET

### Пулы соединений

Neon DB автоматически управляет пулами соединений при использовании эндпоинта с `-pooler`. Настройки пула в коде:

```typescript
// Оптимальные настройки пула для Neon DB
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  max: 10, // Максимальное количество соединений в пуле
  idleTimeoutMillis: 30000, // Время неактивности соединения до его закрытия
  connectionTimeoutMillis: 5000, // Таймаут установки соединения
  ssl: {
    rejectUnauthorized: false // Необходимо для SSL подключения
  }
});
```

### Переключение между Neon DB и Replit PostgreSQL

Для переключения между провайдерами используйте соответствующие скрипты запуска:

- Neon DB: `./start-with-neon.sh` или `node neon-start.js`
- Replit PostgreSQL: `./start-with-replit-db.sh` или стандартный запуск `npm run dev`

## Тестирование интеграции с Neon DB

Для комплексного тестирования интеграции UniFarm с Neon DB используйте скрипт:

```bash
node test-neon-integration.js
```

Этот скрипт выполняет серию тестов:

1. Проверяет подключение к Neon DB
2. Анализирует структуру таблиц
3. Тестирует CRUD операции с пользователями
4. Проверяет работу с транзакциями
5. Тестирует функционал фарминга
6. Проводит замеры производительности

После выполнения скрипт выдаст подробный отчет о результатах тестирования и рекомендации по оптимизации при необходимости.

## Устранение неполадок

### Проблемы с подключением

1. Убедитесь, что URL содержит `?sslmode=require`
2. Проверьте правильность учетных данных
3. Проверьте доступность сервера Neon DB

### Ошибки выполнения запросов

1. Проверьте, не блокируются ли запросы из-за неверных типов данных
2. Убедитесь, что партиционирование работает корректно
3. Проверьте лимиты на размер базы данных в вашем плане Neon DB

### Проблемы с производительностью

1. Используйте эндпоинты с `-pooler` для автоматического управления соединениями
2. Убедитесь, что для часто используемых запросов созданы соответствующие индексы
3. Для таблиц с большим количеством записей используйте партиционирование

## Дополнительные ресурсы

- [Документация Neon DB](https://neon.tech/docs/)
- [Оптимизация PostgreSQL](https://www.postgresql.org/docs/current/performance-tips.html)
- [Drizzle ORM с PostgreSQL](https://orm.drizzle.team/docs/postgresql)