<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Dep√≥sito UNI Farming</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .container {
            background-color: #1e1e1e;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        h1 {
            color: #bb86fc;
            text-align: center;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #bb86fc;
        }
        input {
            width: 100%;
            padding: 12px;
            background-color: #2e2e2e;
            border: 1px solid #444;
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 16px;
        }
        button {
            background-color: #bb86fc;
            color: #121212;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #9965f4;
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background-color: #2e2e2e;
            border: 1px solid #444;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .success {
            background-color: #1b5e20;
            border-color: #4caf50;
        }
        .error {
            background-color: #b71c1c;
            border-color: #f44336;
        }
        .info {
            background-color: #0d47a1;
            border-color: #2196f3;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #bb86fc;
            padding-left: 10px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .status-card {
            background-color: #2e2e2e;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #444;
        }
        .status-label {
            color: #888;
            font-size: 14px;
        }
        .status-value {
            color: #bb86fc;
            font-size: 18px;
            font-weight: bold;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Teste de Dep√≥sito UNI Farming</h1>
        
        <div class="status-grid">
            <div class="status-card">
                <div class="status-label">Balan√ßo UNI</div>
                <div class="status-value" id="uni-balance">Carregando...</div>
            </div>
            <div class="status-card">
                <div class="status-label">Dep√≥sito Atual</div>
                <div class="status-value" id="current-deposit">Carregando...</div>
            </div>
            <div class="status-card">
                <div class="status-label">Status Farming</div>
                <div class="status-value" id="farming-status">Carregando...</div>
            </div>
            <div class="status-card">
                <div class="status-label">User ID</div>
                <div class="status-value" id="user-id">62</div>
            </div>
        </div>

        <div class="input-group">
            <label for="amount">Valor do Dep√≥sito (UNI):</label>
            <input type="number" id="amount" value="10" min="1" max="1000" step="0.1">
        </div>
        
        <button onclick="testDeposit()" id="depositBtn">Testar Dep√≥sito UNI</button>
        <button onclick="checkStatus()" style="margin-left: 10px;">Atualizar Status</button>
        <button onclick="checkDirectStatus()" style="margin-left: 10px;">Diagn√≥stico Direto</button>
        
        <div class="result" id="result"></div>
    </div>

    <script>
        const JWT_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjYyLCJ0ZWxlZ3JhbV9pZCI6ODgyMTAwNDIsInVzZXJuYW1lIjoiRGVyQW5keSIsInJlZl9jb2RlIjoiUkVGXzE3NTEzNzI5NTM5MzZfYTM0aWpwIiwiaWF0IjoxNzUxMzcyOTU0LCJleHAiOjE3NTE5Nzc3NTR9.sGJzxg6fRmyH9cxCOQQcF7oBXDEsH1vlbJxAm-fN0L0';
        
        function log(message, type = 'info') {
            const result = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            result.appendChild(logEntry);
            result.scrollTop = result.scrollHeight;
        }

        async function makeApiRequest(url, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${JWT_TOKEN}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            const response = await fetch(url, options);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || `HTTP ${response.status}`);
            }
            
            return data;
        }

        async function checkStatus() {
            try {
                log('üìä Verificando status do farming...', 'info');
                
                // Buscar status do farming
                const farmingData = await makeApiRequest('/api/v2/uni-farming/status?user_id=62');
                
                if (farmingData.success && farmingData.data) {
                    const data = farmingData.data;
                    document.getElementById('uni-balance').textContent = `${parseFloat(data.balance_uni || 0).toFixed(3)} UNI`;
                    document.getElementById('current-deposit').textContent = `${parseFloat(data.uni_deposit_amount || 0).toFixed(3)} UNI`;
                    document.getElementById('farming-status').textContent = data.uni_farming_active ? '‚úÖ Ativo' : '‚ùå Inativo';
                    
                    log(`‚úÖ Status atualizado:
- Balan√ßo: ${data.balance_uni} UNI
- Dep√≥sito: ${data.uni_deposit_amount} UNI
- Ativo: ${data.uni_farming_active}
- Taxa: ${data.uni_farming_rate || 0.01}% por hora`, 'success');
                } else {
                    log('‚ùå Erro ao obter status do farming', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function checkDirectStatus() {
            try {
                log('üîç Executando diagn√≥stico direto do banco de dados...', 'info');
                
                // Buscar status direto
                const diagnosticData = await makeApiRequest('/api/v2/uni-farming/direct-status?user_id=62');
                
                if (diagnosticData.success && diagnosticData.data) {
                    const data = diagnosticData.data;
                    log(`üìä Diagn√≥stico Completo:
                    
Dados Brutos:
- uni_deposit_amount: ${data.raw_data.uni_deposit_amount}
- uni_farming_start_timestamp: ${data.raw_data.uni_farming_start_timestamp}
- uni_farming_rate: ${data.raw_data.uni_farming_rate}
- uni_farming_last_update: ${data.raw_data.uni_farming_last_update}

An√°lise:
- Tem timestamp: ${data.analysis.has_timestamp ? '‚úì' : '‚úó'}
- Tem dep√≥sito: ${data.analysis.has_deposit ? '‚úì' : '‚úó'} (${data.analysis.deposit_value})
- Tem taxa: ${data.analysis.has_rate ? '‚úì' : '‚úó'} (${data.analysis.rate_value})
- Deveria estar ativo: ${data.analysis.should_be_active ? '‚úì' : '‚úó'}

Status Final:
- uni_farming_active: ${data.uni_farming_active}`, data.analysis.should_be_active ? 'success' : 'error');
                } else {
                    log('‚ùå Erro ao obter diagn√≥stico direto', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro no diagn√≥stico: ${error.message}`, 'error');
            }
        }

        async function testDeposit() {
            const amount = document.getElementById('amount').value;
            const depositBtn = document.getElementById('depositBtn');
            
            if (!amount || parseFloat(amount) <= 0) {
                log('‚ùå Por favor, insira um valor v√°lido', 'error');
                return;
            }
            
            depositBtn.disabled = true;
            depositBtn.textContent = 'Processando...';
            
            try {
                // Limpar logs anteriores
                document.getElementById('result').innerHTML = '';
                
                log(`üöÄ Iniciando teste de dep√≥sito de ${amount} UNI`, 'info');
                
                // 1. Verificar status inicial
                await checkStatus();
                
                // 2. Fazer o dep√≥sito
                log(`üí∞ Enviando dep√≥sito para /api/v2/uni-farming/deposit`, 'info');
                const depositResult = await makeApiRequest('/api/v2/uni-farming/deposit', 'POST', {
                    amount: amount.toString(),
                    user_id: 62
                });
                
                if (depositResult.success) {
                    log(`‚úÖ Dep√≥sito realizado com sucesso!`, 'success');
                    log(`Resposta: ${JSON.stringify(depositResult, null, 2)}`, 'success');
                    
                    // 3. Aguardar um pouco para a propaga√ß√£o
                    log('‚è≥ Aguardando 2 segundos para propaga√ß√£o...', 'info');
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // 4. Verificar status ap√≥s dep√≥sito
                    log('üìä Verificando status ap√≥s dep√≥sito...', 'info');
                    await checkStatus();
                    
                } else {
                    log(`‚ùå Falha no dep√≥sito: ${depositResult.error || 'Erro desconhecido'}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro durante o teste: ${error.message}`, 'error');
                console.error('Erro completo:', error);
            } finally {
                depositBtn.disabled = false;
                depositBtn.textContent = 'Testar Dep√≥sito UNI';
            }
        }

        // Verificar status inicial ao carregar
        window.onload = () => {
            checkStatus();
        };
    </script>
</body>
</html>