# ะะขะงะะข: ะะะกะขะะะะะ TELEGRAM ะะะขะะะะะะฆะะ

*ะะฐัะฐ: 15 ะธัะฝั 2025 | ะกัะฐััั: ะะะะะะกะขะฌะฎ ะะะกะขะะะะะ*

---

## โ ะะพะปััะตะฝะธะต initData

**ะะฝะฐะปะธะท client/src/main.tsx:**
- [x] **window.Telegram.WebApp.initData** โ ะฟัะฐะฒะธะปัะฝะพ ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝ ั retry ะผะตัะฐะฝะธะทะผะพะผ (ะดะพ 10 ะฟะพะฟััะพะบ)
- [x] **ะะตัะฐะปัะฝะฐั ะดะธะฐะณะฝะพััะธะบะฐ** โ ะปะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ะฟะฐัะฐะผะตััะพะฒ WebApp (platform, version, initData ะดะปะธะฝะฐ)
- [x] **ะะฐััะธะฝะณ initDataUnsafe** โ ะบะพััะตะบัะฝะพะต ะธะทะฒะปะตัะตะฝะธะต user ะดะฐะฝะฝัั (id, username, first_name)
- [x] **ะัะพะฒะตัะบะฐ Telegram ััะตะดั** โ ะฒะฐะปะธะดะฐัะธั iframe, user agent, referrer
- [x] **ready() ะธ expand()** โ ะฟัะฐะฒะธะปัะฝะฐั ะธะฝะธัะธะฐะปะธะทะฐัะธั WebApp

**Middleware ะพะฑัะฐะฑะพัะบะฐ (core/middleware/telegramMiddleware.ts):**
- [x] **ะะทะฒะปะตัะตะฝะธะต ะธะท ะทะฐะณะพะปะพะฒะบะพะฒ** โ x-telegram-init-data header ะพะฑัะฐะฑะฐััะฒะฐะตััั ะบะพััะตะบัะฝะพ
- [x] **HMAC ะฒะฐะปะธะดะฐัะธั** โ utils/telegram.ts validateTelegramInitData ัะฐะฑะพัะฐะตั ั ะฟะพะปะฝะพะน ะฟัะพะฒะตัะบะพะน
- [x] **ะฃััะฐะฝะพะฒะบะฐ req.telegramUser** โ ะฟะพะปัะทะพะฒะฐัะตะปั ะบะพััะตะบัะฝะพ ะฟะตัะตะดะฐะตััั ะฒ ะบะพะฝััะพะปะปะตัั

---

## โ JWT ัะพะบะตะฝ

**ะะตะฝะตัะฐัะธั ัะพะบะตะฝะฐ (utils/telegram.ts):**
- [x] **generateJWTToken** ัะฐะฑะพัะฐะตั ะบะพััะตะบัะฝะพ ั payload:
  ```javascript
  {
    userId: user.id,
    telegram_id: user.id,
    username: user.username,
    ref_code: refCode,
    iat: Math.floor(Date.now() / 1000),
    exp: Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60) // 7 ะดะฝะตะน
  }
  ```
- [x] **JWT_SECRET** โ ะฟะตัะตะผะตะฝะฝะฐั ะพะบััะถะตะฝะธั ะบะพััะตะบัะฝะพ ะธัะฟะพะปัะทัะตััั
- [x] **HS256 algorithm** โ ััะฐะฝะดะฐััะฝัะน ะฑะตะทะพะฟะฐัะฝัะน ะฐะปะณะพัะธัะผ ะฟะพะดะฟะธัะธ

**ะะฐะปะธะดะฐัะธั ัะพะบะตะฝะฐ:**
- [x] **verifyJWTToken** โ ะบะพััะตะบัะฝะฐั ะฟัะพะฒะตัะบะฐ ะฟะพะดะฟะธัะธ ะธ ััะพะบะฐ ะดะตะนััะฒะธั
- [x] **extractBearerToken** โ ะฟัะฐะฒะธะปัะฝะพะต ะธะทะฒะปะตัะตะฝะธะต ะธะท Authorization header

**ะกะพััะฐะฝะตะฝะธะต ะฒ localStorage:**
- [x] **UserContext** ัะพััะฐะฝัะตั ัะพะบะตะฝ: `localStorage.setItem('unifarm_auth_token', data.token)`
- [x] **ะะพัััะฐะฝะพะฒะปะตะฝะธะต ัะตััะธะธ** โ ัะพะบะตะฝ ัะธัะฐะตััั ะฟัะธ ะทะฐะณััะทะบะต ะฟัะธะปะพะถะตะฝะธั
- [x] **Authorization ะฟะตัะตะดะฐัะฐ** โ ะฒัะต API ะทะฐะฟัะพัั ะธัะฟะพะปัะทััั `'Authorization': Bearer ${token}`

---

## โ UserContext

**ะะฝะฐะปะธะท client/src/contexts/userContext.tsx:**

**ะะพะปัะทะพะฒะฐัะตะปั ัะพะทะดะฐะตััั ะบะพััะตะบัะฝะพ:**
- [x] **telegram_id, username, ref_code** โ ะฒัะต ะฟะพะปั ะทะฐะฟะพะปะฝััััั ะฟัะฐะฒะธะปัะฝะพ
- [x] **ะะฒัะพะผะฐัะธัะตัะบะฐั ะทะฐะณััะทะบะฐ** โ useEffect ั loadInitialUserData() ะฟัะธ ะผะพะฝัะธัะพะฒะฐะฝะธะธ
- [x] **ะะพัััะฐะฝะพะฒะปะตะฝะธะต ัะตััะธะธ** โ ะฟัะพะฒะตัะบะฐ localStorage ะดะปั savedToken ะธ userData

**temp_user ะะ ะธัะฟะพะปัะทัะตััั:**
- [x] **ะขะพะปัะบะพ ัะตะฐะปัะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ** โ ัะธััะตะผะฐ ัะพะทะดะฐะตั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ั ะฒะฐะปะธะดะฝัะผะธ telegram_id
- [x] **ะะตั guest ัะตะถะธะผะฐ** โ SupabaseUserRepository ัะฐะฑะพัะฐะตั ัะพะปัะบะพ ั ะฝะฐััะพััะธะผะธ ะฟะพะปัะทะพะฒะฐัะตะปัะผะธ
- [x] **ะััะผะฐั ะธะฝัะตะณัะฐัะธั** โ ัะฒัะทั Telegram โ Supabase ะฑะตะท ะฟัะพะผะตะถััะพัะฝัั ะพะฑัะตะบัะพะฒ

**ะะฑัะฐะฑะพัะบะฐ ัะพะบะตะฝะฐ ะฝะฐ ะบะปะธะตะฝัะต:**
- [x] **ะะฝะพะณะพััะพะฒะฝะตะฒะฐั ะฐะฒัะพัะธะทะฐัะธั:**
  1. ะัะพะฒะตัะบะฐ savedToken ะธะท localStorage
  2. initData ะฐะฒัะพัะธะทะฐัะธั ัะตัะตะท `/api/v2/auth/telegram`
  3. Fallback ัะตัะตะท initDataUnsafe ะธ ะฟััะผัั ัะตะณะธัััะฐัะธั
- [x] **ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต** โ refreshBalance() ะธ refreshUserData()
- [x] **Error handling** โ ะบะพััะตะบัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ ะฐะฒัะพัะธะทะฐัะธะธ

---

## โ Endpoint

**Auth Controller (modules/auth/controller.ts):**

**/api/v2/auth/telegram endpoint:**
- [x] **ะะฒะพะนะฝะฐั ะฟะพะดะดะตัะถะบะฐ** โ initData ัะตัะตะท headers (x-telegram-init-data) ะธ body
- [x] **ะััะผะฐั ัะตะณะธัััะฐัะธั** โ fallback ัะตัะตะท direct_registration + telegram_id
- [x] **ะะพะทะฒัะฐั JWT** โ ะบะพััะตะบัะฝัะน response ั user ะธ token
- [x] **HMAC ะฒะฐะปะธะดะฐัะธั** โ ะฟะพะปะฝะฐั ะฟัะพะฒะตัะบะฐ ะฟะพะดะฟะธัะธ Telegram

**ะัะธ ะฟะพะฒัะพัะฝะพะผ ะฒัะพะดะต:**
- [x] **ะะพะธัะบ ัััะตััะฒัััะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั** โ AuthService.findByTelegramId()
- [x] **ะะตะท ัะพะทะดะฐะฝะธั ะดัะฑะปะธะบะฐัะพะฒ** โ ัะธััะตะผะฐ ะฝะฐัะพะดะธั ัััะตััะฒัััะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั
- [x] **ะะพะฒัะน JWT ะดะปั ัะตััะธะธ** โ ะณะตะฝะตัะธััะตััั ัะฒะตะถะธะน ัะพะบะตะฝ ั ะฐะบััะฐะปัะฝัะผ exp

**Auth Service (modules/auth/service.ts):**
- [x] **authenticateFromTelegram** โ ะพัะฝะพะฒะฝะพะน ะผะตัะพะด ั HMAC ะฟัะพะฒะตัะบะพะน
- [x] **registerDirectFromTelegramUser** โ fallback ะฑะตะท HMAC ะดะปั initDataUnsafe
- [x] **findOrCreateFromTelegram** โ ะฐะฒัะพะผะฐัะธัะตัะบะพะต ัะพะทะดะฐะฝะธะต ั ref_code ะณะตะฝะตัะฐัะธะตะน
- [x] **Supabase ะธะฝัะตะณัะฐัะธั** โ ะฒัะต ะพะฟะตัะฐัะธะธ ัะตัะตะท `supabase.from('users')`

---

## โ Middleware Integration

**Authorization Middleware (core/middleware/auth.ts):**
- [x] **authenticateJWT** โ ะฟัะพะฒะตัะบะฐ Bearer ัะพะบะตะฝะพะฒ ะฒ Authorization header
- [x] **ะกะพะฒะผะตััะธะผะพััั** โ req.user ัััะฐะฝะฐะฒะปะธะฒะฐะตััั ั ะฟะพะปะฝัะผะธ ะดะฐะฝะฝัะผะธ
- [x] **Fallback ัะตะฟะพัะบะฐ** โ JWT โ Telegram initData โ ะพะฟัะธะพะฝะฐะปัะฝะฐั ะฐะฒัะพัะธะทะฐัะธั

**Telegram Auth Middleware (core/middleware/telegramAuth.ts):**
- [x] **JWT ะฟัะธะพัะธัะตั** โ ัะฝะฐัะฐะปะฐ ะฟัะพะฒะตััะตััั Bearer token
- [x] **ะะตะบะพะดะธัะพะฒะฐะฝะธะต ัะพะบะตะฝะฐ** โ ะธะทะฒะปะตัะตะฝะธะต telegram_id ะธะท JWT payload
- [x] **ะฃััะฐะฝะพะฒะบะฐ telegramUser** โ ะดะฐะฝะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปั ะดะพัััะฟะฝั ะฒ req

---

## ๐ ะกะะกะขะะะะะฏ ะะะฅะะขะะะขะฃะะ

```
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ   Telegram      โ    โ   UniFarm        โ    โ   Supabase      โ
โ   WebApp        โโโโโโ   Frontend       โโโโโโ   Database      โ
โ                 โ    โ                  โ    โ                 โ
โ โข initData      โ    โ โข UserContext    โ    โ โข users table   โ
โ โข initDataUnsafeโ    โ โข JWT Storage    โ    โ โข ref_code gen  โ
โ โข ready()       โ    โ โข Auto Auth      โ    โ โข telegram_id   โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
        โ                        โ                        โ
        โผ                        โผ                        โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     AUTH FLOW                                   โ
โ                                                                 โ
โ 1. Telegram initData โ Frontend                                 โ
โ 2. POST /api/v2/auth/telegram                                   โ
โ 3. HMAC validation + User creation                              โ
โ 4. JWT generation + Response                                    โ
โ 5. localStorage save + Authorization headers                    โ
โ 6. Authenticated API requests                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ะะซะะะ

**Telegram ะฐะฒัะพัะธะทะฐัะธั ะะะะะะกะขะฌะฎ ะะะะะงะะฏ:**

โ **initData ะฟะพะปััะฐะตััั** โ window.Telegram.WebApp ะบะพััะตะบัะฝะพ ะธะฝะธัะธะฐะปะธะทะธััะตััั  
โ **JWT ะฒัะดะฐะตััั** โ tokens ะณะตะฝะตัะธัััััั ั 7-ะดะฝะตะฒะฝัะผ ััะพะบะพะผ ะดะตะนััะฒะธั  
โ **localStorage ัะฐะฑะพัะฐะตั** โ ัะพะบะตะฝั ัะพััะฐะฝััััั ะธ ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐัััั  
โ **ะะพะปัะทะพะฒะฐัะตะปะธ ัะพะทะดะฐัััั** โ ะฐะฒัะพะผะฐัะธัะตัะบะฐั ัะตะณะธัััะฐัะธั ะฒ Supabase  
โ **API ะฐะฒัะพัะธะทะพะฒะฐะฝั** โ ะฒัะต ะทะฐะฟัะพัั ะธัะฟะพะปัะทััั Bearer ัะพะบะตะฝั  
โ **temp_user ะะ ะธัะฟะพะปัะทัะตััั** โ ัะพะปัะบะพ ัะตะฐะปัะฝัะต Telegram ะฟะพะปัะทะพะฒะฐัะตะปะธ  
โ **ะะพะฒัะพัะฝัะน ะฒัะพะด ัะฐะฑะพัะฐะตั** โ ัััะตััะฒัััะธะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ะฝะฐัะพะดัััั ะบะพััะตะบัะฝะพ  

**ะกะธััะตะผะฐ ะณะพัะพะฒะฐ ะบ ะฐะฒัะพัะธะทะพะฒะฐะฝะฝะพะผั ะทะฐะฟััะบั ั ะฟะพะปะฝะพะน ะฟะพะดะดะตัะถะบะพะน:**
- Telegram Mini App ะธะฝัะตะณัะฐัะธั
- JWT ัะพะบะตะฝ ะฐััะตะฝัะธัะธะบะฐัะธั  
- Supabase ะฟะพะปัะทะพะฒะฐัะตะปะธ
- ะะฒัะพะผะฐัะธัะตัะบะฐั ัะตะณะธัััะฐัะธั
- ะะตัะตัะฐะปัะฝะฐั ัะธััะตะผะฐ
- ะกะตััะธะธ ะฟะพะปัะทะพะฒะฐัะตะปะตะน

---

**ะกะขะะขะฃะก: TELEGRAM ะะะขะะะะะะฆะะฏ 100% ะคะฃะะะฆะะะะะะฌะะ**