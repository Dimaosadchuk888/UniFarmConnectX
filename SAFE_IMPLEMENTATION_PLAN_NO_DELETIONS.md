# üõ°Ô∏è –ë–ï–ó–û–ü–ê–°–ù–´–ô –ü–õ–ê–ù –î–û–ü–û–õ–ù–ï–ù–ò–Ø –°–ò–°–¢–ï–ú–´ –ë–ï–ó –£–î–ê–õ–ï–ù–ò–ô

**–î–∞—Ç–∞:** 23 —è–Ω–≤–∞—Ä—è 2025  
**–ü—Ä–∏–Ω—Ü–∏–ø:** –¢–û–õ–¨–ö–û –î–û–ë–ê–í–õ–ï–ù–ò–ï, –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–Ø –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û  
**–ì–∞—Ä–∞–Ω—Ç–∏—è:** 100% —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ä–∞–±–æ—Ç–∞—é—â–∏–º –∫–æ–¥–æ–º  

---

## ‚úÖ –°–¢–†–ê–¢–ï–ì–ò–Ø: –î–æ–ø–æ–ª–Ω—è–µ–º, –Ω–µ –ª–æ–º–∞–µ–º

### üéØ –ö–õ–Æ–ß–ï–í–´–ï –ü–†–ò–ù–¶–ò–ü–´:

1. **–ù–ï –£–î–ê–õ–Ø–ï–ú** —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è –∏ –¥–∞–Ω–Ω—ã–µ
2. **–ù–ï –ú–ï–ù–Ø–ï–ú** —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
3. **–î–û–ë–ê–í–õ–Ø–ï–ú** –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏–π
4. **–°–û–•–†–ê–ù–Ø–ï–ú** –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
5. **–ü–û–ú–ï–ß–ê–ï–ú** –¥—É–±–ª–∏–∫–∞—Ç—ã –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è

---

## üìã –ü–õ–ê–ù –î–û–ü–û–õ–ù–ï–ù–ò–Ø –ë–î

### –≠–¢–ê–ü 1: –ó–ê–©–ò–¢–ê –û–¢ –î–£–ë–õ–ò–ö–ê–¢–û–í (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è)

**–ß—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º:**
```sql
-- –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ tx_hash
ALTER TABLE transactions 
ADD COLUMN IF NOT EXISTS tx_hash_unique TEXT;

-- –ü–æ–ª—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
ADD COLUMN IF NOT EXISTS is_duplicate BOOLEAN DEFAULT FALSE;
ADD COLUMN IF NOT EXISTS duplicate_of_id INTEGER;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ù–ï –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã
- –î—É–±–ª–∏–∫–∞—Ç—ã –ø–æ–º–µ—á–µ–Ω—ã, –Ω–æ –ù–ï —É–¥–∞–ª–µ–Ω—ã
- –ù–æ–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

### –≠–¢–ê–ü 2: –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨ –° –ö–û–î–û–ú

**–ß—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º:**
```sql
-- –ü–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –æ–∂–∏–¥–∞–µ—Ç –∫–æ–¥
ALTER TABLE transactions
ADD COLUMN IF NOT EXISTS amount_uni TEXT;
ADD COLUMN IF NOT EXISTS amount_ton TEXT;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–æ–¥ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏
- –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ –ø–æ–ª–µ amount
- –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### –≠–¢–ê–ü 3: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï boost_purchases

**–ß—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º:**
```sql
ALTER TABLE boost_purchases 
ADD COLUMN IF NOT EXISTS amount DECIMAL(20,9);
ADD COLUMN IF NOT EXISTS daily_rate DECIMAL(10,6);
ADD COLUMN IF NOT EXISTS start_date TIMESTAMP;
ADD COLUMN IF NOT EXISTS end_date TIMESTAMP;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—É—á–∏—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- –ö–æ–¥ —Å–º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å boost_purchases

---

## üîí –ö–ê–ö –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢ –í –ö–û–î–ï

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–Ω–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥):
```typescript
// –í–º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ metadata->>'tx_hash' –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤–æ–µ –ø–æ–ª–µ
const existing = await supabase
  .from('transactions')
  .select('id')
  .eq('tx_hash_unique', ton_tx_hash)
  .single();

if (existing) {
  return { error: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞' };
}

// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –æ–±–∞ –ø–æ–ª—è
const transaction = {
  metadata: { tx_hash: ton_tx_hash },  // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  tx_hash_unique: ton_tx_hash,         // –î–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
  amount_uni: amount_uni || '0',       // –ù–æ–≤—ã–µ –ø–æ–ª—è
  amount_ton: amount_ton || '0'
};
```

### 2. –†–∞–±–æ—Ç–∞ —Å —á–∏—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:
```typescript
// –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
const { data } = await supabase
  .from('transactions_clean')  // –í–º–µ—Å—Ç–æ 'transactions'
  .select('*')
  .eq('user_id', userId);
```

---

## üìä –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –ü–û–î–•–û–î–ê

1. **–ù–£–õ–ï–í–û–ô –†–ò–°–ö** - –Ω–µ –ª–æ–º–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É
2. **–ü–û–õ–ù–ê–Ø –ò–°–¢–û–†–ò–Ø** - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
3. **–ê–£–î–ò–¢** - –º–æ–∂–µ–º –≤–∏–¥–µ—Ç—å –≤—Å–µ –¥—É–±–ª–∏–∫–∞—Ç—ã
4. **–ì–ò–ë–ö–û–°–¢–¨** - –º–æ–∂–µ–º –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
5. **–°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨** - —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

---

## üöÄ –ü–û–†–Ø–î–û–ö –í–ù–ï–î–†–ï–ù–ò–Ø

### –§–ê–ó–ê 1: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL (20 –º–∏–Ω—É—Ç)
```bash
psql -d –≤–∞—à–∞_–±–∞–∑–∞ -f SAFE_ADDITIVE_MIGRATION_PLAN.sql
```

### –§–ê–ó–ê 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (10 –º–∏–Ω—É—Ç)
- –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–º–µ—Ç–∫—É –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤

### –§–ê–ó–ê 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (30 –º–∏–Ω—É—Ç)
- –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
- –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç
- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É boost

### –§–ê–ó–ê 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É tx_hash_unique
- –ò—Å–ø–æ–ª—å–∑—É–µ–º transactions_clean view
- –ó–∞–ø–æ–ª–Ω—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏

---

## ‚úÖ –ì–ê–†–ê–ù–¢–ò–ò

1. **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ù–ï –∏–∑–º–µ–Ω–µ–Ω—ã**
2. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü —Ç–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω–µ–Ω–∞**
3. **–ò–Ω–¥–µ–∫—Å—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç —Å–æ —Å—Ç–∞—Ä—ã–º–∏**
4. **–ö–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Ä–∞–Ω—å—à–µ**
5. **–ù–æ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ**

---

## üìã SQL –°–ö–†–ò–ü–¢

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª: `/scripts/sql/SAFE_ADDITIVE_MIGRATION_PLAN.sql`

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
- –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—è
- –°–æ–∑–¥–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
- –ü–æ–º–µ—á–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã
- –°–æ–∑–¥–∞–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
- –ù–ï —É–¥–∞–ª—è–µ—Ç –∏ –ù–ï –∏–∑–º–µ–Ω—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ

---

## ‚ùì –í–û–ü–†–û–°–´ –î–õ–Ø –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø

1. –£—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–∏ –≤–∞—Å –ø–æ–¥—Ö–æ–¥ —Å –ø–æ–º–µ—Ç–∫–æ–π –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è?
2. –ù—É–∂–Ω–æ –ª–∏ —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–æ–¥ –∏–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ë–î?
3. –•–æ—Ç–∏—Ç–µ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –±—É–¥—É—â–µ–≥–æ?

**–ì–æ—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ø–æ—Å–ª–µ –≤–∞—à–µ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è!**