#!/usr/bin/env node

/**
 * –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫ Telegram WebApp
 */

import fs from 'fs';
import path from 'path';

console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–ï–†–ï–ó–ê–ì–†–£–ó–û–ö TELEGRAM WEBAPP');
console.log('============================================');
console.log('');

// 1. –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –±—Ä–∞—É–∑–µ—Ä–∞ –∏–∑ automatic_updates
console.log('üìã 1. –ê–ù–ê–õ–ò–ó –õ–û–ì–û–í –ë–†–ê–£–ó–ï–†–ê:');
console.log('----------------------------');

const recentLogs = `
[correctApiRequest] –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç: {"ok":false,"status":401,"statusText":"Unauthorized"}
[correctApiRequest] üîÑ –ü–æ–ª—É—á–µ–Ω–∞ –æ—à–∏–±–∫–∞ 401, –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω...
[correctApiRequest] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...
[correctApiRequest] ‚ö†Ô∏è –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
[correctApiRequest] ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω: "–¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ localStorage"
[balanceService] –û—à–∏–±–∫–∞ –≤ fetchBalance: {"success":false,"error":"Authentication required","need_jwt_token":true}
`;

console.log('üî• –ü–†–û–ë–õ–ï–ú–ê –ù–ê–ô–î–ï–ù–ê - –¶–∏–∫–ª –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:');
console.log('1. ‚ùå JWT —Ç–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ localStorage');
console.log('2. ‚ùå API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 Unauthorized');
console.log('3. ‚ùå –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ Telegram initData');
console.log('4. ‚ùå –¢–æ–∫–µ–Ω –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è');
console.log('5. üîÅ –¶–ò–ö–õ: —Å–Ω–æ–≤–∞ –ø.1');
console.log('');

// 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
console.log('üìã 2. –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–û–í –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò:');
console.log('----------------------------------');

const authFiles = [
  'client/src/lib/correctApiRequest.ts',
  'client/src/App.tsx',
  'client/src/contexts/UserContext.tsx',
  'modules/auth/service.ts',
  'core/middleware/telegramAuth.ts'
];

let authProblems = [];

for (const file of authFiles) {
  try {
    if (fs.existsSync(file)) {
      const content = fs.readFileSync(file, 'utf8');
      
      // –ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
      if (file.includes('correctApiRequest.ts')) {
        if (content.includes('window.location.reload()')) {
          authProblems.push(`${file}: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ 401`);
        }
        if (content.includes('need_jwt_token')) {
          authProblems.push(`${file}: –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ JWT —Ç–æ–∫–µ–Ω–∞`);
        }
      }
      
      if (file.includes('App.tsx')) {
        if (content.includes('window.Telegram.WebApp.initData')) {
          console.log(`‚úÖ ${file}: Telegram initData –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞`);
        } else {
          authProblems.push(`${file}: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp`);
        }
      }
      
      console.log(`‚úÖ ${file}: –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —á–∏—Ç–∞–µ—Ç—Å—è`);
    } else {
      authProblems.push(`${file}: –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω`);
    }
  } catch (error) {
    authProblems.push(`${file}: –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è - ${error.message}`);
  }
}

console.log('');
if (authProblems.length > 0) {
  console.log('‚ö†Ô∏è –û–ë–ù–ê–†–£–ñ–ï–ù–´ –ü–†–û–ë–õ–ï–ú–´ –í –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò:');
  authProblems.forEach(problem => console.log(`- ${problem}`));
} else {
  console.log('‚úÖ –§–∞–π–ª—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –ø–æ—Ä—è–¥–∫–µ');
}

console.log('');

// 3. –ê–Ω–∞–ª–∏–∑ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
console.log('üìã 3. –ê–ù–ê–õ–ò–ó –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò:');
console.log('---------------------------------------------');

console.log('üîÑ –¢–ï–ö–£–©–ê–Ø –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨ (–°–õ–û–ú–ê–ù–ù–ê–Ø):');
console.log('1. üì± Telegram WebApp –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è');
console.log('2. ‚öõÔ∏è React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è');
console.log('3. üè† –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç –¥–∞–Ω–Ω—ã–µ (–±–∞–ª–∞–Ω—Å, –ø—Ä–æ—Ñ–∏–ª—å)');
console.log('4. üåê API –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ JWT —Ç–æ–∫–µ–Ω–∞');
console.log('5. ‚ùå –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 Unauthorized');
console.log('6. üîÑ correctApiRequest.ts –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É');
console.log('7. üîÅ –¶–ò–ö–õ: –ø.1 –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è');
console.log('');

console.log('‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨:');
console.log('1. üì± Telegram WebApp –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è');
console.log('2. üîë –ü–æ–ª—É—á–µ–Ω–∏–µ initData –∏–∑ window.Telegram.WebApp.initData');
console.log('3. üåê –û—Ç–ø—Ä–∞–≤–∫–∞ initData –Ω–∞ /api/v2/auth/telegram –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è JWT');
console.log('4. üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ JWT –≤ localStorage');
console.log('5. ‚öõÔ∏è React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º');
console.log('6. üè† –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ');
console.log('');

// 4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é
console.log('üìã 4. –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–û–ë–õ–ï–ú–´:');
console.log('--------------------------------');

console.log('üéØ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê:');
console.log('–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ WebApp');
console.log('');

console.log('üîß –ù–ï–û–ë–•–û–î–ò–ú–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:');
console.log('');
console.log('1. üöÄ –ü–†–ò–û–†–ò–¢–ï–¢ 1 - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ App.tsx:');
console.log('   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É window.Telegram.WebApp.initData');
console.log('   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ /api/v2/auth/telegram –ü–ï–†–ï–î —Ä–µ–Ω–¥–µ—Ä–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤');
console.log('   - –î–æ–∂–¥–∞—Ç—å—Å—è –ø–æ–ª—É—á–µ–Ω–∏—è JWT —Ç–æ–∫–µ–Ω–∞');
console.log('   - –¢–æ–ª—å–∫–æ –ø–æ—Ç–æ–º —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã');
console.log('');

console.log('2. üõ°Ô∏è –ü–†–ò–û–†–ò–¢–ï–¢ 2 - –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ correctApiRequest.ts:');
console.log('   - –£–±—Ä–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É window.location.reload()');
console.log('   - –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ Telegram initData');
console.log('   - –ü–æ–∫–∞–∑–∞—Ç—å loading —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏');
console.log('');

console.log('3. üé® –ü–†–ò–û–†–ò–¢–ï–¢ 3 - –î–æ–±–∞–≤–∏—Ç—å loading —ç–∫—Ä–∞–Ω:');
console.log('   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram..." –≤–æ –≤—Ä–µ–º—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
console.log('   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ API –∑–∞–ø—Ä–æ—Å—ã');
console.log('');

console.log('üìä –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–ô:');
console.log('- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö');
console.log('- ‚úÖ –ù–µ –º–µ–Ω—è—é—Ç —Å–µ—Ä–≤–µ—Ä–Ω—É—é –ª–æ–≥–∏–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
console.log('- ‚úÖ –¢–æ–ª—å–∫–æ –∏—Å–ø—Ä–∞–≤–ª—è—é—Ç –ø–æ—Ä—è–¥–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ');
console.log('- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è');

console.log('');
console.log('üéâ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è WebApp –±—É–¥–µ—Ç:');
console.log('1. ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å Telegram');
console.log('2. ‚úÖ –ü–æ–ª—É—á–∞—Ç—å JWT —Ç–æ–∫–µ–Ω –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ');
console.log('3. ‚úÖ –†–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫');
console.log('4. ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
