# Анализ системы начислений на кошельки UNI и TON

**Дата анализа**: 11 января 2025  
**Статус**: Анализ выполнен без изменения кода

## Резюме

Система начислений UniFarm полностью централизована через `BalanceManager` и работает корректно. Все начисления проходят через единый механизм с логированием, кешированием и уведомлениями.

## 1. Архитектура системы начислений

### 1.1 Центральный компонент - BalanceManager

```typescript
// core/BalanceManager.ts
- addBalance() - пополнение баланса
- subtractBalance() - списание с баланса  
- setBalance() - установка точного баланса
- updateUserBalance() - базовый метод обновления
```

**Ключевые особенности**:
- Все операции проходят через единый центр
- Автоматическое кеширование балансов через BalanceCache
- Интеграция с BalanceNotificationService для WebSocket уведомлений
- Детальное логирование всех операций с метками источника

### 1.2 Точность вычислений

Система использует NUMERIC(20,9) в базе данных и toFixed(6) в коде:
```typescript
balance_uni: parseFloat(newUniBalance.toFixed(6))
balance_ton: parseFloat(newTonBalance.toFixed(6))
```

## 2. Источники начислений UNI

### 2.1 UNI Farming доход (каждые 5 минут)
- **Модуль**: `core/scheduler/farmingScheduler.ts`
- **Процент**: 1% в день от депозита (изменен с 0.24%)
- **Формула**: `депозит * 0.01 / 288` (288 циклов по 5 минут в день)
- **Пример**: депозит 407,319 UNI = ~14.14 UNI за 5 минут

### 2.2 Миссии (единоразово)
- **Модуль**: `modules/missions/service.ts`
- **Награды**: 500 UNI за каждую миссию
- **Миссии**: 
  - ID 1: Telegram чат
  - ID 2: Telegram канал
  - ID 3: YouTube
  - ID 4: TikTok

### 2.3 Ежедневный бонус
- **Модуль**: `modules/dailyBonus/service.ts`
- **Прогрессия**: 1, 2, 3, 4, 5, 10, 20, 40, 80, 160... UNI
- **Максимум**: 160 UNI/день при серии 10+ дней

### 2.4 Реферальные комиссии от UNI Farming
- **Модуль**: `modules/referral/service.ts`
- **Ставки по уровням**:
  - Уровень 1: 100% от дохода реферала
  - Уровень 2: 20%
  - Уровень 3: 10%
  - ...
  - Уровень 20: 0.1%
- **Суммарная нагрузка**: 212% от каждого дохода

## 3. Источники начислений TON

### 3.1 TON Boost доход (каждые 5 минут)
- **Модуль**: `modules/scheduler/tonBoostIncomeScheduler.ts`
- **Процент**: от 1% до 3% в день (зависит от пакета)
- **Формула**: `(balance_ton - 10) * dailyRate / 288`
- **Пакеты**:
  - ID 1: Starter Boost - 1% в день
  - ID 2: Standard Boost - 1.5% в день
  - ID 3: Advanced Boost - 2% в день
  - ID 4: Premium Boost - 2.5% в день
  - ID 5: Elite Boost - 3% в день

### 3.2 Реферальные комиссии от TON Boost
- **Механизм**: аналогичен UNI farming
- **Распределение**: через те же 20 уровней
- **Нагрузка**: те же 212% от дохода

## 4. Процесс начисления

### 4.1 Типичный flow начисления
```
1. Планировщик запускается каждые 5 минут
2. Получает список активных фармеров
3. Рассчитывает доход для каждого
4. Использует BatchBalanceProcessor для массового обновления
5. Создает транзакции через UnifiedTransactionService
6. Распределяет реферальные комиссии
```

### 4.2 Batch обработка для оптимизации
```typescript
// Вместо индивидуальных обновлений:
batchBalanceProcessor.processFarmingIncome(farmerIncomes)
```

## 5. Статистика транзакций

На основе данных из базы:
- **FARMING_REWARD**: 118,607 транзакций
- **REFERRAL_REWARD**: 480,563 транзакций  
- **MISSION_REWARD**: 23 транзакции
- **DAILY_BONUS**: 23 транзакции

## 6. Обнаруженные особенности

### 6.1 Позитивные аспекты
✅ Полная централизация через BalanceManager  
✅ Единообразное создание транзакций через UnifiedTransactionService  
✅ Metadata для отслеживания источника каждой транзакции  
✅ Batch обработка для производительности  
✅ Кеширование балансов с TTL 5 минут  
✅ WebSocket уведомления для real-time обновлений  

### 6.2 Потенциальные улучшения
⚠️ Высокая реферальная нагрузка 212% может создавать инфляцию  
⚠️ Отсутствует механизм верификации максимальных лимитов начислений  
⚠️ Нет защиты от двойных начислений в случае сбоев планировщика  

## 7. Текущий баланс user_id 74

Из логов видно:
- **UNI баланс**: 518,901.122573
- **Активный депозит**: 407,319 UNI
- **Farming активен**: true
- **Ставка**: 1% в день

## Заключение

Система начислений работает корректно и эффективно. Все начисления проходят через централизованный BalanceManager с полным логированием и транзакционной историей. Единственная потенциальная проблема - высокая реферальная нагрузка 212%, которая может привести к быстрому росту балансов в системе с активной реферальной сетью.

Архитектура позволяет легко отслеживать все начисления через metadata в транзакциях, что было реализовано в рамках унификации транзакций.