# T18: –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò TELEGRAM –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
## –û—Ç—á–µ—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏

### ‚úÖ –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û

#### 1. –î–æ–±–∞–≤–ª–µ–Ω endpoint /api/v2/register/telegram
- **–§–∞–π–ª**: `modules/auth/routes.ts`
- **–ú–µ—Ç–æ–¥**: `POST /api/register/telegram`
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: Zod —Å—Ö–µ–º–∞ –¥–ª—è initData –∏ ref_by
- **–°—Ç–∞—Ç—É—Å**: –ê–∫—Ç–∏–≤–µ–Ω –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–∏—Å—Ç–µ–º–µ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏

#### 2. –°–æ–∑–¥–∞–Ω –º–µ—Ç–æ–¥ registerTelegram –≤ AuthController
- **–§–∞–π–ª**: `modules/auth/controller.ts`
- **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**: 
  - –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π (initData)
  - –í—ã–∑–æ–≤ AuthService.registerWithTelegram
  - –í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç–æ–∫–µ–Ω–∞ –∏ —Ñ–ª–∞–≥–∞ isNewUser
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

#### 3. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ registerWithTelegram –≤ AuthService
- **–§–∞–π–ª**: `modules/auth/service.ts`
- **–õ–æ–≥–∏–∫–∞**: 
  - HMAC –≤–∞–ª–∏–¥–∞—Ü–∏—è Telegram initData
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–∞
  - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ isNewUser —Ñ–ª–∞–≥–∞

#### 4. –†–∞—Å—à–∏—Ä–µ–Ω UserService –º–µ—Ç–æ–¥–∞–º–∏ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- **–§–∞–π–ª**: `modules/user/service.ts`
- **–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã**:
  - `findUserByTelegramId()` - –ø–æ–∏—Å–∫ –ø–æ Telegram ID
  - `createFromTelegram()` - —Å–æ–∑–¥–∞–Ω–∏–µ –∏–∑ Telegram –¥–∞–Ω–Ω—ã—Ö
  - `findOrCreateFromTelegram()` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥

#### 5. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **–§–∞–π–ª**: `shared/schema.ts`
- **–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ**: `first_name` –≤ —Ç–∞–±–ª–∏—Ü—É users
- **–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ö–µ–º–∞**: `insertUserSchema` –≤–∫–ª—é—á–∞–µ—Ç first_name

### üß™ –ß–¢–û –ë–´–õ–û –ü–†–û–í–ï–†–ï–ù–û

#### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ API endpoints
- ‚úÖ –ú–∞—Ä—à—Ä—É—Ç `/api/v2/register/telegram` –¥–æ–±–∞–≤–ª–µ–Ω –≤ auth routes
- ‚úÖ –ú–µ—Ç–æ–¥ `registerTelegram` –¥–æ—Å—Ç—É–ø–µ–Ω –≤ AuthController
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Zod —Å—Ö–µ–º—ã

#### 2. Telegram –≤–∞–ª–∏–¥–∞—Ü–∏—è
- ‚úÖ HMAC –ø–æ–¥–ø–∏—Å—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ Telegram initData –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ò–∑–≤–ª–µ–∫–∞—é—Ç—Å—è telegram_id, username, first_name

#### 3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ –ü–æ–ª–µ first_name –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å—Ö–µ–º—É users
- ‚úÖ –ú–µ—Ç–æ–¥—ã —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã
- ‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (ref_by ‚Üí parent_ref_code)

#### 4. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- ‚úÖ JWT —Ç–æ–∫–µ–Ω—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã

### ‚ö†Ô∏è –ß–¢–û –û–°–¢–ê–õ–û–°–¨ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô –ò –ü–û–ß–ï–ú–£

#### 1. –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π endpoint /api/v2/auth/telegram
- **–ü—Ä–∏—á–∏–Ω–∞**: –°–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- **–°—Ç–∞—Ç—É—Å**: –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

#### 2. UserService –≤ modules/users/service.ts
- **–ü—Ä–∏—á–∏–Ω–∞**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è AuthService, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **–°—Ç–∞—Ç—É—Å**: –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–µ—Ç–æ–¥—ã —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç

#### 3. Middleware –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
- **–ü—Ä–∏—á–∏–Ω–∞**: –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–π endpoint
- **–°—Ç–∞—Ç—É—Å**: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è

#### 4. Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **–ü—Ä–∏—á–∏–Ω–∞**: –ó–∞–¥–∞—á–∞ –∫–∞—Å–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ backend —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- **–°—Ç–∞—Ç—É—Å**: Frontend –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π endpoint –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

## –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –†–ï–®–ï–ù–ò–Ø

### –ü–æ—Ç–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
1. **Frontend** ‚Üí POST `/api/v2/register/telegram` —Å Telegram initData
2. **AuthController.registerTelegram()** ‚Üí –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. **AuthService.registerWithTelegram()** ‚Üí HMAC –≤–∞–ª–∏–¥–∞—Ü–∏—è Telegram
4. **UserService.findOrCreateFromTelegram()** ‚Üí –ø–æ–∏—Å–∫/—Å–æ–∑–¥–∞–Ω–∏–µ –≤ –ë–î
5. **JWT –≥–µ–Ω–µ—Ä–∞—Ü–∏—è** ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è —Å–µ—Å—Å–∏–∏
6. **Response** ‚Üí user, token, isNewUser —Ñ–ª–∞–≥

### –ü–æ—Ç–æ–∫ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
1. –ü–æ–∏—Å–∫ –ø–æ telegram_id –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ username –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è
3. –í–æ–∑–≤—Ä–∞—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ JWT —Ç–æ–∫–µ–Ω–∞
5. isNewUser = false

## –†–ï–ó–£–õ–¨–¢–ê–¢ –ó–ê–î–ê–ß–ò T18

### üéØ –¶–ï–õ–¨ –î–û–°–¢–ò–ì–ù–£–¢–ê
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ë–î –ø—Ä–∏ –≤—Ö–æ–¥–µ —á–µ—Ä–µ–∑ Telegram
- ‚úÖ –°–æ–∑–¥–∞—é—Ç—Å—è –∑–∞–ø–∏—Å–∏ —Å telegram_id, username, ref_code
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞—Ö–æ–¥–∞—Ö
- ‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ ref_by –ø–∞—Ä–∞–º–µ—Ç—Ä

### üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –†–ï–ê–õ–ò–ó–ê–¶–ò–ò
- **–ù–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤**: 2 (—Ç–µ—Å—Ç—ã –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)
- **–ò–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤**: 4 (controller, service, routes, schema)
- **–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤**: 4 (registerTelegram, registerWithTelegram, findUserByTelegramId, createFromTelegram)
- **–ù–æ–≤—ã—Ö endpoint**: 1 (/api/v2/register/telegram)

### üöÄ –ì–û–¢–û–í–ù–û–°–¢–¨ –ö PRODUCTION
–°–∏—Å—Ç–µ–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:
- –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ–ø–µ—Ä—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ Mini App.**