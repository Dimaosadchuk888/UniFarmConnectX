# –û—Ç—á–µ—Ç —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–µ–ø–æ–∑–∏—Ç–∞–º–∏
## –î–∞—Ç–∞: 06.08.2025

### ‚úÖ –°–¢–ê–¢–£–° –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô:

#### 1. –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø - –ò–°–ü–†–ê–í–õ–ï–ù–û ‚úÖ
- **–§–∞–π–ª:** `core/TransactionService.ts` —Å—Ç—Ä–æ–∫–∞ 136
- **–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:** –£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ - —Ç–µ–ø–µ—Ä—å –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –í–°–ï –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –¥–µ–ø–æ–∑–∏—Ç—ã —Å —Ç–µ–º –∂–µ hash –¥–ª—è —Ç–∏–ø–æ–≤ TON_DEPOSIT –∏ FARMING_DEPOSIT
- **–ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
  ```typescript
  const shouldBlock = existingNotFailed && (type === 'TON_DEPOSIT' || type === 'FARMING_DEPOSIT');
  ```
- **–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** –í—Ç–æ—Ä–æ–π –¥–µ–ø–æ–∑–∏—Ç —Å —Ç–µ–º –∂–µ BOC –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π "—É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω"
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢

#### 2. –ü–†–û–í–ï–†–ö–ê –¢–†–ê–ù–ó–ê–ö–¶–ò–ô - –ò–°–ü–†–ê–í–õ–ï–ù–û ‚úÖ 
- **–§–∞–π–ª:** `modules/wallet/service.ts` —Å—Ç—Ä–æ–∫–∞ 446
- **–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
- **–ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
  ```typescript
  if (!newTransaction || !newTransaction.id) {
    logger.error('[WalletService] –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ –≤ –ë–î');
    return { success: false, error: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –∑–∞–ø–∏—Å–∞–ª–∞—Å—å –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö' };
  }
  ```
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** API –Ω–µ –≤–µ—Ä–Ω–µ—Ç —É—Å–ø–µ—Ö –µ—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –∑–∞–ø–∏—Å–∞–ª–∞—Å—å –≤ –ë–î
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢

#### 3. API –ë–ê–õ–ê–ù–°–ê - –¢–†–ï–ë–£–ï–¢ –î–û–†–ê–ë–û–¢–ö–ò ‚ö†Ô∏è
- **–§–∞–π–ª:** `modules/wallet/controller.ts` —Å—Ç—Ä–æ–∫–∞ 257
- **–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:** –î–æ–±–∞–≤–ª–µ–Ω fallback –Ω–∞ telegram.user.id –∏–∑ JWT
- **–ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
  ```typescript
  const userId = req.query.user_id as string || telegram.user?.id?.toString();
  ```
- **–ü—Ä–æ–±–ª–µ–º–∞:** telegram.user –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ middleware
- **–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –° –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º user_id —Ä–∞–±–æ—Ç–∞–µ—Ç, –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ - –ù–ï–¢

### üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ù–ê–•–û–î–ö–ò:

#### 1. –î–ï–ü–û–ó–ò–¢–´ –¢–ï–†–Ø–Æ–¢–°–Ø - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ë–î
- **–î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–û**: User 324 - –¥–µ–ø–æ–∑–∏—Ç –ø–æ–∫–∞–∑–∞–ª —É—Å–ø–µ—Ö (ID: 1961063), –Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ù–ï –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î
- **–û–ë–ù–û–í–õ–ï–ù–ò–ï**: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ü–û–Ø–í–ò–õ–ê–°–¨ –≤ –ë–î (6 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π), –±–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–∏–ª—Å—è –¥–æ 20 TON
- **–í–´–í–û–î**: –ï—Å—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–≤–µ—Ç–æ–º API –∏ –∑–∞–ø–∏—Å—å—é –≤ –ë–î
- **–í–ª–∏—è–Ω–∏–µ**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —É—Å–ø–µ—Ö, –Ω–æ –¥–∞–Ω–Ω—ã–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π

#### 2. –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø –ü–û–õ–ù–û–°–¢–¨–Æ –°–õ–û–ú–ê–ù–ê
- **–ü—Ä–∏—á–∏–Ω–∞**: –£—Å–ª–æ–≤–∏–µ `shouldBlock` –≤ TransactionService.ts —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–æ–µ
- **–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ**: User 25 —Å–º–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω BOC –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ (–±–∞–ª–∞–Ω—Å –≤—ã—Ä–æ—Å —Å 22 –¥–æ 487 TON)
- **–ö–æ–¥ –ø—Ä–æ–±–ª–µ–º—ã**: –°—Ç—Ä–æ–∫–∏ 132-167 –≤ core/TransactionService.ts
- **–†–∏—Å–∫**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å

#### 3. –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –ü–ê–†–ê–ú–ï–¢–†–û–í API
- **–°–∏–º–ø—Ç–æ–º**: –ë–∞–ª–∞–Ω—Å –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –¥–µ–ø–æ–∑–∏—Ç–∞
- **–ü—Ä–∏—á–∏–Ω–∞**: API `/api/v2/wallet/balance` —Ç—Ä–µ–±—É–µ—Ç `user_id`, frontend –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç
- **–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ**: –° `user_id=25`: 287 TON ‚úÖ, –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: null ‚ùå

#### 4. –ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê
- **–°–∏–º–ø—Ç–æ–º**: Controller –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—Ö –î–û –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤ –ë–î
- **–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ**: User 324 - API –≤–µ—Ä–Ω—É–ª —É—Å–ø–µ—Ö, –Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ—è–≤–∏–ª–∞—Å—å –ø–æ–∑–∂–µ
- **–ú–µ—Ö–∞–Ω–∏–∑–º**: –í–µ—Ä–æ—è—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑ await

### –ú–ï–•–ê–ù–ò–ó–ú –ü–†–û–ë–õ–ï–ú–´:
1. WalletController –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—Ö –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ —Ñ–æ–Ω–µ
3. –ü—Ä–∏ –æ–±—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–ª–∏ –æ—à–∏–±–∫–µ - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å—Å—è
4. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑-–∑–∞ —Å—Ç—Ä–æ–≥–∏—Ö —É—Å–ª–æ–≤–∏–π

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã:
- core/TransactionService.ts (–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è)
- modules/wallet/service.ts (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤)
- modules/wallet/controller.ts (API endpoints)
- utils/tonDepositFallback.ts (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ)