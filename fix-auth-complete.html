<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ UniFarm</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .step { margin: 20px 0; padding: 15px; border-left: 4px solid #4CAF50; background: #f9f9f9; }
        .critical { border-left-color: #f44336; background: #ffebee; }
        .success { border-left-color: #4CAF50; background: #e8f5e9; }
        button { padding: 10px 20px; margin: 5px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #45a049; }
        .code { background: #f4f4f4; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
        .token-display { word-break: break-all; background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ UniFarm</h1>
        
        <div class="step critical">
            <h3>üéØ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:</h3>
            <p><strong>JWT —Ç–æ–∫–µ–Ω –≤ localStorage —Å–æ–¥–µ—Ä–∂–∏—Ç userId: 48</strong>, –∏–∑-–∑–∞ —á–µ–≥–æ –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 48.</p>
            <p>Middleware –∏—Å–ø—Ä–∞–≤–ª–µ–Ω, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.</p>
        </div>

        <div class="step">
            <h3>üìã –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:</h3>
            <ol>
                <li>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π JWT —Ç–æ–∫–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</li>
                <li>–û—á–∏—Å—Ç–∏—Ç—å localStorage –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ —Ç–æ–∫–µ–Ω–∞</li>
                <li>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π JWT —Ç–æ–∫–µ–Ω</li>
                <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</li>
            </ol>
        </div>

        <div class="step">
            <h3>üé´ –ù–æ–≤—ã–π JWT —Ç–æ–∫–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
            <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID: <strong>61</strong> (telegram_id: 123456789)</p>
            <div id="newToken" class="token-display">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...</div>
            <button onclick="generateNewToken()">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω</button>
        </div>

        <div class="step">
            <h3>üßπ –®–∞–≥ 1: –û—á–∏—Å—Ç–∫–∞ localStorage</h3>
            <button onclick="clearOldTokens()">–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã</button>
            <div id="clearResult"></div>
        </div>

        <div class="step">
            <h3>üîë –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞</h3>
            <button onclick="setNewToken()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω</button>
            <div id="setResult"></div>
        </div>

        <div class="step">
            <h3>üß™ –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <button onclick="testNewAuth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
            <div id="testResult"></div>
        </div>

        <div class="step success">
            <h3>‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
            <p>–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è API –¥–æ–ª–∂–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å <strong>user_id: 61</strong> –≤–º–µ—Å—Ç–æ 48</p>
        </div>
    </div>

    <script>
        let newJWTToken = '';

        async function generateNewToken() {
            try {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞
                const response = await fetch('/api/v2/auth/generate-test-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: 61,
                        telegram_id: 123456789,
                        username: 'test_user_61',
                        ref_code: 'REF_TEST_61'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    newJWTToken = data.token;
                    document.getElementById('newToken').textContent = newJWTToken;
                } else {
                    // Fallback - —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–æ–∫–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    newJWTToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjYxLCJ0ZWxlZ3JhbV9pZCI6MTIzNDU2Nzg5LCJ1c2VybmFtZSI6InRlc3RfdXNlcl82MSIsInJlZl9jb2RlIjoiUkVGX1RFU1RfNjEiLCJpYXQiOjE3NTE2NDk0MDAsImV4cCI6MTc1MjI1NDIwMH0.test_token';
                    document.getElementById('newToken').textContent = '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–∫–µ–Ω';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞:', error);
                newJWTToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjYxLCJ0ZWxlZ3JhbV9pZCI6MTIzNDU2Nzg5LCJ1c2VybmFtZSI6InRlc3RfdXNlcl82MSIsInJlZl9jb2RlIjoiUkVGX1RFU1RfNjEiLCJpYXQiOjE3NTE2NDk0MDAsImV4cCI6MTc1MjI1NDIwMH0.test_token';
                document.getElementById('newToken').textContent = '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback —Ç–æ–∫–µ–Ω';
            }
        }

        function clearOldTokens() {
            // –û—á–∏—â–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–ª—é—á–∏ JWT —Ç–æ–∫–µ–Ω–æ–≤
            const tokenKeys = [
                'authToken', 
                'jwt_token', 
                'telegram_jwt', 
                'user_token',
                'access_token',
                'token'
            ];
            
            let clearedCount = 0;
            tokenKeys.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    clearedCount++;
                }
            });
            
            // –¢–∞–∫–∂–µ –æ—á–∏—â–∞–µ–º sessionStorage
            tokenKeys.forEach(key => {
                if (sessionStorage.getItem(key)) {
                    sessionStorage.removeItem(key);
                    clearedCount++;
                }
            });
            
            document.getElementById('clearResult').innerHTML = 
                `<div style="color: green;">‚úÖ –û—á–∏—â–µ–Ω–æ ${clearedCount} —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ localStorage/sessionStorage</div>`;
        }

        function setNewToken() {
            if (!newJWTToken) {
                document.getElementById('setResult').innerHTML = 
                    '<div style="color: red;">‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω</div>';
                return;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
            localStorage.setItem('authToken', newJWTToken);
            localStorage.setItem('jwt_token', newJWTToken);
            
            document.getElementById('setResult').innerHTML = 
                '<div style="color: green;">‚úÖ –ù–æ–≤—ã–π JWT —Ç–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ localStorage</div>';
        }

        async function testNewAuth() {
            if (!newJWTToken) {
                document.getElementById('testResult').innerHTML = 
                    '<div style="color: red;">‚ùå –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω</div>';
                return;
            }
            
            try {
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º API —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
                const response = await fetch('/api/v2/users/profile', {
                    headers: {
                        'Authorization': `Bearer ${newJWTToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const userId = data.data?.user?.id;
                    const telegramId = data.data?.user?.telegram_id;
                    
                    let resultHtml = `
                        <div style="color: ${userId === 61 ? 'green' : 'red'};">
                            ${userId === 61 ? '‚úÖ' : '‚ùå'} API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç user_id: ${userId}
                        </div>
                        <div>Telegram ID: ${telegramId}</div>
                        <div>Username: ${data.data?.user?.username}</div>
                    `;
                    
                    if (userId === 61) {
                        resultHtml += '<div style="color: green; font-weight: bold;">üéâ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ê!</div>';
                    } else {
                        resultHtml += '<div style="color: red;">‚ùå Middleware –µ—â—ë –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞.</div>';
                    }
                    
                    document.getElementById('testResult').innerHTML = resultHtml;
                } else {
                    document.getElementById('testResult').innerHTML = 
                        `<div style="color: red;">‚ùå API Error: ${response.status} ${response.statusText}</div>`;
                }
            } catch (error) {
                document.getElementById('testResult').innerHTML = 
                    `<div style="color: red;">‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.message}</div>`;
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            generateNewToken();
        };
    </script>
</body>
</html>