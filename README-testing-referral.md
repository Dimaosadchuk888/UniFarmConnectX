# Тестирование 20 уровней реферальной программы UniFarm

Данный документ описывает методику тестирования 20 уровней реферальной программы в UniFarm.

## Требования к реферальной программе

1. **Поддержка 20 уровней** - пользователь получает бонусы не только от своих прямых рефералов (1 уровень), но и от рефералов своих рефералов (2 уровень) и так далее до 20 уровня.

2. **Процентные ставки вознаграждения**:
   - Уровень 1: 100% реферального бонуса
   - Уровень 2: 20% реферального бонуса 
   - Уровень 3: 15% реферального бонуса
   - Уровень 4: 10% реферального бонуса
   - Уровень 5: 5% реферального бонуса
   - Уровни 6-20: по 2% реферального бонуса каждый

3. **"Income from income"** - механизм, при котором пользователь получает процент от дохода, полученного своими рефералами от фарминга, а не только от их депозитов.

## Подготовленные инструменты для тестирования

Для тестирования реферальной программы разработаны следующие инструменты:

1. **check-referral-levels.js** - скрипт для проверки существующих реферальных связей и транзакций, анализирует соответствие начислений процентным ставкам.

2. **test-referral-structure.js** - инструмент для создания тестовой 20-уровневой структуры и проверки работы начислений.

3. **create-test-users-api.js** - скрипт для создания тестовых пользователей и реферальных связей непосредственно через API.

## Методика тестирования

### Метод 1: Изолированное тестирование через API

Этот метод использует `create-test-users-api.js` для создания изолированной тестовой структуры:

1. Установить количество уровней для тестирования в CONFIG.LEVELS (от 3 до 20).
2. Запустить скрипт: `node create-test-users-api.js`
3. Скрипт выполнит следующие действия:
   - Создаст тестовых пользователей с префиксом `test_ref_`
   - Выстроит между ними реферальную цепочку
   - Создаст депозит и выполнит harvest для пользователя самого нижнего уровня
   - Проверит транзакции для всех пользователей в цепочке

### Метод 2: Тестирование через прямые SQL-запросы

При необходимости можно использовать прямые SQL-запросы для тестирования:

```sql
-- Создание тестовых пользователей
INSERT INTO users (username, guest_id, ref_code) 
VALUES ('test_ref_0', 'test-0', 'TESTAAA0') RETURNING id;
-- Повторить для всех уровней

-- Создание реферальных связей
INSERT INTO referrals (user_id, inviter_id, level)
VALUES (2, 1, 1); -- ID инвайти, ID инвайтера, уровень
```

### Метод 3: Поэтапное тестирование

1. Начать с тестирования 3-5 уровней, убедиться что все работает корректно.
2. Постепенно увеличивать количество уровней до 10, 15 и 20.
3. На каждом этапе анализировать результаты с помощью `check-referral-levels.js`.

## Проверка результатов

После запуска тестов используйте скрипт `check-referral-levels.js` для анализа существующих данных:

```bash
node check-referral-levels.js
```

Скрипт выполнит следующие проверки:
- Наличие реферальных связей до 20 уровня
- Наличие реферальных транзакций для всех уровней
- Соответствие начисленных сумм указанным процентным ставкам

## Расчёт ожидаемых бонусов

Для ручной проверки корректности начислений, вы можете использовать следующую формулу:

```
Бонус для уровня N = (Сумма заработка рефералов уровня N) × (Процент для уровня N)
```

Например, если пользователь уровня 3 заработал 100 UNI, то пользователь уровня 2 получит бонус:
```
100 UNI × 15% = 15 UNI
```

А пользователь уровня 1 получит:
```
15 UNI × 20% = 3 UNI
```

## Обработка ошибок и ограничения

1. **Timeout в Replit** - операции в Replit ограничены 20 секундами, поэтому для тестирования полной 20-уровневой структуры может потребоваться разбить тесты на части.

2. **Сброс состояния** - если тестовые данные нужно удалить, можно использовать следующий SQL-запрос:
```sql
DELETE FROM users WHERE username LIKE 'test\_ref\_%';
```

3. **Отладка** - в случае проблем, проверяйте логи сервера и таблицы транзакций на наличие ошибок.

## Дополнительные проверки

1. **Проверка процентной ставки для каждого уровня**
   - Для каждого уровня создать изолированный тест с одним пользователем
   - Проверить, что вознаграждение точно соответствует заданной процентной ставке

2. **Проверка накопительного эффекта**
   - Создать длинную цепочку рефералов
   - Проверить, что каждый пользователь получает вознаграждение от всех нижестоящих уровней

3. **Проверка распределения вознаграждений от фарминга**
   - Убедиться, что механизм "income from income" работает корректно
   - Проверить, что вознаграждения распределяются при операции harvest