# Руководство по тестированию 20-уровневой реферальной программы

Данное руководство описывает методы безопасного тестирования реферальной программы UniFarm с 20 уровнями, для проверки корректности распределения реферальных бонусов без риска повреждения работающей системы.

## Обзор реферальной программы

Реферальная программа UniFarm имеет следующие характеристики:
- 20 уровней реферальной структуры
- Различные процентные ставки для каждого уровня:
  - Уровень 1: 100%
  - Уровень 2: 20%
  - Уровень 3: 15%
  - Уровень 4: 10%
  - Уровень 5: 5%
  - Уровни 6-20: по 2% каждый
- Доход от дохода: реферальные бонусы начисляются от заработка приглашенных пользователей

## Подготовка к тестированию

### Предварительные шаги

1. Убедитесь, что вы находитесь в режиме разработки
2. Сделайте резервную копию текущих данных (если необходимо)
3. Проверьте наличие необходимых скриптов для тестирования

### Необходимые скрипты

В репозитории подготовлены следующие скрипты для безопасного тестирования:

1. `test-referral-structure.js` - создает полную 20-уровневую реферальную структуру и тестирует распределение бонусов
2. `check-referral-levels.js` - анализирует существующие реферальные транзакции и проверяет корректность начислений

## Методы тестирования

### Метод 1: Создание полной тестовой структуры

Этот метод создает с нуля 20-уровневую структуру рефералов с тестовыми пользователями.

```bash
# Запуск скрипта создания и тестирования реферальной структуры
node test-referral-structure.js
```

Скрипт выполнит следующие действия:
1. Создаст 20 тестовых пользователей (с префиксом "test_ref_lvl_")
2. Установит реферальные связи между ними
3. Создаст депозит для пользователя последнего уровня
4. Запустит harvest для проверки распределения реферальных бонусов
5. Проверит транзакции всех пользователей в структуре

### Метод 2: Анализ существующих данных

Если в системе уже есть реферальные связи и транзакции, можно проанализировать их без создания новых тестовых данных.

```bash
# Запуск скрипта анализа существующих реферальных данных
node check-referral-levels.js
```

Скрипт выполнит следующие действия:
1. Получит текущую структуру реферальной программы
2. Проанализирует реферальные транзакции по уровням
3. Проверит соответствие начислений установленным процентным ставкам
4. Сформирует подробный отчет о результатах анализа

### Метод 3: Ручное тестирование через API

Для более гибкого тестирования можно использовать API-запросы:

```bash
# 1. Создание реферальной связи
curl -X POST -H "Content-Type: application/json" -H "x-development-mode: true" \
  -d '{"userId": 2, "inviterId": 1}' \
  https://93cb0060-75d7-4281-ac65-b204cda864a4-00-1j7bpbfst9vfx.pike.replit.dev:3000/api/referral/create-relationship

# 2. Создание депозита
curl -X POST -H "Content-Type: application/json" -H "x-development-mode: true" -H "x-development-user-id: 2" \
  -d '{"amount": "1000"}' \
  https://93cb0060-75d7-4281-ac65-b204cda864a4-00-1j7bpbfst9vfx.pike.replit.dev:3000/api/uni-farming/deposit

# 3. Запуск операции harvest
curl -X POST -H "Content-Type: application/json" -H "x-development-mode: true" -H "x-development-user-id: 2" \
  https://93cb0060-75d7-4281-ac65-b204cda864a4-00-1j7bpbfst9vfx.pike.replit.dev:3000/api/uni-farming/harvest
```

## Проверка результатов

### Через веб-интерфейс

1. Откройте страницу "Партнерская программа" для вашего основного пользователя
2. Проверьте наличие рефералов и начисления
3. Проверьте историю транзакций на наличие реферальных начислений

### Через скрипты проверки

```bash
# Проверка транзакций конкретного пользователя
node scripts/check-transactions.js --user-id 1
```

### В базе данных (только при необходимости)

```sql
-- Проверка реферальных связей
SELECT * FROM referrals WHERE inviter_id = 1;

-- Проверка реферальных транзакций
SELECT * FROM transactions WHERE user_id = 1 AND type LIKE '%referral%';
```

## Очистка после тестирования

После завершения тестирования может потребоваться очистка тестовых данных:

```bash
# Очистка тестовых пользователей (если они больше не нужны)
node scripts/cleanup-test-data.js --prefix test_ref_lvl
```

## Советы по безопасному тестированию

1. **Всегда используйте режим разработки** для тестирования
2. **Используйте префиксы для тестовых пользователей** (например, "test_") для легкого определения и удаления
3. **Тестируйте с небольшими суммами** (до 1000 UNI), чтобы избежать аномалий
4. **Не модифицируйте базу данных напрямую** – используйте API или существующие скрипты
5. **Делайте паузы между операциями** для корректной обработки всех транзакций
6. **Проверяйте логи после каждой операции** на наличие ошибок

## Частые проблемы и их решение

### Транзакции не появляются в истории

**Решение:** Убедитесь, что harvest операция успешно завершена и прошло достаточно времени для обработки всех реферальных начислений (10-15 секунд).

### Некорректные процентные ставки

**Решение:** Проверьте конфигурацию процентных ставок в `referralBonusService.ts` и убедитесь, что она соответствует документации.

### Не отображаются все уровни реферальной программы

**Решение:** Убедитесь, что в тестовой структуре созданы связи для всех 20 уровней и для каждого уровня есть активность, генерирующая реферальные бонусы.

## Заключение

Тестирование реферальной программы требует особой тщательности, чтобы не повредить рабочую систему. Используя описанные выше безопасные методы тестирования, вы можете проверить корректность функционирования всех 20 уровней реферальной программы без риска для системы.