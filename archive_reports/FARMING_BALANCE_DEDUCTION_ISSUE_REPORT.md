# FARMING BALANCE DEDUCTION ISSUE - –ü–û–õ–ù–û–ï –†–ï–®–ï–ù–ò–ï

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–´

### –ü—Ä–æ–±–ª–µ–º–∞
**–§–∞—Ä–º–∏–Ω–≥-–¥–µ–ø–æ–∑–∏—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è, –Ω–æ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è**

### –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
```bash
# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞–ª–æ:
1. BalanceManager.subtractBalance() —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ - —Å–ø–∏—Å–∞–ª 1 UNI
2. API /users/profile –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: 549 UNI  
3. Frontend BalanceCard –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–π –±–∞–ª–∞–Ω—Å: 550 UNI
4. –§–∞—Ä–º–∏–Ω–≥ –¥–µ–ø–æ–∑–∏—Ç—ã —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç totalDepositAmount —Å 1351.1 –¥–æ 1352.1 UNI
```

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞
**Frontend state –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å API** - –ø—Ä–æ–±–ª–µ–º–∞ –≤ React state management, –Ω–µ –≤ backend –ª–æ–≥–∏–∫–µ.

---

## üõ†Ô∏è –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –†–ï–®–ï–ù–ò–ï

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Ä—è–¥–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ UniFarmingCard
**–§–∞–π–ª**: `client/src/components/farming/UniFarmingCard.tsx`

```typescript
// ‚ùå –ë–´–õ–û:
onSuccess: (response) => {
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –î–û –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
  success('–î–µ–ø–æ–∑–∏—Ç —Å–æ–∑–¥–∞–Ω!');
  
  // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –±–µ–∑ await
  refreshBalance(true);
  queryClient.invalidateQueries(...);
}

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û:
onSuccess: async (response) => {
  // 1. –ñ–¥–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UserContext
  await refreshBalance(true);
  
  // 2. –ñ–¥–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è React Query –∫—ç—à–∞
  await queryClient.invalidateQueries(...);
  
  // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ü–û–°–õ–ï –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  success('–î–µ–ø–æ–∑–∏—Ç —Å–æ–∑–¥–∞–Ω!');
}
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞
**–ü—Ä–æ–±–ª–µ–º–∞**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `userData.balance_uni` –≤–º–µ—Å—Ç–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –∏–∑ UserContext

```typescript
// ‚ùå –ë–´–õ–û:
const balanceStr = userData?.balance_uni;

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û:
const { uniBalance } = useUser();
const balanceStr = uniBalance;
```

### 3. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ race condition –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –î–æ–±–∞–≤–ª–µ–Ω `await` –¥–ª—è –≤—Å–µ—Ö –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ‚Üí –ø–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –∏–∑ UserContext

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –ü—Ä–æ–≤–µ—Ä–∫–∞ BalanceManager (‚úÖ –†–ê–ë–û–¢–ê–ï–¢)
```bash
tsx test-balance-manager.js
# –†–µ–∑—É–ª—å—Ç–∞—Ç: –±–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω–∏–ª—Å—è —Å 550 –Ω–∞ 549 UNI
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ API (‚úÖ –†–ê–ë–û–¢–ê–ï–¢)
```bash
curl /api/v2/users/profile
# –†–µ–∑—É–ª—å—Ç–∞—Ç: balance_uni: 549
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ Frontend (‚ùå –¢–†–ï–ë–£–ï–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø)
```
BalanceCard –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: 550 UNI (—Å—Ç–∞—Ä—ã–π)
–ù—É–∂–Ω–æ: –ø–æ–∫–∞–∑–∞—Ç—å 549 UNI (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π)
```

---

## üìã –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –≠—Ç–∞–ø 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å React state sync (‚úÖ –í–´–ü–û–õ–ù–ï–ù–û)
- [x] –ü–æ—Ä—è–¥–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ onSuccess
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞ –∏–∑ UserContext
- [x] Async/await –¥–ª—è –≤—Å–µ—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

### –≠—Ç–∞–ø 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UserContext
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É refreshBalance()
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å API
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –≤ UI

### –≠—Ç–∞–ø 3: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- [ ] –°–æ–∑–¥–∞—Ç—å –¥–µ–ø–æ–∑–∏—Ç —á–µ—Ä–µ–∑ UI
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏

---

## ‚öôÔ∏è –î–ï–¢–ê–õ–ò BACKEND –°–ò–°–¢–ï–ú–´

### BalanceManager (‚úÖ –†–ê–ë–û–¢–ê–ï–¢)
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –≤ Supabase
- –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### FarmingService (‚úÖ –†–ê–ë–û–¢–ê–ï–¢) 
- –°–æ–∑–¥–∞–µ—Ç –¥–µ–ø–æ–∑–∏—Ç—ã –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç totalDepositAmount
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å BalanceManager
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç subtractBalance()

### API Routes (‚úÖ –†–ê–ë–û–¢–ê–Æ–¢)
- /api/v2/uni-farming/deposit –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
- /api/v2/users/profile –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ JWT —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
1. ‚úÖ –î–µ–ø–æ–∑–∏—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è (totalDepositAmount —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è)
2. ‚úÖ –ë–∞–ª–∞–Ω—Å —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ backend (BalanceManager)
3. ‚úÖ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å
4. ‚úÖ Frontend –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
5. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

---

## üîß –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –ü–†–û–ò–ó–í–û–î–°–¢–í–£

**–°—Ç–∞—Ç—É—Å**: 95% –≥–æ—Ç–æ–≤–æ
**–ì–æ—Ç–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**: Backend, API, Database
**–¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏**: Frontend state synchronization

**–í—ã–≤–æ–¥**: –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞, —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

---

## üìä –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –†–ï–ó–Æ–ú–ï

### –ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤:
- ‚ùå BalanceManager.subtractBalance()
- ‚ùå FarmingService.depositUniForFarming()
- ‚ùå API endpoints
- ‚ùå Database —Å—Ö–µ–º–µ

### –ü—Ä–æ–±–ª–µ–º–∞ –í:
- ‚úÖ React state synchronization
- ‚úÖ Frontend cache management
- ‚úÖ –ü–æ—Ä—è–¥–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ UI

**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å frontend state management –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å API.