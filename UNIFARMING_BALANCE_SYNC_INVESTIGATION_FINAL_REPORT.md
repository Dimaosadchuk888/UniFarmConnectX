# üß† –ì–õ–£–ë–û–ö–û–ï –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò –ë–ê–õ–ê–ù–°–ê UNI FARMING
## –î–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞

### üìã –†–ï–ó–Æ–ú–ï –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø

**–°—Ç–∞—Ç—É—Å**: –í—ã—è–≤–ª–µ–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –¥–≤—É–º—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: –í–´–°–û–ö–ê–Ø - –±–∞–ª–∞–Ω—Å—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞**: –ö–æ–Ω—Ñ–ª–∏–∫—Ç –º–µ–∂–¥—É BatchBalanceProcessor –∏ BalanceManager –≤ –æ—Ç–ø—Ä–∞–≤–∫–µ WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

---

## A. üîÅ –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–ê–Ø –¶–ï–ü–û–ß–ö–ê –î–ê–ù–ù–´–•

### –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:
```
farmingScheduler ‚Üí BatchBalanceProcessor ‚Üí –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚Üí BalanceNotificationService ‚Üí WebSocket ‚Üí Frontend UI
```

### –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞:

1. **farmingScheduler.ts** (—Å—Ç—Ä–æ–∫–∏ 142-149)
   - –í—ã–∑—ã–≤–∞–µ—Ç `BatchBalanceProcessor.processFarmingIncome()` —Å –º–∞—Å—Å–∏–≤–æ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π
   - –°–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ FARMING_REWARD –≤ –ë–î (—Å—Ç—Ä–æ–∫–∏ 204-218)

2. **BatchBalanceProcessor.ts** (—Å—Ç—Ä–æ–∫–∏ 112-122, 176-251)
   - `processFarmingIncome()` —Å–æ–∑–¥–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `processBatch()`
   - `processBulkAdd()` –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤ –ë–î
   - **–ö–†–ò–¢–ò–ß–ù–û**: –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î –ø–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã (—Å—Ç—Ä–æ–∫–∏ 229-234)
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ `BalanceNotificationService` (—Å—Ç—Ä–æ–∫–∏ 236-250)

3. **BalanceNotificationService.ts** (—Å—Ç—Ä–æ–∫–∏ 66-131)
   - `notifyBalanceUpdate()` –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 2 —Å–µ–∫—É–Ω–¥—ã
   - `sendAggregatedUpdate()` —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç payload —Å –ø–æ–ª—è–º–∏:
     ```javascript
     {
       type: 'balance_update',
       userId,
       balanceData: {
         balanceUni: latestUpdate.balanceUni,
         balanceTon: latestUpdate.balanceTon,
         changes: { uni, ton },
         sources,
         timestamp
       }
     }
     ```

4. **WebSocket —Å–µ—Ä–≤–µ—Ä** (server/index.ts, —Å—Ç—Ä–æ–∫–∏ 1020-1150)
   - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
   - –ü–µ—Ä–µ–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º

5. **Frontend** (client/src/hooks/useWebSocketBalanceSync.ts)
   - –ü–æ–ª—É—á–∞–µ—Ç `balance_update` –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `refreshBalance(true)`
   - UserContext –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ API –∑–∞–ø—Ä–æ—Å

---

## B. ‚ùå –ù–ê–ô–î–ï–ù–ù–´–ï –û–ë–†–´–í–´ –ò –ö–û–ù–§–õ–ò–ö–¢–´

### 1. **–ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ô –ö–û–ù–§–õ–ò–ö–¢** (–ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞)

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –º–µ–∂–¥—É BatchBalanceProcessor –∏ BalanceManager

**–ü—Ä–æ–±–ª–µ–º–∞**:
- BatchBalanceProcessor –æ–±–Ω–æ–≤–ª—è–µ—Ç –ë–î –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Supabase (—Å—Ç—Ä–æ–∫–∏ 201-211)
- BalanceManager –∏–º–µ–µ—Ç callback `onBalanceUpdate` –¥–ª—è WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- BatchBalanceProcessor –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç BalanceManager, –∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–∞–º
- websocket-balance-integration.ts —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç callback, –Ω–æ –æ–Ω –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ**:
```typescript
// BatchBalanceProcessor.ts, —Å—Ç—Ä–æ–∫–∞ 226-250
const notificationService = BalanceNotificationService.getInstance();
for (const op of operations) {
  // –ü–æ–ª—É—á–∞–µ—Ç –±–∞–ª–∞–Ω—Å—ã –∏–∑ –ë–î
  const { data: userData } = await supabase.from('users').select('balance_uni, balance_ton')...
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é
  notificationService.notifyBalanceUpdate({
    userId: op.userId,
    balanceUni: parseFloat(userData.balance_uni),
    balanceTon: parseFloat(userData.balance_ton),
    // ...
  });
}
```

### 2. **–ü–†–û–ë–õ–ï–ú–ê –° –û–ë–ù–û–í–õ–ï–ù–ò–ï–ú –ë–î**

**–°–∏–º–ø—Ç–æ–º**: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è, –Ω–æ balance_uni –≤ —Ç–∞–±–ª–∏—Ü–µ users –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã**:
1. RPC —Ñ—É–Ω–∫—Ü–∏—è `increment_user_balance` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (—Å—Ç—Ä–æ–∫–∞ 180)
2. Fallback –Ω–∞ —Ä—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. Race condition –º–µ–∂–¥—É —á—Ç–µ–Ω–∏–µ–º –∏ –∑–∞–ø–∏—Å—å—é

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∏–∑ –ª–æ–≥–æ–≤ WebSocket**:
```
[BalanceCard] –¢–µ–∫—É—â–∏–µ –±–∞–ª–∞–Ω—Å—ã: {
  userId: 74,
  uniBalance: 1377201.452588,  // –ù–µ –º–µ–Ω—è–µ—Ç—Å—è
  tonBalance: 872.118945,
  uniFarmingActive: true,
  uniDepositAmount: 553589
}
```

### 3. **MISSING DEPOSIT TRANSACTIONS**

**–§–∞–∫—Ç**: 553,589 UNI –¥–µ–ø–æ–∑–∏—Ç–æ–≤, –Ω–æ 0 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Ç–∏–ø–∞ FARMING_DEPOSIT –≤ –ë–î
**–í—ã–≤–æ–¥**: –î–µ–ø–æ–∑–∏—Ç—ã –±—ã–ª–∏ —Å–¥–µ–ª–∞–Ω—ã —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

---

## C. üîç –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ù–ê–•–û–î–ö–ò

### 1. **–ò–∑–ª–∏—à–µ–∫ –±–∞–ª–∞–Ω—Å–∞**
- –ë–î –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 1,378,507.07 UNI
- –û–∂–∏–¥–∞–µ—Ç—Å—è 1,021,687.42 UNI  
- –ò–∑–ª–∏—à–µ–∫: 356,819.65 UNI
- –í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞: —Ä—É—á–Ω—ã–µ SQL –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–ª–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π

### 2. **WebSocket –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**
- websocket-balance-integration.ts —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç callback —Å changeAmount: 0
- –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –¥–∞–∂–µ –µ—Å–ª–∏ callback –≤—ã–∑—ã–≤–∞–ª—Å—è –±—ã, –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –±—ã

### 3. **Frontend –ø–æ–ª—É—á–∞–µ—Ç –ø—É—Å—Ç—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**
- useWebSocketBalanceSync –≤—ã–∑—ã–≤–∞–µ—Ç refreshBalance
- –ù–æ –±–∞–ª–∞–Ω—Å –≤ –ë–î –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω, –ø–æ—ç—Ç–æ–º—É API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ

---

## D. üìä –í–´–í–û–î–´ –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –ö–æ—Ä–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:
**–î–≤–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç**:
1. BalanceManager (—Å WebSocket callback) - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∞—Ä–º–∏–Ω–≥–∞
2. BatchBalanceProcessor (–ø—Ä—è–º—ã–µ SQL + —Å–≤–æ–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è) - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ë–î

### –¢–æ—á–∫–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞):

1. **core/scheduler/farmingScheduler.ts** (—Å—Ç—Ä–æ–∫–∞ 142)
   - –ó–∞–º–µ–Ω–∏—Ç—å –≤—ã–∑–æ–≤ BatchBalanceProcessor –Ω–∞ BalanceManager.addBalance()

2. **core/BatchBalanceProcessor.ts** (—Å—Ç—Ä–æ–∫–∏ 180-211)
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î –∏–ª–∏ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ RPC —Ñ—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

3. **server/websocket-balance-integration.ts** (—Å—Ç—Ä–æ–∫–∞ 25)
   - –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ changeAmount –≤–º–µ—Å—Ç–æ 0

4. **–°–æ–∑–¥–∞—Ç—å RPC —Ñ—É–Ω–∫—Ü–∏—é –≤ Supabase**:
   ```sql
   CREATE OR REPLACE FUNCTION increment_user_balance(
     p_user_id INTEGER,
     p_uni_amount NUMERIC,
     p_ton_amount NUMERIC
   ) RETURNS void AS $$
   BEGIN
     UPDATE users 
     SET balance_uni = balance_uni + p_uni_amount,
         balance_ton = balance_ton + p_ton_amount
     WHERE id = p_user_id;
   END;
   $$ LANGUAGE plpgsql;
   ```

### –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:
**–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–∂–µ –≤–Ω–µ—Å–µ–Ω—ã –≤ –∫–æ–¥, –Ω–æ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

---

## üìà –ú–ï–¢–†–ò–ö–ò –ü–†–û–ë–õ–ï–ú–´

- **–í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è**: >48 —á–∞—Å–æ–≤ –±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤
- **–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**: –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∞—Ä–º–µ—Ä—ã (36+)
- **–ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è**: ~2,500+ UNI –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å –¥–ª—è –±–∏–∑–Ω–µ—Å–∞**: –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –≤–∏–¥—è—Ç —Å–≤–æ–∏ –¥–æ—Ö–æ–¥—ã