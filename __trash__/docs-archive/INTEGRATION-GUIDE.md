# Руководство по интеграции исправлений в проект UniFarm

## Обзор

Данное руководство содержит подробные инструкции по интеграции исправлений для решения следующих проблем:

1. **Нестабильное подключение к базе данных Neon**
2. **Проблемы с CORS, блокирующие работу Telegram Mini App**
3. **Отсутствие поддержки сессий для авторизации пользователей**
4. **Некорректная обработка данных авторизации от Telegram**

## Предварительные требования

Перед началом убедитесь, что у вас есть:

1. Токен бота Telegram (переменная окружения `TELEGRAM_BOT_TOKEN`)
2. URL подключения к базе данных Neon (переменная окружения `DATABASE_URL`)

## Шаг 1: Применение фикса для базы данных

Это решение применяется в начале работы приложения и обеспечивает стабильное подключение к Neon DB.

### Что нужно сделать:

В файле `server/index.ts` добавьте следующую строку в самом начале, до всех других импортов:

```typescript
// Применяем фикс для стабильного подключения к Neon DB
import '../unified-fix';
```

## Шаг 2: Интеграция исправлений в Express-приложение

Данный шаг применяет исправления CORS, сессий и авторизации Telegram к приложению Express.

### Что нужно сделать:

В файле `server/routes.ts` найдите функцию `registerRoutes` и в начале функции (после создания `app`) добавьте:

```typescript
// Импортируем модуль исправлений
const { applyFixes } = require('../unified-fix');

// Применяем все исправления
applyFixes(app, storage);
```

## Шаг 3: Проверка интеграции

После внедрения исправлений необходимо убедиться, что всё работает корректно.

### Проверка подключения к базе данных:

1. Откройте в браузере URL: `https://ваш-домен.replit.app/api/diag/health`
2. Должен вернуться JSON с информацией о работе сервера
3. Откройте URL: `https://ваш-домен.replit.app/api/diag/db`
4. Должен вернуться JSON с информацией о подключении к базе данных

### Проверка авторизации через Telegram:

Для полноценной проверки необходимо открыть приложение в Telegram Mini App и убедиться, что:
1. Авторизация работает
2. Пользователь успешно создается при первом входе
3. Сессия сохраняется между перезагрузками страницы

## Детали реализации

### 1. Исправление подключения к базе данных:

- Принудительно отключает подключение через Unix сокеты
- Устанавливает переменные окружения для стабильного TCP/IP соединения
- Применяет настройки SSL для Neon DB

### 2. Исправление CORS:

- Правильно настраивает `Access-Control-Allow-Origin` для работы с Telegram
- Добавляет `Access-Control-Allow-Credentials: true` для поддержки cookies
- Настраивает разрешенные заголовки, включая Telegram-специфичные

### 3. Настройка сессий:

- Создает таблицу `sessions` в базе данных (если отсутствует)
- Настраивает cookie с параметрами `secure: true` и `sameSite: 'none'`
- Добавляет методы для работы с авторизацией в объект запроса

### 4. Интеграция с Telegram:

- Проверяет подпись данных initData от Telegram
- Создает маршрут для авторизации `/api/telegram/auth`
- Добавляет функционал для создания нового пользователя и сохранения в сессии

## Диагностические эндпоинты

Для облегчения диагностики проблем добавлены специальные эндпоинты:

- `/api/diag/health` - проверка состояния сервера
- `/api/diag/db` - проверка подключения к базе данных

## Дополнительная информация

### Файлы проекта:

- `unified-fix.js` - основной модуль с исправлениями
- `telegram-integration.js` - специализированные компоненты для Telegram
- `create-sessions-table.sql` - SQL-скрипт для ручного создания таблицы сессий

### Логирование:

Все действия исправлений логируются с префиксом `[UniFarm Fix]`, что позволяет легко отслеживать их работу в логах сервера.

## Возможные проблемы и их решение

### Проблема: Не создалась таблица sessions

**Решение:** Выполните SQL-запрос из файла `create-sessions-table.sql` напрямую в базе данных.

### Проблема: Не работает авторизация через Telegram

**Решение:**
1. Проверьте наличие переменной окружения `TELEGRAM_BOT_TOKEN`
2. Убедитесь, что в заголовке запроса передается `telegram-init-data` или `x-telegram-init-data`

### Проблема: Сессии не сохраняются

**Решение:**
1. Проверьте, что домен телеграма добавлен в разрешенные `origin`
2. Убедитесь, что включена настройка `credentials: true` в CORS
3. Проверьте, что на фронтенде запросы отправляются с опцией `credentials: 'include'`