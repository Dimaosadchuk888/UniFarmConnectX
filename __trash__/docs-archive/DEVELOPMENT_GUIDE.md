# Руководство по разработке UniFarm

## Содержание
1. [Обзор архитектуры](#обзор-архитектуры)
2. [Структура базы данных](#структура-базы-данных)
3. [Система партиционирования и хранения данных](#система-партиционирования-и-хранения-данных)
4. [Руководство по работе с API](#руководство-по-работе-с-api)
5. [Рефакторинг и оптимизация](#рефакторинг-и-оптимизация)
6. [Рекомендации по развертыванию](#рекомендации-по-развертыванию)

## Обзор архитектуры

UniFarm - это платформа для фарминга криптовалют, использующая многоуровневую реферальную систему. Архитектура приложения:

- **Фронтенд**: React + TypeScript с использованием React Query и Shadcn/UI
- **Бэкенд**: Express.js с TypeScript
- **База данных**: PostgreSQL с Drizzle ORM
- **Telegram интеграция**: TelegramWebApp API для мини-приложения
- **Блокчейн**: TON Keeper для управления кошельками

### Схема взаимодействия компонентов:

```
[Клиент] <-> [API (Express.js)] <-> [Бизнес-логика (Service Layer)] <-> [Хранилище (Drizzle ORM)] <-> [PostgreSQL]
```

## Структура базы данных

Подробная информация о структуре базы данных доступна в [DATABASE_STRUCTURE.md](DATABASE_STRUCTURE.md).

Основные таблицы:
- `users` - информация о пользователях
- `transactions` - партиционированная таблица транзакций
- `uni_farming_deposits` - депозиты UNI-фарминга
- `referrals` - реферальная структура
- `farming_snapshots` - снимки состояния фарминга (ежедневные)
- `wallet_snapshots` - снимки балансов (ежедневные)

## Система партиционирования и хранения данных

### Принцип работы партиционирования

Основная таблица `transactions` использует RANGE-партиционирование по дате, что позволяет:

1. Ускорить запросы, работающие с данными за определенный период
2. Упростить архивацию и удаление старых данных
3. Оптимизировать работу индексов

### Жизненный цикл данных

1. Данные записываются в основную таблицу `transactions`, которая автоматически распределяет их по партициям в формате `transactions_YYYY_MM_DD`
2. Ежедневно создаются снимки важных данных в таблицах `farming_snapshots` и `wallet_snapshots`
3. Партиции, содержащие данные старше 7 дней, могут быть безопасно удалены, если для этих дат существуют снимки
4. Система сохраняет агрегированные данные даже после удаления детальных транзакций

### Процесс создания и удаления партиций

#### Автоматическое создание партиций:

```typescript
// Пример из create_auto_partitioned_transactions.ts
CREATE TABLE ${partitionName} PARTITION OF transactions
FOR VALUES FROM ('${format(date, 'yyyy-MM-dd')}') TO ('${format(nextDate, 'yyyy-MM-dd')}');
```

#### Безопасное удаление партиций:

```typescript
// Проверка наличия снимка перед удалением
const hasSnapshot = await checkSnapshotExists(dateToCheck);
const daysOld = differenceInDays(today, dateToCheck);

// Удаляем только партиции старше 7 дней и имеющие снимки
if (daysOld >= 7 && hasSnapshot) {
  await dropPartition(partitionName, dateToCheck);
}
```

### Cron-задачи по обслуживанию данных

Система включает следующие автоматические задачи:

1. **Ежедневное создание снимков фарминга**: запускается в 00:05
   ```typescript
   cron.schedule('5 0 * * *', runFarmingSnapshotsJob);
   ```

2. **Ежедневное создание снимков кошельков**: запускается в 00:10
   ```typescript
   cron.schedule('10 0 * * *', runWalletSnapshotsJob);
   ```

3. **Удаление старых партиций**: запускается в 03:00
   ```typescript
   cron.schedule('0 3 * * *', runClearOldPartitionsJob);
   ```

## Руководство по работе с API

### Структура API

API использует стандартизованный формат ответа:

```typescript
{
  success: boolean,
  data?: any,
  error?: string
}
```

### Аутентификация и идентификация пользователей

Порядок определения пользователя:
1. `user_id` в параметрах запроса
2. Пользователь из сессии
3. `telegram_id` из TelegramWebApp данных
4. `guest_id` из параметров

### Транзакции и фарминг

Основные эндпоинты для работы с транзакциями и фармингом:
- `POST /api/farming/deposit` - внести депозит в фарминг
- `POST /api/farming/harvest` - собрать доход от фарминга
- `GET /api/transactions` - получить список транзакций
- `GET /api/farming/info` - получить информацию о фарминге

## Рефакторинг и оптимизация

### Переход на SOLID

Текущий рефакторинг следует принципам SOLID:
- **S**: Single Responsibility - класс отвечает за одну задачу
- **O**: Open/Closed - классы открыты для расширения, закрыты для модификации
- **L**: Liskov Substitution - подтипы могут заменять базовые типы
- **I**: Interface Segregation - разделение интерфейсов
- **D**: Dependency Inversion - зависимость от абстракций

### Оптимизация производительности

1. **Партиционирование таблиц**:
   - До: запросы к таблице `transactions` выполнялись за ~8.864 мс
   - После: ~0.053 мс (ускорение в 167 раз)

2. **Индексы**:
   - Созданы индексы для критичных полей (`user_id`, `type`, `created_at`)
   - Составные индексы для часто используемых комбинаций полей

3. **Архитектурная оптимизация**:
   - Перенос бизнес-логики в сервисный слой
   - Стандартизация API-ответов
   - Централизованная обработка ошибок

## Рекомендации по развертыванию

### Подготовка к развертыванию

1. Выполнить миграции:
   ```bash
   npm run db:migrate
   ```

2. Проверить наличие необходимых cron-задач:
   ```bash
   npx tsx server/scripts/cron_scheduler.ts
   ```

### Мониторинг после развертывания

1. Проверка создания партиций:
   ```sql
   SELECT tablename FROM pg_tables WHERE tablename LIKE 'transactions_%';
   ```

2. Проверка создания снимков:
   ```sql
   SELECT COUNT(*) FROM farming_snapshots WHERE snapshot_date = CURRENT_DATE - INTERVAL '1 day';
   ```

### Рекомендуемые параметры сервера

- **RAM**: от 2GB
- **CPU**: от 2 vCPU
- **База данных**: минимум 50GB дискового пространства для хранения партиций
- **Конфигурация PostgreSQL**:
  - `max_connections = 200`
  - `shared_buffers = 512MB`
  - `work_mem = 16MB`
  - `maintenance_work_mem = 128MB`

---

## Рекомендации по доработке

### Приоритетные задачи:

1. Автоматизированные тесты для cron-задач
2. Система мониторинга партиционирования
3. Панель администратора для управления партициями
4. Дополнительные оптимизации запросов для вложенных реферальных структур