# üéØ –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–ò–ß–ò–ù –°–ü–ò–°–ê–ù–ò–Ø –ë–ê–õ–ê–ù–°–ê

**–î–∞—Ç–∞**: 24 –∏—é–ª—è 2025, 09:10 UTC  
**–°—Ç–∞—Ç—É—Å**: üî¥ **–ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ù–ê–ô–î–ï–ù–ê**  
**–ú–µ—Ç–æ–¥**: –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ë–î –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞

## üö® –ö–õ–Æ–ß–ï–í–ê–Ø –ù–ê–•–û–î–ö–ê: –ê–ö–¢–ò–í–ù–´–ô CONSTRAINT –ù–ï–°–ú–û–¢–†–Ø –ù–ê –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï

### –ö—Ä–∏—Ç–∏—á–Ω–æ–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ:

**–í –ö–û–î–ï**: `tx_hash_unique: null` (–æ—Ç–∫–ª—é—á–µ–Ω–æ –≤ TransactionService.ts:114)  
**–í –ë–î**: `UNIQUE CONSTRAINT "idx_tx_hash_unique_safe"` (–ê–ö–¢–ò–í–ï–ù!)

**–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏**: –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–π tx_hash_unique –ø–æ–ª—É—á–µ–Ω–∞ –æ—à–∏–±–∫–∞:
```
üö® CONSTRAINT –ê–ö–¢–ò–í–ï–ù! 
duplicate key value violates unique constraint "idx_tx_hash_unique_safe"
```

## üîç –ú–ï–•–ê–ù–ò–ó–ú –ü–†–û–ë–õ–ï–ú–´

### –°—Ü–µ–Ω–∞—Ä–∏–π "–∏—Å—á–µ–∑–∞—é—â–∏—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤":

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç TON –¥–µ–ø–æ–∑–∏—Ç** ‚Üí Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å
2. **Backend —Å–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é** ‚Üí –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –ë–î —Å tx_hash_unique = null
3. **–°–µ—Ç–µ–≤–æ–π glitch –∏–ª–∏ retry** ‚Üí Frontend –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å  
4. **–ì–¥–µ-—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∑–∞–ø–æ–ª–Ω—è–µ—Ç tx_hash_unique** ‚Üí (–≤–æ–∑–º–æ–∂–Ω–æ –≤ –¥—Ä—É–≥–æ–º –º–æ–¥—É–ª–µ)
5. **UNIQUE CONSTRAINT —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç** ‚Üí Duplicate key violation
6. **PostgreSQL –¥–µ–ª–∞–µ—Ç ROLLBACK** ‚Üí –£—Å–ø–µ—à–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è
7. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ"** ‚Üí –î–µ–ø–æ–∑–∏—Ç –ø–æ—è–≤–∏–ª—Å—è –∏ –ø—Ä–æ–ø–∞–ª

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è tx_hash_unique:

–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ `tx_hash_unique: null` –≤ –∫–æ–¥–µ, —Å–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å —ç—Ç–æ –ø–æ–ª–µ —á–µ—Ä–µ–∑:
- **WebSocket callback —Ñ—É–Ω–∫—Ü–∏–∏**
- **BalanceManager –ø—Ä—è–º—ã–µ UPDATE'—ã**  
- **BatchBalanceProcessor –æ–ø–µ—Ä–∞—Ü–∏–∏**
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–∏–≥–≥–µ—Ä—ã** (–Ω–∞–π–¥–µ–Ω—ã –≤ SQL —Å–∫—Ä–∏–ø—Ç–∞—Ö)
- **–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏ farming —Å–∏—Å—Ç–µ–º**

## üìä –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê –†–ê–°–•–û–ñ–î–ï–ù–ò–Ø –ë–ê–õ–ê–ù–°–û–í

### User #184 (—Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):
- **–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å**: TON: 0.190783, UNI: 340,256.794304
- **–†–∞—Å—á–µ—Ç –ø–æ 20 –ø–æ—Å–ª–µ–¥–Ω–∏–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º**: –í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–´–ï (–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è)
- **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–ø–∏—Å–∞–Ω–∏—è**: –ó–∞ —Å–µ–≥–æ–¥–Ω—è –ù–ï –ù–ê–ô–î–ï–ù–û –Ω–∏ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ WITHDRAWAL

**–í—ã–≤–æ–¥**: –ë–∞–ª–∞–Ω—Å —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ü–†–Ø–ú–´–ú–ò UPDATE –∑–∞–ø—Ä–æ—Å–∞–º–∏ –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π!

## üîß –ù–ê–ô–î–ï–ù–ù–´–ï SQL –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã —Å —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏:
1. **`scripts/sync-database-to-code-immediate.sql`** - —Å–æ–¥–µ—Ä–∂–∏—Ç CREATE TRIGGER
2. **`scripts/fix-database-inconsistencies.sql`** - —Å–æ–¥–µ—Ä–∂–∏—Ç CREATE TRIGGER  
3. **`docs/SQL_CRITICAL_FIXES_JUNE_28.sql`** - —Å–æ–¥–µ—Ä–∂–∏—Ç CREATE TRIGGER

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã:
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
```

–≠—Ç–∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ø–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞.

## üéØ –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –†–ï–®–ï–ù–ò–ï

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–ë–ï–ó–û–ü–ê–°–ù–´–ï):

1. **–û—Ç–∫–ª—é—á–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π constraint**:
   ```sql
   DROP INDEX IF EXISTS idx_tx_hash_unique_safe;
   ```

2. **–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä—è–º—ã—Ö UPDATE**:
   ```typescript
   // –í BalanceManager –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º UPDATE users
   logger.critical('[DIRECT_BALANCE_UPDATE]', {
     user_id, old_balance, new_balance, stack_trace
   });
   ```

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏**:
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è users.balance_* 
   - –°–æ–ø–æ—Å—Ç–∞–≤–ª—è—Ç—å —Å —Å–æ–∑–¥–∞–Ω–Ω—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** –¥–ª—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–∞
2. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π** —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π BalanceManager
3. **–ê—É–¥–∏—Ç –≤—Å–µ—Ö –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–≤** –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
4. **–ö–æ–Ω—Ç—Ä–æ–ª—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏** –±–∞–ª–∞–Ω—Å–∞ vs —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

## üö® –ö–†–ò–¢–ò–ß–ù–û–°–¢–¨ –ü–†–û–ë–õ–ï–ú–´

### –ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ:
- **–ü–æ—Ç–µ—Ä—è –¥–æ–≤–µ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** - –¥–µ–ø–æ–∑–∏—Ç—ã "–∏—Å—á–µ–∑–∞—é—Ç"
- **–ù–∞—Ä—É—à–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏** - –±–∞–ª–∞–Ω—Å –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º  
- **–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–∞** - –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É—é—Ç—Å—è
- **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–±—ã—Ç–∫–∏** - –Ω–µ—É—á—Ç–µ–Ω–Ω—ã–µ —Å–ø–∏—Å–∞–Ω–∏—è

### –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ —Å–ª—É—á–∞–∏:
- **User #25**: –ñ–∞–ª–æ–±—ã –Ω–∞ –∏—Å—á–µ–∑–∞—é—â–∏–µ 25 TON –¥–µ–ø–æ–∑–∏—Ç—ã
- **User #184**: –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –Ω–∞ —Å–æ—Ç–Ω–∏ —Ç—ã—Å—è—á UNI
- **–°–∏—Å—Ç–µ–º–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: –ó–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –¥–µ–ø–æ–∑–∏—Ç–∞–º–∏

## üí° –ò–¢–û–ì–û–í–´–ô –î–ò–ê–ì–ù–û–ó

**–ü–†–û–ë–õ–ï–ú–ê –ù–ï –í –ö–û–î–ï –ü–û–ü–û–õ–ù–ï–ù–ò–Ø - –ü–†–û–ë–õ–ï–ú–ê –í –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–• –ü–†–û–¶–ï–°–°–ê–• –°–ü–ò–°–ê–ù–ò–Ø!**

–°–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è, –Ω–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (constraint rollbacks, –ø—Ä—è–º—ã–µ UPDATE'—ã, —Ç—Ä–∏–≥–≥–µ—Ä—ã –ë–î) —Å–ø–∏—Å—ã–≤–∞—é—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ –ë–ï–ó –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤ –∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–º—É —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ constraint + –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è).

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥**: –û—Ç–∫–ª—é—á–∏—Ç—å `idx_tx_hash_unique_safe` constraint –∏ –¥–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.