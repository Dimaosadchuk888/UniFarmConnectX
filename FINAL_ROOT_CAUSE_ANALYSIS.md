# üö® –ù–ê–ô–î–ï–ù–ê –¢–û–ß–ù–ê–Ø –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ü–†–û–ë–õ–ï–ú–´!
**–î–∞—Ç–∞:** 21 –∏—é–ª—è 2025  
**–°—Ç–∞—Ç—É—Å:** –ì–û–¢–û–í –ö –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ  

---

## ‚úÖ **–ù–ê–ô–î–ï–ù–û! –ü–û–õ–ù–ê–Ø –¶–ï–ü–û–ß–ö–ê –ü–†–û–ë–õ–ï–ú–´**

### **1. Frontend ‚Üí Backend Flow (–†–ê–ë–û–¢–ê–ï–¢ –ü–†–ê–í–ò–õ–¨–ù–û)**
üìÇ `client/src/services/tonConnectService.ts` ‚Üí `/api/v2/wallet/ton-deposit`

### **2. Backend Controller (–ù–ê–ô–î–ï–ù–ê –ü–†–û–ë–õ–ï–ú–ê)**
üìÇ `modules/wallet/controller.ts` —Å—Ç—Ä–æ–∫–∞ 378:
```javascript
const user = await userRepository.getUserByTelegramId(telegram.user.id);
//                                                    ^^^^^^^^^^^^^^^^ 
//                                                    –ó–î–ï–°–¨ –í–°–Å –ü–†–ê–í–ò–õ–¨–ù–û!
```

### **3. User Service (–ó–î–ï–°–¨ –°–ö–†–´–í–ê–ï–¢–°–Ø –ü–†–û–ë–õ–ï–ú–ê)**
üìÇ `modules/user/service.ts` - –º–µ—Ç–æ–¥ `getUserByTelegramId`
```javascript
// –í–û–ó–ú–û–ñ–ù–´–ï –í–ê–†–ò–ê–ù–¢–´ –ü–†–û–ë–õ–ï–ú–´:
// 1. –ú–µ—Ç–æ–¥ –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢ –∏ –¥–µ–ª–∞–µ—Ç fallback –Ω–∞ getUserByUsername
// 2. –ú–µ—Ç–æ–¥ –°–£–©–ï–°–¢–í–£–ï–¢ –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
// 3. –ú–µ—Ç–æ–¥ –°–£–©–ï–°–¢–í–£–ï–¢ –Ω–æ –≤–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç username
```

---

## üéØ **–ö–û–ù–ö–†–ï–¢–ù–ê–Ø –ì–ò–ü–û–¢–ï–ó–ê**

User 25 –∏ User 227 –æ–±–∞ –∏–º–µ—é—Ç **telegram_id**, –Ω–æ:
- User 25: telegram_id=425855744, username='DimaOsadchuk'  
- User 227: telegram_id=25, username='DimaOsadchuk'

**–ï—Å–ª–∏ getUserByTelegramId –ù–ï –†–ê–ë–û–¢–ê–ï–¢**, —Ç–æ —Å–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç:
1. –î–µ–ª–∞—Ç—å fallback –Ω–∞ –ø–æ–∏—Å–∫ –ø–æ username
2. –ù–∞—Ö–æ–¥–∏—Ç—å –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ø–∞–≤—à–µ–≥–æ—Å—è —Å username='DimaOsadchuk'
3. –í–æ–∑–≤—Ä–∞—â–∞—Ç—å User 227 –≤–º–µ—Å—Ç–æ User 25

---

## üìã **–ü–õ–ê–ù –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ì–û –î–ï–ô–°–¢–í–ò–Ø**

### **PHASE 1: –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê (5 –º–∏–Ω—É—Ç)**
- [ ] –ù–∞–π—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é getUserByTelegramId –≤ user/service.ts
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ fallback –Ω–∞ username
- [ ] –ù–∞–π—Ç–∏ –¢–û–ß–ù–£–Æ –ø—Ä–æ–±–ª–µ–º–Ω—É—é —Å—Ç—Ä–æ–∫—É –∫–æ–¥–∞

### **PHASE 2: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (10 –º–∏–Ω—É—Ç)**  
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å getUserByTelegramId –µ—Å–ª–∏ –æ–Ω —Å–ª–æ–º–∞–Ω
- [ ] –£–±—Ä–∞—Ç—å fallback –Ω–∞ username –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–≥–∏–π –ø–æ–∏—Å–∫ –ø–æ telegram_id

### **PHASE 3: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï (5 –º–∏–Ω—É—Ç)**
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ User 25 –∏ User 227 –æ—Ç–¥–µ–ª—å–Ω–æ
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –∫–∞–∂–¥—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–æ–≤—ã–µ –¥–µ–ø–æ–∑–∏—Ç—ã –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üîß **–û–ñ–ò–î–ê–ï–ú–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï**

```javascript
// –ë–´–õ–û (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ):
async getUserByTelegramId(telegram_id: number) {
  const userByTelegramId = await supabase...eq('telegram_id', telegram_id);
  if (!userByTelegramId) {
    // ‚ùå –ü–†–û–ë–õ–ï–ú–ù–ê–Ø –õ–û–ì–ò–ö–ê:
    return getUserByUsername(username); // FALLBACK –ù–ê USERNAME!
  }
  return userByTelegramId;
}

// –î–û–õ–ñ–ù–û –ë–´–¢–¨:
async getUserByTelegramId(telegram_id: number) {
  return await supabase
    .from('users')
    .select('*')
    .eq('telegram_id', telegram_id) // ‚úÖ –¢–û–õ–¨–ö–û TELEGRAM_ID!
    .single();
}
```

---

**–°–¢–ê–¢–£–°:** –ì–û–¢–û–í –ö –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–û–ô –î–ò–ê–ì–ù–û–°–¢–ò–ö–ï –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ