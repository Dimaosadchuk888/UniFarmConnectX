# üîç –ü–û–õ–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´ –í–´–í–û–î–ê –°–†–ï–î–°–¢–í

**–î–∞—Ç–∞**: 29 –∏—é–ª—è 2025  
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É" –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏  
**–°—Ç–∞—Ç—É—Å**: üü° **–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê - –ù–ê–ô–î–ï–ù–´ –ò–°–¢–û–ß–ù–ò–ö–ò –û–®–ò–ë–ö–ò**

---

## üéØ –ò–°–¢–û–ß–ù–ò–ö–ò –û–®–ò–ë–ö–ò "–ù–ï–¢ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö –ò–ù–¢–ï–†–ù–ï–¢–£"

### üìç **1. Frontend Error Handling (–ü–µ—Ä–≤–∏—á–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)**

**–§–∞–π–ª**: `client/src/lib/correctApiRequest.ts` - —Å—Ç—Ä–æ–∫–∏ 236-245
```typescript
// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
if (error instanceof Error && error.name === 'TypeError' && error.message.includes('fetch')) {
  if (appInitialized) {
    toast({
      title: "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É",  // ‚ùå –í–û–¢ –ò–°–¢–û–ß–ù–ò–ö –û–®–ò–ë–ö–ò
      description: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º",
      variant: "destructive"
    });
  }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –õ—é–±–∞—è –æ—à–∏–±–∫–∞ `fetch()` API –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–æ–±–ª–µ–º–∞ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º, –≤–∫–ª—é—á–∞—è HTTP 401/403/500.

### üìç **2. Withdrawal Service Fallback (–í—Ç–æ—Ä–∏—á–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)**

**–§–∞–π–ª**: `client/src/services/withdrawalService.ts` - —Å—Ç—Ä–æ–∫–∏ 115-121
```typescript
} catch (networkError) {
  console.error(`[submitWithdrawal] [${requestId}] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Å–µ—Ç–µ–≤–æ–º —Å–ª–æ–µ:`, networkError);
  return {
    message: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É',  // ‚ùå –í–¢–û–†–ò–ß–ù–´–ô –ò–°–¢–û–ß–ù–ò–ö
  };
}
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –û–±—â–∏–π catch –±–ª–æ–∫ –¥–ª—è –ª—é–±—ã—Ö –æ—à–∏–±–æ–∫ –∏–∑ `correctApiRequest()`.

### üìç **3. NetworkStatusIndicator Component (–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)**

**–§–∞–π–ª**: `client/src/components/common/NetworkStatusIndicator.tsx`
```typescript
description: "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.",  // ‚ùå –°–ò–°–¢–ï–ú–ù–´–ô –ò–ù–î–ò–ö–ê–¢–û–†
```

---

## üîÑ –ü–û–õ–ù–ê–Ø –¶–ï–ü–û–ß–ö–ê –í–´–í–û–î–ê –°–†–ï–î–°–¢–í

### **Frontend Flow (–†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)**

1. **WithdrawalForm.tsx**: 
   - ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Ä–∞–±–æ—Ç–∞–µ—Ç (TON –∞–¥—Ä–µ—Å, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—É–º–º—ã)
   - ‚úÖ `onSubmit()` –≤—ã–∑—ã–≤–∞–µ—Ç `submitWithdrawal()` –ø—Ä–∞–≤–∏–ª—å–Ω–æ

2. **withdrawalService.ts**:
   - ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - ‚úÖ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ `requestData` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - ‚úÖ –í—ã–∑–æ–≤ `correctApiRequest('/api/v2/wallet/withdraw', 'POST', requestData)` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

### **API Endpoint (–¢—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)**

3. **Backend Routes**: `modules/wallet/routes.ts` - —Å—Ç—Ä–æ–∫–∞ 78
   ```typescript
   router.post('/withdraw', requireTelegramAuth, strictRateLimit, validateBody(withdrawSchema), walletController.withdraw.bind(walletController));
   ```
   - ‚úÖ Endpoint —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: `/api/v2/wallet/withdraw`
   - ‚úÖ –¢—Ä–µ–±—É–µ—Ç `requireTelegramAuth` middleware
   - ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ `withdrawSchema` —Ä–∞–±–æ—Ç–∞–µ—Ç

4. **Controller**: `modules/wallet/controller.ts` - –º–µ—Ç–æ–¥ `withdraw()` (—Å—Ç—Ä–æ–∫–∏ 187-245)
   ```typescript
   const telegram = this.validateTelegramAuth(req, res);
   if (!telegram) return;  // ‚ùå –ó–î–ï–°–¨ –í–û–ó–í–†–ê–©–ê–ï–¢–°–Ø 401 –ë–ï–ó JWT
   ```
   - ‚ö†Ô∏è **–ü–†–û–ë–õ–ï–ú–ê**: –ï—Å–ª–∏ JWT —Ç–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç/–Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω ‚Üí HTTP 401
   - ‚úÖ –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

5. **Service Layer**: `modules/wallet/service.ts` - –º–µ—Ç–æ–¥ `processWithdrawal()`
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ withdrawal requests —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç  
   - ‚úÖ AdminBot notifications –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï API ENDPOINT

### **–ü—Ä—è–º–æ–π —Ç–µ—Å—Ç –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**:
```bash
curl -s http://localhost:3000/api/v2/wallet/withdraw -X POST -H "Content-Type: application/json" -d '{"user_id":184,"amount":"1","currency":"TON","wallet_address":"test"}'
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: `{"success":false,"error":"Authentication required","need_jwt_token":true}`

**–í—ã–≤–æ–¥**: ‚úÖ **API –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û** - –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ç—Ä–µ–±—É–µ—Ç JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é

---

## üö® **–ö–û–†–ï–ù–¨ –ü–†–û–ë–õ–ï–ú–´ –ù–ê–ô–î–ï–ù**

### **–ì–ª–∞–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞**: **JWT Authentication Failure ‚Üí Network Error Misinterpretation**

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**: –ó–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É –∏ –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É"
2. **Frontend**: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å –±–µ–∑ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ JWT —Ç–æ–∫–µ–Ω–∞
3. **Backend**: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 401 "Authentication required"  
4. **correctApiRequest.ts**: –ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç 401 –∫–∞–∫ auth error, –ø–∞–¥–∞–µ—Ç –≤ catch –±–ª–æ–∫
5. **Error Handler**: –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –∫–∞–∫ "network error" ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É"

### **–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –æ—à–∏–±–∫–∏**:
```
Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç: POST /api/v2/wallet/withdraw –±–µ–∑ JWT
Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç: 401 Authentication required  
correctApiRequest: –õ–æ–≤–∏—Ç –æ—à–∏–±–∫—É, –Ω–æ –Ω–µ –∫–∞–∫ authentication error
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç: "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É"
```

---

## üí° **–ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø**

### **1. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: Fix Authentication Error Handling**
```typescript
// –í correctApiRequest.ts –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ network error check:
if (response.status === 401) {
  const errorData = await response.json();
  if (errorData.need_jwt_token) {
    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –ù–ï –æ —Å–µ—Ç–∏
    toast({
      title: "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è",
      description: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
      variant: "destructive"
    });
  }
}
```

### **2. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: Enhanced Withdrawal Error Messages**
- –î–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫ –≤—ã–≤–æ–¥–∞
- –†–∞–∑–ª–∏—á–∞—Ç—å authentication, validation, –∏ network errors

### **3. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: JWT Token Management**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—á–µ–º—É JWT —Ç–æ–∫–µ–Ω—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏
- –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

---

## üìä **–°–ò–°–¢–ï–ú–ù–´–ô –°–¢–ê–¢–£–°**

### ‚úÖ **–†–∞–±–æ—Ç–∞—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
- WithdrawalForm.tsx (UI –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è)
- withdrawalService.ts (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤)
- Backend API endpoints (—Ç—Ä–µ–±—É—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é)
- processWithdrawal –ª–æ–≥–∏–∫–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–æ–∫)
- AdminBot notifications (–æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–¥–º–∏–Ω–∞–º)

### ‚ùå **–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
- correctApiRequest.ts (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è 401 errors)
- JWT authentication flow (—Ç–æ–∫–µ–Ω—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏)
- Error messaging (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "network error" –≤–º–µ—Å—Ç–æ "auth error")

### üü° **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏**:
- **LSP Error**: `modules/wallet/controller.ts:475` - Type mismatch –≤ User object
- **Rate Limiting**: Withdrawal endpoint –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `strictRateLimit` 
- **WebSocket Updates**: –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (User 184 –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)

---

## üéØ **–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò**

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å authentication error handling –≤ correctApiRequest.ts
2. **–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ**: –î–æ–±–∞–≤–∏—Ç—å proper JWT token refresh mechanism  
3. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ**: –£–ª—É—á—à–∏—Ç—å error messaging –≤–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ

**–†–ï–ó–£–õ–¨–¢–ê–¢**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥ –∏ –ø–æ–ª—É—á–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–æ –ª–æ–∂–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º.

---

**–°—Ç–∞—Ç—É—Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏**: ‚úÖ **–ó–ê–í–ï–†–®–ï–ù–ê** - –ò—Å—Ç–æ—á–Ω–∏–∫ –æ—à–∏–±–∫–∏ "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É" –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –∏ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω.