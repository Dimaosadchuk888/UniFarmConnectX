# –ü–ª–∞–Ω –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è Telegram start_param –≤ UniFarm

## üìÖ –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 12 —è–Ω–≤–∞—Ä—è 2025

## üéØ –¶–µ–ª—å
–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Telegram start_param –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

### 1. –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

**–¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤:**
1. **Frontend (App.tsx):**
   - URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: `ref_code`, `refCode`
   - sessionStorage: `referrer_code`
   - –ü–µ—Ä–µ–¥–∞—á–∞ –Ω–∞ backend: –ø–æ–ª–µ `ref_by`

2. **Backend (auth/service.ts):**
   - –ü–æ–ª—É—á–µ–Ω–∏–µ `ref_by` –∏–∑ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î: –ø–æ–ª–µ `referred_by`

3. **–•—Ä–∞–Ω–∏–ª–∏—â–∞:**
   - sessionStorage: `referrer_code`
   - localStorage: –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤

### 2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

**Frontend:**
- `client/src/App.tsx` - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `client/src/lib/utils.ts` - —Ñ—É–Ω–∫—Ü–∏—è getReferrerIdFromUrl() (–≥–æ—Ç–æ–≤–∞, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- `client/src/services/referralService.ts` - —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç—ã —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º–∏ –∫–æ–¥–∞–º–∏
- `client/src/utils/referralUtils.ts` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫

**Backend:**
- `modules/auth/controller.ts` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `modules/auth/service.ts` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–≤—è–∑–∏
- `modules/referral/service.ts` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑–µ–π

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
- –¢–∞–±–ª–∏—Ü–∞ `users`, –ø–æ–ª–µ `referred_by` - —Ö—Ä–∞–Ω–µ–Ω–∏–µ ID –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ

### 3. –§–æ—Ä–º–∞—Ç—ã —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:**
- `REF_1234567890_abc123` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç
- `userXXX` - legacy —Ñ–æ—Ä–º–∞—Ç –¥–ª—è start –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
- –õ—é–±–∞—è —Å—Ç—Ä–æ–∫–∞ 6-12 —Å–∏–º–≤–æ–ª–æ–≤ A-Z0-9

### 4. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫:**
   ```typescript
   https://t.me/UniFarmBot/unifarm?startapp=REF_123456
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–∏–∫–ª–æ–≤:**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π –∫–æ–¥
   - –ù–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑–µ–π

3. **–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–π:**
   - 20-—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ (100% –Ω–∞ L1, 2-20% –Ω–∞ L2-L20)
   - –ö–æ–º–∏—Å—Å–∏–∏ –æ—Ç farming –∏ boost –¥–æ—Ö–æ–¥–æ–≤

## üîß –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è start_param

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏)

**1.1 –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π:**
```bash
# –°–æ–∑–¥–∞–µ–º backup –≤–µ—Ç–∫—É
git checkout -b backup/before-start-param
git add .
git commit -m "Backup before start_param implementation"
```

**1.2 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ App.tsx
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ª–∏—á–∏–µ start_param –≤ Telegram WebApp

### –≠—Ç–∞–ø 2: –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**2.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ App.tsx —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é:**
```typescript
// –°—Ç—Ä–æ–∫–∞ 107, –∑–∞–º–µ–Ω—è–µ–º:
const refCode = urlParams.get('ref_code') || urlParams.get('refCode') || 
               sessionStorage.getItem('referrer_code');

// –ù–∞:
import { getReferrerIdFromUrl } from './lib/utils';

// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:
// 1. Telegram start_param (–µ—Å–ª–∏ –µ—Å—Ç—å)
// 2. URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—Ç–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞)
// 3. sessionStorage (fallback)
const telegramRefCode = getReferrerIdFromUrl();
const urlRefCode = urlParams.get('ref_code') || urlParams.get('refCode');
const savedRefCode = sessionStorage.getItem('referrer_code');

// –í—ã–±–∏—Ä–∞–µ–º —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
const refCode = telegramRefCode || urlRefCode || savedRefCode;

// –õ–æ–≥–∏—Ä—É–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
console.log('[App] Referral code sources:', {
  telegram: telegramRefCode,
  url: urlRefCode,
  saved: savedRefCode,
  selected: refCode,
  source: telegramRefCode ? 'telegram' : (urlRefCode ? 'url' : 'saved')
});
```

**2.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ sessionStorage:**
```typescript
// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
if (refCode) {
  sessionStorage.setItem('referrer_code', refCode);
  sessionStorage.setItem('referrer_source', 
    telegramRefCode ? 'telegram' : 'url'
  );
}
```

### –≠—Ç–∞–ø 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

**3.1 –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:**
```typescript
// test-start-param.html
const testScenarios = [
  {
    name: "Telegram start_param",
    setup: () => {
      window.Telegram = {
        WebApp: {
          startParam: "REF_123456_test",
          initData: "..."
        }
      };
    }
  },
  {
    name: "URL ref_code",
    setup: () => {
      window.history.pushState({}, '', '?ref_code=REF_789012_test');
    }
  },
  {
    name: "Combined sources",
    setup: () => {
      window.Telegram.WebApp.startParam = "REF_111_telegram";
      window.history.pushState({}, '', '?ref_code=REF_222_url');
    }
  }
];
```

### –≠—Ç–∞–ø 4: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)

**4.1 –ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑–µ–π:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤
SELECT 
  COUNT(*) as total,
  COUNT(CASE WHEN ref_code LIKE 'REF_%' THEN 1 END) as standard_format,
  COUNT(CASE WHEN ref_code LIKE 'user%' THEN 1 END) as legacy_format
FROM users
WHERE ref_code IS NOT NULL;
```

### –≠—Ç–∞–ø 5: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

**5.1 –ü–æ—ç—Ç–∞–ø–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ:**
1. Deploy —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏)
2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ 24 —á–∞—Å–∞
3. Deploy —Å –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–æ–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤
4. A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)

### –≠—Ç–∞–ø 6: –û—á–∏—Å—Ç–∫–∞

**6.1 –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ –∫–æ–¥–∞:**
- –ù–ï —É–¥–∞–ª—è—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
- –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–æ–≤
- –û—Å—Ç–∞–≤–∏—Ç—å –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Å—Å—ã–ª–æ–∫

## ‚ö†Ô∏è –†–∏—Å–∫–∏ –∏ –∏—Ö –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è

### –†–∏—Å–∫ 1: –ü–æ—Ç–µ—Ä—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑–µ–π
**–ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è:** 
- –°–æ—Ö—Ä–∞–Ω—è–µ–º –í–°–ï –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–Ω–µ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É)
- –î–æ–±–∞–≤–ª—è–µ–º fallback –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ

### –†–∏—Å–∫ 2: –ö–æ–Ω—Ñ–ª–∏–∫—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
**–ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è:**
- –ß–µ—Ç–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: Telegram > URL > Storage
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–¥–∞

### –†–∏—Å–∫ 3: –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–æ–≤
**–ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è:**
- getReferrerIdFromUrl() —É–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã
- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ backend –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

## üìã –ß–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å–æ–∑–¥–∞–Ω—ã
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- [ ] –¢–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã
- [ ] –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞

## üéØ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç:
1. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Telegram start_param
2. **–°–æ—Ö—Ä–∞–Ω—è—Ç—å** –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤—Å–µ—Ö —Ç–µ–∫—É—â–∏—Ö —Å–ø–æ—Å–æ–±–æ–≤ –ø–µ—Ä–µ–¥–∞—á–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –∫–æ–¥–æ–≤
3. **–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å** –∏—Å—Ç–æ—á–Ω–∏–∫ –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
4. **–†–∞–±–æ—Ç–∞—Ç—å** –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üîÑ –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞

–í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º:
```bash
# –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–∞—Ç
git checkout backup/before-start-param -- client/src/App.tsx
npm run build
# Deploy
```

–í—Ä–µ–º—è –æ—Ç–∫–∞—Ç–∞: < 5 –º–∏–Ω—É—Ç