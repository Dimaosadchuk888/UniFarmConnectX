# TON Connect Domain Mismatch Fix Report
**Дата**: 16 января 2025
**Статус**: ✅ Найдена и исправлена критическая проблема

## Найденная проблема

### Корневая причина
TON Connect не может загрузить манифест из-за использования относительного пути в условиях, когда кошелек может пытаться загрузить манифест с другого домена.

### Детали проблемы
1. **Было**: `<TonConnectUIProvider manifestUrl="/tonconnect-manifest.json">`
2. **Проблема**: При относительном пути TON Connect может пытаться загрузить манифест с другого домена
3. **Решение**: Использовать абсолютный URL с текущим доменом

## Внесенные изменения

### 1. Обновлен App.tsx (строка 285)
```jsx
// Было:
<TonConnectUIProvider manifestUrl="/tonconnect-manifest.json">

// Стало:
<TonConnectUIProvider manifestUrl={`${window.location.origin}/tonconnect-manifest.json`}>
```

### 2. Манифесты обновлены правильно
Оба манифеста содержат корректный домен `ab245275`:
- `/tonconnect-manifest.json` ✅
- `/.well-known/tonconnect-manifest.json` ✅

### 3. Создан скрипт автоматической генерации
`scripts/generate-manifests.js` - автоматически обновляет манифесты на основе переменных окружения.

## Дополнительные инструменты для диагностики

### 1. Расширенная диагностическая страница
Создана страница `/ton-connect-diagnostics.html` для глубокого анализа:
- Проверка доступности манифеста
- Тест CORS политики
- Прямое подключение кошелька
- Очистка кэша TON Connect

### 2. Компонент отладки
`TonConnectDebug.tsx` на странице кошелька показывает:
- Статус загрузки манифеста
- Состояние подключения кошелька
- Возможные ошибки

## Что нужно сделать пользователю

1. **Перезагрузить страницу** (Ctrl+F5) для применения изменений

2. **Если проблема сохраняется**, открыть диагностическую страницу:
   ```
   https://uni-farm-connect-x-ab245275.replit.app/ton-connect-diagnostics.html
   ```

3. **Проверить результаты тестов**:
   - Все тесты должны быть зелеными
   - Особое внимание на "Домен в манифесте"
   - CORS заголовки должны быть доступны

4. **Попробовать прямое подключение** через кнопку на диагностической странице

## Возможные причины, если проблема остается

1. **Кэширование на стороне CDN/прокси** - манифест может кэшироваться со старым доменом
2. **Блокировка браузером** - проверить консоль браузера на предмет ошибок CORS
3. **Проблемы с TON Connect SDK** - попробовать очистить кэш через диагностическую страницу

## Архитектурное решение

Теперь манифест всегда загружается с текущего домена приложения, что исключает проблемы с cross-origin запросами и обеспечивает корректную работу в любом окружении (Preview, Production).