# Миграция с Neon DB на PostgreSQL Replit

## Обзор

Этот документ описывает процесс миграции UniFarm с использования облачной PostgreSQL базы данных Neon DB на встроенную PostgreSQL базу данных Replit. Миграция обеспечивает:

1. Снижение зависимости от внешних сервисов
2. Более высокую скорость доступа к данным из-за меньшей сетевой задержки
3. Упрощение процесса разработки, так как все компоненты системы теперь находятся в рамках одной платформы

## Архитектура решения

Для обеспечения возможности использования обеих баз данных (Neon DB и PostgreSQL Replit) было реализовано решение на основе паттерна "Селектор":

1. Создан селектор базы данных (`db-selector-new.ts`), который динамически выбирает подключение к нужной БД
2. Добавлен адаптер для PostgreSQL Replit (`db-replit.ts`)
3. Реализован механизм переключения между базами данных через переменную окружения `DATABASE_PROVIDER`
4. Добавлена поддержка миграции схемы с помощью Drizzle ORM

## Технические детали

### 1. Файлы миграции

- `db-selector-new.ts` - центральный селектор для выбора провайдера БД
- `db-replit.ts` - адаптер для работы с PostgreSQL Replit
- `migrate-replit-db.mjs` - скрипт для миграции схемы в базу данных Replit

### 2. Переменные окружения

| Переменная | Значение | Описание |
|------------|----------|----------|
| DATABASE_PROVIDER | "neon" | Использование Neon DB (по умолчанию) |
| DATABASE_PROVIDER | "replit" | Использование PostgreSQL Replit |

### 3. Рабочие процессы (workflows)

- `Start with Replit DB` - запуск сервера с использованием PostgreSQL Replit
- `Start with Neon DB` - запуск сервера с использованием Neon DB
- `Migrate to Replit DB` - миграция схемы в PostgreSQL Replit
- `Check Database Status` - проверка состояния базы данных

## Как использовать

### Запуск с PostgreSQL Replit:

```bash
DATABASE_PROVIDER=replit npx tsx server/index.ts
```

Или через workflow:
```
Start with Replit DB
```

### Запуск с Neon DB:

```bash
DATABASE_PROVIDER=neon npx tsx server/index.ts
```

Или через workflow:
```
Start with Neon DB
```

### Миграция схемы:

```bash
node migrate-replit-db.mjs
```

Или через workflow:
```
Migrate to Replit DB
```

## Ограничения и особенности

1. Данные между базами не синхронизируются - каждая база содержит отдельный набор данных
2. При первом запуске с PostgreSQL Replit база данных будет пустой
3. Для тестирования API и функциональности системы в среде Replit необходимо создать тестовые данные
4. В производственной среде рекомендуется использовать PostgreSQL Replit, особенно если скорость доступа критична

## Советы по устранению неполадок

- Если возникают ошибки подключения к базе данных, проверьте значения переменных окружения
- При проблемах с подключением к PostgreSQL Replit убедитесь, что база данных создана и корректно настроена
- Если возникают ошибки миграции схемы, сначала проверьте результаты миграции с помощью `Check Database Status`
- При возникновении ошибок в селекторе, проверьте правильность экспортов в файле `db-selector-new.ts`

## Заключение

Эта миграция значительно улучшает работу UniFarm в среде Replit, избавляя от зависимости от внешней базы данных Neon DB. Архитектура реализации позволяет легко переключаться между базами данных, что упрощает тестирование и дальнейшее сопровождение.