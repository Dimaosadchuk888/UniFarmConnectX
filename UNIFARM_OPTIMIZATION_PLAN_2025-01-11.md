# üéØ –ü–õ–ê–ù –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ô UNIFARM

**–î–∞—Ç–∞:** 11 —è–Ω–≤–∞—Ä—è 2025  
**–û—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ê—É–¥–∏—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã UNIFARM_REQUEST_FLOW_AUDIT_2025-01-11.md  
**–¶–µ–ª—å:** –£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏

---

## üìã –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞–º–∏](#1-—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è-—É–ø—Ä–∞–≤–ª–µ–Ω–∏—è-–±–∞–ª–∞–Ω—Å–∞–º–∏)
2. [–†–µ–∞–ª–∏–∑–∞—Ü–∏—è WebSocket –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏](#2-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è-websocket-–≤-—Ä–µ–∞–ª—å–Ω–æ–º-–≤—Ä–µ–º–µ–Ω–∏)
3. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è TON –∫–æ—à–µ–ª—å–∫–æ–≤](#3-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-ton-–∫–æ—à–µ–ª—å–∫–æ–≤)
4. [–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è farming_sessions](#4-–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è-farming_sessions)
5. [–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ Referral –Ω–∞–≥—Ä–∞–¥](#5-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-–ª–æ–≥–∏–∫–∏-referral-–Ω–∞–≥—Ä–∞–¥)
6. [–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π](#6-—Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è-—Ç–∏–ø–æ–≤-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
7. [–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–≤](#7-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–≤)
8. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è](#8-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ-—É–ª—É—á—à–µ–Ω–∏—è)

---

## 1. –¶–ï–ù–¢–†–ê–õ–ò–ó–ê–¶–ò–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ë–ê–õ–ê–ù–°–ê–ú–ò

### üéØ –ß—Ç–æ —É–ª—É—á—à–∏—Ç—å:
–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –í–°–ï –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–ª–∞–Ω—Å–∞–º–∏ —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π BalanceManager, —É—Å—Ç—Ä–∞–Ω–∏–≤ –ø—Ä—è–º—ã–µ SQL –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

### ‚ö° –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ:
- **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**: –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race conditions
- **–ê—É–¥–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤–∞–ª–∏–¥–∞—Ü–∏—é, rollback

### üîß –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:

#### 1.1 –û–±–Ω–æ–≤–∏—Ç—å UNI Farming –¥–µ–ø–æ–∑–∏—Ç:
```typescript
// modules/farming/service.ts
async depositUniForFarming(userId: string, amount: number) {
  // –ë–´–õ–û: –ø—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Supabase
  // –°–¢–ê–õ–û:
  const { balanceManager } = await import('../../core/BalanceManager');
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
  const hasBalance = await balanceManager.hasSufficientBalance(
    parseInt(userId), amount, 0
  );
  
  if (!hasBalance) {
    throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
  }
  
  // –ê—Ç–æ–º–∞—Ä–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
  await balanceManager.transaction(async (trx) => {
    // –°–ø–∏—Å–∞–Ω–∏–µ UNI
    await balanceManager.subtractBalance(
      parseInt(userId), amount, 0, 
      'FarmingService.depositUni', trx
    );
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ farming –ø–æ–ª–µ–π —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
    await this.updateFarmingState(userId, amount, trx);
  });
}
```

#### 1.2 –û–±–Ω–æ–≤–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏:
```typescript
// core/scheduler/farmingScheduler.ts
async processUniFarmingIncome() {
  // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞—Ä–º–µ—Ä–∞
  const income = this.calculateIncome(farmer);
  
  // –ë–´–õ–û: –ø—Ä—è–º–æ–π Supabase.update()
  // –°–¢–ê–õ–û:
  await balanceManager.addBalance(
    farmer.id,
    income,
    0,
    'FarmingScheduler.processIncome'
  );
}
```

### ‚ö†Ô∏è –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:
- –ù–µ–±–æ–ª—å—à–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ latency (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–ª–æ–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏)
- –¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä—è–º—ã—Ö SQL

---

## 2. –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø WEBSOCKET –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò

### üéØ –ß—Ç–æ —É–ª—É—á—à–∏—Ç—å:
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π WebSocket —Å–µ—Ä–≤–µ—Ä –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–æ–≤.

### ‚ö° –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ:
- **UX**: –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –æ—Ç polling
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ real-time features

### üîß –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:

#### 2.1 WebSocket —Å–µ—Ä–≤–µ—Ä:
```typescript
// core/websocket/WebSocketServer.ts
import { Server } from 'socket.io';
import { Server as HttpServer } from 'http';
import { verifyJWT } from '../middleware/auth';

export class WebSocketServer {
  private io: Server;
  private userSockets: Map<string, Set<string>> = new Map();

  constructor(httpServer: HttpServer) {
    this.io = new Server(httpServer, {
      cors: {
        origin: process.env.FRONTEND_URL,
        credentials: true
      }
    });
    
    this.setupMiddleware();
    this.setupHandlers();
  }

  private setupMiddleware() {
    // JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    this.io.use(async (socket, next) => {
      try {
        const token = socket.handshake.auth.token;
        const decoded = await verifyJWT(token);
        socket.data.userId = decoded.userId;
        next();
      } catch (error) {
        next(new Error('Unauthorized'));
      }
    });
  }

  private setupHandlers() {
    this.io.on('connection', (socket) => {
      const userId = socket.data.userId;
      
      // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ–∫–µ—Ç–∞
      if (!this.userSockets.has(userId)) {
        this.userSockets.set(userId, new Set());
      }
      this.userSockets.get(userId)!.add(socket.id);
      
      // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      socket.join(`user:${userId}`);
      
      // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
      socket.on('disconnect', () => {
        const sockets = this.userSockets.get(userId);
        if (sockets) {
          sockets.delete(socket.id);
          if (sockets.size === 0) {
            this.userSockets.delete(userId);
          }
        }
      });
    });
  }

  // –ú–µ—Ç–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
  emitToUser(userId: string, event: string, data: any) {
    this.io.to(`user:${userId}`).emit(event, data);
  }
}
```

#### 2.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å BalanceNotificationService:
```typescript
// core/balanceNotificationService.ts
import { webSocketServer } from '../websocket';

private sendAggregatedUpdate(userId: string) {
  const updates = this.pendingUpdates.get(userId) || [];
  
  if (updates.length === 0) return;
  
  // –ê–≥—Ä–µ–≥–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
  const aggregated = this.aggregateUpdates(updates);
  
  // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ WebSocket
  webSocketServer.emitToUser(userId, 'balance:update', {
    timestamp: new Date().toISOString(),
    changes: aggregated,
    currentBalance: {
      uni: aggregated.finalUni,
      ton: aggregated.finalTon
    }
  });
  
  // –û—á–∏—Å—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏
  this.pendingUpdates.delete(userId);
}
```

#### 2.3 –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å:
```typescript
// client/src/contexts/WebSocketContext.tsx
import { io, Socket } from 'socket.io-client';

export const WebSocketProvider: React.FC = ({ children }) => {
  const [socket, setSocket] = useState<Socket | null>(null);
  const { token } = useAuth();
  
  useEffect(() => {
    if (!token) return;
    
    const newSocket = io(process.env.VITE_WS_URL, {
      auth: { token }
    });
    
    newSocket.on('balance:update', (data) => {
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      queryClient.setQueryData(['user', 'balance'], data.currentBalance);
      
      // Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      toast({
        title: '–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω',
        description: `UNI: ${data.currentBalance.uni}, TON: ${data.currentBalance.ton}`
      });
    });
    
    setSocket(newSocket);
    
    return () => {
      newSocket.close();
    };
  }, [token]);
  
  return (
    <WebSocketContext.Provider value={{ socket }}>
      {children}
    </WebSocketContext.Provider>
  );
};
```

### ‚ö†Ô∏è –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:
- –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ CORS –∏ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
- –ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ reconnect –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

---

## 3. –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø TON –ö–û–®–ï–õ–¨–ö–û–í

### üéØ –ß—Ç–æ —É–ª—É—á—à–∏—Ç—å:
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TON wallet –∞–¥—Ä–µ—Å–∞–º–∏.

### ‚ö° –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ:
- **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- **UX**: –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ

### üîß –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:

#### 3.1 API endpoint:
```typescript
// modules/wallet/controller.ts
@requireTelegramAuth
async connectTonWallet(req: Request, res: Response) {
  try {
    const { walletAddress } = req.body;
    const userId = req.user!.id;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞
    if (!isValidTonAddress(walletAddress)) {
      return res.status(400).json({
        success: false,
        error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞'
      });
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
    const result = await this.walletService.saveTonWallet(
      userId,
      walletAddress
    );
    
    return res.json({
      success: true,
      data: result
    });
  } catch (error) {
    return this.handleError(res, error);
  }
}

// modules/wallet/routes.ts
router.post('/connect-ton', controller.connectTonWallet.bind(controller));
```

#### 3.2 Service —Å–ª–æ–π:
```typescript
// modules/wallet/service.ts
async saveTonWallet(userId: string, address: string) {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
  const existing = await supabase
    .from('users')
    .select('id')
    .eq('ton_wallet_address', address)
    .neq('id', userId)
    .single();
    
  if (existing.data) {
    throw new Error('–≠—Ç–æ—Ç –∞–¥—Ä–µ—Å —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É');
  }
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  const { data, error } = await supabase
    .from('users')
    .update({
      ton_wallet_address: address,
      ton_wallet_verified: true,
      ton_wallet_linked_at: new Date().toISOString()
    })
    .eq('id', userId)
    .select()
    .single();
    
  if (error) throw error;
  
  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
  await this.logWalletConnection(userId, address);
  
  return data;
}
```

#### 3.3 Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:
```typescript
// client/src/components/ton-boost/BoostPackagesCard.tsx
const handleWalletConnect = async (wallet: Wallet) => {
  try {
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –∏–∑ TonConnect
    const address = wallet.account.address;
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ backend
    const response = await fetch('/api/v2/wallet/connect-ton', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ walletAddress: address })
    });
    
    if (response.ok) {
      toast({
        title: '–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω',
        description: `–ê–¥—Ä–µ—Å ${address} —Å–æ—Ö—Ä–∞–Ω–µ–Ω`
      });
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞:', error);
  }
};
```

### ‚ö†Ô∏è –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:
- –¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö

---

## 4. –ö–û–†–†–ï–ö–¢–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø FARMING_SESSIONS

### üéØ –ß—Ç–æ —É–ª—É—á—à–∏—Ç—å:
–°–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ farming_sessions –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–ø–æ–∑–∏—Ç–µ.

### ‚ö° –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ:
- **–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π**: –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç farming –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**: —Ä–∞—Å—á–µ—Ç ROI, —Å—Ä–µ–¥–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ farming
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞**: —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–ø–æ—Ä–æ–≤ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### üîß –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:

```typescript
// modules/farming/service.ts
async createFarmingSession(
  userId: string, 
  amount: number,
  trx?: any
) {
  const sessionData = {
    user_id: parseInt(userId),
    deposit_amount: amount,
    start_time: new Date().toISOString(),
    status: 'active',
    rate: 0.01, // 1% daily
    accumulated_income: 0,
    last_update: new Date().toISOString()
  };
  
  const { data, error } = await supabase
    .from('farming_sessions')
    .insert(sessionData)
    .select()
    .single();
    
  if (error) throw error;
  
  return data;
}

// –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ depositUniForFarming
async depositUniForFarming(userId: string, amount: number) {
  await balanceManager.transaction(async (trx) => {
    // –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
    await balanceManager.subtractBalance(...);
    
    // –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
    await this.createFarmingSession(userId, amount, trx);
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await this.updateFarmingState(userId, amount, trx);
  });
}
```

### ‚ö†Ô∏è –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ–±—ä–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î
- –¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

---

## 5. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –õ–û–ì–ò–ö–ò REFERRAL –ù–ê–ì–†–ê–î

### üéØ –ß—Ç–æ —É–ª—É—á—à–∏—Ç—å:
Referral –Ω–∞–≥—Ä–∞–¥—ã –¥–æ–ª–∂–Ω—ã –Ω–∞—á–∏—Å–ª—è—Ç—å—Å—è –æ—Ç –¥–æ—Ö–æ–¥–∞, –∞ –Ω–µ –æ—Ç –ø–æ–∫—É–ø–∫–∏ Boost.

### ‚ö° –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ:
- **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞**: –Ω–∞–≥—Ä–∞–¥—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç –ø—Ä–∏–±—ã–ª–∏, –∞ –Ω–µ –æ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
- **–≠–∫–æ–Ω–æ–º–∏–∫–∞**: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∏–Ω—Ñ–ª—è—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
- **–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å**: –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –∑–∞ —Ä–µ–∞–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

### üîß –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:

```typescript
// modules/boost/service.ts
async purchaseWithInternalWallet(userId: string, boostId: number) {
  // ... –ø–æ–∫—É–ø–∫–∞ boost ...
  
  // –£–î–ê–õ–ò–¢–¨ —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏:
  // await referralService.distributeReferralRewards(
  //   userId, boostAmount, 'TON', 'boost'
  // );
  
  // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ - —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–∞—Ü–∏—è boost
  await this.activateBoostPackage(userId, boostId);
}

// modules/scheduler/tonBoostIncomeScheduler.ts
async processBoostIncome(user: any, boost: any) {
  const income = this.calculateIncome(boost);
  
  // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞
  await balanceManager.addBalance(user.id, 0, income);
  
  // –¢–ï–ü–ï–†–¨ –Ω–∞—á–∏—Å–ª—è–µ–º referral –æ—Ç –¥–æ—Ö–æ–¥–∞
  await referralService.distributeReferralRewards(
    user.id.toString(),
    income.toString(),
    'TON',
    'boost_income' // –Ω–æ–≤—ã–π —Ç–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞
  );
}
```

### ‚ö†Ô∏è –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —ç–∫–æ–Ω–æ–º–∏–∫–∏ (–º–µ–Ω—å—à–µ referral –≤—ã–ø–ª–∞—Ç)
- –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

## 6. –°–¢–ê–ù–î–ê–†–¢–ò–ó–ê–¶–ò–Ø –¢–ò–ü–û–í –¢–†–ê–ù–ó–ê–ö–¶–ò–ô

### üéØ –ß—Ç–æ —É–ª—É—á—à–∏—Ç—å:
–î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ç–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ enum –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö.

### ‚ö° –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ:
- **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**: —Ç–æ—á–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
- **–û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å**: –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã

### üîß –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:

#### 6.1 –û–±–Ω–æ–≤–∏—Ç—å enum –≤ –ë–î:
```sql
ALTER TYPE transaction_type ADD VALUE 'BOOST_PURCHASE';
ALTER TYPE transaction_type ADD VALUE 'FARMING_DEPOSIT';
ALTER TYPE transaction_type ADD VALUE 'BOOST_INCOME';
```

#### 6.2 –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥:
```typescript
// shared/types/transaction.ts
export enum TransactionType {
  DEPOSIT = 'DEPOSIT',
  WITHDRAW = 'WITHDRAW',
  FARMING_REWARD = 'FARMING_REWARD',
  FARMING_DEPOSIT = 'FARMING_DEPOSIT', // –Ω–æ–≤—ã–π
  REFERRAL_REWARD = 'REFERRAL_REWARD',
  DAILY_BONUS = 'DAILY_BONUS',
  MISSION_REWARD = 'MISSION_REWARD',
  BOOST_PURCHASE = 'BOOST_PURCHASE',   // –Ω–æ–≤—ã–π
  BOOST_INCOME = 'BOOST_INCOME',       // –Ω–æ–≤—ã–π
  TON_BOOST_INCOME = 'TON_BOOST_INCOME',
  AIRDROP_CLAIM = 'AIRDROP_CLAIM'
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤
// modules/boost/service.ts
await this.createTransaction({
  type: TransactionType.BOOST_PURCHASE, // –≤–º–µ—Å—Ç–æ FARMING_REWARD
  // ...
});
```

### ‚ö†Ô∏è –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:
- –¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

---

## 7. –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ü–õ–ê–ù–ò–†–û–í–©–ò–ö–û–í

### üéØ –ß—Ç–æ —É–ª—É—á—à–∏—Ç—å:
–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ BalanceManager –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã.

### ‚ö° –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ:
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

### üîß –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:

```typescript
// core/scheduler/optimizedScheduler.ts
export class OptimizedFarmingScheduler {
  async processBatch() {
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∞—Ä–º–µ—Ä–æ–≤
    const farmers = await this.getActiveFarmers();
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const updates = farmers.map(farmer => ({
      userId: farmer.id,
      uniIncome: this.calculateUniIncome(farmer),
      tonIncome: 0
    }));
    
    // Batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ BalanceManager
    await balanceManager.batchUpdateBalances(updates);
    
    // Batch —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    await this.createBatchTransactions(updates);
    
    // Referral –Ω–∞–≥—Ä–∞–¥—ã —Ç–æ–∂–µ batch
    await this.processBatchReferrals(updates);
  }
  
  private async processBatchReferrals(updates: any[]) {
    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    const promises = updates.map(update => 
      referralService.distributeReferralRewards(
        update.userId,
        update.uniIncome,
        'UNI',
        'farming'
      )
    );
    
    await Promise.all(promises);
  }
}
```

### ‚ö†Ô∏è –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:
- –°–ª–æ–∂–Ω–µ–µ –æ—Ç–ª–∞–¥–∫–∞ batch –æ–ø–µ—Ä–∞—Ü–∏–π
- –¢—Ä–µ–±—É–µ—Ç—Å—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## 8. –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

### üéØ –ß—Ç–æ —É–ª—É—á—à–∏—Ç—å:
–û–±—â–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –ø—Ä–∞–∫—Ç–∏–∫–∏.

### ‚ö° –ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ:
- **Maintainability**: –ª–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∫–æ–¥
- **Testability**: –ø—Ä–æ—â–µ –ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã
- **Scalability**: –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–æ—Å—Ç—É

### üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

#### 8.1 Repository –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π:
```typescript
// core/base/BaseRepository.ts
export abstract class BaseRepository<T> {
  constructor(protected tableName: string) {}
  
  async findById(id: string): Promise<T | null> {
    const { data } = await supabase
      .from(this.tableName)
      .select()
      .eq('id', id)
      .single();
    return data;
  }
  
  async create(entity: Partial<T>): Promise<T> {
    const { data, error } = await supabase
      .from(this.tableName)
      .insert(entity)
      .select()
      .single();
    if (error) throw error;
    return data;
  }
  
  // ... –¥—Ä—É–≥–∏–µ –±–∞–∑–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã
}
```

#### 8.2 Event-driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
```typescript
// core/events/EventBus.ts
export class EventBus {
  private handlers = new Map<string, Set<Handler>>();
  
  on(event: string, handler: Handler) {
    if (!this.handlers.has(event)) {
      this.handlers.set(event, new Set());
    }
    this.handlers.get(event)!.add(handler);
  }
  
  async emit(event: string, data: any) {
    const handlers = this.handlers.get(event) || new Set();
    
    // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    await Promise.all(
      Array.from(handlers).map(handler => handler(data))
    );
  }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
eventBus.on('balance:updated', async (data) => {
  await notificationService.notify(data);
  await analyticsService.track(data);
});
```

#### 8.3 Dependency Injection:
```typescript
// core/di/container.ts
import { Container } from 'inversify';

const container = new Container();

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
container.bind<BalanceManager>('BalanceManager')
  .to(BalanceManager)
  .inSingletonScope();

container.bind<ReferralService>('ReferralService')
  .to(ReferralService)
  .inSingletonScope();

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
const balanceManager = container.get<BalanceManager>('BalanceManager');
```

---

## üìä –ü–†–ò–û–†–ò–¢–ï–¢–´ –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –§–∞–∑–∞ 1 (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ):
1. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ —á–µ—Ä–µ–∑ BalanceManager
2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Referral –ª–æ–≥–∏–∫–∏
3. –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### –§–∞–∑–∞ 2 (–í–∞–∂–Ω—ã–µ):
4. WebSocket —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
5. TON wallet –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
6. Farming sessions

### –§–∞–∑–∞ 3 (–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è):
7. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–≤
8. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

---

## ‚è±Ô∏è –û–¶–ï–ù–ö–ê –í–†–ï–ú–ï–ù–ò

| –ó–∞–¥–∞—á–∞ | –û—Ü–µ–Ω–∫–∞ | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|--------|---------|-----------|
| –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ | 2-3 –¥–Ω—è | –°—Ä–µ–¥–Ω—è—è |
| WebSocket | 3-4 –¥–Ω—è | –í—ã—Å–æ–∫–∞—è |
| TON wallet | 1-2 –¥–Ω—è | –ù–∏–∑–∫–∞—è |
| Farming sessions | 1 –¥–µ–Ω—å | –ù–∏–∑–∫–∞—è |
| Referral –ª–æ–≥–∏–∫–∞ | 1-2 –¥–Ω—è | –°—Ä–µ–¥–Ω—è—è |
| –¢–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π | 1 –¥–µ–Ω—å | –ù–∏–∑–∫–∞—è |
| –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏ | 2-3 –¥–Ω—è | –°—Ä–µ–¥–Ω—è—è |
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | 5-7 –¥–Ω–µ–π | –í—ã—Å–æ–∫–∞—è |

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** 16-24 –¥–Ω—è –ø—Ä–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

**–ö–æ–Ω–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞**