<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –≤—ã–≤–æ–¥–∞ TON</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
            margin-top: 0;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .balance-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .balance-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .withdrawals-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .withdrawals-table th, .withdrawals-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .withdrawals-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .status-pending { color: #856404; }
        .status-approved { color: #155724; }
        .status-rejected { color: #721c24; }
        #logs {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
        }
        .log-info { color: #0c5460; }
        .log-success { color: #155724; }
        .log-error { color: #721c24; }
        .log-warning { color: #856404; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –≤—ã–≤–æ–¥–∞ TON</h1>
    
    <!-- –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å -->
    <div class="container">
        <h2>üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</h2>
        <div class="balance-card">
            <div class="balance-item">
                <span>UNI –±–∞–ª–∞–Ω—Å:</span>
                <strong id="uniBalance">–ó–∞–≥—Ä—É–∑–∫–∞...</strong>
            </div>
            <div class="balance-item">
                <span>TON –±–∞–ª–∞–Ω—Å:</span>
                <strong id="tonBalance">–ó–∞–≥—Ä—É–∑–∫–∞...</strong>
            </div>
            <div class="balance-item">
                <span>User ID:</span>
                <strong id="userId">–ó–∞–≥—Ä—É–∑–∫–∞...</strong>
            </div>
        </div>
        <button onclick="loadBalance()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤—ã–≤–æ–¥–∞ -->
    <div class="container">
        <h2>üì§ –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥ TON</h2>
        <form id="withdrawForm">
            <div class="form-group">
                <label for="amount">–°—É–º–º–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞ (TON):</label>
                <input type="number" id="amount" step="0.001" min="0.001" value="2" required>
            </div>
            <div class="form-group">
                <label for="wallet">TON –∫–æ—à–µ–ª–µ–∫:</label>
                <input type="text" id="wallet" value="UQCZm66N6h86EFy7uKaS9gqbfmDHUlDV1c2TQ7OnB7Y85HQz" required>
            </div>
            <button type="submit" id="submitBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
            <button type="button" onclick="testInsufficientFunds()">–¢–µ—Å—Ç: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤</button>
        </form>
        <div id="withdrawResult"></div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫ -->
    <div class="container">
        <h2>üìã –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫ –Ω–∞ –≤—ã–≤–æ–¥</h2>
        <button onclick="loadWithdrawals()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        <div id="withdrawalsList">
            <p>–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫</p>
        </div>
    </div>

    <!-- –õ–æ–≥–∏ -->
    <div class="container">
        <h2>üìù –õ–æ–≥–∏ –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
        <button onclick="clearLogs()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        <div id="logs"></div>
    </div>

    <script>
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        const API_BASE = 'http://localhost:3000/api/v2';
        let currentJWT = localStorage.getItem('unifarm_jwt_token');
        let currentUserId = null;

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã', 'info');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
        }

        // API –∑–∞–ø—Ä–æ—Å —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentJWT}`
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ API: ${error.message}`, 'error');
                throw error;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–ª–∞–Ω—Å
        async function loadBalance() {
            try {
                log('–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞...', 'info');
                
                // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const profile = await apiRequest('/users/profile');
                currentUserId = profile.data.id;
                
                document.getElementById('userId').textContent = currentUserId;
                document.getElementById('uniBalance').textContent = `${profile.data.balance_uni} UNI`;
                document.getElementById('tonBalance').textContent = `${profile.data.balance_ton} TON`;
                
                log(`–ë–∞–ª–∞–Ω—Å –∑–∞–≥—Ä—É–∂–µ–Ω: ${profile.data.balance_ton} TON, ${profile.data.balance_uni} UNI`, 'success');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞: ${error.message}`, 'error');
                document.getElementById('userId').textContent = '–û—à–∏–±–∫–∞';
                document.getElementById('uniBalance').textContent = '–û—à–∏–±–∫–∞';
                document.getElementById('tonBalance').textContent = '–û—à–∏–±–∫–∞';
            }
        }

        // –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥
        async function createWithdrawal(amount, wallet) {
            try {
                log(`–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥ ${amount} TON...`, 'info');
                
                const result = await apiRequest('/wallet/withdraw', 'POST', {
                    amount: amount.toString(),
                    currency: 'TON',
                    wallet_address: wallet
                });
                
                log(`–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!`, 'success');
                showResult('withdrawResult', 
                    `‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ ${amount} TON —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!`, 
                    'success'
                );
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∏ —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫
                setTimeout(() => {
                    loadBalance();
                    loadWithdrawals();
                }, 1000);
                
                return result;
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏: ${error.message}`, 'error');
                showResult('withdrawResult', 
                    `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 
                    'error'
                );
                throw error;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫
        async function loadWithdrawals() {
            try {
                log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞—è–≤–æ–∫...', 'info');
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ç–∏–ø–∞ withdrawal
                const result = await apiRequest(`/wallet/${currentUserId}/transactions?type=withdrawal&limit=10`);
                
                const withdrawals = result.data.transactions || [];
                
                if (withdrawals.length === 0) {
                    document.getElementById('withdrawalsList').innerHTML = 
                        '<p class="info">–ó–∞—è–≤–æ–∫ –Ω–∞ –≤—ã–≤–æ–¥ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                    return;
                }
                
                let html = '<table class="withdrawals-table"><thead><tr>' +
                    '<th>ID</th><th>–°—É–º–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th>' +
                    '</tr></thead><tbody>';
                
                withdrawals.forEach(w => {
                    const date = new Date(w.createdAt).toLocaleString('ru-RU');
                    html += `<tr>
                        <td>${w.id}</td>
                        <td>${w.amount} ${w.currency}</td>
                        <td class="status-${w.status}">${w.status}</td>
                        <td>${date}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                document.getElementById('withdrawalsList').innerHTML = html;
                
                log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${withdrawals.length} –∑–∞—è–≤–æ–∫`, 'success');
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫: ${error.message}`, 'error');
                document.getElementById('withdrawalsList').innerHTML = 
                    `<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</p>`;
            }
        }

        // –¢–µ—Å—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
        async function testInsufficientFunds() {
            try {
                log('–¢–µ—Å—Ç: –ø–æ–ø—ã—Ç–∫–∞ –≤—ã–≤–æ–¥–∞ —Å—É–º–º—ã –±–æ–ª—å—à–µ –±–∞–ª–∞–Ω—Å–∞...', 'warning');
                await createWithdrawal(99999, 'UQCZm66N6h86EFy7uKaS9gqbfmDHUlDV1c2TQ7OnB7Y85HQz');
            } catch (error) {
                // –û–∂–∏–¥–∞–µ–º–∞—è –æ—à–∏–±–∫–∞
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
        document.getElementById('withdrawForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('amount').value);
            const wallet = document.getElementById('wallet').value;
            const submitBtn = document.getElementById('submitBtn');
            
            submitBtn.disabled = true;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            try {
                await createWithdrawal(amount, wallet);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
            }
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞
        if (!currentJWT) {
            document.body.innerHTML = `
                <div class="container">
                    <h2>‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
                    <p>JWT —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ —Å–∏—Å—Ç–µ–º–µ.</p>
                    <p>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:</p>
                    <code>localStorage.setItem('unifarm_jwt_token', '–í–ê–®_JWT_–¢–û–ö–ï–ù')</code>
                </div>
            `;
        } else {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            loadBalance();
            log('–°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
        }
    </script>
</body>
</html>