# Отчёт о унификации создания транзакций в UniFarm

## Дата: 11 января 2025

## Проблема
В системе UniFarm найдена архитектурная проблема: несколько модулей создавали транзакции напрямую через Supabase API, минуя централизованный `UnifiedTransactionService`. Это приводило к:
- Отсутствию metadata с original_type для отслеживания источника транзакций
- Несогласованности в формате данных
- Потере возможности централизованного мониторинга

## Найденные проблемы

### 1. TON Boost транзакции
- **Статус**: ✅ ИСПРАВЛЕНО
- **Файл**: `modules/scheduler/tonBoostIncomeScheduler.ts`
- **Проблема**: Создавал транзакции напрямую через `supabase.from('transactions').insert()`
- **Решение**: Обновлён для использования `UnifiedTransactionService.createTransaction()`
- **Результат**: Теперь транзакции TON_BOOST_INCOME создаются с правильными metadata

### 2. Referral транзакции  
- **Статус**: ✅ ИСПРАВЛЕНО
- **Файл**: `modules/referral/service.ts`
- **Проблема**: Создавал REFERRAL_REWARD транзакции напрямую
- **Решение**: Обновлён для использования `UnifiedTransactionService.createTransaction()`
- **Результат**: Теперь реферальные транзакции создаются с metadata

### 3. Mission транзакции
- **Статус**: ❌ ТРЕБУЕТ ИСПРАВЛЕНИЯ
- **Файл**: `modules/missions/service.ts` (строка 138)
- **Проблема**: Создаёт MISSION_REWARD транзакции напрямую

### 4. Daily Bonus транзакции
- **Статус**: ❌ ТРЕБУЕТ ИСПРАВЛЕНИЯ
- **Файл**: `modules/dailyBonus/service.ts` (строка 174)
- **Проблема**: Создаёт DAILY_BONUS транзакции напрямую

## Ключевые находки из проверки БД

```
✅ FARMING_REWARD: 118,607 транзакций (включая TON Boost)
✅ REFERRAL_REWARD: 480,563 транзакций  
✅ DAILY_BONUS: 23 транзакций
✅ MISSION_REWARD: 23 транзакций
❌ TON_BOOST_INCOME: показывает null (маппится в FARMING_REWARD)
❌ BOOST_PURCHASE: НЕ НАЙДЕНО
❌ FARMING_DEPOSIT: НЕ НАЙДЕНО
```

## Рекомендации

1. **Срочно исправить** оставшиеся модули (missions, dailyBonus) для использования UnifiedTransactionService
2. **Добавить в enum** типы транзакций BOOST_PURCHASE и FARMING_DEPOSIT в БД
3. **Провести аудит** всех модулей на предмет прямого создания транзакций
4. **Документировать** правило: ВСЕ транзакции должны создаваться только через UnifiedTransactionService

## Преимущества унификации

- ✅ Единообразный формат транзакций
- ✅ Автоматическое преобразование типов через маппинг
- ✅ Централизованное логирование
- ✅ Metadata для отслеживания источника
- ✅ Упрощение будущих изменений