# üõ°Ô∏è –û–¢–ß–ï–¢ –û –ë–ï–ó–û–ü–ê–°–ù–´–• –ò–ó–ú–ï–ù–ï–ù–ò–Ø–•

**–î–∞—Ç–∞**: 24 –∏—é–ª—è 2025, 09:25 UTC  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ë–ï–ó–û–ü–ê–°–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´**  
**–¶–µ–ª—å**: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å—á–µ–∑–∞—é—â–∏—Ö TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤

## üìã –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ë–ï–ó–û–ü–ê–°–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### 1. –ö—Ä–∏—Ç–∏—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ ‚úÖ

**–§–∞–π–ª**: `core/BalanceManager.ts`
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä—è–º—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–∞
- **–¢–∏–ø**: `logger.critical('[DIRECT_BALANCE_UPDATE]', {...})`
- **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è**: user_id, –æ–ø–µ—Ä–∞—Ü–∏—è, —Å—Ç–∞—Ä—ã–π/–Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å, –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∏—Å—Ç–æ—á–Ω–∏–∫, stack trace
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –¢–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞

**–§–∞–π–ª**: `modules/wallet/service.ts` - —Ñ—É–Ω–∫—Ü–∏—è `processTonDeposit()`
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- **–≠—Ç–∞–ø—ã**: –ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏, –æ—à–∏–±–∫–∏, —É—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- **–¢–∏–ø**: `logger.critical('[TON_DEPOSIT_*]', {...})`
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –¢–æ–ª—å–∫–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –ª–æ–≥–∏–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ ‚úÖ

**–§–∞–π–ª**: `MONITORING_SCRIPT.js`
- **–§—É–Ω–∫—Ü–∏—è**: Real-time –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–æ–≤ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**: 
  - –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è users.balance_*
  - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–∑–¥–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è transactions
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏—Å—á–µ–∑–∞—é—â–∏—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –¢–û–õ–¨–ö–û —á—Ç–µ–Ω–∏–µ, –Ω–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ë–î

### 3. –ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ constraint ‚ö†Ô∏è

**–§–∞–π–ª**: `SAFE_CONSTRAINT_REMOVAL.js`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: Constraint `idx_tx_hash_unique_safe` –í–°–ï –ï–©–ï –ê–ö–¢–ò–í–ï–ù
- **–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ—Ç –ø—Ä—è–º–æ–≥–æ SQL –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ Supabase RPC
- **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞–ª–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å constraint
- **–°—Ç–∞—Ç—É—Å**: –¢—Ä–µ–±—É–µ—Ç—Å—è —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å PostgreSQL

## üéØ –≠–§–§–ï–ö–¢ –û–¢ –ò–ó–ú–ï–ù–ï–ù–ò–ô

### –ß—Ç–æ —Ç–µ–ø–µ—Ä—å –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:
1. **–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞**: –° —É–∫–∞–∑–∞–Ω–∏–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏ stack trace
2. **–í—Å–µ TON –¥–µ–ø–æ–∑–∏—Ç—ã**: –û—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
3. **–û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏**: –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–µ—É–¥–∞—á–∞—Ö
4. **Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å—á–µ–∑–∞—é—â–∏—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤** –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤** –ø—Ä—è–º—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–∞
- **–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –±–∞–ª–∞–Ω—Å–æ–≤
- **Stack trace –∞–Ω–∞–ª–∏–∑** –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ –∫–æ–¥–∞

## üö® –û–°–¢–ê–í–®–ò–ï–°–Ø –†–ò–°–ö–ò

### Constraint –≤—Å–µ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω:
- **–ü—Ä–æ–±–ª–µ–º–∞**: `idx_tx_hash_unique_safe` –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å rollback'–∏
- **–í–ª–∏—è–Ω–∏–µ**: –î–µ–ø–æ–∑–∏—Ç—ã –≤—Å–µ –µ—â–µ –º–æ–≥—É—Ç –∏—Å—á–µ–∑–∞—Ç—å –∏–∑-–∑–∞ constraint –Ω–∞—Ä—É—à–µ–Ω–∏–π
- **–†–µ—à–µ–Ω–∏–µ**: –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ PostgreSQL –¥–ª—è: `DROP INDEX IF EXISTS idx_tx_hash_unique_safe;`

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ**: –£–¥–∞–ª–∏—Ç—å constraint —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –ë–î
2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å**: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–ª—É—á–∞–µ–≤
3. **–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å**: –õ–æ–≥–∏ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏—Å—á–µ–∑–∞—é—â–∏—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤

## üìä –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π: ‚úÖ 100%
- –ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ
- –¢–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–∏–º—ã
- –ù–µ—Ç –≤–ª–∏—è–Ω–∏—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: ‚úÖ –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–µ–Ω—ã
- –ü–æ–ª–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–ª–∞–Ω—Å–æ–º
- Real-time –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã: ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ
- **–ì–æ—Ç–æ–≤–æ**: –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **–¢—Ä–µ–±—É–µ—Ç—Å—è**: –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ constraint –∏–∑ –ë–î

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: `node MONITORING_SCRIPT.js`
2. **–£–¥–∞–ª–∏—Ç—å constraint**: –ß–µ—Ä–µ–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å PostgreSQL
3. **–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ª–æ–≥–∏**: –ò—Å–∫–∞—Ç—å –Ω–æ–≤—ã–µ —Å–ª—É—á–∞–∏ –∏—Å—á–µ–∑–∞—é—â–∏—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤
4. **–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ**: –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

**–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**: –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è –∏ –≥–æ—Ç–æ–≤–∞ –∫ –≤—ã—è–≤–ª–µ–Ω–∏—é –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º—ã –∏—Å—á–µ–∑–∞—é—â–∏—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.