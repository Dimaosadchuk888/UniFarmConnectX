# üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ô –ü–õ–ê–ù –ú–ò–ì–†–ê–¶–ò–ò –ù–ê –ö–û–†–†–ï–ö–¢–ù–£–Æ –°–•–ï–ú–£ –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò

**–î–∞—Ç–∞:** 21 —è–Ω–≤–∞—Ä—è 2025  
**–¶–µ–ª—å:** –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ telegram_id –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞

---

## üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï –°–ò–°–¢–ï–ú–´

### –ü—Ä–æ–±–ª–µ–º–∞
```
JWT Context: telegram.user.id = database_id (–Ω–∞–ø—Ä–∏–º–µ—Ä, 74)
–û–∂–∏–¥–∞–µ—Ç—Å—è: telegram.user.id = telegram_id (–Ω–∞–ø—Ä–∏–º–µ—Ä, 999489)
```

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:
- –ù–µ–≤–µ—Ä–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –î–µ–ø–æ–∑–∏—Ç—ã –∑–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–µ —Ç–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –°–æ–∑–¥–∞—é—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç—ã –∞–∫–∫–∞—É–Ω—Ç–æ–≤
- –¢–µ—Ä—è—é—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

---

## ‚ö†Ô∏è 1. –ü–û–°–õ–ï–î–°–¢–í–ò–Ø –î–õ–Ø –¢–ï–ö–£–©–ï–ô –°–ò–°–¢–ï–ú–´

### 1.1 –ß—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

1. **–í—Å–µ –º–µ—Ç–æ–¥—ã –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö**
   ```typescript
   // –°–µ–π—á–∞—Å (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
   getUserByTelegramId(telegram.user.id) // –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è database_id
   
   // –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
   getUserByTelegramId(telegram.user.telegram_id)
   ```

2. **–õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è/–ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
   - getOrCreateUserFromTelegram –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π telegram_id
   - –ò–∑–º–µ–Ω–∏—Ç—Å—è –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

3. **–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞**
   - –°–≤—è–∑–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞—Ä—É—à–µ–Ω—ã –µ—Å–ª–∏ referred_by —Ö—Ä–∞–Ω–∏—Ç database_id

### 1.2 –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã

1. **–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–æ–≤**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å telegram_id=111 –∏–º–µ–µ—Ç wallet="UQxx...123"
   - –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –Ω–µ –Ω–∞–π—Ç–∏ —ç—Ç—É —Å–≤—è–∑—å

2. **–ö—Ä–æ—Å—Å-—Å—Å—ã–ª–∫–∏ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö**
   - –ï—Å–ª–∏ user_id –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ database_id
   - –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–∏ —Å–≤—è–∑–∏

### 1.3 –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø—Ä–æ–±–ª–µ–º–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

**–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π:**
```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ telegram_id
SELECT COUNT(*) FROM users WHERE telegram_id IS NULL;

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥—É–±–ª–∏—Ä—É—é—â–∏–º–∏—Å—è telegram_id
SELECT telegram_id, COUNT(*) FROM users 
GROUP BY telegram_id HAVING COUNT(*) > 1;

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å wallet –Ω–æ –±–µ–∑ telegram_id
SELECT COUNT(*) FROM users 
WHERE ton_wallet_address IS NOT NULL AND telegram_id IS NULL;
```

---

## üö® 2. –†–ò–°–ö–ò –ú–ò–ì–†–ê–¶–ò–ò

### 2.1 –†–∏—Å–∫ –ø–æ—è–≤–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

**–°—Ü–µ–Ω–∞—Ä–∏–π –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ö–æ–¥–∏–ª —Å telegram_id=111
2. –°–æ–∑–¥–∞–ª–∞—Å—å –∑–∞–ø–∏—Å—å —Å id=1, telegram_id=111
3. –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –ø–æ telegram_id
4. –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å
5. –ü–æ–ª—É—á–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç: id=1000, telegram_id=111

**–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:**
```sql
-- –î–æ–±–∞–≤–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
CREATE UNIQUE INDEX idx_users_telegram_id ON users(telegram_id) 
WHERE telegram_id IS NOT NULL;
```

### 2.2 –†–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:**
- –ë–∞–ª–∞–Ω—Å—ã (balance_uni, balance_ton)
- –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏
- –ê–∫—Ç–∏–≤–Ω—ã–µ farming —Å–µ—Å—Å–∏–∏
- –ü—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏

### 2.3 –†–∏—Å–∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∫–µ–π—Å—ã:**
1. **–û–¥–∏–Ω wallet –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤**
   ```
   User A: telegram_id=111, wallet="UQxx...123"
   User B: telegram_id=222, wallet="UQxx...123"
   ```
   –†–µ—à–µ–Ω–∏–µ: –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É wallet_links

2. **–ó–∞–ø–∏—Å–∏ –±–µ–∑ telegram_id**
   - –ì–æ—Å—Ç–µ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã
   - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
   - –°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏

---

## ‚úÖ 3. –ë–ï–ó–û–ü–ê–°–ù–´–ô –ü–õ–ê–ù –ú–ò–ì–†–ê–¶–ò–ò

### PHASE 1: –ü–û–î–ì–û–¢–û–í–ö–ê (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞)

**–®–∞–≥ 1.1: –ê—É–¥–∏—Ç –¥–∞–Ω–Ω—ã—Ö**
```sql
-- –°–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
CREATE VIEW migration_audit AS
SELECT 
  COUNT(*) as total_users,
  COUNT(DISTINCT telegram_id) as unique_telegram_ids,
  COUNT(CASE WHEN telegram_id IS NULL THEN 1 END) as users_without_telegram_id,
  COUNT(CASE WHEN ton_wallet_address IS NOT NULL THEN 1 END) as users_with_wallet,
  COUNT(CASE WHEN telegram_id IS NULL AND ton_wallet_address IS NOT NULL THEN 1 END) as wallet_without_telegram_id
FROM users;
```

**–®–∞–≥ 1.2: –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ**
```bash
# –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
pg_dump -h $DATABASE_HOST -U $DATABASE_USER -d $DATABASE_NAME > backup_before_migration_$(date +%Y%m%d_%H%M%S).sql

# –ë—ç–∫–∞–ø –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü
pg_dump -t users -t transactions -t referrals > critical_tables_backup.sql
```

**–®–∞–≥ 1.3: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –º–∏–≥—Ä–∞—Ü–∏–∏**
```sql
CREATE TABLE migration_log (
  id SERIAL PRIMARY KEY,
  action VARCHAR(100),
  affected_user_id INTEGER,
  old_value JSONB,
  new_value JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### PHASE 2: –ú–ò–ì–†–ê–¶–ò–Ø –î–ê–ù–ù–´–•

**–®–∞–≥ 2.1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ NULL telegram_id**
```sql
-- –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å wallet –Ω–æ –±–µ–∑ telegram_id
-- –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ–º–µ—Ç–∏—Ç—å –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
UPDATE users 
SET telegram_id = -1 * id  -- –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π ID –∫–∞–∫ –º–∞—Ä–∫–µ—Ä
WHERE telegram_id IS NULL AND ton_wallet_address IS NOT NULL;

-- –í–∞—Ä–∏–∞–Ω—Ç 2: –£–¥–∞–ª–∏—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
DELETE FROM users 
WHERE telegram_id IS NULL 
  AND balance_uni = 0 
  AND balance_ton = 0
  AND created_at < NOW() - INTERVAL '30 days';
```

**–®–∞–≥ 2.2: –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ telegram_id**
```sql
-- –ù–∞–π—Ç–∏ –∏ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
WITH duplicates AS (
  SELECT telegram_id, array_agg(id ORDER BY created_at) as user_ids
  FROM users 
  WHERE telegram_id IS NOT NULL
  GROUP BY telegram_id 
  HAVING COUNT(*) > 1
)
SELECT * FROM duplicates;

-- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥—É–±–ª–∏–∫–∞—Ç–∞ - –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Å–∞–º—É—é —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å
```

**–®–∞–≥ 2.3: –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤**
```sql
-- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ telegram_id
CREATE UNIQUE INDEX idx_users_telegram_id_unique 
ON users(telegram_id) 
WHERE telegram_id IS NOT NULL AND telegram_id > 0;

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ wallet
CREATE INDEX idx_users_wallet ON users(ton_wallet_address);
```

### PHASE 3: –ò–ó–ú–ï–ù–ï–ù–ò–ï –ö–û–î–ê

**–®–∞–≥ 3.1: –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã**

–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
```
modules/wallet/controller.ts
modules/missions/controller.ts  
modules/user/controller.ts
modules/farming/controller.ts
modules/referral/controller.ts
modules/boost/controller.ts
modules/dailyBonus/controller.ts
modules/tonFarming/controller.ts
```

–ü–∞—Ç—Ç–µ—Ä–Ω –∑–∞–º–µ–Ω—ã:
```typescript
// –ë—ã–ª–æ:
const user = await userRepository.getUserByTelegramId(telegram.user.id);

// –°—Ç–∞–ª–æ:
const user = await userRepository.getUserByTelegramId(telegram.user.telegram_id);
```

**–®–∞–≥ 3.2: –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
```typescript
// modules/wallet/controller.ts
const user = await userRepository.getOrCreateUserFromTelegram({
  telegram_id: telegram.user.telegram_id, // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ
  username: telegram.user.username,
  first_name: telegram.user.first_name
});
```

**–®–∞–≥ 3.3: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏**
```typescript
// –í –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –º–µ—Ç–æ–¥–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
logger.info('Request context', {
  jwt_user_id: telegram.user.id,
  jwt_telegram_id: telegram.user.telegram_id,
  method: req.method,
  path: req.path
});
```

### PHASE 4: –í–ê–õ–ò–î–ê–¶–ò–Ø –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì

**–®–∞–≥ 4.1: –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ –º–µ—Ç—Ä–∏–∫**
```sql
CREATE VIEW migration_metrics AS
SELECT
  'users_without_telegram_id' as metric,
  COUNT(*) as value
FROM users WHERE telegram_id IS NULL
UNION ALL
SELECT
  'duplicate_telegram_ids' as metric,
  COUNT(DISTINCT telegram_id) as value
FROM users
GROUP BY telegram_id
HAVING COUNT(*) > 1
UNION ALL
SELECT
  'orphaned_wallets' as metric,
  COUNT(*) as value
FROM users
WHERE ton_wallet_address IS NOT NULL 
  AND telegram_id IS NULL;
```

**–®–∞–≥ 4.2: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫**
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ middleware –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
app.use((err, req, res, next) => {
  if (err.message.includes('telegram_id')) {
    logger.error('Migration related error', {
      error: err.message,
      path: req.path,
      jwt: req.headers.authorization
    });
  }
  next(err);
});
```

---

## üõ°Ô∏è 4. –°–¢–†–ê–¢–ï–ì–ò–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

### 4.1 –ü–æ—ç—Ç–∞–ø–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ

**–ö–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ:**
1. –í–∫–ª—é—á–∏—Ç—å –Ω–æ–≤—É—é –ª–æ–≥–∏–∫—É –¥–ª—è 5% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –æ—à–∏–±–∫–∏ 24 —á–∞—Å–∞
3. –†–∞—Å—à–∏—Ä–∏—Ç—å –¥–æ 25%, –∑–∞—Ç–µ–º 50%, –∑–∞—Ç–µ–º 100%

**Feature flags:**
```typescript
const USE_TELEGRAM_ID_AUTH = process.env.USE_TELEGRAM_ID_AUTH === 'true';

if (USE_TELEGRAM_ID_AUTH) {
  user = await getUserByTelegramId(telegram.user.telegram_id);
} else {
  user = await getUserByTelegramId(telegram.user.id); // —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞
}
```

### 4.2 –û—Ç–∫–∞—Ç –≤ —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º

**–ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞:**
1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –∏–∑ git
2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ë–î
3. –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à–∏
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã

**–ö–æ–º–∞–Ω–¥—ã –æ—Ç–∫–∞—Ç–∞:**
```bash
# –û—Ç–∫–∞—Ç –∫–æ–¥–∞
git revert HEAD

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î
psql -h $DATABASE_HOST -U $DATABASE_USER -d $DATABASE_NAME < backup_before_migration.sql

# –û—á–∏—Å—Ç–∫–∞ Redis –∫—ç—à–∞
redis-cli FLUSHALL
```

---

## üìã 5. –ß–ï–ö–õ–ò–°–¢ –ü–†–û–í–ï–†–ö–ò

### Pre-migration
- [ ] –°–æ–∑–¥–∞–Ω –ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø –ë–î
- [ ] –ü—Ä–æ–≤–µ–¥–µ–Ω –∞—É–¥–∏—Ç –¥–∞–Ω–Ω—ã—Ö
- [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã NULL telegram_id
- [ ] –†–∞–∑—Ä–µ—à–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã
- [ ] –°–æ–∑–¥–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã

### Post-migration
- [ ] –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É—Å–ø–µ—à–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è
- [ ] –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤–æ–π—Ç–∏
- [ ] TON –¥–µ–ø–æ–∑–∏—Ç—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ù–µ—Ç —Ä–æ—Å—Ç–∞ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –≤ –Ω–æ—Ä–º–µ

### –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ < 0.1%
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API –Ω–µ —É–≤–µ–ª–∏—á–∏–ª–æ—Å—å
- –ù–µ—Ç –Ω–æ–≤—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ telegram_id
- –í—Å–µ –¥–µ–ø–æ–∑–∏—Ç—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

---

## üéØ 6. –ò–¢–û–ì–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
```
Frontend ‚Üí JWT (telegram_id) ‚Üí Backend ‚Üí Database (telegram_id)
                ‚Üì
         –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                ‚Üì
         getUserByTelegramId(telegram_id)
                ‚Üì
         –£–Ω–∏–∫–∞–ª—å–Ω–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
```

### –ì–∞—Ä–∞–Ω—Ç–∏–∏:
1. **–û–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç—å**: 1 telegram_id = 1 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
2. **–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å**: –í—Å–µ —Å–≤—è–∑–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ò–Ω–¥–µ–∫—Å—ã –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–¥–º–µ–Ω–∏—Ç—å —á—É–∂–æ–π –∞–∫–∫–∞—É–Ω—Ç

---

## üìÖ TIMELINE

1. **–î–µ–Ω—å 1-2**: –ê—É–¥–∏—Ç –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
2. **–î–µ–Ω—å 3**: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥–µ
3. **–î–µ–Ω—å 4-5**: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
4. **–î–µ–Ω—å 6**: –ö–∞–Ω–∞—Ä–µ–µ—á–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (5%)
5. **–î–µ–Ω—å 7-10**: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
6. **–î–µ–Ω—å 11**: –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
7. **–î–µ–Ω—å 12-14**: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

**–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:** 21 —è–Ω–≤–∞—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤ –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é –∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—é