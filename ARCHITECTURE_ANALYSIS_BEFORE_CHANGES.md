# üèóÔ∏è –ê–ù–ê–õ–ò–ó –ê–†–•–ò–¢–ï–ö–¢–£–†–´ TON –î–ï–ü–û–ó–ò–¢–û–í
**–î–∞—Ç–∞:** 21 –∏—é–ª—è 2025  
**–¶–µ–ª—å:** –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏  
**–°—Ç–∞—Ç—É—Å:** –ì–û–¢–û–í –ö –ò–ó–ú–ï–ù–ï–ù–ò–Ø–ú

---

## üîç **–¢–ï–ö–£–©–ò–ô FLOW –û–ë–†–ê–ë–û–¢–ö–ò TON –î–ï–ü–û–ó–ò–¢–û–í**

### **1. Frontend (TonConnectService)**
üìÇ `client/src/services/tonConnectService.ts`
```javascript
// –°—Ç—Ä–æ–∫–∏ 375-427: –°–æ–∑–¥–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
const result = await tonConnectUI.sendTransaction(transaction);

// –ü–†–û–ë–õ–ï–ú–ê: Frontend –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç backend –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
return {
  txHash: result.boc,
  status: 'success'  
};
```

### **2. Backend API Handler** 
üìÇ `modules/wallet/controller.ts`
```javascript
// –°—Ç—Ä–æ–∫–∏ 365-450: tonDeposit endpoint (–ù–ê–ô–î–ï–ù–û!)
async tonDeposit(req: Request, res: Response, next: NextFunction) {
  const telegram = this.validateTelegramAuth(req, res);
  const { ton_tx_hash, amount, wallet_address } = req.body;
  
  // ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ö–ê–ö –û–ü–†–ï–î–ï–õ–Ø–ï–¢–°–Ø user_id –î–õ–Ø processTonDeposit?
  const user = await userRepository.getUserByTelegramId(telegram.user.id);  
  
  const result = await walletService.processTonDeposit({
    user_id: user.id,  // ‚Üê –≠–¢–û–¢ user.id –ú–û–ñ–ï–¢ –ë–´–¢–¨ –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ú
    amount,
    ton_tx_hash,
    wallet_address
  });
}
```

### **3. Service Layer**
üìÇ `modules/wallet/service.ts`
```javascript
// –°—Ç—Ä–æ–∫–∏ 300-466: processTonDeposit –º–µ—Ç–æ–¥
async processTonDeposit(params: {
  user_id: string,    // ‚Üê –í–û–¢ –ü–†–û–ë–õ–ï–ú–ù–ê–Ø –õ–û–ì–ò–ö–ê
  amount: number,
  ton_tx_hash: string,
  wallet_address: string
}) {
  // –°—Ç—Ä–æ–∫–∏ 375-379: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ tx_hash
  .eq('description', ton_tx_hash)  // ‚Üê –ü–†–ê–í–ò–õ–¨–ù–û
  
  // –°—Ç—Ä–æ–∫–∏ 415-434: –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  .insert({
    user_id,           // ‚Üê –ü–û–õ–£–ß–ï–ù –ò–ó –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ò–°–¢–û–ß–ù–ò–ö–ê
    amount_ton: amount,
    type: 'DEPOSIT',
    currency: 'TON'
  })
}
```

---

## üö® **–ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ü–†–û–ë–õ–ï–ú–´**

### **–ù–∞–π–¥–µ–Ω–∞ —Ç–æ—á–∫–∞ –æ—à–∏–±–∫–∏:**
‚ùå **–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ, –ö–ê–ö –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è user_id –≤ processTonDeposit**

–ù—É–∂–Ω–æ –ø—Ä–æ—Å–ª–µ–¥–∏—Ç—å:
1. –ì–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è processTonDeposit 
2. –û—Ç–∫—É–¥–∞ –±–µ—Ä–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä user_id
3. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–∏ –æ–Ω username –∏–ª–∏ telegram_id

---

## üìã **–ü–õ–ê–ù –ü–û–ò–°–ö–ê –ü–†–û–ë–õ–ï–ú–´**

### **PHASE 1: –ù–ê–ô–¢–ò –ò–°–¢–û–ß–ù–ò–ö user_id**
- [ ] –ù–∞–π—Ç–∏ –≥–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è processTonDeposit
- [ ] –ü—Ä–æ—Å–ª–µ–¥–∏—Ç—å –æ—Ç–∫—É–¥–∞ –±–µ—Ä–µ—Ç—Å—è user_id 
- [ ] –ù–∞–π—Ç–∏ –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### **PHASE 2: –ò–î–ï–ù–¢–ò–§–ò–¶–ò–†–û–í–ê–¢–¨ –ü–†–û–ë–õ–ï–ú–£**
- [ ] –ù–∞–π—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ username –≤–º–µ—Å—Ç–æ telegram_id
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω–æ–µ –º–µ—Å—Ç–æ –≤ –∫–æ–¥–µ

### **PHASE 3: –ò–°–ü–†–ê–í–ò–¢–¨**
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å username –Ω–∞ telegram_id –ø–æ–∏—Å–∫
- [ ] –î–æ–±–∞–≤–∏—Ç—å fallback –º–µ—Ö–∞–Ω–∏–∑–º
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

---

## üîß **–ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –ù–ê–ë–õ–Æ–î–ï–ù–ò–Ø**

### **–†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:**
‚úÖ **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç tx_hash, –Ω–µ username  
‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è  
‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞** - –ø—Ä—è–º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ë–î  
‚úÖ **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ** - —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ  

### **–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–æ–Ω—ã:**
‚ùå **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ user_id** - –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫  
‚ùå **–ü–∞—Ä—Å–∏–Ω–≥ amount** - –Ω–æ–≤—ã–µ –¥–µ–ø–æ–∑–∏—Ç—ã = 0  
‚ùå **Frontend integration** - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç backend  

### **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- `SupabaseUserRepository` - –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `supabase` - –ø—Ä—è–º—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã  
- `logger` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üéØ **–°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò**

1. **–ù–∞–π—Ç–∏ processTonDeposit –≤—ã–∑–æ–≤—ã** –≤ codebase
2. **–ü—Ä–æ—Å–ª–µ–¥–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ user_id** –ø–∞—Ä–∞–º–µ—Ç—Ä–∞  
3. **–ù–∞–π—Ç–∏ –ª–æ–≥–∏–∫—É username ‚Üí user_id** –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
4. **–ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ telegram_id ‚Üí user_id** –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ

---

**–°–¢–ê–¢–£–°:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–∑—É—á–µ–Ω–∞, –≥–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É –ø—Ä–æ–±–ª–µ–º–Ω–æ–π –ª–æ–≥–∏–∫–∏