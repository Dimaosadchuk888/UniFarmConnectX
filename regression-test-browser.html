<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1 { color: #4CAF50; }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 5px;
            background: #222;
        }
        .pass { color: #4CAF50; }
        .fail { color: #f44336; }
        .info { color: #2196F3; }
        .warn { color: #ff9800; }
        pre {
            background: #111;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
        }
        button:hover { background: #45a049; }
    </style>
</head>
<body>
    <h1>üß™ –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤</h1>
    <p>–î–∞—Ç–∞: 12.07.2025 | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö endpoints</p>
    
    <button onclick="runAllTests()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
    <button onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    
    <div id="results"></div>

    <script>
        const JWT_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6NzQsInRlbGVncmFtX2lkIjoxMjM0NTY3ODksInVzZXJuYW1lIjoidGVzdF91c2VyXzE3NTIxMjk4NDA5MDUiLCJmaXJzdF9uYW1lIjoiVGVzdCIsImxhc3RfbmFtZSI6IlVzZXIiLCJyZWZfY29kZSI6IlJFRl8xNzUyMTI5ODQwOTA1X3Q5Mzh2cyIsImlhdCI6MTc1MjEyOTg0MCwiZXhwIjoxNzUyNzM0NjQwfQ.JxAC5u79LcXU0HQsEP_9GsLTc_Qnk0xBGLhJIQ0bE-4';
        
        let allResults = [];
        
        async function testEndpoint(name, method, url, body = null, expectedCodes = [200]) {
            const result = {
                name,
                method,
                url,
                startTime: Date.now()
            };
            
            try {
                const options = {
                    method,
                    headers: {
                        'Authorization': `Bearer ${JWT_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(url, options);
                result.responseTime = Date.now() - result.startTime;
                result.status = response.status;
                result.success = expectedCodes.includes(response.status);
                
                try {
                    result.data = await response.json();
                } catch (e) {
                    result.data = await response.text();
                }
                
            } catch (error) {
                result.responseTime = Date.now() - result.startTime;
                result.error = error.message;
                result.success = false;
            }
            
            return result;
        }
        
        async function runAllTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h2>‚è≥ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤...</h2>';
            allResults = [];
            
            // 1. GET /api/v2/wallet/balance
            const balanceTest = await testEndpoint(
                'Wallet Balance',
                'GET',
                '/api/v2/wallet/balance'
            );
            displayResult(balanceTest);
            allResults.push(balanceTest);
            
            // 2. GET /api/v2/wallet/transactions
            const transactionsTest = await testEndpoint(
                'Wallet Transactions',
                'GET',
                '/api/v2/wallet/transactions?page=1&limit=10'
            );
            displayResult(transactionsTest);
            allResults.push(transactionsTest);
            
            // 3. GET /api/v2/uni-farming/status
            const farmingTest = await testEndpoint(
                'UNI Farming Status',
                'GET',
                '/api/v2/uni-farming/status?user_id=74'
            );
            displayResult(farmingTest);
            allResults.push(farmingTest);
            
            // 4. POST /api/v2/wallet/ton-deposit
            const tonDepositTest = await testEndpoint(
                'TON Deposit',
                'POST',
                '/api/v2/wallet/ton-deposit',
                {
                    ton_tx_hash: `test_tx_${Date.now()}`,
                    amount: 0.1,
                    wallet_address: 'test_wallet_' + Date.now()
                },
                [200, 201]
            );
            displayResult(tonDepositTest);
            allResults.push(tonDepositTest);
            
            // 5. POST /api/v2/wallet/withdraw
            const withdrawTest = await testEndpoint(
                'Wallet Withdraw',
                'POST',
                '/api/v2/wallet/withdraw',
                {
                    amount: 100,
                    currency: 'UNI',
                    wallet_address: 'test_withdraw_' + Date.now()
                },
                [200, 201, 400]
            );
            displayResult(withdrawTest);
            allResults.push(withdrawTest);
            
            // 6. POST /api/v2/wallet/transfer
            const transferTest = await testEndpoint(
                'Wallet Transfer',
                'POST',
                '/api/v2/wallet/transfer',
                {
                    recipient_id: 75,
                    amount: 10,
                    currency: 'UNI'
                },
                [200, 400]
            );
            displayResult(transferTest);
            allResults.push(transferTest);
            
            // 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const authTest = await testEndpoint(
                'Authorization Check (–±–µ–∑ —Ç–æ–∫–µ–Ω–∞)',
                'GET',
                '/api/v2/wallet/balance',
                null,
                [401]
            );
            // –£–±–∏—Ä–∞–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞
            delete authTest.headers;
            const authResponse = await fetch('/api/v2/wallet/balance');
            authTest.status = authResponse.status;
            authTest.success = authResponse.status === 401;
            displayResult(authTest);
            allResults.push(authTest);
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
            generateReport();
        }
        
        function displayResult(result) {
            const resultsDiv = document.getElementById('results');
            
            if (resultsDiv.innerHTML.includes('–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤...')) {
                resultsDiv.innerHTML = '';
            }
            
            const section = document.createElement('div');
            section.className = 'test-section';
            
            const statusClass = result.success ? 'pass' : 'fail';
            const statusIcon = result.success ? '‚úÖ' : '‚ùå';
            
            let html = `
                <h3>${statusIcon} ${result.name}</h3>
                <p>
                    <span class="${statusClass}">–°—Ç–∞—Ç—É—Å: ${result.status || 'ERROR'}</span> | 
                    –ú–µ—Ç–æ–¥: ${result.method} | 
                    URL: ${result.url} | 
                    –í—Ä–µ–º—è: ${result.responseTime}ms
                </p>
            `;
            
            if (result.error) {
                html += `<p class="fail">–û—à–∏–±–∫–∞: ${result.error}</p>`;
            }
            
            if (result.data) {
                const dataStr = typeof result.data === 'string' 
                    ? result.data 
                    : JSON.stringify(result.data, null, 2);
                    
                // –°–æ–∫—Ä–∞—â–∞–µ–º –≤—ã–≤–æ–¥ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
                const truncated = dataStr.length > 500 
                    ? dataStr.substring(0, 500) + '...'
                    : dataStr;
                    
                html += `<pre>${truncated}</pre>`;
            }
            
            section.innerHTML = html;
            resultsDiv.appendChild(section);
        }
        
        function generateReport() {
            const resultsDiv = document.getElementById('results');
            const summary = document.createElement('div');
            summary.className = 'test-section';
            
            const passed = allResults.filter(r => r.success).length;
            const failed = allResults.filter(r => !r.success).length;
            const successRate = ((passed / allResults.length) * 100).toFixed(1);
            
            let reportHtml = `
                <h2>üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç</h2>
                <p>
                    <span class="pass">‚úÖ –£—Å–ø–µ—à–Ω–æ: ${passed}</span> | 
                    <span class="fail">‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–æ: ${failed}</span> | 
                    <span class="info">üìà –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: ${successRate}%</span>
                </p>
            `;
            
            // –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            if (successRate === 100) {
                reportHtml += `<p class="pass"><strong>üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ! –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –±–µ–∑ –æ—à–∏–±–æ–∫.</strong></p>`;
            } else if (successRate >= 80) {
                reportHtml += `<p class="warn"><strong>‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —É—Å–ø–µ—à–Ω–∞, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:</strong></p>`;
                allResults.filter(r => !r.success).forEach(r => {
                    reportHtml += `<p>- ${r.name}: HTTP ${r.status || 'ERROR'}</p>`;
                });
            } else {
                reportHtml += `<p class="fail"><strong>‚ùå –ú–∏–≥—Ä–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è - –º–Ω–æ–≥–æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤.</strong></p>`;
            }
            
            // –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            const avgTime = allResults
                .filter(r => r.responseTime)
                .reduce((sum, r) => sum + r.responseTime, 0) / allResults.length;
                
            reportHtml += `<p>‚ö° –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞: ${avgTime.toFixed(1)}ms</p>`;
            
            summary.innerHTML = reportHtml;
            resultsDiv.appendChild(summary);
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –æ—Ç—á–µ—Ç–∞
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', allResults);
            
            // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
            createMarkdownReport();
        }
        
        function createMarkdownReport() {
            const passed = allResults.filter(r => r.success).length;
            const failed = allResults.filter(r => !r.success).length;
            const successRate = ((passed / allResults.length) * 100).toFixed(1);
            
            let report = `# Regression Test Results - Migration Completed
Date: ${new Date().toLocaleString('ru-RU')}

## Summary
- ‚úÖ Passed: ${passed}
- ‚ùå Failed: ${failed}
- üìä Success Rate: ${successRate}%

## Detailed Results

| Endpoint | Method | Status | Response Time | Result |
|----------|--------|--------|---------------|--------|
`;

            allResults.forEach(result => {
                const icon = result.success ? '‚úÖ' : '‚ùå';
                const status = result.status || 'ERROR';
                const time = result.responseTime ? `${result.responseTime}ms` : 'N/A';
                
                report += `| ${result.url} | ${result.method} | ${status} | ${time} | ${icon} |\n`;
            });
            
            report += `\n## Key Findings\n\n`;
            
            if (successRate === 100) {
                report += `### ‚úÖ Migration Status: SUCCESS
All migrated endpoints are functioning correctly.\n`;
            } else {
                report += `### ‚ö†Ô∏è Migration Status: NEEDS ATTENTION\n`;
                allResults.filter(r => !r.success).forEach(r => {
                    report += `- ${r.name} (${r.url}): HTTP ${r.status || 'ERROR'}\n`;
                });
            }
            
            console.log('=== MARKDOWN REPORT ===');
            console.log(report);
            console.log('======================');
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            allResults = [];
        }
    </script>
</body>
</html>