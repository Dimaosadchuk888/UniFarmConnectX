<!DOCTYPE html>
<html>
<head>
    <title>UniFarm JWT Auth Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>üîê UniFarm JWT Auth Fix</h1>
    <p>–≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ UniFarm.</p>
    
    <div id="status"></div>
    
    <button onclick="checkCurrentAuth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
    <button onclick="installJWTToken()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å JWT —Ç–æ–∫–µ–Ω</button>
    <button onclick="testAPIRequest()">–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API –∑–∞–ø—Ä–æ—Å</button>
    <button onclick="clearAuth()">–û—á–∏—Å—Ç–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
    
    <div id="output"></div>

    <script>
        const statusDiv = document.getElementById('status');
        const outputDiv = document.getElementById('output');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            outputDiv.appendChild(div);
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }
        
        function checkCurrentAuth() {
            log('=== –ü–†–û–í–ï–†–ö–ê –¢–ï–ö–£–©–ï–ô –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ===');
            
            const token = localStorage.getItem('unifarm_jwt_token');
            if (!token) {
                log('‚ùå JWT —Ç–æ–∫–µ–Ω –ù–ï –ù–ê–ô–î–ï–ù –≤ localStorage', 'error');
                return;
            }
            
            log('‚úÖ JWT —Ç–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω –≤ localStorage', 'success');
            log(`–î–ª–∏–Ω–∞ —Ç–æ–∫–µ–Ω–∞: ${token.length} —Å–∏–º–≤–æ–ª–æ–≤`);
            
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                const decoded = JSON.parse(jsonPayload);
                
                log('‚úÖ –¢–æ–∫–µ–Ω –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ:', 'success');
                log(`<pre>${JSON.stringify(decoded, null, 2)}</pre>`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
                const now = Date.now() / 1000;
                if (decoded.exp < now) {
                    log('‚ùå –¢–æ–∫–µ–Ω –ò–°–¢–ï–ö', 'error');
                } else {
                    log('‚úÖ –¢–æ–∫–µ–Ω –î–ï–ô–°–¢–í–ò–¢–ï–õ–ï–ù', 'success');
                    log(`–ò—Å—Ç–µ–∫–∞–µ—Ç: ${new Date(decoded.exp * 1000).toLocaleString('ru-RU')}`);
                }
            } catch (e) {
                log('‚ùå –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ' + e.message, 'error');
            }
        }
        
        function installJWTToken() {
            log('=== –£–°–¢–ê–ù–û–í–ö–ê JWT –¢–û–ö–ï–ù–ê ===');
            
            // JWT —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID 62 (preview_test)
            const correctToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjYyLCJ0ZWxlZ3JhbV9pZCI6ODg4ODg4NDgsInVzZXJuYW1lIjoicHJldmlld190ZXN0IiwiZmlyc3RfbmFtZSI6IlByZXZpZXciLCJyZWZfY29kZSI6IlJFRl8xNzUxNzgwNTIxOTE4X2UxdjYyZCIsImlhdCI6MTc1MTg3MTA2MywiZXhwIjoxNzUyNDc1ODYzfQ.NKbyJiXtLnGzyr0w-C1oR658X5TzDO6EkKU8Ie5zgE0';
            
            localStorage.setItem('unifarm_jwt_token', correctToken);
            log('‚úÖ JWT —Ç–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ localStorage', 'success');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
            const verifyToken = localStorage.getItem('unifarm_jwt_token');
            if (verifyToken === correctToken) {
                log('‚úÖ –¢–æ–∫–µ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –≤ localStorage', 'success');
                
                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω
                try {
                    const base64Url = correctToken.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    const decoded = JSON.parse(jsonPayload);
                    
                    log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', 'success');
                    log(`<pre>ID: ${decoded.userId}
Username: ${decoded.username}
Telegram ID: ${decoded.telegram_id}
Ref Code: ${decoded.ref_code}
Expires: ${new Date(decoded.exp * 1000).toLocaleString('ru-RU')}</pre>`);
                } catch (e) {
                    log('‚ùå –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è: ' + e.message, 'error');
                }
            } else {
                log('‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ–∫–µ–Ω–∞', 'error');
            }
        }
        
        async function testAPIRequest() {
            log('=== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï API –ó–ê–ü–†–û–°–ê ===');
            
            const token = localStorage.getItem('unifarm_jwt_token');
            if (!token) {
                log('‚ùå JWT —Ç–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω.', 'error');
                return;
            }
            
            try {
                log('üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ /api/v2/users/profile...');
                
                const response = await fetch('/api/v2/users/profile', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                log(`–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ API –∑–∞–ø—Ä–æ—Å –£–°–ü–ï–®–ï–ù:', 'success');
                    log(`<pre>${JSON.stringify(data, null, 2)}</pre>`);
                } else {
                    const errorData = await response.json();
                    log('‚ùå API –∑–∞–ø—Ä–æ—Å –ù–ï–£–°–ü–ï–®–ï–ù:', 'error');
                    log(`<pre>${JSON.stringify(errorData, null, 2)}</pre>`);
                }
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message, 'error');
            }
        }
        
        function clearAuth() {
            log('=== –û–ß–ò–°–¢–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ===');
            
            localStorage.removeItem('unifarm_jwt_token');
            log('‚úÖ JWT —Ç–æ–∫–µ–Ω —É–¥–∞–ª–µ–Ω –∏–∑ localStorage', 'success');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—á–∏—Å—Ç–∫—É
            const token = localStorage.getItem('unifarm_jwt_token');
            if (!token) {
                log('‚úÖ localStorage –æ—á–∏—â–µ–Ω', 'success');
            } else {
                log('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ localStorage', 'error');
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            log('üîß UniFarm JWT Auth Fix Tool –∑–∞–≥—Ä—É–∂–µ–Ω');
            checkCurrentAuth();
        };
    </script>
</body>
</html>