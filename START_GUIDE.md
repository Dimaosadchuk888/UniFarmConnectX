# UniFarm - Руководство по запуску и настройке

## Содержание
1. [Быстрый запуск](#быстрый-запуск)
2. [Подробная настройка](#подробная-настройка)
   - [Настройка окружения](#настройка-окружения)
   - [База данных](#база-данных)
   - [Интеграция с Telegram](#интеграция-с-telegram)
3. [Проверка работоспособности](#проверка-работоспособности)
4. [Устранение неполадок](#устранение-неполадок)

## Быстрый запуск

Для быстрого запуска в Replit:

1. Нажмите кнопку "Run" в Replit
2. Сервер запустится автоматически через скрипт `start.cjs`
3. После загрузки, приложение будет доступно по адресу Replit Preview URL

## Подробная настройка

### Настройка окружения

Приложение использует следующие переменные окружения:

```
APP_URL=https://<your-replit-url>
MINI_APP_URL=https://<your-replit-url>
TELEGRAM_WEBHOOK_URL=https://<your-replit-url>/api/telegram/webhook
TELEGRAM_BOT_TOKEN=<your-telegram-bot-token>
DATABASE_URL=<your-database-url>
```

Все эти переменные можно настроить в файле `.env` или через переменные окружения Replit.

### База данных

UniFarm использует трехуровневую систему хранения данных:

1. **Neon PostgreSQL** (основная БД)
2. **Replit PostgreSQL** (резервная БД)
3. **In-memory Storage** (аварийное хранилище при недоступности БД)

Система автоматически переключается между хранилищами при возникновении ошибок подключения.

#### Настройка Neon DB

1. Создайте базу данных в Neon (https://neon.tech)
2. Добавьте строку подключения в переменную `DATABASE_URL`

#### Настройка Replit PostgreSQL

База данных Replit PostgreSQL настраивается автоматически. Для проверки её состояния:

```bash
curl http://localhost:3000/api/health
```

### Интеграция с Telegram

#### Настройка бота

1. Создайте бота у @BotFather в Telegram
2. Получите токен бота и добавьте его в переменную `TELEGRAM_BOT_TOKEN`
3. Установите меню бота командой `/setmenubutton` у @BotFather:
   - URL: `https://<your-replit-url>`
   - Текст кнопки: `Открыть UniFarm`

#### Настройка Webhook

Webhook настраивается автоматически при запуске приложения. URL для webhook:
```
https://<your-replit-url>/api/telegram/webhook
```

## Проверка работоспособности

После запуска можно проверить состояние приложения через API:

```bash
curl https://<your-replit-url>/api/health
```

Ответ должен содержать:
```json
{
  "status": "ok",
  "server": "up",
  "db": "connected", 
  "telegram": "initialized",
  "timestamp": "2025-05-22T...",
  "uptime": 123.45,
  "memoryUsage": {
    "rss": "123MB",
    "heapTotal": "45MB",
    "heapUsed": "23MB"
  }
}
```

## Устранение неполадок

### Перезапуск сервера

Если сервер не отвечает, используйте скрипт `start.cjs`:

```bash
node start.cjs
```

### Проблемы с базой данных

Если статус базы данных в `/api/health` показывает `"db": "error"`:

1. Проверьте подключение к интернету
2. Проверьте строку подключения к БД в переменной `DATABASE_URL`
3. Убедитесь, что IP-адрес Replit не заблокирован на стороне Neon

### Проблемы с Telegram

Если статус в `/api/health` показывает `"telegram": "not_initialized"`:

1. Проверьте токен бота в `TELEGRAM_BOT_TOKEN`
2. Проверьте доступность URL приложения извне
3. Перезапустите сервер

### Проблемы с запуском workflow

Если сервер не запускается через кнопку Run в Replit:

1. Проверьте конфигурацию в `workflows/stable-server.toml`
2. Убедитесь, что файл `start.cjs` существует и не поврежден
3. Запустите сервер вручную через команду `node start.cjs`