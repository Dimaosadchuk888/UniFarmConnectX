# –û–¢–ß–ï–¢: –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ü–†–û–ë–õ–ï–ú–´ TON –î–ï–ü–û–ó–ò–¢–û–í
**–î–∞—Ç–∞:** 21 –∏—é–ª—è 2025
**–°—Ç–∞—Ç—É—Å:** –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê –ò–î–ï–ù–¢–ò–§–ò–¶–ò–†–û–í–ê–ù–ê

## üîç –ê–ù–ê–õ–ò–ó –¶–ï–ü–û–ß–ö–ò –û–ë–†–ê–ë–û–¢–ö–ò TON –¢–†–ê–ù–ó–ê–ö–¶–ò–ô

### üìã –ü–û–õ–ù–ê–Ø –¶–ï–ü–û–ß–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –ü–õ–ê–¢–ï–ñ–ï–ô:

**1Ô∏è‚É£ FRONTEND (TonDepositCard.tsx)**
- **–§—É–Ω–∫—Ü–∏—è:** `handleDeposit()` (—Å—Ç—Ä–æ–∫–∏ 95-156)
- **–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TON —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ TON Connect
- **–ö–ª—é—á–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
  - –í—ã–∑–æ–≤ `sendTonTransaction()` —á–µ—Ä–µ–∑ TON Connect UI
  - –ü–æ–ª—É—á–µ–Ω–∏–µ `result.txHash` –æ—Ç –±–ª–æ–∫—á–µ–π–Ω–∞
  - **–ö–†–ò–¢–ò–ß–ù–û:** –û—Ç–ø—Ä–∞–≤–∫–∞ POST –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ `/api/v2/wallet/ton-deposit`

**2Ô∏è‚É£ BACKEND CONTROLLER (modules/wallet/controller.ts)**
- **–§—É–Ω–∫—Ü–∏—è:** `tonDeposit()` (–Ω–∞–π–¥–µ–Ω–∞ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫)
- **–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:** –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
- **–ö–ª—é—á–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
  - –í–∞–ª–∏–¥–∞—Ü–∏—è `ton_tx_hash`, `amount`, `wallet_address`
  - **–ö–†–ò–¢–ò–ß–ù–û:** –í—ã–∑–æ–≤ `getUserByTelegramId(telegram.user.id)`
  - –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –≤ `processTonDeposit()`

**3Ô∏è‚É£ BACKEND SERVICE (modules/wallet/service.ts)**
- **–§—É–Ω–∫—Ü–∏—è:** `processTonDeposit()` (—Å—Ç—Ä–æ–∫–∏ 341-466)
- **–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:** –§–∏–∫—Å–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- **–ö–ª—é—á–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –ø–æ `metadata->tx_hash`
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –ë–î

**4Ô∏è‚É£ FRONTEND DISPLAY (BalanceCard.tsx + API)**
- **–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞:** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞
- **API endpoint:** `/api/v2/wallet/balance?user_id=184`
- **–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä:** `getBalance()` –≤ controller.ts (—Å—Ç—Ä–æ–∫–∏ 172-222)

---

## üö® –û–ë–ù–ê–†–£–ñ–ï–ù–ù–ê–Ø –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê –í –ó–í–ï–ù–ï #2 (CONTROLLER)

**–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ `tonDeposit()` –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**

```typescript
const user = await userRepository.getUserByTelegramId(telegram.user.id);
if (!user) {
  return this.sendError(res, '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 404);
}
```

**üéØ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê:**
- **"–†–∞–∑–Ω—ã–µ –∫–∞–±–∏–Ω–µ—Ç—ã"** = —Ä–∞–∑–Ω—ã–µ Telegram –∞–∫–∫–∞—É–Ω—Ç—ã
- JWT —Ç–æ–∫–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç `telegram_id` –æ—Ç –æ–¥–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
- –ê TON –¥–µ–ø–æ–∑–∏—Ç –¥–µ–ª–∞–µ—Ç—Å—è –∏–∑ –¥—Ä—É–≥–æ–≥–æ Telegram –∞–∫–∫–∞—É–Ω—Ç–∞
- **getUserByTelegramId() –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** ‚Üí 404 –æ—à–∏–±–∫–∞
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** `processTonDeposit()` –ù–ò–ö–û–ì–î–ê –ù–ï –í–´–ó–´–í–ê–ï–¢–°–Ø!

---

## üîç –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê –ü–†–û–ë–õ–ï–ú–´:

### üìä –ê–ù–ê–õ–ò–ó –õ–û–ì–û–í –ë–†–ê–£–ó–ï–†–ê:
- TON –±–∞–ª–∞–Ω—Å –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è: `3.355847 ‚Üí 3.359317` (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç —Ñ–∞—Ä–º–∏–Ω–≥–∞)
- **–û–¢–°–£–¢–°–¢–í–£–Æ–¢ –ª–æ–≥–∏:** –≤—ã–∑–æ–≤–æ–≤ `/api/v2/wallet/ton-deposit`
- **–û–¢–°–£–¢–°–¢–í–£–Æ–¢ –ª–æ–≥–∏:** –æ–±—Ä–∞–±–æ—Ç–∫–∏ TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –≤ backend
- **–û–¢–°–£–¢–°–¢–í–£–Æ–¢ –æ—à–∏–±–∫–∏:** –≤ –±—Ä–∞—É–∑–µ—Ä–µ, —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–∏—Ö–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ 404

### üìã –ê–ù–ê–õ–ò–ó –ö–û–î–ê:
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –ö–û–†–†–ï–ö–¢–ù–û:**
- ‚úÖ –ü–æ–∏—Å–∫ –ø–æ `eq('metadata->tx_hash', ton_tx_hash)` —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ metadata —Å–æ–¥–µ—Ä–∂–∏—Ç `tx_hash: ton_tx_hash`
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç

**–ù–û –¥–µ–ø–æ–∑–∏—Ç—ã –ù–ï –î–û–•–û–î–Ø–¢ –¥–æ `processTonDeposit()`!**

---

## üéØ –°–¶–ï–ù–ê–†–ò–ô –ü–†–û–ë–õ–ï–ú–´:

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ê** –∑–∞—Ö–æ–¥–∏—Ç –≤ UniFarm ‚Üí –ø–æ–ª—É—á–∞–µ—Ç JWT —Å `telegram_id: 12345`
2. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë** –Ω–∞ —Ç–æ–º –∂–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –¥–µ–ª–∞–µ—Ç TON –¥–µ–ø–æ–∑–∏—Ç —á–µ—Ä–µ–∑ Tonkeeper
3. Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å —Å JWT –æ—Ç **–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ê** (`telegram_id: 12345`)
4. Backend –∏—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ `telegram_id: 12345`
5. **–ù–û –¥–µ–ø–æ–∑–∏—Ç —Å–¥–µ–ª–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë** (–¥—Ä—É–≥–æ–π telegram_id)
6. `getUserByTelegramId()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `null` ‚Üí 404 "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"
7. **processTonDeposit() –ù–ò–ö–û–ì–î–ê –ù–ï –í–´–ü–û–õ–ù–Ø–ï–¢–°–Ø**
8. TON —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å –∫–æ—à–µ–ª—å–∫–∞, –Ω–æ –±–∞–ª–∞–Ω—Å –≤ UniFarm –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

---

## üí° –ß–¢–û –ù–£–ñ–ù–û –ò–°–ü–†–ê–í–ò–¢–¨:

### üîß –í–ê–†–ò–ê–ù–¢ 1: –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö telegram_id
- –°–æ–∑–¥–∞—Ç—å mapping –º–µ–∂–¥—É –∫–æ—à–µ–ª—å–∫–∞–º–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö telegram_id

### üîß –í–ê–†–ò–ê–ù–¢ 2: WALLET-BASED AUTHENTICATION  
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å wallet_address –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- –°–≤—è–∑—ã–≤–∞—Ç—å –¥–µ–ø–æ–∑–∏—Ç—ã —Å –∫–æ—à–µ–ª—å–∫–∞–º–∏, –∞ –Ω–µ telegram_id
- –°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –ø—Ä–∏–≤—è–∑–∫–∏ –∫–æ—à–µ–ª—å–∫–æ–≤ –∫ –∞–∫–∫–∞—É–Ω—Ç–∞–º

### üîß –í–ê–†–ò–ê–ù–¢ 3: –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –î–ï–ü–û–ó–ò–¢ HANDLER
- –ü—Ä–∏–Ω–∏–º–∞—Ç—å –¥–µ–ø–æ–∑–∏—Ç—ã –æ—Ç –ª—é–±—ã—Ö telegram_id
- –°–æ–∑–¥–∞–≤–∞—Ç—å "pending deposits" –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ claimed
- –°–∏—Å—Ç–µ–º–∞ —Ä—É—á–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–ø–æ–∑–∏—Ç–æ–≤

---

## üìù –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:

### üö® –ù–ï–ú–ï–î–õ–ï–ù–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:
1. **–î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤ `tonDeposit()` controller
2. **–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å 404 –æ—à–∏–±–∫–∏** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–º–µ—Å—Ç–æ –º–æ–ª—á–∞–Ω–∏—è
3. **–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### üîÑ –î–û–õ–ì–û–°–†–û–ß–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
1. **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ multi-account
2. **–£–ª—É—á—à–µ–Ω–∏–µ UX** —Å —á–µ—Ç–∫–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ–± –æ—à–∏–±–∫–∞—Ö
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–¥–æ–±–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –±—ã–ª–æ –ü–†–ê–í–ò–õ–¨–ù–´–ú**, –Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞—Ö–æ–¥–∏–ª–∞—Å—å –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ –≤ —Ü–µ–ø–æ—á–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏. 

**–†–µ–∞–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ Telegram –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –µ—â–µ –¥–æ —ç—Ç–∞–ø–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏.

**–°—Ä–æ—á–Ω–æ—Å—Ç—å:** –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø - —É—á–∞—Å—Ç–Ω–∏–∫–∏ —Ç–µ—Ä—è—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏ –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏.