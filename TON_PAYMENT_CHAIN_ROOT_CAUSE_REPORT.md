# üö® –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ü–†–û–ë–õ–ï–ú–´ TON –î–ï–ü–û–ó–ò–¢–û–í –ù–ê–ô–î–ï–ù–ê

## üìã –ü–†–û–ë–õ–ï–ú–ê
–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ UniFarm —Å–æ–æ–±—â–∞—é—Ç —á—Ç–æ TON –¥–µ–ø–æ–∑–∏—Ç—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å –∏—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ —á–µ—Ä–µ–∑ Connect Wallet (Tonkeeper), –Ω–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –±–∞–ª–∞–Ω—Å–µ UniFarm —Å–∏—Å—Ç–µ–º—ã.

## üéØ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ù–ê–ô–î–ï–ù–ê

**–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –í –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–ò –¢–†–ê–ù–ó–ê–ö–¶–ò–ô**

### üîç –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ—à–∏–±–∫–∏:
**–§–∞–π–ª:** `modules/wallet/service.ts`  
**–°—Ç—Ä–æ–∫–∞:** 377  
**–§—É–Ω–∫—Ü–∏—è:** `processTonDeposit()`

### üí• –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:

```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê (—Ç–µ–∫—É—â–∏–π –∫–æ–¥):
const existingTransaction = await supabase
  .from('transactions')
  .select('*')
  .eq('description', ton_tx_hash)  // üö® –û–®–ò–ë–ö–ê –¢–£–¢!
  .eq('type', 'DEPOSIT')
  .single();
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ –ø–æ–ª—é `description`, –Ω–æ:
- `description` —Å–æ–¥–µ—Ä–∂–∏—Ç: `"TON deposit from blockchain: {tx_hash}"`
- `ton_tx_hash` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ hash: `"abc123def456..."`
- **–ü–û–ò–°–ö –ù–ò–ö–û–ì–î–ê –ù–ï –ù–ê–•–û–î–ò–¢ –°–û–í–ü–ê–î–ï–ù–ò–ô!**

## üîó –ü–û–õ–ù–ê–Ø –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –¶–ï–ü–û–ß–ö–ê –û–®–ò–ë–ö–ò

### ‚úÖ –≠–¢–ê–ü 1: Frontend (–†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
```typescript
// TonDepositCard.tsx —Å—Ç—Ä–æ–∫–∞ 121
const response = await fetch('/api/v2/wallet/ton-deposit', {
  method: 'POST',
  body: JSON.stringify({
    user_id: userId,           // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π user ID
    ton_tx_hash: result.txHash, // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π hash —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    amount: depositAmount,      // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—É–º–º–∞
    wallet_address: walletAddress // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å
  })
});
```

### ‚úÖ –≠–¢–ê–ü 2: Controller (–†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
```typescript
// modules/wallet/controller.ts —Å—Ç—Ä–æ–∫–∞ 378
const user = await userRepository.getUserByTelegramId(telegram.user.id); // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
const result = await walletService.processTonDeposit({
  user_id: user.id,           // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π user ID
  ton_tx_hash,               // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π hash
  amount: parseFloat(amount), // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—É–º–º–∞
  wallet_address             // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å
});
```

### ‚ùå –≠–¢–ê–ü 3: Service (–°–õ–û–ú–ê–ù–ê –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø)
```typescript
// modules/wallet/service.ts —Å—Ç—Ä–æ–∫–∞ 374-379
const existingTransaction = await supabase
  .from('transactions')
  .select('*')
  .eq('description', ton_tx_hash)  // üö® –í–û–¢ –û–®–ò–ë–ö–ê!
  .eq('type', 'DEPOSIT')
  .single();

// –ü–û–ò–°–ö:
// ton_tx_hash = "abc123def456..."
// description = "TON deposit from blockchain: abc123def456..."
// –°–û–í–ü–ê–î–ï–ù–ò–Ø –ù–ï–¢! ‚ùå
```

### ‚ùå –≠–¢–ê–ü 4: –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—à–∏–±–∫–∏
```typescript
if (existingTransaction.data) {
  // ‚ùå –ù–ò–ö–û–ì–î–ê –ù–ï –í–´–ü–û–õ–ù–Ø–ï–¢–°–Ø!
  return { success: false, error: '–≠—Ç–æ—Ç –¥–µ–ø–æ–∑–∏—Ç —É–∂–µ –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω' };
}

// ‚úÖ –í–°–ï–ì–î–ê –í–´–ü–û–õ–ù–Ø–ï–¢–°–Ø (–¥–∞–∂–µ –¥–ª—è –¥—É–±–ª–µ–π):
// - –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
// - –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å
// - –ù–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ UI
```

## üí∏ –í–õ–ò–Ø–ù–ò–ï –ù–ê –£–ß–ê–°–¢–ù–ò–ö–û–í

**–ß—Ç–æ –≤–∏–¥–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫:**
1. üí∏ TON —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å –∫–æ—à–µ–ª—å–∫–∞ (blockchain —É—Å–ø–µ—à–Ω–æ)
2. üíæ UniFarm –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–î–µ–ø–æ–∑–∏—Ç —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω" 
3. üìä –ë–∞–ª–∞–Ω—Å –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
4. üò° –£—á–∞—Å—Ç–Ω–∏–∫ –¥—É–º–∞–µ—Ç —á—Ç–æ –¥–µ–Ω—å–≥–∏ –ø–æ—Ç–µ—Ä—è–Ω—ã

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Å–∏—Å—Ç–µ–º–µ:**
1. ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
2. ‚úÖ –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ users
3. ‚ùå –ù–û frontend –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ –ø–æ–∏—Å–∫–∞

## üîß –ü–†–ê–í–ò–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ–∏—Å–∫ –ø–æ metadata
```typescript
const existingTransaction = await supabase
  .from('transactions')
  .select('*')
  .eq('metadata->tx_hash', ton_tx_hash)
  .eq('type', 'DEPOSIT')
  .single();
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É description
```typescript
const existingTransaction = await supabase
  .from('transactions')
  .select('*')
  .ilike('description', `%${ton_tx_hash}%`)
  .eq('type', 'DEPOSIT')
  .single();
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ tx_hash –≤ —Ç–∞–±–ª–∏—Ü—É
```sql
ALTER TABLE transactions ADD COLUMN tx_hash VARCHAR(255);
CREATE INDEX idx_transactions_tx_hash ON transactions(tx_hash);
```

## üìä –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ù–ê–•–û–î–ö–ò

1. **WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç** - –±–∞–ª–∞–Ω—Å—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è description** - —É—è–∑–≤–∏–º–æ—Å—Ç—å –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π  
3. **BalanceManager –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** - –ø—Ä—è–º—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –±–∞–∑–µ –º–æ–≥—É—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É

## üö® –°–†–û–ß–ù–û–°–¢–¨ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

**–ö–†–ò–¢–ò–ß–ù–û:** –ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π TON –¥–µ–ø–æ–∑–∏—Ç –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:
- –ü–æ—Ç–µ—Ä–µ –¥–æ–≤–µ—Ä–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –í–æ–∑–º–æ–∂–Ω—ã–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è–º  
- –ü—Ä–æ–±–ª–µ–º–∞–º —Å –∞—É–¥–∏—Ç–æ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

## ‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ù–ê–•–û–î–ö–ò

–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç:
- ‚úÖ Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ Authentication —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
- ‚úÖ Controller –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚ùå **Service –∏–º–µ–µ—Ç —Å–ª–æ–º–∞–Ω–Ω—É—é –ª–æ–≥–∏–∫—É –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏**
- ‚úÖ Database –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- ‚ùå **Frontend –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –ø–æ–∏—Å–∫–∞**

---
**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞:** 21 –∏—é–ª—è 2025, 15:40 UTC  
**–°—Ç–∞—Ç—É—Å:** –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏