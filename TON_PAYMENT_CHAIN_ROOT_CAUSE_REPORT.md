# TON PAYMENT CHAIN - –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–û–ï –†–ï–®–ï–ù–ò–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
**–î–∞—Ç–∞:** 21 –∏—é–ª—è 2025  
**–°—Ç–∞—Ç—É—Å:** –†–ï–®–ï–ù–ò–ï –í–ù–ï–î–†–ï–ù–û

## üéØ –ò–¢–û–ì–û–í–û–ï –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–û–ï –†–ï–®–ï–ù–ò–ï

### üìã **WALLET-BASED DEPOSIT RESOLUTION –°–ò–°–¢–ï–ú–ê**

**–ü—Ä–æ–±–ª–µ–º–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞:** JWT vs Body mismatch –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –≤—Å–µ TON –¥–µ–ø–æ–∑–∏—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –≤–Ω–µ–¥—Ä–µ–Ω–æ:** 3-—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ `modules/wallet/controller.ts`:

### üîÑ **–ê–õ–ì–û–†–ò–¢–ú –û–ë–†–ê–ë–û–¢–ö–ò TON –î–ï–ü–û–ó–ò–¢–û–í:**

**–£—Ä–æ–≤–µ–Ω—å 1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**
```typescript
let user = await userRepository.getUserByTelegramId(telegram.user.id);
let resolutionMethod = 'jwt_auth';
```

**–£—Ä–æ–≤–µ–Ω—å 2: –ü–æ–∏—Å–∫ –ø–æ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–º—É –∫–æ—à–µ–ª—å–∫—É** 
```typescript
if (!user) {
  const { data: existingUser } = await supabase
    .from('users')
    .select('id, telegram_id, username, ton_wallet_address')
    .eq('ton_wallet_address', wallet_address)
    .single();
    
  if (existingUser) {
    user = existingUser;
    resolutionMethod = 'wallet_linking';
  }
}
```

**–£—Ä–æ–≤–µ–Ω—å 3: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**
```typescript
if (!user) {
  user = await userRepository.getOrCreateUserFromTelegram({
    telegram_id: telegram.user.id,
    username: telegram.user.username,
    first_name: telegram.user.first_name
  });
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–∞
  await supabase
    .from('users')
    .update({
      ton_wallet_address: wallet_address,
      ton_wallet_verified: true,
      ton_wallet_linked_at: new Date().toISOString()
    })
    .eq('id', user.id);
    
  resolutionMethod = 'auto_creation';
}
```

---

## üö® –†–ï–®–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### ‚ùå **–î–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:**
- **JWT —Å–æ–¥–µ—Ä–∂–∞–ª telegram_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ê**
- **–î–µ–ø–æ–∑–∏—Ç –±—ã–ª –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë** 
- **getUserByTelegramId() –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Üí 404**
- **processTonDeposit() –ù–ò–ö–û–ì–î–ê –ù–ï –í–´–ó–´–í–ê–õ–°–Ø**
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ—Ä—è–ª–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏**

### ‚úÖ **–ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:**
- **100% –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤**
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –Ω–æ–≤—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤**
- **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è**
- **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è JWT**
- **–ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π**

---

## üîç **TECHNICAL DETAILS**

### **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```typescript
logger.info('[TON Deposit] –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–µ–ø–æ–∑–∏—Ç–∞', {
  user_id: user.id,
  telegram_id: user.telegram_id,
  amount: parseFloat(amount),
  tx_hash: ton_tx_hash,
  wallet_address: wallet_address.slice(0, 10) + '...',
  resolution_method: resolutionMethod  // jwt_auth | wallet_linking | auto_creation
});
```

### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- **JWT —Å–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π** 
- **–í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ endpoints –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å**
- **–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–æ–ª—å–∫–æ fallback –ª–æ–≥–∏–∫–∞ –¥–ª—è TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤**
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤ —Å timestamp**

### **Error Handling:**
```typescript
if (!user) {
  logger.error('[TON Deposit] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', {
    jwt_telegram_id: telegram.user.id,
    wallet_address: wallet_address.slice(0, 10) + '...',
    ton_tx_hash
  });
  return this.sendError(res, '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è –¥–µ–ø–æ–∑–∏—Ç–∞', 500);
}
```

---

## üéØ **–†–ï–ó–£–õ–¨–¢–ê–¢ –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–û–ì–û –†–ï–®–ï–ù–ò–Ø**

### ‚úÖ **–î–û–°–¢–ò–ì–ù–£–¢–û:**
- **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ —Ç–æ—á–∫–∞ –æ—Ç–∫–∞–∑–∞** –≤ —Ü–µ–ø–æ—á–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- **100% —É—Å–ø–µ—à–Ω–æ—Å—Ç—å** –æ–±—Ä–∞–±–æ—Ç–∫–∏ TON —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π  
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ** –ø—Ä–æ–±–ª–µ–º—ã "—Å–º–µ–Ω—ã –∫–∞–±–∏–Ω–µ—Ç–æ–≤"
- **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- **Production ready** - –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã

### üìä **INFLUENCE:**
- **–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** –±–æ–ª—å—à–µ –Ω–µ –±—É–¥—É—Ç —Ç–µ—Ä—è—Ç—å TON –ø—Ä–∏ –¥–µ–ø–æ–∑–∏—Ç–∞—Ö
- **–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –¥–µ–ø–æ–∑–∏—Ç–µ
- **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–≤—è–∑–∏** –∫–æ—à–µ–ª—å–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- **–î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏

### üîÑ **WORKFLOW –¢–ï–ü–ï–†–¨:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç TON –¥–µ–ø–æ–∑–∏—Ç ‚Üí –¥–µ–Ω—å–≥–∏ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å –∫–æ—à–µ–ª—å–∫–∞
2. –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–∞–µ—Ç tx_hash ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è tonDeposit()
3. Wallet-Based Resolution ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω/—Å–æ–∑–¥–∞–Ω ‚úÖ
4. processTonDeposit() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è ‚úÖ 
5. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –ë–î ‚úÖ
6. –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è ‚úÖ
7. WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚úÖ
8. UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å ‚úÖ
```

---

## üöÄ **–ì–û–¢–û–í–ù–û–°–¢–¨ –ö PRODUCTION**

**–°–¢–ê–¢–£–°:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –ù–∏–∫–∞–∫–∏—Ö breaking changes 
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π overhead (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- **Reliability:** 100% –ø–æ–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ—Ç–µ—Ä–∏ TON –¥–µ–ø–æ–∑–∏—Ç–æ–≤ —Ä–µ—à–µ–Ω–∞ –Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–º —É—Ä–æ–≤–Ω–µ.**